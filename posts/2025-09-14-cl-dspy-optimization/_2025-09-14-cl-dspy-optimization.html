<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shubham Gupta">
<meta name="dcterms.date" content="2025-09-14">
<meta name="description" content="Optimzing DSPy programs for ConvFinQA">

<title>Shubham Gupta ‚Äì Curriculum Learning ü§ù DSPy: Optimization</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<script src="../../site_libs/quarto-search/autocomplete-preset-algolia.umd.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">

<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="/site_libs/bootstrap/bootstrap-1713c1db1ad41a796903378fc9ac7b2b.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "algolia": {
    "application-id": "HR1HJNZUVY",
    "search-only-api-key": "3326e8971e20d27e2dd21591d6a24656",
    "index-name": "blog_pages",
    "index-fields": {
      "href": "url",
      "section": "sec",
      "text": "body"
    },
    "analytics-events": true,
    "show-logo": false,
    "libDir": "site_libs"
  },
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"></script>


<script type="text/javascript">
var ALGOLIA_INSIGHTS_SRC = "https://cdn.jsdelivr.net/npm/search-insights/dist/search-insights.iife.min.js";
!function(e,a,t,n,s,i,c){e.AlgoliaAnalyticsObject=s,e[s]=e[s]||function(){
(e[s].queue=e[s].queue||[]).push(arguments)},i=a.createElement(t),c=a.getElementsByTagName(t)[0],
i.async=1,i.src=n,c.parentNode.insertBefore(i,c)
}(window,document,"script",ALGOLIA_INSIGHTS_SRC,"aa");
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-plugin-algolia-insights">

</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CLKTGRWBQT"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-CLKTGRWBQT', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Shubham Gupta - Curriculum Learning ü§ù DSPy: Optimization">
<meta property="og:description" content="Optimzing DSPy programs for ConvFinQA">
<meta property="og:image" content="https://shubhamg.in/posts/cl_dspy/submission_mlflow_metrics.png">
<meta property="og:site_name" content="Shubham Gupta">
<meta property="og:image:height" content="1052">
<meta property="og:image:width" content="2646">
<meta name="twitter:title" content="Shubham Gupta - Curriculum Learning ü§ù DSPy: Optimization">
<meta name="twitter:description" content="Optimzing DSPy programs for ConvFinQA">
<meta name="twitter:image" content="https://shubhamg.in/posts/cl_dspy/submission_mlflow_metrics.png">
<meta name="twitter:creator" content="@shubhamg2208">
<meta name="twitter:image-height" content="1052">
<meta name="twitter:image-width" content="2646">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Shubham Gupta</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/goodhamgupta"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Curriculum Learning ü§ù DSPy: Optimization</h1>
                  <div>
        <div class="description">
          Optimzing DSPy programs for ConvFinQA
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">programming</div>
                <div class="quarto-category">dspy</div>
                <div class="quarto-category">curriculum-learning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Shubham Gupta </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 14, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>In <a href="../2025-08-31-cl-dspy-eda.html">Part 1</a> we carved the ConvFinQA corpus into curriculum-aware difficulty tiers through some EDA. <a href="../../posts/2025-09-01-cl-dspy-modelling/index.html">Part 2</a> turned that insight into zero-shot baselines, pitting several LLMs against each tier. The hard bucket still hurt, which is proof that smarter prompting, not bigger models, is our next lever.</p>
<p>In this installment, instead of fine-tunes we‚Äôll use DSPy‚Äôs programmatic prompt optimizers to lift accuracy beyond the Part 2 ceiling. We‚Äôll iterate over the shortlisted models:</p>
<ul>
<li>o4-mini,</li>
<li>o3</li>
<li>gemini-2.5-flash (this couldn‚Äôt be completed due to rate limits unfortunately)</li>
</ul>
<p>We feed each model curriculum-ordered exemplars, and let DSPy search the prompt space under tight token and latency caps.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<section id="baseline-recap" class="level3">
<h3 class="anchored" data-anchor-id="baseline-recap">Baseline recap</h3>
<ul>
<li>Zero-shot baselines from Part 2 (https://shubhamg.in/posts/2025-09-01-cl-dspy-modelling/) established a ceiling on Medium/Hard tiers.</li>
<li>Shortlisted models: o4-mini, o3, gemini-2.5-flash.</li>
<li>Common failure modes: multi-op arithmetic chains, cross-turn dependencies, long-context/table lookups.</li>
<li>Objective here: improve Medium/Hard without finetuning via DSPy prompt optimizers, comparing against Part 2 metrics.</li>
</ul>
<p>Let‚Äôs copy over some of the code from the previous notebook here, before we start optimising our models!</p>
<div id="cell-4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(<span class="st">"http://localhost:5000"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>mlflow.dspy.autolog(log_compiles<span class="op">=</span><span class="va">True</span>, log_evals<span class="op">=</span><span class="va">True</span>, log_traces_from_compile<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"DSPy Optimization"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>&lt;Experiment: artifact_location='mlflow-artifacts:/3', creation_time=1753708026551, experiment_id='3', last_update_time=1753708026551, lifecycle_stage='active', name='DSPy Optimization', tags={}&gt;</code></pre>
</div>
</div>
<div id="cell-5" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dotenv</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>dotenv.load_dotenv(<span class="st">"../.env"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>MAX_TOKENS <span class="op">=</span> <span class="dv">20_000</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>lm_oai_gpt_4_1 <span class="op">=</span> dspy.LM(</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openai/gpt-4.1-2025-04-14"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>lm_oai_gpt_4_1_mini <span class="op">=</span> dspy.LM(</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openai/gpt-4.1-mini-2025-04-14"</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>lm_oai_o4_mini <span class="op">=</span> dspy.LM(</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openai/o4-mini-2025-04-16"</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    temperature<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>lm_oai_gpt_5 <span class="op">=</span> dspy.LM(</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openai/gpt-5-2025-08-07"</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    temperature<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>lm_oai_gpt_5_mini <span class="op">=</span> dspy.LM(</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openai/gpt-5-mini-2025-08-07"</span>,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    temperature<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>lm_oai_gpt_5_nano <span class="op">=</span> dspy.LM(</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openai/gpt-5-nano-2025-08-07"</span>,</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    temperature<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>lm_anthropic_sonnet_4_0 <span class="op">=</span> dspy.LM(</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"anthropic/claude-sonnet-4-20250514"</span>,</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"ANTHROPIC_API_KEY"</span>],</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>lm_gemini_flash_2_5 <span class="op">=</span> dspy.LM(</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gemini/gemini-2.5-flash"</span>,</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"GEMINI_API_KEY"</span>],</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>lm_gemini_flash_2_5_lite <span class="op">=</span> dspy.LM(</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gemini/gemini-2.5-flash-lite"</span>,</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"GEMINI_API_KEY"</span>],</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>lm_oai_o3 <span class="op">=</span> dspy.LM(</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openai/o3-2025-04-16"</span>,</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    temperature<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>lm_anthropic_opus_4_0 <span class="op">=</span> dspy.LM(</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"anthropic/claude-opus-4-20250514"</span>,</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"ANTHROPIC_API_KEY"</span>],</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>lm_gemini_pro_2_5 <span class="op">=</span> dspy.LM(</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gemini/gemini-2.5-pro"</span>,</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.environ[<span class="st">"GEMINI_API_KEY"</span>],</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>lm_qwen3_32b <span class="op">=</span> dspy.LM(</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ollama/qwen3:32b"</span>,</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    api_base<span class="op">=</span><span class="st">"http://localhost:11434"</span>,</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span>MAX_TOKENS,</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-6" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>llms <span class="op">=</span> [</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    lm_oai_gpt_4_1,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    lm_oai_gpt_4_1_mini,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    lm_oai_o4_mini,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    lm_anthropic_sonnet_4_0,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    lm_gemini_flash_2_5,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    lm_gemini_flash_2_5_lite,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    lm_oai_o3,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    lm_anthropic_opus_4_0,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    lm_gemini_pro_2_5,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    lm_qwen3_32b,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-7" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="st">"../data/convfinqa_dataset.json"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="dspy-modules" class="level2">
<h2 class="anchored" data-anchor-id="dspy-modules">DSPy Modules</h2>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SolveTurnWithoutReasoning(dspy.Signature):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    conversation_context: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"Conversation so far"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    evidence_snippets: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">"Snippets of evidence surrounding the table"</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    table: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"Input financial table with metrics"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    question: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"Question to answer"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    ops: <span class="bu">str</span> <span class="op">=</span> dspy.OutputField(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">"Comma-separated ConvFinQA DSL program. Allowed ops: add(x, y), subtract(x, y), multiply(x, y), divide(x, y), exp(x, y), greater(x, y). Args may be constants (e.g., const_100), numbers (int or float), or prior step refs (#0, #1‚Ä¶). Order always follows the pattern x &lt;op&gt; y‚Äîpick x and y deliberately. Example: subtract(const_100, 42), divide(#0, 3.14). Convert to percentages only if explicitly asked in the question."</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    answer: <span class="bu">str</span> <span class="op">=</span> dspy.OutputField(</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">"Final answer. This will be a single number, or a boolean string(yes/no)"</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SolveTurnWithReasoning(dspy.Signature):</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    conversation_context: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"Conversation so far"</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    evidence_snippets: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">"Snippets of evidence surrounding the table"</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    table: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"Input financial table with metrics"</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    question: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"Question to answer"</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    reasoning: <span class="bu">str</span> <span class="op">=</span> dspy.OutputField(</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">"Reasoning behind the answer. Carefully analyze the conversation_context, and especially the evidence_snippets and table for the given question, and generate your reasoning before generating the ops and answer."</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    ops: <span class="bu">str</span> <span class="op">=</span> dspy.OutputField(</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">"Comma-separated ConvFinQA DSL program. Allowed ops: add(x, y), subtract(x, y), multiply(x, y), divide(x, y), exp(x, y), greater(x, y). Args may be constants (e.g., const_100), numbers (int or float), or prior step refs (#0, #1‚Ä¶). Order always follows the pattern x &lt;op&gt; y‚Äîpick x and y deliberately. Example: subtract(const_100, 42), divide(#0, 3.14). Convert to percentages only if explicitly asked in the question."</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    answer: <span class="bu">str</span> <span class="op">=</span> dspy.OutputField(</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">"Final answer. This will be a single number, or a boolean string(yes/no)"</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TurnSolver(dspy.Module):</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="co">    In the context of this series of interconnected finance-related queries and the additional information provided by the pretext, table data, and posttext from a company's financial filings, please provide a response to the final question. This may require extracting information from the context and performing mathematical calculations. Please take into account the information provided in the preceding questions and their answers when formulating your response: </span><span class="ch">\n\n</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, reasoning_lm<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if reasoning_lm:</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     self.pred = dspy.ChainOfThought(SolveTurnWithReasoning)</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># else:</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     self.pred = dspy.Predict(SolveTurnWithoutReasoning)</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pred <span class="op">=</span> dspy.ChainOfThought(SolveTurnWithReasoning)</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, conversation_context, evidence_snippets, table, question):</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a><span class="co">        Run the model to solve a single turn.</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="co">            conversation_context (str): Conversation so far.</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a><span class="co">            evidence_snippets (str): Evidence text around the table.</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a><span class="co">            table (str): Financial table in markdown.</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a><span class="co">            question (str): Question to answer.</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a><span class="co">            dspy.Prediction: Model output with reasoning, ops, and answer.</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.pred(</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>            conversation_context<span class="op">=</span>conversation_context,</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>            evidence_snippets<span class="op">=</span>evidence_snippets,</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>            table<span class="op">=</span>table,</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>            question<span class="op">=</span>question,</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> norm_ans(x):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Normalize an answer for comparison.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Converts input to string, strips whitespace, removes percent signs,</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">    and attempts to cast to float. If conversion fails, returns the cleaned string.</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">        x: The answer to normalize (str, float, or int).</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">        float or str: Normalized float if possible, else cleaned string.</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(x).strip().replace(<span class="st">"%"</span>, <span class="st">""</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(s)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> s</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _table_md(table_dict: <span class="bu">dict</span>, max_cols: <span class="bu">int</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert a dictionarised table to compact GitHub-markdown.</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Accepted shapes</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co">    1) {row_name: {col_name: value, ‚Ä¶}, ‚Ä¶}   # regular 2-level mapping</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co">    2) {col_name: value, ‚Ä¶}                  # flat ‚Üí coerced to single row</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co">    Guarantees</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co">    ‚Ä¢ Original row order is kept.</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co">    ‚Ä¢ Column headers are kept in *first-seen* order; NO deduplication.</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co">    ‚Ä¢ max_cols (if given) truncates *after* enumeration, duplicates included.</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="co">    ‚Ä¢ None ‚Üí "" and everything else is str()-ed.</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> table_dict:</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">all</span>(<span class="kw">not</span> <span class="bu">isinstance</span>(v, <span class="bu">dict</span>) <span class="cf">for</span> v <span class="kw">in</span> table_dict.values()):</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># flat mapping ‚Üí one anonymous row</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        table_dict <span class="op">=</span> {<span class="st">""</span>: <span class="bu">dict</span>(table_dict)}</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ensure every value is a dict</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>        table_dict <span class="op">=</span> {</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>            r: (v <span class="cf">if</span> <span class="bu">isinstance</span>(v, <span class="bu">dict</span>) <span class="cf">else</span> {<span class="st">""</span>: v}) <span class="cf">for</span> r, v <span class="kw">in</span> table_dict.items()</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    row_ids <span class="op">=</span> <span class="bu">list</span>(table_dict.keys())  <span class="co"># preserve caller order</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    cols: <span class="bu">list</span> <span class="op">=</span> []</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> row_ids:</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        cols.extend(table_dict[r].keys())</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> max_cols <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>        cols <span class="op">=</span> cols[:max_cols]</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    header <span class="op">=</span> <span class="st">"| Row | "</span> <span class="op">+</span> <span class="st">" | "</span>.join(<span class="bu">map</span>(<span class="bu">str</span>, cols)) <span class="op">+</span> <span class="st">" |"</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    sep <span class="op">=</span> <span class="st">"|"</span> <span class="op">+</span> <span class="st">"---|"</span> <span class="op">*</span> (<span class="bu">len</span>(cols) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> [header, sep]</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> row_ids:</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>        vals <span class="op">=</span> [<span class="bu">str</span>(table_dict[r].get(c, <span class="st">""</span>)) <span class="cf">for</span> c <span class="kw">in</span> cols]</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        lines.append(<span class="st">"| "</span> <span class="op">+</span> <span class="bu">str</span>(r) <span class="op">+</span> <span class="st">" | "</span> <span class="op">+</span> <span class="st">" | "</span>.join(vals) <span class="op">+</span> <span class="st">" |"</span>)</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(lines)</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_inputs_from_row(</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    row,</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    turn_idx,</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>,</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    history_mode: <span class="bu">str</span> <span class="op">=</span> <span class="st">"teacher"</span>,</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    state: <span class="bu">dict</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    max_table_cols: <span class="bu">int</span> <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a><span class="co">    history_mode: 'teacher' | 'model' | 'none'</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a><span class="co">    state: carries model predictions across turns when history_mode='model'</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a><span class="co">           expected keys: {'pred_answers': list[str|float]}</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a><span class="co">    evidence_builder: optional callable(row, turn_idx)-&gt;str; if None, use simple truncation.</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>    qs <span class="op">=</span> row[<span class="st">"dialogue_conv_questions"</span>]</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>    gold <span class="op">=</span> row[<span class="st">"dialogue_executed_answers"</span>]</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- history ----</span></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>    history_lines <span class="op">=</span> []</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(turn_idx):</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>        history_lines.append(<span class="ss">f"Q</span><span class="sc">{</span>t <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>qs[t]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> history_mode <span class="op">==</span> <span class="st">"teacher"</span>:</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>            history_lines.append(<span class="ss">f"A</span><span class="sc">{</span>t <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>gold[t]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> (</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>            history_mode <span class="op">==</span> <span class="st">"model"</span> <span class="kw">and</span> state <span class="kw">and</span> <span class="bu">len</span>(state.get(<span class="st">"pred_answers"</span>, [])) <span class="op">&gt;</span> t</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>        ):</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>            history_lines.append(<span class="ss">f"A</span><span class="sc">{</span>t <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>state[<span class="st">'pred_answers'</span>][t]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> history_mode <span class="op">==</span> <span class="st">"none"</span>:</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span>  <span class="co"># only questions</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>    conversation_context <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(history_lines) <span class="cf">if</span> history_lines <span class="cf">else</span> <span class="st">"None"</span></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>    evidence_snippets <span class="op">=</span> (</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"[PRE]</span><span class="ch">\n</span><span class="sc">{</span>row[<span class="st">'doc_pre_text'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">[/PRE]</span><span class="ch">\n</span><span class="ss">[POST]</span><span class="ch">\n</span><span class="sc">{</span>row[<span class="st">'doc_post_text'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">[/POST]"</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>    table_md <span class="op">=</span> _table_md(row.get(<span class="st">"doc_table"</span>, {}) <span class="kw">or</span> {}, max_cols<span class="op">=</span>max_table_cols)</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>        conversation_context<span class="op">=</span>conversation_context,</span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>        evidence_snippets<span class="op">=</span>evidence_snippets,</span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>        table<span class="op">=</span>table_md,</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>        question<span class="op">=</span>qs[turn_idx],</span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>        ops<span class="op">=</span>row[<span class="st">"dialogue_turn_program"</span>][turn_idx],</span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>        <span class="op">**</span>row,</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_dialogues(model, df):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Evaluate a dialogue model on a DataFrame of conversations.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">        model: Callable that takes unpacked input dict and returns an object with at least `.answer` (and optionally `.ops`).</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">        df: pd.DataFrame with columns:</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">            - "dialogue_conv_questions": list of str, all questions in the conversation</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">            - "dialogue_executed_answers": list of str/float, all executed answers so far</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">            - (other columns as needed by evidence_builder)</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">        dict with:</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">            - "turn_em_micro": float, micro-averaged exact match over all turns</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">            - "dlg_mean_em_macro": float, macro-averaged mean EM per dialogue</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">            - "joint_em": float, fraction of dialogues with all turns correct</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">            - "final_turn_em": float, EM on the final turn of each dialogue</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">            - "n_dialogues": int, number of dialogues</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co">            - "n_turns": int, total number of turns</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    turn_hits <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    turn_tot <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># exec_hits = 0</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    dlg_mean_ems <span class="op">=</span> []</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    dlg_joint_hits <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    final_hits <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        qs <span class="op">=</span> row[<span class="st">"dialogue_conv_questions"</span>]</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        gold <span class="op">=</span> row[<span class="st">"dialogue_executed_answers"</span>]</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        ems <span class="op">=</span> []</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        exec_flags <span class="op">=</span> []</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(qs)):</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            inp <span class="op">=</span> build_inputs_from_row(row, t)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> model(<span class="op">**</span>inp)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            pa <span class="op">=</span> norm_ans(out.answer)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>            ga <span class="op">=</span> norm_ans(gold[t])</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            em <span class="op">=</span> <span class="bu">float</span>(pa <span class="op">==</span> ga)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            ems.append(em)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>            turn_hits <span class="op">+=</span> em</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>            turn_tot <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        dlg_mean_ems.append(<span class="bu">sum</span>(ems) <span class="op">/</span> <span class="bu">len</span>(ems))</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">all</span>(v <span class="op">==</span> <span class="fl">1.0</span> <span class="cf">for</span> v <span class="kw">in</span> ems):</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>            dlg_joint_hits <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        final_hits <span class="op">+=</span> ems[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"turn_em_micro"</span>: turn_hits <span class="op">/</span> <span class="bu">max</span>(<span class="dv">1</span>, turn_tot),</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dlg_mean_em_macro"</span>: <span class="bu">sum</span>(dlg_mean_ems) <span class="op">/</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(dlg_mean_ems)),</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"joint_em"</span>: dlg_joint_hits <span class="op">/</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(dlg_mean_ems)),</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"final_turn_em"</span>: final_hits <span class="op">/</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(dlg_mean_ems)),</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_dialogues"</span>: <span class="bu">len</span>(dlg_mean_ems),</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_turns"</span>: turn_tot,</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-12" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> turn_em_metric(example, pred, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute turn-level exact match (EM) metric for a single example/prediction pair.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">        example: dict-like, must contain "gold_answer" key.</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">        pred: object with an "answer" attribute.</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">        float: 1.0 if normalized prediction matches normalized gold answer (with tolerance for floats), else 0.0.</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> dspy.evaluate.metrics <span class="im">import</span> answer_exact_match</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    pa <span class="op">=</span> norm_ans(pred.answer)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    ga <span class="op">=</span> norm_ans(example[<span class="st">"answer"</span>])</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(pa, <span class="bu">float</span>) <span class="kw">and</span> <span class="bu">isinstance</span>(ga, <span class="bu">float</span>):</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(<span class="bu">abs</span>(pa <span class="op">-</span> ga) <span class="op">&lt;=</span> <span class="fl">1e-2</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># exact_match in DSPy needs the inputs to be in string format</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># due to the normalisations DSPy performs internally.</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        ground_truth <span class="op">=</span> dspy.Prediction(answer<span class="op">=</span><span class="bu">str</span>(example.answer))</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        pred_answer <span class="op">=</span> dspy.Prediction(answer<span class="op">=</span><span class="bu">str</span>(pred.answer))</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(answer_exact_match(ground_truth, pred_answer))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-13" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_turn_examples(df, history_mode<span class="op">=</span><span class="st">"teacher"</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    examples <span class="op">=</span> []</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        qs <span class="op">=</span> row[<span class="st">"dialogue_conv_questions"</span>]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        gold <span class="op">=</span> row[<span class="st">"dialogue_executed_answers"</span>]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(qs)):</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            inp <span class="op">=</span> build_inputs_from_row(row, t, history_mode<span class="op">=</span>history_mode)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            ex <span class="op">=</span> <span class="bu">dict</span>(<span class="op">**</span>inp, answer<span class="op">=</span>gold[t])</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            examples.append(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                dspy.Example(<span class="op">**</span>ex).with_inputs(</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"conversation_context"</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"evidence_snippets"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"table"</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"question"</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> examples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="preparing-datasets" class="level2">
<h2 class="anchored" data-anchor-id="preparing-datasets">Preparing Datasets</h2>
<p>We will aim to use the splits as follows: - <code>train</code>: Used primarily for the <em>optimisation</em> phase. This will be discussed shortly. - <code>valid</code>: Used to evaluate the performance of an LM on an optimised model <em>trained</em> using the train dataset. - <code>test</code>: Used to evaluate the performance of an LM on a held-out dataset. This will determine the overall stage performance.</p>
<div id="cell-16" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.DataFrame(data[<span class="st">"train"</span>])</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame(data[<span class="st">"dev"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten features to remove the indexing gymnastics</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>train_flat_df <span class="op">=</span> pd.concat(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        train_df.drop([<span class="st">"doc"</span>, <span class="st">"dialogue"</span>, <span class="st">"features"</span>], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"doc"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"doc_"</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"dialogue"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"dialogue_"</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"features"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"features_"</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>test_flat_df <span class="op">=</span> pd.concat(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        test_df.drop([<span class="st">"doc"</span>, <span class="st">"dialogue"</span>, <span class="st">"features"</span>], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"doc"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"doc_"</span>),</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"dialogue"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"dialogue_"</span>),</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"features"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"features_"</span>),</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-18" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">doc_pre_text</th>
<th data-quarto-table-cell-role="th">doc_post_text</th>
<th data-quarto-table-cell-role="th">doc_table</th>
<th data-quarto-table-cell-role="th">dialogue_conv_questions</th>
<th data-quarto-table-cell-role="th">dialogue_conv_answers</th>
<th data-quarto-table-cell-role="th">dialogue_turn_program</th>
<th data-quarto-table-cell-role="th">dialogue_executed_answers</th>
<th data-quarto-table-cell-role="th">dialogue_qa_split</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Single_JKHY/2009/page_28.pdf-3</td>
<td>26 | 2009 annual report in fiscal 2008 , reven...</td>
<td>year ended june 30 , cash provided by operatio...</td>
<td>{'Year ended June 30, 2009': {'net income': 10...</td>
<td>[what is the net cash from operating activitie...</td>
<td>[206588, 181001, 25587, 14.1%]</td>
<td>[206588, 181001, subtract(206588, 181001), sub...</td>
<td>[206588.0, 181001.0, 25587.0, 0.14136]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Single_RSG/2008/page_114.pdf-2</td>
<td>substantially all of the goodwill and other in...</td>
<td>the above unaudited pro forma financial inform...</td>
<td>{'year ended december 31 2008 ( unaudited )': ...</td>
<td>[what were revenues in 2008?, what were they i...</td>
<td>[9362.2, 9244.9, 117.3, 1.3%]</td>
<td>[9362.2, 9244.9, subtract(9362.2, 9244.9), sub...</td>
<td>[9362.2, 9244.9, 117.3, 0.01269]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Single_AAPL/2002/page_23.pdf-1</td>
<td>in a new business model such as the retail seg...</td>
<td>.</td>
<td>{'2002': {'net sales': 5742.0, 'cost of sales'...</td>
<td>[what was the total of net sales in 2001?, and...</td>
<td>[5363, 7983, -2620, -32%]</td>
<td>[5363, 7983, subtract(5363, 7983), subtract(53...</td>
<td>[5363.0, 7983.0, -2620.0, -0.3282]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Single_UPS/2009/page_33.pdf-2</td>
<td>( 1 ) includes shares repurchased through our ...</td>
<td>.</td>
<td>{'12/31/04': {'united parcel service inc .': 1...</td>
<td>[what was the change in the performance of the...</td>
<td>[-24.05, -24.05%, 102.11, 2.11, 2.11%, -26.16%]</td>
<td>[subtract(75.95, const_100), subtract(75.95, c...</td>
<td>[-24.05, -0.2405, 102.11, 2.11, 0.0211, -0.2616]</td>
<td>[False, False, False, False, False, False]</td>
<td>6</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Double_UPS/2009/page_33.pdf</td>
<td>( 1 ) includes shares repurchased through our ...</td>
<td>.</td>
<td>{'12/31/04': {'united parcel service inc .': 1...</td>
<td>[what was the fluctuation of the performance p...</td>
<td>[-8.94, -8.9%, -24.05, -24.05%, 2.11, 2.11%, -...</td>
<td>[subtract(91.06, const_100), subtract(91.06, c...</td>
<td>[-8.94, -0.0894, -24.05, -0.2405, 2.11, 0.0211...</td>
<td>[False, False, True, True, True, True, True]</td>
<td>7</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-19" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>easy_train_ids <span class="op">=</span> pd.read_json(<span class="st">"./splits/easy_train.jsonl"</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>easy_valid_ids <span class="op">=</span> pd.read_json(<span class="st">"./splits/easy_valid.jsonl"</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>easy_test_ids <span class="op">=</span> pd.read_json(<span class="st">"./splits/easy_test.jsonl"</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>medium_train_ids <span class="op">=</span> pd.read_json(<span class="st">"./splits/medium_train.jsonl"</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>medium_valid_ids <span class="op">=</span> pd.read_json(<span class="st">"./splits/medium_valid.jsonl"</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>medium_test_ids <span class="op">=</span> pd.read_json(<span class="st">"./splits/medium_test.jsonl"</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>hard_train_ids <span class="op">=</span> pd.read_json(<span class="st">"./splits/hard_train.jsonl"</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>hard_valid_ids <span class="op">=</span> pd.read_json(<span class="st">"./splits/hard_valid.jsonl"</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>hard_test_ids <span class="op">=</span> pd.read_json(<span class="st">"./splits/hard_test.jsonl"</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>easy_train_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">"id"</span>].isin(easy_train_ids[<span class="st">"id"</span>])].copy()</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>easy_valid_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">"id"</span>].isin(easy_valid_ids[<span class="st">"id"</span>])].copy()</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>easy_test_df <span class="op">=</span> test_flat_df[test_flat_df[<span class="st">"id"</span>].isin(easy_test_ids[<span class="st">"id"</span>])].copy()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>medium_train_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">"id"</span>].isin(medium_train_ids[<span class="st">"id"</span>])].copy()</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>medium_valid_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">"id"</span>].isin(medium_valid_ids[<span class="st">"id"</span>])].copy()</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>medium_test_df <span class="op">=</span> test_flat_df[test_flat_df[<span class="st">"id"</span>].isin(medium_test_ids[<span class="st">"id"</span>])].copy()</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>hard_train_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">"id"</span>].isin(hard_train_ids[<span class="st">"id"</span>])].copy()</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>hard_valid_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">"id"</span>].isin(hard_valid_ids[<span class="st">"id"</span>])].copy()</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>hard_test_df <span class="op">=</span> test_flat_df[test_flat_df[<span class="st">"id"</span>].isin(hard_test_ids[<span class="st">"id"</span>])].copy()</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> easy_train_ids.shape[<span class="dv">0</span>] <span class="op">==</span> easy_train_df.shape[<span class="dv">0</span>]</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> easy_valid_ids.shape[<span class="dv">0</span>] <span class="op">==</span> easy_valid_df.shape[<span class="dv">0</span>]</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> easy_test_ids.shape[<span class="dv">0</span>] <span class="op">==</span> easy_test_df.shape[<span class="dv">0</span>]</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> medium_train_ids.shape[<span class="dv">0</span>] <span class="op">==</span> medium_train_df.shape[<span class="dv">0</span>]</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> medium_valid_ids.shape[<span class="dv">0</span>] <span class="op">==</span> medium_valid_df.shape[<span class="dv">0</span>]</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> medium_test_ids.shape[<span class="dv">0</span>] <span class="op">==</span> medium_test_df.shape[<span class="dv">0</span>]</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> hard_train_ids.shape[<span class="dv">0</span>] <span class="op">==</span> hard_train_df.shape[<span class="dv">0</span>]</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> hard_valid_ids.shape[<span class="dv">0</span>] <span class="op">==</span> hard_valid_df.shape[<span class="dv">0</span>]</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> hard_test_ids.shape[<span class="dv">0</span>] <span class="op">==</span> hard_test_df.shape[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>easy_train_examples <span class="op">=</span> to_turn_examples(easy_train_df)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>easy_valid_examples <span class="op">=</span> to_turn_examples(easy_valid_df)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>easy_test_examples <span class="op">=</span> to_turn_examples(easy_test_df)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>medium_train_examples <span class="op">=</span> to_turn_examples(medium_train_df)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>medium_valid_examples <span class="op">=</span> to_turn_examples(medium_valid_df)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>medium_test_examples <span class="op">=</span> to_turn_examples(medium_test_df)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>hard_train_examples <span class="op">=</span> to_turn_examples(hard_train_df)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>hard_valid_examples <span class="op">=</span> to_turn_examples(hard_valid_df)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>hard_test_examples <span class="op">=</span> to_turn_examples(hard_test_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dspy-optimization" class="level2">
<h2 class="anchored" data-anchor-id="dspy-optimization">DSPy Optimization</h2>
<p>We aim to <em>optimize</em> prompts with dspy because:</p>
<ul>
<li>Hand-tuned prompts plateau fast and break when the data distribution drifts.<br>
</li>
<li>Brute-force prompt crafting doesn‚Äôt scale; automated search + distillation does.<br>
</li>
<li>DSPy acts as a compiler: give it a spec + metric, get back a better program.</li>
</ul>
<p>DSPy has a few inbuilt methods to do prompt optimization, as shown <a href="https://dspy.ai/learn/optimization/optimizers/">in the docs</a>. Due to time and cost contraints, we will focus on a few key approaches:</p>
<ul>
<li><strong>BootstrapFewShotWithRandomSearch</strong> ‚Äì LM proposes demos, keep the ones that pass <code>metric</code>.
<ul>
<li>Uses a teacher module (which defaults to your program) to generate complete demonstrations for every stage of your program, along with labeled examples in trainset. Parameters include max_labeled_demos (the number of demonstrations randomly selected from the trainset) and max_bootstrapped_demos (the number of additional examples generated by the teacher). The bootstrapping process employs the metric to validate demonstrations, including only those that pass the metric in the ‚Äúcompiled‚Äù prompt.</li>
<li><code>RandomSearch</code> applies the above several times with random search over generated demonstrations, and selects the best program over the optimization.</li>
</ul></li>
<li><strong>MIPROv2</strong> ‚Äì Bayes-opt over instructions <em>and</em> demos (can stay 0-shot).
<ul>
<li>Generates instructions and few-shot examples in each step. The instruction generation is data-aware and demonstration-aware. Uses Bayesian Optimization to effectively search over the space of generation instructions/demonstrations across your modules.</li>
</ul></li>
<li><strong>BootstrapFinetune</strong> ‚Äì distill the compiled prompt into weight updates. We might use this to improve the performance of a smaller and cheaper model to match the perform of a larger model!
<ul>
<li>The output is a DSPy program that has the same steps, but where each step is conducted by a finetuned model instead of a prompted LM.</li>
</ul></li>
</ul>
</section>
<section id="optimisation-methods" class="level2">
<h2 class="anchored" data-anchor-id="optimisation-methods">Optimisation Methods</h2>
<p>In the previous notebook, on the ‚Äúgate‚Äù dataset, we had the following results:</p>
<table class="table">
<thead>
<tr class="header">
<th>LLM</th>
<th>Evaluation Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>openai/gpt-4.1-2025-04-14</td>
<td>80.0</td>
</tr>
<tr class="even">
<td>openai/gpt-4.1-mini-2025-04-14</td>
<td>50.0</td>
</tr>
<tr class="odd">
<td>openai/o4-mini-2025-04-16</td>
<td>60.0</td>
</tr>
<tr class="even">
<td>anthropic/claude-sonnet-4-20250514</td>
<td>60.0</td>
</tr>
<tr class="odd">
<td>gemini/gemini-2.5-flash</td>
<td>70.0</td>
</tr>
<tr class="even">
<td>gemini/gemini-2.5-flash-lite</td>
<td>70.0</td>
</tr>
<tr class="odd">
<td>openai/o3-2025-04-16</td>
<td>80.0</td>
</tr>
<tr class="even">
<td>anthropic/claude-opus-4-20250514</td>
<td>70.0</td>
</tr>
<tr class="odd">
<td>gemini/gemini-2.5-pro</td>
<td>80.0</td>
</tr>
<tr class="even">
<td>ollama/qwen3:32b</td>
<td>70.0</td>
</tr>
</tbody>
</table>
<p>Compared to the frontier model o3, we had relatively poor performance with o4-mini and gemini-2.5-flash.</p>
<p>Let‚Äôs try to see if we can improve the performance here. Specifically, we will do the first stage of optimisation on the <em>easy</em> dataset, using the BootstrapFewShot metric.</p>
<p>For the easy dataset, we will restrict the number of few shot examples to 5.</p>
<section id="bootstrapfewshotwithrandomsearch" class="level3">
<h3 class="anchored" data-anchor-id="bootstrapfewshotwithrandomsearch">BootstrapFewShotWithRandomSearch</h3>
<div id="cell-26" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>selected_llms <span class="op">=</span> [lm_oai_o4_mini, lm_gemini_flash_2_5, lm_oai_o3]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-27" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(easy_train_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>679</code></pre>
</div>
</div>
<p>The <a href="https://dspy.ai/learn/optimization/optimizers/">official documentation</a> for BootstrapFewShotWithRandomSearch recommends to use 50 or more examples. Due to time and cost constraints, we will randomly sample 70 examples from the easy train set, and use them to optimize our program.</p>
<div id="cell-29" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">42</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>bootstrap_rs_random_easy_subset <span class="op">=</span> random.sample(easy_train_examples, <span class="dv">70</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-30" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> litellm</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.teleprompt <span class="im">import</span> BootstrapFewShotWithRandomSearch</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Config needed to prevent the optimizer from using _unsupported_ temperature</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># for reasoning models.</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>litellm.drop_params <span class="op">=</span> <span class="va">True</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    max_bootstrapped_demos<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    max_labeled_demos<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    num_candidate_programs<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    max_rounds<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>bootstrap_rs_easy_compiled_programs <span class="op">=</span> []</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"bootstrap_few_shot_rs_easy"</span>):</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> candidate_lm <span class="kw">in</span> selected_llms:</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f"bootstrap_few_shot_rs_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">'/'</span>, <span class="st">'_'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r"[^a-zA-Z0-9_\-]"</span>, <span class="st">"_"</span>, run_name)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>                teleprompter <span class="op">=</span> BootstrapFewShotWithRandomSearch(</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>                    metric<span class="op">=</span>turn_em_metric, <span class="op">**</span>config</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>                optimized_program <span class="op">=</span> teleprompter.<span class="bu">compile</span>(</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>                    dspy.ChainOfThought(SolveTurnWithReasoning),</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>                    trainset<span class="op">=</span>bootstrap_rs_random_easy_subset,</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>                bootstrap_rs_easy_compiled_programs.append(optimized_program)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Going to sample between 1 and 3 traces per predictor.
Will attempt to bootstrap 5 candidate sets.
Average Metric: 45.00 / 70 (64.3%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:00&lt;00:00, 87.74it/s] 
üèÉ View run eval_0 at: http://localhost:5000/#/experiments/3/runs/fcce9b07d50e41609bc04c3d9c2235c7
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 64.29 for seed -3
...
2025/07/29 01:09:48 INFO dspy.evaluate.evaluate: Average Metric: 56.0 / 70 (80.0%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9aa596c147174804958bfd90f9e69998","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2fac575b2f714ab3a5f079b5b8c068e7","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9352e516d8b848579ba0d22b01c35fb2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dd46b6737ed8418484d64e9cef39a594","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"19d7fe20fa6b4fb7bb39768109a6e96f","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d9ac51afacd244629a94d3d29cc78260","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"71a5a9849439471b90be1451f4ed6d8c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"795ab895387b4c0e9eac571ee453ac88","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"650c0bd2cb2a4041bdf156931c25130c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f16c05df32404d64b8a8431d48d39234","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0479a155634a4c4ba4d92bebca0b0727","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ea69ff24378d45a3998851b5aa0962d4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8b8c7a6497d04213a381c037724d4895","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bc397a6b03924336bbc43a1bd839784c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d43544d6f72f40dbaae08ad6b18cb0bd","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4e7c85dbd6f64f61a359ea5a37c40ed0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6913487151e04ab7a89037c30da2cfd7","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cf6a3e6ba2a646a093455efcf2d34a65","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"102094c059e84577861cd1271f22e414","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d5351ffa3e234f7f92c3f1932b3dd438","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d3e11c2f024d4ec090827c250d4258ca","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3cff124f59634e5b9279882b0501180a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"043eb11fea0a462684dac9bbb48f4f03","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e694033bfb9e4689bd6c07fc39d0801c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"db37866855a049b88bb7e4c9dd3597c6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"93fd5af0c6644afc978088bc68e1ee83","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5aa8485009e94f079807723d8dbc5ab2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e5cce25e5c7941d6bf6a39bcd3c76bf8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f90ceb161810483ab7c0fb2a38dd46e4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4d26bd076e4845b193dfa48d40f9e51b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2bceaac3cdcd48a0b05bc0f5e0c884a5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ab959aa00cf145d0984217e3c543fcd0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7a19b204ef7443e3964026a61386dbf3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0944c174ba5d4b7f888c2c78316eeb67","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f58455aed23543369dda147cdcc46ee6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6f9faa0b381e48b4a3239439f9b5c8a0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"14d1357491a342a6b3cbb1a778076b69","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3146876614a146569534ee1e0cef7f86","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"36e21760751a482c874fbc57b485e178","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped="">
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<p>From the logs, and in the <a href="http://localhost:5000/#/experiments/3/runs/b5f08a070a634f74888fb8c42f24bfa3">MLFlow UI</a>, we see the following performances for each model:</p>
<table>
<colgroup>
<col style="width: 23%" />
<col style="width: 63%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Candidate Scores</th>
<th>Best Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>64.29, 65.71, 67.14, 68.57, 65.71, 64.29, 67.14, 72.86</td>
<td>72.86</td>
</tr>
<tr class="even">
<td>gemini-2.5-flash</td>
<td>61.43, 67.14, 65.71, 65.71, 64.29, 67.14, 68.57, 85.71</td>
<td>85.71</td>
</tr>
<tr class="odd">
<td>o3</td>
<td>74.29, 74.29, 74.29, 72.86, 74.29, 75.71, 75.71, 80.0</td>
<td>80.0</td>
</tr>
</tbody>
</table>
<p>Surprisingly, the best model is <strong>gemini-2.5-flash</strong>, on this small random subset of the <em>easy</em> dataset.</p>
<p>We can also look at the prompt generated for the model:</p>
<div id="cell-32" class="cell" data-execution_count="91">
<div class="sourceCode" id="cb23"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>bootstrap_rs_easy_compiled_programs[<span class="dv">1</span>].inspect_history(n<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>



[2025-07-29T01:03:41.268360]

System message:

Your input fields are:
1. `conversation_context` (str): Conversation so far
2. `evidence_snippets` (str): Snippets of evidence surrounding the table
3. `table` (str): Input financial table with metrics
4. `question` (str): Question to answer
Your output fields are:
1. `reasoning` (str): Reasoning behind the answer. Carefully analyze the conversation_context, and especially the evidence_snippets and table for the given question, and generate your reasoning before generating the ops and answer.
2. `ops` (str): Comma-separated ConvFinQA DSL program. Allowed ops: add(x, y), subtract(x, y), multiply(x, y), divide(x, y), exp(x, y), greater(x, y). Args may be constants (e.g., const_100), numbers (int or float), or prior step refs (#0, #1‚Ä¶). Order always follows the pattern x &lt;op&gt; y‚Äîpick x and y deliberately. Example: subtract(const_100, 42), divide(#0, 3.14). Convert to percentages only if explicitly asked in the question.
3. `answer` (str): Final answer. This will be a single number, or a boolean string(yes/no)
All interactions will be structured in the following way, with the appropriate values filled in.

[[ ## conversation_context ## ]]
{conversation_context}

[[ ## evidence_snippets ## ]]
{evidence_snippets}

[[ ## table ## ]]
{table}

[[ ## question ## ]]
{question}

[[ ## reasoning ## ]]
{reasoning}

[[ ## ops ## ]]
{ops}

[[ ## answer ## ]]
{answer}

[[ ## completed ## ]]
In adhering to this structure, your objective is: 
        Given the fields `conversation_context`, `evidence_snippets`, `table`, `question`, produce the fields `reasoning`, `ops`, `answer`.


User message:

This is an example of the task, though some input or output fields are not supplied.

[[ ## conversation_context ## ]]
Q1: what was the expected dividend yield in 2006?
A1: 3.24
Q2: what was the expected yield in 2005?
A2: 3.29
Q3: what is the net difference?
A3: -0.05

[[ ## evidence_snippets ## ]]
[PRE]
eastman notes to the audited consolidated financial statements stock option awards option awards are granted to non-employee directors on an annual basis and to employees who meet certain eligibility requirements . a single annual option grant is usually awarded to eligible employees in the fourth quarter of each year , if and when granted by the compensation and management development committee of the board of directors , and occasional individual grants are awarded to eligible employees throughout the year . option awards have an exercise price equal to the closing price of the company&#39;s stock on the date of grant . the term of options is ten years with vesting periods that vary up to three years . vesting usually occurs ratably or at the end of the vesting period . sfas no . 123 ( r ) requires that stock option awards be valued at fair value determined by market price , if actively traded in a public market or , if not , calculated using an option pricing financial model . the fair value of the company&#39;s options cannot be determined by market value as they are not traded in an open market . accordingly , a financial pricing model is utilized to determine fair value . the company utilizes the black scholes merton ( &quot;bsm&quot; ) model which relies on certain assumptions to estimate an option&#39;s fair value . the weighted average assumptions used in the determination of fair value for stock options awarded in 2006 , 2005 and 2004 are provided in the table below: .
[/PRE]
[POST]
prior to adoption of sfas no . 123 ( r ) , the company calculated the expected term of stock options of six years . effective with the fourth quarter 2005 annual option award , the company analyzed historical annual grant transactions over a ten year period comprising exercises , post-vesting cancellations and expirations to determine the expected term . the company expects to execute this analysis each year preceding the annual option grant to ensure that all assumptions based upon internal data reflect the most reasonable expectations for fair value determination . the weighted average expected term of 4.4 years for 2006 reflects the impact of this annual analysis and the weighting of option swap and reload grants which may have much shorter expected terms than new option grants . the volatility rate of grants is derived from historical company common stock volatility over the same time period as the expected term . the company uses a weekly high closing stock price based upon daily closing prices in the week . the volatility rate is derived by mathematical formula utilizing the weekly high closing price data . for the periods presented above , the expected dividend yield is derived by mathematical formula which uses the expected company annual dividend amount over the expected term divided by the fair market value of the company&#39;s common stock at the grant date . the average risk-free interest rate is derived from united states department of treasury published interest rates of daily yield curves for the same time period as the expected term . prior to adoption of sfas no . 123 ( r ) , the company did not estimate forfeitures and recognized them as they occurred for proforma disclosure of share-based compensation expense . with adoption of sfas no . 123 ( r ) , estimated forfeitures must be considered in recording share-based compensation expense . estimated forfeiture rates vary with each type of award affected by several factors , one of which is the varying composition and characteristics of the award participants . estimated forfeitures for the company&#39;s share-based awards historically range from 0.75 percent to 10.0 percent with the estimated forfeitures for options at 0.75 percent. .
[/POST]

[[ ## table ## ]]
| Row | expected volatility rate | expected dividend yield | average risk-free interest rate | expected forfeiture rate | expected term years | expected volatility rate | expected dividend yield | average risk-free interest rate | expected forfeiture rate | expected term years | expected volatility rate | expected dividend yield | average risk-free interest rate | expected forfeiture rate | expected term years |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| 2006 | -21.4 | -3.24 | -4.62 | -0.75 | 4.4 | -21.4 | -3.24 | -4.62 | -0.75 | 4.4 | -21.4 | -3.24 | -4.62 | -0.75 | 4.4 |
| 2005 | -22.9 | -3.29 | -4.48 | actual | 5.0 | -22.9 | -3.29 | -4.48 | actual | 5.0 | -22.9 | -3.29 | -4.48 | actual | 5.0 |
| 2004 | -28.0 | -3.8 | -3.46 | actual | 6.0 | -28.0 | -3.8 | -3.46 | actual | 6.0 | -28.0 | -3.8 | -3.46 | actual | 6.0 |

[[ ## question ## ]]
what is the percent change?


Assistant message:

[[ ## reasoning ## ]]
Not supplied for this particular example. 

[[ ## ops ## ]]
subtract(3.24, 3.29), divide(#0, 3.29)

[[ ## answer ## ]]
-0.0152


User message:

[[ ## conversation_context ## ]]
None

[[ ## evidence_snippets ## ]]
[PRE]
the company granted 1020 performance shares . the vesting of these shares is contingent on meeting stated goals over a performance period . beginning with restricted stock grants in september 2010 , dividends are accrued on restricted class a common stock and restricted stock units and are paid once the restricted stock vests . the following table summarizes restricted stock and performance shares activity for 2010 : number of shares weighted average grant date fair value .
[/PRE]
[POST]
the total fair value of restricted stock that vested during the years ended december 31 , 2010 , 2009 and 2008 , was $ 10.3 million , $ 6.2 million and $ 2.5 million , respectively . eligible employees may acquire shares of cme group 2019s class a common stock using after-tax payroll deductions made during consecutive offering periods of approximately six months in duration . shares are purchased at the end of each offering period at a price of 90% ( 90 % ) of the closing price of the class a common stock as reported on the nasdaq . compensation expense is recognized on the dates of purchase for the discount from the closing price . in 2010 , 2009 and 2008 , a total of 4371 , 4402 and 5600 shares , respectively , of class a common stock were issued to participating employees . these shares are subject to a six-month holding period . annual expense of $ 0.1 million for the purchase discount was recognized in 2010 , 2009 and 2008 , respectively . non-executive directors receive an annual award of class a common stock with a value equal to $ 75000 . non-executive directors may also elect to receive some or all of the cash portion of their annual stipend , up to $ 25000 , in shares of stock based on the closing price at the date of distribution . as a result , 7470 , 11674 and 5509 shares of class a common stock were issued to non-executive directors during 2010 , 2009 and 2008 , respectively . these shares are not subject to any vesting restrictions . expense of $ 2.4 million , $ 2.5 million and $ 2.4 million related to these stock-based payments was recognized for the years ended december 31 , 2010 , 2009 and 2008 , respectively. .
[/POST]

[[ ## table ## ]]
| Row | outstanding at december 31 2009 | granted | vested | cancelled | outstanding at december 31 2010 | outstanding at december 31 2009 | granted | vested | cancelled | outstanding at december 31 2010 |
|---|---|---|---|---|---|---|---|---|---|---|
| number of shares | 116677.0 | 134245.0 | -34630.0 | -19830.0 | 196462.0 | 116677.0 | 134245.0 | -34630.0 | -19830.0 | 196462.0 |
| weighted average grant date fair value | 280.0 | 275.0 | 257.0 | 260.0 | 283.0 | 280.0 | 275.0 | 257.0 | 260.0 | 283.0 |

[[ ## question ## ]]
what was the change in number of shares from 2009 to 2010?


Assistant message:

[[ ## reasoning ## ]]
To find the change in the number of shares from 2009 to 2010, I need to identify the &#39;number of shares&#39; outstanding at December 31, 2009, and the &#39;number of shares&#39; outstanding at December 31, 2010, from the table. Then, I will subtract the 2009 value from the 2010 value.

From the table:
- Number of shares outstanding at December 31, 2009: 116677.0
- Number of shares outstanding at December 31, 2010: 196462.0

The change is 196462.0 - 116677.0.

[[ ## ops ## ]]
subtract(196462.0, 116677.0)

[[ ## answer ## ]]
79785.0


User message:

[[ ## conversation_context ## ]]
Q1: what is the increase in value of an investment in delphi automotive plc from 2011 to 2013?
A1: 185.81

[[ ## evidence_snippets ## ]]
[PRE]
stock performance graph * $ 100 invested on 11/17/11 in our stock or 10/31/11 in the relevant index , including reinvestment of dividends . fiscal year ending december 31 , 2013 . ( 1 ) delphi automotive plc ( 2 ) s&amp;p 500 2013 standard &amp; poor 2019s 500 total return index ( 3 ) automotive supplier peer group 2013 russell 3000 auto parts index , including american axle &amp; manufacturing , borgwarner inc. , cooper tire &amp; rubber company , dana holding corp. , delphi automotive plc , dorman products inc. , federal-mogul corp. , ford motor co. , fuel systems solutions inc. , general motors co. , gentex corp. , gentherm inc. , genuine parts co. , johnson controls inc. , lkq corp. , lear corp. , meritor inc. , remy international inc. , standard motor products inc. , stoneridge inc. , superior industries international , trw automotive holdings corp. , tenneco inc. , tesla motors inc. , the goodyear tire &amp; rubber co. , tower international inc. , visteon corp. , and wabco holdings inc . company index november 17 , december 31 , december 31 , december 31 .
[/PRE]
[POST]
dividends on february 26 , 2013 , the board of directors approved the initiation of dividend payments on the company&#39;s ordinary shares . the board of directors declared a regular quarterly cash dividend of $ 0.17 per ordinary share that was paid in each quarter of 2013 . in addition , in january 2014 , the board of directors declared a regular quarterly cash dividend of $ 0.25 per ordinary share , payable on february 27 , 2014 to shareholders of record at the close of business on february 18 , 2014 . in october 2011 , the board of managers of delphi automotive llp approved a distribution of approximately $ 95 million , which was paid on december 5 , 2011 , principally in respect of taxes , to members of delphi automotive llp who held membership interests as of the close of business on october 31 , 2011. .
[/POST]

[[ ## table ## ]]
| Row | delphi automotive plc ( 1 ) | s&amp;p 500 ( 2 ) | automotive supplier peer group ( 3 ) | delphi automotive plc ( 1 ) | s&amp;p 500 ( 2 ) | automotive supplier peer group ( 3 ) | delphi automotive plc ( 1 ) | s&amp;p 500 ( 2 ) | automotive supplier peer group ( 3 ) | delphi automotive plc ( 1 ) | s&amp;p 500 ( 2 ) | automotive supplier peer group ( 3 ) |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| november 17 2011 | 100.0 | 100.0 | 100.0 | 100.0 | 100.0 | 100.0 | 100.0 | 100.0 | 100.0 | 100.0 | 100.0 | 100.0 |
| december 31 2011 | 100.98 | 100.8 | 89.27 | 100.98 | 100.8 | 89.27 | 100.98 | 100.8 | 89.27 | 100.98 | 100.8 | 89.27 |
| december 31 2012 | 179.33 | 116.93 | 110.41 | 179.33 | 116.93 | 110.41 | 179.33 | 116.93 | 110.41 | 179.33 | 116.93 | 110.41 |
| december 31 2013 | 285.81 | 154.8 | 166.46 | 285.81 | 154.8 | 166.46 | 285.81 | 154.8 | 166.46 | 285.81 | 154.8 | 166.46 |

[[ ## question ## ]]
what return rate does this represent?

Respond with the corresponding output fields, starting with the field `[[ ## reasoning ## ]]`, then `[[ ## ops ## ]]`, then `[[ ## answer ## ]]`, and then ending with the marker for `[[ ## completed ## ]]`.


Response:

[[ ## reasoning ## ]]
The previous question (Q1) asked for the increase in value, which was calculated as 185.81. This value represents the difference between the investment value in 2013 (285.81) and the initial investment value in 2011 (100.0). To find the return rate, I need to divide this increase by the initial investment value. The initial investment value for Delphi Automotive PLC on November 17, 2011, was 100.0.

Therefore, the return rate is the increase (185.81) divided by the initial value (100.0).

[[ ## ops ## ]]
divide(185.81, 100.0)

[[ ## answer ## ]]
1.8581




</code></pre>
</div>
</div>
<p>As we can see, the above prompt has a good collection of few-shot examples, which have helped improve the model‚Äôs performance.</p>
<p>The <em>optimised</em> programs can also be saved to disk, so that we can re-use them later.</p>
<div id="cell-34" class="cell" data-execution_count="94">
<div class="sourceCode" id="cb25"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">id</span>, oc <span class="kw">in</span> <span class="bu">enumerate</span>(bootstrap_rs_easy_compiled_programs):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    model_name <span class="op">=</span> selected_llms[<span class="bu">id</span>].model</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    sanitized_model_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[-/\.]&quot;</span>, <span class="st">&quot;_&quot;</span>, model_name)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    oc.save(<span class="ss">f&quot;./programs/</span><span class="sc">{</span>sanitized_model_name<span class="sc">}</span><span class="ss">_bootstrap_rs_easy/&quot;</span>, save_program<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<section id="evaluation" class="level4">
<h4>Evaluation</h4>
<p>While the models work well on our <em>randomly sampled</em> subset, to compare them fairly to the zero-shot versions, we need to run the evaluation on the <code>validation</code> sets, similar to what we did in the <code>modelling</code> notebook.</p>
<div id="cell-37" class="cell" data-execution_count="96">
<div class="sourceCode" id="cb26"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>gate_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;validation_datasets/gate_ids.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>probe_medium_ids <span class="op">=</span> pd.read_json(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;validation_datasets/probe_medium_ids.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>probe_hard_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;validation_datasets/probe_hard_ids.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div id="cell-38" class="cell" data-execution_count="97">
<div class="sourceCode" id="cb27"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>gate_df <span class="op">=</span> easy_valid_df[easy_valid_df[<span class="st">&quot;id&quot;</span>].isin(gate_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>probe_df <span class="op">=</span> pd.concat(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        medium_valid_df[medium_valid_df[<span class="st">&quot;id&quot;</span>].isin(probe_medium_ids[<span class="st">&quot;id&quot;</span>])],</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        hard_valid_df[hard_valid_df[<span class="st">&quot;id&quot;</span>].isin(probe_hard_ids[<span class="st">&quot;id&quot;</span>])],</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>).copy()</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gate_df.shape[<span class="dv">0</span>] <span class="op">==</span> gate_ids.shape[<span class="dv">0</span>]</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> probe_df.shape[<span class="dv">0</span>] <span class="op">==</span> probe_medium_ids.shape[<span class="dv">0</span>] <span class="op">+</span> probe_hard_ids.shape[<span class="dv">0</span>]</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>gate_examples <span class="op">=</span> to_turn_examples(gate_df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>probe_examples <span class="op">=</span> to_turn_examples(probe_df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span>)</span></code></pre></div>
</div>
<div id="cell-39" class="cell" data-execution_count="104">
<div class="sourceCode" id="cb28"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>bootstrap_rs_gate_valid_results <span class="op">=</span> []</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;gate_dataset_results&quot;</span>) <span class="im">as</span> parent_ctx:</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, candidate_lm <span class="kw">in</span> <span class="bu">enumerate</span>(selected_llms):</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;bootstrap_rs_gate_valid_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>            current_evaluator <span class="op">=</span> Evaluate(</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>                devset<span class="op">=</span>gate_examples,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>                num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>                display_progress<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>                <span class="co"># display_table=True,</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># provide_traceback=True,</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>                return_all_scores<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>                return_outputs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>                current_result <span class="op">=</span> current_evaluator(</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>                    bootstrap_rs_easy_compiled_programs[idx], metric<span class="op">=</span>turn_em_metric</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>                bootstrap_rs_gate_valid_results.append(current_result)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 108.00 / 151 (71.5%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 151/151 [00:05&lt;00:00, 28.47it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/3/runs/f51f5cb2ef784fee83e3c8d90d36c810
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run bootstrap_rs_gate_valid_openai_o4-mini-2025-04-16 at: http://localhost:5000/#/experiments/3/runs/11ab97c789e74ad49817a6ff42545b71
üß™ View experiment at: http://localhost:5000/#/experiments/3
...
2025/07/29 01:46:14 INFO dspy.evaluate.evaluate: Average Metric: 115.0 / 151 (76.2%)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<div id="cell-40" class="cell" data-execution_count="105">
<div class="sourceCode" id="cb31"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bootstrap_rs_gate_valid_results[<span class="dv">0</span>][<span class="dv">0</span>])</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bootstrap_rs_gate_valid_results[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bootstrap_rs_gate_valid_results[<span class="dv">2</span>][<span class="dv">0</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>71.52
76.82
76.16</code></pre>
</div>
</div>
<p>We have the following results:</p>
<table>
<colgroup>
<col style="width: 22%" />
<col style="width: 19%" />
<col style="width: 34%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>model_name</th>
<th>zero_shot_perform</th>
<th>bootstrapfewshotwithrandomsearch</th>
<th>pct_change_vs_zero_shot</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>60.0</td>
<td>71.52</td>
<td>+19.2%</td>
</tr>
<tr class="even">
<td>gemini-2.5-flash</td>
<td>70</td>
<td>76.82</td>
<td>+9.7%</td>
</tr>
<tr class="odd">
<td>o3</td>
<td>80</td>
<td>76.16</td>
<td>-4.8%</td>
</tr>
</tbody>
</table>
<p>We see the small reasoning models have significant gains in performance, especially o4-mini which now has a total score of 71.52% on the <code>gate</code> dataset.</p>
<p>However, we also see a slight reduction in the performance of o3. This could be because the few shot are acting as distractors, likely because they are noisy(as seen in our previous notebook).</p>
<p>We will explore another method before moving on!</p>
</section>
</section>
<section id="miprov2" class="level3">
<h3>MIPROv2</h3>
<p>The previous method, BootstrapFewShotWithRandomSearch, was able to generate a good collection of few-shot examples, which have helped improve the model‚Äôs performance. However, we see that the prompt instructions themselves were not optimised for the model, and could be improved.</p>
<p>MIPROv2 aims to be the best of both worlds: It will jointly optimise both the selected few-shot examples, as well as the instructions, using Bayesion Optimisation. Internally, it will just ask the LLMs for a better prompt, a technique called <strong>metaprompting</strong>, first released by <a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/prompt-generator">Anthropic</a>.</p>
<p>MIPROv2 has 3 optimisation modes: <code>light</code>, <code>medium</code>, <code>heavy</code>, which map well to our existing curriculum learning approach of splitting the datasets.</p>
<section id="setup-1" class="level4">
<h4>Setup</h4>
<p>While MIPROv2 gives the best results with large data, due to time and cost constraints, we will evaluate it on <em>micro</em> datasets.</p>
<p>Specifically, from our existing curriculum of easy, medium, and hard datasets, we will select a small subset for train and validation.</p>
<p>Once we‚Äôve finished the optimisation for all stages, we will run the final evaluation on the full <code>test</code> dataset i.e easy_test + medium_test + hard_test.</p>
<div id="cell-46" class="cell" data-execution_count="135">
<div class="sourceCode" id="cb33"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>micro_easy_train_df <span class="op">=</span> easy_train_df.sample(n<span class="op">=</span><span class="dv">120</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>micro_easy_valid_df <span class="op">=</span> easy_valid_df.sample(n<span class="op">=</span><span class="dv">30</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>micro_medium_train_df <span class="op">=</span> medium_train_df.sample(n<span class="op">=</span><span class="dv">200</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>micro_medium_valid_df <span class="op">=</span> medium_valid_df.sample(n<span class="op">=</span><span class="dv">50</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>micro_hard_train_df <span class="op">=</span> hard_train_df.sample(n<span class="op">=</span><span class="dv">200</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>micro_hard_valid_df <span class="op">=</span> hard_valid_df.sample(n<span class="op">=</span><span class="dv">60</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>micro_easy_train_examples <span class="op">=</span> to_turn_examples(</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    micro_easy_train_df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>micro_easy_valid_examples <span class="op">=</span> to_turn_examples(</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    micro_easy_valid_df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>micro_medium_train_examples <span class="op">=</span> to_turn_examples(</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    micro_medium_train_df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>micro_medium_valid_examples <span class="op">=</span> to_turn_examples(</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    micro_medium_valid_df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>micro_hard_train_examples <span class="op">=</span> to_turn_examples(</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    micro_hard_train_df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>micro_hard_valid_examples <span class="op">=</span> to_turn_examples(</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    micro_hard_valid_df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<p>To save further costs, we will run MIPROv2 on only the smaller reasoning models</p>
<ul>
<li>o4-mini</li>
<li>gemini-2.5-flash</li>
</ul>
<div id="cell-48" class="cell" data-execution_count="133">
<div class="sourceCode" id="cb34"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>mipro_llms <span class="op">=</span> [lm_oai_o4_mini, lm_gemini_flash_2_5]</span></code></pre></div>
</div>
</section>
<section id="curriculum-learning-easy" class="level4">
<h4>Curriculum Learning: Easy</h4>
<p>Since we have a new validation set for MIPROv2, we first need to establish a baseline performance.</p>
<div id="cell-51" class="cell" data-execution_count="138">
<div class="sourceCode" id="cb35"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>baseline_results <span class="op">=</span> []</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;baseline_micro_easy&quot;</span>) <span class="im">as</span> parent_ctx:</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> candidate_lm <span class="kw">in</span> mipro_llms:</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;baseline_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>            current_evaluator <span class="op">=</span> Evaluate(</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>                devset<span class="op">=</span>micro_easy_valid_examples,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>                num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>                display_progress<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>                <span class="co"># display_table=True,</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># provide_traceback=True,</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>                return_all_scores<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>                return_outputs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>                current_result <span class="op">=</span> current_evaluator(</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>                    TurnSolver(reasoning_lm<span class="op">=</span><span class="va">True</span>), metric<span class="op">=</span>turn_em_metric</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>                baseline_results.append(current_result)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 11.00 / 21 (52.4%):  22%|‚ñà‚ñà‚ñè       | 21/95 [00:00&lt;00:01, 50.20it/s]Average Metric: 34.00 / 62 (54.8%):  64%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç   | 61/95 [00:01&lt;00:00, 81.06it/s]Average Metric: 36.00 / 64 (56.2%):  66%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã   | 63/95 [00:01&lt;00:00, 81.06it/s]Average Metric: 60.00 / 95 (63.2%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 95/95 [00:01&lt;00:00, 74.14it/s] 
üèÉ View run eval at: http://localhost:5000/#/experiments/3/runs/12c628a13fc142ee96326609276a54a9
üß™ View experiment at: http://localhost:5000/#/experiments/3
...
2025/07/29 11:49:27 INFO dspy.evaluate.evaluate: Average Metric: 61.0 / 95 (64.2%)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<p>The results are as follows:</p>
<table>
<thead>
<tr class="header">
<th>model_name</th>
<th>micro_easy_valid_set em_metric</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>63.16</td>
</tr>
<tr class="even">
<td>gemini-2.5-flash</td>
<td>64.21</td>
</tr>
</tbody>
</table>
<p>We will now aim to improve the performance of each of these models, using the MIPROv2 optimiser.</p>
<div id="cell-53" class="cell" data-execution_count="139">
<div class="sourceCode" id="cb38"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> litellm</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.teleprompt <span class="im">import</span> MIPROv2</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Config needed to prevent the optimizer from using _unsupported_ temperature</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># for reasoning models.</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>litellm.drop_params <span class="op">=</span> <span class="va">True</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    max_bootstrapped_demos<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    max_labeled_demos<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    auto<span class="op">=</span><span class="st">&quot;light&quot;</span>,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    log_dir<span class="op">=</span><span class="st">&quot;./mipro_micro_logs&quot;</span>,</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>mipro_micro_easy_compiled_programs <span class="op">=</span> []</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;mipro_micro_easy&quot;</span>):</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> candidate_lm <span class="kw">in</span> mipro_llms:</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;mipro_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>                teleprompter <span class="op">=</span> MIPROv2(metric<span class="op">=</span>turn_em_metric, <span class="op">**</span>config)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>                optimized_program <span class="op">=</span> teleprompter.<span class="bu">compile</span>(</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>                    dspy.ChainOfThought(SolveTurnWithReasoning),</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>                    trainset<span class="op">=</span>micro_easy_train_examples,</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>                    valset<span class="op">=</span>micro_easy_valid_examples,</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>                    requires_permission_to_run<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>                mipro_micro_easy_compiled_programs.append(optimized_program)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/29 11:49:54 INFO dspy.teleprompt.mipro_optimizer_v2: 
RUNNING WITH THE FOLLOWING LIGHT AUTO RUN SETTINGS:
num_trials: 10
minibatch: True
num_fewshot_candidates: 6
num_instruct_candidates: 3
valset size: 95

2025/07/29 11:49:54 INFO dspy.teleprompt.mipro_optimizer_v2: 
==&gt; STEP 1: BOOTSTRAP FEWSHOT EXAMPLES &lt;==
2025/07/29 11:49:54 INFO dspy.teleprompt.mipro_optimizer_v2: These will be used as few-shot example candidates for our program and for creating instructions.

2025/07/29 11:49:54 INFO dspy.teleprompt.mipro_optimizer_v2: Bootstrapping N=6 sets of demonstrations...
  1%|          | 2/350 [00:00&lt;00:11, 30.06it/s]
  1%|          | 2/350 [00:00&lt;00:12, 28.92it/s]
  1%|          | 3/350 [00:00&lt;00:10, 32.53it/s]
  1%|          | 2/350 [00:00&lt;00:12, 28.96it/s]
2025/07/29 11:49:56 INFO dspy.teleprompt.mipro_optimizer_v2: 
==&gt; STEP 2: PROPOSE INSTRUCTION CANDIDATES &lt;==
2025/07/29 11:49:56 INFO dspy.teleprompt.mipro_optimizer_v2: We will use the few-shot examples from the previous step, a generated dataset summary, a summary of the program code, and a randomly selected prompting tip to propose instructions.
2025/07/29 11:49:57 INFO dspy.teleprompt.mipro_optimizer_v2: 
Proposing N=3 instructions...

2025/07/29 11:49:57 INFO dspy.teleprompt.mipro_optimizer_v2: Proposed Instructions for Predictor 0:

2025/07/29 11:49:57 INFO dspy.teleprompt.mipro_optimizer_v2: 0: Given the fields `conversation_context`, `evidence_snippets`, `table`, `question`, produce the fields `reasoning`, `ops`, `answer`.

2025/07/29 11:49:57 INFO dspy.teleprompt.mipro_optimizer_v2: 1: You are a financial analyst AI specializing in conversational question answering over corporate financial tables. Given the following inputs:

...
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run mipro_micro_easy at: http://localhost:5000/#/experiments/3/runs/94952a4430d948679def7185323e94d1
üß™ View experiment at: http://localhost:5000/#/experiments/3</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5a8ddcf2946945f79b498455e3351698","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fd907e290bb742ce842a12fcbe1c8fcf","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ae89b351c5c748a4bc7c5e5f9abc80f8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5dc79f7f27c44f8185dd4f56bfb8d46e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1181782cc6d647bbb4b6e0efa3480ed8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bfc71ed9d6f64e50af0de00d0ef033f7","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6e972df862754df7be79c92decabd418","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bdf8720cec1b40fe9cc7307bb7bde07b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7da7860e37b24881ab369982b5a434b6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"28e90e5f6dd7412cb28579af492b30da","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7e5e85ce3aaf4f60ad1e69a056cbe49c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"74788ae1ac174af59e6fcc0914c3bda3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"63db190929884393aefdb08bcfc65216","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"839a9c5d4bd94698a483eeb556df0d1d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d524442fa37c40d8b3e0bfc8467b160a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"49bb3dc9f1da4590a636e18728b0b087","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fc4f69be57ad4f17bf543b6ace970ef5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a866d58fa6e14610ad791a7d9230770c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<p>We now have the following results:</p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 31%" />
<col style="width: 26%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th>model_name</th>
<th>em_metric before optimisation</th>
<th>em_metric after MIPROv2</th>
<th>% increase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>63.16</td>
<td>74.74</td>
<td>18.3%</td>
</tr>
<tr class="even">
<td>gemini-2.5-flash</td>
<td>64.21</td>
<td>71.58</td>
<td>11.5%</td>
</tr>
</tbody>
</table>
<p>We see significant improvement in performance for both models, with o4-mini getting the best result at 74.74%. Looking at the prompt</p>
<div id="cell-55" class="cell" data-execution_count="141">
<div class="sourceCode" id="cb41"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>mipro_micro_easy_compiled_programs[<span class="dv">0</span>].inspect_history(n<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>



[2025-07-29T11:50:11.459861]

System message:

Your input fields are:
1. `conversation_context` (str): Conversation so far
2. `evidence_snippets` (str): Snippets of evidence surrounding the table
3. `table` (str): Input financial table with metrics
4. `question` (str): Question to answer
Your output fields are:
1. `reasoning` (str): Reasoning behind the answer. Carefully analyze the conversation_context, and especially the evidence_snippets and table for the given question, and generate your reasoning before generating the ops and answer.
2. `ops` (str): Comma-separated ConvFinQA DSL program. Allowed ops: add(x, y), subtract(x, y), multiply(x, y), divide(x, y), exp(x, y), greater(x, y). Args may be constants (e.g., const_100), numbers (int or float), or prior step refs (#0, #1‚Ä¶). Order always follows the pattern x &lt;op&gt; y‚Äîpick x and y deliberately. Example: subtract(const_100, 42), divide(#0, 3.14). Convert to percentages only if explicitly asked in the question.
3. `answer` (str): Final answer. This will be a single number, or a boolean string(yes/no)
All interactions will be structured in the following way, with the appropriate values filled in.

[[ ## conversation_context ## ]]
{conversation_context}

[[ ## evidence_snippets ## ]]
{evidence_snippets}

[[ ## table ## ]]
{table}

[[ ## question ## ]]
{question}

[[ ## reasoning ## ]]
{reasoning}

[[ ## ops ## ]]
{ops}

[[ ## answer ## ]]
{answer}

[[ ## completed ## ]]
In adhering to this structure, your objective is: 
        You are a financial analyst AI specializing in conversational question answering over corporate financial tables. Given the following inputs:
        
        Conversation Context: {conversation_context}  
        Evidence Snippets: {evidence_snippets}  
        Table: {table}  
        Question: {question}  
        
        Produce exactly three output sections:
        
        1. Reasoning: A clear, step-by-step natural-language analysis showing how you locate numbers in the table or snippets and how you plan to compute the answer.  
        2. Ops: A comma-separated ConvFinQA DSL program (using only add(x,y), subtract(x,y), multiply(x,y), divide(x,y), exp(x,y), greater(x,y)) that implements your reasoning. Reference constants or prior steps (#0, #1, ‚Ä¶) in the form ‚Äúop(arg1,arg2)‚Äù. Only convert to percentages if explicitly asked.  
        3. Answer: The final result as a single number or ‚Äúyes‚Äù/‚Äúno‚Äù.  
        
        Use the prefixes ‚ÄúReasoning:‚Äù, ‚ÄúOps:‚Äù, and ‚ÄúAnswer:‚Äù exactly, and do not include any additional sections or commentary.


User message:

[[ ## conversation_context ## ]]
Q1: what was the net change in value of ars investments from 2008 to 2009?
A1: -12.0
Q2: what was the 2008 value?
A2: 192.0

[[ ## evidence_snippets ## ]]
[PRE]
mastercard incorporated notes to consolidated financial statements 2014continued the municipal bond portfolio is comprised of tax exempt bonds and is diversified across states and sectors . the portfolio has an average credit quality of double-a . the short-term bond funds invest in fixed income securities , including corporate bonds , mortgage-backed securities and asset-backed securities . the company holds investments in ars . interest on these securities is exempt from u.s . federal income tax and the interest rate on the securities typically resets every 35 days . the securities are fully collateralized by student loans with guarantees , ranging from approximately 95% ( 95 % ) to 98% ( 98 % ) of principal and interest , by the u.s . government via the department of education . beginning on february 11 , 2008 , the auction mechanism that normally provided liquidity to the ars investments began to fail . since mid-february 2008 , all investment positions in the company 2019s ars investment portfolio have experienced failed auctions . the securities for which auctions have failed have continued to pay interest in accordance with the contractual terms of such instruments and will continue to accrue interest and be auctioned at each respective reset date until the auction succeeds , the issuer redeems the securities or they mature . during 2008 , ars were reclassified as level 3 from level 2 . as of december 31 , 2010 , the ars market remained illiquid , but issuer call and redemption activity in the ars student loan sector has occurred periodically since the auctions began to fail . during 2010 and 2009 , the company did not sell any ars in the auction market , but there were calls at par . the table below includes a roll-forward of the company 2019s ars investments from january 1 , 2009 to december 31 , 2010 . significant unobservable inputs ( level 3 ) ( in millions ) .
[/PRE]
[POST]
the company evaluated the estimated impairment of its ars portfolio to determine if it was other-than- temporary . the company considered several factors including , but not limited to , the following : ( 1 ) the reasons for the decline in value ( changes in interest rates , credit event , or market fluctuations ) ; ( 2 ) assessments as to whether it is more likely than not that it will hold and not be required to sell the investments for a sufficient period of time to allow for recovery of the cost basis ; ( 3 ) whether the decline is substantial ; and ( 4 ) the historical and anticipated duration of the events causing the decline in value . the evaluation for other-than-temporary impairments is a quantitative and qualitative process , which is subject to various risks and uncertainties . the risks and uncertainties include changes in credit quality , market liquidity , timing and amounts of issuer calls and interest rates . as of december 31 , 2010 , the company believed that the unrealized losses on the ars were not related to credit quality but rather due to the lack of liquidity in the market . the company believes that it is more .
[/POST]

[[ ## table ## ]]
| Row | fair value december 31 2008 | calls at par | recovery of unrealized losses due to issuer calls | increase in fair value | fair value december 31 2009 | fair value december 31 2010 |
|---|---|---|---|---|---|---|
| significant unobservable inputs ( level 3 ) ( in millions ) | 192.0 | -94.0 | 13.0 | 7.0 | 180.0 | 106.0 |

[[ ## question ## ]]
what is the net change divided by the 2008 value?


Assistant message:

[[ ## reasoning ## ]]
From the table, the fair value at December 31, 2008 was 192.0 and at December 31, 2009 was 180.0.  
Net change = 180.0 ‚àí 192.0 = ‚àí12.0.  
Divide the net change by the 2008 value: ‚àí12.0 √∑ 192.0 = ‚àí0.0625.

[[ ## ops ## ]]
subtract(180.0,192.0), divide(#0,192.0)

[[ ## answer ## ]]
-0.0625


User message:

[[ ## conversation_context ## ]]
Q1: what was the expense of class a common stock issued to non-executive directors in 2010?
A1: 2.4

[[ ## evidence_snippets ## ]]
[PRE]
the company granted 1020 performance shares . the vesting of these shares is contingent on meeting stated goals over a performance period . beginning with restricted stock grants in september 2010 , dividends are accrued on restricted class a common stock and restricted stock units and are paid once the restricted stock vests . the following table summarizes restricted stock and performance shares activity for 2010 : number of shares weighted average grant date fair value .
[/PRE]
[POST]
the total fair value of restricted stock that vested during the years ended december 31 , 2010 , 2009 and 2008 , was $ 10.3 million , $ 6.2 million and $ 2.5 million , respectively . eligible employees may acquire shares of cme group 2019s class a common stock using after-tax payroll deductions made during consecutive offering periods of approximately six months in duration . shares are purchased at the end of each offering period at a price of 90% ( 90 % ) of the closing price of the class a common stock as reported on the nasdaq . compensation expense is recognized on the dates of purchase for the discount from the closing price . in 2010 , 2009 and 2008 , a total of 4371 , 4402 and 5600 shares , respectively , of class a common stock were issued to participating employees . these shares are subject to a six-month holding period . annual expense of $ 0.1 million for the purchase discount was recognized in 2010 , 2009 and 2008 , respectively . non-executive directors receive an annual award of class a common stock with a value equal to $ 75000 . non-executive directors may also elect to receive some or all of the cash portion of their annual stipend , up to $ 25000 , in shares of stock based on the closing price at the date of distribution . as a result , 7470 , 11674 and 5509 shares of class a common stock were issued to non-executive directors during 2010 , 2009 and 2008 , respectively . these shares are not subject to any vesting restrictions . expense of $ 2.4 million , $ 2.5 million and $ 2.4 million related to these stock-based payments was recognized for the years ended december 31 , 2010 , 2009 and 2008 , respectively. .
[/POST]

[[ ## table ## ]]
| Row | outstanding at december 31 2009 | granted | vested | cancelled | outstanding at december 31 2010 | outstanding at december 31 2009 | granted | vested | cancelled | outstanding at december 31 2010 |
|---|---|---|---|---|---|---|---|---|---|---|
| number of shares | 116677.0 | 134245.0 | -34630.0 | -19830.0 | 196462.0 | 116677.0 | 134245.0 | -34630.0 | -19830.0 | 196462.0 |
| weighted average grant date fair value | 280.0 | 275.0 | 257.0 | 260.0 | 283.0 | 280.0 | 275.0 | 257.0 | 260.0 | 283.0 |

[[ ## question ## ]]
what is that times 1000000?


Assistant message:

[[ ## reasoning ## ]]
The expense of class A common stock issued to non-executive directors in 2010 was $2.4 million. Multiplying that by 1,000,000 converts millions to units: 2.4 √ó 1,000,000 = 2,400,000.

[[ ## ops ## ]]
multiply(const_2.4,const_1000000)

[[ ## answer ## ]]
2400000


User message:

[[ ## conversation_context ## ]]
Q1: what is the increase in the total expense related to the defined contribution plan for non-u.s.employees from 2010 to 2011?
A1: 9.7
Q2: what is the total expense related to the defined contribution plan for non-u.s.employees in 2010?
A2: 11.7

[[ ## evidence_snippets ## ]]
[PRE]
the following is a schedule of future minimum rental payments required under long-term operating leases at october 29 , 2011 : fiscal years operating leases .
[/PRE]
[POST]
12 . commitments and contingencies from time to time in the ordinary course of the company 2019s business , various claims , charges and litigation are asserted or commenced against the company arising from , or related to , contractual matters , patents , trademarks , personal injury , environmental matters , product liability , insurance coverage and personnel and employment disputes . as to such claims and litigation , the company can give no assurance that it will prevail . the company does not believe that any current legal matters will have a material adverse effect on the company 2019s financial position , results of operations or cash flows . 13 . retirement plans the company and its subsidiaries have various savings and retirement plans covering substantially all employees . the company maintains a defined contribution plan for the benefit of its eligible u.s . employees . this plan provides for company contributions of up to 5% ( 5 % ) of each participant 2019s total eligible compensation . in addition , the company contributes an amount equal to each participant 2019s pre-tax contribution , if any , up to a maximum of 3% ( 3 % ) of each participant 2019s total eligible compensation . the total expense related to the defined contribution plan for u.s . employees was $ 21.9 million in fiscal 2011 , $ 20.5 million in fiscal 2010 and $ 21.5 million in fiscal 2009 . the company also has various defined benefit pension and other retirement plans for certain non-u.s . employees that are consistent with local statutory requirements and practices . the total expense related to the various defined benefit pension and other retirement plans for certain non-u.s . employees was $ 21.4 million in fiscal 2011 , $ 11.7 million in fiscal 2010 and $ 10.9 million in fiscal 2009 . non-u.s . plan disclosures the company 2019s funding policy for its foreign defined benefit pension plans is consistent with the local requirements of each country . the plans 2019 assets consist primarily of u.s . and non-u.s . equity securities , bonds , property and cash . the benefit obligations and related assets under these plans have been measured at october 29 , 2011 and october 30 , 2010 . analog devices , inc . notes to consolidated financial statements 2014 ( continued ) .
[/POST]

[[ ## table ## ]]
| Row | 2012 | 2013 | 2014 | 2015 | 2016 | later years | total |
|---|---|---|---|---|---|---|---|
| operating leases | 17590.0 | 12724.0 | 6951.0 | 5649.0 | 3669.0 | 19472.0 | 66055.0 |

[[ ## question ## ]]
what growth rate does this represent?

Respond with the corresponding output fields, starting with the field `[[ ## reasoning ## ]]`, then `[[ ## ops ## ]]`, then `[[ ## answer ## ]]`, and then ending with the marker for `[[ ## completed ## ]]`.


Response:

[[ ## reasoning ## ]]
The expense for non-U.S. employees was $11.7 million in 2010 and $21.4 million in 2011, an increase of $9.7 million. The growth rate is the increase divided by the 2010 base: 9.7 / 11.7 ‚âà 0.8291.

[[ ## ops ## ]]
divide(const_9.7,const_11.7)

[[ ## answer ## ]]
0.8291

[[ ## completed ## ]]




</code></pre>
</div>
</div>
<p>We see a super-detailed prompt, complete with both few-shot examples and detailed instructions on the role of the model and the expected output. All of this was achevied without prompting by hand!!</p>
<p>We‚Äôll also save this programs to disk, for future reference.</p>
<div id="cell-57" class="cell" data-execution_count="142">
<div class="sourceCode" id="cb43"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">id</span>, oc <span class="kw">in</span> <span class="bu">enumerate</span>(mipro_micro_easy_compiled_programs):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    model_name <span class="op">=</span> selected_llms[<span class="bu">id</span>].model</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    sanitized_model_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[-/\.]&quot;</span>, <span class="st">&quot;_&quot;</span>, model_name)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    oc.save(<span class="ss">f&quot;./programs/</span><span class="sc">{</span>sanitized_model_name<span class="sc">}</span><span class="ss">_mipro_micro_easy/&quot;</span>, save_program<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<p>Next, we will use these compiled programs as the starting point, and optimise the upcoming stages i.e <strong>finally do curriculum learning!</strong></p>
</section>
<section id="curriculum-learning-medium" class="level4">
<h4>Curriculum Learning: Medium</h4>
<p>We will just re-run the same loop as above, with the compiled programs as the starting point, and the datasets changed to the <code>medium</code> stage.</p>
<p>First, let‚Äôs benchmark the <code>optimised programns</code> from the easy stage on the <code>medium</code> validation set</p>
<div id="cell-61" class="cell" data-execution_count="143">
<div class="sourceCode" id="cb44"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>baseline_medium_results <span class="op">=</span> []</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;baseline_micro_medium&quot;</span>) <span class="im">as</span> parent_ctx:</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, candidate_lm <span class="kw">in</span> <span class="bu">enumerate</span>(mipro_llms):</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;baseline_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>            current_evaluator <span class="op">=</span> Evaluate(</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                devset<span class="op">=</span>micro_medium_valid_examples,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>                display_progress<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>                return_all_scores<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>                return_outputs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>                current_result <span class="op">=</span> current_evaluator(</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>                    mipro_micro_easy_compiled_programs[idx], metric<span class="op">=</span>turn_em_metric</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>                baseline_medium_results.append(current_result)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 153.00 / 194 (78.9%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 194/194 [01:11&lt;00:00,  2.71it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/3/runs/d329a74cf0d348a5bc0cef64cf208e43
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run baseline_openai_o4-mini-2025-04-16 at: http://localhost:5000/#/experiments/3/runs/0f2a019e21524ae4ae71ff96d4f1c8a6
üß™ View experiment at: http://localhost:5000/#/experiments/3
Average Metric: 150.00 / 194 (77.3%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 194/194 [00:45&lt;00:00,  4.23it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/3/runs/1137bcdb00824fa8bed994f464c903e6
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run baseline_gemini_gemini-2_5-flash at: http://localhost:5000/#/experiments/3/runs/2db710ec2ad44542b84f3d13bae2566c
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run baseline_micro_medium at: http://localhost:5000/#/experiments/3/runs/25cae29dfdc242478bae535c60e644e1
üß™ View experiment at: http://localhost:5000/#/experiments/3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/29 12:04:59 INFO dspy.evaluate.evaluate: Average Metric: 153.0 / 194 (78.9%)
2025/07/29 12:05:45 INFO dspy.evaluate.evaluate: Average Metric: 150.0 / 194 (77.3%)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<p>The results are as follows:</p>
<table>
<thead>
<tr class="header">
<th>model_name</th>
<th>micro_medium_valid_set em_metric</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>78.9%</td>
</tr>
<tr class="even">
<td>gemini-2.5-flash</td>
<td>77.30%</td>
</tr>
</tbody>
</table>
<p>We will now aim to improve the performance of each of these models, using the MIPROv2 optimiser.</p>
<div id="cell-63" class="cell" data-execution_count="145">
<div class="sourceCode" id="cb47"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    max_bootstrapped_demos<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    max_labeled_demos<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    auto<span class="op">=</span><span class="st">&quot;light&quot;</span>,  <span class="co"># Still keeping this as light as this is computationally expensive</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    log_dir<span class="op">=</span><span class="st">&quot;./mipro_micro_logs&quot;</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>mipro_micro_medium_compiled_programs <span class="op">=</span> []</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;mipro_micro_medium&quot;</span>):</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, candidate_lm <span class="kw">in</span> <span class="bu">enumerate</span>(mipro_llms):</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;mipro_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>                teleprompter <span class="op">=</span> MIPROv2(metric<span class="op">=</span>turn_em_metric, <span class="op">**</span>config)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>                optimized_program <span class="op">=</span> teleprompter.<span class="bu">compile</span>(</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>                    mipro_micro_easy_compiled_programs[idx],</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>                    trainset<span class="op">=</span>micro_medium_train_examples,</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>                    valset<span class="op">=</span>micro_medium_valid_examples,</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>                    requires_permission_to_run<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>                mipro_micro_medium_compiled_programs.append(optimized_program)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/29 12:07:51 INFO dspy.teleprompt.mipro_optimizer_v2: 
RUNNING WITH THE FOLLOWING LIGHT AUTO RUN SETTINGS:
num_trials: 10
minibatch: True
num_fewshot_candidates: 6
num_instruct_candidates: 3
valset size: 100

2025/07/29 12:07:52 INFO dspy.teleprompt.mipro_optimizer_v2: 
==&gt; STEP 1: BOOTSTRAP FEWSHOT EXAMPLES &lt;==
2025/07/29 12:07:52 INFO dspy.teleprompt.mipro_optimizer_v2: These will be used as few-shot example candidates for our program and for creating instructions.

...
2025/07/29 12:26:15 INFO dspy.evaluate.evaluate: Average Metric: 91.0 / 100 (91.0%)
2025/07/29 12:26:15 INFO dspy.teleprompt.mipro_optimizer_v2: New best full eval score! Score: 91.0
2025/07/29 12:26:17 INFO dspy.teleprompt.mipro_optimizer_v2: Full eval scores so far: [81.0, 0.0, 91.0]
2025/07/29 12:26:17 INFO dspy.teleprompt.mipro_optimizer_v2: Best full score so far: 91.0
2025/07/29 12:26:17 INFO dspy.teleprompt.mipro_optimizer_v2: =======================
2025/07/29 12:26:17 INFO dspy.teleprompt.mipro_optimizer_v2: 

2025/07/29 12:26:17 INFO dspy.teleprompt.mipro_optimizer_v2: Returning best identified program with score 91.0!</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Bootstrapping set 1/6
Bootstrapping set 2/6
Bootstrapping set 3/6
...
Average Metric: 91.00 / 100 (91.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 100/100 [00:12&lt;00:00,  7.84it/s]
üèÉ View run eval_full_2 at: http://localhost:5000/#/experiments/3/runs/6390215385304cff8297d122dd799027
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run mipro_gemini_gemini-2_5-flash at: http://localhost:5000/#/experiments/3/runs/bfa8a54582554fad9a20ad3c1bcb0e98
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run mipro_micro_medium at: http://localhost:5000/#/experiments/3/runs/4c01dc5b8ebc463ead87e69fd8ab5c67
üß™ View experiment at: http://localhost:5000/#/experiments/3</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"87c99d0d95ff40b99dcc84643a5d30af","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a2c6b58c8ab84543b08cf1c79860630d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c2539bea47b9478197872a2f9a044c94","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e8e11cd7cc6d411d8880eadae3ca5a4e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ffd03016c90d4a7eba69cada2400aa93","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"717d5dd746114d448febe6c19016e665","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"161f54b87f594b848ffcf03e097dea03","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2bf783a86fef4d38b7767b0620620068","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b13062fcde19481598885ac8f3c04aca","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"308f6e3ceca647d581b37af7604c9b6c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"42dfe05be796463a9c6296c120066030","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"eeaab233ea7444ed9cc5beb6f9775f2f","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"135769d768bb4b8a80c4a4fcf976a84a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e820de5690d54a9eaab00108b4422611","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9b4fea7fdc01491da5d1472c8380ab92","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"aed1bff1b1354ecb80fb68f04307b4fb","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3c6f74f6143148a191c529b2472924c1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ac807e43a04f49af9b5e665a15a46f88","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<p>We now have the following results: We now have the following results:</p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 31%" />
<col style="width: 26%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th>model_name</th>
<th>em_metric before optimisation</th>
<th>em_metric after MIPROv2</th>
<th>% increase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>78.90</td>
<td>80.00</td>
<td>1.4%</td>
</tr>
<tr class="even">
<td>gemini-2.5-flash</td>
<td>77.30</td>
<td>91.00</td>
<td>17.7%</td>
</tr>
</tbody>
</table>
<p>Aha! We see significant improvement gemini-2.5-flash, and break the 90% accuracy barrier!</p>
<p>Looking at the prompt for the gemini-model:</p>
<div id="cell-65" class="cell" data-execution_count="146">
<div class="sourceCode" id="cb50"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>mipro_micro_medium_compiled_programs[<span class="dv">1</span>].inspect_history(n<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>



[2025-07-29T12:26:14.956939]

System message:

Your input fields are:
1. `conversation_context` (str): Conversation so far
2. `evidence_snippets` (str): Snippets of evidence surrounding the table
3. `table` (str): Input financial table with metrics
4. `question` (str): Question to answer
Your output fields are:
1. `reasoning` (str): Reasoning behind the answer. Carefully analyze the conversation_context, and especially the evidence_snippets and table for the given question, and generate your reasoning before generating the ops and answer.
2. `ops` (str): Comma-separated ConvFinQA DSL program. Allowed ops: add(x, y), subtract(x, y), multiply(x, y), divide(x, y), exp(x, y), greater(x, y). Args may be constants (e.g., const_100), numbers (int or float), or prior step refs (#0, #1‚Ä¶). Order always follows the pattern x &lt;op&gt; y‚Äîpick x and y deliberately. Example: subtract(const_100, 42), divide(#0, 3.14). Convert to percentages only if explicitly asked in the question.
3. `answer` (str): Final answer. This will be a single number, or a boolean string(yes/no)
All interactions will be structured in the following way, with the appropriate values filled in.

[[ ## conversation_context ## ]]
{conversation_context}

[[ ## evidence_snippets ## ]]
{evidence_snippets}

[[ ## table ## ]]
{table}

[[ ## question ## ]]
{question}

[[ ## reasoning ## ]]
{reasoning}

[[ ## ops ## ]]
{ops}

[[ ## answer ## ]]
{answer}

[[ ## completed ## ]]
In adhering to this structure, your objective is: 
        You are an expert financial AI assistant specialized in analyzing financial documents and answering complex numerical questions. Your primary goal is to accurately extract and compute information from both structured tables and unstructured text, even when answers depend on chained operations or require robust state management across multiple dialogue turns. You must also correctly interpret numerical values, including implicit units and signs, and format outputs appropriately for human-readable results.
        
        Given the `conversation_context` for multi-turn interactions, `evidence_snippets` for textual context, a `table` containing financial data, and the current `question`, your task is to:
        1.  First, generate a detailed `reasoning` that explains the logical steps to derive the answer, considering all relevant information from the context, snippets, and table.
        2.  Then, translate this reasoning into a precise sequence of `ops` using the ConvFinQA DSL, ensuring correct operations, references, and handling of numerical semantics.
        3.  Finally, provide the computed `answer` as a single number or a boolean.


User message:

This is an example of the task, though some input or output fields are not supplied.

[[ ## conversation_context ## ]]
Q1: as of april 3, 2010, what was the amount of doors in the wholesale segment in the europe geography?
A1: 4421.0
Q2: and what was the total amount of doors?
A2: 8940.0
Q3: what percentage, then, of this total did that amount in europe represent?
A3: 0.49452

[[ ## evidence_snippets ## ]]
[PRE]
table of contents worldwide distribution channels the following table presents the number of doors by geographic location , in which ralph lauren-branded products distributed by our wholesale segment were sold to consumers in our primary channels of distribution as of april 3 , 2010 : number of location doors ( a ) .
[/PRE]
[POST]
( a ) in asia-pacific , our products are primarily distributed through concessions-based sales arrangements . in addition , american living and chaps-branded products distributed by our wholesale segment were sold domestically through approximately 1700 doors as of april 3 , 2010 . we have five key department-store customers that generate significant sales volume . for fiscal 2010 , these customers in the aggregate accounted for approximately 45% ( 45 % ) of all wholesale revenues , with macy 2019s , inc . representing approximately 18% ( 18 % ) of these revenues . our product brands are sold primarily through their own sales forces . our wholesale segment maintains its primary showrooms in new york city . in addition , we maintain regional showrooms in atlanta , chicago , dallas , milan , paris , london , munich , madrid and stockholm . shop-within-shops . as a critical element of our distribution to department stores , we and our licensing partners utilize shop- within-shops to enhance brand recognition , to permit more complete merchandising of our lines by the department stores and to differentiate the presentation of products . shop-within-shops fixed assets primarily include items such as customized freestanding fixtures , wall cases and components , decorative items and flooring . as of april 3 , 2010 , we had approximately 14000 shop-within-shops dedicated to our ralph lauren-branded wholesale products worldwide . excluding significantly larger shop-within-shops in key department store locations , the size of our shop-within-shops typically ranges from approximately 300 to 6000 square feet . we normally share in the cost of these shop-within-shops with our wholesale customers . basic stock replenishment program . basic products such as knit shirts , chino pants and oxford cloth shirts can be ordered at any time through our basic stock replenishment programs . we generally ship these products within three-to-five days of order receipt . our retail segment as of april 3 , 2010 , our retail segment consisted of 179 full-price retail stores and 171 factory stores worldwide , totaling approximately 2.6 million square feet , 281 concessions-based shop-within-shops and two e-commerce websites . the extension of our direct-to-consumer reach is a primary long-term strategic goal . full-price retail stores our full-price retail stores reinforce the luxury image and distinct sensibility of our brands and feature exclusive lines that are not sold in domestic department stores . we opened 3 new full-price stores and closed 3 full-price stores in fiscal 2010 . in addition , we assumed 16 full-price stores in connection with the asia-pacific .
[/POST]

[[ ## table ## ]]
| Row | united states and canada | europe | japan | total |
|---|---|---|---|---|
| number of doors ( a ) | 4402.0 | 4421.0 | 117.0 | 8940.0 |

[[ ## question ## ]]
and what percentage of the total did the amount of doors in united states and canada represent?


Assistant message:

[[ ## reasoning ## ]]
Not supplied for this particular example. 

[[ ## ops ## ]]
divide(4402, 8940)

[[ ## answer ## ]]
0.49239


User message:

[[ ## conversation_context ## ]]
None

[[ ## evidence_snippets ## ]]
[PRE]
part i the following table details the growth in global weighted average berths and the global , north american and european cruise guests over the past five years : weighted-average supply of berths marketed globally ( 1 ) royal caribbean cruises ltd . total berths global cruise guests ( 1 ) north american cruise guests ( 2 ) european cruise guests ( 3 ) .
[/PRE]
[POST]
( 1 ) source : our estimates of the number of global cruise guests and the weighted-average supply of berths marketed globally are based on a com- bination of data that we obtain from various publicly available cruise industry trade information sources including seatrade insider , cruise industry news and cruise line international association ( 201cclia 201d ) . in addition , our estimates incorporate our own statistical analysis utilizing the same publicly available cruise industry data as a base . ( 2 ) source : cruise line international association based on cruise guests carried for at least two consecutive nights for years 2009 through 2012 . year 2013 amounts represent our estimates ( see number 1 above ) . includes the united states of america and canada . ( 3 ) source : clia europe , formerly european cruise council , for years 2009 through 2012 . year 2013 amounts represent our estimates ( see number 1 above ) . north america the majority of cruise guests are sourced from north america , which represented approximately 56% ( 56 % ) of global cruise guests in 2013 . the compound annual growth rate in cruise guests sourced from this market was approximately 3.2% ( 3.2 % ) from 2009 to 2013 . europe cruise guests sourced from europe represented approximately 30% ( 30 % ) of global cruise guests in 2013 . the compound annual growth rate in cruise guests sourced from this market was approximately 6.0% ( 6.0 % ) from 2009 to 2013 . other markets in addition to expected industry growth in north america and europe , we expect the asia/pacific region to demonstrate an even higher growth rate in the near term , although it will continue to represent a relatively small sector compared to north america and europe . based on industry data , cruise guests sourced from the asia/pacific region represented approximately 4.5% ( 4.5 % ) of global cruise guests in 2013 . the compound annual growth rate in cruise guests sourced from this market was approximately 15% ( 15 % ) from 2011 to 2013 . competition we compete with a number of cruise lines . our princi- pal competitors are carnival corporation &amp; plc , which owns , among others , aida cruises , carnival cruise lines , costa cruises , cunard line , holland america line , iberocruceros , p&amp;o cruises and princess cruises ; disney cruise line ; msc cruises ; norwegian cruise line and oceania cruises . cruise lines compete with other vacation alternatives such as land-based resort hotels and sightseeing destinations for consumers 2019 leisure time . demand for such activities is influenced by political and general economic conditions . com- panies within the vacation market are dependent on consumer discretionary spending . operating strategies our principal operating strategies are to : and employees and protect the environment in which our vessels and organization operate , to better serve our global guest base and grow our business , order to enhance our revenues , our brands globally , expenditures and ensure adequate cash and liquid- ity , with the overall goal of maximizing our return on invested capital and long-term shareholder value , ization and maintenance of existing ships and the transfer of key innovations across each brand , while prudently expanding our fleet with new state-of- the-art cruise ships , ships by deploying them into those markets and itineraries that provide opportunities to optimize returns , while continuing our focus on existing key markets , service customer preferences and expectations in an innovative manner , while supporting our strategic focus on profitability , and .
[/POST]

[[ ## table ## ]]
| Row | 2009 | 2010 | 2011 | 2012 | 2013 | 2009 | 2010 | 2011 | 2012 | 2013 | 2009 | 2010 | 2011 | 2012 | 2013 | 2009 | 2010 | 2011 | 2012 | 2013 | 2009 | 2010 | 2011 | 2012 | 2013 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| weighted-averagesupply ofberthsmarketedglobally ( 1 ) | 363000.0 | 391000.0 | 412000.0 | 425000.0 | 432000.0 | 363000.0 | 391000.0 | 412000.0 | 425000.0 | 432000.0 | 363000.0 | 391000.0 | 412000.0 | 425000.0 | 432000.0 | 363000.0 | 391000.0 | 412000.0 | 425000.0 | 432000.0 | 363000.0 | 391000.0 | 412000.0 | 425000.0 | 432000.0 |
| royal caribbean cruises ltd . total berths | 84050.0 | 92300.0 | 92650.0 | 98650.0 | 98750.0 | 84050.0 | 92300.0 | 92650.0 | 98650.0 | 98750.0 | 84050.0 | 92300.0 | 92650.0 | 98650.0 | 98750.0 | 84050.0 | 92300.0 | 92650.0 | 98650.0 | 98750.0 | 84050.0 | 92300.0 | 92650.0 | 98650.0 | 98750.0 |
| globalcruiseguests ( 1 ) | 17340000.0 | 18800000.0 | 20227000.0 | 20898000.0 | 21300000.0 | 17340000.0 | 18800000.0 | 20227000.0 | 20898000.0 | 21300000.0 | 17340000.0 | 18800000.0 | 20227000.0 | 20898000.0 | 21300000.0 | 17340000.0 | 18800000.0 | 20227000.0 | 20898000.0 | 21300000.0 | 17340000.0 | 18800000.0 | 20227000.0 | 20898000.0 | 21300000.0 |
| north americancruiseguests ( 2 ) | 10198000.0 | 10781000.0 | 11625000.0 | 11640000.0 | 11816000.0 | 10198000.0 | 10781000.0 | 11625000.0 | 11640000.0 | 11816000.0 | 10198000.0 | 10781000.0 | 11625000.0 | 11640000.0 | 11816000.0 | 10198000.0 | 10781000.0 | 11625000.0 | 11640000.0 | 11816000.0 | 10198000.0 | 10781000.0 | 11625000.0 | 11640000.0 | 11816000.0 |
| europeancruiseguests ( 3 ) | 5000000.0 | 5540000.0 | 5894000.0 | 6139000.0 | 6399000.0 | 5000000.0 | 5540000.0 | 5894000.0 | 6139000.0 | 6399000.0 | 5000000.0 | 5540000.0 | 5894000.0 | 6139000.0 | 6399000.0 | 5000000.0 | 5540000.0 | 5894000.0 | 6139000.0 | 6399000.0 | 5000000.0 | 5540000.0 | 5894000.0 | 6139000.0 | 6399000.0 |

[[ ## question ## ]]
what is the total global cruise guests are from north america or europe?


Assistant message:

[[ ## reasoning ## ]]
The question asks for the total number of global cruise guests that are from North America or Europe. I need to find the number of North American cruise guests and European cruise guests for a specific year and sum them up. The evidence snippets provide percentages for 2013 for North America (56%) and Europe (30%) of global cruise guests. The table also provides the absolute numbers for North American cruise guests and European cruise guests for 2013. I will sum the values for &#39;north americancruiseguests (2)&#39; and &#39;europeancruiseguests (3)&#39; for the year 2013.

North American cruise guests in 2013 = 11,816,000
European cruise guests in 2013 = 6,399,000
Total = 11,816,000 + 6,399,000 = 18,215,000.

[[ ## ops ## ]]
add(11816000.0, 6399000.0)

[[ ## answer ## ]]
18215000.0


User message:

[[ ## conversation_context ## ]]
Q1: what was the net change in value of net income from 2012 to 2013?
A1: 41.8

[[ ## evidence_snippets ## ]]
[PRE]
other expense , net : the company&#39;s other expense consists of the following: .
[/PRE]
[POST]
income tax provision : the company recorded income tax expense of $ 77.2 million and had income before income taxes of $ 322.5 million for the year ended december 31 , 2013 , representing an effective tax rate of 23.9% ( 23.9 % ) . during the year ended december 31 , 2012 , the company recorded income tax expense of $ 90.1 million and had income before income taxes of $ 293.5 million , representing an effective tax rate of 30.7% ( 30.7 % ) . in december 2013 , the company received notice from the irs that the joint committee on taxation took no exception to the company&#39;s tax returns that were filed for 2009 and 2010 . an $ 11.0 million tax benefit was recognized in the company&#39;s 2013 financial results as the company had effectively settled uncertainty regarding the realization of refund claims filed in connection with the 2009 and 2010 returns . in the u.s. , which is the largest jurisdiction where the company receives such a tax credit , the availability of the research and development credit expired at the end of the 2011 tax year . in january 2013 , the u.s . congress passed legislation that reinstated the research and development credit retroactive to 2012 . the income tax provision for the year ended december 31 , 2013 includes approximately $ 2.3 million related to the reinstated research and development credit for 2012 activity . the decrease in the effective tax rate from the prior year is primarily due to the release of an uncertain tax position mentioned above , the reinstatement of the u.s . research and development credit mentioned above , and cash repatriation activities . when compared to the federal and state combined statutory rate , the effective tax rates for the years ended december 31 , 2013 and 2012 were favorably impacted by lower statutory tax rates in many of the company 2019s foreign jurisdictions , the domestic manufacturing deduction and tax benefits associated with the merger of the company 2019s japan subsidiaries in 2010 . net income : the company 2019s net income for the year ended december 31 , 2013 was $ 245.3 million as compared to net income of $ 203.5 million for the year ended december 31 , 2012 . diluted earnings per share was $ 2.58 for the year ended december 31 , 2013 and $ 2.14 for the year ended december 31 , 2012 . the weighted average shares used in computing diluted earnings per share were 95.1 million and 95.0 million for the years ended december 31 , 2013 and 2012 , respectively . table of contents .
[/POST]

[[ ## table ## ]]
| Row | foreign currency losses net | other income ( expense ) net | total other expense net | foreign currency losses net | other income ( expense ) net | total other expense net |
|---|---|---|---|---|---|---|
| year ended december 31 , 2013 | -1115.0 | 69.0 | -1046.0 | -1115.0 | 69.0 | -1046.0 |
| year ended december 31 , 2012 | -1401.0 | -4.0 | -1405.0 | -1401.0 | -4.0 | -1405.0 |

[[ ## question ## ]]
what was net income in 2012?


Assistant message:

[[ ## reasoning ## ]]
The question asks for the net income in 2012. I will locate this information in the provided evidence snippets. The evidence states that &quot;the company 2019s net income for the year ended december 31 , 2013 was $ 245.3 million as compared to net income of $ 203.5 million for the year ended december 31 , 2012&quot;. Therefore, the net income in 2012 was $203.5 million.

[[ ## ops ## ]]
203.5

[[ ## answer ## ]]
203.5


User message:

[[ ## conversation_context ## ]]
Q1: in 2017, what was the number of granted performance shares?
A1: 203298.0
Q2: and what was the total number of granted shares?
A2: 650942.0
Q3: what percentage, then, of this total did that performance shares number represent?
A3: 0.31231
Q4: and from 2016 to that year, what was the total of compensation expense attributable to directors?
A4: 4.9

[[ ## evidence_snippets ## ]]
[PRE]
in 2017 , the company granted 440076 shares of restricted class a common stock and 7568 shares of restricted stock units . restricted common stock and restricted stock units generally have a vesting period of two to four years . the fair value related to these grants was $ 58.7 million , which is recognized as compensation expense on an accelerated basis over the vesting period . dividends are accrued on restricted class a common stock and restricted stock units and are paid once the restricted stock vests . in 2017 , the company also granted 203298 performance shares . the fair value related to these grants was $ 25.3 million , which is recognized as compensation expense on an accelerated and straight-lined basis over the vesting period . the vesting of these shares is contingent on meeting stated performance or market conditions . the following table summarizes restricted stock , restricted stock units , and performance shares activity for 2017 : number of shares weighted average grant date fair value .
[/PRE]
[POST]
the total fair value of restricted stock , restricted stock units , and performance shares that vested during 2017 , 2016 and 2015 was $ 66.0 million , $ 59.8 million and $ 43.3 million , respectively . under the espp , eligible employees may acquire shares of class a common stock using after-tax payroll deductions made during consecutive offering periods of approximately six months in duration . shares are purchased at the end of each offering period at a price of 90% ( 90 % ) of the closing price of the class a common stock as reported on the nasdaq global select market . compensation expense is recognized on the dates of purchase for the discount from the closing price . in 2017 , 2016 and 2015 , a total of 19936 , 19858 and 19756 shares , respectively , of class a common stock were issued to participating employees . these shares are subject to a six-month holding period . annual expense of $ 0.3 million for the purchase discount was recognized in 2017 , and $ 0.2 million was recognized in both 2016 and 2015 . non-executive directors receive an annual award of class a common stock with a value equal to $ 100000 . non-executive directors may also elect to receive some or all of the cash portion of their annual stipend , up to $ 60000 , in shares of stock based on the closing price at the date of distribution . as a result , 19736 shares , 26439 shares and 25853 shares of class a common stock were issued to non-executive directors during 2017 , 2016 and 2015 , respectively . these shares are not subject to any vesting restrictions . expense of $ 2.5 million , $ 2.4 million and $ 2.5 million related to these stock-based payments was recognized for the years ended december 31 , 2017 , 2016 and 2015 , respectively. .
[/POST]

[[ ## table ## ]]
| Row | outstanding at december 31 2016 | granted | vested | cancelled | outstanding at december 31 2017 | outstanding at december 31 2016 | granted | vested | cancelled | outstanding at december 31 2017 |
|---|---|---|---|---|---|---|---|---|---|---|
| number of shares | 1820578.0 | 650942.0 | -510590.0 | -401699.0 | 1559231.0 | 1820578.0 | 650942.0 | -510590.0 | -401699.0 | 1559231.0 |
| weightedaveragegrant datefair value | 98.0 | 129.0 | 87.0 | 95.0 | 116.0 | 98.0 | 129.0 | 87.0 | 95.0 | 116.0 |

[[ ## question ## ]]
including 2015, what becomes that total of compensation expense?

Respond with the corresponding output fields, starting with the field `[[ ## reasoning ## ]]`, then `[[ ## ops ## ]]`, then `[[ ## answer ## ]]`, and then ending with the marker for `[[ ## completed ## ]]`.


Response:

[[ ## reasoning ## ]]
The question asks for the total compensation expense, including the year 2015. I need to sum up all explicitly stated compensation expenses for the years 2015, 2016, and 2017 from the evidence snippets.

From the snippets:
**For 2017:**
1.  Compensation expense for restricted class A common stock and restricted stock units: $58.7 million.
2.  Compensation expense for performance shares: $25.3 million.
3.  Annual expense for ESPP purchase discount: $0.3 million.
4.  Expense related to non-executive directors&#39; stock-based payments: $2.5 million.
Total for 2017 = 58.7 + 25.3 + 0.3 + 2.5 = 86.8 million.

**For 2016:**
1.  Annual expense for ESPP purchase discount: $0.2 million.
2.  Expense related to non-executive directors&#39; stock-based payments: $2.4 million.
Total for 2016 = 0.2 + 2.4 = 2.6 million.

**For 2015:**
1.  Annual expense for ESPP purchase discount: $0.2 million.
2.  Expense related to non-executive directors&#39; stock-based payments: $2.5 million.
Total for 2015 = 0.2 + 2.5 = 2.7 million.

Finally, sum the total compensation expenses for 2015, 2016, and 2017.
Total compensation expense = Total 2017 + Total 2016 + Total 2015
Total compensation expense = 86.8 + 2.6 + 2.7 = 92.1 million.

[[ ## ops ## ]]
add(58.7, 25.3, 0.3, 2.5, 0.2, 2.4, 0.2, 2.5)

[[ ## answer ## ]]
92.1




</code></pre>
</div>
</div>
<p>We see that a few more examples have been added from the <code>medium</code> stage, which has helped significantly improve the model‚Äôs performance.</p>
<p>Let‚Äôs also save the programs to disk.</p>
<div id="cell-67" class="cell" data-execution_count="147">
<div class="sourceCode" id="cb52"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">id</span>, oc <span class="kw">in</span> <span class="bu">enumerate</span>(mipro_micro_medium_compiled_programs):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    model_name <span class="op">=</span> selected_llms[<span class="bu">id</span>].model</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    sanitized_model_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[-/\.]&quot;</span>, <span class="st">&quot;_&quot;</span>, model_name)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    oc.save(<span class="ss">f&quot;./programs/</span><span class="sc">{</span>sanitized_model_name<span class="sc">}</span><span class="ss">_mipro_micro_medium/&quot;</span>, save_program<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<p>Next, we will <em>optimise</em> for the <strong>hard problem</strong></p>
</section>
<section id="curriculum-learning-hard" class="level4">
<h4>Curriculum Learning: Hard</h4>
<p>First, let‚Äôs benchmark the <code>optimised programns</code> from the medium stage on the <code>hard</code> validation set</p>
<div id="cell-71" class="cell" data-execution_count="149">
<div class="sourceCode" id="cb53"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>baseline_hard_results <span class="op">=</span> []</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;baseline_micro_hard&quot;</span>) <span class="im">as</span> parent_ctx:</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, candidate_lm <span class="kw">in</span> <span class="bu">enumerate</span>(mipro_llms):</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;baseline_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>            current_evaluator <span class="op">=</span> Evaluate(</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>                devset<span class="op">=</span>micro_hard_valid_examples,</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>                num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>                display_progress<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>                return_all_scores<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>                return_outputs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>                current_result <span class="op">=</span> current_evaluator(</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>                    mipro_micro_medium_compiled_programs[idx], metric<span class="op">=</span>turn_em_metric</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>                baseline_hard_results.append(current_result)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 208.00 / 266 (78.2%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 266/266 [00:03&lt;00:00, 73.06it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/3/runs/0572758d7b8544d99f6dd52028e67409
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run baseline_openai_o4-mini-2025-04-16 at: http://localhost:5000/#/experiments/3/runs/2d9c84100b6b4c3688cf42d5eba881f2
üß™ View experiment at: http://localhost:5000/#/experiments/3
Average Metric: 226.00 / 266 (85.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 266/266 [00:34&lt;00:00,  7.81it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/3/runs/fc410ce0954c4281975199a4fa6d7c04
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run baseline_gemini_gemini-2_5-flash at: http://localhost:5000/#/experiments/3/runs/4e9533e7df14490181999627414fc61e
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run baseline_micro_hard at: http://localhost:5000/#/experiments/3/runs/bf12642f5c1b4cc8828b89f2599a2b0e
üß™ View experiment at: http://localhost:5000/#/experiments/3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/29 13:06:41 INFO dspy.evaluate.evaluate: Average Metric: 208.0 / 266 (78.2%)
2025/07/29 13:07:15 INFO dspy.evaluate.evaluate: Average Metric: 226.0 / 266 (85.0%)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<p>The baseline results are as follows:</p>
<table>
<thead>
<tr class="header">
<th>model_name</th>
<th>micro_hard_valid_set em_metric</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>78.2%</td>
</tr>
<tr class="even">
<td>gemini-2.5-flash</td>
<td>85.0%</td>
</tr>
</tbody>
</table>
<div id="cell-73" class="cell" data-execution_count="150">
<div class="sourceCode" id="cb56"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Waiting... </span><span class="sc">{</span>i <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/10 minutes elapsed&quot;</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">60</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;10 minutes have passed.&quot;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Waiting... 1/10 minutes elapsed
Waiting... 2/10 minutes elapsed
Waiting... 3/10 minutes elapsed
Waiting... 4/10 minutes elapsed
Waiting... 5/10 minutes elapsed
Waiting... 6/10 minutes elapsed
Waiting... 7/10 minutes elapsed
Waiting... 8/10 minutes elapsed
Waiting... 9/10 minutes elapsed
Waiting... 10/10 minutes elapsed
10 minutes have passed.</code></pre>
</div>
</div>
<div id="cell-74" class="cell" data-execution_count="151">
<div class="sourceCode" id="cb58"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    max_bootstrapped_demos<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    max_labeled_demos<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    auto<span class="op">=</span><span class="st">&quot;medium&quot;</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    log_dir<span class="op">=</span><span class="st">&quot;./mipro_micro_logs&quot;</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>mipro_micro_hard_compiled_programs <span class="op">=</span> []</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;mipro_micro_hard&quot;</span>):</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, candidate_lm <span class="kw">in</span> <span class="bu">enumerate</span>(mipro_llms):</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;mipro_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>                teleprompter <span class="op">=</span> MIPROv2(metric<span class="op">=</span>turn_em_metric, <span class="op">**</span>config)</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>                optimized_program <span class="op">=</span> teleprompter.<span class="bu">compile</span>(</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>                    mipro_micro_medium_compiled_programs[idx],</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>                    trainset<span class="op">=</span>micro_hard_train_examples,</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>                    valset<span class="op">=</span>micro_hard_valid_examples,</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>                    requires_permission_to_run<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>                mipro_micro_hard_compiled_programs.append(optimized_program)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/29 13:18:39 INFO dspy.teleprompt.mipro_optimizer_v2: 
RUNNING WITH THE FOLLOWING MEDIUM AUTO RUN SETTINGS:
num_trials: 18
minibatch: True
num_fewshot_candidates: 12
num_instruct_candidates: 6
valset size: 266

2025/07/29 13:18:46 INFO dspy.teleprompt.mipro_optimizer_v2: 
==&gt; STEP 1: BOOTSTRAP FEWSHOT EXAMPLES &lt;==
2025/07/29 13:18:46 INFO dspy.teleprompt.mipro_optimizer_v2: These will be used as few-shot example candidates for our program and for creating instructions.

2025/07/29 13:18:46 INFO dspy.teleprompt.mipro_optimizer_v2: Bootstrapping N=12 sets of demonstrations...
  0%|          | 4/974 [00:36&lt;2:28:30,  9.19s/it]
  0%|          | 1/974 [00:04&lt;1:10:37,  4.36s/it]
  0%|          | 1/974 [00:04&lt;1:20:09,  4.94s/it]
  0%|          | 3/974 [00:23&lt;2:08:07,  7.92s/it]
  1%|          | 6/974 [00:59&lt;2:40:46,  9.97s/it]
  1%|          | 5/974 [00:58&lt;3:09:39, 11.74s/it]
  0%|          | 2/974 [06:00&lt;48:36:05, 180.01s/it]
  0%|          | 1/974 [00:06&lt;1:48:53,  6.71s/it]
  0%|          | 3/974 [00:25&lt;2:18:44,  8.57s/it]
  0%|          | 1/974 [00:13&lt;3:36:34, 13.36s/it]
2025/07/29 13:34:48 INFO dspy.teleprompt.mipro_optimizer_v2: 
...
Average Metric: 145.00 / 171 (84.8%):  64%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç   | 170/266 [00:09&lt;00:09,  9.84it/s]Average Metric: 145.00 / 172 (84.3%):  64%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç   | 171/266 [00:10&lt;00:09,  9.84it/s]Average Metric: 145.00 / 173 (83.8%):  65%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå   | 173/266 [00:11&lt;00:23,  3.99it/s]Average Metric: 145.00 / 174 (83.3%):  65%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå   | 173/266 [00:11&lt;00:23,  3.99it/s]Average Metric: 145.00 / 175 (82.9%):  66%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå   | 175/266 [00:12&lt;00:29,  3.10it/s]Average Metric: 145.00 / 175 (82.9%):  66%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå   | 175/266 [00:14&lt;00:29,  3.10it/s]Average Metric: 145.00 / 175 (82.9%):  67%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã   | 177/266 [00:15&lt;00:49,  1.81it/s]Average Metric: 145.00 / 175 (82.9%):  67%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã   | 177/266 [00:15&lt;00:49,  1.81it/s]Average Metric: 145.00 / 175 (82.9%):  67%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã   | 179/266 [00:15&lt;00:40,  2.13it/s]Average Metric: 145.00 / 175 (82.9%):  68%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä   | 180/266 [00:16&lt;00:37,  2.32it/s]Average Metric: 145.00 / 175 (82.9%):  68%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä   | 180/266 [00:16&lt;00:37,  2.32it/s]Average Metric: 145.00 / 175 (82.9%):  68%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä   | 181/266 [00:16&lt;00:36,  2.32it/s]Average Metric: 145.00 / 175 (82.9%):  69%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ   | 183/266 [00:16&lt;00:29,  2.78it/s]Average Metric: 145.00 / 175 (82.9%):  69%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ   | 183/266 [00:16&lt;00:29,  2.78it/s]Average Metric: 145.00 / 175 (82.9%):  76%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã  | 203/266 [00:17&lt;00:05, 11.68it/s]
üèÉ View run eval_full_4 at: http://localhost:5000/#/experiments/3/runs/d42af3a2f5674ecb8579b46c8adcdb87
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run mipro_gemini_gemini-2_5-flash at: http://localhost:5000/#/experiments/3/runs/add9bb06b00943c593c8e562fcde594f
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run mipro_micro_hard at: http://localhost:5000/#/experiments/3/runs/d368c83b497347c984aafef7921c3b65
üß™ View experiment at: http://localhost:5000/#/experiments/3</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"feb9c3e0853740d68ead60fd1ba5bd68","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ab9f027e037e4745bcfea31e18b05e25","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dbb072893c6349aa9d5de32c3b5204d4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"548f27f5851846aaaedf354385c02d7a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e1ea38b7dd1d4a228f2801cf40905b17","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3674c2c369184984a1acc40b94c7c99c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6120118829874b9ab0975859c66d1bbf","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3abf29eaa3cb4fb8b3ca114193641f17","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"381edd4ed1e0430fbf87a3ba629e82eb","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ff5b6050b6bb4d22829153e76d96d87a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1ff7dd6fd32f4605ba39cc85982a057b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"593ea65b830b4cfa8580403444f2003b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c00764acc6d34de0acebd0e91d0c982a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5e7e142bd0bd440c937409486b9dd502","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dc802b2aa60841a98fb6d9d275de1228","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4f6452506bd14a5ea16335f9dc53bd79","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0a75d5eeb6cd488390f7fcd496ac6240","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"757a348bfe6445a48045877e4f964e05","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"abb2922e2c0d44a4ba73a9ea09ed8060","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"365ef3418ec94ffebcee44e61d6c9a61","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0d379ea167c9405dbe0edca58cd00b09","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9a37cdb83963409f992fb311d4a20b1c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"84fe2a8aa0104270a8ad4c3298acad9e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"88d532703124499d99fa7ca09caebaf3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d8466ea59dd04f7c910bebd6d575d718","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8008aff22cbd4c7ab8818dae2df7e937","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0e9f10ad1bcc443e8030a410646a076c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a076e4fa515a4f56a27812d26b9ab51c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7938e33caafc451baa7ca640e8de7acd","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"80e063b068c24356b64253f671bbf091","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a19edb85e7f2451389a82246c9262a72","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"62af21c9a4c04c97b233969c21d43c53","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"822b1ce1e54148a9b432f4908bf0615e","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d4ffbd86aa044662b62239ee1f2ef1c0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5367eaaf1b1f4bc9bc890402a6aa1a55","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"318c00ab1cb14350bfed86d133eedf63","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a3a59bc405304ad08c4b217d89c077dc","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"116ab35778fa4865b6861b515f10c102","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"52eede42351946df9ec8b48bc658c60d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a67e06549e3a41e4921c55e03951b942","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3a27c2353b5e4030834c6767b3fa82b6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a4a446552c8e4760abb32d59565713d5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<p>We faced some rate-limits errors on gemini-2.5-flash, which caused a few full validation evals to fail. We‚Äôll use the evals we have so far for the model, and continue.</p>
<p>We have the following results:</p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 31%" />
<col style="width: 26%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th>model_name</th>
<th>em_metric before optimisation</th>
<th>em_metric after MIPROv2</th>
<th>% change</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>78.20</td>
<td>86.47</td>
<td>+10.6%</td>
</tr>
<tr class="even">
<td>gemini-2.5-flash</td>
<td>85.00</td>
<td>84.96</td>
<td>-0.05%</td>
</tr>
</tbody>
</table>
<p>Aha! MIPROv2 has succesfully helped improve the performance of o4-mini on the hard validation dataset, bringing the total validation accuracy to <strong>86.47%</strong></p>
<p>We see a slight degregation in the performance for gemini-2.5-flash. Note that because of the rate-limit errors, this metric is not a <em>true</em> estimation of the model ability.</p>
<p>Through this analysis, we can conclude that MIPROv2 is a useful tool for improving the performance of models on hard validation datasets, but it may not be as effective for models that are already performing well.</p>
<p><strong>We‚Äôve finally identified our winner: o4-mini!</strong></p>
<p>Let‚Äôs save the programs to disk!</p>
<div id="cell-77" class="cell" data-execution_count="156">
<div class="sourceCode" id="cb61"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">id</span>, oc <span class="kw">in</span> <span class="bu">enumerate</span>(mipro_micro_hard_compiled_programs):</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    model_name <span class="op">=</span> selected_llms[<span class="bu">id</span>].model</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    sanitized_model_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[-/\.]&quot;</span>, <span class="st">&quot;_&quot;</span>, model_name)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    oc.save(</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f&quot;./programs/</span><span class="sc">{</span>sanitized_model_name<span class="sc">}</span><span class="ss">_mipro_micro_hard/&quot;</span>,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>        save_program<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
</div>
</section>
</section>
<section id="final-evaluation" class="level3">
<h3>Final Evaluation</h3>
<p>We now want to evaluate our winning models on the final test dataset. In our case, the test dataset will be collection of easy + medium + hard test sets.</p>
<p>Before evaluating our <em>optimised</em> model, let‚Äôs benchmark the zero-shot performance of o4-mini on the test dataset</p>
<div id="cell-80" class="cell" data-execution_count="14">
<div class="sourceCode" id="cb62"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>final_test_examples <span class="op">=</span> easy_test_examples <span class="op">+</span> medium_test_examples <span class="op">+</span> hard_test_examples</span></code></pre></div>
</div>
<div id="cell-81" class="cell" data-execution_count="16">
<div class="sourceCode" id="cb63"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>final_baseline_results <span class="op">=</span> []</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;final_evaluation_baseline_gpt_5_nano&quot;</span>) <span class="im">as</span> parent_ctx:</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    run_name <span class="op">=</span> <span class="ss">f&quot;baseline_</span><span class="sc">{</span>lm_oai_gpt_5_nano<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>        current_evaluator <span class="op">=</span> Evaluate(</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>            devset<span class="op">=</span>final_test_examples,</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>            num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>            display_progress<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>            return_all_scores<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>            return_outputs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> dspy.context(lm<span class="op">=</span>lm_oai_gpt_5_nano) <span class="im">as</span> ctx:</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>            current_result <span class="op">=</span> current_evaluator(</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>                TurnSolver(reasoning_lm<span class="op">=</span><span class="va">True</span>), metric<span class="op">=</span>turn_em_metric</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>            final_baseline_results.append(current_result)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0%|          | 0/678 [00:00&lt;?, ?it/s]Average Metric: 0.00 / 0 (0%):   0%|          | 1/678 [00:09&lt;1:44:15,  9.24s/it]Average Metric: 0.00 / 0 (0%):   0%|          | 2/678 [00:09&lt;45:38,  4.05s/it]  Average Metric: 0.00 / 0 (0%):   0%|          | 2/678 [00:09&lt;45:38,  4.05s/it]Average Metric: 0.00 / 0 (0%):   0%|          | 3/678 [00:09&lt;45:34,  4.05s/it]Average Metric: 0.00 / 0 (0%):   1%|          | 8/678 [00:09&lt;07:38,  1.46it/s]Average Metric: 0.00 / 0 (0%):   1%|‚ñè         | 10/678 [00:09&lt;07:37,  1.46it/s]Average Metric: 0.00 / 0 (0%):   2%|‚ñè         | 12/678 [00:09&lt;07:35,  1.46it/s]Average Metric: 0.00 / 0 (0%):   2%|‚ñè         | 15/678 [00:09&lt;07:33,  1.46it/s]Average Metric: 0.00 / 0 (0%):   5%|‚ñå         | 35/678 [00:09&lt;07:20,  1.46it/s]Average Metric: 0.00 / 0 (0%):  16%|‚ñà‚ñå        | 108/678 [00:09&lt;06:30,  1.46it/s]Average Metric: 0.00 / 0 (0%):  17%|‚ñà‚ñã        | 118/678 [00:09&lt;00:17, 31.31it/s]Average Metric: 0.00 / 0 (0%):  22%|‚ñà‚ñà‚ñè       | 146/678 [00:09&lt;00:16, 31.31it/s]Average Metric: 0.00 / 0 (0%):  24%|‚ñà‚ñà‚ñç       | 165/678 [00:09&lt;00:16, 31.31it/s]Average Metric: 0.00 / 0 (0%):  26%|‚ñà‚ñà‚ñå       | 175/678 [00:09&lt;00:16, 31.31it/s]Average Metric: 0.00 / 0 (0%):  27%|‚ñà‚ñà‚ñã       | 182/678 [00:09&lt;00:15, 31.31it/s]Average Metric: 0.00 / 0 (0%):  27%|‚ñà‚ñà‚ñã       | 185/678 [00:09&lt;00:15, 31.31it/s]Average Metric: 0.00 / 0 (0%):  30%|‚ñà‚ñà‚ñâ       | 202/678 [00:09&lt;00:15, 31.31it/s]Average Metric: 0.00 / 0 (0%):  32%|‚ñà‚ñà‚ñà‚ñè      | 219/678 [00:09&lt;00:14, 31.31it/s]Average Metric: 0.00 / 0 (0%):  34%|‚ñà‚ñà‚ñà‚ñç      | 233/678 [00:09&lt;00:14, 31.31it/s]Average Metric: 0.00 / 0 (0%):  35%|‚ñà‚ñà‚ñà‚ñå      | 240/678 [00:09&lt;00:13, 31.31it/s]Average Metric: 0.00 / 0 (0%):  37%|‚ñà‚ñà‚ñà‚ñã      | 250/678 [00:09&lt;00:05, 80.45it/s]Average Metric: 0.00 / 0 (0%):  39%|‚ñà‚ñà‚ñà‚ñä      | 262/678 [00:09&lt;00:05, 80.45it/s]Average Metric: 0.00 / 0 (0%):  40%|‚ñà‚ñà‚ñà‚ñâ      | 269/678 [00:09&lt;00:05, 80.45it/s]Average Metric: 0.00 / 0 (0%):  41%|‚ñà‚ñà‚ñà‚ñà‚ñè     | 280/678 [00:09&lt;00:04, 80.45it/s]Average Metric: 0.00 / 0 (0%):  42%|‚ñà‚ñà‚ñà‚ñà‚ñè     | 286/678 [00:09&lt;00:04, 80.45it/s]Average Metric: 0.00 / 0 (0%):  44%|‚ñà‚ñà‚ñà‚ñà‚ñç     | 300/678 [00:09&lt;00:04, 80.45it/s]Average Metric: 0.00 / 0 (0%):  46%|‚ñà‚ñà‚ñà‚ñà‚ñå     | 309/678 [00:09&lt;00:04, 80.45it/s]Average Metric: 0.00 / 0 (0%):  48%|‚ñà‚ñà‚ñà‚ñà‚ñä     | 327/678 [00:10&lt;00:04, 80.45it/s]Average Metric: 0.00 / 0 (0%):  56%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå    | 378/678 [00:10&lt;00:03, 80.45it/s]Average Metric: 0.00 / 0 (0%):  65%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç   | 439/678 [00:10&lt;00:02, 80.45it/s]Average Metric: 0.00 / 0 (0%):  70%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   | 477/678 [00:10&lt;00:02, 80.45it/s]Average Metric: 0.00 / 0 (0%):  95%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå| 647/678 [00:10&lt;00:00, 63.91it/s] 
üèÉ View run eval at: http://localhost:5000/#/experiments/3/runs/6c75579e534b4751a98f4adad09d0fd9
üß™ View experiment at: http://localhost:5000/#/experiments/3
...
2025/07/29 14:41:40 INFO dspy.evaluate.evaluate: Average Metric: 493.0 / 678 (72.7%)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<p>We get the following performance:</p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 31%" />
<col style="width: 26%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th>model_name</th>
<th>em_metric before optimisation</th>
<th>em_metric after MIPROv2</th>
<th>% increase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>72.70</td>
<td>??</td>
<td>??</td>
</tr>
</tbody>
</table>
<p>Now, let‚Äôs try our <em>optimised</em> program!</p>
<div id="cell-85" class="cell" data-execution_count="160">
<div class="sourceCode" id="cb73"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>final_program <span class="op">=</span> dspy.load(<span class="st">&quot;./programs/openai_o4_mini_2025_04_16_mipro_micro_hard/&quot;</span>)</span></code></pre></div>
</div>
<div id="cell-86" class="cell" data-execution_count="189">
<div class="sourceCode" id="cb74"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>final_program.save(<span class="st">&quot;./programs/final_program.json&quot;</span>, save_program<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
</div>
<div id="cell-87" class="cell" data-execution_count="194">
<div class="sourceCode" id="cb75"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reference code showing how to load the DSPy program</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>loaded_dspy_program <span class="op">=</span> dspy.ChainOfThought(SolveTurnWithReasoning)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>loaded_dspy_program.load(<span class="st">&quot;./programs/final_program.json&quot;</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>loaded_dspy_program.predict.signature.instructions</span></code></pre></div>
</div>
<div id="cell-88" class="cell">
<div class="sourceCode" id="cb76"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">42</span>)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>bootstrap_rs_random_easy_subset <span class="op">=</span> random.sample(easy_train_examples, <span class="dv">70</span>)</span></code></pre></div>
</div>
<div id="cell-89" class="cell">
<div class="sourceCode" id="cb77"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> litellm</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.teleprompt <span class="im">import</span> BootstrapFewShotWithRandomSearch</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Config needed to prevent the optimizer from using _unsupported_ temperature</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="co"># for reasoning models.</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>litellm.drop_params <span class="op">=</span> <span class="va">True</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    max_bootstrapped_demos<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    max_labeled_demos<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    num_candidate_programs<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    max_rounds<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>bootstrap_rs_easy_compiled_programs <span class="op">=</span> []</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;bootstrap_few_shot_rs_easy&quot;</span>):</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> candidate_lm <span class="kw">in</span> selected_llms:</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;bootstrap_few_shot_rs_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>                teleprompter <span class="op">=</span> BootstrapFewShotWithRandomSearch(</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>                    metric<span class="op">=</span>turn_em_metric, <span class="op">**</span>config</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>                optimized_program <span class="op">=</span> teleprompter.<span class="bu">compile</span>(</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>                    dspy.ChainOfThought(SolveTurnWithReasoning),</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>                    trainset<span class="op">=</span>bootstrap_rs_random_easy_subset,</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>                bootstrap_rs_easy_compiled_programs.append(optimized_program)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Going to sample between 1 and 3 traces per predictor.
Will attempt to bootstrap 5 candidate sets.
Average Metric: 45.00 / 70 (64.3%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:00&lt;00:00, 87.74it/s] 
üèÉ View run eval_0 at: http://localhost:5000/#/experiments/3/runs/fcce9b07d50e41609bc04c3d9c2235c7
...
Scores so far: [74.29, 74.29, 74.29, 72.86, 74.29, 75.71, 75.71, 80.0]
Best score so far: 80.0
8 candidate programs found.
üèÉ View run bootstrap_few_shot_rs_openai_o3-2025-04-16 at: http://localhost:5000/#/experiments/3/runs/8576b067ea60468ebc37cda1a17be1dc
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run bootstrap_few_shot_rs_easy at: http://localhost:5000/#/experiments/3/runs/b5f08a070a634f74888fb8c42f24bfa3
üß™ View experiment at: http://localhost:5000/#/experiments/3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/29 01:03:08 INFO dspy.evaluate.evaluate: Average Metric: 45.0 / 70 (64.3%)
...
2025/07/29 01:09:48 INFO dspy.evaluate.evaluate: Average Metric: 56.0 / 70 (80.0%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9aa596c147174804958bfd90f9e69998","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2fac575b2f714ab3a5f079b5b8c068e7","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9352e516d8b848579ba0d22b01c35fb2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dd46b6737ed8418484d64e9cef39a594","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"19d7fe20fa6b4fb7bb39768109a6e96f","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d9ac51afacd244629a94d3d29cc78260","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"71a5a9849439471b90be1451f4ed6d8c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"795ab895387b4c0e9eac571ee453ac88","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"650c0bd2cb2a4041bdf156931c25130c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f16c05df32404d64b8a8431d48d39234","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0479a155634a4c4ba4d92bebca0b0727","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ea69ff24378d45a3998851b5aa0962d4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8b8c7a6497d04213a381c037724d4895","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bc397a6b03924336bbc43a1bd839784c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d43544d6f72f40dbaae08ad6b18cb0bd","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4e7c85dbd6f64f61a359ea5a37c40ed0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6913487151e04ab7a89037c30da2cfd7","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cf6a3e6ba2a646a093455efcf2d34a65","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"102094c059e84577861cd1271f22e414","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d5351ffa3e234f7f92c3f1932b3dd438","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d3e11c2f024d4ec090827c250d4258ca","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3cff124f59634e5b9279882b0501180a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"043eb11fea0a462684dac9bbb48f4f03","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e694033bfb9e4689bd6c07fc39d0801c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"db37866855a049b88bb7e4c9dd3597c6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"93fd5af0c6644afc978088bc68e1ee83","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5aa8485009e94f079807723d8dbc5ab2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e5cce25e5c7941d6bf6a39bcd3c76bf8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f90ceb161810483ab7c0fb2a38dd46e4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4d26bd076e4845b193dfa48d40f9e51b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2bceaac3cdcd48a0b05bc0f5e0c884a5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ab959aa00cf145d0984217e3c543fcd0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7a19b204ef7443e3964026a61386dbf3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0944c174ba5d4b7f888c2c78316eeb67","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f58455aed23543369dda147cdcc46ee6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6f9faa0b381e48b4a3239439f9b5c8a0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"14d1357491a342a6b3cbb1a778076b69","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3146876614a146569534ee1e0cef7f86","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"36e21760751a482c874fbc57b485e178","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<p>Moment of truth üò¨</p>
<div id="cell-91" class="cell" data-execution_count="162">
<div class="sourceCode" id="cb80"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>final_optimised_results <span class="op">=</span> []</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;final_evaluation_baseline&quot;</span>) <span class="im">as</span> parent_ctx:</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    run_name <span class="op">=</span> <span class="ss">f&quot;optimised_</span><span class="sc">{</span>lm_oai_o4_mini<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>        current_evaluator <span class="op">=</span> Evaluate(</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>            devset<span class="op">=</span>final_test_examples,</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>            num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>            display_progress<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>            return_all_scores<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>            return_outputs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> dspy.context(lm<span class="op">=</span>lm_oai_o4_mini) <span class="im">as</span> ctx:</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>            current_result <span class="op">=</span> current_evaluator(final_program, metric<span class="op">=</span>turn_em_metric)</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>            final_optimised_results.append(current_result)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 573.00 / 667 (85.9%):  98%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä| 667/678 [03:10&lt;00:04,  2.33it/s]Average Metric: 580.00 / 678 (85.5%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 678/678 [03:23&lt;00:00,  3.34it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/3/runs/ec07411faf3944d991dba6d8d15ffac7
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run optimised_openai_o4-mini-2025-04-16 at: http://localhost:5000/#/experiments/3/runs/1dddc8a3aed24d5184dde24e67445b1d
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run final_evaluation_baseline at: http://localhost:5000/#/experiments/3/runs/5ab44887bf414849a652aabc1a040da0
üß™ View experiment at: http://localhost:5000/#/experiments/3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/29 14:52:30 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 14:52:42 INFO dspy.evaluate.evaluate: Average Metric: 580.0 / 678 (85.5%)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<p>Our final results are as follows</p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 31%" />
<col style="width: 26%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th>model_name</th>
<th>em_metric before optimisation</th>
<th>em_metric after MIPROv2</th>
<th>% increase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>72.70</td>
<td>85.50</td>
<td>17.6</td>
</tr>
</tbody>
</table>
<p>Great success! We‚Äôve successfully improved the performance of o4-mini on our dataset using Curriculum Learning by 17.6%, to acheive a final score of 85.50%!</p>
</section>
<section id="error-analysis" class="level3">
<h3>Error Analysis</h3>
<p>As we‚Äôve done previously in the <code>modelling</code> notebook, we will now try to classify the errors in the predictions, using the same taxonomy as before.</p>
<p>The taxonomy is as follows:</p>
<ul>
<li>OK</li>
<li>NUMERICAL_ANSWER_WRONG</li>
<li>TEXTUAL_SELECTION_ANSWER_WRONG</li>
<li>FORMAT_ERROR</li>
<li>EVIDENCE_MISMATCH</li>
<li>GROUND_TRUTH_INCORRECT</li>
</ul>
<div id="cell-95" class="cell" data-execution_count="172">
<div class="sourceCode" id="cb83"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> copy <span class="im">import</span> deepcopy</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>final_selected_error_records <span class="op">=</span> []</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _idx, record <span class="kw">in</span> <span class="bu">enumerate</span>(final_optimised_results):</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> example, prediction, score <span class="kw">in</span> record[<span class="dv">1</span>]:</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>        example_copy <span class="op">=</span> deepcopy(example)</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        example_copy[<span class="st">&quot;ground_truth_answer&quot;</span>] <span class="op">=</span> example_copy[<span class="st">&quot;answer&quot;</span>]</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> example_copy[<span class="st">&quot;answer&quot;</span>]</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>        final_selected_error_records.append(</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;model_name&quot;</span>: lm_oai_o4_mini.model,</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;turn_em_metric_score&quot;</span>: score,</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>                <span class="op">**</span>example_copy.toDict(),</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">**</span>prediction.toDict(),</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
</div>
<div id="cell-96" class="cell" data-execution_count="173">
<div class="sourceCode" id="cb84"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Literal</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AssessmentSignature(dspy.Signature):</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Categorize model predictions by comparing them to ground truth, context, and evidence.</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Assign a specific error type or OK label, with concise justification, based on rubric.</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="co">    When comparing numerical answers, always allow a tolerance of 1e-2. For eg: If the question asks for a percentage, but the ground_truth_answer is given as a decimal, the assessment_answer label will be GROUND_TRUTH_INCORRECT</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>    ground_truth_answer: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;The correct answer as per the ground truth data.&quot;</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    table: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Tabular data (as string) relevant to the question and answer.&quot;</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>    conversation_context: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Previous dialogue turns or context for the current question.&quot;</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    evidence_snippets: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Text snippets from the source document supporting the answer.&quot;</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>    question: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">&quot;The question being answered by the model.&quot;</span>)</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>    predicted_reasoning: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Model&#39;s step-by-step explanation or justification for its answer.&quot;</span></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>    predicted_ops: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Operations or programmatic steps the model used to derive its answer.&quot;</span></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>    predicted_answer: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;The answer predicted by the model for the given question.&quot;</span></span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a>    assessment_answer: Literal[</span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;NUMERICAL_ANSWER_WRONG&quot;</span>,</span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;TEXTUAL_SELECTION_ANSWER_WRONG&quot;</span>,</span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;FORMAT_ERROR&quot;</span>,</span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;EVIDENCE_MISMATCH&quot;</span>,</span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;GROUND_TRUTH_INCORRECT&quot;</span>,</span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true" tabindex="-1"></a>    ] <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">&quot;Single categorical label.&quot;</span>)</span></code></pre></div>
</div>
<div id="cell-97" class="cell" data-execution_count="174">
<div class="sourceCode" id="cb85"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>judge_examples <span class="op">=</span> []</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> record <span class="kw">in</span> final_selected_error_records:</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> record[<span class="st">&quot;turn_em_metric_score&quot;</span>] <span class="op">!=</span> <span class="dv">1</span>:</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>        judge_examples.append(</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>            dspy.Example(</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>                <span class="bu">id</span><span class="op">=</span>record[<span class="st">&quot;id&quot;</span>],</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>                model_name<span class="op">=</span>record[<span class="st">&quot;model_name&quot;</span>],</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>                predicted_reasoning<span class="op">=</span>record[<span class="st">&quot;reasoning&quot;</span>],</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>                predicted_ops<span class="op">=</span>record[<span class="st">&quot;ops&quot;</span>],</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>                predicted_answer<span class="op">=</span>record[<span class="st">&quot;answer&quot;</span>],</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>                ground_truth_answer<span class="op">=</span>record[<span class="st">&quot;ground_truth_answer&quot;</span>],</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>                table<span class="op">=</span>record[<span class="st">&quot;table&quot;</span>],</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>                conversation_context<span class="op">=</span>record[<span class="st">&quot;conversation_context&quot;</span>],</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>                evidence_snippets<span class="op">=</span>record[<span class="st">&quot;evidence_snippets&quot;</span>],</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>                question<span class="op">=</span>record[<span class="st">&quot;question&quot;</span>],</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>            ).with_inputs(</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;predicted_reasoning&quot;</span>,</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;predicted_ops&quot;</span>,</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;predicted_answer&quot;</span>,</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;ground_truth_answer&quot;</span>,</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;table&quot;</span>,</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;conversation_context&quot;</span>,</span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;evidence_snippets&quot;</span>,</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;question&quot;</span>,</span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
</div>
<div id="cell-98" class="cell" data-execution_count="177">
<div class="sourceCode" id="cb86"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>judge_lm <span class="op">=</span> deepcopy(lm_gemini_flash_2_5)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>judge_results <span class="op">=</span> []</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;final_error_analysis_gemini_flash_2_5&quot;</span>) <span class="im">as</span> run:</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> dspy.context(lm<span class="op">=</span>judge_lm, cache<span class="op">=</span><span class="va">True</span>, track_cost<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> example <span class="kw">in</span> tqdm(judge_examples, desc<span class="op">=</span><span class="st">&quot;Judging examples&quot;</span>):</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>            module <span class="op">=</span> dspy.ChainOfThought(AssessmentSignature)</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>            jr <span class="op">=</span> module(<span class="op">**</span>example)</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>            jr[<span class="st">&quot;assessment_reasoning&quot;</span>] <span class="op">=</span> jr[<span class="st">&quot;reasoning&quot;</span>]</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">del</span> jr[<span class="st">&quot;reasoning&quot;</span>]</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>            judge_results.append(</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;id&quot;</span>: example[<span class="st">&quot;id&quot;</span>],</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;model_name&quot;</span>: example[<span class="st">&quot;model_name&quot;</span>],</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;question&quot;</span>: example[<span class="st">&quot;question&quot;</span>],</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;ground_truth_answer&quot;</span>: example[<span class="st">&quot;ground_truth_answer&quot;</span>],</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;predicted_answer&quot;</span>: example[<span class="st">&quot;predicted_answer&quot;</span>],</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;assessment_answer&quot;</span>: jr[<span class="st">&quot;assessment_answer&quot;</span>],</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;assessment_reasoning&quot;</span>: jr[<span class="st">&quot;assessment_reasoning&quot;</span>],</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>            )</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Judging examples:   0%|          | 0/98 [00:00&lt;?, ?it/s]2025/07/29 15:07:21 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
...
Judging examples: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 98/98 [23:19&lt;00:00, 14.28s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>üèÉ View run final_error_analysis_gemini_flash_2_5 at: http://localhost:5000/#/experiments/3/runs/7925f6a08e264efcb78f0eec4152219d
üß™ View experiment at: http://localhost:5000/#/experiments/3</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
</div>
</div>
</div>
<div id="cell-99" class="cell" data-execution_count="178">
<div class="sourceCode" id="cb89"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(judge_results)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>grouped <span class="op">=</span> (</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">&quot;model_name&quot;</span>, <span class="st">&quot;assessment_answer&quot;</span>]).size().reset_index(name<span class="op">=</span><span class="st">&quot;count&quot;</span>)</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(data<span class="op">=</span>grouped, x<span class="op">=</span><span class="st">&quot;model_name&quot;</span>, y<span class="op">=</span><span class="st">&quot;count&quot;</span>, hue<span class="op">=</span><span class="st">&quot;assessment_answer&quot;</span>)</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Assessment Answer Counts by Model&quot;</span>)</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Count&quot;</span>)</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Model Name&quot;</span>)</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">&quot;Assessment Answer&quot;</span>)</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value annotations</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> ax.patches:</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> p.get_height()</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> height <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>        ax.annotate(</span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f&quot;</span><span class="sc">{</span><span class="bu">int</span>(height)<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>            (p.get_x() <span class="op">+</span> p.get_width() <span class="op">/</span> <span class="dv">2</span>, height),</span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">&quot;center&quot;</span>,</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>            va<span class="op">=</span><span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>            fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">&quot;black&quot;</span>,</span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>            xytext<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>            textcoords<span class="op">=</span><span class="st">&quot;offset points&quot;</span>,</span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure>
<p><img src="2025-09-14-cl-dspy-optimization_files/figure-html/cell-54-output-1.png" class="img-fluid" /></p>
</figure>
</div>
</div>
</div>
<div id="cell-100" class="cell" data-execution_count="186">
<div class="sourceCode" id="cb90"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">&#39;./judge_results/final_judge_results.csv&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
</div>
<div id="cell-101" class="cell" data-execution_count="187">
<div class="sourceCode" id="cb91"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>df.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="187">
<pre><code>(98, 7)</code></pre>
</div>
</div>
<p>As seen before,</p>
<ul>
<li>68 of the examples have an incorrect ground truth i.e our generated answers are correct.</li>
<li>Of the 27 answers that were marked as NUMERICAL_ANSWER_WRONG, some of them are because the llm incorrectly computed some fractions. While this could‚Äôve been solved with tool calling/using a python interpretor, this would‚Äôve made the pipeline more tricky. More on this soon.</li>
<li>The example marked as ‚ÄúEVIDENCE_MISMATCH‚Äù correctly identifies that the model got confused with the given context, and could not resolve the question given the previous conversation history. This step could likely be improved by doing some-form of query rewriting.</li>
</ul>
<p>Overall, assuming the all the judge results are correct for the ‚ÄúGROUND_TRUTH_INCORRECT‚Äù label, our overall accuracy is acrually:</p>
<p><span class="math display">\[
\frac{(580 + 68)}{678} = 95.5\%
\]</span></p>
<p>Note that this is a <em>super optimistic</em> estimate, as we have not accounted for the fact that the judge might have made a mistake in their evaluation. Also, since we didn‚Äôt judge the <em>baseline</em> o4-mini performance, the overall accuracy might be lower than what we‚Äôve calculated here.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2>Conclusion</h2>
<p>As mentioned earlier, our final result looks as follows:</p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 31%" />
<col style="width: 26%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr class="header">
<th>model_name</th>
<th>em_metric before optimisation</th>
<th>em_metric after MIPROv2</th>
<th>% increase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>o4-mini</td>
<td>72.70</td>
<td>85.50</td>
<td>17.6</td>
</tr>
</tbody>
</table>
<p>We‚Äôve improved the performance of o4-mini on our dataset using Curriculum Learning by 17.6%, to acheive a final score of 85.50%!</p>
<p>A few key takeways:</p>
<ol type="1">
<li><strong>Curriculum first ‚Äì then optimize</strong>
<ul>
<li>Ordering exemplars from ‚ÄúEasy ‚Üí Medium ‚Üí Hard‚Äù gave every optimizer a warmer start. Versus a random exemplar pool, accuracy on the Hard tier rose <strong>+4.7 pts</strong> before we even touched DSPy‚Äôs search space.</li>
</ul></li>
<li><strong>DSPy &gt; hand-rolled prompts</strong>
<ul>
<li>With only <code>BootstrapFewShot</code> + <code>BeamSearchOptimizer</code>, the smallest model (o4-mini) jumped from <strong>38.2 ‚Üí 51.6 Hard-tier EM</strong>: the single largest gain in the series.</li>
</ul></li>
</ol>
</section>
<section id="why-no-agents" class="level2">
<h2>Why no agents?</h2>
<p>In this assignment, I‚Äôve deliberately chosen to <em>not use</em> any agentic systems because:</p>
<ul>
<li>Adding agents requires implementation of tools that the agents can use.
<ul>
<li>The only operations that need tools in this dataset are simple mathematical ops(add, subtract, etc.)</li>
<li>Recent models are increasingly getting better at predicting results of math operations, purely through next-token prediction. The recent <a href="https://www.nature.com/articles/d41586-025-02343-x">IMO Gold Medal</a> models by OAI and Deepmind has confirmed that next-token prediction is enough to solve even some of the most challenging math problems and proofs.</li>
<li>Adding tool calling tests another model ability: Instruction Following. Specfically, all tool call are returned in a specific format by the model, and while they mostly suceed, this introduces another area where we have to handle errors.</li>
</ul></li>
</ul>
<p>We argue that in the future model releases, tool calls for doing <code>math operations</code> will be not be required. Instead, tools will be used primarily to help the model get access to <em>your</em> data, such as emails, company slack, etc. via the MCP protocol, and do operations <em>on your behalf</em>.</p>
</section>
<section id="why-no-fine-tuning" class="level2">
<h2>Why no fine-tuning?</h2>
<p><a href="https://arxiv.org/abs/2507.19457">Recent research</a> has shown that good <em>prompt optimisation</em> can lead to better results compared to finetuning, even when we using reinforcement-learning. We confirmed this insight in our notebooks, where we were able to use a small reasoning model to match the frontier reasoning model performance on our dataset.</p>
</section>
<section id="what-could-be-improved" class="level2">
<h2>What could be improved?</h2>
<p>In the future, we could explore the following:</p>
<ul>
<li>The current methodology of supplying the table content is quite simple. We know that table formatting affects how models understand content. I would experiment with other table formats, and especially with XML based table formats.</li>
<li>Currently, the <code>evidence_snippets</code> i.e the pre_text and post_text fields are blindly concatenated into a single paragraph with separators. While this seems to work for the current dataset, to reduce the chance of polluting the ctx window with irrelevant information, we would perform a retrieval step for each question, where only the relevant chunks would be added to the context before answering the question.
<ul>
<li>Because this dataset has many domain specific terms(financial metrics), we argue that BM25 based methods should give a strong baseline, followed by using a late-interaction mechanism(such as ColBERT) to improve retrieval further.</li>
<li>For the domain specific terms, we could also add a stage to retrieve the precise definition of a metric asked in the question, which could further help disambiguate the meaning of the metric. For this, we would use the <a href="https://github.com/sohomghosh/FinRAD_Financial_Readability_Assessment_Dataset">Financial Readability Assessment(FinRAD) Dataset</a>.</li>
</ul></li>
<li>The current dataset has a nice setup for using Reinforcement Learning:
<ul>
<li>Specifically, we could model each dialogue as an episode in RL.</li>
<li>The metric for analysis would be things like answer formatting, answer correctness, answer coherence, etc. We can use hyperparams to control the weight of each of these components.</li>
<li>Finally, we could use GRPO, to train the model based a collection of it‚Äôs own outputs, and picking the best output from them. This is the same methodology used to train Deepseek R1.</li>
<li>DSPy does support optmising a model with GRPO, using the Arbor RL server. I would aim to experiment with this approach.</li>
</ul></li>
<li>Finally, our solution still uses a hosted model.
<ul>
<li>Some businesses may want to use their own hosted/open-source model, particularly those with goverment regulations.</li>
<li>We would experiment with the <code>BootstrapFinetune</code> method from DSPy to finetune a small LM to match the performance of a large LM. Specifcially, we believe we should be able to get comparable performance with Qwen3:32b, an open-source frontier model.</li>
</ul></li>
</ul>
<hr />
<p>Thanks for sticking around! Spotted a bug or have a optimization? Open an issue in the repo, or yell at me on <a href="https://x.com/shubhamg2208">Twitter/X</a>. Happy hacking!</p>
<div id="quarto-navigation-envelope" class="hidden">
<p><span class="hidden" data-render-id="quarto-int-sidebar-title">Shubham Gupta</span> <span class="hidden" data-render-id="quarto-int-navbar-title">Shubham Gupta</span> <span class="hidden" data-render-id="quarto-int-navbar:About">About</span> <span class="hidden" data-render-id="quarto-int-navbar:/about.html">/about.html</span> <span class="hidden" data-render-id="quarto-int-navbar:https://github.com/goodhamgupta">https://github.com/goodhamgupta</span> <span class="hidden" data-render-id="quarto-int-navbar:/index.xml">/index.xml</span></p>
</div>
<div id="quarto-meta-markdown" class="hidden">
<p><span class="hidden" data-render-id="quarto-metatitle">Shubham Gupta - Curriculum Learning ü§ù DSPy: Optimization</span> <span class="hidden" data-render-id="quarto-twittercardtitle">Shubham Gupta - Curriculum Learning ü§ù DSPy: Optimization</span> <span class="hidden" data-render-id="quarto-ogcardtitle">Shubham Gupta - Curriculum Learning ü§ù DSPy: Optimization</span> <span class="hidden" data-render-id="quarto-metasitename">Shubham Gupta</span> <span class="hidden" data-render-id="quarto-twittercarddesc">Optimzing DSPy programs for ConvFinQA</span> <span class="hidden" data-render-id="quarto-ogcardddesc">Optimzing DSPy programs for ConvFinQA</span></p>
</div>
</section>

</main> <!-- /main -->
<script id = "quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js"
        data-repo="goodhamgupta/personal_blog"
        data-repo-id="R_kgDOLXv-xA"
        data-category="General"
        data-category-id="DIC_kwDOLXv-xM4Cdogy"
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->

</body>

</html>
</iframe></div></div></div></section></section></main></div><footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions"><ul><li><a href="https://github.com/goodhamgupta/personal_blog/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>
