<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shubham Gupta">
<meta name="dcterms.date" content="2025-08-31">
<meta name="description" content="Diving into DSPy for ConvFinQA">

<title>Shubham Gupta - Curriculum Learning ü§ù DSPy: EDA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<script src="../site_libs/quarto-search/autocomplete-preset-algolia.umd.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "algolia": {
    "application-id": "HR1HJNZUVY",
    "search-only-api-key": "3326e8971e20d27e2dd21591d6a24656",
    "index-name": "blog_pages",
    "index-fields": {
      "href": "url",
      "section": "sec",
      "text": "body"
    },
    "analytics-events": true,
    "show-logo": false,
    "libDir": "site_libs"
  },
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"></script>


<script type="text/javascript">
var ALGOLIA_INSIGHTS_SRC = "https://cdn.jsdelivr.net/npm/search-insights/dist/search-insights.iife.min.js";
!function(e,a,t,n,s,i,c){e.AlgoliaAnalyticsObject=s,e[s]=e[s]||function(){
(e[s].queue=e[s].queue||[]).push(arguments)},i=a.createElement(t),c=a.getElementsByTagName(t)[0],
i.async=1,i.src=n,c.parentNode.insertBefore(i,c)
}(window,document,"script",ALGOLIA_INSIGHTS_SRC,"aa");
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-plugin-algolia-insights">

</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CLKTGRWBQT"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-CLKTGRWBQT', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Shubham Gupta - Curriculum Learning ü§ù DSPy: EDA">
<meta property="og:description" content="Diving into DSPy for ConvFinQA">
<meta property="og:image" content="https://shubhamg.in/posts/cl_dspy/curriculum_learning_data.png">
<meta property="og:site_name" content="Shubham Gupta">
<meta property="og:image:height" content="1488">
<meta property="og:image:width" content="1202">
<meta name="twitter:title" content="Shubham Gupta - Curriculum Learning ü§ù DSPy: EDA">
<meta name="twitter:description" content="Diving into DSPy for ConvFinQA">
<meta name="twitter:image" content="https://shubhamg.in/posts/cl_dspy/curriculum_learning_data.png">
<meta name="twitter:creator" content="@shubhamg2208">
<meta name="twitter:image-height" content="1488">
<meta name="twitter:image-width" content="1202">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Shubham Gupta</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/goodhamgupta"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Curriculum Learning ü§ù DSPy: EDA</h1>
                  <div>
        <div class="description">
          Diving into DSPy for ConvFinQA
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">programming</div>
                <div class="quarto-category">dspy</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Shubham Gupta </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 31, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#dataset-card" id="toc-dataset-card" class="nav-link" data-scroll-target="#dataset-card">Dataset Card</a>
  <ul class="collapse">
  <li><a href="#table-of-contents" id="toc-table-of-contents" class="nav-link" data-scroll-target="#table-of-contents">Table of Contents</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#useful-extracts-from-the-paper" id="toc-useful-extracts-from-the-paper" class="nav-link" data-scroll-target="#useful-extracts-from-the-paper">Useful Extracts from the Paper</a>
  <ul class="collapse">
  <li><a href="#types-of-question" id="toc-types-of-question" class="nav-link" data-scroll-target="#types-of-question">Types of Question:</a></li>
  </ul></li>
  <li><a href="#dataset-statistics" id="toc-dataset-statistics" class="nav-link" data-scroll-target="#dataset-statistics">Dataset Statistics</a></li>
  <li><a href="#baselines" id="toc-baselines" class="nav-link" data-scroll-target="#baselines">Baselines</a>
  <ul class="collapse">
  <li><a href="#human-baselines" id="toc-human-baselines" class="nav-link" data-scroll-target="#human-baselines">Human Baselines</a></li>
  <li><a href="#model-baselines" id="toc-model-baselines" class="nav-link" data-scroll-target="#model-baselines">Model Baselines</a></li>
  </ul></li>
  <li><a href="#dataset-structure" id="toc-dataset-structure" class="nav-link" data-scroll-target="#dataset-structure">Dataset Structure</a>
  <ul class="collapse">
  <li><a href="#data-fields" id="toc-data-fields" class="nav-link" data-scroll-target="#data-fields">Data Fields</a></li>
  <li><a href="#cleaning-process" id="toc-cleaning-process" class="nav-link" data-scroll-target="#cleaning-process">Cleaning Process</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#eda" id="toc-eda" class="nav-link" data-scroll-target="#eda">EDA</a>
  <ul class="collapse">
  <li><a href="#missing-data" id="toc-missing-data" class="nav-link" data-scroll-target="#missing-data">Missing Data</a></li>
  <li><a href="#pre-and-post-text" id="toc-pre-and-post-text" class="nav-link" data-scroll-target="#pre-and-post-text">pre and post text</a></li>
  <li><a href="#doc_table" id="toc-doc_table" class="nav-link" data-scroll-target="#doc_table"><code>doc_table</code></a>
  <ul class="collapse">
  <li><a href="#table-dimensions" id="toc-table-dimensions" class="nav-link" data-scroll-target="#table-dimensions">Table Dimensions</a></li>
  <li><a href="#column-header-analysis" id="toc-column-header-analysis" class="nav-link" data-scroll-target="#column-header-analysis">Column Header Analysis</a></li>
  <li><a href="#row-header-analysis" id="toc-row-header-analysis" class="nav-link" data-scroll-target="#row-header-analysis">Row Header Analysis</a></li>
  </ul></li>
  <li><a href="#dialogue_conv_questions" id="toc-dialogue_conv_questions" class="nav-link" data-scroll-target="#dialogue_conv_questions"><code>dialogue_conv_questions</code></a></li>
  <li><a href="#dialogue_conv_answers" id="toc-dialogue_conv_answers" class="nav-link" data-scroll-target="#dialogue_conv_answers"><code>dialogue_conv_answers</code></a></li>
  <li><a href="#dialogue_turn_program" id="toc-dialogue_turn_program" class="nav-link" data-scroll-target="#dialogue_turn_program"><code>dialogue_turn_program</code></a></li>
  <li><a href="#features_num_dialogue_turns" id="toc-features_num_dialogue_turns" class="nav-link" data-scroll-target="#features_num_dialogue_turns"><code>features_num_dialogue_turns</code></a></li>
  <li><a href="#features_has_type2_question" id="toc-features_has_type2_question" class="nav-link" data-scroll-target="#features_has_type2_question"><code>features_has_type2_question</code></a></li>
  </ul></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology</a>
  <ul class="collapse">
  <li><a href="#curriculum-learning" id="toc-curriculum-learning" class="nav-link" data-scroll-target="#curriculum-learning">Curriculum Learning</a></li>
  <li><a href="#curriculum-design-quota-rebalancing" id="toc-curriculum-design-quota-rebalancing" class="nav-link" data-scroll-target="#curriculum-design-quota-rebalancing">Curriculum Design &amp; Quota Rebalancing</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/goodhamgupta/personal_blog/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>While interviewing for my next role, I received a take-home assignment focused on financial reasoning over conversational data. Given all the hype around DSPy, I decided to use this opportunity to finally learn the tool properly.</p>
<p>Financial reasoning over conversational data presents a unique challenge in NLP: models must not only understand natural language but also perform multi-step numerical computations while maintaining context across dialogue turns.</p>
<p><a href="https://github.com/czyssrs/ConvFinQA">ConvFinQA</a> tackles this problem by combining conversational QA with financial documents and tables, requiring systems to execute chains of mathematical operations to arrive at correct answers.</p>
<p>What if we could improve model performance by teaching systems to learn from easier examples first, gradually building up to complex multi-turn reasoning? This is the core idea behind curriculum learning.</p>
<p>This post begins a series exploring curriculum learning with <a href="https://github.com/stanfordnlp/dspy">DSPy</a>. We start with an exploratory analysis of ConvFinQA to understand what makes some examples harder than others, identify complexity patterns in the data, and establish the foundation for a curriculum-based approach to training more effective reasoning systems.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Given the dataset ConvFinQA, we will aim to explore the dataset.</p>
<p>Specifically, for the hiring task, our goals are as follows:</p>
<ul>
<li>Explore the dataset to understand the distribution of the data</li>
<li>Identify evaluation metrics that can be used to evaluate the model</li>
<li>Design a high-level flow of the implementation</li>
<li>Identify methods/models to use</li>
</ul>
<div id="cell-4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-5" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="st">"../data/convfinqa_dataset.json"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-6" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>dict_keys(['train', 'dev'])</code></pre>
</div>
</div>
<p>The current dataset only contains the <code>train</code> and <code>dev</code> splits. For evaluation, we will likely use the <code>dev</code> split, and for training, we‚Äôll split the <code>train</code> split into a <code>train</code> and <code>val</code> split.</p>
<div id="cell-8" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"train"</span>][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{'id': 'Single_JKHY/2009/page_28.pdf-3',
 'doc': {'pre_text': '26 | 2009 annual report in fiscal 2008 , revenues in the credit union systems and services business segment increased 14% ( 14 % ) from fiscal 2007 . all revenue components within the segment experienced growth during fiscal 2008 . license revenue generated the largest dollar growth in revenue as episys ae , our flagship core processing system aimed at larger credit unions , experienced strong sales throughout the year . support and service revenue , which is the largest component of total revenues for the credit union segment , experienced 34 percent growth in eft support and 10 percent growth in in-house support . gross profit in this business segment increased $ 9344 in fiscal 2008 compared to fiscal 2007 , due primarily to the increase in license revenue , which carries the highest margins . liquidity and capital resources we have historically generated positive cash flow from operations and have generally used funds generated from operations and short-term borrowings on our revolving credit facility to meet capital requirements . we expect this trend to continue in the future . the company 2019s cash and cash equivalents increased to $ 118251 at june 30 , 2009 from $ 65565 at june 30 , 2008 . the following table summarizes net cash from operating activities in the statement of cash flows : 2009 2008 2007 .',
  'post_text': 'year ended june 30 , cash provided by operations increased $ 25587 to $ 206588 for the fiscal year ended june 30 , 2009 as compared to $ 181001 for the fiscal year ended june 30 , 2008 . this increase is primarily attributable to a decrease in receivables compared to the same period a year ago of $ 21214 . this decrease is largely the result of fiscal 2010 annual software maintenance billings being provided to customers earlier than in the prior year , which allowed more cash to be collected before the end of the fiscal year than in previous years . further , we collected more cash overall related to revenues that will be recognized in subsequent periods in the current year than in fiscal 2008 . cash used in investing activities for the fiscal year ended june 2009 was $ 59227 and includes $ 3027 in contingent consideration paid on prior years 2019 acquisitions . cash used in investing activities for the fiscal year ended june 2008 was $ 102148 and includes payments for acquisitions of $ 48109 , plus $ 1215 in contingent consideration paid on prior years 2019 acquisitions . capital expenditures for fiscal 2009 were $ 31562 compared to $ 31105 for fiscal 2008 . cash used for software development in fiscal 2009 was $ 24684 compared to $ 23736 during the prior year . net cash used in financing activities for the current fiscal year was $ 94675 and includes the repurchase of 3106 shares of our common stock for $ 58405 , the payment of dividends of $ 26903 and $ 13489 net repayment on our revolving credit facilities . cash used in financing activities was partially offset by proceeds of $ 3773 from the exercise of stock options and the sale of common stock ( through the employee stock purchase plan ) and $ 348 excess tax benefits from stock option exercises . during fiscal 2008 , net cash used in financing activities for the fiscal year was $ 101905 and includes the repurchase of 4200 shares of our common stock for $ 100996 , the payment of dividends of $ 24683 and $ 429 net repayment on our revolving credit facilities . cash used in financing activities was partially offset by proceeds of $ 20394 from the exercise of stock options and the sale of common stock and $ 3809 excess tax benefits from stock option exercises . beginning during fiscal 2008 , us financial markets and many of the largest us financial institutions have been shaken by negative developments in the home mortgage industry and the mortgage markets , and particularly the markets for subprime mortgage-backed securities . since that time , these and other such developments have resulted in a broad , global economic downturn . while we , as is the case with most companies , have experienced the effects of this downturn , we have not experienced any significant issues with our current collection efforts , and we believe that any future impact to our liquidity will be minimized by cash generated by recurring sources of revenue and due to our access to available lines of credit. .',
  'table': {'Year ended June 30, 2009': {'net income': 103102.0,
    'non-cash expenses': 74397.0,
    'change in receivables': 21214.0,
    'change in deferred revenue': 21943.0,
    'change in other assets and liabilities': -14068.0,
    'net cash from operating activities': 206588.0},
   '2008': {'net income': 104222.0,
    'non-cash expenses': 70420.0,
    'change in receivables': -2913.0,
    'change in deferred revenue': 5100.0,
    'change in other assets and liabilities': 4172.0,
    'net cash from operating activities': 181001.0},
   '2007': {'net income': 104681.0,
    'non-cash expenses': 56348.0,
    'change in receivables': -28853.0,
    'change in deferred revenue': 24576.0,
    'change in other assets and liabilities': 17495.0,
    'net cash from operating activities': 174247.0}}},
 'dialogue': {'conv_questions': ['what is the net cash from operating activities in 2009?',
   'what about in 2008?',
   'what is the difference?',
   'what percentage change does this represent?'],
  'conv_answers': ['206588', '181001', '25587', '14.1%'],
  'turn_program': ['206588',
   '181001',
   'subtract(206588, 181001)',
   'subtract(206588, 181001), divide(#0, 181001)'],
  'executed_answers': [206588.0, 181001.0, 25587.0, 0.14136],
  'qa_split': [False, False, False, False]},
 'features': {'num_dialogue_turns': 4,
  'has_type2_question': False,
  'has_duplicate_columns': False,
  'has_non_numeric_values': False}}</code></pre>
</div>
</div>
<p>The data matches the schema given in the <code>dataset.md</code> file.</p>
<details>
<summary>
dataset.md
</summary>
</details></section>
<section id="dataset-card" class="level1">
<h1>Dataset Card</h1>
<section id="table-of-contents" class="level2">
<h2 class="anchored" data-anchor-id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#useful-extracts-from-the-paper">Useful Extracts from the Paper</a>
<ul>
<li><a href="#types-of-question">Types of Question</a></li>
</ul></li>
<li><a href="#dataset-statistics">Dataset Statistics</a></li>
<li><a href="#baselines">Baselines</a>
<ul>
<li><a href="#human-baselines">Human Baselines</a></li>
<li><a href="#model-baselines">Model Baselines</a>
<ul>
<li><a href="#statistics">Statistics</a></li>
<li><a href="#analysis-from-the-paper-section-53">Analysis from the Paper</a></li>
</ul></li>
</ul></li>
<li><a href="#dataset-structure">Dataset Structure</a>
<ul>
<li><a href="#data-fields">Data Fields</a></li>
<li><a href="#cleaning-process">Cleaning Process</a></li>
</ul></li>
</ul>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This dataset is a cleaner version of the original dataset from the <a href="https://github.com/czyssrs/ConvFinQA">ConFinQA repo</a>. This dataset consists of conversational numerical reasoning questions over unstructured financial documents, containing datatables.</p>
</section>
<section id="useful-extracts-from-the-paper" class="level2">
<h2 class="anchored" data-anchor-id="useful-extracts-from-the-paper">Useful Extracts from the Paper</h2>
<blockquote class="blockquote">
<p>CONVFINQA (Conversational Finance Question Answering), with 3,892 conversations consisting of 14,115 questions. To construct the dataset, we design a framework to simulate the conversation flow by decomposition and concatenation of the multihop questions from the FinQA dataset.</p>
</blockquote>
<blockquote class="blockquote">
<p>In our CONVFINQA dataset, the major challenge is to learn the chain of numerical reasoning throughout the conversation turns.</p>
</blockquote>
<p>A sample example:</p>
<p><img src="cl_dspy/exampleq.png" alt="Example Question" width="400"></p>
<section id="types-of-question" class="level3">
<h3 class="anchored" data-anchor-id="types-of-question">Types of Question:</h3>
<ul>
<li><strong>Type I: Simple conversation</strong>: we take one muti-hop question and decompose its reasoning program into single steps ‚Äì each reasoning step will then be realized into one question as one conversation turn.</li>
<li><strong>Type II: Hybrid conversations</strong>: We take two multi-hop questions about the same report and break down their reasoning steps. Then, we add a number selection steps like in type I conversations. By combining the steps from both questions, we build a full conversation that reflects someone asking about two related aspects of the same report. Since these aspects are often connected, the resulting conversation includes longer reasoning chains across turns.</li>
</ul>
<p><img src="cl_dspy/conversation_types.png" alt="Conversation Types" width="500"></p>
</section>
</section>
<section id="dataset-statistics" class="level2">
<h2 class="anchored" data-anchor-id="dataset-statistics">Dataset Statistics</h2>
<blockquote class="blockquote">
<p>We end up with 3,892 conversations containing 14,115 questions. We split the dataset into 3,037/421/434 for train/dev/test sets. 2,715 of the conversations are simple conversations, and the rest 1,177 are hybrid conversations.</p>
</blockquote>
<table class="table">
<thead>
<tr class="header">
<th>Split</th>
<th>Conversations</th>
<th>Questions</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Train</td>
<td>3,037</td>
<td>‚Äî</td>
</tr>
<tr class="even">
<td>Dev</td>
<td>421</td>
<td>‚Äî</td>
</tr>
<tr class="odd">
<td>Test</td>
<td>434</td>
<td>‚Äî</td>
</tr>
<tr class="even">
<td><strong>Total</strong></td>
<td><strong>3,892</strong></td>
<td><strong>14,115</strong></td>
</tr>
</tbody>
</table>
<p><img src="cl_dspy/dataset_stats.png" alt="Dataset Statistics" width="350"></p>
</section>
<section id="baselines" class="level2">
<h2 class="anchored" data-anchor-id="baselines">Baselines</h2>
<section id="human-baselines" class="level3">
<h3 class="anchored" data-anchor-id="human-baselines">Human Baselines</h3>
<blockquote class="blockquote">
<p>To evaluate the quality of CONVFINQA and establish human performance references, we sample 200 example questions and distribute to both the expert and laymen annotators to answer.</p>
</blockquote>
<table class="table">
<thead>
<tr class="header">
<th>Annotator</th>
<th>Exe Acc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Human Expert Performance</strong></td>
<td><strong>89.44</strong></td>
</tr>
<tr class="even">
<td>General Crowd Performance</td>
<td>46.90</td>
</tr>
</tbody>
</table>
</section>
<section id="model-baselines" class="level3">
<h3 class="anchored" data-anchor-id="model-baselines">Model Baselines</h3>
<section id="statistics" class="level4">
<h4 class="anchored" data-anchor-id="statistics">Statistics</h4>
<table class="table">
<thead>
<tr class="header">
<th>Model</th>
<th>Method</th>
<th>Exe Acc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GPT-3</td>
<td>answer-only-prompt</td>
<td>24.09</td>
</tr>
<tr class="even">
<td>GPT-3</td>
<td>CoT prompting</td>
<td>40.63</td>
</tr>
<tr class="odd">
<td>GPT-3</td>
<td>DSL program*</td>
<td>45.15</td>
</tr>
<tr class="even">
<td>FinQANet(RoBERTa-large)**</td>
<td>DSL program</td>
<td><strong>68.90</strong></td>
</tr>
</tbody>
</table>
<p>*Referred to as: <code>Program-normal-DSL</code> prompting in the paper</p>
<p>**Proposed in FinQA, it is a pipeline approach with a retriever to first retrieve the supporting facts from the input financial report, then a generator to generate the DSL program to get the answer. Note: all methods in this baseline table had a retrieval step, not just FinQANet. #### Analysis from the Paper (Section 5.3): &gt; The model [FinQANet] excels at number selection questions. For the number selection questions depending on previous references, e.g., what is that value in the subsequent year?, the model is mostly able to answer. Also, the model is mostly clear on when to discard the previous context and make the transition to new questions.</p>
<blockquote class="blockquote">
<p>The model [FinQANet] suffers from the lack of domain knowledge. The lack of financial knowledge leads to many errors of missing retrieval facts, wrong value selections, and wrong mathematical generations. Nonetheless, the current large pretrained models do see financial corpus during pretraining; we still need to endow the system with stronger domain knowledge for tasks requiring high-level, complex domain reasoning abilities.</p>
</blockquote>
<blockquote class="blockquote">
<p>The model [FinQANet] struggles with long reasoning chains. For the later question turns in a conversation that demonstrate longer reasoning dependencies to the previous context, the model often struggles with deducting the correct reasoning programs. If the prediction for any turn is wrong, then there is a very minor chance that the subsequent turns are correct.</p>
</blockquote>
<blockquote class="blockquote">
<p>Later turns in the conversations [by FinQANet] tend to be harder to answer due to longer reasoning dependencies. [See figure 5.]</p>
</blockquote>
<p><img src="cl_dspy/figure5.png" alt="Figure 5" width="500"></p>
</section>
</section>
</section>
<section id="dataset-structure" class="level2">
<h2 class="anchored" data-anchor-id="dataset-structure">Dataset Structure</h2>
<section id="data-fields" class="level3">
<h3 class="anchored" data-anchor-id="data-fields">Data Fields</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConvFinQARecord(BaseModel):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span>: <span class="bu">str</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"The id of the record"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    doc: Document <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"The document"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    dialogue: Dialogue <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"The conversational dialogue"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    features: Features <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"The features of the record, created by XXX to help you understand the data"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Document(BaseModel):</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    pre_text: <span class="bu">str</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"The text before the table in the document"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    post_text: <span class="bu">str</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"The text after the table in the document"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    table: <span class="bu">dict</span>[<span class="bu">str</span>, <span class="bu">dict</span>[<span class="bu">str</span>, <span class="bu">float</span> <span class="op">|</span> <span class="bu">str</span> <span class="op">|</span> <span class="bu">int</span>]] <span class="op">=</span> Field(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The table of the document as a dictionary "</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dialogue(BaseModel):</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    conv_questions: <span class="bu">list</span>[<span class="bu">str</span>] <span class="op">=</span> Field(</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The questions in the conversation dialogue, originally called 'dialogue_break'"</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    conv_answers: <span class="bu">list</span>[<span class="bu">str</span>] <span class="op">=</span> Field(</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The answers to each question turn, derived from 'answer_list' and original FinQA answers"</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    turn_program: <span class="bu">list</span>[<span class="bu">str</span>] <span class="op">=</span> Field(</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The DSL turn program for each question turn"</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    executed_answers: <span class="bu">list</span>[<span class="bu">float</span> <span class="op">|</span> <span class="bu">str</span>] <span class="op">=</span> Field(</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The golden program execution results for each question turn"</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    qa_split: <span class="bu">list</span>[<span class="bu">bool</span>] <span class="op">=</span> Field(</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"This field indicates the source of each question turn - 0 if from the decomposition of the first FinQA question, 1 if from the second. For the Type I simple conversations, this field is all 0s."</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Features(BaseModel):</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    num_dialogue_turns: <span class="bu">int</span> <span class="op">=</span> Field(</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The number of turns in the dialogue, calculated from the length of conv_questions"</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    has_type2_question: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether the dialogue has a type 2 question, calculated if qa_split contains a 1 this will return true"</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    has_duplicate_columns: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether the table has duplicate column names not fully addressed during cleaning. We suffix the duplicate column headers with a number if there was no algorithmic fix. e.g. 'Revenue (1)' or 'Revenue (2) "</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    has_non_numeric_values: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether the table has non-numeric values"</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="cleaning-process" class="level3">
<h3 class="anchored" data-anchor-id="cleaning-process">Cleaning Process</h3>
<p>The original data is in a messy disorganised state with a lot of errors in the original OCR process. We have cleaned it for you for the purpose of this task. Though it is not perfect.</p>
<p><strong>Tables:</strong> - Fix duplicate column headers, either by inspecting the original table or by suffixing the duplicate column headers with a number if there was no algorithmic fix. e.g.&nbsp;‚ÄòRevenue (1)‚Äô or ‚ÄòRevenue (2)‚Äô - Convert all values to numeric where applicable, e.g.&nbsp;negative values are sometimes written as ‚Äò(12345)‚Äô or ‚Äò-12345 (12345)‚Äô when they should be -12345.0</p>
<p><strong>Dialogue:</strong> - Answer list is now the correct length and corresponds to the number of the dialogue questions - Answer list contains the correct answers for each conversational question instead of placeholder values located in multiple places</p>

<div id="cell-10" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.DataFrame(data[<span class="st">"train"</span>])</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame(data[<span class="st">"dev"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-11" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>train_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Index(['id', 'doc', 'dialogue', 'features'], dtype='object')</code></pre>
</div>
</div>
<div id="cell-12" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>train_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3037 entries, 0 to 3036
Data columns (total 4 columns):
 #   Column    Non-Null Count  Dtype 
---  ------    --------------  ----- 
 0   id        3037 non-null   object
 1   doc       3037 non-null   object
 2   dialogue  3037 non-null   object
 3   features  3037 non-null   object
dtypes: object(4)
memory usage: 95.0+ KB</code></pre>
</div>
</div>
<div id="cell-13" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>test_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>Index(['id', 'doc', 'dialogue', 'features'], dtype='object')</code></pre>
</div>
</div>
<div id="cell-14" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>test_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 421 entries, 0 to 420
Data columns (total 4 columns):
 #   Column    Non-Null Count  Dtype 
---  ------    --------------  ----- 
 0   id        421 non-null    object
 1   doc       421 non-null    object
 2   dialogue  421 non-null    object
 3   features  421 non-null    object
dtypes: object(4)
memory usage: 13.3+ KB</code></pre>
</div>
</div>
<p>Given the schema in <code>dataset.md</code> file, we will <em>explode</em> the columns with nested features to make them easier to work with.</p>
<div id="cell-16" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>train_flat_df <span class="op">=</span> pd.concat(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        train_df.drop([<span class="st">"doc"</span>, <span class="st">"dialogue"</span>, <span class="st">"features"</span>], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"doc"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"doc_"</span>),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"dialogue"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"dialogue_"</span>),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"features"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"features_"</span>),</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>test_flat_df <span class="op">=</span> pd.concat(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        test_df.drop([<span class="st">"doc"</span>, <span class="st">"dialogue"</span>, <span class="st">"features"</span>], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"doc"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"doc_"</span>),</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"dialogue"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"dialogue_"</span>),</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"features"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"features_"</span>),</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3037 entries, 0 to 3036
Data columns (total 13 columns):
 #   Column                           Non-Null Count  Dtype 
---  ------                           --------------  ----- 
 0   id                               3037 non-null   object
 1   doc_pre_text                     3037 non-null   object
 2   doc_post_text                    3037 non-null   object
 3   doc_table                        3037 non-null   object
 4   dialogue_conv_questions          3037 non-null   object
 5   dialogue_conv_answers            3037 non-null   object
 6   dialogue_turn_program            3037 non-null   object
 7   dialogue_executed_answers        3037 non-null   object
 8   dialogue_qa_split                3037 non-null   object
 9   features_num_dialogue_turns      3037 non-null   int64 
 10  features_has_type2_question      3037 non-null   bool  
 11  features_has_duplicate_columns   3037 non-null   bool  
 12  features_has_non_numeric_values  3037 non-null   bool  
dtypes: bool(3), int64(1), object(9)
memory usage: 246.3+ KB</code></pre>
</div>
</div>
<div id="cell-18" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>test_flat_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 421 entries, 0 to 420
Data columns (total 13 columns):
 #   Column                           Non-Null Count  Dtype 
---  ------                           --------------  ----- 
 0   id                               421 non-null    object
 1   doc_pre_text                     421 non-null    object
 2   doc_post_text                    421 non-null    object
 3   doc_table                        421 non-null    object
 4   dialogue_conv_questions          421 non-null    object
 5   dialogue_conv_answers            421 non-null    object
 6   dialogue_turn_program            421 non-null    object
 7   dialogue_executed_answers        421 non-null    object
 8   dialogue_qa_split                421 non-null    object
 9   features_num_dialogue_turns      421 non-null    int64 
 10  features_has_type2_question      421 non-null    bool  
 11  features_has_duplicate_columns   421 non-null    bool  
 12  features_has_non_numeric_values  421 non-null    bool  
dtypes: bool(3), int64(1), object(9)
memory usage: 34.2+ KB</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="eda" class="level1">
<h1>EDA</h1>
<section id="missing-data" class="level3">
<h3 class="anchored" data-anchor-id="missing-data">Missing Data</h3>
<p>First, let‚Äôs check to see if there‚Äôs any missing data in any field.</p>
<div id="cell-22" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> missingno <span class="im">as</span> msno</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>msno.matrix(train_flat_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-23" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>msno.matrix(test_flat_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-15-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>No missing values in the training dataset.</p>
</section>
<section id="pre-and-post-text" class="level2">
<h2 class="anchored" data-anchor-id="pre-and-post-text">pre and post text</h2>
<p>According to the database schema:</p>
<ul>
<li>pre_text -&gt; Supporting text from the document occuring BEFORE the table content</li>
<li>post_text -&gt; Supporting text from the document occuring AFTER the table content</li>
</ul>
<div id="cell-27" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>pprint(train_flat_df[<span class="st">"doc_pre_text"</span>].head().iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('26 | 2009 annual report in fiscal 2008 , revenues in the credit union '
 'systems and services business segment increased 14% ( 14 % ) from fiscal '
 '2007 . all revenue components within the segment experienced growth during '
 'fiscal 2008 . license revenue generated the largest dollar growth in revenue '
 'as episys ae , our flagship core processing system aimed at larger credit '
 'unions , experienced strong sales throughout the year . support and service '
 'revenue , which is the largest component of total revenues for the credit '
 'union segment , experienced 34 percent growth in eft support and 10 percent '
 'growth in in-house support . gross profit in this business segment increased '
 '$ 9344 in fiscal 2008 compared to fiscal 2007 , due primarily to the '
 'increase in license revenue , which carries the highest margins . liquidity '
 'and capital resources we have historically generated positive cash flow from '
 'operations and have generally used funds generated from operations and '
 'short-term borrowings on our revolving credit facility to meet capital '
 'requirements . we expect this trend to continue in the future . the company '
 '2019s cash and cash equivalents increased to $ 118251 at june 30 , 2009 from '
 '$ 65565 at june 30 , 2008 . the following table summarizes net cash from '
 'operating activities in the statement of cash flows : 2009 2008 2007 .')</code></pre>
</div>
</div>
<div id="cell-28" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(<span class="bu">len</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>count    3037.000000
mean     1760.501811
std      1397.695620
min         1.000000
25%       568.000000
50%      1417.000000
75%      2765.000000
max      7153.000000
Name: doc_pre_text, dtype: float64</code></pre>
</div>
</div>
<div id="cell-29" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>pprint(test_flat_df[<span class="st">"doc_pre_text"</span>].head().iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('stock-based awards under the plan stock options 2013 marathon grants stock '
 'options under the 2007 plan and previously granted options under the 2003 '
 'plan . marathon 2019s stock options represent the right to purchase shares '
 'of common stock at the fair market value of the common stock on the date of '
 'grant . through 2004 , certain stock options were granted under the 2003 '
 'plan with a tandem stock appreciation right , which allows the recipient to '
 'instead elect to receive cash and/or common stock equal to the excess of the '
 'fair market value of shares of common stock , as determined in accordance '
 'with the 2003 plan , over the option price of the shares . in general , '
 'stock options granted under the 2007 plan and the 2003 plan vest ratably '
 'over a three-year period and have a maximum term of ten years from the date '
 'they are granted . stock appreciation rights 2013 prior to 2005 , marathon '
 'granted sars under the 2003 plan . no stock appreciation rights have been '
 'granted under the 2007 plan . similar to stock options , stock appreciation '
 'rights represent the right to receive a payment equal to the excess of the '
 'fair market value of shares of common stock on the date the right is '
 'exercised over the grant price . under the 2003 plan , certain sars were '
 'granted as stock-settled sars and others were granted in tandem with stock '
 'options . in general , sars granted under the 2003 plan vest ratably over a '
 'three-year period and have a maximum term of ten years from the date they '
 'are granted . stock-based performance awards 2013 prior to 2005 , marathon '
 'granted stock-based performance awards under the 2003 plan . no stock-based '
 'performance awards have been granted under the 2007 plan . beginning in 2005 '
 ', marathon discontinued granting stock-based performance awards and instead '
 'now grants cash-settled performance units to officers . all stock-based '
 'performance awards granted under the 2003 plan have either vested or been '
 'forfeited . as a result , there are no outstanding stock-based performance '
 'awards . restricted stock 2013 marathon grants restricted stock and '
 'restricted stock units under the 2007 plan and previously granted such '
 'awards under the 2003 plan . in 2005 , the compensation committee began '
 'granting time-based restricted stock to certain u.s.-based officers of '
 'marathon and its consolidated subsidiaries as part of their annual long-term '
 'incentive package . the restricted stock awards to officers vest three years '
 'from the date of grant , contingent on the recipient 2019s continued '
 'employment . marathon also grants restricted stock to certain non-officer '
 'employees and restricted stock units to certain international employees ( '
 '201crestricted stock awards 201d ) , based on their performance within '
 'certain guidelines and for retention purposes . the restricted stock awards '
 'to non-officers generally vest in one-third increments over a three-year '
 'period , contingent on the recipient 2019s continued employment . prior to '
 'vesting , all restricted stock recipients have the right to vote such stock '
 'and receive dividends thereon . the non-vested shares are not transferable '
 'and are held by marathon 2019s transfer agent . common stock units 2013 '
 'marathon maintains an equity compensation program for its non-employee '
 'directors under the 2007 plan and previously maintained such a program under '
 'the 2003 plan . all non-employee directors other than the chairman receive '
 'annual grants of common stock units , and they are required to hold those '
 'units until they leave the board of directors . when dividends are paid on '
 'marathon common stock , directors receive dividend equivalents in the form '
 'of additional common stock units . stock-based compensation expense 2013 '
 'total employee stock-based compensation expense was $ 80 million , $ 83 '
 'million and $ 111 million in 2007 , 2006 and 2005 . the total related income '
 'tax benefits were $ 29 million , $ 31 million and $ 39 million . in 2007 and '
 '2006 , cash received upon exercise of stock option awards was $ 27 million '
 'and $ 50 million . tax benefits realized for deductions during 2007 and 2006 '
 'that were in excess of the stock-based compensation expense recorded for '
 'options exercised and other stock-based awards vested during the period '
 'totaled $ 30 million and $ 36 million . cash settlements of stock option '
 'awards totaled $ 1 million and $ 3 million in 2007 and 2006 . stock option '
 'awards granted 2013 during 2007 , 2006 and 2005 , marathon granted stock '
 'option awards to both officer and non-officer employees . the weighted '
 'average grant date fair value of these awards was based on the following '
 'black-scholes assumptions: .')</code></pre>
</div>
</div>
<div id="cell-30" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(<span class="bu">len</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>count     421.000000
mean     1538.061758
std      1337.167597
min        17.000000
25%       410.000000
50%      1072.000000
75%      2347.000000
max      5639.000000
Name: doc_pre_text, dtype: float64</code></pre>
</div>
</div>
<p>Looks like the pre_text in the data has some si</p>
<div id="cell-32" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    train_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Length of doc_pre_text"</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"train_flat_df: doc_pre_text length"</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    test_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"orange"</span>,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Length of doc_pre_text"</span>)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"test_flat_df: doc_pre_text length"</span>)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    train_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Length of doc_post_text"</span>)</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"train_flat_df: doc_post_text length"</span>)</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    test_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Length of doc_post_text"</span>)</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"test_flat_df: doc_post_text length"</span>)</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-20-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-20-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-20-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Looks like the train and test data have a similar distribution for doc_pre_text and doc_post_text.</p>
<p>However, we do see some extreme outliers, with the large documents have &gt; 5000 characters.</p>
<p>Most new generation LLMs do have a ctx window large enough to handle both pre text + table + post text in the same context window, and we may not need any pre-processing for fields. However, we will revisit this later.</p>
</section>
<section id="doc_table" class="level2">
<h2 class="anchored" data-anchor-id="doc_table"><code>doc_table</code></h2>
<section id="table-dimensions" class="level3">
<h3 class="anchored" data-anchor-id="table-dimensions">Table Dimensions</h3>
<div id="cell-36" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_dims(table):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute basic shape statistics for a table dict.</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">        table (dict): Mapping from row keys to dicts of column:value pairs.</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">        pd.Series: Series with n_rows, n_cols, total_cells.</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co">            - n_rows: Number of rows in the table (outer dict keys)</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">            - n_cols: Number of unique columns across all rows</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">            - total_cells: Total number of (row, col) value pairs</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    n_rows <span class="op">=</span> <span class="bu">len</span>(table)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> {col <span class="cf">for</span> row <span class="kw">in</span> table.values() <span class="cf">for</span> col <span class="kw">in</span> row}</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    n_cols <span class="op">=</span> <span class="bu">len</span>(cols)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    total_cells <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(row) <span class="cf">for</span> row <span class="kw">in</span> table.values())</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series({<span class="st">"n_rows"</span>: n_rows, <span class="st">"n_cols"</span>: n_cols, <span class="st">"total_cells"</span>: total_cells})</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> (train_flat_df, test_flat_df):</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    df[[<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]] <span class="op">=</span> df[<span class="st">"doc_table"</span>].<span class="bu">apply</span>(compute_dims)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>all_dims <span class="op">=</span> pd.concat(</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        train_flat_df[[<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]].assign(split<span class="op">=</span><span class="st">"train"</span>),</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>        test_flat_df[[<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]].assign(split<span class="op">=</span><span class="st">"test"</span>),</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    ignore_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, col <span class="kw">in</span> <span class="bu">zip</span>(axes, [<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]):</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    sns.histplot(data<span class="op">=</span>all_dims, x<span class="op">=</span>col, hue<span class="op">=</span><span class="st">"split"</span>, multiple<span class="op">=</span><span class="st">"stack"</span>, bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax)</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    ax.set_title(col)</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-21-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Some key points:</p>
<ul>
<li>Most tables don‚Äôt have more than 6 rows. This is good, since it limits the amount of error that can be introduced by the model when answering a question.</li>
<li>Column distribution is a bit more extreme, especially in the training dataset.
<ul>
<li>While the training dataset has a maximum of 17 columns, most of the <code>test</code> dataset tops out at ~8-9 columns.</li>
<li>This is a good feature we could use to determine which records to use for the evaluation. More on this soon!</li>
</ul></li>
<li>Same as the number of columns, we see that the training dataset has a much wider distribution of number of cells. In the test set, the majority of records have cells &lt; 30.</li>
</ul>
<div id="cell-38" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tables with more than </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss"> columns per split:"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> split, df <span class="kw">in</span> [(<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)]:</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> df[df[<span class="st">"n_cols"</span>] <span class="op">&gt;</span> threshold]</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(subset)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> subset.empty:</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(subset[[<span class="st">"id"</span>, <span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>]].head(), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tables with more than 10 columns per split:
  train: 100
                                id  n_rows  n_cols
16     Double_PNC/2014/page_99.pdf       2      14
37    Single_GS/2013/page_47.pdf-2       3      12
90   Single_CDW/2015/page_34.pdf-2       5      12
133   Single_CE/2014/page_90.pdf-1       1      11
137   Single_C/2009/page_195.pdf-2       3      14 

  test: 8
                                id  n_rows  n_cols
50   Single_JPM/2007/page_33.pdf-2       3      11
51   Single_GS/2017/page_143.pdf-2       2      13
109  Single_JPM/2007/page_33.pdf-1       3      11
117  Single_GS/2017/page_143.pdf-1       2      13
298  Single_MA/2008/page_126.pdf-1       1      14 
</code></pre>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_nested_tables(table):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Recursively count nested tables in a table dict.</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">    A nested table is any dict or list of dicts within cell values (deeper than the row level).</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _count(t, depth):</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        cnt <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(t, <span class="bu">dict</span>):</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> v <span class="kw">in</span> t.values():</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(v, <span class="bu">dict</span>):</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> depth <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>                        cnt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>                    cnt <span class="op">+=</span> _count(v, depth <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> <span class="bu">isinstance</span>(v, <span class="bu">list</span>):</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> item <span class="kw">in</span> v:</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">isinstance</span>(item, <span class="bu">dict</span>):</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> depth <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>                                cnt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>                            cnt <span class="op">+=</span> _count(item, depth <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cnt</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _count(table, <span class="dv">0</span>)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> (train_flat_df, test_flat_df):</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"nested_tables"</span>] <span class="op">=</span> df[<span class="st">"doc_table"</span>].<span class="bu">apply</span>(count_nested_tables)</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Nested tables per split:"</span>)</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> split, df <span class="kw">in</span> [(<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)]:</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    nt <span class="op">=</span> df[<span class="st">"nested_tables"</span>]</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">: docs w/ nested tables = </span><span class="sc">{</span>(nt <span class="op">&gt;</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span><span class="bu">len</span>(nt)<span class="sc">}</span><span class="ss">, max nested = </span><span class="sc">{</span>nt<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>nested_df <span class="op">=</span> pd.concat(</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>        train_flat_df[[<span class="st">"nested_tables"</span>]].assign(split<span class="op">=</span><span class="st">"train"</span>),</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>        test_flat_df[[<span class="st">"nested_tables"</span>]].assign(split<span class="op">=</span><span class="st">"test"</span>),</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>    ignore_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>nested_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nested tables per split:
  train: docs w/ nested tables = 0 / 3037, max nested = 0
  test: docs w/ nested tables = 0 / 421, max nested = 0
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3458 entries, 0 to 3457
Data columns (total 2 columns):
 #   Column         Non-Null Count  Dtype 
---  ------         --------------  ----- 
 0   nested_tables  3458 non-null   int64 
 1   split          3458 non-null   object
dtypes: int64(1), object(1)
memory usage: 54.2+ KB</code></pre>
</div>
</div>
<div id="cell-40" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>nested_df[nested_df[<span class="st">"nested_tables"</span>] <span class="op">&gt;=</span> <span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">nested_tables</th>
<th data-quarto-table-cell-role="th">split</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Looks like the table are not deeply nested! This is good since we don‚Äôt have to worry too much about table formatting, when sending the table as context to the LLM.</p>
<div id="cell-42" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="column-header-analysis" class="level3">
<h3 class="anchored" data-anchor-id="column-header-analysis">Column Header Analysis</h3>
<div id="cell-44" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_split(df, split_name):</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    n_docs <span class="op">=</span> <span class="bu">len</span>(df)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    dup_count <span class="op">=</span> df[<span class="st">"features_has_duplicate_columns"</span>].<span class="bu">sum</span>()</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    years_per_doc <span class="op">=</span> df[<span class="st">"doc_table"</span>].<span class="bu">apply</span>(<span class="bu">len</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    year_stats <span class="op">=</span> years_per_doc.describe().to_dict()</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    freq <span class="op">=</span> Counter()</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    doc_freq <span class="op">=</span> Counter()</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    all_headers <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tbl <span class="kw">in</span> df[<span class="st">"doc_table"</span>]:</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>        hdrs_in_doc <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> year_dict <span class="kw">in</span> tbl.values():</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>            freq.update(year_dict.keys())</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>            hdrs_in_doc.update(year_dict.keys())</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>        doc_freq.update(hdrs_in_doc)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>        all_headers.update(hdrs_in_doc)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- </span><span class="sc">{</span>split_name<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> SPLIT ---"</span>)</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total docs: </span><span class="sc">{</span>n_docs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Docs w/ duplicate cols: </span><span class="sc">{</span>dup_count<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>dup_count <span class="op">/</span> n_docs<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Years/doc stats: </span><span class="sc">{</span>year_stats<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique headers across all docs: </span><span class="sc">{</span><span class="bu">len</span>(all_headers)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Top 10 headers by total occurrences:"</span>, freq.most_common(<span class="dv">10</span>))</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Top 10 headers by docs appeared in:"</span>, doc_freq.most_common(<span class="dv">10</span>))</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> [(<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)]:</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    analyze_split(df, name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- TRAIN SPLIT ---
Total docs: 3037
Docs w/ duplicate cols: 60 (2.0%)
Years/doc stats: {'count': 3037.0, 'mean': 2.839973658215344, 'std': 1.5134690841267935, 'min': 1.0, '25%': 2.0, '50%': 3.0, '75%': 3.0, 'max': 10.0}
Unique headers across all docs: 3948
Top 10 headers by total occurrences: [('total', 1147), ('s&amp;p 500 index', 456), ('s&amp;p 500', 419), ('other', 371), ('operating profit', 253), ('net sales', 229), ('2009', 210), ('2012', 206), ('2010', 206), ('2011', 201)]
Top 10 headers by docs appeared in: [('total', 383), ('other', 205), ('thereafter', 109), ('2012', 107), ('2011', 103), ('2013', 102), ('2010', 99), ('2009', 98), ('2014', 91), ('2018', 87)]

--- TEST SPLIT ---
Total docs: 421
Docs w/ duplicate cols: 17 (4.0%)
Years/doc stats: {'count': 421.0, 'mean': 3.0332541567695963, 'std': 1.6500609236986385, 'min': 1.0, '25%': 2.0, '50%': 3.0, '75%': 4.0, 'max': 8.0}
Unique headers across all docs: 833
Top 10 headers by total occurrences: [('total', 183), ('s&amp;p 500 index', 120), ('cadence design systems inc .', 72), ('nasdaq composite', 72), ('other', 60), ('s&amp;p 500', 42), ('2011', 40), ('operating income', 39), ('2012', 38), ('s&amp;p retail index', 36)]
Top 10 headers by docs appeared in: [('total', 54), ('other', 36), ('s&amp;p 500 index', 20), ('2014', 18), ('2015', 18), ('2012', 17), ('2010', 16), ('2011', 16), ('2007', 16), ('2017', 14)]</code></pre>
</div>
</div>
</section>
<section id="row-header-analysis" class="level3">
<h3 class="anchored" data-anchor-id="row-header-analysis">Row Header Analysis</h3>
<div id="cell-46" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_row_key(k: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Lower-case, drop punctuation, collapse spaces."""</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> k:</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> k.lower()</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> re.sub(<span class="vs">r"[_\-]"</span>, <span class="st">" "</span>, k)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> re.sub(<span class="vs">r"[()%:$,]"</span>, <span class="st">" "</span>, k)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.sub(<span class="vs">r"\s+"</span>, <span class="st">" "</span>, k).strip()</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_row_headers(df, split_name: <span class="bu">str</span>, top_n: <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span>):</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    raw_freq, norm_freq, summary_freq <span class="op">=</span> Counter(), Counter(), Counter()</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    summary_kw <span class="op">=</span> (</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total"</span>,</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"net"</span>,</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"%"</span>,</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"percent"</span>,</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"change"</span>,</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"difference"</span>,</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"subtotal"</span>,</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"summary"</span>,</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tbl <span class="kw">in</span> df[<span class="st">"doc_table"</span>]:</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(tbl, <span class="bu">dict</span>):</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> year_dict <span class="kw">in</span> tbl.values():</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(year_dict, <span class="bu">dict</span>):</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> raw <span class="kw">in</span> year_dict.keys():</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> raw <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>                raw <span class="op">=</span> <span class="bu">str</span>(raw).strip()</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>                norm <span class="op">=</span> normalize_row_key(raw)</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>                raw_freq[raw] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>                norm_freq[norm] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">any</span>(k <span class="kw">in</span> raw.lower() <span class="cf">for</span> k <span class="kw">in</span> summary_kw):</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>                    summary_freq[raw] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>    total_rows <span class="op">=</span> <span class="bu">sum</span>(raw_freq.values())</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">===== </span><span class="sc">{</span>split_name<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> SPLIT : ROW HEADER ANALYSIS ====="</span>)</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Row instances              : </span><span class="sc">{</span>total_rows<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique raw headers         : </span><span class="sc">{</span><span class="bu">len</span>(raw_freq)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique normalized headers  : </span><span class="sc">{</span><span class="bu">len</span>(norm_freq)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Raw header  ‚ûú  Normalized header (top 10 by freq)"</span>)</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> hdr, _ <span class="kw">in</span> raw_freq.most_common(<span class="dv">10</span>):</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>hdr[:<span class="dv">55</span>]<span class="sc">:55}</span><span class="ss"> ‚ûú </span><span class="sc">{</span>normalize_row_key(hdr)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top-</span><span class="sc">{</span>top_n<span class="sc">}</span><span class="ss"> most frequent financial metrics (normalized)"</span>)</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> hdr, cnt <span class="kw">in</span> norm_freq.most_common(top_n):</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>hdr[:<span class="dv">55</span>]<span class="sc">:55}</span><span class="ss"> </span><span class="sc">{</span>cnt<span class="sc">:&gt;6}</span><span class="ss">"</span>)</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>    tot_summary <span class="op">=</span> <span class="bu">sum</span>(summary_freq.values())</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Subtotal/Summary rows detected (keywords </span><span class="sc">{</span>summary_kw<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Instances: </span><span class="sc">{</span>tot_summary<span class="sc">}</span><span class="ss">  (</span><span class="sc">{</span>tot_summary <span class="op">/</span> total_rows<span class="sc">:.1%}</span><span class="ss"> of all rows)"</span>)</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> hdr, cnt <span class="kw">in</span> summary_freq.most_common(<span class="dv">10</span>):</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>hdr[:<span class="dv">55</span>]<span class="sc">:55}</span><span class="ss"> </span><span class="sc">{</span>cnt<span class="sc">:&gt;6}</span><span class="ss">"</span>)</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> ((<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)):</span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>    analyze_row_headers(df, name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
===== TRAIN SPLIT : ROW HEADER ANALYSIS =====
Row instances              : 42813
Unique raw headers         : 3,948
Unique normalized headers  : 3,921

Raw header  ‚ûú  Normalized header (top 10 by freq)
total                                                   ‚ûú total
s&amp;p 500 index                                           ‚ûú s&amp;p 500 index
s&amp;p 500                                                 ‚ûú s&amp;p 500
other                                                   ‚ûú other
operating profit                                        ‚ûú operating profit
net sales                                               ‚ûú net sales
2009                                                    ‚ûú 2009
2012                                                    ‚ûú 2012
2010                                                    ‚ûú 2010
2011                                                    ‚ûú 2011

Top-10 most frequent financial metrics (normalized)
total                                                     1147
s&amp;p 500 index                                              456
s&amp;p 500                                                    419
other                                                      371
operating profit                                           253
net sales                                                  229
2009                                                       210
2010                                                       208
2012                                                       206
2011                                                       201

Subtotal/Summary rows detected (keywords ('total', 'net', '%', 'percent', 'change', 'difference', 'subtotal', 'summary'))
Instances: 7535  (17.6% of all rows)
total                                                     1147
net sales                                                  229
net income                                                 118
net cash provided by operating activities                  117
total net revenues                                          78
total operating expenses                                    75
total contractual obligations                               67
total debt                                                  61
net earnings ( loss )                                       58
total minimum lease payments                                57

===== TEST SPLIT : ROW HEADER ANALYSIS =====
Row instances              : 6159
Unique raw headers         : 833
Unique normalized headers  : 832

Raw header  ‚ûú  Normalized header (top 10 by freq)
total                                                   ‚ûú total
s&amp;p 500 index                                           ‚ûú s&amp;p 500 index
cadence design systems inc .                            ‚ûú cadence design systems inc .
nasdaq composite                                        ‚ûú nasdaq composite
other                                                   ‚ûú other
s&amp;p 500                                                 ‚ûú s&amp;p 500
2011                                                    ‚ûú 2011
operating income                                        ‚ûú operating income
2012                                                    ‚ûú 2012
s&amp;p retail index                                        ‚ûú s&amp;p retail index

Top-10 most frequent financial metrics (normalized)
total                                                      183
s&amp;p 500 index                                              120
cadence design systems inc .                                72
nasdaq composite                                            72
other                                                       60
s&amp;p 500                                                     42
2011                                                        40
operating income                                            39
2012                                                        38
s&amp;p retail index                                            36

Subtotal/Summary rows detected (keywords ('total', 'net', '%', 'percent', 'change', 'difference', 'subtotal', 'summary'))
Instances: 1218  (19.8% of all rows)
total                                                      183
net cash provided by operating activities                   28
1.375% ( 1.375 % ) notes due 2015                           24
6.25% ( 6.25 % ) notes due 2017                             24
5.00% ( 5.00 % ) notes due 2019                             24
4.25% ( 4.25 % ) notes due 2021                             24
3.375% ( 3.375 % ) notes due 2022                           24
total long-term borrowings                                  24
total contractual obligations                               24
net income                                                  21</code></pre>
</div>
</div>
<p>We see some similar patterns in the row headers across the splits, but nothing of significance.</p>
<div id="cell-48" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _yield_cells(x):</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">dict</span>):</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v <span class="kw">in</span> x.values():</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> <span class="cf">from</span> _yield_cells(v)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(x, (<span class="bu">list</span>, <span class="bu">tuple</span>)):</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v <span class="kw">in</span> x:</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> <span class="cf">from</span> _yield_cells(v)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> x</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _parse_num(tok):</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(tok).strip()</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> s <span class="kw">or</span> s.lower() <span class="kw">in</span> (<span class="st">"na"</span>, <span class="st">"n/a"</span>, <span class="st">"nan"</span>, <span class="st">"-"</span>):</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    neg <span class="op">=</span> (s.startswith(<span class="st">"("</span>) <span class="kw">and</span> s.endswith(<span class="st">")"</span>)) <span class="kw">or</span> s.endswith(<span class="st">"-"</span>)</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> s.strip(<span class="st">"()"</span>).rstrip(<span class="st">"-"</span>)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"[,\$%]"</span>, <span class="st">""</span>, s)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    mult <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> s.lower().endswith(<span class="st">"m"</span>):</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>        mult, s <span class="op">=</span> <span class="fl">1e6</span>, s[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> s.lower().endswith(<span class="st">"k"</span>):</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>        mult, s <span class="op">=</span> <span class="fl">1e3</span>, s[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> <span class="bu">float</span>(s) <span class="op">*</span> mult</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>val <span class="cf">if</span> neg <span class="cf">else</span> val</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_cell_values(df, split_name, top_n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> num <span class="op">=</span> missing <span class="op">=</span> unp <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>    unpatt <span class="op">=</span> Counter()</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tbl <span class="kw">in</span> df[<span class="st">"doc_table"</span>]:</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(tbl, <span class="bu">dict</span>):</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cell <span class="kw">in</span> _yield_cells(tbl):</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>            txt <span class="op">=</span> <span class="bu">str</span>(cell).strip()</span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> cell <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> txt <span class="op">==</span> <span class="st">""</span>:</span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>                missing <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> _parse_num(cell) <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>                unp <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>                key <span class="op">=</span> txt.lower()[:<span class="dv">25</span>]</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>                unpatt[key] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>                num <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">=== </span><span class="sc">{</span>split_name<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> CELL QUALITY ==="</span>)</span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"total: </span><span class="sc">{</span>total<span class="sc">}</span><span class="ss">, numeric: </span><span class="sc">{</span>num<span class="sc">}</span><span class="ss">, missing: </span><span class="sc">{</span>missing<span class="sc">}</span><span class="ss">, unparseable: </span><span class="sc">{</span>unp<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Top </span><span class="sc">{</span>top_n<span class="sc">}</span><span class="ss"> unparseable patterns:"</span>)</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pat, cnt <span class="kw">in</span> unpatt.most_common(top_n):</span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>pat<span class="sc">:25}</span><span class="ss"> </span><span class="sc">{</span>cnt<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, d <span class="kw">in</span> ((<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)):</span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>    analyze_cell_values(d, name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== TRAIN CELL QUALITY ===
total: 42813, numeric: 41499, missing: 184, unparseable: 1130
Top 10 unparseable patterns:
  -                         265
  n/a                       147
  ( in thousands )          102
  nm                        62
  owned                     43
  $ -                       42
  pay                       22
  fta                       20
  cash                      16
  leased                    14

=== TEST CELL QUALITY ===
total: 6159, numeric: 6045, missing: 12, unparseable: 102
Top 10 unparseable patterns:
  -                         13
  none                      9
  high                      6
  low                       6
  ( b )                     6
  leased                    6
  united states             4
  united kingdom            4
  ( d )                     3
  nm                        3</code></pre>
</div>
</div>
<p>We see that:</p>
<ul>
<li><strong>Train</strong> (42,813 total cells): 97.0% numeric, 0.4% missing, 2.6% unparseable<br>
</li>
<li><strong>Test</strong> (6,159 total cells): 98.2% numeric, 0.2% missing, 1.7% unparseable</li>
</ul>
<p>Top unparseable patterns include <code>-</code>, <code>n/a</code>, <code>( in thousands )</code>, <code>nm</code>, <code>none</code>, <code>high</code>, <code>low</code>, etc., indicating placeholders, qualifiers, and unit headers that need cleaning or custom parsing.</p>
<p>When selecting records for evaluation, we should:</p>
<ul>
<li>Exclude or preprocess records with unparseable cells (~1,232 cells total).<br>
</li>
<li>Drop tables where &gt;5% of cells are unparseable to ensure numeric consistency.</li>
</ul>
<p>This keeps our evaluation set focused on clean, numeric data and avoids noise from poorly parsed entries. More on this later!</p>
<div id="cell-50" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
</section>
<section id="dialogue_conv_questions" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_conv_questions"><code>dialogue_conv_questions</code></h2>
<div id="cell-52" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>train_q_lens <span class="op">=</span> train_flat_df[<span class="st">"dialogue_conv_questions"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>test_q_lens <span class="op">=</span> test_flat_df[<span class="st">"dialogue_conv_questions"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>df_q <span class="op">=</span> pd.concat(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: train_q_lens, <span class="st">"split"</span>: <span class="st">"train"</span>}),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: test_q_lens, <span class="st">"split"</span>: <span class="st">"test"</span>}),</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_q, x<span class="op">=</span><span class="st">"length"</span>, hue<span class="op">=</span><span class="st">"split"</span>, stat<span class="op">=</span><span class="st">"density"</span>, element<span class="op">=</span><span class="st">"step"</span>, fill<span class="op">=</span><span class="va">False</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Dialogue Question Lengths by Split"</span>)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Question Length (characters)"</span>)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Density"</span>)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-30-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Majority of the questions in both the train and test set are short. This is ideal.</p>
</section>
<section id="dialogue_conv_answers" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_conv_answers"><code>dialogue_conv_answers</code></h2>
<div id="cell-55" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>train_q_lens <span class="op">=</span> train_flat_df[<span class="st">"dialogue_conv_answers"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>test_q_lens <span class="op">=</span> test_flat_df[<span class="st">"dialogue_conv_answers"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>df_q <span class="op">=</span> pd.concat(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: train_q_lens, <span class="st">"split"</span>: <span class="st">"train"</span>}),</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: test_q_lens, <span class="st">"split"</span>: <span class="st">"test"</span>}),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_q, x<span class="op">=</span><span class="st">"length"</span>, hue<span class="op">=</span><span class="st">"split"</span>, stat<span class="op">=</span><span class="st">"density"</span>, element<span class="op">=</span><span class="st">"step"</span>, fill<span class="op">=</span><span class="va">False</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Dialogue Answer Lengths by Split"</span>)</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Answer Length (characters)"</span>)</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Density"</span>)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-31-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>As mentioned in the dataset, most of the answers are either numeric or boolean in nature. We see a majority of the answers having length &lt;= 8, meaning that these are either large numbers, or numbers with large precision.</p>
</section>
<section id="dialogue_turn_program" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_turn_program"><code>dialogue_turn_program</code></h2>
<p>This field represents the program DSL generated for the current turn.</p>
<div id="cell-59" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"dialogue_turn_program"</span>].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>0    [206588, 181001, subtract(206588, 181001), sub...
1    [9362.2, 9244.9, subtract(9362.2, 9244.9), sub...
2    [5363, 7983, subtract(5363, 7983), subtract(53...
3    [subtract(75.95, const_100), subtract(75.95, c...
4    [subtract(91.06, const_100), subtract(91.06, c...
Name: dialogue_turn_program, dtype: object</code></pre>
</div>
</div>
<div id="cell-60" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _get_op_counts(df: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Return a Series with the number of '(' in every element of dialogue_turn_program."""</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"dialogue_turn_program"</span>]</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        .explode()  <span class="co"># one element per row</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>        .dropna()</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> rec: <span class="bu">str</span>(rec).count(<span class="st">"("</span>))</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>counts_train <span class="op">=</span> _get_op_counts(train_flat_df)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>counts_test <span class="op">=</span> _get_op_counts(test_flat_df)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>df_counts <span class="op">=</span> pd.concat(</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"ops"</span>: counts_train, <span class="st">"split"</span>: <span class="st">"train"</span>}),</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"ops"</span>: counts_test, <span class="st">"split"</span>: <span class="st">"test"</span>}),</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_counts,</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"ops"</span>,</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"split"</span>,</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="bu">range</span>(<span class="dv">0</span>, df_counts[<span class="st">"ops"</span>].<span class="bu">max</span>() <span class="op">+</span> <span class="dv">2</span>),</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>    element<span class="op">=</span><span class="st">"step"</span>,</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Number of operations per element"</span>)</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Histogram of operation counts in turn_programs (train vs. test)"</span>)</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-33-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distributions for number of operations in both the train and test set. Majority of the operations are &lt; 4 .</p>
<p>We could argue that the number of operations is a good proxy for the complexity of the program. As such, we should probably aim to do well first on the examples where the number of operations is small.</p>
<div id="cell-62" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="features_num_dialogue_turns" class="level2">
<h2 class="anchored" data-anchor-id="features_num_dialogue_turns"><code>features_num_dialogue_turns</code></h2>
<div id="cell-64" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>order <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>(train_flat_df[<span class="st">"features_num_dialogue_turns"</span>]).union(</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>        test_flat_df[<span class="st">"features_num_dialogue_turns"</span>]</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>train_flat_df,</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    order<span class="op">=</span>order,</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].<span class="bu">set</span>(</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Train: Num Dialogue Turns"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">"Num Dialogue Turns"</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>test_flat_df,</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>    order<span class="op">=</span>order,</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"orange"</span>,</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Test: Num Dialogue Turns"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-35-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distributions across the train and test sets. As mentioned in the paper, we should expect conversations with more dialogue turns, to be more difficult to answer for models.</p>
<p>This is yet another feature we could use when deciding how to split our data into train, validation, and test sets.</p>
<div id="cell-66" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="features_has_type2_question" class="level2">
<h2 class="anchored" data-anchor-id="features_has_type2_question"><code>features_has_type2_question</code></h2>
<div id="cell-68" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> [(<span class="st">"Train"</span>, train_flat_df), (<span class="st">"Test"</span>, test_flat_df)]:</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    vc <span class="op">=</span> df[<span class="st">"features_has_type2_question"</span>].value_counts()</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> set ‚Äì Has Type 2 Question counts:</span><span class="ch">\n</span><span class="sc">{</span>vc<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_has_type2_question"</span>,</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>train_flat_df,</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].<span class="bu">set</span>(</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Train: Has Type 2 Question"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">"Has Type 2 Question"</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_has_type2_question"</span>,</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>test_flat_df,</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"Oranges"</span>,</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Test: Has Type 2 Question"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train set ‚Äì Has Type 2 Question counts:
features_has_type2_question
False    2148
True      889
Name: count, dtype: int64

Test set ‚Äì Has Type 2 Question counts:
features_has_type2_question
False    300
True     121
Name: count, dtype: int64
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/zf/l4rjbhhj6xq9bfzs9cr7m5vr0000gn/T/ipykernel_98862/668524099.py:9: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.

  sns.countplot(
/var/folders/zf/l4rjbhhj6xq9bfzs9cr7m5vr0000gn/T/ipykernel_98862/668524099.py:20: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.

  sns.countplot(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-37-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-37-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distrbutions for Type2 questions across the train and test sets, as expected.</p>
</section>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<p><a id="methodology"></a></p>
<p>Given the above dataset analysis, a few things are clear:</p>
<ul>
<li>Given the recent explosion of ctx window size for language models, we should be able to build strong baselines model without any finetuning.</li>
<li>The length analysis of the different fields(pre/post text, table, questions, etc.) confirms that we will likely not need any form of retrieval to answer the questions, <strong>contradictory</strong> to the original paper.</li>
<li>There are varying levels of difficulty in the given set of questions and answer.
<ul>
<li>We ideally should leverage this to build our models in stages, such that we can track and measure accuracy and perform error analysis at each stage.</li>
</ul></li>
</ul>
<p>The current generation of language models have 3 main phases of training:</p>
<ul>
<li><strong>pre-training</strong>: large-scale self-supervised next-token prediction on massive web corpora (e.g., C4, Common Crawl) to learn general language patterns.<br>
</li>
<li><strong>mid-training</strong>: intermediate training on medium-sized, higher-quality or domain-specific data (10‚Äì300 B tokens) with curriculum learning, long-context adaptation, and synthetic/instructional examples to sharpen capabilities.<br>
</li>
<li><strong>post-training</strong>: fine-tuning or instruction-tuning on smaller, curated datasets (100 M‚Äì1 B tokens) and often RLHF to align the model to downstream tasks and human preferences.</li>
</ul>
<p>As seen with our dataset, even current language models are <strong>trained in stages</strong>, with problems that are seemingly difficult for models to understand explicitly trained in either the mid or post-training phase.</p>
<p>This methodology has roots in an reinforcement learning technique called <strong>Curriculum Learning</strong>.</p>
<section id="curriculum-learning" class="level3">
<h3 class="anchored" data-anchor-id="curriculum-learning">Curriculum Learning</h3>
<p><strong>Core Idea</strong>: Curriculum learning for LLMs involves carefully selecting and ordering training data based on difficulty, starting with simpler examples and gradually introducing more complex ones.</p>
<p><strong>Why it‚Äôs beneficial:</strong></p>
<ul>
<li>Improved Efficiency:
<ul>
<li>By starting with easier examples, LLMs can learn fundamental concepts more effectively and then build upon that knowledge.</li>
</ul></li>
<li>Better Generalization:
<ul>
<li>A well-designed curriculum can help LLMs generalize better to unseen data by exposing them to a wider range of complexities and nuances.</li>
</ul></li>
<li>Reduced Training Time:
<ul>
<li>In some cases, curriculum learning can lead to faster convergence and reduced training time.</li>
</ul></li>
</ul>
<p align="center">
<img src="./cl_dspy/curriculum_learning_data.png" width="400" height="500"> <br> <sub> Source: <a href="https://arxiv.org/pdf/2101.10382">Curriculum Learning: A Survey</a>, Soviany et al. </sub>
</p>
<p>For our dataset, given our analysis, we have the following levers to consider:</p>
<ul>
<li>Number of Turns buckets. Eg: 1‚Äì2, 3‚Äì4, 5‚Äì6, ‚â•7</li>
<li>Number of max ops bucket: Eg: 0‚Äì1, 2‚Äì3, 4+</li>
<li>Type1 vs Type2 questions</li>
<li>Context length bucket (pre_text/post_text len): ‚â§P50, P50‚ÄìP80, &gt;P80</li>
<li>Noise flags: duplicate columns / non-numeric values</li>
</ul>
<p>Given that we have limited time for the assignment, we will pick the following</p>
<ul>
<li><strong>Easy</strong>
<ul>
<li>This is the Core stage</li>
<li>We hope the model will learn how to answer questions that directly pick answers from context, perform simple operations, and can carry previous answers minimally.</li>
<li>We will use the following filters(all must hold TRUE):
<ul>
<li>max_ops_per_conversation ‚â§ 2</li>
<li>2 ‚â§ num_dialogue_turns ‚â§ 4</li>
<li>has_type2_question == False</li>
<li>doc_pre_text_len ‚â§ P50_pre</li>
<li>doc_post_text_len ‚â§ P50_post</li>
<li>total_cells ‚â§ P50_cells</li>
</ul></li>
</ul></li>
<li><strong>Medium</strong>
<ul>
<li>This stage focuses on improving the reasoning ability of the model, and it‚Äôs ability to track dependencies.</li>
<li>The hope is that this stage will help the model learn multi-op arithmetic, cross question dependencies, and variable reuse.
<ul>
<li>Filters (must satisfy both lines)
<ul>
<li>( (max_ops_per_conversation ‚àà {2,3}) OR (has_type2_question == True) )</li>
<li>3 ‚â§ num_dialogue_turns ‚â§ 6</li>
<li>doc_pre_text_len ‚â§ P90_pre</li>
<li>doc_post_text_len ‚â§ P90_post</li>
<li>total_cells ‚â§ P90_cells</li>
</ul></li>
<li>This admits many max_ops=2 dialogs but with more turns and/or Type2.</li>
</ul></li>
</ul></li>
<li><strong>Hard</strong>
<ul>
<li>This stage will aim to tackle the long-tail of difficult problems, and help introduce much needed robustness in our models.</li>
<li>Specifically, we hope that at the end of this stage, the model is good at long context answer, which requires retrieval and reasoning, extreme op depth, and poorly formatted/large tables.</li>
<li>Filters (any single trigger is enough)
<ul>
<li>Deep ops: max_ops_per_conversation ‚â• 4 OR</li>
<li>Long dialogs: features_num_dialogue_turns ‚â• 7</li>
<li>Long context: doc_pre_text_len &gt; P90_pre OR doc_post_text_len &gt; P90_post</li>
<li>Large tables: total_cells &gt; P90_cells</li>
<li>Noisy schema: has_non_numeric_values OR has_duplicate_columns with some complexity ‚Üí ~10‚Äì15%</li>
</ul></li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>To prevent overlap and duplicates, we will construct the stages in reverse order i.e - Hard first to ensure we isolate the difficult problems - Easy next to identify baseline performance - Remaining problems go into medium to help develop better reasoning and arithmetic abilities.</p>
</blockquote>
<div id="cell-74" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
<div id="cell-75" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_max_ops_per_conversation(df):</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> max_ops(turn_programs):</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># turn_programs is a list of lists (or strings), one per turn</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Each turn_program is a string or list of strings, e.g. ['subtract(206588, 181001)', ...]</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll count the number of operations per turn, then take the max</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> re</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(turn_programs, <span class="bu">list</span>):</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        op_pattern <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r"([a-zA-Z_][a-zA-Z0-9_]*\()"</span>)</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>        max_ops <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> turn <span class="kw">in</span> turn_programs:</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(turn, <span class="bu">str</span>):</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>                <span class="co"># count ops in the string</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>                ops <span class="op">=</span> <span class="bu">len</span>(op_pattern.findall(turn))</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="bu">isinstance</span>(turn, <span class="bu">list</span>):</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># count ops in all strings in the list</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>                ops <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(op_pattern.findall(<span class="bu">str</span>(x))) <span class="cf">for</span> x <span class="kw">in</span> turn)</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>                ops <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> ops <span class="op">&gt;</span> max_ops:</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>                max_ops <span class="op">=</span> ops</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> max_ops</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[<span class="st">"dialogue_turn_program"</span>].<span class="bu">apply</span>(max_ops)</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">=</span> get_max_ops_per_conversation(train_flat_df)</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">=</span> get_max_ops_per_conversation(test_flat_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-76" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables', 'max_ops_per_conversation'],
      dtype='object')</code></pre>
</div>
</div>
<div id="cell-77" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"doc_pre_text_len"</span>] <span class="op">=</span> train_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"doc_post_text_len"</span>] <span class="op">=</span> train_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"doc_pre_text_len"</span>] <span class="op">=</span> test_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"doc_post_text_len"</span>] <span class="op">=</span> test_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-78" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_ops_per_conversation"</span>,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_type2_question"</span>,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_duplicate_columns"</span>,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_non_numeric_values"</span>,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_pre_text_len"</span>,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_post_text_len"</span>,</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_rows"</span>,</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_cols"</span>,</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_cells"</span>,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>].astype(<span class="bu">int</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_ops_per_conversation</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
<th data-quarto-table-cell-role="th">doc_pre_text_len</th>
<th data-quarto-table-cell-role="th">doc_post_text_len</th>
<th data-quarto-table-cell-role="th">n_rows</th>
<th data-quarto-table-cell-role="th">n_cols</th>
<th data-quarto-table-cell-role="th">total_cells</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2.035232</td>
<td>0.292723</td>
<td>0.019756</td>
<td>3.656240</td>
<td>0.122160</td>
<td>300.901218</td>
<td>320.378005</td>
<td>2.839974</td>
<td>5.232137</td>
<td>14.097135</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>0.655179</td>
<td>0.455087</td>
<td>0.139185</td>
<td>1.319899</td>
<td>0.327524</td>
<td>239.324988</td>
<td>256.003210</td>
<td>1.513469</td>
<td>2.506996</td>
<td>10.260609</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>3.000000</td>
<td>0.000000</td>
<td>100.000000</td>
<td>102.000000</td>
<td>2.000000</td>
<td>3.000000</td>
<td>7.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>4.000000</td>
<td>0.000000</td>
<td>244.000000</td>
<td>285.000000</td>
<td>3.000000</td>
<td>5.000000</td>
<td>12.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>2.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>5.000000</td>
<td>0.000000</td>
<td>470.000000</td>
<td>498.000000</td>
<td>3.000000</td>
<td>7.000000</td>
<td>18.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>5.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>9.000000</td>
<td>1.000000</td>
<td>1132.000000</td>
<td>1489.000000</td>
<td>10.000000</td>
<td>19.000000</td>
<td>114.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-79" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>test_flat_df[</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_ops_per_conversation"</span>,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_type2_question"</span>,</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_duplicate_columns"</span>,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_non_numeric_values"</span>,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_pre_text_len"</span>,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_post_text_len"</span>,</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_rows"</span>,</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_cols"</span>,</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_cells"</span>,</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>].astype(<span class="bu">int</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_ops_per_conversation</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
<th data-quarto-table-cell-role="th">doc_pre_text_len</th>
<th data-quarto-table-cell-role="th">doc_post_text_len</th>
<th data-quarto-table-cell-role="th">n_rows</th>
<th data-quarto-table-cell-role="th">n_cols</th>
<th data-quarto-table-cell-role="th">total_cells</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2.061758</td>
<td>0.287411</td>
<td>0.040380</td>
<td>3.539192</td>
<td>0.076010</td>
<td>263.475059</td>
<td>322.712589</td>
<td>3.033254</td>
<td>5.173397</td>
<td>14.629454</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>0.658993</td>
<td>0.453093</td>
<td>0.197083</td>
<td>1.252239</td>
<td>0.265329</td>
<td>226.086872</td>
<td>252.372826</td>
<td>1.650061</td>
<td>2.206237</td>
<td>8.670173</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.000000</td>
<td>0.000000</td>
<td>3.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>2.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.000000</td>
<td>0.000000</td>
<td>74.000000</td>
<td>119.000000</td>
<td>2.000000</td>
<td>3.000000</td>
<td>8.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>4.000000</td>
<td>0.000000</td>
<td>187.000000</td>
<td>292.000000</td>
<td>3.000000</td>
<td>5.000000</td>
<td>12.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>2.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>5.000000</td>
<td>0.000000</td>
<td>406.000000</td>
<td>520.000000</td>
<td>4.000000</td>
<td>6.000000</td>
<td>18.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>5.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>8.000000</td>
<td>1.000000</td>
<td>933.000000</td>
<td>1099.000000</td>
<td>8.000000</td>
<td>14.000000</td>
<td>48.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="curriculum-design-quota-rebalancing" class="level2">
<h2 class="anchored" data-anchor-id="curriculum-design-quota-rebalancing">Curriculum Design &amp; Quota Rebalancing</h2>
<p>While our complexity classification captures overall difficulty, curriculum learning requires more nuanced sampling strategies. Simply taking the hardest examples might create an imbalanced curriculum that overrepresents certain types of complexity while ignoring others.</p>
<p>Consider two scenarios: 1. <strong>Naive sampling</strong>: We randomly sample from our ‚ÄúHard‚Äù bucket and end up with 80% long-context examples but only 5% multi-operation examples 2. <strong>Quota sampling</strong>: We ensure balanced representation across complexity dimensions</p>
<p>The second approach creates a more robust curriculum. Our hard examples should include: - <strong>Deep reasoning</strong> (4+ mathematical operations) - <strong>Long conversations</strong> (7+ dialogue turns) - <strong>Dense context</strong> (lengthy pre/post text) - <strong>Complex tables</strong> (many cells, nested structures) - <strong>Noisy data</strong> (duplicate columns, non-numeric values)</p>
<p>This ensures our model learns to handle diverse types of complexity rather than overfitting to a single difficulty dimension. The following code implements quota-based sampling to achieve this balanced representation:</p>
<div id="cell-81" class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>TARGETS <span class="op">=</span> {</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Easy"</span>: {<span class="st">"train"</span>: <span class="dv">300</span>, <span class="st">"valid"</span>: <span class="dv">70</span>, <span class="st">"test"</span>: <span class="dv">80</span>},</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Medium"</span>: {<span class="st">"train"</span>: <span class="dv">300</span>, <span class="st">"valid"</span>: <span class="dv">70</span>, <span class="st">"test"</span>: <span class="dv">80</span>},</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hard"</span>: {<span class="st">"train"</span>: <span class="dv">220</span>, <span class="st">"valid"</span>: <span class="dv">60</span>, <span class="st">"test"</span>: <span class="dv">80</span>},</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>OUTDIR <span class="op">=</span> Path(<span class="st">"splits"</span>)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>RANDOM_STATE <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>P50_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.50</span>))</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>P65_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.65</span>))</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>P80_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.80</span>))</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>P90_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.90</span>))</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>P50_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.50</span>))</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>P65_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.65</span>))</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>P80_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.80</span>))</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>P90_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.90</span>))</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>P50_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.50</span>))</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>P65_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.65</span>))</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>P80_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.80</span>))</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>P90_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.90</span>))</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"[Percentiles/train] pre P50=</span><span class="sc">{</span>P50_pre<span class="sc">}</span><span class="ss">, P65=</span><span class="sc">{</span>P65_pre<span class="sc">}</span><span class="ss">, P80=</span><span class="sc">{</span>P80_pre<span class="sc">}</span><span class="ss">, P90=</span><span class="sc">{</span>P90_pre<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"| post P50=</span><span class="sc">{</span>P50_post<span class="sc">}</span><span class="ss">, P65=</span><span class="sc">{</span>P65_post<span class="sc">}</span><span class="ss">, P80=</span><span class="sc">{</span>P80_post<span class="sc">}</span><span class="ss">, P90=</span><span class="sc">{</span>P90_post<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"| cells P50=</span><span class="sc">{</span>P50_cells<span class="sc">}</span><span class="ss">, P65=</span><span class="sc">{</span>P65_cells<span class="sc">}</span><span class="ss">, P80=</span><span class="sc">{</span>P80_cells<span class="sc">}</span><span class="ss">, P90=</span><span class="sc">{</span>P90_cells<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_stages(df: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>    mops <span class="op">=</span> df[<span class="st">"max_ops_per_conversation"</span>]</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>    turns <span class="op">=</span> df[<span class="st">"features_num_dialogue_turns"</span>]</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>    t2 <span class="op">=</span> df[<span class="st">"features_has_type2_question"</span>]</span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>    preL <span class="op">=</span> df[<span class="st">"doc_pre_text_len"</span>]</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>    postL <span class="op">=</span> df[<span class="st">"doc_post_text_len"</span>]</span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>    cells <span class="op">=</span> df[<span class="st">"total_cells"</span>]</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>    dup <span class="op">=</span> df[<span class="st">"features_has_duplicate_columns"</span>]</span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>    nonnum <span class="op">=</span> df[<span class="st">"features_has_non_numeric_values"</span>]</span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HARD (tail)</span></span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>    hard <span class="op">=</span> (</span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>        (mops <span class="op">&gt;=</span> <span class="dv">4</span>)</span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (turns <span class="op">&gt;=</span> <span class="dv">7</span>)</span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (preL <span class="op">&gt;</span> P90_pre)</span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (postL <span class="op">&gt;</span> P90_post)</span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (cells <span class="op">&gt;</span> P90_cells)</span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (dup)</span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (</span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>            nonnum</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (</span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>                (mops <span class="op">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (preL <span class="op">&gt;</span> P80_pre)</span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (postL <span class="op">&gt;</span> P80_post)</span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (cells <span class="op">&gt;</span> P80_cells)</span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># EASY (P65)</span></span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>    easy <span class="op">=</span> (<span class="op">~</span>hard) <span class="op">&amp;</span> (</span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>        (mops <span class="op">&lt;=</span> <span class="dv">2</span>)</span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (turns.between(<span class="dv">2</span>, <span class="dv">4</span>, inclusive<span class="op">=</span><span class="st">"both"</span>))</span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (<span class="op">~</span>t2)</span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (preL <span class="op">&lt;=</span> P65_pre)</span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (postL <span class="op">&lt;=</span> P65_post)</span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (cells <span class="op">&lt;=</span> P65_cells)</span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MEDIUM (middle band)</span></span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a>    medium <span class="op">=</span> (</span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a>        (<span class="op">~</span>hard)</span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (<span class="op">~</span>easy)</span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (</span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a>            ((mops.isin([<span class="dv">2</span>, <span class="dv">3</span>])) <span class="op">|</span> (t2))</span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (turns.between(<span class="dv">3</span>, <span class="dv">6</span>, inclusive<span class="op">=</span><span class="st">"both"</span>))</span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (preL <span class="op">&lt;=</span> P90_pre)</span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (postL <span class="op">&lt;=</span> P90_post)</span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (cells <span class="op">&lt;=</span> P90_cells)</span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-87"><a href="#cb70-87" aria-hidden="true" tabindex="-1"></a>    stage <span class="op">=</span> pd.Series(index<span class="op">=</span>df.index, dtype<span class="op">=</span><span class="st">"string"</span>)</span>
<span id="cb70-88"><a href="#cb70-88" aria-hidden="true" tabindex="-1"></a>    stage.loc[hard] <span class="op">=</span> <span class="st">"Hard"</span></span>
<span id="cb70-89"><a href="#cb70-89" aria-hidden="true" tabindex="-1"></a>    stage.loc[easy] <span class="op">=</span> <span class="st">"Easy"</span></span>
<span id="cb70-90"><a href="#cb70-90" aria-hidden="true" tabindex="-1"></a>    stage.loc[medium] <span class="op">=</span> <span class="st">"Medium"</span></span>
<span id="cb70-91"><a href="#cb70-91" aria-hidden="true" tabindex="-1"></a>    stage <span class="op">=</span> stage.fillna(<span class="st">"Medium"</span>)</span>
<span id="cb70-92"><a href="#cb70-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stage</span>
<span id="cb70-93"><a href="#cb70-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-94"><a href="#cb70-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-95"><a href="#cb70-95" aria-hidden="true" tabindex="-1"></a>cur_train_df <span class="op">=</span> train_flat_df.copy()</span>
<span id="cb70-96"><a href="#cb70-96" aria-hidden="true" tabindex="-1"></a>cur_test_df <span class="op">=</span> test_flat_df.copy()</span>
<span id="cb70-97"><a href="#cb70-97" aria-hidden="true" tabindex="-1"></a>cur_train_df[<span class="st">"stage"</span>] <span class="op">=</span> assign_stages(cur_train_df)</span>
<span id="cb70-98"><a href="#cb70-98" aria-hidden="true" tabindex="-1"></a>cur_test_df[<span class="st">"stage"</span>] <span class="op">=</span> assign_stages(cur_test_df)</span>
<span id="cb70-99"><a href="#cb70-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-100"><a href="#cb70-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"[Stage counts] TRAIN:"</span>, cur_train_df[<span class="st">"stage"</span>].value_counts().to_dict())</span>
<span id="cb70-101"><a href="#cb70-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"[Stage counts] TEST:  "</span>, cur_test_df[<span class="st">"stage"</span>].value_counts().to_dict())</span>
<span id="cb70-102"><a href="#cb70-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-103"><a href="#cb70-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-104"><a href="#cb70-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_df(df: pd.DataFrame, n: <span class="bu">int</span>, seed: <span class="bu">int</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb70-105"><a href="#cb70-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> df.empty:</span>
<span id="cb70-106"><a href="#cb70-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df.iloc[<span class="dv">0</span>:<span class="dv">0</span>]</span>
<span id="cb70-107"><a href="#cb70-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">&lt;=</span> n:</span>
<span id="cb70-108"><a href="#cb70-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df.sample(frac<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span>seed)  <span class="co"># shuffle full pool if small</span></span>
<span id="cb70-109"><a href="#cb70-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.sample(n<span class="op">=</span>n, random_state<span class="op">=</span>seed)</span>
<span id="cb70-110"><a href="#cb70-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-111"><a href="#cb70-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-112"><a href="#cb70-112" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================</span></span>
<span id="cb70-113"><a href="#cb70-113" aria-hidden="true" tabindex="-1"></a><span class="co"># HARD QUOTA REBALANCING</span></span>
<span id="cb70-114"><a href="#cb70-114" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================</span></span>
<span id="cb70-115"><a href="#cb70-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-116"><a href="#cb70-116" aria-hidden="true" tabindex="-1"></a>HARD_PROPS <span class="op">=</span> {</span>
<span id="cb70-117"><a href="#cb70-117" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep_ops"</span>: <span class="fl">0.23</span>,  <span class="co"># max_ops &gt;= 4</span></span>
<span id="cb70-118"><a href="#cb70-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"long_turns"</span>: <span class="fl">0.23</span>,  <span class="co"># turns &gt;= 7</span></span>
<span id="cb70-119"><a href="#cb70-119" aria-hidden="true" tabindex="-1"></a>    <span class="st">"long_ctx"</span>: <span class="fl">0.27</span>,  <span class="co"># pre &gt; P90_pre OR post &gt; P90_post</span></span>
<span id="cb70-120"><a href="#cb70-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">"big_table"</span>: <span class="fl">0.20</span>,  <span class="co"># total_cells &gt; P90_cells</span></span>
<span id="cb70-121"><a href="#cb70-121" aria-hidden="true" tabindex="-1"></a>    <span class="st">"noisy"</span>: <span class="fl">0.07</span>,  <span class="co"># duplicate OR non-numeric (with complexity already in stage)</span></span>
<span id="cb70-122"><a href="#cb70-122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-123"><a href="#cb70-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-124"><a href="#cb70-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-125"><a href="#cb70-125" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hard_bucket_masks(df: pd.DataFrame):</span>
<span id="cb70-126"><a href="#cb70-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb70-127"><a href="#cb70-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deep_ops"</span>: (df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">&gt;=</span> <span class="dv">4</span>),</span>
<span id="cb70-128"><a href="#cb70-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_turns"</span>: (df[<span class="st">"features_num_dialogue_turns"</span>] <span class="op">&gt;=</span> <span class="dv">7</span>),</span>
<span id="cb70-129"><a href="#cb70-129" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_ctx"</span>: (df[<span class="st">"doc_pre_text_len"</span>] <span class="op">&gt;</span> P90_pre)</span>
<span id="cb70-130"><a href="#cb70-130" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (df[<span class="st">"doc_post_text_len"</span>] <span class="op">&gt;</span> P90_post),</span>
<span id="cb70-131"><a href="#cb70-131" aria-hidden="true" tabindex="-1"></a>        <span class="st">"big_table"</span>: (df[<span class="st">"total_cells"</span>] <span class="op">&gt;</span> P90_cells),</span>
<span id="cb70-132"><a href="#cb70-132" aria-hidden="true" tabindex="-1"></a>        <span class="st">"noisy"</span>: (df[<span class="st">"features_has_duplicate_columns"</span>])</span>
<span id="cb70-133"><a href="#cb70-133" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (df[<span class="st">"features_has_non_numeric_values"</span>]),</span>
<span id="cb70-134"><a href="#cb70-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-135"><a href="#cb70-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-136"><a href="#cb70-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-137"><a href="#cb70-137" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quota_sample_df(</span>
<span id="cb70-138"><a href="#cb70-138" aria-hidden="true" tabindex="-1"></a>    pool: pd.DataFrame, total_n: <span class="bu">int</span>, masks: <span class="bu">dict</span>, props: <span class="bu">dict</span>, seed: <span class="bu">int</span></span>
<span id="cb70-139"><a href="#cb70-139" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb70-140"><a href="#cb70-140" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb70-141"><a href="#cb70-141" aria-hidden="true" tabindex="-1"></a><span class="co">    Quota-based sampling without replacement across overlapping buckets.</span></span>
<span id="cb70-142"><a href="#cb70-142" aria-hidden="true" tabindex="-1"></a><span class="co">    - masks: dict[name] -&gt; boolean Series over pool</span></span>
<span id="cb70-143"><a href="#cb70-143" aria-hidden="true" tabindex="-1"></a><span class="co">    - props: dict[name] -&gt; proportion (0..1)</span></span>
<span id="cb70-144"><a href="#cb70-144" aria-hidden="true" tabindex="-1"></a><span class="co">    Strategy:</span></span>
<span id="cb70-145"><a href="#cb70-145" aria-hidden="true" tabindex="-1"></a><span class="co">      1) compute desired counts per bucket by props * total_n</span></span>
<span id="cb70-146"><a href="#cb70-146" aria-hidden="true" tabindex="-1"></a><span class="co">      2) iterate buckets in fixed priority, sample from items not yet taken</span></span>
<span id="cb70-147"><a href="#cb70-147" aria-hidden="true" tabindex="-1"></a><span class="co">      3) cap each bucket by its availability</span></span>
<span id="cb70-148"><a href="#cb70-148" aria-hidden="true" tabindex="-1"></a><span class="co">      4) top up remaining slots uniformly at random from leftover pool</span></span>
<span id="cb70-149"><a href="#cb70-149" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb70-150"><a href="#cb70-150" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb70-151"><a href="#cb70-151" aria-hidden="true" tabindex="-1"></a>    pool <span class="op">=</span> pool.copy()</span>
<span id="cb70-152"><a href="#cb70-152" aria-hidden="true" tabindex="-1"></a>    taken_idx <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb70-153"><a href="#cb70-153" aria-hidden="true" tabindex="-1"></a>    out_parts <span class="op">=</span> []</span>
<span id="cb70-154"><a href="#cb70-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-155"><a href="#cb70-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># emphasize "deep_ops" and "long_turns"/"long_ctx" first</span></span>
<span id="cb70-156"><a href="#cb70-156" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> [<span class="st">"deep_ops"</span>, <span class="st">"long_turns"</span>, <span class="st">"long_ctx"</span>, <span class="st">"big_table"</span>, <span class="st">"noisy"</span>]</span>
<span id="cb70-157"><a href="#cb70-157" aria-hidden="true" tabindex="-1"></a>    desired <span class="op">=</span> {k: <span class="bu">int</span>(<span class="bu">round</span>(total_n <span class="op">*</span> props.get(k, <span class="fl">0.0</span>))) <span class="cf">for</span> k <span class="kw">in</span> order}</span>
<span id="cb70-158"><a href="#cb70-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adjust rounding to not exceed total_n</span></span>
<span id="cb70-159"><a href="#cb70-159" aria-hidden="true" tabindex="-1"></a>    diff <span class="op">=</span> total_n <span class="op">-</span> <span class="bu">sum</span>(desired.values())</span>
<span id="cb70-160"><a href="#cb70-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> diff <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb70-161"><a href="#cb70-161" aria-hidden="true" tabindex="-1"></a>        <span class="co"># distribute remainder by descending props</span></span>
<span id="cb70-162"><a href="#cb70-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">sorted</span>(order, key<span class="op">=</span><span class="kw">lambda</span> x: props.get(x, <span class="dv">0</span>), reverse<span class="op">=</span>(diff <span class="op">&gt;</span> <span class="dv">0</span>)):</span>
<span id="cb70-163"><a href="#cb70-163" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> diff <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb70-164"><a href="#cb70-164" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb70-165"><a href="#cb70-165" aria-hidden="true" tabindex="-1"></a>            desired[k] <span class="op">+=</span> <span class="dv">1</span> <span class="cf">if</span> diff <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb70-166"><a href="#cb70-166" aria-hidden="true" tabindex="-1"></a>            diff <span class="op">+=</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">if</span> diff <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb70-167"><a href="#cb70-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-168"><a href="#cb70-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> order:</span>
<span id="cb70-169"><a href="#cb70-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> desired[k] <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb70-170"><a href="#cb70-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb70-171"><a href="#cb70-171" aria-hidden="true" tabindex="-1"></a>        bucket_idx <span class="op">=</span> pool.index[masks[k]]</span>
<span id="cb70-172"><a href="#cb70-172" aria-hidden="true" tabindex="-1"></a>        <span class="co"># remove already taken</span></span>
<span id="cb70-173"><a href="#cb70-173" aria-hidden="true" tabindex="-1"></a>        bucket_idx <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> bucket_idx <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> taken_idx]</span>
<span id="cb70-174"><a href="#cb70-174" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> bucket_idx:</span>
<span id="cb70-175"><a href="#cb70-175" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb70-176"><a href="#cb70-176" aria-hidden="true" tabindex="-1"></a>        take_k <span class="op">=</span> <span class="bu">min</span>(desired[k], <span class="bu">len</span>(bucket_idx))</span>
<span id="cb70-177"><a href="#cb70-177" aria-hidden="true" tabindex="-1"></a>        choose <span class="op">=</span> <span class="bu">list</span>(rng.choice(bucket_idx, size<span class="op">=</span>take_k, replace<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb70-178"><a href="#cb70-178" aria-hidden="true" tabindex="-1"></a>        out_parts.append(pool.loc[choose])</span>
<span id="cb70-179"><a href="#cb70-179" aria-hidden="true" tabindex="-1"></a>        taken_idx.update(choose)</span>
<span id="cb70-180"><a href="#cb70-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-181"><a href="#cb70-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># top-up if needed</span></span>
<span id="cb70-182"><a href="#cb70-182" aria-hidden="true" tabindex="-1"></a>    taken_cnt <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(p) <span class="cf">for</span> p <span class="kw">in</span> out_parts)</span>
<span id="cb70-183"><a href="#cb70-183" aria-hidden="true" tabindex="-1"></a>    need <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, total_n <span class="op">-</span> taken_cnt)</span>
<span id="cb70-184"><a href="#cb70-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> need <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb70-185"><a href="#cb70-185" aria-hidden="true" tabindex="-1"></a>        leftover_idx <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> pool.index <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> taken_idx]</span>
<span id="cb70-186"><a href="#cb70-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> leftover_idx:</span>
<span id="cb70-187"><a href="#cb70-187" aria-hidden="true" tabindex="-1"></a>            k <span class="op">=</span> <span class="bu">min</span>(need, <span class="bu">len</span>(leftover_idx))</span>
<span id="cb70-188"><a href="#cb70-188" aria-hidden="true" tabindex="-1"></a>            choose <span class="op">=</span> <span class="bu">list</span>(rng.choice(leftover_idx, size<span class="op">=</span>k, replace<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb70-189"><a href="#cb70-189" aria-hidden="true" tabindex="-1"></a>            out_parts.append(pool.loc[choose])</span>
<span id="cb70-190"><a href="#cb70-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-191"><a href="#cb70-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> out_parts:</span>
<span id="cb70-192"><a href="#cb70-192" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> pd.concat(out_parts, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb70-193"><a href="#cb70-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb70-194"><a href="#cb70-194" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> pool.iloc[<span class="dv">0</span>:<span class="dv">0</span>]</span>
<span id="cb70-195"><a href="#cb70-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-196"><a href="#cb70-196" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out.sample(frac<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span>seed)</span>
<span id="cb70-197"><a href="#cb70-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-198"><a href="#cb70-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-199"><a href="#cb70-199" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Build splits with quota rebalance only for Hard ---</span></span>
<span id="cb70-200"><a href="#cb70-200" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> {}</span>
<span id="cb70-201"><a href="#cb70-201" aria-hidden="true" tabindex="-1"></a>OUTDIR.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-202"><a href="#cb70-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-203"><a href="#cb70-203" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, stage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"Easy"</span>, <span class="st">"Medium"</span>, <span class="st">"Hard"</span>]):</span>
<span id="cb70-204"><a href="#cb70-204" aria-hidden="true" tabindex="-1"></a>    tconf <span class="op">=</span> TARGETS[stage]</span>
<span id="cb70-205"><a href="#cb70-205" aria-hidden="true" tabindex="-1"></a>    train_pool <span class="op">=</span> cur_train_df[cur_train_df[<span class="st">"stage"</span>] <span class="op">==</span> stage]</span>
<span id="cb70-206"><a href="#cb70-206" aria-hidden="true" tabindex="-1"></a>    test_pool <span class="op">=</span> cur_test_df[cur_test_df[<span class="st">"stage"</span>] <span class="op">==</span> stage]</span>
<span id="cb70-207"><a href="#cb70-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-208"><a href="#cb70-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stage <span class="op">!=</span> <span class="st">"Hard"</span>:</span>
<span id="cb70-209"><a href="#cb70-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ---- original sampling for Easy/Medium ----</span></span>
<span id="cb70-210"><a href="#cb70-210" aria-hidden="true" tabindex="-1"></a>        tv_target <span class="op">=</span> tconf[<span class="st">"train"</span>] <span class="op">+</span> tconf[<span class="st">"valid"</span>]</span>
<span id="cb70-211"><a href="#cb70-211" aria-hidden="true" tabindex="-1"></a>        tv <span class="op">=</span> sample_df(train_pool, tv_target, seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb70-212"><a href="#cb70-212" aria-hidden="true" tabindex="-1"></a>        vsize <span class="op">=</span> <span class="bu">min</span>(tconf[<span class="st">"valid"</span>], <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">int</span>(<span class="bu">round</span>(<span class="fl">0.2</span> <span class="op">*</span> <span class="bu">len</span>(tv)))))</span>
<span id="cb70-213"><a href="#cb70-213" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> tv.iloc[:vsize]</span>
<span id="cb70-214"><a href="#cb70-214" aria-hidden="true" tabindex="-1"></a>        train <span class="op">=</span> tv.iloc[vsize : vsize <span class="op">+</span> tconf[<span class="st">"train"</span>]]</span>
<span id="cb70-215"><a href="#cb70-215" aria-hidden="true" tabindex="-1"></a>        test <span class="op">=</span> sample_df(test_pool, tconf[<span class="st">"test"</span>], seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">2</span>)</span>
<span id="cb70-216"><a href="#cb70-216" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb70-217"><a href="#cb70-217" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ---- HARD: quota-based sampling ----</span></span>
<span id="cb70-218"><a href="#cb70-218" aria-hidden="true" tabindex="-1"></a>        masks_train <span class="op">=</span> hard_bucket_masks(train_pool)</span>
<span id="cb70-219"><a href="#cb70-219" aria-hidden="true" tabindex="-1"></a>        masks_test <span class="op">=</span> hard_bucket_masks(test_pool)</span>
<span id="cb70-220"><a href="#cb70-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-221"><a href="#cb70-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># TRAIN (quota)</span></span>
<span id="cb70-222"><a href="#cb70-222" aria-hidden="true" tabindex="-1"></a>        hard_train <span class="op">=</span> quota_sample_df(</span>
<span id="cb70-223"><a href="#cb70-223" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">=</span>train_pool,</span>
<span id="cb70-224"><a href="#cb70-224" aria-hidden="true" tabindex="-1"></a>            total_n<span class="op">=</span>tconf[<span class="st">"train"</span>],</span>
<span id="cb70-225"><a href="#cb70-225" aria-hidden="true" tabindex="-1"></a>            masks<span class="op">=</span>masks_train,</span>
<span id="cb70-226"><a href="#cb70-226" aria-hidden="true" tabindex="-1"></a>            props<span class="op">=</span>HARD_PROPS,</span>
<span id="cb70-227"><a href="#cb70-227" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">11</span>,</span>
<span id="cb70-228"><a href="#cb70-228" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-229"><a href="#cb70-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-230"><a href="#cb70-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VALID (quota) from remaining train_pool</span></span>
<span id="cb70-231"><a href="#cb70-231" aria-hidden="true" tabindex="-1"></a>        remaining_train_pool <span class="op">=</span> train_pool.drop(hard_train.index)</span>
<span id="cb70-232"><a href="#cb70-232" aria-hidden="true" tabindex="-1"></a>        hard_valid <span class="op">=</span> quota_sample_df(</span>
<span id="cb70-233"><a href="#cb70-233" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">=</span>remaining_train_pool,</span>
<span id="cb70-234"><a href="#cb70-234" aria-hidden="true" tabindex="-1"></a>            total_n<span class="op">=</span>tconf[<span class="st">"valid"</span>],</span>
<span id="cb70-235"><a href="#cb70-235" aria-hidden="true" tabindex="-1"></a>            masks<span class="op">=</span>hard_bucket_masks(remaining_train_pool),</span>
<span id="cb70-236"><a href="#cb70-236" aria-hidden="true" tabindex="-1"></a>            props<span class="op">=</span>HARD_PROPS,</span>
<span id="cb70-237"><a href="#cb70-237" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">12</span>,</span>
<span id="cb70-238"><a href="#cb70-238" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-239"><a href="#cb70-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-240"><a href="#cb70-240" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TEST</span><span class="co"> (quota) from dev pool</span></span>
<span id="cb70-241"><a href="#cb70-241" aria-hidden="true" tabindex="-1"></a>        hard_test <span class="op">=</span> quota_sample_df(</span>
<span id="cb70-242"><a href="#cb70-242" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">=</span>test_pool,</span>
<span id="cb70-243"><a href="#cb70-243" aria-hidden="true" tabindex="-1"></a>            total_n<span class="op">=</span>tconf[<span class="st">"test"</span>],</span>
<span id="cb70-244"><a href="#cb70-244" aria-hidden="true" tabindex="-1"></a>            masks<span class="op">=</span>masks_test,</span>
<span id="cb70-245"><a href="#cb70-245" aria-hidden="true" tabindex="-1"></a>            props<span class="op">=</span>HARD_PROPS,</span>
<span id="cb70-246"><a href="#cb70-246" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">13</span>,</span>
<span id="cb70-247"><a href="#cb70-247" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-248"><a href="#cb70-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-249"><a href="#cb70-249" aria-hidden="true" tabindex="-1"></a>        train, valid, test <span class="op">=</span> hard_train, hard_valid, hard_test</span>
<span id="cb70-250"><a href="#cb70-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-251"><a href="#cb70-251" aria-hidden="true" tabindex="-1"></a>    splits[stage] <span class="op">=</span> {<span class="st">"train"</span>: train, <span class="st">"valid"</span>: valid, <span class="st">"test"</span>: test}</span>
<span id="cb70-252"><a href="#cb70-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-253"><a href="#cb70-253" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> split_name, df_part <span class="kw">in</span> splits[stage].items():</span>
<span id="cb70-254"><a href="#cb70-254" aria-hidden="true" tabindex="-1"></a>        outp <span class="op">=</span> OUTDIR <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>stage<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>split_name<span class="sc">}</span><span class="ss">.jsonl"</span></span>
<span id="cb70-255"><a href="#cb70-255" aria-hidden="true" tabindex="-1"></a>        df_part[[<span class="st">"id"</span>]].to_json(outp, orient<span class="op">=</span><span class="st">"records"</span>, lines<span class="op">=</span><span class="va">True</span>, force_ascii<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb70-256"><a href="#cb70-256" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"[</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">] </span><span class="sc">{</span>split_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(df_part)<span class="sc">:4d}</span><span class="ss">  -&gt; </span><span class="sc">{</span>outp<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-257"><a href="#cb70-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-258"><a href="#cb70-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-259"><a href="#cb70-259" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quick_report(df):</span>
<span id="cb70-260"><a href="#cb70-260" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb70-261"><a href="#cb70-261" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"n"</span>: <span class="dv">0</span>}</span>
<span id="cb70-262"><a href="#cb70-262" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb70-263"><a href="#cb70-263" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n"</span>: <span class="bu">len</span>(df),</span>
<span id="cb70-264"><a href="#cb70-264" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ops_max_med"</span>: <span class="bu">float</span>(df[<span class="st">"max_ops_per_conversation"</span>].median()),</span>
<span id="cb70-265"><a href="#cb70-265" aria-hidden="true" tabindex="-1"></a>        <span class="st">"turns_med"</span>: <span class="bu">float</span>(df[<span class="st">"features_num_dialogue_turns"</span>].median()),</span>
<span id="cb70-266"><a href="#cb70-266" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type2_rate"</span>: <span class="bu">float</span>(df[<span class="st">"features_has_type2_question"</span>].mean()),</span>
<span id="cb70-267"><a href="#cb70-267" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pre_P50"</span>: <span class="bu">int</span>(df[<span class="st">"doc_pre_text_len"</span>].median()),</span>
<span id="cb70-268"><a href="#cb70-268" aria-hidden="true" tabindex="-1"></a>        <span class="st">"post_P50"</span>: <span class="bu">int</span>(df[<span class="st">"doc_post_text_len"</span>].median()),</span>
<span id="cb70-269"><a href="#cb70-269" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cells_P50"</span>: <span class="bu">int</span>(df[<span class="st">"total_cells"</span>].median()),</span>
<span id="cb70-270"><a href="#cb70-270" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deep_ops_rate"</span>: <span class="bu">float</span>((df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">&gt;=</span> <span class="dv">4</span>).mean()),</span>
<span id="cb70-271"><a href="#cb70-271" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_turns_rate"</span>: <span class="bu">float</span>((df[<span class="st">"features_num_dialogue_turns"</span>] <span class="op">&gt;=</span> <span class="dv">7</span>).mean()),</span>
<span id="cb70-272"><a href="#cb70-272" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_ctx_rate"</span>: <span class="bu">float</span>(</span>
<span id="cb70-273"><a href="#cb70-273" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb70-274"><a href="#cb70-274" aria-hidden="true" tabindex="-1"></a>                (df[<span class="st">"doc_pre_text_len"</span>] <span class="op">&gt;</span> P90_pre)</span>
<span id="cb70-275"><a href="#cb70-275" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (df[<span class="st">"doc_post_text_len"</span>] <span class="op">&gt;</span> P90_post)</span>
<span id="cb70-276"><a href="#cb70-276" aria-hidden="true" tabindex="-1"></a>            ).mean()</span>
<span id="cb70-277"><a href="#cb70-277" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb70-278"><a href="#cb70-278" aria-hidden="true" tabindex="-1"></a>        <span class="st">"big_table_rate"</span>: <span class="bu">float</span>((df[<span class="st">"total_cells"</span>] <span class="op">&gt;</span> P90_cells).mean()),</span>
<span id="cb70-279"><a href="#cb70-279" aria-hidden="true" tabindex="-1"></a>        <span class="st">"noisy_rate"</span>: <span class="bu">float</span>(</span>
<span id="cb70-280"><a href="#cb70-280" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb70-281"><a href="#cb70-281" aria-hidden="true" tabindex="-1"></a>                df[<span class="st">"features_has_duplicate_columns"</span>]</span>
<span id="cb70-282"><a href="#cb70-282" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> df[<span class="st">"features_has_non_numeric_values"</span>]</span>
<span id="cb70-283"><a href="#cb70-283" aria-hidden="true" tabindex="-1"></a>            ).mean()</span>
<span id="cb70-284"><a href="#cb70-284" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb70-285"><a href="#cb70-285" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-286"><a href="#cb70-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-287"><a href="#cb70-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-288"><a href="#cb70-288" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> stage <span class="kw">in</span> [<span class="st">"Easy"</span>, <span class="st">"Medium"</span>, <span class="st">"Hard"</span>]:</span>
<span id="cb70-289"><a href="#cb70-289" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">[Sanity] </span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-290"><a href="#cb70-290" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> part, dfp <span class="kw">in</span> splits[stage].items():</span>
<span id="cb70-291"><a href="#cb70-291" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>part<span class="sc">:&gt;5s}</span><span class="ss"> -&gt;"</span>, quick_report(dfp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Through this exploratory analysis, we‚Äôve established the foundation for applying curriculum learning to financial reasoning tasks:</p>
<p><strong>Key Insights:</strong> - ConvFinQA complexity varies dramatically across multiple dimensions: reasoning depth (1-6+ operations), conversation length (2-10+ turns), context density, table size, and data quality - Simple random sampling from difficulty buckets creates imbalanced curricula that overemphasize certain complexity types - Quota-based sampling ensures balanced representation across all complexity dimensions in our training data</p>
<p><strong>What‚Äôs Next:</strong> - <strong>Modelling</strong>: We‚Äôll implement DSPy baselines across our curriculum stages, exploring different LLM models and narrowing down to the most promising models - <strong>Optimization</strong>: We‚Äôll apply DSPy‚Äôs optimization techniques with our curriculum learning strategy to achieve state-of-the-art performance</p>
<p>The curriculum learning framework is now ready ‚Äî let‚Äôs see how DSPy performs when guided by our complexity-aware training progression.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="goodhamgupta/personal_blog" data-repo-id="R_kgDOLXv-xA" data-category="General" data-category-id="DIC_kwDOLXv-xM4Cdogy" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/goodhamgupta/personal_blog/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer><script>var lightboxQuarto = GLightbox({"openEffect":"zoom","closeEffect":"zoom","descPosition":"bottom","loop":false,"selector":".lightbox"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>