<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shubham Gupta">
<meta name="dcterms.date" content="2025-08-31">
<meta name="description" content="Diving into DSPy for ConvFinQA">

<title>Shubham Gupta - Curriculum Learning with DSPy</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<script src="../site_libs/quarto-search/autocomplete-preset-algolia.umd.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "algolia": {
    "application-id": "HR1HJNZUVY",
    "search-only-api-key": "3326e8971e20d27e2dd21591d6a24656",
    "index-name": "blog_pages",
    "index-fields": {
      "href": "url",
      "section": "sec",
      "text": "body"
    },
    "analytics-events": true,
    "show-logo": false,
    "libDir": "site_libs"
  },
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"></script>


<script type="text/javascript">
var ALGOLIA_INSIGHTS_SRC = "https://cdn.jsdelivr.net/npm/search-insights/dist/search-insights.iife.min.js";
!function(e,a,t,n,s,i,c){e.AlgoliaAnalyticsObject=s,e[s]=e[s]||function(){
(e[s].queue=e[s].queue||[]).push(arguments)},i=a.createElement(t),c=a.getElementsByTagName(t)[0],
i.async=1,i.src=n,c.parentNode.insertBefore(i,c)
}(window,document,"script",ALGOLIA_INSIGHTS_SRC,"aa");
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-plugin-algolia-insights">

</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CLKTGRWBQT"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-CLKTGRWBQT', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Shubham Gupta - Curriculum Learning with DSPy">
<meta property="og:description" content="Diving into DSPy for ConvFinQA">
<meta property="og:site_name" content="Shubham Gupta">
<meta name="twitter:title" content="Shubham Gupta - Curriculum Learning with DSPy">
<meta name="twitter:description" content="Diving into DSPy for ConvFinQA">
<meta name="twitter:creator" content="@shubhamg2208">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Shubham Gupta</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/goodhamgupta"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Curriculum Learning with DSPy</h1>
                  <div>
        <div class="description">
          Diving into DSPy for ConvFinQA
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">programming</div>
                <div class="quarto-category">dspy</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Shubham Gupta </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 31, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#eda" id="toc-eda" class="nav-link" data-scroll-target="#eda">EDA</a>
  <ul class="collapse">
  <li><a href="#missing-data" id="toc-missing-data" class="nav-link" data-scroll-target="#missing-data">Missing Data</a></li>
  <li><a href="#pre-and-post-text" id="toc-pre-and-post-text" class="nav-link" data-scroll-target="#pre-and-post-text">pre and post text</a></li>
  <li><a href="#doc_table" id="toc-doc_table" class="nav-link" data-scroll-target="#doc_table"><code>doc_table</code></a>
  <ul class="collapse">
  <li><a href="#table-dimensions" id="toc-table-dimensions" class="nav-link" data-scroll-target="#table-dimensions">Table Dimensions</a></li>
  <li><a href="#column-header-analysis" id="toc-column-header-analysis" class="nav-link" data-scroll-target="#column-header-analysis">Column Header Analysis</a></li>
  <li><a href="#row-header-analysis" id="toc-row-header-analysis" class="nav-link" data-scroll-target="#row-header-analysis">Row Header Analysis</a></li>
  </ul></li>
  <li><a href="#dialogue_conv_questions" id="toc-dialogue_conv_questions" class="nav-link" data-scroll-target="#dialogue_conv_questions"><code>dialogue_conv_questions</code></a></li>
  <li><a href="#dialogue_conv_answers" id="toc-dialogue_conv_answers" class="nav-link" data-scroll-target="#dialogue_conv_answers"><code>dialogue_conv_answers</code></a></li>
  <li><a href="#dialogue_turn_program" id="toc-dialogue_turn_program" class="nav-link" data-scroll-target="#dialogue_turn_program"><code>dialogue_turn_program</code></a></li>
  <li><a href="#features_num_dialogue_turns" id="toc-features_num_dialogue_turns" class="nav-link" data-scroll-target="#features_num_dialogue_turns"><code>features_num_dialogue_turns</code></a></li>
  <li><a href="#features_has_type2_question" id="toc-features_has_type2_question" class="nav-link" data-scroll-target="#features_has_type2_question"><code>features_has_type2_question</code></a></li>
  </ul></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology</a>
  <ul class="collapse">
  <li><a href="#curriculum-learning" id="toc-curriculum-learning" class="nav-link" data-scroll-target="#curriculum-learning">Curriculum Learning</a></li>
  <li><a href="#curriculum-stages" id="toc-curriculum-stages" class="nav-link" data-scroll-target="#curriculum-stages">Curriculum Stages</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/goodhamgupta/personal_blog/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Given the dataset ConvFinQA, we will aim to explore the dataset.</p>
<p>Specifically, for the hiring task, our goals are as follows:</p>
<ul>
<li>Explore the dataset to understand the distribution of the data</li>
<li>Identify evaluation metrics that can be used to evaluate the model</li>
<li>Design a high-level flow of the implementation</li>
<li>Identify methods/models to use</li>
</ul>
<div id="cell-3" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="st">"../data/convfinqa_dataset.json"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-5" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>dict_keys(['train', 'dev'])</code></pre>
</div>
</div>
<p>The current dataset only contains the <code>train</code> and <code>dev</code> splits. For evaluation, we will likely use the <code>dev</code> split, and for training, we’ll split the <code>train</code> split into a <code>train</code> and <code>val</code> split.</p>
<div id="cell-7" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"train"</span>][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{'id': 'Single_JKHY/2009/page_28.pdf-3',
 'doc': {'pre_text': '26 | 2009 annual report in fiscal 2008 , revenues in the credit union systems and services business segment increased 14% ( 14 % ) from fiscal 2007 . all revenue components within the segment experienced growth during fiscal 2008 . license revenue generated the largest dollar growth in revenue as episys ae , our flagship core processing system aimed at larger credit unions , experienced strong sales throughout the year . support and service revenue , which is the largest component of total revenues for the credit union segment , experienced 34 percent growth in eft support and 10 percent growth in in-house support . gross profit in this business segment increased $ 9344 in fiscal 2008 compared to fiscal 2007 , due primarily to the increase in license revenue , which carries the highest margins . liquidity and capital resources we have historically generated positive cash flow from operations and have generally used funds generated from operations and short-term borrowings on our revolving credit facility to meet capital requirements . we expect this trend to continue in the future . the company 2019s cash and cash equivalents increased to $ 118251 at june 30 , 2009 from $ 65565 at june 30 , 2008 . the following table summarizes net cash from operating activities in the statement of cash flows : 2009 2008 2007 .',
  'post_text': 'year ended june 30 , cash provided by operations increased $ 25587 to $ 206588 for the fiscal year ended june 30 , 2009 as compared to $ 181001 for the fiscal year ended june 30 , 2008 . this increase is primarily attributable to a decrease in receivables compared to the same period a year ago of $ 21214 . this decrease is largely the result of fiscal 2010 annual software maintenance billings being provided to customers earlier than in the prior year , which allowed more cash to be collected before the end of the fiscal year than in previous years . further , we collected more cash overall related to revenues that will be recognized in subsequent periods in the current year than in fiscal 2008 . cash used in investing activities for the fiscal year ended june 2009 was $ 59227 and includes $ 3027 in contingent consideration paid on prior years 2019 acquisitions . cash used in investing activities for the fiscal year ended june 2008 was $ 102148 and includes payments for acquisitions of $ 48109 , plus $ 1215 in contingent consideration paid on prior years 2019 acquisitions . capital expenditures for fiscal 2009 were $ 31562 compared to $ 31105 for fiscal 2008 . cash used for software development in fiscal 2009 was $ 24684 compared to $ 23736 during the prior year . net cash used in financing activities for the current fiscal year was $ 94675 and includes the repurchase of 3106 shares of our common stock for $ 58405 , the payment of dividends of $ 26903 and $ 13489 net repayment on our revolving credit facilities . cash used in financing activities was partially offset by proceeds of $ 3773 from the exercise of stock options and the sale of common stock ( through the employee stock purchase plan ) and $ 348 excess tax benefits from stock option exercises . during fiscal 2008 , net cash used in financing activities for the fiscal year was $ 101905 and includes the repurchase of 4200 shares of our common stock for $ 100996 , the payment of dividends of $ 24683 and $ 429 net repayment on our revolving credit facilities . cash used in financing activities was partially offset by proceeds of $ 20394 from the exercise of stock options and the sale of common stock and $ 3809 excess tax benefits from stock option exercises . beginning during fiscal 2008 , us financial markets and many of the largest us financial institutions have been shaken by negative developments in the home mortgage industry and the mortgage markets , and particularly the markets for subprime mortgage-backed securities . since that time , these and other such developments have resulted in a broad , global economic downturn . while we , as is the case with most companies , have experienced the effects of this downturn , we have not experienced any significant issues with our current collection efforts , and we believe that any future impact to our liquidity will be minimized by cash generated by recurring sources of revenue and due to our access to available lines of credit. .',
  'table': {'Year ended June 30, 2009': {'net income': 103102.0,
    'non-cash expenses': 74397.0,
    'change in receivables': 21214.0,
    'change in deferred revenue': 21943.0,
    'change in other assets and liabilities': -14068.0,
    'net cash from operating activities': 206588.0},
   '2008': {'net income': 104222.0,
    'non-cash expenses': 70420.0,
    'change in receivables': -2913.0,
    'change in deferred revenue': 5100.0,
    'change in other assets and liabilities': 4172.0,
    'net cash from operating activities': 181001.0},
   '2007': {'net income': 104681.0,
    'non-cash expenses': 56348.0,
    'change in receivables': -28853.0,
    'change in deferred revenue': 24576.0,
    'change in other assets and liabilities': 17495.0,
    'net cash from operating activities': 174247.0}}},
 'dialogue': {'conv_questions': ['what is the net cash from operating activities in 2009?',
   'what about in 2008?',
   'what is the difference?',
   'what percentage change does this represent?'],
  'conv_answers': ['206588', '181001', '25587', '14.1%'],
  'turn_program': ['206588',
   '181001',
   'subtract(206588, 181001)',
   'subtract(206588, 181001), divide(#0, 181001)'],
  'executed_answers': [206588.0, 181001.0, 25587.0, 0.14136],
  'qa_split': [False, False, False, False]},
 'features': {'num_dialogue_turns': 4,
  'has_type2_question': False,
  'has_duplicate_columns': False,
  'has_non_numeric_values': False}}</code></pre>
</div>
</div>
<p>The data matches the schema given in the <code>dataset.md</code> file.</p>
<div id="cell-9" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.DataFrame(data[<span class="st">"train"</span>])</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame(data[<span class="st">"dev"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>train_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Index(['id', 'doc', 'dialogue', 'features'], dtype='object')</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>train_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3037 entries, 0 to 3036
Data columns (total 4 columns):
 #   Column    Non-Null Count  Dtype 
---  ------    --------------  ----- 
 0   id        3037 non-null   object
 1   doc       3037 non-null   object
 2   dialogue  3037 non-null   object
 3   features  3037 non-null   object
dtypes: object(4)
memory usage: 95.0+ KB</code></pre>
</div>
</div>
<div id="cell-12" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>test_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>Index(['id', 'doc', 'dialogue', 'features'], dtype='object')</code></pre>
</div>
</div>
<div id="cell-13" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>test_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 421 entries, 0 to 420
Data columns (total 4 columns):
 #   Column    Non-Null Count  Dtype 
---  ------    --------------  ----- 
 0   id        421 non-null    object
 1   doc       421 non-null    object
 2   dialogue  421 non-null    object
 3   features  421 non-null    object
dtypes: object(4)
memory usage: 13.3+ KB</code></pre>
</div>
</div>
<p>Given the schema in <code>dataset.md</code> file, we will <em>explode</em> the columns with nested features to make them easier to work with.</p>
<div id="cell-15" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>train_flat_df <span class="op">=</span> pd.concat(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        train_df.drop([<span class="st">"doc"</span>, <span class="st">"dialogue"</span>, <span class="st">"features"</span>], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"doc"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"doc_"</span>),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"dialogue"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"dialogue_"</span>),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"features"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"features_"</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>test_flat_df <span class="op">=</span> pd.concat(</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        test_df.drop([<span class="st">"doc"</span>, <span class="st">"dialogue"</span>, <span class="st">"features"</span>], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"doc"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"doc_"</span>),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"dialogue"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"dialogue_"</span>),</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"features"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"features_"</span>),</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3037 entries, 0 to 3036
Data columns (total 13 columns):
 #   Column                           Non-Null Count  Dtype 
---  ------                           --------------  ----- 
 0   id                               3037 non-null   object
 1   doc_pre_text                     3037 non-null   object
 2   doc_post_text                    3037 non-null   object
 3   doc_table                        3037 non-null   object
 4   dialogue_conv_questions          3037 non-null   object
 5   dialogue_conv_answers            3037 non-null   object
 6   dialogue_turn_program            3037 non-null   object
 7   dialogue_executed_answers        3037 non-null   object
 8   dialogue_qa_split                3037 non-null   object
 9   features_num_dialogue_turns      3037 non-null   int64 
 10  features_has_type2_question      3037 non-null   bool  
 11  features_has_duplicate_columns   3037 non-null   bool  
 12  features_has_non_numeric_values  3037 non-null   bool  
dtypes: bool(3), int64(1), object(9)
memory usage: 246.3+ KB</code></pre>
</div>
</div>
<div id="cell-17" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>test_flat_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 421 entries, 0 to 420
Data columns (total 13 columns):
 #   Column                           Non-Null Count  Dtype 
---  ------                           --------------  ----- 
 0   id                               421 non-null    object
 1   doc_pre_text                     421 non-null    object
 2   doc_post_text                    421 non-null    object
 3   doc_table                        421 non-null    object
 4   dialogue_conv_questions          421 non-null    object
 5   dialogue_conv_answers            421 non-null    object
 6   dialogue_turn_program            421 non-null    object
 7   dialogue_executed_answers        421 non-null    object
 8   dialogue_qa_split                421 non-null    object
 9   features_num_dialogue_turns      421 non-null    int64 
 10  features_has_type2_question      421 non-null    bool  
 11  features_has_duplicate_columns   421 non-null    bool  
 12  features_has_non_numeric_values  421 non-null    bool  
dtypes: bool(3), int64(1), object(9)
memory usage: 34.2+ KB</code></pre>
</div>
</div>
</section>
<section id="eda" class="level1">
<h1>EDA</h1>
<section id="missing-data" class="level3">
<h3 class="anchored" data-anchor-id="missing-data">Missing Data</h3>
<p>First, let’s check to see if there’s any missing data in any field.</p>
<div id="cell-21" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> missingno <span class="im">as</span> msno</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>msno.matrix(train_flat_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-22" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>msno.matrix(test_flat_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-15-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>No missing values in the training dataset.</p>
</section>
<section id="pre-and-post-text" class="level2">
<h2 class="anchored" data-anchor-id="pre-and-post-text">pre and post text</h2>
<p>According to the database schema:</p>
<ul>
<li>pre_text -&gt; Supporting text from the document occuring BEFORE the table content</li>
<li>post_text -&gt; Supporting text from the document occuring AFTER the table content</li>
</ul>
<div id="cell-26" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>pprint(train_flat_df[<span class="st">"doc_pre_text"</span>].head().iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('26 | 2009 annual report in fiscal 2008 , revenues in the credit union '
 'systems and services business segment increased 14% ( 14 % ) from fiscal '
 '2007 . all revenue components within the segment experienced growth during '
 'fiscal 2008 . license revenue generated the largest dollar growth in revenue '
 'as episys ae , our flagship core processing system aimed at larger credit '
 'unions , experienced strong sales throughout the year . support and service '
 'revenue , which is the largest component of total revenues for the credit '
 'union segment , experienced 34 percent growth in eft support and 10 percent '
 'growth in in-house support . gross profit in this business segment increased '
 '$ 9344 in fiscal 2008 compared to fiscal 2007 , due primarily to the '
 'increase in license revenue , which carries the highest margins . liquidity '
 'and capital resources we have historically generated positive cash flow from '
 'operations and have generally used funds generated from operations and '
 'short-term borrowings on our revolving credit facility to meet capital '
 'requirements . we expect this trend to continue in the future . the company '
 '2019s cash and cash equivalents increased to $ 118251 at june 30 , 2009 from '
 '$ 65565 at june 30 , 2008 . the following table summarizes net cash from '
 'operating activities in the statement of cash flows : 2009 2008 2007 .')</code></pre>
</div>
</div>
<div id="cell-27" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(<span class="bu">len</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>count    3037.000000
mean     1760.501811
std      1397.695620
min         1.000000
25%       568.000000
50%      1417.000000
75%      2765.000000
max      7153.000000
Name: doc_pre_text, dtype: float64</code></pre>
</div>
</div>
<div id="cell-28" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>pprint(test_flat_df[<span class="st">"doc_pre_text"</span>].head().iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('stock-based awards under the plan stock options 2013 marathon grants stock '
 'options under the 2007 plan and previously granted options under the 2003 '
 'plan . marathon 2019s stock options represent the right to purchase shares '
 'of common stock at the fair market value of the common stock on the date of '
 'grant . through 2004 , certain stock options were granted under the 2003 '
 'plan with a tandem stock appreciation right , which allows the recipient to '
 'instead elect to receive cash and/or common stock equal to the excess of the '
 'fair market value of shares of common stock , as determined in accordance '
 'with the 2003 plan , over the option price of the shares . in general , '
 'stock options granted under the 2007 plan and the 2003 plan vest ratably '
 'over a three-year period and have a maximum term of ten years from the date '
 'they are granted . stock appreciation rights 2013 prior to 2005 , marathon '
 'granted sars under the 2003 plan . no stock appreciation rights have been '
 'granted under the 2007 plan . similar to stock options , stock appreciation '
 'rights represent the right to receive a payment equal to the excess of the '
 'fair market value of shares of common stock on the date the right is '
 'exercised over the grant price . under the 2003 plan , certain sars were '
 'granted as stock-settled sars and others were granted in tandem with stock '
 'options . in general , sars granted under the 2003 plan vest ratably over a '
 'three-year period and have a maximum term of ten years from the date they '
 'are granted . stock-based performance awards 2013 prior to 2005 , marathon '
 'granted stock-based performance awards under the 2003 plan . no stock-based '
 'performance awards have been granted under the 2007 plan . beginning in 2005 '
 ', marathon discontinued granting stock-based performance awards and instead '
 'now grants cash-settled performance units to officers . all stock-based '
 'performance awards granted under the 2003 plan have either vested or been '
 'forfeited . as a result , there are no outstanding stock-based performance '
 'awards . restricted stock 2013 marathon grants restricted stock and '
 'restricted stock units under the 2007 plan and previously granted such '
 'awards under the 2003 plan . in 2005 , the compensation committee began '
 'granting time-based restricted stock to certain u.s.-based officers of '
 'marathon and its consolidated subsidiaries as part of their annual long-term '
 'incentive package . the restricted stock awards to officers vest three years '
 'from the date of grant , contingent on the recipient 2019s continued '
 'employment . marathon also grants restricted stock to certain non-officer '
 'employees and restricted stock units to certain international employees ( '
 '201crestricted stock awards 201d ) , based on their performance within '
 'certain guidelines and for retention purposes . the restricted stock awards '
 'to non-officers generally vest in one-third increments over a three-year '
 'period , contingent on the recipient 2019s continued employment . prior to '
 'vesting , all restricted stock recipients have the right to vote such stock '
 'and receive dividends thereon . the non-vested shares are not transferable '
 'and are held by marathon 2019s transfer agent . common stock units 2013 '
 'marathon maintains an equity compensation program for its non-employee '
 'directors under the 2007 plan and previously maintained such a program under '
 'the 2003 plan . all non-employee directors other than the chairman receive '
 'annual grants of common stock units , and they are required to hold those '
 'units until they leave the board of directors . when dividends are paid on '
 'marathon common stock , directors receive dividend equivalents in the form '
 'of additional common stock units . stock-based compensation expense 2013 '
 'total employee stock-based compensation expense was $ 80 million , $ 83 '
 'million and $ 111 million in 2007 , 2006 and 2005 . the total related income '
 'tax benefits were $ 29 million , $ 31 million and $ 39 million . in 2007 and '
 '2006 , cash received upon exercise of stock option awards was $ 27 million '
 'and $ 50 million . tax benefits realized for deductions during 2007 and 2006 '
 'that were in excess of the stock-based compensation expense recorded for '
 'options exercised and other stock-based awards vested during the period '
 'totaled $ 30 million and $ 36 million . cash settlements of stock option '
 'awards totaled $ 1 million and $ 3 million in 2007 and 2006 . stock option '
 'awards granted 2013 during 2007 , 2006 and 2005 , marathon granted stock '
 'option awards to both officer and non-officer employees . the weighted '
 'average grant date fair value of these awards was based on the following '
 'black-scholes assumptions: .')</code></pre>
</div>
</div>
<div id="cell-29" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(<span class="bu">len</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>count     421.000000
mean     1538.061758
std      1337.167597
min        17.000000
25%       410.000000
50%      1072.000000
75%      2347.000000
max      5639.000000
Name: doc_pre_text, dtype: float64</code></pre>
</div>
</div>
<p>Looks like the pre_text in the data has some si</p>
<div id="cell-31" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    train_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Length of doc_pre_text"</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"train_flat_df: doc_pre_text length"</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    test_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"orange"</span>,</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Length of doc_pre_text"</span>)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"test_flat_df: doc_pre_text length"</span>)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    train_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Length of doc_post_text"</span>)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"train_flat_df: doc_post_text length"</span>)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    test_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Length of doc_post_text"</span>)</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"test_flat_df: doc_post_text length"</span>)</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-20-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-20-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-20-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Looks like the train and test data have a similar distribution for doc_pre_text and doc_post_text.</p>
<p>However, we do see some extreme outliers, with the large documents have &gt; 5000 characters.</p>
<p>Most new generation LLMs do have a ctx window large enough to handle both pre text + table + post text in the same context window, and we may not need any pre-processing for fields. However, we will revisit this later.</p>
</section>
<section id="doc_table" class="level2">
<h2 class="anchored" data-anchor-id="doc_table"><code>doc_table</code></h2>
<section id="table-dimensions" class="level3">
<h3 class="anchored" data-anchor-id="table-dimensions">Table Dimensions</h3>
<div id="cell-35" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_dims(table):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute basic shape statistics for a table dict.</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">        table (dict): Mapping from row keys to dicts of column:value pairs.</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">        pd.Series: Series with n_rows, n_cols, total_cells.</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">            - n_rows: Number of rows in the table (outer dict keys)</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">            - n_cols: Number of unique columns across all rows</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">            - total_cells: Total number of (row, col) value pairs</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    n_rows <span class="op">=</span> <span class="bu">len</span>(table)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> {col <span class="cf">for</span> row <span class="kw">in</span> table.values() <span class="cf">for</span> col <span class="kw">in</span> row}</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    n_cols <span class="op">=</span> <span class="bu">len</span>(cols)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    total_cells <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(row) <span class="cf">for</span> row <span class="kw">in</span> table.values())</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series({<span class="st">"n_rows"</span>: n_rows, <span class="st">"n_cols"</span>: n_cols, <span class="st">"total_cells"</span>: total_cells})</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> (train_flat_df, test_flat_df):</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    df[[<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]] <span class="op">=</span> df[<span class="st">"doc_table"</span>].<span class="bu">apply</span>(compute_dims)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>all_dims <span class="op">=</span> pd.concat(</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>        train_flat_df[[<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]].assign(split<span class="op">=</span><span class="st">"train"</span>),</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        test_flat_df[[<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]].assign(split<span class="op">=</span><span class="st">"test"</span>),</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    ignore_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, col <span class="kw">in</span> <span class="bu">zip</span>(axes, [<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]):</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    sns.histplot(data<span class="op">=</span>all_dims, x<span class="op">=</span>col, hue<span class="op">=</span><span class="st">"split"</span>, multiple<span class="op">=</span><span class="st">"stack"</span>, bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    ax.set_title(col)</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-21-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Some key points:</p>
<ul>
<li>Most tables don’t have more than 6 rows. This is good, since it limits the amount of error that can be introduced by the model when answering a question.</li>
<li>Column distribution is a bit more extreme, especially in the training dataset.
<ul>
<li>While the training dataset has a maximum of 17 columns, most of the <code>test</code> dataset tops out at ~8-9 columns.</li>
<li>This is a good feature we could use to determine which records to use for the evaluation. More on this soon!</li>
</ul></li>
<li>Same as the number of columns, we see that the training dataset has a much wider distribution of number of cells. In the test set, the majority of records have cells &lt; 30.</li>
</ul>
<div id="cell-37" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tables with more than </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss"> columns per split:"</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> split, df <span class="kw">in</span> [(<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)]:</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> df[df[<span class="st">"n_cols"</span>] <span class="op">&gt;</span> threshold]</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(subset)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> subset.empty:</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(subset[[<span class="st">"id"</span>, <span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>]].head(), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tables with more than 10 columns per split:
  train: 100
                                id  n_rows  n_cols
16     Double_PNC/2014/page_99.pdf       2      14
37    Single_GS/2013/page_47.pdf-2       3      12
90   Single_CDW/2015/page_34.pdf-2       5      12
133   Single_CE/2014/page_90.pdf-1       1      11
137   Single_C/2009/page_195.pdf-2       3      14 

  test: 8
                                id  n_rows  n_cols
50   Single_JPM/2007/page_33.pdf-2       3      11
51   Single_GS/2017/page_143.pdf-2       2      13
109  Single_JPM/2007/page_33.pdf-1       3      11
117  Single_GS/2017/page_143.pdf-1       2      13
298  Single_MA/2008/page_126.pdf-1       1      14 
</code></pre>
</div>
</div>
<div id="cell-38" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_nested_tables(table):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Recursively count nested tables in a table dict.</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">    A nested table is any dict or list of dicts within cell values (deeper than the row level).</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _count(t, depth):</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        cnt <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(t, <span class="bu">dict</span>):</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> v <span class="kw">in</span> t.values():</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(v, <span class="bu">dict</span>):</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> depth <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>                        cnt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>                    cnt <span class="op">+=</span> _count(v, depth <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> <span class="bu">isinstance</span>(v, <span class="bu">list</span>):</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> item <span class="kw">in</span> v:</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">isinstance</span>(item, <span class="bu">dict</span>):</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> depth <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>                                cnt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>                            cnt <span class="op">+=</span> _count(item, depth <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cnt</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _count(table, <span class="dv">0</span>)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> (train_flat_df, test_flat_df):</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"nested_tables"</span>] <span class="op">=</span> df[<span class="st">"doc_table"</span>].<span class="bu">apply</span>(count_nested_tables)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Nested tables per split:"</span>)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> split, df <span class="kw">in</span> [(<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)]:</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    nt <span class="op">=</span> df[<span class="st">"nested_tables"</span>]</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">: docs w/ nested tables = </span><span class="sc">{</span>(nt <span class="op">&gt;</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span><span class="bu">len</span>(nt)<span class="sc">}</span><span class="ss">, max nested = </span><span class="sc">{</span>nt<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>nested_df <span class="op">=</span> pd.concat(</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        train_flat_df[[<span class="st">"nested_tables"</span>]].assign(split<span class="op">=</span><span class="st">"train"</span>),</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        test_flat_df[[<span class="st">"nested_tables"</span>]].assign(split<span class="op">=</span><span class="st">"test"</span>),</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>    ignore_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>nested_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nested tables per split:
  train: docs w/ nested tables = 0 / 3037, max nested = 0
  test: docs w/ nested tables = 0 / 421, max nested = 0
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3458 entries, 0 to 3457
Data columns (total 2 columns):
 #   Column         Non-Null Count  Dtype 
---  ------         --------------  ----- 
 0   nested_tables  3458 non-null   int64 
 1   split          3458 non-null   object
dtypes: int64(1), object(1)
memory usage: 54.2+ KB</code></pre>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>nested_df[nested_df[<span class="st">"nested_tables"</span>] <span class="op">&gt;=</span> <span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">nested_tables</th>
<th data-quarto-table-cell-role="th">split</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Looks like the table are not deeply nested! This is good since we don’t have to worry too much about table formatting, when sending the table as context to the LLM.</p>
<div id="cell-41" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="column-header-analysis" class="level3">
<h3 class="anchored" data-anchor-id="column-header-analysis">Column Header Analysis</h3>
<div id="cell-43" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_split(df, split_name):</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    n_docs <span class="op">=</span> <span class="bu">len</span>(df)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    dup_count <span class="op">=</span> df[<span class="st">"features_has_duplicate_columns"</span>].<span class="bu">sum</span>()</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    years_per_doc <span class="op">=</span> df[<span class="st">"doc_table"</span>].<span class="bu">apply</span>(<span class="bu">len</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    year_stats <span class="op">=</span> years_per_doc.describe().to_dict()</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    freq <span class="op">=</span> Counter()</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    doc_freq <span class="op">=</span> Counter()</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    all_headers <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tbl <span class="kw">in</span> df[<span class="st">"doc_table"</span>]:</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        hdrs_in_doc <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> year_dict <span class="kw">in</span> tbl.values():</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>            freq.update(year_dict.keys())</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>            hdrs_in_doc.update(year_dict.keys())</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        doc_freq.update(hdrs_in_doc)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        all_headers.update(hdrs_in_doc)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- </span><span class="sc">{</span>split_name<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> SPLIT ---"</span>)</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total docs: </span><span class="sc">{</span>n_docs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Docs w/ duplicate cols: </span><span class="sc">{</span>dup_count<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>dup_count <span class="op">/</span> n_docs<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Years/doc stats: </span><span class="sc">{</span>year_stats<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique headers across all docs: </span><span class="sc">{</span><span class="bu">len</span>(all_headers)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Top 10 headers by total occurrences:"</span>, freq.most_common(<span class="dv">10</span>))</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Top 10 headers by docs appeared in:"</span>, doc_freq.most_common(<span class="dv">10</span>))</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> [(<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)]:</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    analyze_split(df, name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- TRAIN SPLIT ---
Total docs: 3037
Docs w/ duplicate cols: 60 (2.0%)
Years/doc stats: {'count': 3037.0, 'mean': 2.839973658215344, 'std': 1.5134690841267935, 'min': 1.0, '25%': 2.0, '50%': 3.0, '75%': 3.0, 'max': 10.0}
Unique headers across all docs: 3948
Top 10 headers by total occurrences: [('total', 1147), ('s&amp;p 500 index', 456), ('s&amp;p 500', 419), ('other', 371), ('operating profit', 253), ('net sales', 229), ('2009', 210), ('2012', 206), ('2010', 206), ('2011', 201)]
Top 10 headers by docs appeared in: [('total', 383), ('other', 205), ('thereafter', 109), ('2012', 107), ('2011', 103), ('2013', 102), ('2010', 99), ('2009', 98), ('2014', 91), ('2018', 87)]

--- TEST SPLIT ---
Total docs: 421
Docs w/ duplicate cols: 17 (4.0%)
Years/doc stats: {'count': 421.0, 'mean': 3.0332541567695963, 'std': 1.6500609236986385, 'min': 1.0, '25%': 2.0, '50%': 3.0, '75%': 4.0, 'max': 8.0}
Unique headers across all docs: 833
Top 10 headers by total occurrences: [('total', 183), ('s&amp;p 500 index', 120), ('cadence design systems inc .', 72), ('nasdaq composite', 72), ('other', 60), ('s&amp;p 500', 42), ('2011', 40), ('operating income', 39), ('2012', 38), ('s&amp;p retail index', 36)]
Top 10 headers by docs appeared in: [('total', 54), ('other', 36), ('s&amp;p 500 index', 20), ('2014', 18), ('2015', 18), ('2012', 17), ('2010', 16), ('2011', 16), ('2007', 16), ('2017', 14)]</code></pre>
</div>
</div>
</section>
<section id="row-header-analysis" class="level3">
<h3 class="anchored" data-anchor-id="row-header-analysis">Row Header Analysis</h3>
<div id="cell-45" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_row_key(k: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Lower-case, drop punctuation, collapse spaces."""</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> k:</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> k.lower()</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> re.sub(<span class="vs">r"[_\-]"</span>, <span class="st">" "</span>, k)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> re.sub(<span class="vs">r"[()%:$,]"</span>, <span class="st">" "</span>, k)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.sub(<span class="vs">r"\s+"</span>, <span class="st">" "</span>, k).strip()</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_row_headers(df, split_name: <span class="bu">str</span>, top_n: <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span>):</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    raw_freq, norm_freq, summary_freq <span class="op">=</span> Counter(), Counter(), Counter()</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    summary_kw <span class="op">=</span> (</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total"</span>,</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"net"</span>,</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"%"</span>,</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"percent"</span>,</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"change"</span>,</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"difference"</span>,</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"subtotal"</span>,</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"summary"</span>,</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tbl <span class="kw">in</span> df[<span class="st">"doc_table"</span>]:</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(tbl, <span class="bu">dict</span>):</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> year_dict <span class="kw">in</span> tbl.values():</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(year_dict, <span class="bu">dict</span>):</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> raw <span class="kw">in</span> year_dict.keys():</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> raw <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>                raw <span class="op">=</span> <span class="bu">str</span>(raw).strip()</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>                norm <span class="op">=</span> normalize_row_key(raw)</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>                raw_freq[raw] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>                norm_freq[norm] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">any</span>(k <span class="kw">in</span> raw.lower() <span class="cf">for</span> k <span class="kw">in</span> summary_kw):</span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>                    summary_freq[raw] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>    total_rows <span class="op">=</span> <span class="bu">sum</span>(raw_freq.values())</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">===== </span><span class="sc">{</span>split_name<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> SPLIT : ROW HEADER ANALYSIS ====="</span>)</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Row instances              : </span><span class="sc">{</span>total_rows<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique raw headers         : </span><span class="sc">{</span><span class="bu">len</span>(raw_freq)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique normalized headers  : </span><span class="sc">{</span><span class="bu">len</span>(norm_freq)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Raw header  ➜  Normalized header (top 10 by freq)"</span>)</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> hdr, _ <span class="kw">in</span> raw_freq.most_common(<span class="dv">10</span>):</span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>hdr[:<span class="dv">55</span>]<span class="sc">:55}</span><span class="ss"> ➜ </span><span class="sc">{</span>normalize_row_key(hdr)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top-</span><span class="sc">{</span>top_n<span class="sc">}</span><span class="ss"> most frequent financial metrics (normalized)"</span>)</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> hdr, cnt <span class="kw">in</span> norm_freq.most_common(top_n):</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>hdr[:<span class="dv">55</span>]<span class="sc">:55}</span><span class="ss"> </span><span class="sc">{</span>cnt<span class="sc">:&gt;6}</span><span class="ss">"</span>)</span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>    tot_summary <span class="op">=</span> <span class="bu">sum</span>(summary_freq.values())</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Subtotal/Summary rows detected (keywords </span><span class="sc">{</span>summary_kw<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Instances: </span><span class="sc">{</span>tot_summary<span class="sc">}</span><span class="ss">  (</span><span class="sc">{</span>tot_summary <span class="op">/</span> total_rows<span class="sc">:.1%}</span><span class="ss"> of all rows)"</span>)</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> hdr, cnt <span class="kw">in</span> summary_freq.most_common(<span class="dv">10</span>):</span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>hdr[:<span class="dv">55</span>]<span class="sc">:55}</span><span class="ss"> </span><span class="sc">{</span>cnt<span class="sc">:&gt;6}</span><span class="ss">"</span>)</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> ((<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)):</span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>    analyze_row_headers(df, name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
===== TRAIN SPLIT : ROW HEADER ANALYSIS =====
Row instances              : 42813
Unique raw headers         : 3,948
Unique normalized headers  : 3,921

Raw header  ➜  Normalized header (top 10 by freq)
total                                                   ➜ total
s&amp;p 500 index                                           ➜ s&amp;p 500 index
s&amp;p 500                                                 ➜ s&amp;p 500
other                                                   ➜ other
operating profit                                        ➜ operating profit
net sales                                               ➜ net sales
2009                                                    ➜ 2009
2012                                                    ➜ 2012
2010                                                    ➜ 2010
2011                                                    ➜ 2011

Top-10 most frequent financial metrics (normalized)
total                                                     1147
s&amp;p 500 index                                              456
s&amp;p 500                                                    419
other                                                      371
operating profit                                           253
net sales                                                  229
2009                                                       210
2010                                                       208
2012                                                       206
2011                                                       201

Subtotal/Summary rows detected (keywords ('total', 'net', '%', 'percent', 'change', 'difference', 'subtotal', 'summary'))
Instances: 7535  (17.6% of all rows)
total                                                     1147
net sales                                                  229
net income                                                 118
net cash provided by operating activities                  117
total net revenues                                          78
total operating expenses                                    75
total contractual obligations                               67
total debt                                                  61
net earnings ( loss )                                       58
total minimum lease payments                                57

===== TEST SPLIT : ROW HEADER ANALYSIS =====
Row instances              : 6159
Unique raw headers         : 833
Unique normalized headers  : 832

Raw header  ➜  Normalized header (top 10 by freq)
total                                                   ➜ total
s&amp;p 500 index                                           ➜ s&amp;p 500 index
cadence design systems inc .                            ➜ cadence design systems inc .
nasdaq composite                                        ➜ nasdaq composite
other                                                   ➜ other
s&amp;p 500                                                 ➜ s&amp;p 500
2011                                                    ➜ 2011
operating income                                        ➜ operating income
2012                                                    ➜ 2012
s&amp;p retail index                                        ➜ s&amp;p retail index

Top-10 most frequent financial metrics (normalized)
total                                                      183
s&amp;p 500 index                                              120
cadence design systems inc .                                72
nasdaq composite                                            72
other                                                       60
s&amp;p 500                                                     42
2011                                                        40
operating income                                            39
2012                                                        38
s&amp;p retail index                                            36

Subtotal/Summary rows detected (keywords ('total', 'net', '%', 'percent', 'change', 'difference', 'subtotal', 'summary'))
Instances: 1218  (19.8% of all rows)
total                                                      183
net cash provided by operating activities                   28
1.375% ( 1.375 % ) notes due 2015                           24
6.25% ( 6.25 % ) notes due 2017                             24
5.00% ( 5.00 % ) notes due 2019                             24
4.25% ( 4.25 % ) notes due 2021                             24
3.375% ( 3.375 % ) notes due 2022                           24
total long-term borrowings                                  24
total contractual obligations                               24
net income                                                  21</code></pre>
</div>
</div>
<p>We see some similar patterns in the row headers across the splits, but nothing of significance.</p>
<div id="cell-47" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _yield_cells(x):</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">dict</span>):</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v <span class="kw">in</span> x.values():</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> <span class="cf">from</span> _yield_cells(v)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(x, (<span class="bu">list</span>, <span class="bu">tuple</span>)):</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v <span class="kw">in</span> x:</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> <span class="cf">from</span> _yield_cells(v)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> x</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _parse_num(tok):</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(tok).strip()</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> s <span class="kw">or</span> s.lower() <span class="kw">in</span> (<span class="st">"na"</span>, <span class="st">"n/a"</span>, <span class="st">"nan"</span>, <span class="st">"-"</span>):</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    neg <span class="op">=</span> (s.startswith(<span class="st">"("</span>) <span class="kw">and</span> s.endswith(<span class="st">")"</span>)) <span class="kw">or</span> s.endswith(<span class="st">"-"</span>)</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> s.strip(<span class="st">"()"</span>).rstrip(<span class="st">"-"</span>)</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"[,\$%]"</span>, <span class="st">""</span>, s)</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    mult <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> s.lower().endswith(<span class="st">"m"</span>):</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        mult, s <span class="op">=</span> <span class="fl">1e6</span>, s[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> s.lower().endswith(<span class="st">"k"</span>):</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>        mult, s <span class="op">=</span> <span class="fl">1e3</span>, s[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> <span class="bu">float</span>(s) <span class="op">*</span> mult</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>val <span class="cf">if</span> neg <span class="cf">else</span> val</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_cell_values(df, split_name, top_n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> num <span class="op">=</span> missing <span class="op">=</span> unp <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>    unpatt <span class="op">=</span> Counter()</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tbl <span class="kw">in</span> df[<span class="st">"doc_table"</span>]:</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(tbl, <span class="bu">dict</span>):</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cell <span class="kw">in</span> _yield_cells(tbl):</span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>            txt <span class="op">=</span> <span class="bu">str</span>(cell).strip()</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> cell <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> txt <span class="op">==</span> <span class="st">""</span>:</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>                missing <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> _parse_num(cell) <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>                unp <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>                key <span class="op">=</span> txt.lower()[:<span class="dv">25</span>]</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>                unpatt[key] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>                num <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">=== </span><span class="sc">{</span>split_name<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> CELL QUALITY ==="</span>)</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"total: </span><span class="sc">{</span>total<span class="sc">}</span><span class="ss">, numeric: </span><span class="sc">{</span>num<span class="sc">}</span><span class="ss">, missing: </span><span class="sc">{</span>missing<span class="sc">}</span><span class="ss">, unparseable: </span><span class="sc">{</span>unp<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Top </span><span class="sc">{</span>top_n<span class="sc">}</span><span class="ss"> unparseable patterns:"</span>)</span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pat, cnt <span class="kw">in</span> unpatt.most_common(top_n):</span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>pat<span class="sc">:25}</span><span class="ss"> </span><span class="sc">{</span>cnt<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, d <span class="kw">in</span> ((<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)):</span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>    analyze_cell_values(d, name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== TRAIN CELL QUALITY ===
total: 42813, numeric: 41499, missing: 184, unparseable: 1130
Top 10 unparseable patterns:
  -                         265
  n/a                       147
  ( in thousands )          102
  nm                        62
  owned                     43
  $ -                       42
  pay                       22
  fta                       20
  cash                      16
  leased                    14

=== TEST CELL QUALITY ===
total: 6159, numeric: 6045, missing: 12, unparseable: 102
Top 10 unparseable patterns:
  -                         13
  none                      9
  high                      6
  low                       6
  ( b )                     6
  leased                    6
  united states             4
  united kingdom            4
  ( d )                     3
  nm                        3</code></pre>
</div>
</div>
<p>We see that:</p>
<ul>
<li><strong>Train</strong> (42,813 total cells): 97.0% numeric, 0.4% missing, 2.6% unparseable<br>
</li>
<li><strong>Test</strong> (6,159 total cells): 98.2% numeric, 0.2% missing, 1.7% unparseable</li>
</ul>
<p>Top unparseable patterns include <code>-</code>, <code>n/a</code>, <code>( in thousands )</code>, <code>nm</code>, <code>none</code>, <code>high</code>, <code>low</code>, etc., indicating placeholders, qualifiers, and unit headers that need cleaning or custom parsing.</p>
<p>When selecting records for evaluation, we should:</p>
<ul>
<li>Exclude or preprocess records with unparseable cells (~1,232 cells total).<br>
</li>
<li>Drop tables where &gt;5% of cells are unparseable to ensure numeric consistency.</li>
</ul>
<p>This keeps our evaluation set focused on clean, numeric data and avoids noise from poorly parsed entries. More on this later!</p>
<div id="cell-49" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
</section>
<section id="dialogue_conv_questions" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_conv_questions"><code>dialogue_conv_questions</code></h2>
<div id="cell-51" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>train_q_lens <span class="op">=</span> train_flat_df[<span class="st">"dialogue_conv_questions"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>test_q_lens <span class="op">=</span> test_flat_df[<span class="st">"dialogue_conv_questions"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>df_q <span class="op">=</span> pd.concat(</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: train_q_lens, <span class="st">"split"</span>: <span class="st">"train"</span>}),</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: test_q_lens, <span class="st">"split"</span>: <span class="st">"test"</span>}),</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_q, x<span class="op">=</span><span class="st">"length"</span>, hue<span class="op">=</span><span class="st">"split"</span>, stat<span class="op">=</span><span class="st">"density"</span>, element<span class="op">=</span><span class="st">"step"</span>, fill<span class="op">=</span><span class="va">False</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Dialogue Question Lengths by Split"</span>)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Question Length (characters)"</span>)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Density"</span>)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-30-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Majority of the questions in both the train and test set are short. This is ideal.</p>
</section>
<section id="dialogue_conv_answers" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_conv_answers"><code>dialogue_conv_answers</code></h2>
<div id="cell-54" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>train_q_lens <span class="op">=</span> train_flat_df[<span class="st">"dialogue_conv_answers"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>test_q_lens <span class="op">=</span> test_flat_df[<span class="st">"dialogue_conv_answers"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>df_q <span class="op">=</span> pd.concat(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: train_q_lens, <span class="st">"split"</span>: <span class="st">"train"</span>}),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: test_q_lens, <span class="st">"split"</span>: <span class="st">"test"</span>}),</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_q, x<span class="op">=</span><span class="st">"length"</span>, hue<span class="op">=</span><span class="st">"split"</span>, stat<span class="op">=</span><span class="st">"density"</span>, element<span class="op">=</span><span class="st">"step"</span>, fill<span class="op">=</span><span class="va">False</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Dialogue Answer Lengths by Split"</span>)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Answer Length (characters)"</span>)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Density"</span>)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-31-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>As mentioned in the dataset, most of the answers are either numeric or boolean in nature. We see a majority of the answers having length &lt;= 8, meaning that these are either large numbers, or numbers with large precision.</p>
</section>
<section id="dialogue_turn_program" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_turn_program"><code>dialogue_turn_program</code></h2>
<p>This field represents the program DSL generated for the current turn.</p>
<div id="cell-58" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"dialogue_turn_program"</span>].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>0    [206588, 181001, subtract(206588, 181001), sub...
1    [9362.2, 9244.9, subtract(9362.2, 9244.9), sub...
2    [5363, 7983, subtract(5363, 7983), subtract(53...
3    [subtract(75.95, const_100), subtract(75.95, c...
4    [subtract(91.06, const_100), subtract(91.06, c...
Name: dialogue_turn_program, dtype: object</code></pre>
</div>
</div>
<div id="cell-59" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _get_op_counts(df: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Return a Series with the number of '(' in every element of dialogue_turn_program."""</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"dialogue_turn_program"</span>]</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        .explode()  <span class="co"># one element per row</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        .dropna()</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> rec: <span class="bu">str</span>(rec).count(<span class="st">"("</span>))</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>counts_train <span class="op">=</span> _get_op_counts(train_flat_df)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>counts_test <span class="op">=</span> _get_op_counts(test_flat_df)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>df_counts <span class="op">=</span> pd.concat(</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"ops"</span>: counts_train, <span class="st">"split"</span>: <span class="st">"train"</span>}),</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"ops"</span>: counts_test, <span class="st">"split"</span>: <span class="st">"test"</span>}),</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_counts,</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"ops"</span>,</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"split"</span>,</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="bu">range</span>(<span class="dv">0</span>, df_counts[<span class="st">"ops"</span>].<span class="bu">max</span>() <span class="op">+</span> <span class="dv">2</span>),</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    element<span class="op">=</span><span class="st">"step"</span>,</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Number of operations per element"</span>)</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Histogram of operation counts in turn_programs (train vs. test)"</span>)</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-33-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distributions for number of operations in both the train and test set. Majority of the operations are &lt; 4 .</p>
<p>We could argue that the number of operations is a good proxy for the complexity of the program. As such, we should probably aim to do well first on the examples where the number of operations is small.</p>
<div id="cell-61" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="features_num_dialogue_turns" class="level2">
<h2 class="anchored" data-anchor-id="features_num_dialogue_turns"><code>features_num_dialogue_turns</code></h2>
<div id="cell-63" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>order <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>(train_flat_df[<span class="st">"features_num_dialogue_turns"</span>]).union(</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>        test_flat_df[<span class="st">"features_num_dialogue_turns"</span>]</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>train_flat_df,</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    order<span class="op">=</span>order,</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].<span class="bu">set</span>(</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Train: Num Dialogue Turns"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">"Num Dialogue Turns"</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>test_flat_df,</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    order<span class="op">=</span>order,</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"orange"</span>,</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Test: Num Dialogue Turns"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-35-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distributions across the train and test sets. As mentioned in the paper, we should expect conversations with more dialogue turns, to be more difficult to answer for models.</p>
<p>This is yet another feature we could use when deciding how to split our data into train, validation, and test sets.</p>
<div id="cell-65" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="features_has_type2_question" class="level2">
<h2 class="anchored" data-anchor-id="features_has_type2_question"><code>features_has_type2_question</code></h2>
<div id="cell-67" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> [(<span class="st">"Train"</span>, train_flat_df), (<span class="st">"Test"</span>, test_flat_df)]:</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    vc <span class="op">=</span> df[<span class="st">"features_has_type2_question"</span>].value_counts()</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> set – Has Type 2 Question counts:</span><span class="ch">\n</span><span class="sc">{</span>vc<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_has_type2_question"</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>train_flat_df,</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].<span class="bu">set</span>(</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Train: Has Type 2 Question"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">"Has Type 2 Question"</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_has_type2_question"</span>,</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>test_flat_df,</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"Oranges"</span>,</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Test: Has Type 2 Question"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train set – Has Type 2 Question counts:
features_has_type2_question
False    2148
True      889
Name: count, dtype: int64

Test set – Has Type 2 Question counts:
features_has_type2_question
False    300
True     121
Name: count, dtype: int64
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/zf/l4rjbhhj6xq9bfzs9cr7m5vr0000gn/T/ipykernel_98862/668524099.py:9: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.

  sns.countplot(
/var/folders/zf/l4rjbhhj6xq9bfzs9cr7m5vr0000gn/T/ipykernel_98862/668524099.py:20: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.

  sns.countplot(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-37-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-37-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distrbutions for Type2 questions across the train and test sets, as expected.</p>
</section>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<p>Given the above dataset analysis, a few things are clear:</p>
<ul>
<li>Given the recent explosion of ctx window size for language models, we should be able to build strong baselines model without any finetuning.</li>
<li>The length analysis of the different fields(pre/post text, table, questions, etc.) confirms that we will likely not need any form of retrieval to answer the questions, <strong>contradictory</strong> to the original paper.</li>
<li>There are varying levels of difficulty in the given set of questions and answer.
<ul>
<li>We ideally should leverage this to build our models in stages, such that we can track and measure accuracy and perform error analysis at each stage.</li>
</ul></li>
</ul>
<p>The current generation of language models have 3 main phases of training:</p>
<ul>
<li><strong>pre-training</strong>: large-scale self-supervised next-token prediction on massive web corpora (e.g., C4, Common Crawl) to learn general language patterns.<br>
</li>
<li><strong>mid-training</strong>: intermediate training on medium-sized, higher-quality or domain-specific data (10–300 B tokens) with curriculum learning, long-context adaptation, and synthetic/instructional examples to sharpen capabilities.<br>
</li>
<li><strong>post-training</strong>: fine-tuning or instruction-tuning on smaller, curated datasets (100 M–1 B tokens) and often RLHF to align the model to downstream tasks and human preferences.</li>
</ul>
<p>As seen with our dataset, even current language models are <strong>trained in stages</strong>, with problems that are seemingly difficult for models to understand explicitly trained in either the mid or post-training phase.</p>
<p>This methodology has roots in an reinforcement learning technique called <strong>Curriculum Learning</strong>.</p>
<section id="curriculum-learning" class="level3">
<h3 class="anchored" data-anchor-id="curriculum-learning">Curriculum Learning</h3>
<p><strong>Core Idea</strong>: Curriculum learning for LLMs involves carefully selecting and ordering training data based on difficulty, starting with simpler examples and gradually introducing more complex ones.</p>
<p><strong>Why it’s beneficial:</strong></p>
<ul>
<li>Improved Efficiency:
<ul>
<li>By starting with easier examples, LLMs can learn fundamental concepts more effectively and then build upon that knowledge.</li>
</ul></li>
<li>Better Generalization:
<ul>
<li>A well-designed curriculum can help LLMs generalize better to unseen data by exposing them to a wider range of complexities and nuances.</li>
</ul></li>
<li>Reduced Training Time:
<ul>
<li>In some cases, curriculum learning can lead to faster convergence and reduced training time.</li>
</ul></li>
</ul>
<p align="center">
<img src="./cl_dspy/curriculum_learning_data.png" width="400" height="500"> <br> <sub> Source: <a href="https://arxiv.org/pdf/2101.10382">Curriculum Learning: A Survey</a>, Soviany et al. </sub>
</p>
<p>For our dataset, given our analysis, we have the following levers to consider:</p>
<ul>
<li>Number of Turns buckets. Eg: 1–2, 3–4, 5–6, ≥7</li>
<li>Number of max ops bucket: Eg: 0–1, 2–3, 4+</li>
<li>Type1 vs Type2 questions</li>
<li>Context length bucket (pre_text/post_text len): ≤P50, P50–P80, &gt;P80</li>
<li>Noise flags: duplicate columns / non-numeric values</li>
</ul>
<p>Given that we have limited time for the assignment, we will pick the following</p>
<ul>
<li><strong>Easy</strong>
<ul>
<li>This is the Core stage</li>
<li>We hope the model will learn how to answer questions that directly pick answers from context, perform simple operations, and can carry previous answers minimally.</li>
<li>We will use the following filters(all must hold TRUE):
<ul>
<li>max_ops_per_conversation ≤ 2</li>
<li>2 ≤ num_dialogue_turns ≤ 4</li>
<li>has_type2_question == False</li>
<li>doc_pre_text_len ≤ P50_pre</li>
<li>doc_post_text_len ≤ P50_post</li>
<li>total_cells ≤ P50_cells</li>
</ul></li>
</ul></li>
<li><strong>Medium</strong>
<ul>
<li>This stage focuses on improving the reasoning ability of the model, and it’s ability to track dependencies.</li>
<li>The hope is that this stage will help the model learn multi-op arithmetic, cross question dependencies, and variable reuse.
<ul>
<li>Filters (must satisfy both lines)
<ul>
<li>( (max_ops_per_conversation ∈ {2,3}) OR (has_type2_question == True) )</li>
<li>3 ≤ num_dialogue_turns ≤ 6</li>
<li>doc_pre_text_len ≤ P90_pre</li>
<li>doc_post_text_len ≤ P90_post</li>
<li>total_cells ≤ P90_cells</li>
</ul></li>
<li>This admits many max_ops=2 dialogs but with more turns and/or Type2.</li>
</ul></li>
</ul></li>
<li><strong>Hard</strong>
<ul>
<li>This stage will aim to tackle the long-tail of difficult problems, and help introduce much needed robustness in our models.</li>
<li>Specifically, we hope that at the end of this stage, the model is good at long context answer, which requires retrieval and reasoning, extreme op depth, and poorly formatted/large tables.</li>
<li>Filters (any single trigger is enough)
<ul>
<li>Deep ops: max_ops_per_conversation ≥ 4 OR</li>
<li>Long dialogs: features_num_dialogue_turns ≥ 7</li>
<li>Long context: doc_pre_text_len &gt; P90_pre OR doc_post_text_len &gt; P90_post</li>
<li>Large tables: total_cells &gt; P90_cells</li>
<li>Noisy schema: has_non_numeric_values OR has_duplicate_columns with some complexity → ~10–15%</li>
</ul></li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>To prevent overlap and duplicates, we will construct the stages in reverse order i.e - Hard first to ensure we isolate the difficult problems - Easy next to identify baseline performance - Remaining problems go into medium to help develop better reasoning and arithmetic abilities.</p>
</blockquote>
<div id="cell-73" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
<div id="cell-74" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_max_ops_per_conversation(df):</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> max_ops(turn_programs):</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># turn_programs is a list of lists (or strings), one per turn</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Each turn_program is a string or list of strings, e.g. ['subtract(206588, 181001)', ...]</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll count the number of operations per turn, then take the max</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> re</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(turn_programs, <span class="bu">list</span>):</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>        op_pattern <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r"([a-zA-Z_][a-zA-Z0-9_]*\()"</span>)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>        max_ops <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> turn <span class="kw">in</span> turn_programs:</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(turn, <span class="bu">str</span>):</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>                <span class="co"># count ops in the string</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>                ops <span class="op">=</span> <span class="bu">len</span>(op_pattern.findall(turn))</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="bu">isinstance</span>(turn, <span class="bu">list</span>):</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># count ops in all strings in the list</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>                ops <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(op_pattern.findall(<span class="bu">str</span>(x))) <span class="cf">for</span> x <span class="kw">in</span> turn)</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>                ops <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> ops <span class="op">&gt;</span> max_ops:</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>                max_ops <span class="op">=</span> ops</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> max_ops</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[<span class="st">"dialogue_turn_program"</span>].<span class="bu">apply</span>(max_ops)</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">=</span> get_max_ops_per_conversation(train_flat_df)</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">=</span> get_max_ops_per_conversation(test_flat_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-75" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables', 'max_ops_per_conversation'],
      dtype='object')</code></pre>
</div>
</div>
<div id="cell-76" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"doc_pre_text_len"</span>] <span class="op">=</span> train_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"doc_post_text_len"</span>] <span class="op">=</span> train_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"doc_pre_text_len"</span>] <span class="op">=</span> test_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"doc_post_text_len"</span>] <span class="op">=</span> test_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-77" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_ops_per_conversation"</span>,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_type2_question"</span>,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_duplicate_columns"</span>,</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_non_numeric_values"</span>,</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_pre_text_len"</span>,</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_post_text_len"</span>,</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_rows"</span>,</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_cols"</span>,</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_cells"</span>,</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>].astype(<span class="bu">int</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_ops_per_conversation</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
<th data-quarto-table-cell-role="th">doc_pre_text_len</th>
<th data-quarto-table-cell-role="th">doc_post_text_len</th>
<th data-quarto-table-cell-role="th">n_rows</th>
<th data-quarto-table-cell-role="th">n_cols</th>
<th data-quarto-table-cell-role="th">total_cells</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2.035232</td>
<td>0.292723</td>
<td>0.019756</td>
<td>3.656240</td>
<td>0.122160</td>
<td>300.901218</td>
<td>320.378005</td>
<td>2.839974</td>
<td>5.232137</td>
<td>14.097135</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>0.655179</td>
<td>0.455087</td>
<td>0.139185</td>
<td>1.319899</td>
<td>0.327524</td>
<td>239.324988</td>
<td>256.003210</td>
<td>1.513469</td>
<td>2.506996</td>
<td>10.260609</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>3.000000</td>
<td>0.000000</td>
<td>100.000000</td>
<td>102.000000</td>
<td>2.000000</td>
<td>3.000000</td>
<td>7.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>4.000000</td>
<td>0.000000</td>
<td>244.000000</td>
<td>285.000000</td>
<td>3.000000</td>
<td>5.000000</td>
<td>12.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>2.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>5.000000</td>
<td>0.000000</td>
<td>470.000000</td>
<td>498.000000</td>
<td>3.000000</td>
<td>7.000000</td>
<td>18.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>5.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>9.000000</td>
<td>1.000000</td>
<td>1132.000000</td>
<td>1489.000000</td>
<td>10.000000</td>
<td>19.000000</td>
<td>114.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-78" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>test_flat_df[</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_ops_per_conversation"</span>,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_type2_question"</span>,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_duplicate_columns"</span>,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_non_numeric_values"</span>,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_pre_text_len"</span>,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_post_text_len"</span>,</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_rows"</span>,</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_cols"</span>,</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_cells"</span>,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>].astype(<span class="bu">int</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_ops_per_conversation</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
<th data-quarto-table-cell-role="th">doc_pre_text_len</th>
<th data-quarto-table-cell-role="th">doc_post_text_len</th>
<th data-quarto-table-cell-role="th">n_rows</th>
<th data-quarto-table-cell-role="th">n_cols</th>
<th data-quarto-table-cell-role="th">total_cells</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2.061758</td>
<td>0.287411</td>
<td>0.040380</td>
<td>3.539192</td>
<td>0.076010</td>
<td>263.475059</td>
<td>322.712589</td>
<td>3.033254</td>
<td>5.173397</td>
<td>14.629454</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>0.658993</td>
<td>0.453093</td>
<td>0.197083</td>
<td>1.252239</td>
<td>0.265329</td>
<td>226.086872</td>
<td>252.372826</td>
<td>1.650061</td>
<td>2.206237</td>
<td>8.670173</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.000000</td>
<td>0.000000</td>
<td>3.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>2.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.000000</td>
<td>0.000000</td>
<td>74.000000</td>
<td>119.000000</td>
<td>2.000000</td>
<td>3.000000</td>
<td>8.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>4.000000</td>
<td>0.000000</td>
<td>187.000000</td>
<td>292.000000</td>
<td>3.000000</td>
<td>5.000000</td>
<td>12.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>2.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>5.000000</td>
<td>0.000000</td>
<td>406.000000</td>
<td>520.000000</td>
<td>4.000000</td>
<td>6.000000</td>
<td>18.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>5.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>8.000000</td>
<td>1.000000</td>
<td>933.000000</td>
<td>1099.000000</td>
<td>8.000000</td>
<td>14.000000</td>
<td>48.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="curriculum-stages" class="level2">
<h2 class="anchored" data-anchor-id="curriculum-stages">Curriculum Stages</h2>
<div id="cell-80" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>TARGETS <span class="op">=</span> {</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Easy"</span>: {<span class="st">"train"</span>: <span class="dv">300</span>, <span class="st">"valid"</span>: <span class="dv">70</span>, <span class="st">"test"</span>: <span class="dv">80</span>},</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Medium"</span>: {<span class="st">"train"</span>: <span class="dv">300</span>, <span class="st">"valid"</span>: <span class="dv">70</span>, <span class="st">"test"</span>: <span class="dv">80</span>},</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hard"</span>: {<span class="st">"train"</span>: <span class="dv">220</span>, <span class="st">"valid"</span>: <span class="dv">60</span>, <span class="st">"test"</span>: <span class="dv">80</span>},</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>OUTDIR <span class="op">=</span> Path(<span class="st">"splits"</span>)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>RANDOM_STATE <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Expect: train_flat_df, test_flat_df already loaded with columns:</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ['id','doc_pre_text','doc_post_text','doc_table','dialogue_conv_questions',</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a><span class="co">#  'dialogue_conv_answers','dialogue_turn_program','dialogue_executed_answers',</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="co">#  'dialogue_qa_split','features_num_dialogue_turns','features_has_type2_question',</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="co">#  'features_has_duplicate_columns','features_has_non_numeric_values',</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a><span class="co">#  'n_rows','n_cols','total_cells','nested_tables','max_ops_per_conversation',</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  'doc_pre_text_len','doc_post_text_len']</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a><span class="co"># --- percentiles on TRAIN only (add P65, P90) ---</span></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>P50_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.50</span>))</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>P65_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.65</span>))</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>P80_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.80</span>))</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>P90_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.90</span>))</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>P50_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.50</span>))</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>P65_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.65</span>))</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>P80_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.80</span>))</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>P90_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.90</span>))</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>P50_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.50</span>))</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>P65_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.65</span>))</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>P80_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.80</span>))</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>P90_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.90</span>))</span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"[Percentiles/train] pre P50=</span><span class="sc">{</span>P50_pre<span class="sc">}</span><span class="ss">, P65=</span><span class="sc">{</span>P65_pre<span class="sc">}</span><span class="ss">, P80=</span><span class="sc">{</span>P80_pre<span class="sc">}</span><span class="ss">, P90=</span><span class="sc">{</span>P90_pre<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"| post P50=</span><span class="sc">{</span>P50_post<span class="sc">}</span><span class="ss">, P65=</span><span class="sc">{</span>P65_post<span class="sc">}</span><span class="ss">, P80=</span><span class="sc">{</span>P80_post<span class="sc">}</span><span class="ss">, P90=</span><span class="sc">{</span>P90_post<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"| cells P50=</span><span class="sc">{</span>P50_cells<span class="sc">}</span><span class="ss">, P65=</span><span class="sc">{</span>P65_cells<span class="sc">}</span><span class="ss">, P80=</span><span class="sc">{</span>P80_cells<span class="sc">}</span><span class="ss">, P90=</span><span class="sc">{</span>P90_cells<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Stage assignment (unchanged) ---</span></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_stages(df: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a>    mops <span class="op">=</span> df[<span class="st">"max_ops_per_conversation"</span>]</span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a>    turns <span class="op">=</span> df[<span class="st">"features_num_dialogue_turns"</span>]</span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a>    t2 <span class="op">=</span> df[<span class="st">"features_has_type2_question"</span>]</span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>    preL <span class="op">=</span> df[<span class="st">"doc_pre_text_len"</span>]</span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a>    postL <span class="op">=</span> df[<span class="st">"doc_post_text_len"</span>]</span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a>    cells <span class="op">=</span> df[<span class="st">"total_cells"</span>]</span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a>    dup <span class="op">=</span> df[<span class="st">"features_has_duplicate_columns"</span>]</span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a>    nonnum <span class="op">=</span> df[<span class="st">"features_has_non_numeric_values"</span>]</span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HARD (tail)</span></span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a>    hard <span class="op">=</span> (</span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a>        (mops <span class="op">&gt;=</span> <span class="dv">4</span>)</span>
<span id="cb69-58"><a href="#cb69-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (turns <span class="op">&gt;=</span> <span class="dv">7</span>)</span>
<span id="cb69-59"><a href="#cb69-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (preL <span class="op">&gt;</span> P90_pre)</span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (postL <span class="op">&gt;</span> P90_post)</span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (cells <span class="op">&gt;</span> P90_cells)</span>
<span id="cb69-62"><a href="#cb69-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (dup)</span>
<span id="cb69-63"><a href="#cb69-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (</span>
<span id="cb69-64"><a href="#cb69-64" aria-hidden="true" tabindex="-1"></a>            nonnum</span>
<span id="cb69-65"><a href="#cb69-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (</span>
<span id="cb69-66"><a href="#cb69-66" aria-hidden="true" tabindex="-1"></a>                (mops <span class="op">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb69-67"><a href="#cb69-67" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (preL <span class="op">&gt;</span> P80_pre)</span>
<span id="cb69-68"><a href="#cb69-68" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (postL <span class="op">&gt;</span> P80_post)</span>
<span id="cb69-69"><a href="#cb69-69" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (cells <span class="op">&gt;</span> P80_cells)</span>
<span id="cb69-70"><a href="#cb69-70" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb69-71"><a href="#cb69-71" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb69-72"><a href="#cb69-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-73"><a href="#cb69-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-74"><a href="#cb69-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># EASY (broaden to P65)</span></span>
<span id="cb69-75"><a href="#cb69-75" aria-hidden="true" tabindex="-1"></a>    easy <span class="op">=</span> (<span class="op">~</span>hard) <span class="op">&amp;</span> (</span>
<span id="cb69-76"><a href="#cb69-76" aria-hidden="true" tabindex="-1"></a>        (mops <span class="op">&lt;=</span> <span class="dv">2</span>)</span>
<span id="cb69-77"><a href="#cb69-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (turns.between(<span class="dv">2</span>, <span class="dv">4</span>, inclusive<span class="op">=</span><span class="st">"both"</span>))</span>
<span id="cb69-78"><a href="#cb69-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (<span class="op">~</span>t2)</span>
<span id="cb69-79"><a href="#cb69-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (preL <span class="op">&lt;=</span> P65_pre)</span>
<span id="cb69-80"><a href="#cb69-80" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (postL <span class="op">&lt;=</span> P65_post)</span>
<span id="cb69-81"><a href="#cb69-81" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (cells <span class="op">&lt;=</span> P65_cells)</span>
<span id="cb69-82"><a href="#cb69-82" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-83"><a href="#cb69-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-84"><a href="#cb69-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MEDIUM (middle band)</span></span>
<span id="cb69-85"><a href="#cb69-85" aria-hidden="true" tabindex="-1"></a>    medium <span class="op">=</span> (</span>
<span id="cb69-86"><a href="#cb69-86" aria-hidden="true" tabindex="-1"></a>        (<span class="op">~</span>hard)</span>
<span id="cb69-87"><a href="#cb69-87" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (<span class="op">~</span>easy)</span>
<span id="cb69-88"><a href="#cb69-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (</span>
<span id="cb69-89"><a href="#cb69-89" aria-hidden="true" tabindex="-1"></a>            ((mops.isin([<span class="dv">2</span>, <span class="dv">3</span>])) <span class="op">|</span> (t2))</span>
<span id="cb69-90"><a href="#cb69-90" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (turns.between(<span class="dv">3</span>, <span class="dv">6</span>, inclusive<span class="op">=</span><span class="st">"both"</span>))</span>
<span id="cb69-91"><a href="#cb69-91" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (preL <span class="op">&lt;=</span> P90_pre)</span>
<span id="cb69-92"><a href="#cb69-92" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (postL <span class="op">&lt;=</span> P90_post)</span>
<span id="cb69-93"><a href="#cb69-93" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (cells <span class="op">&lt;=</span> P90_cells)</span>
<span id="cb69-94"><a href="#cb69-94" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb69-95"><a href="#cb69-95" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-96"><a href="#cb69-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-97"><a href="#cb69-97" aria-hidden="true" tabindex="-1"></a>    stage <span class="op">=</span> pd.Series(index<span class="op">=</span>df.index, dtype<span class="op">=</span><span class="st">"string"</span>)</span>
<span id="cb69-98"><a href="#cb69-98" aria-hidden="true" tabindex="-1"></a>    stage.loc[hard] <span class="op">=</span> <span class="st">"Hard"</span></span>
<span id="cb69-99"><a href="#cb69-99" aria-hidden="true" tabindex="-1"></a>    stage.loc[easy] <span class="op">=</span> <span class="st">"Easy"</span></span>
<span id="cb69-100"><a href="#cb69-100" aria-hidden="true" tabindex="-1"></a>    stage.loc[medium] <span class="op">=</span> <span class="st">"Medium"</span></span>
<span id="cb69-101"><a href="#cb69-101" aria-hidden="true" tabindex="-1"></a>    stage <span class="op">=</span> stage.fillna(<span class="st">"Medium"</span>)</span>
<span id="cb69-102"><a href="#cb69-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stage</span>
<span id="cb69-103"><a href="#cb69-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-104"><a href="#cb69-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-105"><a href="#cb69-105" aria-hidden="true" tabindex="-1"></a>cur_train_df <span class="op">=</span> train_flat_df.copy()</span>
<span id="cb69-106"><a href="#cb69-106" aria-hidden="true" tabindex="-1"></a>cur_test_df <span class="op">=</span> test_flat_df.copy()</span>
<span id="cb69-107"><a href="#cb69-107" aria-hidden="true" tabindex="-1"></a>cur_train_df[<span class="st">"stage"</span>] <span class="op">=</span> assign_stages(cur_train_df)</span>
<span id="cb69-108"><a href="#cb69-108" aria-hidden="true" tabindex="-1"></a>cur_test_df[<span class="st">"stage"</span>] <span class="op">=</span> assign_stages(cur_test_df)</span>
<span id="cb69-109"><a href="#cb69-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-110"><a href="#cb69-110" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"[Stage counts] TRAIN:"</span>, cur_train_df[<span class="st">"stage"</span>].value_counts().to_dict())</span>
<span id="cb69-111"><a href="#cb69-111" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"[Stage counts] TEST:  "</span>, cur_test_df[<span class="st">"stage"</span>].value_counts().to_dict())</span>
<span id="cb69-112"><a href="#cb69-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-113"><a href="#cb69-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-114"><a href="#cb69-114" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Simple sampler (unchanged) ---</span></span>
<span id="cb69-115"><a href="#cb69-115" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_df(df: pd.DataFrame, n: <span class="bu">int</span>, seed: <span class="bu">int</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb69-116"><a href="#cb69-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> df.empty:</span>
<span id="cb69-117"><a href="#cb69-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df.iloc[<span class="dv">0</span>:<span class="dv">0</span>]</span>
<span id="cb69-118"><a href="#cb69-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">&lt;=</span> n:</span>
<span id="cb69-119"><a href="#cb69-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df.sample(frac<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span>seed)  <span class="co"># shuffle full pool if small</span></span>
<span id="cb69-120"><a href="#cb69-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.sample(n<span class="op">=</span>n, random_state<span class="op">=</span>seed)</span>
<span id="cb69-121"><a href="#cb69-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-122"><a href="#cb69-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-123"><a href="#cb69-123" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================</span></span>
<span id="cb69-124"><a href="#cb69-124" aria-hidden="true" tabindex="-1"></a><span class="co"># HARD QUOTA REBALANCING</span></span>
<span id="cb69-125"><a href="#cb69-125" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================</span></span>
<span id="cb69-126"><a href="#cb69-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-127"><a href="#cb69-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Proportions for Hard buckets (sum ≈ 1.0). Tune if desired.</span></span>
<span id="cb69-128"><a href="#cb69-128" aria-hidden="true" tabindex="-1"></a>HARD_PROPS <span class="op">=</span> {</span>
<span id="cb69-129"><a href="#cb69-129" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep_ops"</span>: <span class="fl">0.23</span>,  <span class="co"># max_ops &gt;= 4</span></span>
<span id="cb69-130"><a href="#cb69-130" aria-hidden="true" tabindex="-1"></a>    <span class="st">"long_turns"</span>: <span class="fl">0.23</span>,  <span class="co"># turns &gt;= 7</span></span>
<span id="cb69-131"><a href="#cb69-131" aria-hidden="true" tabindex="-1"></a>    <span class="st">"long_ctx"</span>: <span class="fl">0.27</span>,  <span class="co"># pre &gt; P90_pre OR post &gt; P90_post</span></span>
<span id="cb69-132"><a href="#cb69-132" aria-hidden="true" tabindex="-1"></a>    <span class="st">"big_table"</span>: <span class="fl">0.20</span>,  <span class="co"># total_cells &gt; P90_cells</span></span>
<span id="cb69-133"><a href="#cb69-133" aria-hidden="true" tabindex="-1"></a>    <span class="st">"noisy"</span>: <span class="fl">0.07</span>,  <span class="co"># duplicate OR non-numeric (with complexity already in stage)</span></span>
<span id="cb69-134"><a href="#cb69-134" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-135"><a href="#cb69-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-136"><a href="#cb69-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-137"><a href="#cb69-137" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hard_bucket_masks(df: pd.DataFrame):</span>
<span id="cb69-138"><a href="#cb69-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb69-139"><a href="#cb69-139" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deep_ops"</span>: (df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">&gt;=</span> <span class="dv">4</span>),</span>
<span id="cb69-140"><a href="#cb69-140" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_turns"</span>: (df[<span class="st">"features_num_dialogue_turns"</span>] <span class="op">&gt;=</span> <span class="dv">7</span>),</span>
<span id="cb69-141"><a href="#cb69-141" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_ctx"</span>: (df[<span class="st">"doc_pre_text_len"</span>] <span class="op">&gt;</span> P90_pre)</span>
<span id="cb69-142"><a href="#cb69-142" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (df[<span class="st">"doc_post_text_len"</span>] <span class="op">&gt;</span> P90_post),</span>
<span id="cb69-143"><a href="#cb69-143" aria-hidden="true" tabindex="-1"></a>        <span class="st">"big_table"</span>: (df[<span class="st">"total_cells"</span>] <span class="op">&gt;</span> P90_cells),</span>
<span id="cb69-144"><a href="#cb69-144" aria-hidden="true" tabindex="-1"></a>        <span class="st">"noisy"</span>: (df[<span class="st">"features_has_duplicate_columns"</span>])</span>
<span id="cb69-145"><a href="#cb69-145" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (df[<span class="st">"features_has_non_numeric_values"</span>]),</span>
<span id="cb69-146"><a href="#cb69-146" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb69-147"><a href="#cb69-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-148"><a href="#cb69-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-149"><a href="#cb69-149" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quota_sample_df(</span>
<span id="cb69-150"><a href="#cb69-150" aria-hidden="true" tabindex="-1"></a>    pool: pd.DataFrame, total_n: <span class="bu">int</span>, masks: <span class="bu">dict</span>, props: <span class="bu">dict</span>, seed: <span class="bu">int</span></span>
<span id="cb69-151"><a href="#cb69-151" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb69-152"><a href="#cb69-152" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb69-153"><a href="#cb69-153" aria-hidden="true" tabindex="-1"></a><span class="co">    Quota-based sampling without replacement across overlapping buckets.</span></span>
<span id="cb69-154"><a href="#cb69-154" aria-hidden="true" tabindex="-1"></a><span class="co">    - masks: dict[name] -&gt; boolean Series over pool</span></span>
<span id="cb69-155"><a href="#cb69-155" aria-hidden="true" tabindex="-1"></a><span class="co">    - props: dict[name] -&gt; proportion (0..1)</span></span>
<span id="cb69-156"><a href="#cb69-156" aria-hidden="true" tabindex="-1"></a><span class="co">    Strategy:</span></span>
<span id="cb69-157"><a href="#cb69-157" aria-hidden="true" tabindex="-1"></a><span class="co">      1) compute desired counts per bucket by props * total_n</span></span>
<span id="cb69-158"><a href="#cb69-158" aria-hidden="true" tabindex="-1"></a><span class="co">      2) iterate buckets in fixed priority, sample from items not yet taken</span></span>
<span id="cb69-159"><a href="#cb69-159" aria-hidden="true" tabindex="-1"></a><span class="co">      3) cap each bucket by its availability</span></span>
<span id="cb69-160"><a href="#cb69-160" aria-hidden="true" tabindex="-1"></a><span class="co">      4) top up remaining slots uniformly at random from leftover pool</span></span>
<span id="cb69-161"><a href="#cb69-161" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb69-162"><a href="#cb69-162" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb69-163"><a href="#cb69-163" aria-hidden="true" tabindex="-1"></a>    pool <span class="op">=</span> pool.copy()</span>
<span id="cb69-164"><a href="#cb69-164" aria-hidden="true" tabindex="-1"></a>    taken_idx <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb69-165"><a href="#cb69-165" aria-hidden="true" tabindex="-1"></a>    out_parts <span class="op">=</span> []</span>
<span id="cb69-166"><a href="#cb69-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-167"><a href="#cb69-167" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fixed priority: emphasize "deep_ops" and "long_turns"/"long_ctx" first</span></span>
<span id="cb69-168"><a href="#cb69-168" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> [<span class="st">"deep_ops"</span>, <span class="st">"long_turns"</span>, <span class="st">"long_ctx"</span>, <span class="st">"big_table"</span>, <span class="st">"noisy"</span>]</span>
<span id="cb69-169"><a href="#cb69-169" aria-hidden="true" tabindex="-1"></a>    desired <span class="op">=</span> {k: <span class="bu">int</span>(<span class="bu">round</span>(total_n <span class="op">*</span> props.get(k, <span class="fl">0.0</span>))) <span class="cf">for</span> k <span class="kw">in</span> order}</span>
<span id="cb69-170"><a href="#cb69-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adjust rounding to not exceed total_n</span></span>
<span id="cb69-171"><a href="#cb69-171" aria-hidden="true" tabindex="-1"></a>    diff <span class="op">=</span> total_n <span class="op">-</span> <span class="bu">sum</span>(desired.values())</span>
<span id="cb69-172"><a href="#cb69-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> diff <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb69-173"><a href="#cb69-173" aria-hidden="true" tabindex="-1"></a>        <span class="co"># distribute remainder by descending props</span></span>
<span id="cb69-174"><a href="#cb69-174" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">sorted</span>(order, key<span class="op">=</span><span class="kw">lambda</span> x: props.get(x, <span class="dv">0</span>), reverse<span class="op">=</span>(diff <span class="op">&gt;</span> <span class="dv">0</span>)):</span>
<span id="cb69-175"><a href="#cb69-175" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> diff <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb69-176"><a href="#cb69-176" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb69-177"><a href="#cb69-177" aria-hidden="true" tabindex="-1"></a>            desired[k] <span class="op">+=</span> <span class="dv">1</span> <span class="cf">if</span> diff <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb69-178"><a href="#cb69-178" aria-hidden="true" tabindex="-1"></a>            diff <span class="op">+=</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">if</span> diff <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb69-179"><a href="#cb69-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-180"><a href="#cb69-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> order:</span>
<span id="cb69-181"><a href="#cb69-181" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> desired[k] <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb69-182"><a href="#cb69-182" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb69-183"><a href="#cb69-183" aria-hidden="true" tabindex="-1"></a>        bucket_idx <span class="op">=</span> pool.index[masks[k]]</span>
<span id="cb69-184"><a href="#cb69-184" aria-hidden="true" tabindex="-1"></a>        <span class="co"># remove already taken</span></span>
<span id="cb69-185"><a href="#cb69-185" aria-hidden="true" tabindex="-1"></a>        bucket_idx <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> bucket_idx <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> taken_idx]</span>
<span id="cb69-186"><a href="#cb69-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> bucket_idx:</span>
<span id="cb69-187"><a href="#cb69-187" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb69-188"><a href="#cb69-188" aria-hidden="true" tabindex="-1"></a>        take_k <span class="op">=</span> <span class="bu">min</span>(desired[k], <span class="bu">len</span>(bucket_idx))</span>
<span id="cb69-189"><a href="#cb69-189" aria-hidden="true" tabindex="-1"></a>        choose <span class="op">=</span> <span class="bu">list</span>(rng.choice(bucket_idx, size<span class="op">=</span>take_k, replace<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb69-190"><a href="#cb69-190" aria-hidden="true" tabindex="-1"></a>        out_parts.append(pool.loc[choose])</span>
<span id="cb69-191"><a href="#cb69-191" aria-hidden="true" tabindex="-1"></a>        taken_idx.update(choose)</span>
<span id="cb69-192"><a href="#cb69-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-193"><a href="#cb69-193" aria-hidden="true" tabindex="-1"></a>    <span class="co"># top-up if needed</span></span>
<span id="cb69-194"><a href="#cb69-194" aria-hidden="true" tabindex="-1"></a>    taken_cnt <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(p) <span class="cf">for</span> p <span class="kw">in</span> out_parts)</span>
<span id="cb69-195"><a href="#cb69-195" aria-hidden="true" tabindex="-1"></a>    need <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, total_n <span class="op">-</span> taken_cnt)</span>
<span id="cb69-196"><a href="#cb69-196" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> need <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb69-197"><a href="#cb69-197" aria-hidden="true" tabindex="-1"></a>        leftover_idx <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> pool.index <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> taken_idx]</span>
<span id="cb69-198"><a href="#cb69-198" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> leftover_idx:</span>
<span id="cb69-199"><a href="#cb69-199" aria-hidden="true" tabindex="-1"></a>            k <span class="op">=</span> <span class="bu">min</span>(need, <span class="bu">len</span>(leftover_idx))</span>
<span id="cb69-200"><a href="#cb69-200" aria-hidden="true" tabindex="-1"></a>            choose <span class="op">=</span> <span class="bu">list</span>(rng.choice(leftover_idx, size<span class="op">=</span>k, replace<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb69-201"><a href="#cb69-201" aria-hidden="true" tabindex="-1"></a>            out_parts.append(pool.loc[choose])</span>
<span id="cb69-202"><a href="#cb69-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-203"><a href="#cb69-203" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> out_parts:</span>
<span id="cb69-204"><a href="#cb69-204" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> pd.concat(out_parts, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb69-205"><a href="#cb69-205" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb69-206"><a href="#cb69-206" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> pool.iloc[<span class="dv">0</span>:<span class="dv">0</span>]  <span class="co"># empty</span></span>
<span id="cb69-207"><a href="#cb69-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-208"><a href="#cb69-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out.sample(frac<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span>seed)  <span class="co"># shuffle for stability</span></span>
<span id="cb69-209"><a href="#cb69-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-210"><a href="#cb69-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-211"><a href="#cb69-211" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Build splits with quota rebalance only for Hard ---</span></span>
<span id="cb69-212"><a href="#cb69-212" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> {}</span>
<span id="cb69-213"><a href="#cb69-213" aria-hidden="true" tabindex="-1"></a>OUTDIR.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb69-214"><a href="#cb69-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-215"><a href="#cb69-215" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, stage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"Easy"</span>, <span class="st">"Medium"</span>, <span class="st">"Hard"</span>]):</span>
<span id="cb69-216"><a href="#cb69-216" aria-hidden="true" tabindex="-1"></a>    tconf <span class="op">=</span> TARGETS[stage]</span>
<span id="cb69-217"><a href="#cb69-217" aria-hidden="true" tabindex="-1"></a>    train_pool <span class="op">=</span> cur_train_df[cur_train_df[<span class="st">"stage"</span>] <span class="op">==</span> stage]</span>
<span id="cb69-218"><a href="#cb69-218" aria-hidden="true" tabindex="-1"></a>    test_pool <span class="op">=</span> cur_test_df[cur_test_df[<span class="st">"stage"</span>] <span class="op">==</span> stage]</span>
<span id="cb69-219"><a href="#cb69-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-220"><a href="#cb69-220" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stage <span class="op">!=</span> <span class="st">"Hard"</span>:</span>
<span id="cb69-221"><a href="#cb69-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ---- original sampling for Easy/Medium ----</span></span>
<span id="cb69-222"><a href="#cb69-222" aria-hidden="true" tabindex="-1"></a>        tv_target <span class="op">=</span> tconf[<span class="st">"train"</span>] <span class="op">+</span> tconf[<span class="st">"valid"</span>]</span>
<span id="cb69-223"><a href="#cb69-223" aria-hidden="true" tabindex="-1"></a>        tv <span class="op">=</span> sample_df(train_pool, tv_target, seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb69-224"><a href="#cb69-224" aria-hidden="true" tabindex="-1"></a>        vsize <span class="op">=</span> <span class="bu">min</span>(tconf[<span class="st">"valid"</span>], <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">int</span>(<span class="bu">round</span>(<span class="fl">0.2</span> <span class="op">*</span> <span class="bu">len</span>(tv)))))</span>
<span id="cb69-225"><a href="#cb69-225" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> tv.iloc[:vsize]</span>
<span id="cb69-226"><a href="#cb69-226" aria-hidden="true" tabindex="-1"></a>        train <span class="op">=</span> tv.iloc[vsize : vsize <span class="op">+</span> tconf[<span class="st">"train"</span>]]</span>
<span id="cb69-227"><a href="#cb69-227" aria-hidden="true" tabindex="-1"></a>        test <span class="op">=</span> sample_df(test_pool, tconf[<span class="st">"test"</span>], seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">2</span>)</span>
<span id="cb69-228"><a href="#cb69-228" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb69-229"><a href="#cb69-229" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ---- HARD: quota-based sampling ----</span></span>
<span id="cb69-230"><a href="#cb69-230" aria-hidden="true" tabindex="-1"></a>        masks_train <span class="op">=</span> hard_bucket_masks(train_pool)</span>
<span id="cb69-231"><a href="#cb69-231" aria-hidden="true" tabindex="-1"></a>        masks_test <span class="op">=</span> hard_bucket_masks(test_pool)</span>
<span id="cb69-232"><a href="#cb69-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-233"><a href="#cb69-233" aria-hidden="true" tabindex="-1"></a>        <span class="co"># TRAIN (quota)</span></span>
<span id="cb69-234"><a href="#cb69-234" aria-hidden="true" tabindex="-1"></a>        hard_train <span class="op">=</span> quota_sample_df(</span>
<span id="cb69-235"><a href="#cb69-235" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">=</span>train_pool,</span>
<span id="cb69-236"><a href="#cb69-236" aria-hidden="true" tabindex="-1"></a>            total_n<span class="op">=</span>tconf[<span class="st">"train"</span>],</span>
<span id="cb69-237"><a href="#cb69-237" aria-hidden="true" tabindex="-1"></a>            masks<span class="op">=</span>masks_train,</span>
<span id="cb69-238"><a href="#cb69-238" aria-hidden="true" tabindex="-1"></a>            props<span class="op">=</span>HARD_PROPS,</span>
<span id="cb69-239"><a href="#cb69-239" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">11</span>,</span>
<span id="cb69-240"><a href="#cb69-240" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb69-241"><a href="#cb69-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-242"><a href="#cb69-242" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VALID (quota) from remaining train_pool</span></span>
<span id="cb69-243"><a href="#cb69-243" aria-hidden="true" tabindex="-1"></a>        remaining_train_pool <span class="op">=</span> train_pool.drop(hard_train.index)</span>
<span id="cb69-244"><a href="#cb69-244" aria-hidden="true" tabindex="-1"></a>        hard_valid <span class="op">=</span> quota_sample_df(</span>
<span id="cb69-245"><a href="#cb69-245" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">=</span>remaining_train_pool,</span>
<span id="cb69-246"><a href="#cb69-246" aria-hidden="true" tabindex="-1"></a>            total_n<span class="op">=</span>tconf[<span class="st">"valid"</span>],</span>
<span id="cb69-247"><a href="#cb69-247" aria-hidden="true" tabindex="-1"></a>            masks<span class="op">=</span>hard_bucket_masks(remaining_train_pool),</span>
<span id="cb69-248"><a href="#cb69-248" aria-hidden="true" tabindex="-1"></a>            props<span class="op">=</span>HARD_PROPS,</span>
<span id="cb69-249"><a href="#cb69-249" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">12</span>,</span>
<span id="cb69-250"><a href="#cb69-250" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb69-251"><a href="#cb69-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-252"><a href="#cb69-252" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TEST</span><span class="co"> (quota) from dev pool</span></span>
<span id="cb69-253"><a href="#cb69-253" aria-hidden="true" tabindex="-1"></a>        hard_test <span class="op">=</span> quota_sample_df(</span>
<span id="cb69-254"><a href="#cb69-254" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">=</span>test_pool,</span>
<span id="cb69-255"><a href="#cb69-255" aria-hidden="true" tabindex="-1"></a>            total_n<span class="op">=</span>tconf[<span class="st">"test"</span>],</span>
<span id="cb69-256"><a href="#cb69-256" aria-hidden="true" tabindex="-1"></a>            masks<span class="op">=</span>masks_test,</span>
<span id="cb69-257"><a href="#cb69-257" aria-hidden="true" tabindex="-1"></a>            props<span class="op">=</span>HARD_PROPS,</span>
<span id="cb69-258"><a href="#cb69-258" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">13</span>,</span>
<span id="cb69-259"><a href="#cb69-259" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb69-260"><a href="#cb69-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-261"><a href="#cb69-261" aria-hidden="true" tabindex="-1"></a>        train, valid, test <span class="op">=</span> hard_train, hard_valid, hard_test</span>
<span id="cb69-262"><a href="#cb69-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-263"><a href="#cb69-263" aria-hidden="true" tabindex="-1"></a>    splits[stage] <span class="op">=</span> {<span class="st">"train"</span>: train, <span class="st">"valid"</span>: valid, <span class="st">"test"</span>: test}</span>
<span id="cb69-264"><a href="#cb69-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-265"><a href="#cb69-265" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write JSONL files with just ids (easy to join later)</span></span>
<span id="cb69-266"><a href="#cb69-266" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> split_name, df_part <span class="kw">in</span> splits[stage].items():</span>
<span id="cb69-267"><a href="#cb69-267" aria-hidden="true" tabindex="-1"></a>        outp <span class="op">=</span> OUTDIR <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>stage<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>split_name<span class="sc">}</span><span class="ss">.jsonl"</span></span>
<span id="cb69-268"><a href="#cb69-268" aria-hidden="true" tabindex="-1"></a>        df_part[[<span class="st">"id"</span>]].to_json(outp, orient<span class="op">=</span><span class="st">"records"</span>, lines<span class="op">=</span><span class="va">True</span>, force_ascii<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb69-269"><a href="#cb69-269" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"[</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">] </span><span class="sc">{</span>split_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(df_part)<span class="sc">:4d}</span><span class="ss">  -&gt; </span><span class="sc">{</span>outp<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb69-270"><a href="#cb69-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-271"><a href="#cb69-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-272"><a href="#cb69-272" aria-hidden="true" tabindex="-1"></a><span class="co"># --- quick sanity report ---</span></span>
<span id="cb69-273"><a href="#cb69-273" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quick_report(df):</span>
<span id="cb69-274"><a href="#cb69-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb69-275"><a href="#cb69-275" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"n"</span>: <span class="dv">0</span>}</span>
<span id="cb69-276"><a href="#cb69-276" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb69-277"><a href="#cb69-277" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n"</span>: <span class="bu">len</span>(df),</span>
<span id="cb69-278"><a href="#cb69-278" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ops_max_med"</span>: <span class="bu">float</span>(df[<span class="st">"max_ops_per_conversation"</span>].median()),</span>
<span id="cb69-279"><a href="#cb69-279" aria-hidden="true" tabindex="-1"></a>        <span class="st">"turns_med"</span>: <span class="bu">float</span>(df[<span class="st">"features_num_dialogue_turns"</span>].median()),</span>
<span id="cb69-280"><a href="#cb69-280" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type2_rate"</span>: <span class="bu">float</span>(df[<span class="st">"features_has_type2_question"</span>].mean()),</span>
<span id="cb69-281"><a href="#cb69-281" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pre_P50"</span>: <span class="bu">int</span>(df[<span class="st">"doc_pre_text_len"</span>].median()),</span>
<span id="cb69-282"><a href="#cb69-282" aria-hidden="true" tabindex="-1"></a>        <span class="st">"post_P50"</span>: <span class="bu">int</span>(df[<span class="st">"doc_post_text_len"</span>].median()),</span>
<span id="cb69-283"><a href="#cb69-283" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cells_P50"</span>: <span class="bu">int</span>(df[<span class="st">"total_cells"</span>].median()),</span>
<span id="cb69-284"><a href="#cb69-284" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deep_ops_rate"</span>: <span class="bu">float</span>((df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">&gt;=</span> <span class="dv">4</span>).mean()),</span>
<span id="cb69-285"><a href="#cb69-285" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_turns_rate"</span>: <span class="bu">float</span>((df[<span class="st">"features_num_dialogue_turns"</span>] <span class="op">&gt;=</span> <span class="dv">7</span>).mean()),</span>
<span id="cb69-286"><a href="#cb69-286" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_ctx_rate"</span>: <span class="bu">float</span>(</span>
<span id="cb69-287"><a href="#cb69-287" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb69-288"><a href="#cb69-288" aria-hidden="true" tabindex="-1"></a>                (df[<span class="st">"doc_pre_text_len"</span>] <span class="op">&gt;</span> P90_pre)</span>
<span id="cb69-289"><a href="#cb69-289" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (df[<span class="st">"doc_post_text_len"</span>] <span class="op">&gt;</span> P90_post)</span>
<span id="cb69-290"><a href="#cb69-290" aria-hidden="true" tabindex="-1"></a>            ).mean()</span>
<span id="cb69-291"><a href="#cb69-291" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb69-292"><a href="#cb69-292" aria-hidden="true" tabindex="-1"></a>        <span class="st">"big_table_rate"</span>: <span class="bu">float</span>((df[<span class="st">"total_cells"</span>] <span class="op">&gt;</span> P90_cells).mean()),</span>
<span id="cb69-293"><a href="#cb69-293" aria-hidden="true" tabindex="-1"></a>        <span class="st">"noisy_rate"</span>: <span class="bu">float</span>(</span>
<span id="cb69-294"><a href="#cb69-294" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb69-295"><a href="#cb69-295" aria-hidden="true" tabindex="-1"></a>                df[<span class="st">"features_has_duplicate_columns"</span>]</span>
<span id="cb69-296"><a href="#cb69-296" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> df[<span class="st">"features_has_non_numeric_values"</span>]</span>
<span id="cb69-297"><a href="#cb69-297" aria-hidden="true" tabindex="-1"></a>            ).mean()</span>
<span id="cb69-298"><a href="#cb69-298" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb69-299"><a href="#cb69-299" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb69-300"><a href="#cb69-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-301"><a href="#cb69-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-302"><a href="#cb69-302" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> stage <span class="kw">in</span> [<span class="st">"Easy"</span>, <span class="st">"Medium"</span>, <span class="st">"Hard"</span>]:</span>
<span id="cb69-303"><a href="#cb69-303" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">[Sanity] </span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb69-304"><a href="#cb69-304" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> part, dfp <span class="kw">in</span> splits[stage].items():</span>
<span id="cb69-305"><a href="#cb69-305" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>part<span class="sc">:&gt;5s}</span><span class="ss"> -&gt;"</span>, quick_report(dfp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[Percentiles/train] pre P50=244, P65=365, P80=518, P90=637 | post P50=285, P65=407, P80=548, P90=679 | cells P50=12, P65=15, P80=18, P90=25
[Stage counts] TRAIN: {'Medium': 1687, 'Hard': 1063, 'Easy': 287}
[Stage counts] TEST:   {'Medium': 253, 'Hard': 134, 'Easy': 34}
[Easy] train:  230  -&gt; splits/easy_train.jsonl
[Easy] valid:   57  -&gt; splits/easy_valid.jsonl
[Easy] test:   34  -&gt; splits/easy_test.jsonl
[Medium] train:  300  -&gt; splits/medium_train.jsonl
[Medium] valid:   70  -&gt; splits/medium_valid.jsonl
[Medium] test:   80  -&gt; splits/medium_test.jsonl
[Hard] train:  220  -&gt; splits/hard_train.jsonl
[Hard] valid:   60  -&gt; splits/hard_valid.jsonl
[Hard] test:   80  -&gt; splits/hard_test.jsonl

[Sanity] Easy
  train -&gt; {'n': 230, 'ops_max_med': 2.0, 'turns_med': 3.0, 'type2_rate': 0.0, 'pre_P50': 217, 'post_P50': 253, 'cells_P50': 9, 'deep_ops_rate': 0.0, 'long_turns_rate': 0.0, 'long_ctx_rate': 0.0, 'big_table_rate': 0.0, 'noisy_rate': 0.06086956521739131}
  valid -&gt; {'n': 57, 'ops_max_med': 2.0, 'turns_med': 3.0, 'type2_rate': 0.0, 'pre_P50': 200, 'post_P50': 297, 'cells_P50': 8, 'deep_ops_rate': 0.0, 'long_turns_rate': 0.0, 'long_ctx_rate': 0.0, 'big_table_rate': 0.0, 'noisy_rate': 0.10526315789473684}
   test -&gt; {'n': 34, 'ops_max_med': 2.0, 'turns_med': 3.0, 'type2_rate': 0.0, 'pre_P50': 189, 'post_P50': 272, 'cells_P50': 8, 'deep_ops_rate': 0.0, 'long_turns_rate': 0.0, 'long_ctx_rate': 0.0, 'big_table_rate': 0.0, 'noisy_rate': 0.08823529411764706}

[Sanity] Medium
  train -&gt; {'n': 300, 'ops_max_med': 2.0, 'turns_med': 4.0, 'type2_rate': 0.32666666666666666, 'pre_P50': 243, 'post_P50': 253, 'cells_P50': 11, 'deep_ops_rate': 0.0, 'long_turns_rate': 0.0, 'long_ctx_rate': 0.0, 'big_table_rate': 0.0, 'noisy_rate': 0.07666666666666666}
  valid -&gt; {'n': 70, 'ops_max_med': 2.0, 'turns_med': 3.5, 'type2_rate': 0.32857142857142857, 'pre_P50': 216, 'post_P50': 269, 'cells_P50': 12, 'deep_ops_rate': 0.0, 'long_turns_rate': 0.0, 'long_ctx_rate': 0.0, 'big_table_rate': 0.0, 'noisy_rate': 0.1}
   test -&gt; {'n': 80, 'ops_max_med': 2.0, 'turns_med': 3.0, 'type2_rate': 0.3625, 'pre_P50': 206, 'post_P50': 216, 'cells_P50': 13, 'deep_ops_rate': 0.0, 'long_turns_rate': 0.0, 'long_ctx_rate': 0.0, 'big_table_rate': 0.0, 'noisy_rate': 0.025}

[Sanity] Hard
  train -&gt; {'n': 220, 'ops_max_med': 2.0, 'turns_med': 5.0, 'type2_rate': 0.42727272727272725, 'pre_P50': 222, 'post_P50': 270, 'cells_P50': 15, 'deep_ops_rate': 0.2590909090909091, 'long_turns_rate': 0.2590909090909091, 'long_ctx_rate': 0.37272727272727274, 'big_table_rate': 0.2681818181818182, 'noisy_rate': 0.20454545454545456}
  valid -&gt; {'n': 60, 'ops_max_med': 2.0, 'turns_med': 4.0, 'type2_rate': 0.4, 'pre_P50': 161, 'post_P50': 292, 'cells_P50': 17, 'deep_ops_rate': 0.23333333333333334, 'long_turns_rate': 0.16666666666666666, 'long_ctx_rate': 0.38333333333333336, 'big_table_rate': 0.25, 'noisy_rate': 0.25}
   test -&gt; {'n': 80, 'ops_max_med': 2.0, 'turns_med': 4.0, 'type2_rate': 0.325, 'pre_P50': 176, 'post_P50': 177, 'cells_P50': 18, 'deep_ops_rate': 0.15, 'long_turns_rate': 0.0375, 'long_ctx_rate': 0.4375, 'big_table_rate': 0.3375, 'noisy_rate': 0.275}</code></pre>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>So far, we’ve explored the given dataset, and we’ve decided to do curriculum learning for the problem statement.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="goodhamgupta/personal_blog" data-repo-id="R_kgDOLXv-xA" data-category="General" data-category-id="DIC_kwDOLXv-xM4Cdogy" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/goodhamgupta/personal_blog/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer><script>var lightboxQuarto = GLightbox({"selector":".lightbox","closeEffect":"zoom","descPosition":"bottom","openEffect":"zoom","loop":false});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>