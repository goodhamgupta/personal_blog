<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shubham Gupta">
<meta name="dcterms.date" content="2025-08-31">
<meta name="description" content="Mapping ConvFinQA and crafting a curriculum for financial QA">

<title>Shubham Gupta - Curriculum Learning ü§ù DSPy: Exploration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<script src="../site_libs/quarto-search/autocomplete-preset-algolia.umd.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "algolia": {
    "application-id": "HR1HJNZUVY",
    "search-only-api-key": "3326e8971e20d27e2dd21591d6a24656",
    "index-name": "blog_pages",
    "index-fields": {
      "href": "url",
      "section": "sec",
      "text": "body"
    },
    "analytics-events": true,
    "show-logo": false,
    "libDir": "site_libs"
  },
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"></script>


<script type="text/javascript">
var ALGOLIA_INSIGHTS_SRC = "https://cdn.jsdelivr.net/npm/search-insights/dist/search-insights.iife.min.js";
!function(e,a,t,n,s,i,c){e.AlgoliaAnalyticsObject=s,e[s]=e[s]||function(){
(e[s].queue=e[s].queue||[]).push(arguments)},i=a.createElement(t),c=a.getElementsByTagName(t)[0],
i.async=1,i.src=n,c.parentNode.insertBefore(i,c)
}(window,document,"script",ALGOLIA_INSIGHTS_SRC,"aa");
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-plugin-algolia-insights">

</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CLKTGRWBQT"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-CLKTGRWBQT', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Shubham Gupta - Curriculum Learning ü§ù DSPy: Exploration">
<meta property="og:description" content="Mapping ConvFinQA and crafting a curriculum for financial QA">
<meta property="og:image" content="https://shubhamg.in/posts/cl_dspy/curriculum_learning_data.png">
<meta property="og:site_name" content="Shubham Gupta">
<meta property="og:image:height" content="1488">
<meta property="og:image:width" content="1202">
<meta name="twitter:title" content="Shubham Gupta - Curriculum Learning ü§ù DSPy: Exploration">
<meta name="twitter:description" content="Mapping ConvFinQA and crafting a curriculum for financial QA">
<meta name="twitter:image" content="https://shubhamg.in/posts/cl_dspy/curriculum_learning_data.png">
<meta name="twitter:creator" content="@shubhamg2208">
<meta name="twitter:image-height" content="1488">
<meta name="twitter:image-width" content="1202">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Shubham Gupta</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/goodhamgupta"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Curriculum Learning ü§ù DSPy: Exploration</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
                  <div>
        <div class="description">
          Mapping ConvFinQA and crafting a curriculum for financial QA
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">programming</div>
                <div class="quarto-category">dspy</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Shubham Gupta </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 31, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#eda" id="toc-eda" class="nav-link" data-scroll-target="#eda">EDA</a>
  <ul class="collapse">
  <li><a href="#missing-data" id="toc-missing-data" class="nav-link" data-scroll-target="#missing-data">Missing Data</a></li>
  <li><a href="#pre-and-post-text" id="toc-pre-and-post-text" class="nav-link" data-scroll-target="#pre-and-post-text">pre and post text</a></li>
  <li><a href="#doc_table" id="toc-doc_table" class="nav-link" data-scroll-target="#doc_table"><code>doc_table</code></a>
  <ul class="collapse">
  <li><a href="#table-dimensions" id="toc-table-dimensions" class="nav-link" data-scroll-target="#table-dimensions">Table Dimensions</a></li>
  <li><a href="#column-header-analysis" id="toc-column-header-analysis" class="nav-link" data-scroll-target="#column-header-analysis">Column Header Analysis</a></li>
  <li><a href="#row-header-analysis" id="toc-row-header-analysis" class="nav-link" data-scroll-target="#row-header-analysis">Row Header Analysis</a></li>
  </ul></li>
  <li><a href="#dialogue_conv_questions" id="toc-dialogue_conv_questions" class="nav-link" data-scroll-target="#dialogue_conv_questions"><code>dialogue_conv_questions</code></a></li>
  <li><a href="#dialogue_conv_answers" id="toc-dialogue_conv_answers" class="nav-link" data-scroll-target="#dialogue_conv_answers"><code>dialogue_conv_answers</code></a></li>
  <li><a href="#dialogue_turn_program" id="toc-dialogue_turn_program" class="nav-link" data-scroll-target="#dialogue_turn_program"><code>dialogue_turn_program</code></a></li>
  <li><a href="#features_num_dialogue_turns" id="toc-features_num_dialogue_turns" class="nav-link" data-scroll-target="#features_num_dialogue_turns"><code>features_num_dialogue_turns</code></a></li>
  <li><a href="#features_has_type2_question" id="toc-features_has_type2_question" class="nav-link" data-scroll-target="#features_has_type2_question"><code>features_has_type2_question</code></a></li>
  </ul></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology</a>
  <ul class="collapse">
  <li><a href="#curriculum-learning" id="toc-curriculum-learning" class="nav-link" data-scroll-target="#curriculum-learning">Curriculum Learning</a></li>
  <li><a href="#curriculum-design-quota-rebalancing" id="toc-curriculum-design-quota-rebalancing" class="nav-link" data-scroll-target="#curriculum-design-quota-rebalancing">Curriculum Design &amp; Quota Rebalancing</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/goodhamgupta/personal_blog/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>In my current project, I‚Äôm exploring financial reasoning over conversational data. With all the buzz around DSPy, I decided it‚Äôs the perfect time to dive deep into this tool.</p>
<p>Financial reasoning over conversational data presents a unique challenge in NLP: models must not only understand natural language but also perform multi-step numerical computations while maintaining context across dialogue turns.</p>
<p><a href="https://github.com/czyssrs/ConvFinQA">ConvFinQA</a> is a dataset that combines conversational QA with financial documents and tables, requiring systems to execute chains of mathematical operations to arrive at correct answers.</p>
<p>What if we could improve model performance by teaching systems to learn from easier examples first, gradually building up to complex multi-turn reasoning? This is the core idea behind <a href="https://huggingface.co/learn/deep-rl-course/en/unitbonus3/curriculum-learning">curriculum learning</a>.</p>
<p>This post begins a series exploring curriculum learning with <a href="https://github.com/stanfordnlp/dspy">DSPy</a>. We start with an exploratory analysis of ConvFinQA to understand what makes some examples harder than others, identify complexity patterns in the data, and establish the base for a curriculum-based approach.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<div id="cell-3" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="st">"../data/convfinqa_dataset.json"</span>))</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>data.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>dict_keys(['train', 'dev'])</code></pre>
</div>
</div>
<p>The current dataset only contains the <code>train</code> and <code>dev</code> splits. For evaluation, we will likely use the <code>dev</code> split, and for training, we‚Äôll split the <code>train</code> split into a <code>train</code> and <code>val</code> split.</p>
<div id="cell-5" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.DataFrame(data[<span class="st">"train"</span>])</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame(data[<span class="st">"dev"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-6" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>train_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3037 entries, 0 to 3036
Data columns (total 4 columns):
 #   Column    Non-Null Count  Dtype 
---  ------    --------------  ----- 
 0   id        3037 non-null   object
 1   doc       3037 non-null   object
 2   dialogue  3037 non-null   object
 3   features  3037 non-null   object
dtypes: object(4)
memory usage: 95.0+ KB</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>test_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 421 entries, 0 to 420
Data columns (total 4 columns):
 #   Column    Non-Null Count  Dtype 
---  ------    --------------  ----- 
 0   id        421 non-null    object
 1   doc       421 non-null    object
 2   dialogue  421 non-null    object
 3   features  421 non-null    object
dtypes: object(4)
memory usage: 13.3+ KB</code></pre>
</div>
</div>
<p>We will <em>explode</em> the columns with nested features to make them easier to work with.</p>
<div id="cell-9" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>train_flat_df <span class="op">=</span> pd.concat(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        train_df.drop([<span class="st">"doc"</span>, <span class="st">"dialogue"</span>, <span class="st">"features"</span>], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"doc"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"doc_"</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"dialogue"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"dialogue_"</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">"features"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"features_"</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>test_flat_df <span class="op">=</span> pd.concat(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        test_df.drop([<span class="st">"doc"</span>, <span class="st">"dialogue"</span>, <span class="st">"features"</span>], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"doc"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"doc_"</span>),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"dialogue"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"dialogue_"</span>),</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">"features"</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">"features_"</span>),</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-10" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3037 entries, 0 to 3036
Data columns (total 13 columns):
 #   Column                           Non-Null Count  Dtype 
---  ------                           --------------  ----- 
 0   id                               3037 non-null   object
 1   doc_pre_text                     3037 non-null   object
 2   doc_post_text                    3037 non-null   object
 3   doc_table                        3037 non-null   object
 4   dialogue_conv_questions          3037 non-null   object
 5   dialogue_conv_answers            3037 non-null   object
 6   dialogue_turn_program            3037 non-null   object
 7   dialogue_executed_answers        3037 non-null   object
 8   dialogue_qa_split                3037 non-null   object
 9   features_num_dialogue_turns      3037 non-null   int64 
 10  features_has_type2_question      3037 non-null   bool  
 11  features_has_duplicate_columns   3037 non-null   bool  
 12  features_has_non_numeric_values  3037 non-null   bool  
dtypes: bool(3), int64(1), object(9)
memory usage: 246.3+ KB</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>test_flat_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 421 entries, 0 to 420
Data columns (total 13 columns):
 #   Column                           Non-Null Count  Dtype 
---  ------                           --------------  ----- 
 0   id                               421 non-null    object
 1   doc_pre_text                     421 non-null    object
 2   doc_post_text                    421 non-null    object
 3   doc_table                        421 non-null    object
 4   dialogue_conv_questions          421 non-null    object
 5   dialogue_conv_answers            421 non-null    object
 6   dialogue_turn_program            421 non-null    object
 7   dialogue_executed_answers        421 non-null    object
 8   dialogue_qa_split                421 non-null    object
 9   features_num_dialogue_turns      421 non-null    int64 
 10  features_has_type2_question      421 non-null    bool  
 11  features_has_duplicate_columns   421 non-null    bool  
 12  features_has_non_numeric_values  421 non-null    bool  
dtypes: bool(3), int64(1), object(9)
memory usage: 34.2+ KB</code></pre>
</div>
</div>
</section>
<section id="eda" class="level1">
<h1>EDA</h1>
<section id="missing-data" class="level3">
<h3 class="anchored" data-anchor-id="missing-data">Missing Data</h3>
<p>First, let‚Äôs check to see if there‚Äôs any missing data in any field.</p>
<div id="cell-15" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> missingno <span class="im">as</span> msno</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>msno.matrix(train_flat_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-9-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-16" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>msno.matrix(test_flat_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-10-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>No missing values in the training dataset.</p>
</section>
<section id="pre-and-post-text" class="level2">
<h2 class="anchored" data-anchor-id="pre-and-post-text">pre and post text</h2>
<p>According to the database schema:</p>
<ul>
<li>pre_text -&gt; Supporting text from the document occuring BEFORE the table content</li>
<li>post_text -&gt; Supporting text from the document occuring AFTER the table content</li>
</ul>
<div id="cell-20" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>pprint(train_flat_df[<span class="st">"doc_pre_text"</span>].head().iloc[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>('26 | 2009 annual report in fiscal 2008 , revenues in the credit union '
 'systems and services business segment increased 14% ( 14 % ) from fiscal '
 '2007 . all revenue components within the segment experienced growth during '
 'fiscal 2008 . license revenue generated the largest dollar growth in revenue '
 'as episys ae , our flagship core processing system aimed at larger credit '
 'unions , experienced strong sales throughout the year . support and service '
 'revenue , which is the largest component of total revenues for the credit '
 'union segment , experienced 34 percent growth in eft support and 10 percent '
 'growth in in-house support . gross profit in this business segment increased '
 '$ 9344 in fiscal 2008 compared to fiscal 2007 , due primarily to the '
 'increase in license revenue , which carries the highest margins . liquidity '
 'and capital resources we have historically generated positive cash flow from '
 'operations and have generally used funds generated from operations and '
 'short-term borrowings on our revolving credit facility to meet capital '
 'requirements . we expect this trend to continue in the future . the company '
 '2019s cash and cash equivalents increased to $ 118251 at june 30 , 2009 from '
 '$ 65565 at june 30 , 2008 . the following table summarizes net cash from '
 'operating activities in the statement of cash flows : 2009 2008 2007 .')</code></pre>
</div>
</div>
<div id="cell-21" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(<span class="bu">len</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>count    3037.000000
mean     1760.501811
std      1397.695620
min         1.000000
25%       568.000000
50%      1417.000000
75%      2765.000000
max      7153.000000
Name: doc_pre_text, dtype: float64</code></pre>
</div>
</div>
<div id="cell-22" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(<span class="bu">len</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>count     421.000000
mean     1538.061758
std      1337.167597
min        17.000000
25%       410.000000
50%      1072.000000
75%      2347.000000
max      5639.000000
Name: doc_pre_text, dtype: float64</code></pre>
</div>
</div>
<p>Looks like the pre_text in the data has some si</p>
<div id="cell-24" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    train_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Length of doc_pre_text"</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"train_flat_df: doc_pre_text length"</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    test_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"orange"</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Length of doc_pre_text"</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"test_flat_df: doc_pre_text length"</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    train_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Length of doc_post_text"</span>)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"train_flat_df: doc_post_text length"</span>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    test_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(<span class="bu">str</span>(x))),</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Length of doc_post_text"</span>)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"test_flat_df: doc_post_text length"</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Looks like the train and test data have a similar distribution for doc_pre_text and doc_post_text.</p>
<p>However, we do see some extreme outliers, with the large documents have &gt; 5000 characters.</p>
<p>Most new generation LLMs do have a ctx window large enough to handle both pre text + table + post text in the same context window, and we may not need any pre-processing for fields. However, we will revisit this later.</p>
</section>
<section id="doc_table" class="level2">
<h2 class="anchored" data-anchor-id="doc_table"><code>doc_table</code></h2>
<section id="table-dimensions" class="level3">
<h3 class="anchored" data-anchor-id="table-dimensions">Table Dimensions</h3>
<div id="cell-28" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_dims(table):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute basic shape statistics for a table dict.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">        table (dict): Mapping from row keys to dicts of column:value pairs.</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">        pd.Series: Series with n_rows, n_cols, total_cells.</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">            - n_rows: Number of rows in the table (outer dict keys)</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">            - n_cols: Number of unique columns across all rows</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">            - total_cells: Total number of (row, col) value pairs</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    n_rows <span class="op">=</span> <span class="bu">len</span>(table)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> {col <span class="cf">for</span> row <span class="kw">in</span> table.values() <span class="cf">for</span> col <span class="kw">in</span> row}</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    n_cols <span class="op">=</span> <span class="bu">len</span>(cols)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    total_cells <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(row) <span class="cf">for</span> row <span class="kw">in</span> table.values())</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series({<span class="st">"n_rows"</span>: n_rows, <span class="st">"n_cols"</span>: n_cols, <span class="st">"total_cells"</span>: total_cells})</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> (train_flat_df, test_flat_df):</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    df[[<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]] <span class="op">=</span> df[<span class="st">"doc_table"</span>].<span class="bu">apply</span>(compute_dims)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>all_dims <span class="op">=</span> pd.concat(</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        train_flat_df[[<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]].assign(split<span class="op">=</span><span class="st">"train"</span>),</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        test_flat_df[[<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]].assign(split<span class="op">=</span><span class="st">"test"</span>),</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    ignore_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, col <span class="kw">in</span> <span class="bu">zip</span>(axes, [<span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>, <span class="st">"total_cells"</span>]):</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    sns.histplot(data<span class="op">=</span>all_dims, x<span class="op">=</span>col, hue<span class="op">=</span><span class="st">"split"</span>, multiple<span class="op">=</span><span class="st">"stack"</span>, bins<span class="op">=</span><span class="dv">30</span>, ax<span class="op">=</span>ax)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    ax.set_title(col)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-15-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Some key points:</p>
<ul>
<li>Most tables don‚Äôt have more than 6 rows. This is good, since it limits the amount of error that can be introduced by the model when answering a question.</li>
<li>Column distribution is a bit more extreme, especially in the training dataset.
<ul>
<li>While the training dataset has a maximum of 17 columns, most of the <code>test</code> dataset tops out at ~8-9 columns.</li>
<li>This is a good feature we could use to determine which records to use for the evaluation. More on this soon!</li>
</ul></li>
<li>Same as the number of columns, we see that the training dataset has a much wider distribution of number of cells. In the test set, the majority of records have cells &lt; 30.</li>
</ul>
<div id="cell-30" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Tables with more than </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss"> columns per split:"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> split, df <span class="kw">in</span> [(<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)]:</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> df[df[<span class="st">"n_cols"</span>] <span class="op">&gt;</span> threshold]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(subset)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> subset.empty:</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(subset[[<span class="st">"id"</span>, <span class="st">"n_rows"</span>, <span class="st">"n_cols"</span>]].head(), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Tables with more than 10 columns per split:
  train: 100
                                id  n_rows  n_cols
16     Double_PNC/2014/page_99.pdf       2      14
37    Single_GS/2013/page_47.pdf-2       3      12
90   Single_CDW/2015/page_34.pdf-2       5      12
133   Single_CE/2014/page_90.pdf-1       1      11
137   Single_C/2009/page_195.pdf-2       3      14 

  test: 8
                                id  n_rows  n_cols
50   Single_JPM/2007/page_33.pdf-2       3      11
51   Single_GS/2017/page_143.pdf-2       2      13
109  Single_JPM/2007/page_33.pdf-1       3      11
117  Single_GS/2017/page_143.pdf-1       2      13
298  Single_MA/2008/page_126.pdf-1       1      14 
</code></pre>
</div>
</div>
<div id="cell-31" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_nested_tables(table):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Recursively count nested tables in a table dict.</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">    A nested table is any dict or list of dicts within cell values (deeper than the row level).</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _count(t, depth):</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        cnt <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(t, <span class="bu">dict</span>):</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> v <span class="kw">in</span> t.values():</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(v, <span class="bu">dict</span>):</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> depth <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>                        cnt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>                    cnt <span class="op">+=</span> _count(v, depth <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> <span class="bu">isinstance</span>(v, <span class="bu">list</span>):</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> item <span class="kw">in</span> v:</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">isinstance</span>(item, <span class="bu">dict</span>):</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> depth <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>                                cnt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>                            cnt <span class="op">+=</span> _count(item, depth <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cnt</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _count(table, <span class="dv">0</span>)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> (train_flat_df, test_flat_df):</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"nested_tables"</span>] <span class="op">=</span> df[<span class="st">"doc_table"</span>].<span class="bu">apply</span>(count_nested_tables)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Nested tables per split:"</span>)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> split, df <span class="kw">in</span> [(<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)]:</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    nt <span class="op">=</span> df[<span class="st">"nested_tables"</span>]</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"  </span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">: docs w/ nested tables = </span><span class="sc">{</span>(nt <span class="op">&gt;</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span><span class="bu">len</span>(nt)<span class="sc">}</span><span class="ss">, max nested = </span><span class="sc">{</span>nt<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>nested_df <span class="op">=</span> pd.concat(</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        train_flat_df[[<span class="st">"nested_tables"</span>]].assign(split<span class="op">=</span><span class="st">"train"</span>),</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        test_flat_df[[<span class="st">"nested_tables"</span>]].assign(split<span class="op">=</span><span class="st">"test"</span>),</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    ignore_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>nested_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Nested tables per split:
  train: docs w/ nested tables = 0 / 3037, max nested = 0
  test: docs w/ nested tables = 0 / 421, max nested = 0
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3458 entries, 0 to 3457
Data columns (total 2 columns):
 #   Column         Non-Null Count  Dtype 
---  ------         --------------  ----- 
 0   nested_tables  3458 non-null   int64 
 1   split          3458 non-null   object
dtypes: int64(1), object(1)
memory usage: 54.2+ KB</code></pre>
</div>
</div>
<div id="cell-32" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>nested_df[nested_df[<span class="st">"nested_tables"</span>] <span class="op">&gt;=</span> <span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">nested_tables</th>
<th data-quarto-table-cell-role="th">split</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Looks like the table are not deeply nested! This is good since we don‚Äôt have to worry too much about table formatting, when sending the table as context to the LLM.</p>
</section>
<section id="column-header-analysis" class="level3">
<h3 class="anchored" data-anchor-id="column-header-analysis">Column Header Analysis</h3>
<div id="cell-35" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_split(df, split_name):</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    n_docs <span class="op">=</span> <span class="bu">len</span>(df)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    dup_count <span class="op">=</span> df[<span class="st">"features_has_duplicate_columns"</span>].<span class="bu">sum</span>()</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    years_per_doc <span class="op">=</span> df[<span class="st">"doc_table"</span>].<span class="bu">apply</span>(<span class="bu">len</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    year_stats <span class="op">=</span> years_per_doc.describe().to_dict()</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    freq <span class="op">=</span> Counter()</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    doc_freq <span class="op">=</span> Counter()</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    all_headers <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tbl <span class="kw">in</span> df[<span class="st">"doc_table"</span>]:</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        hdrs_in_doc <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> year_dict <span class="kw">in</span> tbl.values():</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>            freq.update(year_dict.keys())</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>            hdrs_in_doc.update(year_dict.keys())</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        doc_freq.update(hdrs_in_doc)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        all_headers.update(hdrs_in_doc)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- </span><span class="sc">{</span>split_name<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> SPLIT ---"</span>)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total docs: </span><span class="sc">{</span>n_docs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Docs w/ duplicate cols: </span><span class="sc">{</span>dup_count<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>dup_count <span class="op">/</span> n_docs<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Years/doc stats: </span><span class="sc">{</span>year_stats<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique headers across all docs: </span><span class="sc">{</span><span class="bu">len</span>(all_headers)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Top 10 headers by total occurrences:"</span>, freq.most_common(<span class="dv">10</span>))</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Top 10 headers by docs appeared in:"</span>, doc_freq.most_common(<span class="dv">10</span>))</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> [(<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)]:</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    analyze_split(df, name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
--- TRAIN SPLIT ---
Total docs: 3037
Docs w/ duplicate cols: 60 (2.0%)
Years/doc stats: {'count': 3037.0, 'mean': 2.839973658215344, 'std': 1.5134690841267935, 'min': 1.0, '25%': 2.0, '50%': 3.0, '75%': 3.0, 'max': 10.0}
Unique headers across all docs: 3948
Top 10 headers by total occurrences: [('total', 1147), ('s&amp;p 500 index', 456), ('s&amp;p 500', 419), ('other', 371), ('operating profit', 253), ('net sales', 229), ('2009', 210), ('2012', 206), ('2010', 206), ('2011', 201)]
Top 10 headers by docs appeared in: [('total', 383), ('other', 205), ('thereafter', 109), ('2012', 107), ('2011', 103), ('2013', 102), ('2010', 99), ('2009', 98), ('2014', 91), ('2018', 87)]

--- TEST SPLIT ---
Total docs: 421
Docs w/ duplicate cols: 17 (4.0%)
Years/doc stats: {'count': 421.0, 'mean': 3.0332541567695963, 'std': 1.6500609236986385, 'min': 1.0, '25%': 2.0, '50%': 3.0, '75%': 4.0, 'max': 8.0}
Unique headers across all docs: 833
Top 10 headers by total occurrences: [('total', 183), ('s&amp;p 500 index', 120), ('cadence design systems inc .', 72), ('nasdaq composite', 72), ('other', 60), ('s&amp;p 500', 42), ('2011', 40), ('operating income', 39), ('2012', 38), ('s&amp;p retail index', 36)]
Top 10 headers by docs appeared in: [('total', 54), ('other', 36), ('s&amp;p 500 index', 20), ('2014', 18), ('2015', 18), ('2012', 17), ('2010', 16), ('2011', 16), ('2007', 16), ('2017', 14)]</code></pre>
</div>
</div>
</section>
<section id="row-header-analysis" class="level3">
<h3 class="anchored" data-anchor-id="row-header-analysis">Row Header Analysis</h3>
<div id="cell-37" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_row_key(k: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Lower-case, drop punctuation, collapse spaces."""</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> k:</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> k.lower()</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> re.sub(<span class="vs">r"[_\-]"</span>, <span class="st">" "</span>, k)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> re.sub(<span class="vs">r"[()%:$,]"</span>, <span class="st">" "</span>, k)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> re.sub(<span class="vs">r"\s+"</span>, <span class="st">" "</span>, k).strip()</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_row_headers(df, split_name: <span class="bu">str</span>, top_n: <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span>):</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    raw_freq, norm_freq, summary_freq <span class="op">=</span> Counter(), Counter(), Counter()</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    summary_kw <span class="op">=</span> (</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total"</span>,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"net"</span>,</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"%"</span>,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"percent"</span>,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"change"</span>,</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"difference"</span>,</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"subtotal"</span>,</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"summary"</span>,</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tbl <span class="kw">in</span> df[<span class="st">"doc_table"</span>]:</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(tbl, <span class="bu">dict</span>):</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> year_dict <span class="kw">in</span> tbl.values():</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(year_dict, <span class="bu">dict</span>):</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> raw <span class="kw">in</span> year_dict.keys():</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> raw <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>                raw <span class="op">=</span> <span class="bu">str</span>(raw).strip()</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>                norm <span class="op">=</span> normalize_row_key(raw)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>                raw_freq[raw] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>                norm_freq[norm] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">any</span>(k <span class="kw">in</span> raw.lower() <span class="cf">for</span> k <span class="kw">in</span> summary_kw):</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>                    summary_freq[raw] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>    total_rows <span class="op">=</span> <span class="bu">sum</span>(raw_freq.values())</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">===== </span><span class="sc">{</span>split_name<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> SPLIT : ROW HEADER ANALYSIS ====="</span>)</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Row instances              : </span><span class="sc">{</span>total_rows<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique raw headers         : </span><span class="sc">{</span><span class="bu">len</span>(raw_freq)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique normalized headers  : </span><span class="sc">{</span><span class="bu">len</span>(norm_freq)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Raw header  ‚ûú  Normalized header (top 10 by freq)"</span>)</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> hdr, _ <span class="kw">in</span> raw_freq.most_common(<span class="dv">10</span>):</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>hdr[:<span class="dv">55</span>]<span class="sc">:55}</span><span class="ss"> ‚ûú </span><span class="sc">{</span>normalize_row_key(hdr)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top-</span><span class="sc">{</span>top_n<span class="sc">}</span><span class="ss"> most frequent financial metrics (normalized)"</span>)</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> hdr, cnt <span class="kw">in</span> norm_freq.most_common(top_n):</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>hdr[:<span class="dv">55</span>]<span class="sc">:55}</span><span class="ss"> </span><span class="sc">{</span>cnt<span class="sc">:&gt;6}</span><span class="ss">"</span>)</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>    tot_summary <span class="op">=</span> <span class="bu">sum</span>(summary_freq.values())</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Subtotal/Summary rows detected (keywords </span><span class="sc">{</span>summary_kw<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Instances: </span><span class="sc">{</span>tot_summary<span class="sc">}</span><span class="ss">  (</span><span class="sc">{</span>tot_summary <span class="op">/</span> total_rows<span class="sc">:.1%}</span><span class="ss"> of all rows)"</span>)</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> hdr, cnt <span class="kw">in</span> summary_freq.most_common(<span class="dv">10</span>):</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>hdr[:<span class="dv">55</span>]<span class="sc">:55}</span><span class="ss"> </span><span class="sc">{</span>cnt<span class="sc">:&gt;6}</span><span class="ss">"</span>)</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> ((<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)):</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>    analyze_row_headers(df, name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
===== TRAIN SPLIT : ROW HEADER ANALYSIS =====
Row instances              : 42813
Unique raw headers         : 3,948
Unique normalized headers  : 3,921

Raw header  ‚ûú  Normalized header (top 10 by freq)
total                                                   ‚ûú total
s&amp;p 500 index                                           ‚ûú s&amp;p 500 index
s&amp;p 500                                                 ‚ûú s&amp;p 500
other                                                   ‚ûú other
operating profit                                        ‚ûú operating profit
net sales                                               ‚ûú net sales
2009                                                    ‚ûú 2009
2012                                                    ‚ûú 2012
2010                                                    ‚ûú 2010
2011                                                    ‚ûú 2011

Top-10 most frequent financial metrics (normalized)
total                                                     1147
s&amp;p 500 index                                              456
s&amp;p 500                                                    419
other                                                      371
operating profit                                           253
net sales                                                  229
2009                                                       210
2010                                                       208
2012                                                       206
2011                                                       201

Subtotal/Summary rows detected (keywords ('total', 'net', '%', 'percent', 'change', 'difference', 'subtotal', 'summary'))
Instances: 7535  (17.6% of all rows)
total                                                     1147
net sales                                                  229
net income                                                 118
net cash provided by operating activities                  117
total net revenues                                          78
total operating expenses                                    75
total contractual obligations                               67
total debt                                                  61
net earnings ( loss )                                       58
total minimum lease payments                                57

===== TEST SPLIT : ROW HEADER ANALYSIS =====
Row instances              : 6159
Unique raw headers         : 833
Unique normalized headers  : 832

Raw header  ‚ûú  Normalized header (top 10 by freq)
total                                                   ‚ûú total
s&amp;p 500 index                                           ‚ûú s&amp;p 500 index
cadence design systems inc .                            ‚ûú cadence design systems inc .
nasdaq composite                                        ‚ûú nasdaq composite
other                                                   ‚ûú other
s&amp;p 500                                                 ‚ûú s&amp;p 500
2011                                                    ‚ûú 2011
operating income                                        ‚ûú operating income
2012                                                    ‚ûú 2012
s&amp;p retail index                                        ‚ûú s&amp;p retail index

Top-10 most frequent financial metrics (normalized)
total                                                      183
s&amp;p 500 index                                              120
cadence design systems inc .                                72
nasdaq composite                                            72
other                                                       60
s&amp;p 500                                                     42
2011                                                        40
operating income                                            39
2012                                                        38
s&amp;p retail index                                            36

Subtotal/Summary rows detected (keywords ('total', 'net', '%', 'percent', 'change', 'difference', 'subtotal', 'summary'))
Instances: 1218  (19.8% of all rows)
total                                                      183
net cash provided by operating activities                   28
1.375% ( 1.375 % ) notes due 2015                           24
6.25% ( 6.25 % ) notes due 2017                             24
5.00% ( 5.00 % ) notes due 2019                             24
4.25% ( 4.25 % ) notes due 2021                             24
3.375% ( 3.375 % ) notes due 2022                           24
total long-term borrowings                                  24
total contractual obligations                               24
net income                                                  21</code></pre>
</div>
</div>
<p>We see some similar patterns in the row headers across the splits, but nothing of significance.</p>
<div id="cell-39" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _yield_cells(x):</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">dict</span>):</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v <span class="kw">in</span> x.values():</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> <span class="cf">from</span> _yield_cells(v)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(x, (<span class="bu">list</span>, <span class="bu">tuple</span>)):</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v <span class="kw">in</span> x:</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> <span class="cf">from</span> _yield_cells(v)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> x</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _parse_num(tok):</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(tok).strip()</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> s <span class="kw">or</span> s.lower() <span class="kw">in</span> (<span class="st">"na"</span>, <span class="st">"n/a"</span>, <span class="st">"nan"</span>, <span class="st">"-"</span>):</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    neg <span class="op">=</span> (s.startswith(<span class="st">"("</span>) <span class="kw">and</span> s.endswith(<span class="st">")"</span>)) <span class="kw">or</span> s.endswith(<span class="st">"-"</span>)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> s.strip(<span class="st">"()"</span>).rstrip(<span class="st">"-"</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> re.sub(<span class="vs">r"[,\$%]"</span>, <span class="st">""</span>, s)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    mult <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> s.lower().endswith(<span class="st">"m"</span>):</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        mult, s <span class="op">=</span> <span class="fl">1e6</span>, s[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> s.lower().endswith(<span class="st">"k"</span>):</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>        mult, s <span class="op">=</span> <span class="fl">1e3</span>, s[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> <span class="bu">float</span>(s) <span class="op">*</span> mult</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>val <span class="cf">if</span> neg <span class="cf">else</span> val</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_cell_values(df, split_name, top_n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> num <span class="op">=</span> missing <span class="op">=</span> unp <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    unpatt <span class="op">=</span> Counter()</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tbl <span class="kw">in</span> df[<span class="st">"doc_table"</span>]:</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(tbl, <span class="bu">dict</span>):</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cell <span class="kw">in</span> _yield_cells(tbl):</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>            txt <span class="op">=</span> <span class="bu">str</span>(cell).strip()</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> cell <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> txt <span class="op">==</span> <span class="st">""</span>:</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>                missing <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> _parse_num(cell) <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>                unp <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>                key <span class="op">=</span> txt.lower()[:<span class="dv">25</span>]</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>                unpatt[key] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>                num <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">=== </span><span class="sc">{</span>split_name<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> CELL QUALITY ==="</span>)</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"total: </span><span class="sc">{</span>total<span class="sc">}</span><span class="ss">, numeric: </span><span class="sc">{</span>num<span class="sc">}</span><span class="ss">, missing: </span><span class="sc">{</span>missing<span class="sc">}</span><span class="ss">, unparseable: </span><span class="sc">{</span>unp<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Top </span><span class="sc">{</span>top_n<span class="sc">}</span><span class="ss"> unparseable patterns:"</span>)</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pat, cnt <span class="kw">in</span> unpatt.most_common(top_n):</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>pat<span class="sc">:25}</span><span class="ss"> </span><span class="sc">{</span>cnt<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, d <span class="kw">in</span> ((<span class="st">"train"</span>, train_flat_df), (<span class="st">"test"</span>, test_flat_df)):</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>    analyze_cell_values(d, name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== TRAIN CELL QUALITY ===
total: 42813, numeric: 41499, missing: 184, unparseable: 1130
Top 10 unparseable patterns:
  -                         265
  n/a                       147
  ( in thousands )          102
  nm                        62
  owned                     43
  $ -                       42
  pay                       22
  fta                       20
  cash                      16
  leased                    14

=== TEST CELL QUALITY ===
total: 6159, numeric: 6045, missing: 12, unparseable: 102
Top 10 unparseable patterns:
  -                         13
  none                      9
  high                      6
  low                       6
  ( b )                     6
  leased                    6
  united states             4
  united kingdom            4
  ( d )                     3
  nm                        3</code></pre>
</div>
</div>
<p>We see that:</p>
<ul>
<li><strong>Train</strong> (42,813 total cells): 97.0% numeric, 0.4% missing, 2.6% unparseable<br>
</li>
<li><strong>Test</strong> (6,159 total cells): 98.2% numeric, 0.2% missing, 1.7% unparseable</li>
</ul>
<p>Top unparseable patterns include <code>-</code>, <code>n/a</code>, <code>( in thousands )</code>, <code>nm</code>, <code>none</code>, <code>high</code>, <code>low</code>, etc., indicating placeholders, qualifiers, and unit headers that need cleaning or custom parsing.</p>
<p>When selecting records for evaluation, we should:</p>
<ul>
<li>Exclude or preprocess records with unparseable cells (~1,232 cells total).<br>
</li>
<li>Drop tables where &gt;5% of cells are unparseable to ensure numeric consistency.</li>
</ul>
<p>This keeps our evaluation set focused on clean, numeric data and avoids noise from poorly parsed entries. More on this later!</p>
<div id="cell-41" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
</section>
<section id="dialogue_conv_questions" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_conv_questions"><code>dialogue_conv_questions</code></h2>
<div id="cell-43" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>train_q_lens <span class="op">=</span> train_flat_df[<span class="st">"dialogue_conv_questions"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>test_q_lens <span class="op">=</span> test_flat_df[<span class="st">"dialogue_conv_questions"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>df_q <span class="op">=</span> pd.concat(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: train_q_lens, <span class="st">"split"</span>: <span class="st">"train"</span>}),</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: test_q_lens, <span class="st">"split"</span>: <span class="st">"test"</span>}),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_q, x<span class="op">=</span><span class="st">"length"</span>, hue<span class="op">=</span><span class="st">"split"</span>, stat<span class="op">=</span><span class="st">"density"</span>, element<span class="op">=</span><span class="st">"step"</span>, fill<span class="op">=</span><span class="va">False</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Dialogue Question Lengths by Split"</span>)</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Question Length (characters)"</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Density"</span>)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-23-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Majority of the questions in both the train and test set are short. This is ideal.</p>
</section>
<section id="dialogue_conv_answers" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_conv_answers"><code>dialogue_conv_answers</code></h2>
<div id="cell-46" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>train_q_lens <span class="op">=</span> train_flat_df[<span class="st">"dialogue_conv_answers"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>test_q_lens <span class="op">=</span> test_flat_df[<span class="st">"dialogue_conv_answers"</span>].explode().dropna().<span class="bu">map</span>(<span class="bu">len</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>df_q <span class="op">=</span> pd.concat(</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: train_q_lens, <span class="st">"split"</span>: <span class="st">"train"</span>}),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"length"</span>: test_q_lens, <span class="st">"split"</span>: <span class="st">"test"</span>}),</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_q, x<span class="op">=</span><span class="st">"length"</span>, hue<span class="op">=</span><span class="st">"split"</span>, stat<span class="op">=</span><span class="st">"density"</span>, element<span class="op">=</span><span class="st">"step"</span>, fill<span class="op">=</span><span class="va">False</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Dialogue Answer Lengths by Split"</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Answer Length (characters)"</span>)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Density"</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-24-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>As mentioned in the dataset, most of the answers are either numeric or boolean in nature. We see a majority of the answers having length &lt;= 8, meaning that these are either large numbers, or numbers with large precision.</p>
</section>
<section id="dialogue_turn_program" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_turn_program"><code>dialogue_turn_program</code></h2>
<p>This field represents the program DSL generated for the current turn.</p>
<div id="cell-50" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"dialogue_turn_program"</span>].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>0    [206588, 181001, subtract(206588, 181001), sub...
1    [9362.2, 9244.9, subtract(9362.2, 9244.9), sub...
2    [5363, 7983, subtract(5363, 7983), subtract(53...
3    [subtract(75.95, const_100), subtract(75.95, c...
4    [subtract(91.06, const_100), subtract(91.06, c...
Name: dialogue_turn_program, dtype: object</code></pre>
</div>
</div>
<div id="cell-51" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _get_op_counts(df: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Return a Series with the number of '(' in every element of dialogue_turn_program."""</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"dialogue_turn_program"</span>]</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        .explode()  <span class="co"># one element per row</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        .dropna()</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> rec: <span class="bu">str</span>(rec).count(<span class="st">"("</span>))</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>counts_train <span class="op">=</span> _get_op_counts(train_flat_df)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>counts_test <span class="op">=</span> _get_op_counts(test_flat_df)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>df_counts <span class="op">=</span> pd.concat(</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"ops"</span>: counts_train, <span class="st">"split"</span>: <span class="st">"train"</span>}),</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame({<span class="st">"ops"</span>: counts_test, <span class="st">"split"</span>: <span class="st">"test"</span>}),</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>sns.histplot(</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_counts,</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"ops"</span>,</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"split"</span>,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="bu">range</span>(<span class="dv">0</span>, df_counts[<span class="st">"ops"</span>].<span class="bu">max</span>() <span class="op">+</span> <span class="dv">2</span>),</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    element<span class="op">=</span><span class="st">"step"</span>,</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Number of operations per element"</span>)</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Histogram of operation counts in turn_programs (train vs. test)"</span>)</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-26-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distributions for number of operations in both the train and test set. Majority of the operations are &lt; 4 .</p>
<p>We could argue that the number of operations is a good proxy for the complexity of the program. As such, we should probably aim to do well first on the examples where the number of operations is small.</p>
<div id="cell-53" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="features_num_dialogue_turns" class="level2">
<h2 class="anchored" data-anchor-id="features_num_dialogue_turns"><code>features_num_dialogue_turns</code></h2>
<div id="cell-55" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>order <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>(train_flat_df[<span class="st">"features_num_dialogue_turns"</span>]).union(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        test_flat_df[<span class="st">"features_num_dialogue_turns"</span>]</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>train_flat_df,</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    order<span class="op">=</span>order,</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].<span class="bu">set</span>(</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Train: Num Dialogue Turns"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">"Num Dialogue Turns"</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>test_flat_df,</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    order<span class="op">=</span>order,</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"orange"</span>,</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Test: Num Dialogue Turns"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-28-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distributions across the train and test sets. As mentioned in the paper, we should expect conversations with more dialogue turns, to be more difficult to answer for models.</p>
<p>This is yet another feature we could use when deciding how to split our data into train, validation, and test sets.</p>
<div id="cell-57" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="features_has_type2_question" class="level2">
<h2 class="anchored" data-anchor-id="features_has_type2_question"><code>features_has_type2_question</code></h2>
<div id="cell-59" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> [(<span class="st">"Train"</span>, train_flat_df), (<span class="st">"Test"</span>, test_flat_df)]:</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    vc <span class="op">=</span> df[<span class="st">"features_has_type2_question"</span>].value_counts()</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> set ‚Äì Has Type 2 Question counts:</span><span class="ch">\n</span><span class="sc">{</span>vc<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_has_type2_question"</span>,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>train_flat_df,</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">0</span>],</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].<span class="bu">set</span>(</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Train: Has Type 2 Question"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">"Has Type 2 Question"</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>sns.countplot(</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"features_has_type2_question"</span>,</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>test_flat_df,</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"Oranges"</span>,</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Test: Has Type 2 Question"</span>, xlabel<span class="op">=</span><span class="st">"Count"</span>, ylabel<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Train set ‚Äì Has Type 2 Question counts:
features_has_type2_question
False    2148
True      889
Name: count, dtype: int64

Test set ‚Äì Has Type 2 Question counts:
features_has_type2_question
False    300
True     121
Name: count, dtype: int64
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/zf/l4rjbhhj6xq9bfzs9cr7m5vr0000gn/T/ipykernel_98862/668524099.py:9: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.

  sns.countplot(
/var/folders/zf/l4rjbhhj6xq9bfzs9cr7m5vr0000gn/T/ipykernel_98862/668524099.py:20: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.

  sns.countplot(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-30-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="2025-08-31-cl-dspy-eda_files/figure-html/cell-30-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distrbutions for Type2 questions across the train and test sets, as expected.</p>
</section>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<p><a id="methodology"></a></p>
<p>Given the above dataset analysis, a few things are clear:</p>
<ul>
<li>Given the recent explosion of ctx window size for language models, we should be able to build strong baselines model without any finetuning.</li>
<li>The length analysis of the different fields(pre/post text, table, questions, etc.) confirms that we will likely not need any form of retrieval to answer the questions, <strong>contradictory</strong> to the original paper.</li>
<li>There are varying levels of difficulty in the given set of questions and answer.
<ul>
<li>We ideally should leverage this to build our models in stages, such that we can track and measure accuracy and perform error analysis at each stage.</li>
</ul></li>
</ul>
<p>The current generation of language models have 3 main phases of training:</p>
<ul>
<li><strong>pre-training</strong>: large-scale self-supervised next-token prediction on massive web corpora (e.g., C4, Common Crawl) to learn general language patterns.<br>
</li>
<li><strong>mid-training</strong>: intermediate training on medium-sized, higher-quality or domain-specific data (10‚Äì300 B tokens) with curriculum learning, long-context adaptation, and synthetic/instructional examples to sharpen capabilities.<br>
</li>
<li><strong>post-training</strong>: fine-tuning or instruction-tuning on smaller, curated datasets (100 M‚Äì1 B tokens) and often RLHF to align the model to downstream tasks and human preferences.</li>
</ul>
<p>As seen with our dataset, even current language models are <strong>trained in stages</strong>, with problems that are seemingly difficult for models to understand explicitly trained in either the mid or post-training phase.</p>
<p>This methodology has roots in an reinforcement learning technique called <strong>Curriculum Learning</strong>.</p>
<section id="curriculum-learning" class="level3">
<h3 class="anchored" data-anchor-id="curriculum-learning">Curriculum Learning</h3>
<p><strong>Core Idea</strong>: Curriculum learning for LLMs involves carefully selecting and ordering training data based on difficulty, starting with simpler examples and gradually introducing more complex ones.</p>
<p><strong>Why it‚Äôs beneficial:</strong></p>
<ul>
<li>Improved Efficiency:
<ul>
<li>By starting with easier examples, LLMs can learn fundamental concepts more effectively and then build upon that knowledge.</li>
</ul></li>
<li>Better Generalization:
<ul>
<li>A well-designed curriculum can help LLMs generalize better to unseen data by exposing them to a wider range of complexities and nuances.</li>
</ul></li>
<li>Reduced Training Time:
<ul>
<li>In some cases, curriculum learning can lead to faster convergence and reduced training time.</li>
</ul></li>
</ul>
<p align="center">
<img src="./cl_dspy/curriculum_learning_data.png" width="400" height="500"> <br> <sub> Source: <a href="https://arxiv.org/pdf/2101.10382">Curriculum Learning: A Survey</a>, Soviany et al. </sub>
</p>
<p>For our dataset, given our analysis, we have the following levers to consider:</p>
<ul>
<li>Number of Turns buckets. Eg: 1‚Äì2, 3‚Äì4, 5‚Äì6, ‚â•7</li>
<li>Number of max ops bucket: Eg: 0‚Äì1, 2‚Äì3, 4+</li>
<li>Type1 vs Type2 questions</li>
<li>Context length bucket (pre_text/post_text len): ‚â§P50, P50‚ÄìP80, &gt;P80</li>
<li>Noise flags: duplicate columns / non-numeric values</li>
</ul>
<p>Given that we had limited time, we will pick the following</p>
<ul>
<li><strong>Easy</strong>
<ul>
<li>This is the Core stage</li>
<li>We hope the model will learn how to answer questions that directly pick answers from context, perform simple operations, and can carry previous answers minimally.</li>
<li>We will use the following filters(all must hold TRUE):
<ul>
<li>max_ops_per_conversation ‚â§ 2</li>
<li>2 ‚â§ num_dialogue_turns ‚â§ 4</li>
<li>has_type2_question == False</li>
<li>doc_pre_text_len ‚â§ P50_pre</li>
<li>doc_post_text_len ‚â§ P50_post</li>
<li>total_cells ‚â§ P50_cells</li>
</ul></li>
</ul></li>
<li><strong>Medium</strong>
<ul>
<li>This stage focuses on improving the reasoning ability of the model, and it‚Äôs ability to track dependencies.</li>
<li>The hope is that this stage will help the model learn multi-op arithmetic, cross question dependencies, and variable reuse.
<ul>
<li>Filters (must satisfy both lines)
<ul>
<li>( (max_ops_per_conversation ‚àà {2,3}) OR (has_type2_question == True) )</li>
<li>3 ‚â§ num_dialogue_turns ‚â§ 6</li>
<li>doc_pre_text_len ‚â§ P90_pre</li>
<li>doc_post_text_len ‚â§ P90_post</li>
<li>total_cells ‚â§ P90_cells</li>
</ul></li>
<li>This admits many max_ops=2 dialogs but with more turns and/or Type2.</li>
</ul></li>
</ul></li>
<li><strong>Hard</strong>
<ul>
<li>This stage will aim to tackle the long-tail of difficult problems, and help introduce much needed robustness in our models.</li>
<li>Specifically, we hope that at the end of this stage, the model is good at long context answer, which requires retrieval and reasoning, extreme op depth, and poorly formatted/large tables.</li>
<li>Filters (any single trigger is enough)
<ul>
<li>Deep ops: max_ops_per_conversation ‚â• 4 OR</li>
<li>Long dialogs: features_num_dialogue_turns ‚â• 7</li>
<li>Long context: doc_pre_text_len &gt; P90_pre OR doc_post_text_len &gt; P90_post</li>
<li>Large tables: total_cells &gt; P90_cells</li>
<li>Noisy schema: has_non_numeric_values OR has_duplicate_columns with some complexity ‚Üí ~10‚Äì15%</li>
</ul></li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>To prevent overlap and duplicates, we will construct the stages in reverse order i.e - Hard first to ensure we isolate the difficult problems - Easy next to identify baseline performance - Remaining problems go into medium to help develop better reasoning and arithmetic abilities.</p>
</blockquote>
<div id="cell-65" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_max_ops_per_conversation(df):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> max_ops(turn_programs):</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># turn_programs is a list of lists (or strings), one per turn</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Each turn_program is a string or list of strings, e.g. ['subtract(206588, 181001)', ...]</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We'll count the number of operations per turn, then take the max</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> re</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(turn_programs, <span class="bu">list</span>):</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>        op_pattern <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r"([a-zA-Z_][a-zA-Z0-9_]*\()"</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        max_ops <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> turn <span class="kw">in</span> turn_programs:</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(turn, <span class="bu">str</span>):</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>                <span class="co"># count ops in the string</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>                ops <span class="op">=</span> <span class="bu">len</span>(op_pattern.findall(turn))</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="bu">isinstance</span>(turn, <span class="bu">list</span>):</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># count ops in all strings in the list</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>                ops <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(op_pattern.findall(<span class="bu">str</span>(x))) <span class="cf">for</span> x <span class="kw">in</span> turn)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>                ops <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> ops <span class="op">&gt;</span> max_ops:</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>                max_ops <span class="op">=</span> ops</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> max_ops</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[<span class="st">"dialogue_turn_program"</span>].<span class="bu">apply</span>(max_ops)</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">=</span> get_max_ops_per_conversation(train_flat_df)</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">=</span> get_max_ops_per_conversation(test_flat_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-66" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"doc_pre_text_len"</span>] <span class="op">=</span> train_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>train_flat_df[<span class="st">"doc_post_text_len"</span>] <span class="op">=</span> train_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"doc_pre_text_len"</span>] <span class="op">=</span> test_flat_df[<span class="st">"doc_pre_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>test_flat_df[<span class="st">"doc_post_text_len"</span>] <span class="op">=</span> test_flat_df[<span class="st">"doc_post_text"</span>].<span class="bu">apply</span>(</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="bu">len</span>(x.split())</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-67" class="cell" data-execution_count="41">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>train_flat_df[</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_ops_per_conversation"</span>,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_type2_question"</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_duplicate_columns"</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_non_numeric_values"</span>,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_pre_text_len"</span>,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_post_text_len"</span>,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_rows"</span>,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_cols"</span>,</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_cells"</span>,</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>].astype(<span class="bu">int</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_ops_per_conversation</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
<th data-quarto-table-cell-role="th">doc_pre_text_len</th>
<th data-quarto-table-cell-role="th">doc_post_text_len</th>
<th data-quarto-table-cell-role="th">n_rows</th>
<th data-quarto-table-cell-role="th">n_cols</th>
<th data-quarto-table-cell-role="th">total_cells</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2.035232</td>
<td>0.292723</td>
<td>0.019756</td>
<td>3.656240</td>
<td>0.122160</td>
<td>300.901218</td>
<td>320.378005</td>
<td>2.839974</td>
<td>5.232137</td>
<td>14.097135</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>0.655179</td>
<td>0.455087</td>
<td>0.139185</td>
<td>1.319899</td>
<td>0.327524</td>
<td>239.324988</td>
<td>256.003210</td>
<td>1.513469</td>
<td>2.506996</td>
<td>10.260609</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>3.000000</td>
<td>0.000000</td>
<td>100.000000</td>
<td>102.000000</td>
<td>2.000000</td>
<td>3.000000</td>
<td>7.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>4.000000</td>
<td>0.000000</td>
<td>244.000000</td>
<td>285.000000</td>
<td>3.000000</td>
<td>5.000000</td>
<td>12.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>2.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>5.000000</td>
<td>0.000000</td>
<td>470.000000</td>
<td>498.000000</td>
<td>3.000000</td>
<td>7.000000</td>
<td>18.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>5.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>9.000000</td>
<td>1.000000</td>
<td>1132.000000</td>
<td>1489.000000</td>
<td>10.000000</td>
<td>19.000000</td>
<td>114.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-68" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>test_flat_df[</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_ops_per_conversation"</span>,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_type2_question"</span>,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_duplicate_columns"</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_num_dialogue_turns"</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features_has_non_numeric_values"</span>,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_pre_text_len"</span>,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"doc_post_text_len"</span>,</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_rows"</span>,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_cols"</span>,</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_cells"</span>,</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>].astype(<span class="bu">int</span>).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="42">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_ops_per_conversation</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
<th data-quarto-table-cell-role="th">doc_pre_text_len</th>
<th data-quarto-table-cell-role="th">doc_post_text_len</th>
<th data-quarto-table-cell-role="th">n_rows</th>
<th data-quarto-table-cell-role="th">n_cols</th>
<th data-quarto-table-cell-role="th">total_cells</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2.061758</td>
<td>0.287411</td>
<td>0.040380</td>
<td>3.539192</td>
<td>0.076010</td>
<td>263.475059</td>
<td>322.712589</td>
<td>3.033254</td>
<td>5.173397</td>
<td>14.629454</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>0.658993</td>
<td>0.453093</td>
<td>0.197083</td>
<td>1.252239</td>
<td>0.265329</td>
<td>226.086872</td>
<td>252.372826</td>
<td>1.650061</td>
<td>2.206237</td>
<td>8.670173</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.000000</td>
<td>0.000000</td>
<td>3.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>2.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.000000</td>
<td>0.000000</td>
<td>74.000000</td>
<td>119.000000</td>
<td>2.000000</td>
<td>3.000000</td>
<td>8.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>4.000000</td>
<td>0.000000</td>
<td>187.000000</td>
<td>292.000000</td>
<td>3.000000</td>
<td>5.000000</td>
<td>12.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>2.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>5.000000</td>
<td>0.000000</td>
<td>406.000000</td>
<td>520.000000</td>
<td>4.000000</td>
<td>6.000000</td>
<td>18.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>5.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>8.000000</td>
<td>1.000000</td>
<td>933.000000</td>
<td>1099.000000</td>
<td>8.000000</td>
<td>14.000000</td>
<td>48.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="curriculum-design-quota-rebalancing" class="level2">
<h2 class="anchored" data-anchor-id="curriculum-design-quota-rebalancing">Curriculum Design &amp; Quota Rebalancing</h2>
<p>While our complexity classification captures overall difficulty, curriculum learning requires more nuanced sampling strategies. Simply taking the hardest examples might create an imbalanced curriculum that overrepresents certain types of complexity while ignoring others.</p>
<p>Consider two scenarios: 1. <strong>Naive sampling</strong>: We randomly sample from our ‚ÄúHard‚Äù bucket and end up with 80% long-context examples but only 5% multi-operation examples 2. <strong>Quota sampling</strong>: We ensure balanced representation across complexity dimensions</p>
<p>The second approach creates a more robust curriculum. Our hard examples should include: - <strong>Deep reasoning</strong> (4+ mathematical operations) - <strong>Long conversations</strong> (7+ dialogue turns) - <strong>Dense context</strong> (lengthy pre/post text) - <strong>Complex tables</strong> (many cells, nested structures) - <strong>Noisy data</strong> (duplicate columns, non-numeric values)</p>
<p>This ensures our model learns to handle diverse types of complexity rather than overfitting to a single difficulty dimension. The following code implements quota-based sampling to achieve this balanced representation:</p>
<div id="cell-70" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>TARGETS <span class="op">=</span> {</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Easy"</span>: {<span class="st">"train"</span>: <span class="dv">300</span>, <span class="st">"valid"</span>: <span class="dv">70</span>, <span class="st">"test"</span>: <span class="dv">80</span>},</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Medium"</span>: {<span class="st">"train"</span>: <span class="dv">300</span>, <span class="st">"valid"</span>: <span class="dv">70</span>, <span class="st">"test"</span>: <span class="dv">80</span>},</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hard"</span>: {<span class="st">"train"</span>: <span class="dv">220</span>, <span class="st">"valid"</span>: <span class="dv">60</span>, <span class="st">"test"</span>: <span class="dv">80</span>},</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>OUTDIR <span class="op">=</span> Path(<span class="st">"splits"</span>)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>RANDOM_STATE <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>P50_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.50</span>))</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>P65_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.65</span>))</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>P80_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.80</span>))</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>P90_pre <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_pre_text_len"</span>].quantile(<span class="fl">0.90</span>))</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>P50_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.50</span>))</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>P65_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.65</span>))</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>P80_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.80</span>))</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>P90_post <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"doc_post_text_len"</span>].quantile(<span class="fl">0.90</span>))</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>P50_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.50</span>))</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>P65_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.65</span>))</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>P80_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.80</span>))</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>P90_cells <span class="op">=</span> <span class="bu">int</span>(train_flat_df[<span class="st">"total_cells"</span>].quantile(<span class="fl">0.90</span>))</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"[Percentiles/train] pre P50=</span><span class="sc">{</span>P50_pre<span class="sc">}</span><span class="ss">, P65=</span><span class="sc">{</span>P65_pre<span class="sc">}</span><span class="ss">, P80=</span><span class="sc">{</span>P80_pre<span class="sc">}</span><span class="ss">, P90=</span><span class="sc">{</span>P90_pre<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"| post P50=</span><span class="sc">{</span>P50_post<span class="sc">}</span><span class="ss">, P65=</span><span class="sc">{</span>P65_post<span class="sc">}</span><span class="ss">, P80=</span><span class="sc">{</span>P80_post<span class="sc">}</span><span class="ss">, P90=</span><span class="sc">{</span>P90_post<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"| cells P50=</span><span class="sc">{</span>P50_cells<span class="sc">}</span><span class="ss">, P65=</span><span class="sc">{</span>P65_cells<span class="sc">}</span><span class="ss">, P80=</span><span class="sc">{</span>P80_cells<span class="sc">}</span><span class="ss">, P90=</span><span class="sc">{</span>P90_cells<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_stages(df: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>    mops <span class="op">=</span> df[<span class="st">"max_ops_per_conversation"</span>]</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>    turns <span class="op">=</span> df[<span class="st">"features_num_dialogue_turns"</span>]</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>    t2 <span class="op">=</span> df[<span class="st">"features_has_type2_question"</span>]</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>    preL <span class="op">=</span> df[<span class="st">"doc_pre_text_len"</span>]</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>    postL <span class="op">=</span> df[<span class="st">"doc_post_text_len"</span>]</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>    cells <span class="op">=</span> df[<span class="st">"total_cells"</span>]</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>    dup <span class="op">=</span> df[<span class="st">"features_has_duplicate_columns"</span>]</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>    nonnum <span class="op">=</span> df[<span class="st">"features_has_non_numeric_values"</span>]</span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HARD (tail)</span></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>    hard <span class="op">=</span> (</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>        (mops <span class="op">&gt;=</span> <span class="dv">4</span>)</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (turns <span class="op">&gt;=</span> <span class="dv">7</span>)</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (preL <span class="op">&gt;</span> P90_pre)</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (postL <span class="op">&gt;</span> P90_post)</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (cells <span class="op">&gt;</span> P90_cells)</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (dup)</span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>            nonnum</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (</span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>                (mops <span class="op">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (preL <span class="op">&gt;</span> P80_pre)</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (postL <span class="op">&gt;</span> P80_post)</span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (cells <span class="op">&gt;</span> P80_cells)</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># EASY (P65)</span></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>    easy <span class="op">=</span> (<span class="op">~</span>hard) <span class="op">&amp;</span> (</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>        (mops <span class="op">&lt;=</span> <span class="dv">2</span>)</span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (turns.between(<span class="dv">2</span>, <span class="dv">4</span>, inclusive<span class="op">=</span><span class="st">"both"</span>))</span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (<span class="op">~</span>t2)</span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (preL <span class="op">&lt;=</span> P65_pre)</span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (postL <span class="op">&lt;=</span> P65_post)</span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (cells <span class="op">&lt;=</span> P65_cells)</span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MEDIUM (middle band)</span></span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a>    medium <span class="op">=</span> (</span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a>        (<span class="op">~</span>hard)</span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (<span class="op">~</span>easy)</span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (</span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a>            ((mops.isin([<span class="dv">2</span>, <span class="dv">3</span>])) <span class="op">|</span> (t2))</span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (turns.between(<span class="dv">3</span>, <span class="dv">6</span>, inclusive<span class="op">=</span><span class="st">"both"</span>))</span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (preL <span class="op">&lt;=</span> P90_pre)</span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (postL <span class="op">&lt;=</span> P90_post)</span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (cells <span class="op">&lt;=</span> P90_cells)</span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a>    stage <span class="op">=</span> pd.Series(index<span class="op">=</span>df.index, dtype<span class="op">=</span><span class="st">"string"</span>)</span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a>    stage.loc[hard] <span class="op">=</span> <span class="st">"Hard"</span></span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a>    stage.loc[easy] <span class="op">=</span> <span class="st">"Easy"</span></span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a>    stage.loc[medium] <span class="op">=</span> <span class="st">"Medium"</span></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a>    stage <span class="op">=</span> stage.fillna(<span class="st">"Medium"</span>)</span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stage</span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a>cur_train_df <span class="op">=</span> train_flat_df.copy()</span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a>cur_test_df <span class="op">=</span> test_flat_df.copy()</span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a>cur_train_df[<span class="st">"stage"</span>] <span class="op">=</span> assign_stages(cur_train_df)</span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a>cur_test_df[<span class="st">"stage"</span>] <span class="op">=</span> assign_stages(cur_test_df)</span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"[Stage counts] TRAIN:"</span>, cur_train_df[<span class="st">"stage"</span>].value_counts().to_dict())</span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"[Stage counts] TEST:  "</span>, cur_test_df[<span class="st">"stage"</span>].value_counts().to_dict())</span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_df(df: pd.DataFrame, n: <span class="bu">int</span>, seed: <span class="bu">int</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> df.empty:</span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df.iloc[<span class="dv">0</span>:<span class="dv">0</span>]</span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">&lt;=</span> n:</span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df.sample(frac<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span>seed)  <span class="co"># shuffle full pool if small</span></span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.sample(n<span class="op">=</span>n, random_state<span class="op">=</span>seed)</span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================</span></span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a><span class="co"># HARD QUOTA REBALANCING</span></span>
<span id="cb53-114"><a href="#cb53-114" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================</span></span>
<span id="cb53-115"><a href="#cb53-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-116"><a href="#cb53-116" aria-hidden="true" tabindex="-1"></a>HARD_PROPS <span class="op">=</span> {</span>
<span id="cb53-117"><a href="#cb53-117" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deep_ops"</span>: <span class="fl">0.23</span>,  <span class="co"># max_ops &gt;= 4</span></span>
<span id="cb53-118"><a href="#cb53-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"long_turns"</span>: <span class="fl">0.23</span>,  <span class="co"># turns &gt;= 7</span></span>
<span id="cb53-119"><a href="#cb53-119" aria-hidden="true" tabindex="-1"></a>    <span class="st">"long_ctx"</span>: <span class="fl">0.27</span>,  <span class="co"># pre &gt; P90_pre OR post &gt; P90_post</span></span>
<span id="cb53-120"><a href="#cb53-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">"big_table"</span>: <span class="fl">0.20</span>,  <span class="co"># total_cells &gt; P90_cells</span></span>
<span id="cb53-121"><a href="#cb53-121" aria-hidden="true" tabindex="-1"></a>    <span class="st">"noisy"</span>: <span class="fl">0.07</span>,  <span class="co"># duplicate OR non-numeric (with complexity already in stage)</span></span>
<span id="cb53-122"><a href="#cb53-122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-123"><a href="#cb53-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-124"><a href="#cb53-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-125"><a href="#cb53-125" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hard_bucket_masks(df: pd.DataFrame):</span>
<span id="cb53-126"><a href="#cb53-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb53-127"><a href="#cb53-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deep_ops"</span>: (df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">&gt;=</span> <span class="dv">4</span>),</span>
<span id="cb53-128"><a href="#cb53-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_turns"</span>: (df[<span class="st">"features_num_dialogue_turns"</span>] <span class="op">&gt;=</span> <span class="dv">7</span>),</span>
<span id="cb53-129"><a href="#cb53-129" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_ctx"</span>: (df[<span class="st">"doc_pre_text_len"</span>] <span class="op">&gt;</span> P90_pre)</span>
<span id="cb53-130"><a href="#cb53-130" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (df[<span class="st">"doc_post_text_len"</span>] <span class="op">&gt;</span> P90_post),</span>
<span id="cb53-131"><a href="#cb53-131" aria-hidden="true" tabindex="-1"></a>        <span class="st">"big_table"</span>: (df[<span class="st">"total_cells"</span>] <span class="op">&gt;</span> P90_cells),</span>
<span id="cb53-132"><a href="#cb53-132" aria-hidden="true" tabindex="-1"></a>        <span class="st">"noisy"</span>: (df[<span class="st">"features_has_duplicate_columns"</span>])</span>
<span id="cb53-133"><a href="#cb53-133" aria-hidden="true" tabindex="-1"></a>        <span class="op">|</span> (df[<span class="st">"features_has_non_numeric_values"</span>]),</span>
<span id="cb53-134"><a href="#cb53-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-135"><a href="#cb53-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-136"><a href="#cb53-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-137"><a href="#cb53-137" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quota_sample_df(</span>
<span id="cb53-138"><a href="#cb53-138" aria-hidden="true" tabindex="-1"></a>    pool: pd.DataFrame, total_n: <span class="bu">int</span>, masks: <span class="bu">dict</span>, props: <span class="bu">dict</span>, seed: <span class="bu">int</span></span>
<span id="cb53-139"><a href="#cb53-139" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb53-140"><a href="#cb53-140" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb53-141"><a href="#cb53-141" aria-hidden="true" tabindex="-1"></a><span class="co">    Quota-based sampling without replacement across overlapping buckets.</span></span>
<span id="cb53-142"><a href="#cb53-142" aria-hidden="true" tabindex="-1"></a><span class="co">    - masks: dict[name] -&gt; boolean Series over pool</span></span>
<span id="cb53-143"><a href="#cb53-143" aria-hidden="true" tabindex="-1"></a><span class="co">    - props: dict[name] -&gt; proportion (0..1)</span></span>
<span id="cb53-144"><a href="#cb53-144" aria-hidden="true" tabindex="-1"></a><span class="co">    Strategy:</span></span>
<span id="cb53-145"><a href="#cb53-145" aria-hidden="true" tabindex="-1"></a><span class="co">      1) compute desired counts per bucket by props * total_n</span></span>
<span id="cb53-146"><a href="#cb53-146" aria-hidden="true" tabindex="-1"></a><span class="co">      2) iterate buckets in fixed priority, sample from items not yet taken</span></span>
<span id="cb53-147"><a href="#cb53-147" aria-hidden="true" tabindex="-1"></a><span class="co">      3) cap each bucket by its availability</span></span>
<span id="cb53-148"><a href="#cb53-148" aria-hidden="true" tabindex="-1"></a><span class="co">      4) top up remaining slots uniformly at random from leftover pool</span></span>
<span id="cb53-149"><a href="#cb53-149" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb53-150"><a href="#cb53-150" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb53-151"><a href="#cb53-151" aria-hidden="true" tabindex="-1"></a>    pool <span class="op">=</span> pool.copy()</span>
<span id="cb53-152"><a href="#cb53-152" aria-hidden="true" tabindex="-1"></a>    taken_idx <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb53-153"><a href="#cb53-153" aria-hidden="true" tabindex="-1"></a>    out_parts <span class="op">=</span> []</span>
<span id="cb53-154"><a href="#cb53-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-155"><a href="#cb53-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># emphasize "deep_ops" and "long_turns"/"long_ctx" first</span></span>
<span id="cb53-156"><a href="#cb53-156" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> [<span class="st">"deep_ops"</span>, <span class="st">"long_turns"</span>, <span class="st">"long_ctx"</span>, <span class="st">"big_table"</span>, <span class="st">"noisy"</span>]</span>
<span id="cb53-157"><a href="#cb53-157" aria-hidden="true" tabindex="-1"></a>    desired <span class="op">=</span> {k: <span class="bu">int</span>(<span class="bu">round</span>(total_n <span class="op">*</span> props.get(k, <span class="fl">0.0</span>))) <span class="cf">for</span> k <span class="kw">in</span> order}</span>
<span id="cb53-158"><a href="#cb53-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adjust rounding to not exceed total_n</span></span>
<span id="cb53-159"><a href="#cb53-159" aria-hidden="true" tabindex="-1"></a>    diff <span class="op">=</span> total_n <span class="op">-</span> <span class="bu">sum</span>(desired.values())</span>
<span id="cb53-160"><a href="#cb53-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> diff <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb53-161"><a href="#cb53-161" aria-hidden="true" tabindex="-1"></a>        <span class="co"># distribute remainder by descending props</span></span>
<span id="cb53-162"><a href="#cb53-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">sorted</span>(order, key<span class="op">=</span><span class="kw">lambda</span> x: props.get(x, <span class="dv">0</span>), reverse<span class="op">=</span>(diff <span class="op">&gt;</span> <span class="dv">0</span>)):</span>
<span id="cb53-163"><a href="#cb53-163" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> diff <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb53-164"><a href="#cb53-164" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb53-165"><a href="#cb53-165" aria-hidden="true" tabindex="-1"></a>            desired[k] <span class="op">+=</span> <span class="dv">1</span> <span class="cf">if</span> diff <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb53-166"><a href="#cb53-166" aria-hidden="true" tabindex="-1"></a>            diff <span class="op">+=</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">if</span> diff <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb53-167"><a href="#cb53-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-168"><a href="#cb53-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> order:</span>
<span id="cb53-169"><a href="#cb53-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> desired[k] <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb53-170"><a href="#cb53-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb53-171"><a href="#cb53-171" aria-hidden="true" tabindex="-1"></a>        bucket_idx <span class="op">=</span> pool.index[masks[k]]</span>
<span id="cb53-172"><a href="#cb53-172" aria-hidden="true" tabindex="-1"></a>        <span class="co"># remove already taken</span></span>
<span id="cb53-173"><a href="#cb53-173" aria-hidden="true" tabindex="-1"></a>        bucket_idx <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> bucket_idx <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> taken_idx]</span>
<span id="cb53-174"><a href="#cb53-174" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> bucket_idx:</span>
<span id="cb53-175"><a href="#cb53-175" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb53-176"><a href="#cb53-176" aria-hidden="true" tabindex="-1"></a>        take_k <span class="op">=</span> <span class="bu">min</span>(desired[k], <span class="bu">len</span>(bucket_idx))</span>
<span id="cb53-177"><a href="#cb53-177" aria-hidden="true" tabindex="-1"></a>        choose <span class="op">=</span> <span class="bu">list</span>(rng.choice(bucket_idx, size<span class="op">=</span>take_k, replace<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb53-178"><a href="#cb53-178" aria-hidden="true" tabindex="-1"></a>        out_parts.append(pool.loc[choose])</span>
<span id="cb53-179"><a href="#cb53-179" aria-hidden="true" tabindex="-1"></a>        taken_idx.update(choose)</span>
<span id="cb53-180"><a href="#cb53-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-181"><a href="#cb53-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># top-up if needed</span></span>
<span id="cb53-182"><a href="#cb53-182" aria-hidden="true" tabindex="-1"></a>    taken_cnt <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">len</span>(p) <span class="cf">for</span> p <span class="kw">in</span> out_parts)</span>
<span id="cb53-183"><a href="#cb53-183" aria-hidden="true" tabindex="-1"></a>    need <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, total_n <span class="op">-</span> taken_cnt)</span>
<span id="cb53-184"><a href="#cb53-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> need <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb53-185"><a href="#cb53-185" aria-hidden="true" tabindex="-1"></a>        leftover_idx <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> pool.index <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> taken_idx]</span>
<span id="cb53-186"><a href="#cb53-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> leftover_idx:</span>
<span id="cb53-187"><a href="#cb53-187" aria-hidden="true" tabindex="-1"></a>            k <span class="op">=</span> <span class="bu">min</span>(need, <span class="bu">len</span>(leftover_idx))</span>
<span id="cb53-188"><a href="#cb53-188" aria-hidden="true" tabindex="-1"></a>            choose <span class="op">=</span> <span class="bu">list</span>(rng.choice(leftover_idx, size<span class="op">=</span>k, replace<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb53-189"><a href="#cb53-189" aria-hidden="true" tabindex="-1"></a>            out_parts.append(pool.loc[choose])</span>
<span id="cb53-190"><a href="#cb53-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-191"><a href="#cb53-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> out_parts:</span>
<span id="cb53-192"><a href="#cb53-192" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> pd.concat(out_parts, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb53-193"><a href="#cb53-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb53-194"><a href="#cb53-194" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> pool.iloc[<span class="dv">0</span>:<span class="dv">0</span>]</span>
<span id="cb53-195"><a href="#cb53-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-196"><a href="#cb53-196" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out.sample(frac<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span>seed)</span>
<span id="cb53-197"><a href="#cb53-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-198"><a href="#cb53-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-199"><a href="#cb53-199" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Build splits with quota rebalance only for Hard ---</span></span>
<span id="cb53-200"><a href="#cb53-200" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> {}</span>
<span id="cb53-201"><a href="#cb53-201" aria-hidden="true" tabindex="-1"></a>OUTDIR.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-202"><a href="#cb53-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-203"><a href="#cb53-203" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, stage <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">"Easy"</span>, <span class="st">"Medium"</span>, <span class="st">"Hard"</span>]):</span>
<span id="cb53-204"><a href="#cb53-204" aria-hidden="true" tabindex="-1"></a>    tconf <span class="op">=</span> TARGETS[stage]</span>
<span id="cb53-205"><a href="#cb53-205" aria-hidden="true" tabindex="-1"></a>    train_pool <span class="op">=</span> cur_train_df[cur_train_df[<span class="st">"stage"</span>] <span class="op">==</span> stage]</span>
<span id="cb53-206"><a href="#cb53-206" aria-hidden="true" tabindex="-1"></a>    test_pool <span class="op">=</span> cur_test_df[cur_test_df[<span class="st">"stage"</span>] <span class="op">==</span> stage]</span>
<span id="cb53-207"><a href="#cb53-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-208"><a href="#cb53-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stage <span class="op">!=</span> <span class="st">"Hard"</span>:</span>
<span id="cb53-209"><a href="#cb53-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ---- original sampling for Easy/Medium ----</span></span>
<span id="cb53-210"><a href="#cb53-210" aria-hidden="true" tabindex="-1"></a>        tv_target <span class="op">=</span> tconf[<span class="st">"train"</span>] <span class="op">+</span> tconf[<span class="st">"valid"</span>]</span>
<span id="cb53-211"><a href="#cb53-211" aria-hidden="true" tabindex="-1"></a>        tv <span class="op">=</span> sample_df(train_pool, tv_target, seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb53-212"><a href="#cb53-212" aria-hidden="true" tabindex="-1"></a>        vsize <span class="op">=</span> <span class="bu">min</span>(tconf[<span class="st">"valid"</span>], <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">int</span>(<span class="bu">round</span>(<span class="fl">0.2</span> <span class="op">*</span> <span class="bu">len</span>(tv)))))</span>
<span id="cb53-213"><a href="#cb53-213" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> tv.iloc[:vsize]</span>
<span id="cb53-214"><a href="#cb53-214" aria-hidden="true" tabindex="-1"></a>        train <span class="op">=</span> tv.iloc[vsize : vsize <span class="op">+</span> tconf[<span class="st">"train"</span>]]</span>
<span id="cb53-215"><a href="#cb53-215" aria-hidden="true" tabindex="-1"></a>        test <span class="op">=</span> sample_df(test_pool, tconf[<span class="st">"test"</span>], seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">2</span>)</span>
<span id="cb53-216"><a href="#cb53-216" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb53-217"><a href="#cb53-217" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ---- HARD: quota-based sampling ----</span></span>
<span id="cb53-218"><a href="#cb53-218" aria-hidden="true" tabindex="-1"></a>        masks_train <span class="op">=</span> hard_bucket_masks(train_pool)</span>
<span id="cb53-219"><a href="#cb53-219" aria-hidden="true" tabindex="-1"></a>        masks_test <span class="op">=</span> hard_bucket_masks(test_pool)</span>
<span id="cb53-220"><a href="#cb53-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-221"><a href="#cb53-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># TRAIN (quota)</span></span>
<span id="cb53-222"><a href="#cb53-222" aria-hidden="true" tabindex="-1"></a>        hard_train <span class="op">=</span> quota_sample_df(</span>
<span id="cb53-223"><a href="#cb53-223" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">=</span>train_pool,</span>
<span id="cb53-224"><a href="#cb53-224" aria-hidden="true" tabindex="-1"></a>            total_n<span class="op">=</span>tconf[<span class="st">"train"</span>],</span>
<span id="cb53-225"><a href="#cb53-225" aria-hidden="true" tabindex="-1"></a>            masks<span class="op">=</span>masks_train,</span>
<span id="cb53-226"><a href="#cb53-226" aria-hidden="true" tabindex="-1"></a>            props<span class="op">=</span>HARD_PROPS,</span>
<span id="cb53-227"><a href="#cb53-227" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">11</span>,</span>
<span id="cb53-228"><a href="#cb53-228" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-229"><a href="#cb53-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-230"><a href="#cb53-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VALID (quota) from remaining train_pool</span></span>
<span id="cb53-231"><a href="#cb53-231" aria-hidden="true" tabindex="-1"></a>        remaining_train_pool <span class="op">=</span> train_pool.drop(hard_train.index)</span>
<span id="cb53-232"><a href="#cb53-232" aria-hidden="true" tabindex="-1"></a>        hard_valid <span class="op">=</span> quota_sample_df(</span>
<span id="cb53-233"><a href="#cb53-233" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">=</span>remaining_train_pool,</span>
<span id="cb53-234"><a href="#cb53-234" aria-hidden="true" tabindex="-1"></a>            total_n<span class="op">=</span>tconf[<span class="st">"valid"</span>],</span>
<span id="cb53-235"><a href="#cb53-235" aria-hidden="true" tabindex="-1"></a>            masks<span class="op">=</span>hard_bucket_masks(remaining_train_pool),</span>
<span id="cb53-236"><a href="#cb53-236" aria-hidden="true" tabindex="-1"></a>            props<span class="op">=</span>HARD_PROPS,</span>
<span id="cb53-237"><a href="#cb53-237" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">12</span>,</span>
<span id="cb53-238"><a href="#cb53-238" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-239"><a href="#cb53-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-240"><a href="#cb53-240" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">TEST</span><span class="co"> (quota) from dev pool</span></span>
<span id="cb53-241"><a href="#cb53-241" aria-hidden="true" tabindex="-1"></a>        hard_test <span class="op">=</span> quota_sample_df(</span>
<span id="cb53-242"><a href="#cb53-242" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">=</span>test_pool,</span>
<span id="cb53-243"><a href="#cb53-243" aria-hidden="true" tabindex="-1"></a>            total_n<span class="op">=</span>tconf[<span class="st">"test"</span>],</span>
<span id="cb53-244"><a href="#cb53-244" aria-hidden="true" tabindex="-1"></a>            masks<span class="op">=</span>masks_test,</span>
<span id="cb53-245"><a href="#cb53-245" aria-hidden="true" tabindex="-1"></a>            props<span class="op">=</span>HARD_PROPS,</span>
<span id="cb53-246"><a href="#cb53-246" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>RANDOM_STATE <span class="op">+</span> i <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">13</span>,</span>
<span id="cb53-247"><a href="#cb53-247" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-248"><a href="#cb53-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-249"><a href="#cb53-249" aria-hidden="true" tabindex="-1"></a>        train, valid, test <span class="op">=</span> hard_train, hard_valid, hard_test</span>
<span id="cb53-250"><a href="#cb53-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-251"><a href="#cb53-251" aria-hidden="true" tabindex="-1"></a>    splits[stage] <span class="op">=</span> {<span class="st">"train"</span>: train, <span class="st">"valid"</span>: valid, <span class="st">"test"</span>: test}</span>
<span id="cb53-252"><a href="#cb53-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-253"><a href="#cb53-253" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> split_name, df_part <span class="kw">in</span> splits[stage].items():</span>
<span id="cb53-254"><a href="#cb53-254" aria-hidden="true" tabindex="-1"></a>        outp <span class="op">=</span> OUTDIR <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>stage<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>split_name<span class="sc">}</span><span class="ss">.jsonl"</span></span>
<span id="cb53-255"><a href="#cb53-255" aria-hidden="true" tabindex="-1"></a>        df_part[[<span class="st">"id"</span>]].to_json(outp, orient<span class="op">=</span><span class="st">"records"</span>, lines<span class="op">=</span><span class="va">True</span>, force_ascii<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb53-256"><a href="#cb53-256" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"[</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">] </span><span class="sc">{</span>split_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(df_part)<span class="sc">:4d}</span><span class="ss">  -&gt; </span><span class="sc">{</span>outp<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-257"><a href="#cb53-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-258"><a href="#cb53-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-259"><a href="#cb53-259" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quick_report(df):</span>
<span id="cb53-260"><a href="#cb53-260" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb53-261"><a href="#cb53-261" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"n"</span>: <span class="dv">0</span>}</span>
<span id="cb53-262"><a href="#cb53-262" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb53-263"><a href="#cb53-263" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n"</span>: <span class="bu">len</span>(df),</span>
<span id="cb53-264"><a href="#cb53-264" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ops_max_med"</span>: <span class="bu">float</span>(df[<span class="st">"max_ops_per_conversation"</span>].median()),</span>
<span id="cb53-265"><a href="#cb53-265" aria-hidden="true" tabindex="-1"></a>        <span class="st">"turns_med"</span>: <span class="bu">float</span>(df[<span class="st">"features_num_dialogue_turns"</span>].median()),</span>
<span id="cb53-266"><a href="#cb53-266" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type2_rate"</span>: <span class="bu">float</span>(df[<span class="st">"features_has_type2_question"</span>].mean()),</span>
<span id="cb53-267"><a href="#cb53-267" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pre_P50"</span>: <span class="bu">int</span>(df[<span class="st">"doc_pre_text_len"</span>].median()),</span>
<span id="cb53-268"><a href="#cb53-268" aria-hidden="true" tabindex="-1"></a>        <span class="st">"post_P50"</span>: <span class="bu">int</span>(df[<span class="st">"doc_post_text_len"</span>].median()),</span>
<span id="cb53-269"><a href="#cb53-269" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cells_P50"</span>: <span class="bu">int</span>(df[<span class="st">"total_cells"</span>].median()),</span>
<span id="cb53-270"><a href="#cb53-270" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deep_ops_rate"</span>: <span class="bu">float</span>((df[<span class="st">"max_ops_per_conversation"</span>] <span class="op">&gt;=</span> <span class="dv">4</span>).mean()),</span>
<span id="cb53-271"><a href="#cb53-271" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_turns_rate"</span>: <span class="bu">float</span>((df[<span class="st">"features_num_dialogue_turns"</span>] <span class="op">&gt;=</span> <span class="dv">7</span>).mean()),</span>
<span id="cb53-272"><a href="#cb53-272" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_ctx_rate"</span>: <span class="bu">float</span>(</span>
<span id="cb53-273"><a href="#cb53-273" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb53-274"><a href="#cb53-274" aria-hidden="true" tabindex="-1"></a>                (df[<span class="st">"doc_pre_text_len"</span>] <span class="op">&gt;</span> P90_pre)</span>
<span id="cb53-275"><a href="#cb53-275" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> (df[<span class="st">"doc_post_text_len"</span>] <span class="op">&gt;</span> P90_post)</span>
<span id="cb53-276"><a href="#cb53-276" aria-hidden="true" tabindex="-1"></a>            ).mean()</span>
<span id="cb53-277"><a href="#cb53-277" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb53-278"><a href="#cb53-278" aria-hidden="true" tabindex="-1"></a>        <span class="st">"big_table_rate"</span>: <span class="bu">float</span>((df[<span class="st">"total_cells"</span>] <span class="op">&gt;</span> P90_cells).mean()),</span>
<span id="cb53-279"><a href="#cb53-279" aria-hidden="true" tabindex="-1"></a>        <span class="st">"noisy_rate"</span>: <span class="bu">float</span>(</span>
<span id="cb53-280"><a href="#cb53-280" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb53-281"><a href="#cb53-281" aria-hidden="true" tabindex="-1"></a>                df[<span class="st">"features_has_duplicate_columns"</span>]</span>
<span id="cb53-282"><a href="#cb53-282" aria-hidden="true" tabindex="-1"></a>                <span class="op">|</span> df[<span class="st">"features_has_non_numeric_values"</span>]</span>
<span id="cb53-283"><a href="#cb53-283" aria-hidden="true" tabindex="-1"></a>            ).mean()</span>
<span id="cb53-284"><a href="#cb53-284" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb53-285"><a href="#cb53-285" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-286"><a href="#cb53-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-287"><a href="#cb53-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-288"><a href="#cb53-288" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> stage <span class="kw">in</span> [<span class="st">"Easy"</span>, <span class="st">"Medium"</span>, <span class="st">"Hard"</span>]:</span>
<span id="cb53-289"><a href="#cb53-289" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">[Sanity] </span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-290"><a href="#cb53-290" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> part, dfp <span class="kw">in</span> splits[stage].items():</span>
<span id="cb53-291"><a href="#cb53-291" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>part<span class="sc">:&gt;5s}</span><span class="ss"> -&gt;"</span>, quick_report(dfp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Through this exploratory analysis of 3,458 ConvFinQA records, we‚Äôve established a foundation for curriculum learning in financial reasoning:</p>
<p><strong>Dataset Characteristics:</strong></p>
<ul>
<li>Zero missing data across all fields, with 97-98% of table cells containing clean numeric values</li>
<li>Text context averages ~1,760 characters (80% under 2,800), making it manageable for modern LLMs</li>
<li>Tables are reasonably sized (median 3√ó5 = 15 cells) with 93% of dialogues having ‚â§6 turns</li>
<li>29% contain Type II questions requiring complex table lookup and multi-step reasoning</li>
</ul>
<p><strong>Curriculum Design Framework:</strong></p>
<p>Our six-feature difficulty classification creates three balanced training stages:</p>
<ul>
<li><strong>Easy</strong>: 230 train examples (‚â§2 ops, 2-4 turns, simple context/tables)</li>
<li><strong>Medium</strong>: 300 train examples (2-3 ops or Type II, moderate complexity)</li>
<li><strong>Hard</strong>: 220 train examples (‚â•4 ops, long conversations, large/noisy data)</li>
</ul>
<p><strong>What‚Äôs Next:</strong></p>
<ul>
<li><strong>Modeling</strong>: Implement DSPy baselines across curriculum stages, comparing LLM performance on progressive difficulty</li>
<li><strong>Optimization</strong>: Apply DSPy‚Äôs <em>optimizers</em> with our curriculum strategy to hopefully achieve better results.</li>
</ul>
<p>Spotted a bug or have questions? Open an issue in the repo, or ping me on <a href="https://x.com/shubhamg2208">Twitter/X</a>. Happy hacking!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="goodhamgupta/personal_blog" data-repo-id="R_kgDOLXv-xA" data-category="General" data-category-id="DIC_kwDOLXv-xM4Cdogy" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/goodhamgupta/personal_blog/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer><script>var lightboxQuarto = GLightbox({"selector":".lightbox","openEffect":"zoom","closeEffect":"zoom","descPosition":"bottom","loop":false});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>