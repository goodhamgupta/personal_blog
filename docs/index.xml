<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Shubham Gupta</title>
<link>https://shubhamg.in/</link>
<atom:link href="https://shubhamg.in/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.4.550</generator>
<lastBuildDate>Sun, 31 Aug 2025 16:00:00 GMT</lastBuildDate>
<item>
  <title>Curriculum Learning ü§ù DSPy: Modelling</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2025-09-01-cl-dspy-modelling/2025-09-01-cl-dspy-modelling.html</link>
  <description><![CDATA[ 





<p>In our <a href="../../posts/2025-08-31-cl-dspy-eda.html">previous exploration</a>, we analyzed 3,458 ConvFinQA records and established a curriculum learning framework with three difficulty stages: <strong>Easy</strong> (‚â§2 ops, simple context), <strong>Medium</strong> (2-3 ops, moderate complexity), and <strong>Hard</strong> (‚â•4 ops, complex multi-turn reasoning).</p>
<p>Now it‚Äôs time to put this curriculum to work by implementing and evaluating our models.</p>
<section id="from-prompting-to-programming" class="level2">
<h2 class="anchored" data-anchor-id="from-prompting-to-programming">From Prompting to Programming</h2>
<p>Traditionally, LLM applications rely on hand-rolled prompts‚Äîcarefully crafted text instructions that are often brittle and difficult to optimize, especially for complex multi-step reasoning tasks like financial QA.</p>
<p>Our curriculum learning approach demands systematic experimentation across models, difficulty levels, and optimization strategies. This makes DSPy the ideal framework, as it transforms prompting from an art into systematic, testable code.</p>
<p><strong>Why DSPy for curriculum learning?</strong></p>
<ul>
<li><strong>Reproducible experiments</strong>: Prompts become Python objects ‚Üí diffable, unit-testable, version-controlled</li>
<li><strong>Optimization</strong>: Built-in optimizers (LabeledFewShot, BootstrapFewShot) auto-search the prompt space across our curriculum stages</li>
<li><strong>Clean evaluation pipeline</strong>: First-class metrics support‚Äîplug in exact match, hit .compile(), get train/val loops with curriculum-aware sampling</li>
<li><strong>Model flexibility</strong>: Test curriculum effects across GPT-4, o4-mini, Gemini, and open-source models with one-line swaps</li>
<li><strong>Efficient iteration</strong>: Caching and threading speed up development cycles crucial for curriculum experiments</li>
</ul>
<p>This approach lets us test whether our Easy‚ÜíMedium‚ÜíHard curriculum improves financial reasoning compared to random sampling.</p>
</section>
<section id="evaluation-metrics" class="level2">
<h2 class="anchored" data-anchor-id="evaluation-metrics">Evaluation Metrics</h2>
<p>For this exploratory analysis, we need a clear metric to measure model performance across our curriculum learning experiments. Following the original ConvFinQA paper, we adopt <strong>Exact Match (EM)</strong> as our primary evaluation metric.</p>
<section id="primary-metric-turn-level-em" class="level3">
<h3 class="anchored" data-anchor-id="primary-metric-turn-level-em">Primary Metric: Turn-level EM</h3>
<p><strong>Turn-level EM</strong> measures whether the generated answer for a specific dialogue turn exactly matches the gold standard answer. This binary metric (1 for exact match, 0 otherwise) provides a strict but interpretable measure of performance that directly aligns with the task requirements.</p>
<p>We choose this as our primary metric for several reasons: - <strong>Simplicity</strong>: Easy to implement and interpret for initial experimentation - <strong>Strictness</strong>: Financial reasoning requires precision‚Äîapproximate answers can be misleading - <strong>Comparability</strong>: Direct comparison with baseline results from the original paper - <strong>Curriculum sensitivity</strong>: Clear signal for measuring improvement across difficulty levels</p>
</section>
<section id="additional-metrics-future-work" class="level3">
<h3 class="anchored" data-anchor-id="additional-metrics-future-work">Additional Metrics (Future Work)</h3>
<p>There are several other metrics could be useful:</p>
<p><strong>Conversation-level metrics</strong> like Dialogue Mean EM and Joint EM would better capture multi-turn reasoning dependencies, but add complexity to curriculum design. Since our curriculum is based on individual example difficulty rather than conversation-level complexity, turn-level metrics are more appropriate for this phase.</p>
<p><strong>Diagnostic metrics</strong> such as Exec-agree % and numeric error analysis would help distinguish between reasoning failures and execution errors. However, for establishing whether curriculum learning improves over random sampling, the binary success signal from exact match provides sufficient discriminative power.</p>
<p><strong>Efficiency metrics</strong> like program length and evidence tokens could reveal interesting patterns about how curriculum learning affects model behavior, but are secondary to establishing basic performance improvements.</p>
<p>We‚Äôve skipped the other metrics for now for the sake of brevity.</p>
</section>
</section>
<section id="model-list" class="level2">
<h2 class="anchored" data-anchor-id="model-list">Model List</h2>
<p>We will consider the following <em>families</em> of models:</p>
<table class="table">
<colgroup>
<col style="width: 18%">
<col style="width: 25%">
<col style="width: 56%">
</colgroup>
<thead>
<tr class="header">
<th>Family</th>
<th>Rationale</th>
<th>Benchmarked Checkpoints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Non-Reasoning</strong></td>
<td>Classic next-token predictors. Useful as baselines for curriculum-learning because they expose the value of explicit reasoning.</td>
<td>‚Ä¢ <code>openai/gpt-4.1-2025-04-14</code> <br>‚Ä¢ <code>openai/gpt-4.1-mini-2025-04-14</code></td>
</tr>
<tr class="even">
<td><strong>Reasoning</strong></td>
<td>Architected for multi-step, chain-of-thought inference. Expected to excel once the curriculum introduces compositional tasks.</td>
<td>‚Ä¢ <code>openai/o4-mini-2025-04-16</code> <br>‚Ä¢ <code>anthropic/claude-sonnet-4-20250514</code> <br>‚Ä¢ <code>gemini-2.5-flash</code> <br>‚Ä¢ <code>gemini-2.5-flash-lite</code></td>
</tr>
<tr class="odd">
<td><strong>Frontier</strong></td>
<td>Flagship models from frontier labs. Highest quality but costly‚Äîkept only for upper-bound comparisons, not final deployment.</td>
<td>‚Ä¢ <code>openai/o3-2025-04-16</code> <br>‚Ä¢ <code>anthropic/claude-opus-4-20250514</code> <br>‚Ä¢ <code>gemini-2.5-pro</code></td>
</tr>
<tr class="even">
<td><strong>Open-Source</strong></td>
<td>Critical for cost-sensitive deployments(an OS models FTW). Benchmarked to quantify the closed‚Äìopen gap.</td>
<td>‚Ä¢ <code>qwen3-32b</code></td>
</tr>
</tbody>
</table>
<section id="two-stage-gating-protocol" class="level3">
<h3 class="anchored" data-anchor-id="two-stage-gating-protocol">Two-Stage Gating Protocol</h3>
<ol type="1">
<li><p><strong>Gate</strong><br>
‚Ä¢ Dataset: 50 ‚ÄúEasy‚Äù teacher-forced dialogues<br>
‚Ä¢ Retain a model only if <strong>Turn-EM ‚â• 0.55</strong></p></li>
<li><p><strong>Probe</strong><br>
‚Ä¢ Dataset: 30 dialogues (15 Medium + 15 Hard), closed-loop<br>
‚Ä¢ Retain a model only if <strong>Final-Turn EM ‚â• 0.35</strong> <em>and</em> <strong>Dialogue-mean EM ‚â• 0.35</strong></p></li>
</ol>
<p>This pipeline quickly eliminates weak candidates while preserving models whose strengths surface in longer, reasoning-heavy contexts.</p>
</section>
<section id="experiment-tracking" class="level3">
<h3 class="anchored" data-anchor-id="experiment-tracking">Experiment Tracking</h3>
<p>All training and evaluation runs are logged with <strong>MLflow</strong>:</p>
<ul>
<li>MLflow Tracking ‚Äì run metadata, metrics, and artifacts for DSPy experiments<br>
</li>
<li>MLflow Model ‚Äì package DSPy programs for reproducible rollout<br>
</li>
<li>MLflow Evaluate ‚Äì built-in GenAI evaluators for rapid iteration<br>
</li>
<li>MLflow Tracing ‚Äì one-line capture of DSPy internals for debugging</li>
</ul>
<p>In production, the deployment pipeline would look as follows:</p>
<p align="center">
, <img src="https://shubhamg.in/posts/cl_dspy/mlflow_dspy.png" alt="DSPy Production deployment with MLFlow. Source: DSPy Docs" width="200" height="300">, <br>, <sub>, DSPy Production deployment with MLFlow. Source: <a href="https://mlflow.org/docs/latest/genai/flavors/dspy/">MLFlow Docs</a>, </sub>,
</p>
</section>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div id="cell-7" class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> mlflow</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> IFrame, HTML, display</span>
<span id="cb1-3"></span>
<span id="cb1-4">mlflow.set_tracking_uri(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://localhost:5000"</span>)</span>
<span id="cb1-5">mlflow.dspy.autolog(log_compiles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, log_evals<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, log_traces_from_compile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-6">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mlflow.set_experiment(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DSPy"</span>)</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display MLFlow UI in an iframe to prevent HTML document conflicts</span></span>
<span id="cb1-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Experiment: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (ID: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>experiment_id<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb1-10">display(HTML(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'&lt;p&gt;&lt;a href="http://localhost:5000/#/experiments/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>experiment_id<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">" target="_blank"&gt;View MLFlow Experiment UI&lt;/a&gt;&lt;/p&gt;'</span>))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>&lt;Experiment: artifact_location='mlflow-artifacts:/1', creation_time=1753611058221, experiment_id='1', last_update_time=1753611058221, lifecycle_stage='active', name='DSPy', tags={}&gt;</code></pre>
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dotenv</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dspy</span>
<span id="cb3-5"></span>
<span id="cb3-6">dotenv.load_dotenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../.env"</span>)</span>
<span id="cb3-7">MAX_TOKENS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20_000</span></span>
<span id="cb3-8"></span>
<span id="cb3-9">lm_oai_gpt_4_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.LM(</span>
<span id="cb3-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-4.1-2025-04-14"</span>,</span>
<span id="cb3-11">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-12">    max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_TOKENS,</span>
<span id="cb3-13">)</span>
<span id="cb3-14">lm_oai_gpt_4_1_mini <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.LM(</span>
<span id="cb3-15">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/gpt-4.1-mini-2025-04-14"</span>,</span>
<span id="cb3-16">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-17">    max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_TOKENS,</span>
<span id="cb3-18">)</span>
<span id="cb3-19"></span>
<span id="cb3-20">lm_oai_o4_mini <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.LM(</span>
<span id="cb3-21">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/o4-mini-2025-04-16"</span>,</span>
<span id="cb3-22">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-23">    temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,</span>
<span id="cb3-24">    max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_TOKENS,</span>
<span id="cb3-25">)</span>
<span id="cb3-26">lm_anthropic_sonnet_4_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.LM(</span>
<span id="cb3-27">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"anthropic/claude-sonnet-4-20250514"</span>,</span>
<span id="cb3-28">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ANTHROPIC_API_KEY"</span>],</span>
<span id="cb3-29">    max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_TOKENS,</span>
<span id="cb3-30">)</span>
<span id="cb3-31">lm_gemini_flash_2_5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.LM(</span>
<span id="cb3-32">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini/gemini-2.5-flash"</span>,</span>
<span id="cb3-33">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GEMINI_API_KEY"</span>],</span>
<span id="cb3-34">    max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_TOKENS,</span>
<span id="cb3-35">)</span>
<span id="cb3-36">lm_gemini_flash_2_5_lite <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.LM(</span>
<span id="cb3-37">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini/gemini-2.5-flash-lite"</span>,</span>
<span id="cb3-38">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GEMINI_API_KEY"</span>],</span>
<span id="cb3-39">    max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_TOKENS,</span>
<span id="cb3-40">)</span>
<span id="cb3-41"></span>
<span id="cb3-42">lm_oai_o3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.LM(</span>
<span id="cb3-43">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai/o3-2025-04-16"</span>,</span>
<span id="cb3-44">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENAI_API_KEY"</span>],</span>
<span id="cb3-45">    temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,</span>
<span id="cb3-46">    max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_TOKENS,</span>
<span id="cb3-47">)</span>
<span id="cb3-48">lm_anthropic_opus_4_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.LM(</span>
<span id="cb3-49">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"anthropic/claude-opus-4-20250514"</span>,</span>
<span id="cb3-50">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ANTHROPIC_API_KEY"</span>],</span>
<span id="cb3-51">    max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_TOKENS,</span>
<span id="cb3-52">)</span>
<span id="cb3-53">lm_gemini_pro_2_5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.LM(</span>
<span id="cb3-54">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini/gemini-2.5-pro"</span>,</span>
<span id="cb3-55">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GEMINI_API_KEY"</span>],</span>
<span id="cb3-56">    max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_TOKENS,</span>
<span id="cb3-57">)</span>
<span id="cb3-58"></span>
<span id="cb3-59">lm_qwen3_32b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.LM(</span>
<span id="cb3-60">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ollama/qwen3:32b"</span>,</span>
<span id="cb3-61">    api_base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://localhost:11434"</span>,</span>
<span id="cb3-62">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,</span>
<span id="cb3-63">    max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MAX_TOKENS,</span>
<span id="cb3-64">)</span></code></pre></div>
</div>
<div id="cell-9" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dspy</span>
<span id="cb4-2"></span>
<span id="cb4-3">llms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb4-4">    lm_oai_gpt_4_1,</span>
<span id="cb4-5">    lm_oai_gpt_4_1_mini,</span>
<span id="cb4-6">    lm_oai_o4_mini,</span>
<span id="cb4-7">    lm_anthropic_sonnet_4_0,</span>
<span id="cb4-8">    lm_gemini_flash_2_5,</span>
<span id="cb4-9">    lm_gemini_flash_2_5_lite,</span>
<span id="cb4-10">    lm_oai_o3,</span>
<span id="cb4-11">    lm_anthropic_opus_4_0,</span>
<span id="cb4-12">    lm_gemini_pro_2_5,</span>
<span id="cb4-13">    lm_qwen3_32b,</span>
<span id="cb4-14">]</span>
<span id="cb4-15"></span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Echo(dspy.Signature):</span>
<span id="cb4-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Echoes the input prompt."""</span></span>
<span id="cb4-19"></span>
<span id="cb4-20">    prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.InputField()</span>
<span id="cb4-21">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.OutputField()</span>
<span id="cb4-22"></span>
<span id="cb4-23"></span>
<span id="cb4-24"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> mlflow.start_run(run_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Setup"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> run:</span>
<span id="cb4-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> lm <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> llms:</span>
<span id="cb4-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb4-27">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> dspy.context(lm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lm, track_usage<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, cache<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb4-28">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> lm <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [lm_oai_gpt_4_1, lm_oai_gpt_4_1_mini]:</span>
<span id="cb4-29">                    program <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.Predict(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"instruction -&gt; answer"</span>)</span>
<span id="cb4-30">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb4-31">                    program <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dspy.ChainOfThought(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"instruction -&gt; answer"</span>)</span>
<span id="cb4-32">                response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> program(instruction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the date?"</span>)</span>
<span id="cb4-33">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(response, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reasoning"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb4-34">                    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> Reasoning: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>response<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>reasoning<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-35">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>response<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>answer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb4-37">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(lm, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'model'</span>, lm)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: ERROR - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>openai/gpt-4.1-2025-04-14: Today's date is June 13, 2024.
openai/gpt-4.1-mini-2025-04-14: The current date is June 15, 2024.
openai/o4-mini-2025-04-16 Reasoning: The user asked for the current date. I will provide today's date in a clear, human-readable format.
openai/o4-mini-2025-04-16: The current date is May 30, 2024.
anthropic/claude-sonnet-4-20250514 Reasoning: The user is asking for the current date. However, I don't have access to real-time information or the ability to know what the current date is. I should explain that I cannot provide the current date and suggest how they can find this information.
anthropic/claude-sonnet-4-20250514: I don't have access to real-time information, so I cannot tell you the current date. To find today's date, you can:
- Check your computer, phone, or other device
- Search "what is today's date" in a search engine
- Ask a voice assistant like Siri, Alexa, or Google Assistant
gemini/gemini-2.5-flash Reasoning: The user is asking for the current date. I will provide today's date.
gemini/gemini-2.5-flash: June 10, 2024
gemini/gemini-2.5-flash-lite Reasoning: The user is asking for the current date. I need to access the current date and format it as requested.
gemini/gemini-2.5-flash-lite: The current date is October 26, 2023.
openai/o3-2025-04-16 Reasoning: I don‚Äôt have real-time access to the system clock, so I‚Äôm unable to determine the exact current date at the moment of this response.
openai/o3-2025-04-16: I‚Äôm sorry, I don‚Äôt have access to real-time information to tell today‚Äôs date.
anthropic/claude-opus-4-20250514 Reasoning: The user is asking for the current date. However, as an AI assistant, I don't have access to real-time information and cannot provide the current date. I should explain this limitation clearly to the user.
anthropic/claude-opus-4-20250514: I don't have access to real-time information, so I cannot tell you today's date. To get the current date, you can check your device's calendar, search "what's today's date" in a search engine, or ask a voice assistant with real-time capabilities.
gemini/gemini-2.5-pro Reasoning: The user has asked for the current date. I will access my internal system's real-time clock to provide the current calendar date.
gemini/gemini-2.5-pro: Today's date is September 10, 2024.
ollama/qwen3:32b Reasoning: I cannot access real-time data or the current date. My knowledge is static and up to July 2024. To find the current date, please check your device's clock or calendar.
ollama/qwen3:32b: I cannot provide the current date as I do not have access to real-time information. Please check your device's clock or calendar for the current date.
üèÉ View run Setup at: http://localhost:5000/#/experiments/1/runs/20df48ca1ad2461d9dcc0b1575caec6d
üß™ View experiment at: http://localhost:5000/#/experiments/1</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped="">
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
  <button onclick="
        const display = this.nextElementSibling.style.display;
        const isCollapsed = display === 'none';
        this.nextElementSibling.style.display = isCollapsed ? null : 'none';

        const verb = isCollapsed ? 'Collapse' : 'Expand';
        this.innerText = `${verb} MLflow Trace`;
    ">Collapse MLflow Trace</button>
  <iframe id="trace-renderer" style="width: 100%; height: 500px; border: none; resize: vertical;" src="http://localhost:5000/static-files/lib/notebook-trace-renderer/index.html?trace_id=3be570b5035f48159f5f6f8b102b3565&amp;experiment_id=1&amp;trace_id=5ef345c76c844b5786e8d8d54b9de2c6&amp;experiment_id=1&amp;trace_id=9e5a6b35374a4fbc8cbc10bcf48a9765&amp;experiment_id=1&amp;trace_id=f54a2f585a8248feb6f8b0e56b6821ca&amp;experiment_id=1&amp;trace_id=7d0291783ca34ac3a2304daa01790993&amp;experiment_id=1&amp;trace_id=7d7c7c7e1e534a6abdcba8718079d6e1&amp;experiment_id=1&amp;trace_id=0a13673c74a146c4b6fdbfde935a0390&amp;experiment_id=1&amp;trace_id=0e3ebc3c4d1d4d4e8b2cef92e92d608a&amp;experiment_id=1&amp;trace_id=c5866268627d4319a05eb6af34b78672&amp;experiment_id=1&amp;trace_id=1f253b525ef547649472ffd87573560d&amp;experiment_id=1&amp;version=3.1.4">
</div>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="11">
<div class="sourceCode" id="cb6"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="st">&quot;../data/convfinqa_dataset.json&quot;</span>))</span></code></pre></div>
</div>
</section>
<section id="model-selection" class="level2">
<h2>Model Selection</h2>
<p>In the <strong>easy</strong> problems stage, we will select a relatively straightforward implementation. Specifically, we will provide the model with all context, and ask it to answer the question in a zero-shot manner.</p>
<p>This will help us identify strong baseline performance, and identify any issues with the model‚Äôs ability to understand the problem.</p>
<p>First, we will create the DSPy signatures for our dataset. Signatures are used to define the input and output of a model.</p>
<p>Specifically, we will have two types of signatures: one that doesn‚Äôt support reasoning model(for direct prediction models like GPT-4.1), and one that does support reasoning mode(for the reasoning models like o3, gemini pro, etc.)</p>
<div id="cell-13" class="cell" data-execution_count="260">
<div class="sourceCode" id="cb7"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SolveTurnWithoutReasoning(dspy.Signature):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    conversation_context: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">&quot;Conversation so far&quot;</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    evidence_snippets: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Snippets of evidence surrounding the table&quot;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    table: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">&quot;Input financial table with metrics&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    question: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">&quot;Question to answer&quot;</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    ops: <span class="bu">str</span> <span class="op">=</span> dspy.OutputField(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Comma-separated ConvFinQA DSL program. Allowed ops: add(x, y), subtract(x, y), multiply(x, y), divide(x, y), exp(x, y), greater(x, y). Args may be constants (e.g., const_100), numbers (int or float), or prior step refs (#0, #1‚Ä¶). Order always follows the pattern x &lt;op&gt; y‚Äîpick x and y deliberately. Example: subtract(const_100, 42), divide(#0, 3.14). Convert to percentages only if explicitly asked in the question.&quot;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    answer: <span class="bu">str</span> <span class="op">=</span> dspy.OutputField(</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Final answer. This will be a single number, or a boolean string(yes/no)&quot;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SolveTurnWithReasoning(dspy.Signature):</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    conversation_context: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">&quot;Conversation so far&quot;</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    evidence_snippets: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Snippets of evidence surrounding the table&quot;</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    table: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">&quot;Input financial table with metrics&quot;</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    question: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">&quot;Question to answer&quot;</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    reasoning: <span class="bu">str</span> <span class="op">=</span> dspy.OutputField(</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Reasoning behind the answer. Carefully analyze the conversation_context, and especially the evidence_snippets and table for the given question, and generate your reasoning before generating the ops and answer.&quot;</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    ops: <span class="bu">str</span> <span class="op">=</span> dspy.OutputField(</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Comma-separated ConvFinQA DSL program. Allowed ops: add(x, y), subtract(x, y), multiply(x, y), divide(x, y), exp(x, y), greater(x, y). Args may be constants (e.g., const_100), numbers (int or float), or prior step refs (#0, #1‚Ä¶). Order always follows the pattern x &lt;op&gt; y‚Äîpick x and y deliberately. Example: subtract(const_100, 42), divide(#0, 3.14). Convert to percentages only if explicitly asked in the question.&quot;</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    answer: <span class="bu">str</span> <span class="op">=</span> dspy.OutputField(</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Final answer. This will be a single number, or a boolean string(yes/no)&quot;</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TurnSolver(dspy.Module):</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="co">    In the context of this series of interconnected finance-related queries and the additional information provided by the pretext, table data, and posttext from a company&#39;s financial filings, please provide a response to the final question. This may require extracting information from the context and performing mathematical calculations. Please take into account the information provided in the preceding questions and their answers when formulating your response: </span><span class="ch">\n\n</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, reasoning_lm<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> reasoning_lm:</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.pred <span class="op">=</span> dspy.ChainOfThought(SolveTurnWithReasoning)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.pred <span class="op">=</span> dspy.Predict(SolveTurnWithoutReasoning)</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, conversation_context, evidence_snippets, table, question):</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="co">        Run the model to solve a single turn.</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="co">            conversation_context (str): Conversation so far.</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a><span class="co">            evidence_snippets (str): Evidence text around the table.</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a><span class="co">            table (str): Financial table in markdown.</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="co">            question (str): Question to answer.</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a><span class="co">            dspy.Prediction: Model output with reasoning, ops, and answer.</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.pred(</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>            conversation_context<span class="op">=</span>conversation_context,</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>            evidence_snippets<span class="op">=</span>evidence_snippets,</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>            table<span class="op">=</span>table,</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>            question<span class="op">=</span>question,</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
</div>
<p>Next, we define a few helper functions to format our dataset for the DSPy model. We intentionally don‚Äôt spend too much time here for now, and will come back to this later, during the <em>optimization</em> phase.</p>
<div id="cell-15" class="cell" data-execution_count="405">
<div class="sourceCode" id="cb8"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> norm_ans(x):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Normalize an answer for comparison.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Converts input to string, strips whitespace, removes percent signs,</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">    and attempts to cast to float. If conversion fails, returns the cleaned string.</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">        x: The answer to normalize (str, float, or int).</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">        float or str: Normalized float if possible, else cleaned string.</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(x).strip().replace(<span class="st">&quot;%&quot;</span>, <span class="st">&quot;&quot;</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(s)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> s</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _table_md(table_dict: <span class="bu">dict</span>, max_cols: <span class="bu">int</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert a dictionarised table to compact GitHub-markdown.</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Accepted shapes</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co">    1) {row_name: {col_name: value, ‚Ä¶}, ‚Ä¶}   # regular 2-level mapping</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co">    2) {col_name: value, ‚Ä¶}                  # flat ‚Üí coerced to single row</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co">    Guarantees</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co">    ‚Ä¢ Original row order is kept.</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co">    ‚Ä¢ Column headers are kept in *first-seen* order; NO deduplication.</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co">    ‚Ä¢ max_cols (if given) truncates *after* enumeration, duplicates included.</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co">    ‚Ä¢ None ‚Üí &quot;&quot; and everything else is str()-ed.</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> table_dict:</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;&quot;</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">all</span>(<span class="kw">not</span> <span class="bu">isinstance</span>(v, <span class="bu">dict</span>) <span class="cf">for</span> v <span class="kw">in</span> table_dict.values()):</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># flat mapping ‚Üí one anonymous row</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        table_dict <span class="op">=</span> {<span class="st">&quot;&quot;</span>: <span class="bu">dict</span>(table_dict)}</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ensure every value is a dict</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        table_dict <span class="op">=</span> {</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>            r: (v <span class="cf">if</span> <span class="bu">isinstance</span>(v, <span class="bu">dict</span>) <span class="cf">else</span> {<span class="st">&quot;&quot;</span>: v}) <span class="cf">for</span> r, v <span class="kw">in</span> table_dict.items()</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    row_ids <span class="op">=</span> <span class="bu">list</span>(table_dict.keys())  <span class="co"># preserve caller order</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    cols: <span class="bu">list</span> <span class="op">=</span> []</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> row_ids:</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        cols.extend(table_dict[r].keys())</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> max_cols <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        cols <span class="op">=</span> cols[:max_cols]</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    header <span class="op">=</span> <span class="st">&quot;| Row | &quot;</span> <span class="op">+</span> <span class="st">&quot; | &quot;</span>.join(<span class="bu">map</span>(<span class="bu">str</span>, cols)) <span class="op">+</span> <span class="st">&quot; |&quot;</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    sep <span class="op">=</span> <span class="st">&quot;|&quot;</span> <span class="op">+</span> <span class="st">&quot;---|&quot;</span> <span class="op">*</span> (<span class="bu">len</span>(cols) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> [header, sep]</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> row_ids:</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>        vals <span class="op">=</span> [<span class="bu">str</span>(table_dict[r].get(c, <span class="st">&quot;&quot;</span>)) <span class="cf">for</span> c <span class="kw">in</span> cols]</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        lines.append(<span class="st">&quot;| &quot;</span> <span class="op">+</span> <span class="bu">str</span>(r) <span class="op">+</span> <span class="st">&quot; | &quot;</span> <span class="op">+</span> <span class="st">&quot; | &quot;</span>.join(vals) <span class="op">+</span> <span class="st">&quot; |&quot;</span>)</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(lines)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_inputs_from_row(</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    row,</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    turn_idx,</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>,</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    history_mode: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;teacher&quot;</span>,</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    state: <span class="bu">dict</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    max_table_cols: <span class="bu">int</span> <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="co">    history_mode: &#39;teacher&#39; | &#39;model&#39; | &#39;none&#39;</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a><span class="co">    state: carries model predictions across turns when history_mode=&#39;model&#39;</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a><span class="co">           expected keys: {&#39;pred_answers&#39;: list[str|float]}</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="co">    evidence_builder: optional callable(row, turn_idx)-&gt;str; if None, use simple truncation.</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>    qs <span class="op">=</span> row[<span class="st">&quot;dialogue_conv_questions&quot;</span>]</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>    gold <span class="op">=</span> row[<span class="st">&quot;dialogue_executed_answers&quot;</span>]</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- history ----</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    history_lines <span class="op">=</span> []</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(turn_idx):</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>        history_lines.append(<span class="ss">f&quot;Q</span><span class="sc">{</span>t <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>qs[t]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> history_mode <span class="op">==</span> <span class="st">&quot;teacher&quot;</span>:</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>            history_lines.append(<span class="ss">f&quot;A</span><span class="sc">{</span>t <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>gold[t]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> (</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>            history_mode <span class="op">==</span> <span class="st">&quot;model&quot;</span> <span class="kw">and</span> state <span class="kw">and</span> <span class="bu">len</span>(state.get(<span class="st">&quot;pred_answers&quot;</span>, [])) <span class="op">&gt;</span> t</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>        ):</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>            history_lines.append(<span class="ss">f&quot;A</span><span class="sc">{</span>t <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>state[<span class="st">&#39;pred_answers&#39;</span>][t]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> history_mode <span class="op">==</span> <span class="st">&quot;none&quot;</span>:</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span>  <span class="co"># only questions</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>    conversation_context <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(history_lines) <span class="cf">if</span> history_lines <span class="cf">else</span> <span class="st">&quot;None&quot;</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compact pre/post: first N sentences</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># def first_sents(txt, n):</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     if not txt: return &quot;&quot;</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     # very light sentence split</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     parts = [p.strip() for p in txt.split(&quot;. &quot;) if p.strip()]</span></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     return &quot;. &quot;.join(parts[:n])</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pre = first_sents(row.get(&quot;doc_pre_text&quot;, &quot;&quot;) or &quot;&quot;, max_pre_sents)</span></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># post= first_sents(row.get(&quot;doc_post_text&quot;, &quot;&quot;) or &quot;&quot;, max_post_sents)</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># evidence_snippets = f&quot;[PRE]\n{pre}\n[/PRE]\n[POST]\n{post}\n[/POST]&quot;</span></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>    evidence_snippets <span class="op">=</span> (</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f&quot;[PRE]</span><span class="ch">\n</span><span class="sc">{</span>row[<span class="st">&#39;doc_pre_text&#39;</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">[/PRE]</span><span class="ch">\n</span><span class="ss">[POST]</span><span class="ch">\n</span><span class="sc">{</span>row[<span class="st">&#39;doc_post_text&#39;</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">[/POST]&quot;</span></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>    table_md <span class="op">=</span> _table_md(row.get(<span class="st">&quot;doc_table&quot;</span>, {}) <span class="kw">or</span> {}, max_cols<span class="op">=</span>max_table_cols)</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>        conversation_context<span class="op">=</span>conversation_context,</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>        evidence_snippets<span class="op">=</span>evidence_snippets,</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>        table<span class="op">=</span>table_md,</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>        question<span class="op">=</span>qs[turn_idx],</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>        <span class="op">**</span>row,</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
</div>
<div id="cell-16" class="cell" data-execution_count="406">
<div class="sourceCode" id="cb9"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_dialogues(model, df):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Evaluate a dialogue model on a DataFrame of conversations.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">        model: Callable that takes unpacked input dict and returns an object with at least `.answer` (and optionally `.ops`).</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">        df: pd.DataFrame with columns:</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">            - &quot;dialogue_conv_questions&quot;: list of str, all questions in the conversation</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">            - &quot;dialogue_executed_answers&quot;: list of str/float, all executed answers so far</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">            - (other columns as needed by evidence_builder)</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">        dict with:</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">            - &quot;turn_em_micro&quot;: float, micro-averaged exact match over all turns</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">            - &quot;dlg_mean_em_macro&quot;: float, macro-averaged mean EM per dialogue</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">            - &quot;joint_em&quot;: float, fraction of dialogues with all turns correct</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co">            - &quot;final_turn_em&quot;: float, EM on the final turn of each dialogue</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">            - &quot;n_dialogues&quot;: int, number of dialogues</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">            - &quot;n_turns&quot;: int, total number of turns</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    turn_hits <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    turn_tot <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># exec_hits = 0</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    dlg_mean_ems <span class="op">=</span> []</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    dlg_joint_hits <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    final_hits <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        qs <span class="op">=</span> row[<span class="st">&quot;dialogue_conv_questions&quot;</span>]</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        gold <span class="op">=</span> row[<span class="st">&quot;dialogue_executed_answers&quot;</span>]</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        ems <span class="op">=</span> []</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        exec_flags <span class="op">=</span> []</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(qs)):</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>            inp <span class="op">=</span> build_inputs_from_row(row, t)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> model(<span class="op">**</span>inp)  <span class="co"># out.ops, out.answer</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>            pa <span class="op">=</span> norm_ans(out.answer)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>            ga <span class="op">=</span> norm_ans(gold[t])</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>            em <span class="op">=</span> <span class="bu">float</span>(pa <span class="op">==</span> ga)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>            ems.append(em)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>            turn_hits <span class="op">+=</span> em</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>            turn_tot <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># (optional) exec check if you have your python DSL evaluator:</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># exec_ok = False</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># try:</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     # exec_ok = (run_dsl(out.ops, inp) == ga)   # plug your interpreter</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     exec_ok = False</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># except Exception:</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     exec_ok = False</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># exec_flags.append(exec_ok)</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>            <span class="co"># exec_hits += float(exec_ok)</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>        dlg_mean_ems.append(<span class="bu">sum</span>(ems) <span class="op">/</span> <span class="bu">len</span>(ems))</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">all</span>(v <span class="op">==</span> <span class="fl">1.0</span> <span class="cf">for</span> v <span class="kw">in</span> ems):</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>            dlg_joint_hits <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>        final_hits <span class="op">+=</span> ems[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;turn_em_micro&quot;</span>: turn_hits <span class="op">/</span> <span class="bu">max</span>(<span class="dv">1</span>, turn_tot),</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;dlg_mean_em_macro&quot;</span>: <span class="bu">sum</span>(dlg_mean_ems) <span class="op">/</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(dlg_mean_ems)),</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;joint_em&quot;</span>: dlg_joint_hits <span class="op">/</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(dlg_mean_ems)),</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;final_turn_em&quot;</span>: final_hits <span class="op">/</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(dlg_mean_ems)),</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># &quot;exec_agree_rate&quot;: exec_hits / max(1, turn_tot),</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;n_dialogues&quot;</span>: <span class="bu">len</span>(dlg_mean_ems),</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;n_turns&quot;</span>: turn_tot,</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
</div>
<p>Next, we will create the DSPy metric, used to <em>evaluate</em> the performance of our model.</p>
<p>We will focus on 2 parts to our metric: - If the answer is a floating point number, we will aim to compare it with the ground truth with some tolerance. - If the answer is a string, we will aim to perform <strong>exact match</strong> via DSPy‚Äôs <code>exact_match</code> metric.</p>
<div id="cell-18" class="cell" data-execution_count="407">
<div class="sourceCode" id="cb10"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> turn_em_metric(example, pred, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute turn-level exact match (EM) metric for a single example/prediction pair.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">        example: dict-like, must contain &quot;gold_answer&quot; key.</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">        pred: object with an &quot;answer&quot; attribute.</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">        float: 1.0 if normalized prediction matches normalized gold answer (with tolerance for floats), else 0.0.</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> dspy.evaluate.metrics <span class="im">import</span> answer_exact_match</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    pa <span class="op">=</span> norm_ans(pred.answer)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    ga <span class="op">=</span> norm_ans(example[<span class="st">&quot;answer&quot;</span>])</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(pa, <span class="bu">float</span>) <span class="kw">and</span> <span class="bu">isinstance</span>(ga, <span class="bu">float</span>):</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(<span class="bu">abs</span>(pa <span class="op">-</span> ga) <span class="op">&lt;=</span> <span class="fl">1e-2</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># exact_match in DSPy needs the inputs to be in string format</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># due to the normalisations DSPy performs internally.</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        ground_truth <span class="op">=</span> dspy.Prediction(answer<span class="op">=</span><span class="bu">str</span>(example.answer))</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        pred_answer <span class="op">=</span> dspy.Prediction(answer<span class="op">=</span><span class="bu">str</span>(pred.answer))</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(answer_exact_match(ground_truth, pred_answer))</span></code></pre></div>
</div>
<div id="cell-19" class="cell" data-execution_count="408">
<div class="sourceCode" id="cb11"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_turn_examples(df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    examples <span class="op">=</span> []</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        qs <span class="op">=</span> row[<span class="st">&quot;dialogue_conv_questions&quot;</span>]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        gold <span class="op">=</span> row[<span class="st">&quot;dialogue_executed_answers&quot;</span>]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(qs)):</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>            inp <span class="op">=</span> build_inputs_from_row(row, t, history_mode<span class="op">=</span>history_mode)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>            ex <span class="op">=</span> <span class="bu">dict</span>(<span class="op">**</span>inp, answer<span class="op">=</span>gold[t])</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            examples.append(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                dspy.Example(<span class="op">**</span>ex).with_inputs(</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;conversation_context&quot;</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;evidence_snippets&quot;</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;table&quot;</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;question&quot;</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> examples</span></code></pre></div>
</div>
<p>Next, we will prepare our datasets.</p>
<p>We will aim to use the splits as follows: - <code>train</code>: Used primarily for the <em>optimisation</em> phase. This will be discussed shortly. - <code>valid</code>: Used to evaluate the performance of an LM on an optimised model <em>trained</em> using the train dataset. - <code>test</code>: Used to evaluate the performance of an LM on a held-out dataset. This will determine the overall stage performance.</p>
<div id="cell-21" class="cell" data-execution_count="409">
<div class="sourceCode" id="cb12"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.DataFrame(data[<span class="st">&quot;train&quot;</span>])</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame(data[<span class="st">&quot;dev&quot;</span>])</span></code></pre></div>
</div>
<div id="cell-22" class="cell" data-execution_count="410">
<div class="sourceCode" id="cb13"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten features to remove the indexing gymnastics</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>train_flat_df <span class="op">=</span> pd.concat(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        train_df.drop([<span class="st">&quot;doc&quot;</span>, <span class="st">&quot;dialogue&quot;</span>, <span class="st">&quot;features&quot;</span>], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">&quot;doc&quot;</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">&quot;doc_&quot;</span>),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">&quot;dialogue&quot;</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">&quot;dialogue_&quot;</span>),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        train_df[<span class="st">&quot;features&quot;</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">&quot;features_&quot;</span>),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>test_flat_df <span class="op">=</span> pd.concat(</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        test_df.drop([<span class="st">&quot;doc&quot;</span>, <span class="st">&quot;dialogue&quot;</span>, <span class="st">&quot;features&quot;</span>], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">&quot;doc&quot;</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">&quot;doc_&quot;</span>),</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">&quot;dialogue&quot;</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">&quot;dialogue_&quot;</span>),</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        test_df[<span class="st">&quot;features&quot;</span>].<span class="bu">apply</span>(pd.Series).add_prefix(<span class="st">&quot;features_&quot;</span>),</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="cell-23" class="cell" data-execution_count="411">
<div class="sourceCode" id="cb14"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>train_flat_df.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="411">
<div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header" style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">doc_pre_text</th>
<th data-quarto-table-cell-role="th">doc_post_text</th>
<th data-quarto-table-cell-role="th">doc_table</th>
<th data-quarto-table-cell-role="th">dialogue_conv_questions</th>
<th data-quarto-table-cell-role="th">dialogue_conv_answers</th>
<th data-quarto-table-cell-role="th">dialogue_turn_program</th>
<th data-quarto-table-cell-role="th">dialogue_executed_answers</th>
<th data-quarto-table-cell-role="th">dialogue_qa_split</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Single_JKHY/2009/page_28.pdf-3</td>
<td>26 | 2009 annual report in fiscal 2008 , revenues in the credit un...</td>
<td>year ended june 30 , cash provided by operations increased $ 25587...</td>
<td>{'Year ended June 30, 2009': {'net income': 103102.0, 'non-cash ex...</td>
<td>[what is the net cash from operating activities in 2009?, what abo...</td>
<td>[206588, 181001, 25587, 14.1%]</td>
<td>[206588, 181001, subtract(206588, 181001), subtract(206588, 181001...</td>
<td>[206588.0, 181001.0, 25587.0, 0.14136]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Single_RSG/2008/page_114.pdf-2</td>
<td>substantially all of the goodwill and other intangible assets reco...</td>
<td>the above unaudited pro forma financial information includes adjus...</td>
<td>{'year ended december 31 2008 ( unaudited )': {'revenue': 9362.2, ...</td>
<td>[what were revenues in 2008?, what were they in 2007?, what was th...</td>
<td>[9362.2, 9244.9, 117.3, 1.3%]</td>
<td>[9362.2, 9244.9, subtract(9362.2, 9244.9), subtract(9362.2, 9244.9...</td>
<td>[9362.2, 9244.9, 117.3, 0.01269]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Single_AAPL/2002/page_23.pdf-1</td>
<td>in a new business model such as the retail segment is inherently r...</td>
<td>.</td>
<td>{'2002': {'net sales': 5742.0, 'cost of sales': 4139.0, 'gross mar...</td>
<td>[what was the total of net sales in 2001?, and what was that in 20...</td>
<td>[5363, 7983, -2620, -32%]</td>
<td>[5363, 7983, subtract(5363, 7983), subtract(5363, 7983), divide(#0...</td>
<td>[5363.0, 7983.0, -2620.0, -0.3282]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Single_UPS/2009/page_33.pdf-2</td>
<td>( 1 ) includes shares repurchased through our publicly announced s...</td>
<td>.</td>
<td>{'12/31/04': {'united parcel service inc .': 100.0, 's&amp;p 500 index...</td>
<td>[what was the change in the performance of the united parcel servi...</td>
<td>[-24.05, -24.05%, 102.11, 2.11, 2.11%, -26.16%]</td>
<td>[subtract(75.95, const_100), subtract(75.95, const_100), divide(#0...</td>
<td>[-24.05, -0.2405, 102.11, 2.11, 0.0211, -0.2616]</td>
<td>[False, False, False, False, False, False]</td>
<td>6</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Double_UPS/2009/page_33.pdf</td>
<td>( 1 ) includes shares repurchased through our publicly announced s...</td>
<td>.</td>
<td>{'12/31/04': {'united parcel service inc .': 100.0, 's&amp;p 500 index...</td>
<td>[what was the fluctuation of the performance price of the ups from...</td>
<td>[-8.94, -8.9%, -24.05, -24.05%, 2.11, 2.11%, -26.16%]</td>
<td>[subtract(91.06, const_100), subtract(91.06, const_100), divide(#0...</td>
<td>[-8.94, -0.0894, -24.05, -0.2405, 2.11, 0.0211, -0.2616]</td>
<td>[False, False, True, True, True, True, True]</td>
<td>7</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-24" class="cell" data-execution_count="412">
<div class="sourceCode" id="cb15"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>easy_train_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;./splits/easy_train.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>easy_valid_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;./splits/easy_valid.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>easy_test_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;./splits/easy_test.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>medium_train_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;./splits/medium_train.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>medium_valid_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;./splits/medium_valid.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>medium_test_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;./splits/medium_test.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>hard_train_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;./splits/hard_train.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>hard_valid_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;./splits/hard_valid.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>hard_test_ids <span class="op">=</span> pd.read_json(<span class="st">&quot;./splits/hard_test.jsonl&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>easy_train_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">&quot;id&quot;</span>].isin(easy_train_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>easy_valid_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">&quot;id&quot;</span>].isin(easy_valid_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>easy_test_df <span class="op">=</span> test_flat_df[test_flat_df[<span class="st">&quot;id&quot;</span>].isin(easy_test_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>medium_train_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">&quot;id&quot;</span>].isin(medium_train_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>medium_valid_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">&quot;id&quot;</span>].isin(medium_valid_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>medium_test_df <span class="op">=</span> test_flat_df[test_flat_df[<span class="st">&quot;id&quot;</span>].isin(medium_test_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>hard_train_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">&quot;id&quot;</span>].isin(hard_train_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>hard_valid_df <span class="op">=</span> train_flat_df[train_flat_df[<span class="st">&quot;id&quot;</span>].isin(hard_valid_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>hard_test_df <span class="op">=</span> test_flat_df[test_flat_df[<span class="st">&quot;id&quot;</span>].isin(hard_test_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> easy_train_ids.shape[<span class="dv">0</span>] <span class="op">==</span> easy_train_df.shape[<span class="dv">0</span>]</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> easy_valid_ids.shape[<span class="dv">0</span>] <span class="op">==</span> easy_valid_df.shape[<span class="dv">0</span>]</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> easy_test_ids.shape[<span class="dv">0</span>] <span class="op">==</span> easy_test_df.shape[<span class="dv">0</span>]</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> medium_train_ids.shape[<span class="dv">0</span>] <span class="op">==</span> medium_train_df.shape[<span class="dv">0</span>]</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> medium_valid_ids.shape[<span class="dv">0</span>] <span class="op">==</span> medium_valid_df.shape[<span class="dv">0</span>]</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> medium_test_ids.shape[<span class="dv">0</span>] <span class="op">==</span> medium_test_df.shape[<span class="dv">0</span>]</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> hard_train_ids.shape[<span class="dv">0</span>] <span class="op">==</span> hard_train_df.shape[<span class="dv">0</span>]</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> hard_valid_ids.shape[<span class="dv">0</span>] <span class="op">==</span> hard_valid_df.shape[<span class="dv">0</span>]</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> hard_test_ids.shape[<span class="dv">0</span>] <span class="op">==</span> hard_test_df.shape[<span class="dv">0</span>]</span></code></pre></div>
</div>
<div id="cell-25" class="cell" data-execution_count="413">
<div class="sourceCode" id="cb16"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>easy_train_examples <span class="op">=</span> to_turn_examples(easy_train_df)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>easy_valid_examples <span class="op">=</span> to_turn_examples(easy_valid_df)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>easy_test_examples <span class="op">=</span> to_turn_examples(easy_test_df)</span></code></pre></div>
</div>
<div id="cell-26" class="cell" data-execution_count="414">
<div class="sourceCode" id="cb17"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(easy_train_examples <span class="op">+</span> easy_valid_examples)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="414">
<pre><code>852</code></pre>
</div>
</div>
<p>We will used DSPy‚Äôs <code>Evaluate</code> class to run our evals in parallel(internally, this is just implemented via threads)</p>
<p>To ensure our setup works as expected, we will run a simple test first.</p>
<div id="cell-29" class="cell" data-execution_count="419">
<div class="sourceCode" id="cb19"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> Evaluate(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    devset<span class="op">=</span>easy_valid_examples[:<span class="dv">10</span>],</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    display_progress<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    display_table<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    provide_traceback<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    return_all_scores<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    return_outputs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> copy <span class="im">import</span> deepcopy</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>tlm <span class="op">=</span> deepcopy(lm_oai_gpt_4_1)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>tlm.cache <span class="op">=</span> <span class="va">False</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">HACK</span><span class="co">: Weird bug in dspy where the context doesn&#39;t set the cache to False, causing answers to be returned from memory. I&#39;ve found that creating a deepcopy and setting the attribute manually fixes this.</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> dspy.context(lm<span class="op">=</span>tlm) <span class="im">as</span> ctx:</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    evaluator(TurnSolver(reasoning_lm<span class="op">=</span><span class="va">False</span>), metric<span class="op">=</span>turn_em_metric)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 8.00 / 10 (80.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:02&lt;00:00,  3.48it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/a5433773d6ef4e359825412ad138c520
üß™ View experiment at: http://localhost:5000/#/experiments/1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/28 18:18:42 INFO dspy.evaluate.evaluate: Average Metric: 8.0 / 10 (80.0%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header" style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">conversation_context</th>
<th data-quarto-table-cell-role="th">evidence_snippets</th>
<th data-quarto-table-cell-role="th">table</th>
<th data-quarto-table-cell-role="th">question</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">doc_pre_text</th>
<th data-quarto-table-cell-role="th">doc_post_text</th>
<th data-quarto-table-cell-role="th">doc_table</th>
<th data-quarto-table-cell-role="th">dialogue_conv_questions</th>
<th data-quarto-table-cell-role="th">dialogue_conv_answers</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">dialogue_executed_answers</th>
<th data-quarto-table-cell-role="th">dialogue_qa_split</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
<th data-quarto-table-cell-role="th">example_answer</th>
<th data-quarto-table-cell-role="th">ops</th>
<th data-quarto-table-cell-role="th">pred_answer</th>
<th data-quarto-table-cell-role="th">turn_em_metric</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>None</td>
<td>[PRE] entergy corporation and subsidiaries management's financial ...</td>
<td>| Row | 2009 net revenue | volume/weather | retail electric price ...</td>
<td>what was the difference in net revenue between 2009 and 2010?</td>
<td>Single_ETR/2011/page_22.pdf-3</td>
<td>entergy corporation and subsidiaries management's financial discus...</td>
<td>the volume/weather variance is primarily due to an increase of 836...</td>
<td>{'amount ( in millions )': {'2009 net revenue': 4694.0, 'volume/we...</td>
<td>['what was the difference in net revenue between 2009 and 2010?', ...</td>
<td>[357, 4694, 7.61%]</td>
<td>...</td>
<td>[357.0, 4694.0, 0.07605]</td>
<td>[False, False, False]</td>
<td>3</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>357.00000</td>
<td>subtract(2010 net revenue, 2009 net revenue)</td>
<td>357.0</td>
<td>‚úîÔ∏è [1.000]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Q1: what was the difference in net revenue between 2009 and 2010?\...</td>
<td>[PRE] entergy corporation and subsidiaries management's financial ...</td>
<td>| Row | 2009 net revenue | volume/weather | retail electric price ...</td>
<td>and the specific value for 2009 again?</td>
<td>Single_ETR/2011/page_22.pdf-3</td>
<td>entergy corporation and subsidiaries management's financial discus...</td>
<td>the volume/weather variance is primarily due to an increase of 836...</td>
<td>{'amount ( in millions )': {'2009 net revenue': 4694.0, 'volume/we...</td>
<td>['what was the difference in net revenue between 2009 and 2010?', ...</td>
<td>[357, 4694, 7.61%]</td>
<td>...</td>
<td>[357.0, 4694.0, 0.07605]</td>
<td>[False, False, False]</td>
<td>3</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>4694.00000</td>
<td>4694.0</td>
<td>4694.0</td>
<td>‚úîÔ∏è [1.000]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Q1: what was the difference in net revenue between 2009 and 2010?\...</td>
<td>[PRE] entergy corporation and subsidiaries management's financial ...</td>
<td>| Row | 2009 net revenue | volume/weather | retail electric price ...</td>
<td>so what was the percentage change during this time?</td>
<td>Single_ETR/2011/page_22.pdf-3</td>
<td>entergy corporation and subsidiaries management's financial discus...</td>
<td>the volume/weather variance is primarily due to an increase of 836...</td>
<td>{'amount ( in millions )': {'2009 net revenue': 4694.0, 'volume/we...</td>
<td>['what was the difference in net revenue between 2009 and 2010?', ...</td>
<td>[357, 4694, 7.61%]</td>
<td>...</td>
<td>[357.0, 4694.0, 0.07605]</td>
<td>[False, False, False]</td>
<td>3</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>0.07605</td>
<td>subtract(5051.0, 4694.0), divide(#0, 4694.0), multiply(#1, const_100)</td>
<td>7.61</td>
<td></td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>None</td>
<td>[PRE] entergy new orleans , inc . management's financial discussio...</td>
<td>| Row | 2003 net revenue | base rates | volume/weather | 2004 defe...</td>
<td>what was the net revenue in 2004?</td>
<td>Single_ETR/2004/page_258.pdf-4</td>
<td>entergy new orleans , inc . management's financial discussion and ...</td>
<td>the increase in base rates was effective june 2003 . the rate incr...</td>
<td>{'( in millions )': {'2003 net revenue': 208.3, 'base rates': 10.6...</td>
<td>[what was the net revenue in 2004?, what was the net revenue in 20...</td>
<td>[239.0, 208.3, 30.7, 14.7%]</td>
<td>...</td>
<td>[239.0, 208.3, 30.7, 0.14738]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>239.00000</td>
<td>None</td>
<td>239.0</td>
<td>‚úîÔ∏è [1.000]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Q1: what was the net revenue in 2004?\nA1: 239.0</td>
<td>[PRE] entergy new orleans , inc . management's financial discussio...</td>
<td>| Row | 2003 net revenue | base rates | volume/weather | 2004 defe...</td>
<td>what was the net revenue in 2003?</td>
<td>Single_ETR/2004/page_258.pdf-4</td>
<td>entergy new orleans , inc . management's financial discussion and ...</td>
<td>the increase in base rates was effective june 2003 . the rate incr...</td>
<td>{'( in millions )': {'2003 net revenue': 208.3, 'base rates': 10.6...</td>
<td>[what was the net revenue in 2004?, what was the net revenue in 20...</td>
<td>[239.0, 208.3, 30.7, 14.7%]</td>
<td>...</td>
<td>[239.0, 208.3, 30.7, 0.14738]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>208.30000</td>
<td>None</td>
<td>208.3</td>
<td>‚úîÔ∏è [1.000]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Q1: what was the net revenue in 2004?\nA1: 239.0\nQ2: what was the...</td>
<td>[PRE] entergy new orleans , inc . management's financial discussio...</td>
<td>| Row | 2003 net revenue | base rates | volume/weather | 2004 defe...</td>
<td>what was the change in value?</td>
<td>Single_ETR/2004/page_258.pdf-4</td>
<td>entergy new orleans , inc . management's financial discussion and ...</td>
<td>the increase in base rates was effective june 2003 . the rate incr...</td>
<td>{'( in millions )': {'2003 net revenue': 208.3, 'base rates': 10.6...</td>
<td>[what was the net revenue in 2004?, what was the net revenue in 20...</td>
<td>[239.0, 208.3, 30.7, 14.7%]</td>
<td>...</td>
<td>[239.0, 208.3, 30.7, 0.14738]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>30.70000</td>
<td>subtract(239.0, 208.3)</td>
<td>30.7</td>
<td>‚úîÔ∏è [1.000]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Q1: what was the net revenue in 2004? A1: 239.0 Q2: what was the n...</td>
<td>[PRE] entergy new orleans , inc . management's financial discussio...</td>
<td>| Row | 2003 net revenue | base rates | volume/weather | 2004 defe...</td>
<td>what is the percent change?</td>
<td>Single_ETR/2004/page_258.pdf-4</td>
<td>entergy new orleans , inc . management's financial discussion and ...</td>
<td>the increase in base rates was effective june 2003 . the rate incr...</td>
<td>{'( in millions )': {'2003 net revenue': 208.3, 'base rates': 10.6...</td>
<td>[what was the net revenue in 2004?, what was the net revenue in 20...</td>
<td>[239.0, 208.3, 30.7, 14.7%]</td>
<td>...</td>
<td>[239.0, 208.3, 30.7, 0.14738]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>0.14738</td>
<td>subtract(239.0, 208.3), divide(#0, 208.3), multiply(#1, 100)</td>
<td>14.72</td>
<td></td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>None</td>
<td>[PRE] nike , inc . notes to consolidated financial statements 2014...</td>
<td>| Row | severance and related costs | cash payments | non-cash sto...</td>
<td>what was the value of the sale of the starter brand?</td>
<td>Single_NKE/2009/page_81.pdf-1</td>
<td>nike , inc . notes to consolidated financial statements 2014 ( con...</td>
<td>the accrual balance as of may 31 , 2009 will be relieved throughou...</td>
<td>{'$ 2014': {'severance and related costs': 195.0, 'cash payments':...</td>
<td>['what was the value of the sale of the starter brand?', 'what was...</td>
<td>[60.0, 28.6, 31.4, 91%]</td>
<td>...</td>
<td>[60.0, 28.6, 31.4, 0.91083]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>60.00000</td>
<td>None</td>
<td>60.0</td>
<td>‚úîÔ∏è [1.000]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Q1: what was the value of the sale of the starter brand?\nA1: 60.0</td>
<td>[PRE] nike , inc . notes to consolidated financial statements 2014...</td>
<td>| Row | severance and related costs | cash payments | non-cash sto...</td>
<td>what was the gain resulting from the sale?</td>
<td>Single_NKE/2009/page_81.pdf-1</td>
<td>nike , inc . notes to consolidated financial statements 2014 ( con...</td>
<td>the accrual balance as of may 31 , 2009 will be relieved throughou...</td>
<td>{'$ 2014': {'severance and related costs': 195.0, 'cash payments':...</td>
<td>['what was the value of the sale of the starter brand?', 'what was...</td>
<td>[60.0, 28.6, 31.4, 91%]</td>
<td>...</td>
<td>[60.0, 28.6, 31.4, 0.91083]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>28.60000</td>
<td>None</td>
<td>28.6</td>
<td>‚úîÔ∏è [1.000]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Q1: what was the value of the sale of the starter brand?\nA1: 60.0...</td>
<td>[PRE] nike , inc . notes to consolidated financial statements 2014...</td>
<td>| Row | severance and related costs | cash payments | non-cash sto...</td>
<td>what was the change in value?</td>
<td>Single_NKE/2009/page_81.pdf-1</td>
<td>nike , inc . notes to consolidated financial statements 2014 ( con...</td>
<td>the accrual balance as of may 31 , 2009 will be relieved throughou...</td>
<td>{'$ 2014': {'severance and related costs': 195.0, 'cash payments':...</td>
<td>['what was the value of the sale of the starter brand?', 'what was...</td>
<td>[60.0, 28.6, 31.4, 91%]</td>
<td>...</td>
<td>[60.0, 28.6, 31.4, 0.91083]</td>
<td>[False, False, False, False]</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>31.40000</td>
<td>subtract(60.0, 28.6)</td>
<td>31.4</td>
<td>‚úîÔ∏è [1.000]</td>
</tr>
</tbody>
</table>

<p>10 rows √ó 21 columns</p>
</div>
</div>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
  <button
    onclick="
        const display = this.nextElementSibling.style.display;
        const isCollapsed = display === 'none';
        this.nextElementSibling.style.display = isCollapsed ? null : 'none';

        const verb = isCollapsed ? 'Collapse' : 'Expand';
        this.innerText = `${verb} MLflow Trace`;
    "
  >Collapse MLflow Trace</button>
  <iframe
    id="trace-renderer"
    style="width: 100%; height: 500px; border: none; resize: vertical;"
    src="http://localhost:5000/static-files/lib/notebook-trace-renderer/index.html?trace_id=caea82d0bc0c4f0d800313b99bd69581&amp;experiment_id=1&amp;trace_id=ed4476c7920b49f3b2e909e88548e086&amp;experiment_id=1&amp;trace_id=6ba8b539ea0f49798599b294060d1213&amp;experiment_id=1&amp;trace_id=711aae8d07b14f619312af02495f941a&amp;experiment_id=1&amp;trace_id=fd97772c93064b3daf30f61009d81fe2&amp;experiment_id=1&amp;trace_id=5b665669eca649c9bd46b04a6f9737ad&amp;experiment_id=1&amp;trace_id=23be442a4d64413abe335a55bebe6a5a&amp;experiment_id=1&amp;trace_id=d057b5aed88a46fb8562a39db0ebd15d&amp;experiment_id=1&amp;trace_id=02f1ddeee02448f58babae2fb6afa3b9&amp;experiment_id=1&amp;trace_id=8e058d1aa41a4932a83c8f0505a867fd&amp;experiment_id=1&amp;version=3.1.4"
  />
</div>
</div>
</div>
<div id="cell-30" class="cell">
<div class="sourceCode" id="cb22"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">42</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>bootstrap_rs_random_easy_subset <span class="op">=</span> random.sample(easy_train_examples, <span class="dv">70</span>)</span></code></pre></div>
</div>
<div id="cell-31" class="cell">
<div class="sourceCode" id="cb23"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> litellm</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.teleprompt <span class="im">import</span> BootstrapFewShotWithRandomSearch</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Config needed to prevent the optimizer from using _unsupported_ temperature</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># for reasoning models.</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>litellm.drop_params <span class="op">=</span> <span class="va">True</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    max_bootstrapped_demos<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    max_labeled_demos<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    num_candidate_programs<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    max_rounds<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>bootstrap_rs_easy_compiled_programs <span class="op">=</span> []</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;bootstrap_few_shot_rs_easy&quot;</span>):</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> candidate_lm <span class="kw">in</span> selected_llms:</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;bootstrap_few_shot_rs_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>                teleprompter <span class="op">=</span> BootstrapFewShotWithRandomSearch(</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>                    metric<span class="op">=</span>turn_em_metric, <span class="op">**</span>config</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>                optimized_program <span class="op">=</span> teleprompter.<span class="bu">compile</span>(</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>                    dspy.ChainOfThought(SolveTurnWithReasoning),</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>                    trainset<span class="op">=</span>bootstrap_rs_random_easy_subset,</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>                bootstrap_rs_easy_compiled_programs.append(optimized_program)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Going to sample between 1 and 3 traces per predictor.
Will attempt to bootstrap 5 candidate sets.
Average Metric: 45.00 / 70 (64.3%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:00&lt;00:00, 87.74it/s] 
üèÉ View run eval_0 at: http://localhost:5000/#/experiments/3/runs/fcce9b07d50e41609bc04c3d9c2235c7
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 64.29 for seed -3
Scores so far: [64.29]
Best score so far: 64.29
  0%|          | 0/70 [00:00&lt;?, ?it/s]Average Metric: 26.00 / 38 (68.4%):  53%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé    | 37/70 [00:00&lt;00:00, 82.89it/s]Average Metric: 46.00 / 70 (65.7%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:00&lt;00:00, 76.35it/s]
üèÉ View run eval_1 at: http://localhost:5000/#/experiments/3/runs/7575401319f442499f871ca8d849bfd1
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 65.71 for seed -2
Scores so far: [64.29, 65.71]
Best score so far: 65.71
Bootstrapped 3 full traces after 6 examples for up to 1 rounds, amounting to 6 attempts.
Average Metric: 47.00 / 70 (67.1%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 62.67it/s]
üèÉ View run eval_2 at: http://localhost:5000/#/experiments/3/runs/3406309f3f0a4041a580021eaf5eff13
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 67.14 for seed -1
Scores so far: [64.29, 65.71, 67.14]
Best score so far: 67.14
Bootstrapped 2 full traces after 2 examples for up to 1 rounds, amounting to 2 attempts.
Average Metric: 48.00 / 70 (68.6%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 52.08it/s]
üèÉ View run eval_3 at: http://localhost:5000/#/experiments/3/runs/8cad7a93fb494289a4d6691d5796f84e
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 68.57 for seed 0
Scores so far: [64.29, 65.71, 67.14, 68.57]
Best score so far: 68.57
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 46.00 / 70 (65.7%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 54.10it/s]
üèÉ View run eval_4 at: http://localhost:5000/#/experiments/3/runs/ab8c076e18394080bbf9634eeff7af35
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [64.29, 65.71, 67.14, 68.57, 65.71]
Best score so far: 68.57
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 45.00 / 70 (64.3%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 44.09it/s]
üèÉ View run eval_5 at: http://localhost:5000/#/experiments/3/runs/679c914720674946a877f4a6a91665ee
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [64.29, 65.71, 67.14, 68.57, 65.71, 64.29]
Best score so far: 68.57
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 47.00 / 70 (67.1%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 61.09it/s]
üèÉ View run eval_6 at: http://localhost:5000/#/experiments/3/runs/ab818ec11652430b9bd68e17dc197665
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [64.29, 65.71, 67.14, 68.57, 65.71, 64.29, 67.14]
Best score so far: 68.57
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 51.00 / 70 (72.9%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 51.33it/s]
üèÉ View run eval_7 at: http://localhost:5000/#/experiments/3/runs/f9f17e61c1334a9ea6903ae3a1105fd8
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 72.86 for seed 4
Scores so far: [64.29, 65.71, 67.14, 68.57, 65.71, 64.29, 67.14, 72.86]
Best score so far: 72.86
8 candidate programs found.
üèÉ View run bootstrap_few_shot_rs_openai_o4-mini-2025-04-16 at: http://localhost:5000/#/experiments/3/runs/b08500752c9041d5acccbc261bd33931
üß™ View experiment at: http://localhost:5000/#/experiments/3
Going to sample between 1 and 3 traces per predictor.
Will attempt to bootstrap 5 candidate sets.
  0%|          | 0/70 [00:00&lt;?, ?it/s]Average Metric: 43.00 / 70 (61.4%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 48.03it/s]
üèÉ View run eval_0 at: http://localhost:5000/#/experiments/3/runs/578a2f04172f4ecbb41d04350201b2d5
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 61.43 for seed -3
Scores so far: [61.43]
Best score so far: 61.43
  0%|          | 0/70 [00:00&lt;?, ?it/s]Average Metric: 29.00 / 42 (69.0%):  59%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä    | 41/70 [00:01&lt;00:00, 32.19it/s]Average Metric: 35.00 / 51 (68.6%):  71%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè  | 50/70 [00:01&lt;00:00, 42.39it/s]Average Metric: 47.00 / 70 (67.1%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 43.35it/s]
üèÉ View run eval_1 at: http://localhost:5000/#/experiments/3/runs/cf868ddb4c5945149422186e878e4ee8
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 67.14 for seed -2
Scores so far: [61.43, 67.14]
Best score so far: 67.14
Bootstrapped 3 full traces after 6 examples for up to 1 rounds, amounting to 6 attempts.
Average Metric: 46.00 / 70 (65.7%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 65.12it/s]
üèÉ View run eval_2 at: http://localhost:5000/#/experiments/3/runs/a83ba7facae34ee2b495fd0bcb478044
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [61.43, 67.14, 65.71]
Best score so far: 67.14
Bootstrapped 2 full traces after 2 examples for up to 1 rounds, amounting to 2 attempts.
Average Metric: 46.00 / 70 (65.7%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 36.63it/s]
üèÉ View run eval_3 at: http://localhost:5000/#/experiments/3/runs/343b2f8e893044da9a9bee74f6be8853
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [61.43, 67.14, 65.71, 65.71]
Best score so far: 67.14
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 45.00 / 70 (64.3%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 37.96it/s]
üèÉ View run eval_4 at: http://localhost:5000/#/experiments/3/runs/3ad1f0eea05b4d7b88e7c47e2c0c29ab
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [61.43, 67.14, 65.71, 65.71, 64.29]
Best score so far: 67.14
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 47.00 / 70 (67.1%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 35.34it/s]
üèÉ View run eval_5 at: http://localhost:5000/#/experiments/3/runs/29b7cf7738bc47d89e81309a65595be0
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [61.43, 67.14, 65.71, 65.71, 64.29, 67.14]
Best score so far: 67.14
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 48.00 / 70 (68.6%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:02&lt;00:00, 31.53it/s]
üèÉ View run eval_6 at: http://localhost:5000/#/experiments/3/runs/d3a6322d0555421784dbb34087099455
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 68.57 for seed 3
Scores so far: [61.43, 67.14, 65.71, 65.71, 64.29, 67.14, 68.57]
Best score so far: 68.57
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 60.00 / 70 (85.7%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:02&lt;00:00, 28.22it/s] 
üèÉ View run eval_7 at: http://localhost:5000/#/experiments/3/runs/93c1cafdbb6b440699788970eb6ffa88
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 85.71 for seed 4
Scores so far: [61.43, 67.14, 65.71, 65.71, 64.29, 67.14, 68.57, 85.71]
Best score so far: 85.71
8 candidate programs found.
üèÉ View run bootstrap_few_shot_rs_gemini_gemini-2_5-flash at: http://localhost:5000/#/experiments/3/runs/621ba195ed244875a4370e2050418a06
üß™ View experiment at: http://localhost:5000/#/experiments/3
Going to sample between 1 and 3 traces per predictor.
Will attempt to bootstrap 5 candidate sets.
  0%|          | 0/70 [00:00&lt;?, ?it/s]Average Metric: 22.00 / 29 (75.9%):  40%|‚ñà‚ñà‚ñà‚ñà      | 28/70 [00:00&lt;00:00, 71.01it/s]Average Metric: 36.00 / 49 (73.5%):  69%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä   | 48/70 [00:01&lt;00:00, 69.84it/s]Average Metric: 52.00 / 70 (74.3%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 37.98it/s]
üèÉ View run eval_0 at: http://localhost:5000/#/experiments/3/runs/377a453f2e0745e38fc89508f7ab1d26
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 74.29 for seed -3
Scores so far: [74.29]
Best score so far: 74.29
  0%|          | 0/70 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 4 (25.0%):   4%|‚ñç         | 3/70 [00:00&lt;00:17,  3.91it/s] Average Metric: 5.00 / 8 (62.5%):  10%|‚ñà         | 7/70 [00:00&lt;00:16,  3.91it/s]Average Metric: 13.00 / 16 (81.2%):  23%|‚ñà‚ñà‚ñé       | 16/70 [00:00&lt;00:01, 39.80it/s]Average Metric: 30.00 / 41 (73.2%):  57%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã    | 40/70 [00:01&lt;00:01, 17.35it/s]Average Metric: 33.00 / 44 (75.0%):  61%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè   | 43/70 [00:01&lt;00:01, 17.35it/s]Average Metric: 52.00 / 70 (74.3%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 36.77it/s]
üèÉ View run eval_1 at: http://localhost:5000/#/experiments/3/runs/d9e37616e88748d8890de6056370f801
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [74.29, 74.29]
Best score so far: 74.29
Bootstrapped 3 full traces after 4 examples for up to 1 rounds, amounting to 4 attempts.
Average Metric: 52.00 / 70 (74.3%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:01&lt;00:00, 35.80it/s]
üèÉ View run eval_2 at: http://localhost:5000/#/experiments/3/runs/7bfc22c9728f4862931e5bb8bf4d379e
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [74.29, 74.29, 74.29]
Best score so far: 74.29
Bootstrapped 2 full traces after 2 examples for up to 1 rounds, amounting to 2 attempts.
Average Metric: 43.00 / 53 (81.1%):  76%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå  | 53/70 [00:22&lt;00:09,  1.74it/s] Average Metric: 50.00 / 68 (73.5%):  97%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã| 68/70 [00:55&lt;00:04,  2.16s/it]Average Metric: 51.00 / 70 (72.9%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [01:56&lt;00:00,  1.66s/it]
üèÉ View run eval_3 at: http://localhost:5000/#/experiments/3/runs/7cc38c776c8c40ad983a78690454b768
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [74.29, 74.29, 74.29, 72.86]
Best score so far: 74.29
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 34.00 / 37 (91.9%):  53%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé    | 37/70 [00:16&lt;00:15,  2.18it/s] Average Metric: 49.00 / 62 (79.0%):  89%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä | 62/70 [00:33&lt;00:07,  1.03it/s]Average Metric: 52.00 / 70 (74.3%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:52&lt;00:00,  1.34it/s]
üèÉ View run eval_4 at: http://localhost:5000/#/experiments/3/runs/3d4799840b5145f38c55cd04a510b4eb
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [74.29, 74.29, 74.29, 72.86, 74.29]
Best score so far: 74.29
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 53.00 / 70 (75.7%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:49&lt;00:00,  1.41it/s] 
üèÉ View run eval_5 at: http://localhost:5000/#/experiments/3/runs/826af9f09c4e4410b2b21424430e67f1
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 75.71 for seed 2
Scores so far: [74.29, 74.29, 74.29, 72.86, 74.29, 75.71]
Best score so far: 75.71
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 44.00 / 48 (91.7%):  69%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä   | 48/70 [00:18&lt;00:08,  2.53it/s] Average Metric: 53.00 / 70 (75.7%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [01:02&lt;00:00,  1.13it/s]
üèÉ View run eval_6 at: http://localhost:5000/#/experiments/3/runs/a029e23cfbe14b92a2ba6ce26146642b
üß™ View experiment at: http://localhost:5000/#/experiments/3
Scores so far: [74.29, 74.29, 74.29, 72.86, 74.29, 75.71, 75.71]
Best score so far: 75.71
Bootstrapped 1 full traces after 1 examples for up to 1 rounds, amounting to 1 attempts.
Average Metric: 56.00 / 70 (80.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 70/70 [00:44&lt;00:00,  1.58it/s] 
üèÉ View run eval_7 at: http://localhost:5000/#/experiments/3/runs/861f0c753b754e6a8eb3372287edd9bc
üß™ View experiment at: http://localhost:5000/#/experiments/3
New best score: 80.0 for seed 4
Scores so far: [74.29, 74.29, 74.29, 72.86, 74.29, 75.71, 75.71, 80.0]
Best score so far: 80.0
8 candidate programs found.
üèÉ View run bootstrap_few_shot_rs_openai_o3-2025-04-16 at: http://localhost:5000/#/experiments/3/runs/8576b067ea60468ebc37cda1a17be1dc
üß™ View experiment at: http://localhost:5000/#/experiments/3
üèÉ View run bootstrap_few_shot_rs_easy at: http://localhost:5000/#/experiments/3/runs/b5f08a070a634f74888fb8c42f24bfa3
üß™ View experiment at: http://localhost:5000/#/experiments/3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/29 01:03:08 INFO dspy.evaluate.evaluate: Average Metric: 45.0 / 70 (64.3%)
2025/07/29 01:03:08 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:08 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:09 INFO dspy.evaluate.evaluate: Average Metric: 46.0 / 70 (65.7%)
  4%|‚ñç         | 3/70 [00:00&lt;00:04, 13.83it/s]2025/07/29 01:03:09 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
  9%|‚ñä         | 6/70 [00:00&lt;00:03, 16.05it/s]
2025/07/29 01:03:11 INFO dspy.evaluate.evaluate: Average Metric: 47.0 / 70 (67.1%)
  3%|‚ñé         | 2/70 [00:00&lt;00:02, 32.62it/s]
2025/07/29 01:03:12 INFO dspy.evaluate.evaluate: Average Metric: 48.0 / 70 (68.6%)
  1%|‚ñè         | 1/70 [00:00&lt;00:03, 18.44it/s]
2025/07/29 01:03:15 INFO dspy.evaluate.evaluate: Average Metric: 46.0 / 70 (65.7%)
  1%|‚ñè         | 1/70 [00:00&lt;00:02, 24.59it/s]
2025/07/29 01:03:17 INFO dspy.evaluate.evaluate: Average Metric: 45.0 / 70 (64.3%)
  1%|‚ñè         | 1/70 [00:00&lt;00:12,  5.70it/s]
2025/07/29 01:03:19 INFO dspy.evaluate.evaluate: Average Metric: 47.0 / 70 (67.1%)
  1%|‚ñè         | 1/70 [00:00&lt;00:02, 28.38it/s]
2025/07/29 01:03:21 INFO dspy.evaluate.evaluate: Average Metric: 51.0 / 70 (72.9%)
2025/07/29 01:03:21 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:22 INFO dspy.evaluate.evaluate: Average Metric: 43.0 / 70 (61.4%)
2025/07/29 01:03:23 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:24 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:24 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:24 INFO dspy.evaluate.evaluate: Average Metric: 47.0 / 70 (67.1%)
  9%|‚ñä         | 6/70 [00:00&lt;00:03, 16.98it/s]
2025/07/29 01:03:27 INFO dspy.evaluate.evaluate: Average Metric: 46.0 / 70 (65.7%)
  3%|‚ñé         | 2/70 [00:00&lt;00:03, 21.93it/s]
2025/07/29 01:03:30 INFO dspy.evaluate.evaluate: Average Metric: 46.0 / 70 (65.7%)
  1%|‚ñè         | 1/70 [00:00&lt;00:02, 28.87it/s]
2025/07/29 01:03:32 INFO dspy.evaluate.evaluate: Average Metric: 45.0 / 70 (64.3%)
  1%|‚ñè         | 1/70 [00:00&lt;00:02, 25.21it/s]
2025/07/29 01:03:34 INFO dspy.evaluate.evaluate: Average Metric: 47.0 / 70 (67.1%)
  1%|‚ñè         | 1/70 [00:00&lt;00:10,  6.34it/s]
2025/07/29 01:03:38 INFO dspy.evaluate.evaluate: Average Metric: 48.0 / 70 (68.6%)
  1%|‚ñè         | 1/70 [00:00&lt;00:05, 13.59it/s]
2025/07/29 01:03:41 INFO dspy.evaluate.evaluate: Average Metric: 60.0 / 70 (85.7%)
2025/07/29 01:03:42 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:42 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:42 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:43 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:43 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:44 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:44 INFO dspy.evaluate.evaluate: Average Metric: 52.0 / 70 (74.3%)
2025/07/29 01:03:44 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:45 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:45 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:45 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:46 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:46 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:03:46 INFO dspy.evaluate.evaluate: Average Metric: 52.0 / 70 (74.3%)
  6%|‚ñå         | 4/70 [00:00&lt;00:04, 15.37it/s]
2025/07/29 01:03:49 INFO dspy.evaluate.evaluate: Average Metric: 52.0 / 70 (74.3%)
  3%|‚ñé         | 2/70 [00:12&lt;06:55,  6.11s/it]
2025/07/29 01:04:25 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:05:26 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:05:59 INFO dspy.evaluate.evaluate: Average Metric: 51.0 / 70 (72.9%)
  1%|‚ñè         | 1/70 [00:05&lt;06:47,  5.90s/it]
2025/07/29 01:06:22 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:06:40 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:06:57 INFO dspy.evaluate.evaluate: Average Metric: 52.0 / 70 (74.3%)
  1%|‚ñè         | 1/70 [00:03&lt;04:04,  3.55s/it]
2025/07/29 01:07:51 INFO dspy.evaluate.evaluate: Average Metric: 53.0 / 70 (75.7%)
  1%|‚ñè         | 1/70 [00:05&lt;06:22,  5.54s/it]
2025/07/29 01:08:16 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/29 01:08:59 INFO dspy.evaluate.evaluate: Average Metric: 53.0 / 70 (75.7%)
  1%|‚ñè         | 1/70 [00:04&lt;04:43,  4.11s/it]
2025/07/29 01:09:48 INFO dspy.evaluate.evaluate: Average Metric: 56.0 / 70 (80.0%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9aa596c147174804958bfd90f9e69998","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2fac575b2f714ab3a5f079b5b8c068e7","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9352e516d8b848579ba0d22b01c35fb2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dd46b6737ed8418484d64e9cef39a594","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"19d7fe20fa6b4fb7bb39768109a6e96f","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d9ac51afacd244629a94d3d29cc78260","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"71a5a9849439471b90be1451f4ed6d8c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"795ab895387b4c0e9eac571ee453ac88","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"650c0bd2cb2a4041bdf156931c25130c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f16c05df32404d64b8a8431d48d39234","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0479a155634a4c4ba4d92bebca0b0727","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ea69ff24378d45a3998851b5aa0962d4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8b8c7a6497d04213a381c037724d4895","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bc397a6b03924336bbc43a1bd839784c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d43544d6f72f40dbaae08ad6b18cb0bd","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4e7c85dbd6f64f61a359ea5a37c40ed0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6913487151e04ab7a89037c30da2cfd7","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cf6a3e6ba2a646a093455efcf2d34a65","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"102094c059e84577861cd1271f22e414","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d5351ffa3e234f7f92c3f1932b3dd438","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d3e11c2f024d4ec090827c250d4258ca","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3cff124f59634e5b9279882b0501180a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"043eb11fea0a462684dac9bbb48f4f03","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e694033bfb9e4689bd6c07fc39d0801c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"db37866855a049b88bb7e4c9dd3597c6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"93fd5af0c6644afc978088bc68e1ee83","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5aa8485009e94f079807723d8dbc5ab2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e5cce25e5c7941d6bf6a39bcd3c76bf8","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f90ceb161810483ab7c0fb2a38dd46e4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4d26bd076e4845b193dfa48d40f9e51b","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2bceaac3cdcd48a0b05bc0f5e0c884a5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ab959aa00cf145d0984217e3c543fcd0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7a19b204ef7443e3964026a61386dbf3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0944c174ba5d4b7f888c2c78316eeb67","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f58455aed23543369dda147cdcc46ee6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6f9faa0b381e48b4a3239439f9b5c8a0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"14d1357491a342a6b3cbb1a778076b69","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3146876614a146569534ee1e0cef7f86","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"36e21760751a482c874fbc57b485e178","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
  <button
    onclick="
        const display = this.nextElementSibling.style.display;
        const isCollapsed = display === 'none';
        this.nextElementSibling.style.display = isCollapsed ? null : 'none';

        const verb = isCollapsed ? 'Collapse' : 'Expand';
        this.innerText = `${verb} MLflow Trace`;
    "
  >Collapse MLflow Trace</button>
  <iframe
    id="trace-renderer"
    style="width: 100%; height: 500px; border: none; resize: vertical;"
    src="http://localhost:5000/static-files/lib/notebook-trace-renderer/index.html?trace_id=bc6ccffd18824246934194a85933d3fd&amp;experiment_id=3&amp;trace_id=e37a0ba10d0543bb908e397933697d6d&amp;experiment_id=3&amp;trace_id=b37797a381b44f7eb13e1f42eca0567c&amp;experiment_id=3&amp;trace_id=9a18ced106784364ae12831ce45a8748&amp;experiment_id=3&amp;trace_id=3d7bb8edeb78492bac5473d6e52c4846&amp;experiment_id=3&amp;trace_id=d42d241ebb9e40b1affe006598cae983&amp;experiment_id=3&amp;trace_id=344ea0c049b946e8b780a9e02d720688&amp;experiment_id=3&amp;trace_id=4cac19ef64574b50b38d4baf81b360d5&amp;experiment_id=3&amp;trace_id=c4ca77588233486e9d234e95aa976329&amp;experiment_id=3&amp;trace_id=c9921423c3aa4f16933885eb15242313&amp;experiment_id=3&amp;version=3.1.4"
  />
</div>
</div>
</div>
<p>From the above, it looks like GPT-4.1 gives an score of 80% on the validation set, WITHOUT ANY PROMPT ENGINEERING/FEW-SHOT PROMPTING. This is great!</p>
<p>As mentioned earlier, due to cost and time constraints, we want to first narrow down the list of models we want to test on the harder stages.</p>
<p>As a recap, our implementation strategy here will be as follows: instead of just using the performance of the models on the ‚Äúeasy‚Äù validation set, we will use a combination of two datasets:</p>
<ol type="1">
<li>Gate - 50 Easy dialogs, teacher - forced. Drop model if Turn-EM &lt; 0.55.</li>
<li>Probe - 30-dialog mixed micro-set (15 Medium + 15 Hard, closed loop). Keep model only if Final-Turn EM ‚â• 0.35, Dialogue-mean EM ‚â• 0.35</li>
</ol>
<p>We will now create our ‚Äúgate‚Äù and ‚Äúprobe‚Äù datasets.</p>
<div id="cell-33" class="cell" data-execution_count="420">
<div class="sourceCode" id="cb26"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>gate_ids <span class="op">=</span> easy_valid_ids.sample(<span class="dv">50</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>probe_medium_ids <span class="op">=</span> medium_valid_ids.sample(<span class="dv">15</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>probe_hard_ids <span class="op">=</span> hard_valid_ids.sample(<span class="dv">30</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>gate_df <span class="op">=</span> easy_valid_df[easy_valid_df[<span class="st">&quot;id&quot;</span>].isin(gate_ids[<span class="st">&quot;id&quot;</span>])].copy()</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>probe_df <span class="op">=</span> pd.concat(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        medium_valid_df[medium_valid_df[<span class="st">&quot;id&quot;</span>].isin(probe_medium_ids[<span class="st">&quot;id&quot;</span>])],</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        hard_valid_df[hard_valid_df[<span class="st">&quot;id&quot;</span>].isin(probe_hard_ids[<span class="st">&quot;id&quot;</span>])],</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>).copy()</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gate_df.shape[<span class="dv">0</span>] <span class="op">==</span> gate_ids.shape[<span class="dv">0</span>]</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> probe_df.shape[<span class="dv">0</span>] <span class="op">==</span> probe_medium_ids.shape[<span class="dv">0</span>] <span class="op">+</span> probe_hard_ids.shape[<span class="dv">0</span>]</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>gate_examples <span class="op">=</span> to_turn_examples(gate_df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>probe_examples <span class="op">=</span> to_turn_examples(probe_df, history_mode<span class="op">=</span><span class="st">&quot;teacher&quot;</span>)</span></code></pre></div>
</div>
<p>We will also save the <code>gate</code> and <code>probe</code> dataset ids, to compare performance of different models on them.</p>
<div id="cell-35" class="cell" data-execution_count="500">
<div class="sourceCode" id="cb27"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">&quot;validation_datasets&quot;</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>gate_ids.to_json(<span class="st">&quot;validation_datasets/gate_ids.jsonl&quot;</span>, orient<span class="op">=</span><span class="st">&quot;records&quot;</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>probe_medium_ids.to_json(</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;validation_datasets/probe_medium_ids.jsonl&quot;</span>, orient<span class="op">=</span><span class="st">&quot;records&quot;</span>, lines<span class="op">=</span><span class="va">True</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>probe_hard_ids.to_json(</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;validation_datasets/probe_hard_ids.jsonl&quot;</span>, orient<span class="op">=</span><span class="st">&quot;records&quot;</span>, lines<span class="op">=</span><span class="va">True</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="cell-36" class="cell" data-execution_count="421">
<div class="sourceCode" id="cb28"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>gate_examples[<span class="dv">0</span>].toDict()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="421">
<pre><code>{&#39;conversation_context&#39;: &#39;None&#39;,
 &#39;evidence_snippets&#39;: &quot;[PRE]\nentergy corporation and subsidiaries management&#39;s financial discussion and analysis refer to 201cselected financial data - five-year comparison of entergy corporation and subsidiaries 201d which accompanies entergy corporation 2019s financial statements in this report for further information with respect to operating statistics . in november 2007 the board approved a plan to pursue a separation of entergy 2019s non-utility nuclear business from entergy through a spin-off of the business to entergy shareholders . in april 2010 , entergy announced that it planned to unwind the business infrastructure associated with the proposed spin-off transaction . as a result of the plan to unwind the business infrastructure , entergy recorded expenses in 2010 for the write-off of certain capitalized costs incurred in connection with the planned spin-off transaction . these costs are discussed in more detail below and throughout this section . net revenue utility following is an analysis of the change in net revenue comparing 2010 to 2009 . amount ( in millions ) .\n[/PRE]\n[POST]\nthe volume/weather variance is primarily due to an increase of 8362 gwh , or 8% ( 8 % ) , in billed electricity usage in all retail sectors , including the effect on the residential sector of colder weather in the first quarter 2010 compared to 2009 and warmer weather in the second and third quarters 2010 compared to 2009 . the industrial sector reflected strong sales growth on continuing signs of economic recovery . the improvement in this sector was primarily driven by inventory restocking and strong exports with the chemicals , refining , and miscellaneous manufacturing sectors leading the improvement . the retail electric price variance is primarily due to : increases in the formula rate plan riders at entergy gulf states louisiana effective november 2009 , january 2010 , and september 2010 , at entergy louisiana effective november 2009 , and at entergy mississippi effective july 2009 ; a base rate increase at entergy arkansas effective july 2010 ; rate actions at entergy texas , including base rate increases effective in may and august 2010 ; a formula rate plan provision of $ 16.6 million recorded in the third quarter 2009 for refunds that were made to customers in accordance with settlements approved by the lpsc ; and the recovery in 2009 by entergy arkansas of 2008 extraordinary storm costs , as approved by the apsc , which ceased in january 2010 . the recovery of storm costs is offset in other operation and maintenance expenses . see note 2 to the financial statements for further discussion of the proceedings referred to above. .\n[/POST]&quot;,
 &#39;table&#39;: &#39;| Row | 2009 net revenue | volume/weather | retail electric price | provision for regulatory proceedings | rough production cost equalization | ano decommissioning trust | fuel recovery | other | 2010 net revenue |\n|---|---|---|---|---|---|---|---|---|---|\n| amount ( in millions ) | 4694.0 | 231.0 | 137.0 | 26.0 | 19.0 | -24.0 | -44.0 | 12.0 | 5051.0 |&#39;,
 &#39;question&#39;: &#39;what was the difference in net revenue between 2009 and 2010?&#39;,
 &#39;id&#39;: &#39;Single_ETR/2011/page_22.pdf-3&#39;,
 &#39;doc_pre_text&#39;: &quot;entergy corporation and subsidiaries management&#39;s financial discussion and analysis refer to 201cselected financial data - five-year comparison of entergy corporation and subsidiaries 201d which accompanies entergy corporation 2019s financial statements in this report for further information with respect to operating statistics . in november 2007 the board approved a plan to pursue a separation of entergy 2019s non-utility nuclear business from entergy through a spin-off of the business to entergy shareholders . in april 2010 , entergy announced that it planned to unwind the business infrastructure associated with the proposed spin-off transaction . as a result of the plan to unwind the business infrastructure , entergy recorded expenses in 2010 for the write-off of certain capitalized costs incurred in connection with the planned spin-off transaction . these costs are discussed in more detail below and throughout this section . net revenue utility following is an analysis of the change in net revenue comparing 2010 to 2009 . amount ( in millions ) .&quot;,
 &#39;doc_post_text&#39;: &#39;the volume/weather variance is primarily due to an increase of 8362 gwh , or 8% ( 8 % ) , in billed electricity usage in all retail sectors , including the effect on the residential sector of colder weather in the first quarter 2010 compared to 2009 and warmer weather in the second and third quarters 2010 compared to 2009 . the industrial sector reflected strong sales growth on continuing signs of economic recovery . the improvement in this sector was primarily driven by inventory restocking and strong exports with the chemicals , refining , and miscellaneous manufacturing sectors leading the improvement . the retail electric price variance is primarily due to : increases in the formula rate plan riders at entergy gulf states louisiana effective november 2009 , january 2010 , and september 2010 , at entergy louisiana effective november 2009 , and at entergy mississippi effective july 2009 ; a base rate increase at entergy arkansas effective july 2010 ; rate actions at entergy texas , including base rate increases effective in may and august 2010 ; a formula rate plan provision of $ 16.6 million recorded in the third quarter 2009 for refunds that were made to customers in accordance with settlements approved by the lpsc ; and the recovery in 2009 by entergy arkansas of 2008 extraordinary storm costs , as approved by the apsc , which ceased in january 2010 . the recovery of storm costs is offset in other operation and maintenance expenses . see note 2 to the financial statements for further discussion of the proceedings referred to above. .&#39;,
 &#39;doc_table&#39;: {&#39;amount ( in millions )&#39;: {&#39;2009 net revenue&#39;: 4694.0,
   &#39;volume/weather&#39;: 231.0,
   &#39;retail electric price&#39;: 137.0,
   &#39;provision for regulatory proceedings&#39;: 26.0,
   &#39;rough production cost equalization&#39;: 19.0,
   &#39;ano decommissioning trust&#39;: -24.0,
   &#39;fuel recovery&#39;: -44.0,
   &#39;other&#39;: 12.0,
   &#39;2010 net revenue&#39;: 5051.0}},
 &#39;dialogue_conv_questions&#39;: [&#39;what was the difference in net revenue between 2009 and 2010?&#39;,
  &#39;and the specific value for 2009 again?&#39;,
  &#39;so what was the percentage change during this time?&#39;],
 &#39;dialogue_conv_answers&#39;: [&#39;357&#39;, &#39;4694&#39;, &#39;7.61%&#39;],
 &#39;dialogue_turn_program&#39;: [&#39;subtract(5051, 4694)&#39;,
  &#39;4694&#39;,
  &#39;subtract(5051, 4694), divide(#0, 4694)&#39;],
 &#39;dialogue_executed_answers&#39;: [357.0, 4694.0, 0.07605],
 &#39;dialogue_qa_split&#39;: [False, False, False],
 &#39;features_num_dialogue_turns&#39;: 3,
 &#39;features_has_type2_question&#39;: False,
 &#39;features_has_duplicate_columns&#39;: False,
 &#39;features_has_non_numeric_values&#39;: False,
 &#39;answer&#39;: 357.0}</code></pre>
</div>
</div>
<div id="cell-37" class="cell" data-execution_count="422">
<div class="sourceCode" id="cb30"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>gate_examples[<span class="dv">0</span>].inputs().toDict()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="422">
<pre><code>{&#39;conversation_context&#39;: &#39;None&#39;,
 &#39;evidence_snippets&#39;: &quot;[PRE]\nentergy corporation and subsidiaries management&#39;s financial discussion and analysis refer to 201cselected financial data - five-year comparison of entergy corporation and subsidiaries 201d which accompanies entergy corporation 2019s financial statements in this report for further information with respect to operating statistics . in november 2007 the board approved a plan to pursue a separation of entergy 2019s non-utility nuclear business from entergy through a spin-off of the business to entergy shareholders . in april 2010 , entergy announced that it planned to unwind the business infrastructure associated with the proposed spin-off transaction . as a result of the plan to unwind the business infrastructure , entergy recorded expenses in 2010 for the write-off of certain capitalized costs incurred in connection with the planned spin-off transaction . these costs are discussed in more detail below and throughout this section . net revenue utility following is an analysis of the change in net revenue comparing 2010 to 2009 . amount ( in millions ) .\n[/PRE]\n[POST]\nthe volume/weather variance is primarily due to an increase of 8362 gwh , or 8% ( 8 % ) , in billed electricity usage in all retail sectors , including the effect on the residential sector of colder weather in the first quarter 2010 compared to 2009 and warmer weather in the second and third quarters 2010 compared to 2009 . the industrial sector reflected strong sales growth on continuing signs of economic recovery . the improvement in this sector was primarily driven by inventory restocking and strong exports with the chemicals , refining , and miscellaneous manufacturing sectors leading the improvement . the retail electric price variance is primarily due to : increases in the formula rate plan riders at entergy gulf states louisiana effective november 2009 , january 2010 , and september 2010 , at entergy louisiana effective november 2009 , and at entergy mississippi effective july 2009 ; a base rate increase at entergy arkansas effective july 2010 ; rate actions at entergy texas , including base rate increases effective in may and august 2010 ; a formula rate plan provision of $ 16.6 million recorded in the third quarter 2009 for refunds that were made to customers in accordance with settlements approved by the lpsc ; and the recovery in 2009 by entergy arkansas of 2008 extraordinary storm costs , as approved by the apsc , which ceased in january 2010 . the recovery of storm costs is offset in other operation and maintenance expenses . see note 2 to the financial statements for further discussion of the proceedings referred to above. .\n[/POST]&quot;,
 &#39;table&#39;: &#39;| Row | 2009 net revenue | volume/weather | retail electric price | provision for regulatory proceedings | rough production cost equalization | ano decommissioning trust | fuel recovery | other | 2010 net revenue |\n|---|---|---|---|---|---|---|---|---|---|\n| amount ( in millions ) | 4694.0 | 231.0 | 137.0 | 26.0 | 19.0 | -24.0 | -44.0 | 12.0 | 5051.0 |&#39;,
 &#39;question&#39;: &#39;what was the difference in net revenue between 2009 and 2010?&#39;}</code></pre>
</div>
</div>
<section id="gate-dataset-results" class="level3">
<h3>Gate Dataset Results</h3>
<div id="cell-39" class="cell" data-execution_count="423">
<div class="sourceCode" id="cb32"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;gate_dataset_results&quot;</span>) <span class="im">as</span> parent_ctx:</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> candidate_lm <span class="kw">in</span> llms:</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;gate_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>            current_evaluator <span class="op">=</span> Evaluate(</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>                devset<span class="op">=</span>gate_examples[:<span class="dv">10</span>],</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>                num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>                display_progress<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>                <span class="co"># display_table=True,</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># provide_traceback=True,</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>                return_all_scores<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>                return_outputs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>                current_result <span class="op">=</span> current_evaluator(</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>                    TurnSolver(reasoning_lm<span class="op">=</span><span class="va">True</span>), metric<span class="op">=</span>turn_em_metric</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>                results.append(current_result)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 8.00 / 10 (80.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:00&lt;00:00, 65.65it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/502b5457f9db44339a5afce34d13d847
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_openai_gpt-4_1-2025-04-14 at: http://localhost:5000/#/experiments/1/runs/7e61e1f47f4e408c8cec59ee1bf9c0dd
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 5.00 / 10 (50.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:00&lt;00:00, 58.97it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/1b4ea94ac47e4660b30234d6ad78c8d8
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_openai_gpt-4_1-mini-2025-04-14 at: http://localhost:5000/#/experiments/1/runs/fa03278692c848e996a3e43e6422099f
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 6.00 / 10 (60.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:00&lt;00:00, 79.01it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/ce1366eaa8c146eabba86650fae12f74
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_openai_o4-mini-2025-04-16 at: http://localhost:5000/#/experiments/1/runs/3d1fb9c72b914d5a942312db0a6a5088
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 6.00 / 10 (60.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:00&lt;00:00, 81.33it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/9e00a96bfd114bbaa9e47dcb478b4423
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_anthropic_claude-sonnet-4-20250514 at: http://localhost:5000/#/experiments/1/runs/76c2180b1f3c4510ab13158d3b0d36eb
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 7.00 / 10 (70.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:00&lt;00:00, 65.50it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/4a3c7957aaab4a4e972b06a7754fe6d4
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_gemini_gemini-2_5-flash at: http://localhost:5000/#/experiments/1/runs/aa191551b2844b57bb9d2db37e50c4f0
üß™ View experiment at: http://localhost:5000/#/experiments/1
  0%|          | 0/10 [00:00&lt;?, ?it/s]Average Metric: 7.00 / 10 (70.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:00&lt;00:00, 61.55it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/809ee64fbd164475b3592ff2340b2595
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_gemini_gemini-2_5-flash-lite at: http://localhost:5000/#/experiments/1/runs/90ea53b2a2484cc0a5302b7c8245184e
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 8.00 / 10 (80.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:00&lt;00:00, 74.80it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/6f1bec87d6ce4137b10e055e94bf54d4
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_openai_o3-2025-04-16 at: http://localhost:5000/#/experiments/1/runs/7e4f8e42c8244b94af37787cacd12ee5
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 7.00 / 10 (70.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:00&lt;00:00, 86.48it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/ab105090285e4b55a93205dc6f1bde64
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_anthropic_claude-opus-4-20250514 at: http://localhost:5000/#/experiments/1/runs/58c90aae89644af8a1d2c7dc845b0c07
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 8.00 / 10 (80.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:00&lt;00:00, 39.63it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/e786a0b633844e7ebdb6a165561b81ec
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_gemini_gemini-2_5-pro at: http://localhost:5000/#/experiments/1/runs/9e1f42bcc8064a9383ed590c1add4d01
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 7.00 / 10 (70.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 10/10 [00:00&lt;00:00, 71.29it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/f4ae2cb32a2b401aa5ab8f7b02dc7b86
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_ollama_qwen3_32b at: http://localhost:5000/#/experiments/1/runs/ca6c0d988ca94f2998eb08f339fdf22a
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_dataset_results at: http://localhost:5000/#/experiments/1/runs/0b0e82f0b3724ec1afedde0d7a036dfe
üß™ View experiment at: http://localhost:5000/#/experiments/1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/28 18:19:36 INFO dspy.evaluate.evaluate: Average Metric: 8.0 / 10 (80.0%)
2025/07/28 18:19:37 INFO dspy.evaluate.evaluate: Average Metric: 5.0 / 10 (50.0%)
2025/07/28 18:19:37 INFO dspy.evaluate.evaluate: Average Metric: 6.0 / 10 (60.0%)
2025/07/28 18:19:37 INFO dspy.evaluate.evaluate: Average Metric: 6.0 / 10 (60.0%)
2025/07/28 18:19:37 INFO dspy.evaluate.evaluate: Average Metric: 7.0 / 10 (70.0%)
2025/07/28 18:19:37 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:19:37 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:19:38 INFO dspy.evaluate.evaluate: Average Metric: 7.0 / 10 (70.0%)
2025/07/28 18:19:38 INFO dspy.evaluate.evaluate: Average Metric: 8.0 / 10 (80.0%)
2025/07/28 18:19:38 INFO dspy.evaluate.evaluate: Average Metric: 7.0 / 10 (70.0%)
2025/07/28 18:19:38 INFO dspy.evaluate.evaluate: Average Metric: 8.0 / 10 (80.0%)
2025/07/28 18:19:39 INFO dspy.evaluate.evaluate: Average Metric: 7.0 / 10 (70.0%)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
  <button
    onclick="
        const display = this.nextElementSibling.style.display;
        const isCollapsed = display === 'none';
        this.nextElementSibling.style.display = isCollapsed ? null : 'none';

        const verb = isCollapsed ? 'Collapse' : 'Expand';
        this.innerText = `${verb} MLflow Trace`;
    "
  >Collapse MLflow Trace</button>
  <iframe
    id="trace-renderer"
    style="width: 100%; height: 500px; border: none; resize: vertical;"
    src="http://localhost:5000/static-files/lib/notebook-trace-renderer/index.html?trace_id=9f5fdac684c74647a0a88cbdcd16d89b&amp;experiment_id=1&amp;trace_id=3de6592234f74ca4ba6a450f2a01b37a&amp;experiment_id=1&amp;trace_id=31e022f38c354840b5abbe64b417306d&amp;experiment_id=1&amp;trace_id=0756d03769c4417e861f7171ecb7bcb8&amp;experiment_id=1&amp;trace_id=f1dcee538d454f96a41dc1d59c3a27f9&amp;experiment_id=1&amp;trace_id=283f1f0436c24afabdb9d865b3c0e802&amp;experiment_id=1&amp;trace_id=ddb2286507bd47fd8580b5e8dd923d7e&amp;experiment_id=1&amp;trace_id=427f384f2d604830844675df25de1226&amp;experiment_id=1&amp;trace_id=789bab02c70346c1a50c91de5f67376b&amp;experiment_id=1&amp;trace_id=2c112f9efbb44a9796a0ca64a43b8b5d&amp;experiment_id=1&amp;version=3.1.4"
  />
</div>
</div>
</div>
<div id="cell-40" class="cell" data-execution_count="424">
<div class="sourceCode" id="cb35"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        {<span class="st">&quot;LLM&quot;</span>: llms[idx].model, <span class="st">&quot;Evaluation Score&quot;</span>: candidate[<span class="dv">0</span>]}</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, candidate <span class="kw">in</span> <span class="bu">enumerate</span>(results)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                  LLM  Evaluation Score
0           openai/gpt-4.1-2025-04-14              80.0
1      openai/gpt-4.1-mini-2025-04-14              50.0
2           openai/o4-mini-2025-04-16              60.0
3  anthropic/claude-sonnet-4-20250514              60.0
4             gemini/gemini-2.5-flash              70.0
5        gemini/gemini-2.5-flash-lite              70.0
6                openai/o3-2025-04-16              80.0
7    anthropic/claude-opus-4-20250514              70.0
8               gemini/gemini-2.5-pro              80.0
9                    ollama/qwen3:32b              70.0</code></pre>
</div>
</div>
<p>From the small test above, we see that most of the models score in a similar range. I think it‚Äôs expected that GPT-4.1-mini performs poorly, given that it‚Äôs a much smaller model compared to all the competetiors.</p>
<p>From the MLFlow logs, we also see that while Qwen3:32b has a relatively high score, inference is quite slow. For now, we will skip this model during the model selection phase, and revisit it later.</p>
<div id="cell-42" class="cell" data-execution_count="425">
<div class="sourceCode" id="cb37"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>model_selection_llms <span class="op">=</span> [</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    lm_oai_gpt_4_1,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    lm_oai_gpt_4_1_mini,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    lm_oai_o4_mini,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    lm_anthropic_sonnet_4_0,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    lm_gemini_flash_2_5,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    lm_gemini_flash_2_5_lite,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    lm_oai_o3,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    lm_anthropic_opus_4_0,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    lm_gemini_pro_2_5,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
</div>
<div id="cell-43" class="cell" data-execution_count="426">
<div class="sourceCode" id="cb38"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;gate_dataset_results_full&quot;</span>) <span class="im">as</span> parent_ctx:</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> candidate_lm <span class="kw">in</span> model_selection_llms:</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;gate_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>            current_evaluator <span class="op">=</span> Evaluate(</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>                devset<span class="op">=</span>gate_examples,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>                num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>                display_progress<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>                <span class="co"># display_table=True,</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># provide_traceback=True,</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>                return_all_scores<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>                return_outputs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>                current_result <span class="op">=</span> current_evaluator(</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>                    TurnSolver(reasoning_lm<span class="op">=</span><span class="va">True</span>), metric<span class="op">=</span>turn_em_metric</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>                results.append(current_result)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 95.00 / 151 (62.9%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 151/151 [00:02&lt;00:00, 74.97it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/e18f45df89fb4a0e9e98e6f01d74bf71
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_openai_gpt-4_1-2025-04-14 at: http://localhost:5000/#/experiments/1/runs/f15c1d3760fc489b95ec5950f3e992b9
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 81.00 / 151 (53.6%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 151/151 [00:02&lt;00:00, 74.18it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/9f40a5f2dc2a4e09977f8b8c53822605
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_openai_gpt-4_1-mini-2025-04-14 at: http://localhost:5000/#/experiments/1/runs/c882d7c82d5f4a3abb510bf57d506c53
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 31.00 / 55 (56.4%):  36%|‚ñà‚ñà‚ñà‚ñå      | 54/151 [00:00&lt;00:01, 53.34it/s]Average Metric: 44.00 / 72 (61.1%):  47%|‚ñà‚ñà‚ñà‚ñà‚ñã     | 71/151 [00:01&lt;00:01, 73.76it/s]Average Metric: 62.00 / 106 (58.5%):  70%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ   | 105/151 [00:01&lt;00:00, 82.16it/s]Average Metric: 95.00 / 151 (62.9%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 151/151 [00:02&lt;00:00, 71.71it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/8154049643d040d39c7642b56ac6d7c5
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_openai_o4-mini-2025-04-16 at: http://localhost:5000/#/experiments/1/runs/938b45e4b5204804b4e4660feebf563a
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 95.00 / 151 (62.9%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 151/151 [00:02&lt;00:00, 70.44it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/599e8c7040b04b8c8f0ca24c6dc94d37
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_anthropic_claude-sonnet-4-20250514 at: http://localhost:5000/#/experiments/1/runs/4442e20dc743456b966821c18219c23e
üß™ View experiment at: http://localhost:5000/#/experiments/1
  0%|          | 0/151 [00:00&lt;?, ?it/s]Average Metric: 31.00 / 47 (66.0%):  30%|‚ñà‚ñà‚ñà       | 46/151 [00:01&lt;00:02, 47.10it/s]Average Metric: 57.00 / 93 (61.3%):  62%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè   | 93/151 [00:01&lt;00:00, 79.96it/s]Average Metric: 73.00 / 122 (59.8%):  80%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  | 121/151 [00:01&lt;00:00, 89.94it/s]Average Metric: 96.00 / 151 (63.6%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 151/151 [00:02&lt;00:00, 67.06it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/bcea3ffb8c6f4cbb98725e43e88cbdd0
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_gemini_gemini-2_5-flash at: http://localhost:5000/#/experiments/1/runs/7db59c48c06c4948adf754477705c360
üß™ View experiment at: http://localhost:5000/#/experiments/1
  0%|          | 0/151 [00:00&lt;?, ?it/s]Average Metric: 8.00 / 12 (66.7%):   7%|‚ñã         | 11/151 [00:00&lt;00:03, 38.23it/s]Average Metric: 9.00 / 13 (69.2%):   8%|‚ñä         | 12/151 [00:00&lt;00:03, 38.23it/s]Average Metric: 18.00 / 29 (62.1%):  19%|‚ñà‚ñâ        | 29/151 [00:00&lt;00:01, 62.69it/s]Average Metric: 20.00 / 32 (62.5%):  21%|‚ñà‚ñà        | 31/151 [00:00&lt;00:01, 62.69it/s]Average Metric: 20.00 / 33 (60.6%):  21%|‚ñà‚ñà        | 32/151 [00:00&lt;00:01, 62.69it/s]Average Metric: 21.00 / 34 (61.8%):  22%|‚ñà‚ñà‚ñè       | 33/151 [00:00&lt;00:01, 62.69it/s]Average Metric: 22.00 / 38 (57.9%):  25%|‚ñà‚ñà‚ñç       | 37/151 [00:00&lt;00:01, 61.42it/s]Average Metric: 44.00 / 75 (58.7%):  49%|‚ñà‚ñà‚ñà‚ñà‚ñâ     | 74/151 [00:01&lt;00:01, 57.41it/s]Average Metric: 44.00 / 76 (57.9%):  50%|‚ñà‚ñà‚ñà‚ñà‚ñâ     | 75/151 [00:01&lt;00:01, 57.41it/s]Average Metric: 44.00 / 78 (56.4%):  51%|‚ñà‚ñà‚ñà‚ñà‚ñà     | 77/151 [00:01&lt;00:01, 58.30it/s]Average Metric: 47.00 / 84 (56.0%):  56%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå    | 84/151 [00:01&lt;00:01, 60.44it/s]Average Metric: 51.00 / 89 (57.3%):  58%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä    | 88/151 [00:01&lt;00:01, 60.44it/s]Average Metric: 52.00 / 90 (57.8%):  59%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ    | 89/151 [00:01&lt;00:01, 60.44it/s]Average Metric: 55.00 / 96 (57.3%):  63%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé   | 95/151 [00:01&lt;00:00, 60.62it/s]Average Metric: 56.00 / 97 (57.7%):  64%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé   | 96/151 [00:01&lt;00:00, 60.62it/s]Average Metric: 59.00 / 107 (55.1%):  70%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   | 106/151 [00:01&lt;00:00, 67.41it/s]Average Metric: 59.00 / 108 (54.6%):  72%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè  | 108/151 [00:01&lt;00:00, 69.63it/s]Average Metric: 62.00 / 112 (55.4%):  74%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé  | 111/151 [00:01&lt;00:00, 69.63it/s]Average Metric: 69.00 / 123 (56.1%):  81%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  | 122/151 [00:01&lt;00:00, 69.40it/s]Average Metric: 87.00 / 151 (57.6%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 151/151 [00:02&lt;00:00, 60.17it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/c348c68458124441865ac735d0b7d641
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_gemini_gemini-2_5-flash-lite at: http://localhost:5000/#/experiments/1/runs/598582fb690540e7baca55a097fee220
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 22.00 / 32 (68.8%):  21%|‚ñà‚ñà        | 31/151 [00:00&lt;00:01, 64.25it/s]Average Metric: 69.00 / 100 (69.0%):  66%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå   | 99/151 [00:01&lt;00:00, 62.91it/s]Average Metric: 106.00 / 151 (70.2%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 151/151 [00:02&lt;00:00, 51.93it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/853504669f224faf8773cf2d9436fb41
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_openai_o3-2025-04-16 at: http://localhost:5000/#/experiments/1/runs/f122d81f9c1d46d582ce64553f6ee3ea
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 103.00 / 151 (68.2%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 151/151 [00:02&lt;00:00, 67.19it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/96826db5718c45d6a2dc0b2c5526441e
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_anthropic_claude-opus-4-20250514 at: http://localhost:5000/#/experiments/1/runs/d329de90de1e40e0b467681f0442656a
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 103.00 / 151 (68.2%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 151/151 [00:02&lt;00:00, 71.07it/s] 
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/1fbbc1c758204d438fd050d77d524632
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_gemini_gemini-2_5-pro at: http://localhost:5000/#/experiments/1/runs/6e2dd13cb21f455c905159caa8335678
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run gate_dataset_results_full at: http://localhost:5000/#/experiments/1/runs/51176a64c2af4fbc803a1e1f0775e924
üß™ View experiment at: http://localhost:5000/#/experiments/1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/28 18:21:32 INFO dspy.evaluate.evaluate: Average Metric: 95.0 / 151 (62.9%)
2025/07/28 18:21:34 INFO dspy.evaluate.evaluate: Average Metric: 81.0 / 151 (53.6%)
2025/07/28 18:21:35 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:35 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:36 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:36 INFO dspy.evaluate.evaluate: Average Metric: 95.0 / 151 (62.9%)
2025/07/28 18:21:38 INFO dspy.evaluate.evaluate: Average Metric: 95.0 / 151 (62.9%)
2025/07/28 18:21:39 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:39 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:40 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:40 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:40 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:41 INFO dspy.evaluate.evaluate: Average Metric: 96.0 / 151 (63.6%)
2025/07/28 18:21:41 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:41 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:41 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:41 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:41 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:41 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:41 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:41 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:41 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:41 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:41 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:41 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:41 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:41 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:42 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:42 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:42 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:42 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:42 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:42 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:42 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:42 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:42 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:42 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:42 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:42 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:42 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:43 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:43 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:43 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:43 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:43 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:43 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:43 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:43 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:43 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:43 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:43 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:21:43 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:43 INFO dspy.evaluate.evaluate: Average Metric: 87.0 / 151 (57.6%)
2025/07/28 18:21:44 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:45 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:21:47 INFO dspy.evaluate.evaluate: Average Metric: 106.0 / 151 (70.2%)
2025/07/28 18:21:49 INFO dspy.evaluate.evaluate: Average Metric: 103.0 / 151 (68.2%)
2025/07/28 18:21:51 INFO dspy.evaluate.evaluate: Average Metric: 103.0 / 151 (68.2%)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
  <button
    onclick="
        const display = this.nextElementSibling.style.display;
        const isCollapsed = display === 'none';
        this.nextElementSibling.style.display = isCollapsed ? null : 'none';

        const verb = isCollapsed ? 'Collapse' : 'Expand';
        this.innerText = `${verb} MLflow Trace`;
    "
  >Collapse MLflow Trace</button>
  <iframe
    id="trace-renderer"
    style="width: 100%; height: 500px; border: none; resize: vertical;"
    src="http://localhost:5000/static-files/lib/notebook-trace-renderer/index.html?trace_id=5276eb031180473cb92d03ceca489d38&amp;experiment_id=1&amp;trace_id=0f2dffe6dfd74fe3b5697a0bffb47658&amp;experiment_id=1&amp;trace_id=35c112a62c334012a612cdca116e9b09&amp;experiment_id=1&amp;trace_id=e30a2c51605b4102b190affb869475f4&amp;experiment_id=1&amp;trace_id=1b74fe5cb6c8453b82c227eb63e11221&amp;experiment_id=1&amp;trace_id=5310ed582ac0431382787b65f63de317&amp;experiment_id=1&amp;trace_id=f713426ecd20413ba2acbb7af0228b2d&amp;experiment_id=1&amp;trace_id=0f44b811a42c41dd9d867b5e12f80044&amp;experiment_id=1&amp;trace_id=543c31429f2d4d7cb4d2284daf66b3f9&amp;experiment_id=1&amp;trace_id=d624a05b74cc43a0a69bc8b400465a69&amp;experiment_id=1&amp;version=3.1.4"
  />
</div>
</div>
</div>
<p>We will now run the evaluation suite over the entire <code>gate dataset</code> for all the models in the above list.</p>
<div id="cell-45" class="cell" data-execution_count="427">
<div class="sourceCode" id="cb41"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>tdf <span class="op">=</span> pd.DataFrame(</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        {<span class="st">&quot;LLM&quot;</span>: llms[idx].model, <span class="st">&quot;Evaluation Score&quot;</span>: candidate[<span class="dv">0</span>]}</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, candidate <span class="kw">in</span> <span class="bu">enumerate</span>(results)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tdf)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                  LLM  Evaluation Score
0           openai/gpt-4.1-2025-04-14             62.91
1      openai/gpt-4.1-mini-2025-04-14             53.64
2           openai/o4-mini-2025-04-16             62.91
3  anthropic/claude-sonnet-4-20250514             62.91
4             gemini/gemini-2.5-flash             63.58
5        gemini/gemini-2.5-flash-lite             57.62
6                openai/o3-2025-04-16             70.20
7    anthropic/claude-opus-4-20250514             68.21
8               gemini/gemini-2.5-pro             68.21</code></pre>
</div>
</div>
<p>From the above table, we see a few interesting things:</p>
<ul>
<li>By default, most of the <strong>reasoning</strong> models perform better on the ‚Äúgate‚Äù dataset, with OAI O3 performing the best with a score of 70.20%</li>
<li>Reasoning models from the remaining two frontier labs score the same i.e 68.21%</li>
<li>We also see that the smaller reasoning models perform similar across the labs, with an average score of 63.58%, but at a <strong>significantly lower cost</strong>.</li>
<li>The outputs from sonnet-4 failed the structured output test, but this could be fixed using the DSPy TypingPredictor in the future. More on this later!</li>
<li>Finally, while a <em>non-reasoning</em> model like GPT-4.1 performs as well as the small reasoning models, the price of input/outputs tokens for GPT-4.1 is significantly higher compared to it‚Äôs counterparts.</li>
</ul>
<p>We will also run the test over the ‚Äúprobe‚Äù dataset, before deciding our final list of LLMs based on the performance-to-cost ratio.</p>
</section>
<section id="probe-dataset-results" class="level3">
<h3>Probe Dataset Results</h3>
<div id="cell-48" class="cell" data-execution_count="428">
<div class="sourceCode" id="cb43"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dspy.evaluate <span class="im">import</span> Evaluate</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>probe_results <span class="op">=</span> []</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;probe_dataset_results_full&quot;</span>) <span class="im">as</span> parent_ctx:</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> candidate_lm <span class="kw">in</span> model_selection_llms:</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f&quot;probe_</span><span class="sc">{</span>candidate_lm<span class="sc">.</span>model<span class="sc">.</span>replace(<span class="st">&#39;/&#39;</span>, <span class="st">&#39;_&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        sanitized_run_name <span class="op">=</span> re.sub(<span class="vs">r&quot;[^a-zA-Z0-9_\-]&quot;</span>, <span class="st">&quot;_&quot;</span>, run_name)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>sanitized_run_name, nested<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>            current_evaluator <span class="op">=</span> Evaluate(</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>                devset<span class="op">=</span>probe_examples,</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>                num_threads<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>                display_progress<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>                <span class="co"># display_table=True,</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># provide_traceback=True,</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>                return_all_scores<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>                return_outputs<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> dspy.context(lm<span class="op">=</span>candidate_lm) <span class="im">as</span> ctx:</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>                current_result <span class="op">=</span> current_evaluator(</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>                    TurnSolver(reasoning_lm<span class="op">=</span><span class="va">True</span>), metric<span class="op">=</span>turn_em_metric</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>                probe_results.append(current_result)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average Metric: 150.00 / 200 (75.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 200/200 [00:02&lt;00:00, 69.58it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/6cccc46d61ae4365b9921586ed0ef193
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run probe_openai_gpt-4_1-2025-04-14 at: http://localhost:5000/#/experiments/1/runs/3b839cca27264ffaaace2643e23975c7
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 130.00 / 200 (65.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 200/200 [00:03&lt;00:00, 60.95it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/8c371daf948343eb8a18370f1756a850
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run probe_openai_gpt-4_1-mini-2025-04-14 at: http://localhost:5000/#/experiments/1/runs/dcfce79bf36446929e2924273e0a2db5
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 79.00 / 102 (77.5%):  50%|‚ñà‚ñà‚ñà‚ñà‚ñà     | 101/200 [00:02&lt;00:02, 36.80it/s]Average Metric: 122.00 / 157 (77.7%):  78%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä  | 156/200 [00:03&lt;00:00, 48.01it/s]Average Metric: 157.00 / 200 (78.5%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 200/200 [00:03&lt;00:00, 53.12it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/758a3867a75541c2a3eab91ac6faf42b
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run probe_openai_o4-mini-2025-04-16 at: http://localhost:5000/#/experiments/1/runs/aafc2286d5ab4819aa467440328eed77
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 150.00 / 200 (75.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 200/200 [00:04&lt;00:00, 49.31it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/3b6644b108a241f99e8dd0e2e1d051fa
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run probe_anthropic_claude-sonnet-4-20250514 at: http://localhost:5000/#/experiments/1/runs/3b4f42a464cd4e3496f4b1755decd7ce
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 24.00 / 31 (77.4%):  15%|‚ñà‚ñå        | 30/200 [00:00&lt;00:03, 50.11it/s]Average Metric: 148.00 / 200 (74.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 200/200 [00:03&lt;00:00, 51.35it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/99af33e15c234269aa69333eebecb916
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run probe_gemini_gemini-2_5-flash at: http://localhost:5000/#/experiments/1/runs/7d11aa5ec28841adafa6b0e66733e13d
üß™ View experiment at: http://localhost:5000/#/experiments/1
  0%|          | 0/200 [00:00&lt;?, ?it/s]Average Metric: 11.00 / 16 (68.8%):   8%|‚ñä         | 15/200 [00:00&lt;00:04, 41.77it/s]Average Metric: 18.00 / 24 (75.0%):  12%|‚ñà‚ñè        | 23/200 [00:00&lt;00:03, 50.59it/s]Average Metric: 19.00 / 26 (73.1%):  12%|‚ñà‚ñé        | 25/200 [00:00&lt;00:03, 50.59it/s]Average Metric: 21.00 / 31 (67.7%):  15%|‚ñà‚ñå        | 30/200 [00:00&lt;00:02, 58.14it/s]Average Metric: 22.00 / 33 (66.7%):  16%|‚ñà‚ñå        | 32/200 [00:00&lt;00:02, 58.14it/s]Average Metric: 27.00 / 42 (64.3%):  20%|‚ñà‚ñà        | 41/200 [00:01&lt;00:04, 33.61it/s]Average Metric: 32.00 / 53 (60.4%):  26%|‚ñà‚ñà‚ñå       | 52/200 [00:01&lt;00:03, 43.63it/s]Average Metric: 36.00 / 61 (59.0%):  30%|‚ñà‚ñà‚ñà       | 60/200 [00:01&lt;00:02, 49.53it/s]Average Metric: 39.00 / 65 (60.0%):  32%|‚ñà‚ñà‚ñà‚ñè      | 64/200 [00:01&lt;00:02, 60.32it/s]Average Metric: 39.00 / 66 (59.1%):  32%|‚ñà‚ñà‚ñà‚ñé      | 65/200 [00:01&lt;00:02, 60.32it/s]Average Metric: 41.00 / 68 (60.3%):  34%|‚ñà‚ñà‚ñà‚ñé      | 67/200 [00:01&lt;00:02, 60.32it/s]Average Metric: 54.00 / 84 (64.3%):  42%|‚ñà‚ñà‚ñà‚ñà‚ñè     | 83/200 [00:01&lt;00:01, 69.98it/s]Average Metric: 60.00 / 93 (64.5%):  46%|‚ñà‚ñà‚ñà‚ñà‚ñå     | 92/200 [00:01&lt;00:01, 70.30it/s]Average Metric: 62.00 / 96 (64.6%):  48%|‚ñà‚ñà‚ñà‚ñà‚ñä     | 95/200 [00:01&lt;00:01, 70.30it/s]Average Metric: 62.00 / 97 (63.9%):  48%|‚ñà‚ñà‚ñà‚ñà‚ñä     | 96/200 [00:01&lt;00:01, 70.30it/s]Average Metric: 62.00 / 98 (63.3%):  49%|‚ñà‚ñà‚ñà‚ñà‚ñâ     | 98/200 [00:01&lt;00:01, 74.90it/s]Average Metric: 63.00 / 99 (63.6%):  49%|‚ñà‚ñà‚ñà‚ñà‚ñâ     | 98/200 [00:01&lt;00:01, 74.90it/s]Average Metric: 64.00 / 102 (62.7%):  50%|‚ñà‚ñà‚ñà‚ñà‚ñà     | 101/200 [00:01&lt;00:01, 74.90it/s]Average Metric: 65.00 / 103 (63.1%):  51%|‚ñà‚ñà‚ñà‚ñà‚ñà     | 102/200 [00:01&lt;00:01, 74.90it/s]Average Metric: 73.00 / 115 (63.5%):  57%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã    | 114/200 [00:02&lt;00:01, 56.16it/s]Average Metric: 76.00 / 119 (63.9%):  59%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ    | 118/200 [00:02&lt;00:01, 56.16it/s]Average Metric: 78.00 / 123 (63.4%):  61%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    | 122/200 [00:02&lt;00:01, 53.09it/s]Average Metric: 82.00 / 129 (63.6%):  64%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç   | 128/200 [00:02&lt;00:01, 45.61it/s]Average Metric: 82.00 / 130 (63.1%):  64%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç   | 129/200 [00:02&lt;00:01, 45.61it/s]Average Metric: 82.00 / 134 (61.2%):  66%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã   | 133/200 [00:02&lt;00:01, 46.87it/s]Average Metric: 83.00 / 135 (61.5%):  67%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã   | 134/200 [00:02&lt;00:01, 46.87it/s]Average Metric: 99.00 / 159 (62.3%):  80%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ  | 159/200 [00:03&lt;00:00, 46.30it/s]Average Metric: 104.00 / 165 (63.0%):  82%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè | 164/200 [00:03&lt;00:01, 35.61it/s]Average Metric: 105.00 / 166 (63.3%):  82%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé | 165/200 [00:03&lt;00:00, 35.61it/s]Average Metric: 105.00 / 167 (62.9%):  83%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé | 166/200 [00:03&lt;00:00, 35.61it/s]Average Metric: 128.00 / 200 (64.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 200/200 [00:03&lt;00:00, 52.47it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/20a1fa6983f349a0888cca2696bcae76
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run probe_gemini_gemini-2_5-flash-lite at: http://localhost:5000/#/experiments/1/runs/0c5ca9e2a1e84041b2937cd264727d94
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 48.00 / 61 (78.7%):  30%|‚ñà‚ñà‚ñà       | 60/200 [00:01&lt;00:03, 45.14it/s]Average Metric: 66.00 / 83 (79.5%):  41%|‚ñà‚ñà‚ñà‚ñà      | 82/200 [00:01&lt;00:01, 76.08it/s]Average Metric: 162.00 / 200 (81.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 200/200 [00:03&lt;00:00, 52.77it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/513ceb4b58c44816894f0196c05f1d27
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run probe_openai_o3-2025-04-16 at: http://localhost:5000/#/experiments/1/runs/07039e1be0154904a14bf5b215b36bfb
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 160.00 / 200 (80.0%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 200/200 [00:04&lt;00:00, 46.05it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/fa3840a6fc86489195ff4b93ba3525d3
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run probe_anthropic_claude-opus-4-20250514 at: http://localhost:5000/#/experiments/1/runs/242a848220a34df18fefcd752c6b1edf
üß™ View experiment at: http://localhost:5000/#/experiments/1
Average Metric: 157.00 / 200 (78.5%): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 200/200 [00:20&lt;00:00,  9.94it/s]
üèÉ View run eval at: http://localhost:5000/#/experiments/1/runs/28468bf07dea42438e3b2835cf8bd5d1
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run probe_gemini_gemini-2_5-pro at: http://localhost:5000/#/experiments/1/runs/b9decff973db41ce9863d93d41eff7c3
üß™ View experiment at: http://localhost:5000/#/experiments/1
üèÉ View run probe_dataset_results_full at: http://localhost:5000/#/experiments/1/runs/7f0b1ff0f4e94143b9fb5509ed6319be
üß™ View experiment at: http://localhost:5000/#/experiments/1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/28 18:22:15 INFO dspy.evaluate.evaluate: Average Metric: 150.0 / 200 (75.0%)
2025/07/28 18:22:18 INFO dspy.evaluate.evaluate: Average Metric: 130.0 / 200 (65.0%)
2025/07/28 18:22:20 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:21 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:22 INFO dspy.evaluate.evaluate: Average Metric: 157.0 / 200 (78.5%)
2025/07/28 18:22:26 INFO dspy.evaluate.evaluate: Average Metric: 150.0 / 200 (75.0%)
2025/07/28 18:22:27 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:30 INFO dspy.evaluate.evaluate: Average Metric: 148.0 / 200 (74.0%)
2025/07/28 18:22:30 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:30 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:30 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:30 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:31 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:31 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:31 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:31 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:31 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:31 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:31 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:31 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:31 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:31 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:31 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:31 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:31 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:32 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:32 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:32 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:32 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:32 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:32 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:32 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:32 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:32 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:32 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:33 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:33 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:33 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:33 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:33 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:33 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:33 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:33 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:33 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:33 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:33 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:33 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:34 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:34 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:34 WARNING dspy.clients.lm: LM response was truncated due to exceeding max_tokens=20000. You can inspect the latest LM interactions with `dspy.inspect_history()`. To avoid truncation, consider passing a larger max_tokens when setting up dspy.LM. You may also consider increasing the temperature (currently 0.0)  if the reason for truncation is repetition.
2025/07/28 18:22:34 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:34 INFO dspy.evaluate.evaluate: Average Metric: 128.0 / 200 (64.0%)
2025/07/28 18:22:35 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:36 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 18:22:38 INFO dspy.evaluate.evaluate: Average Metric: 162.0 / 200 (81.0%)
2025/07/28 18:22:43 INFO dspy.evaluate.evaluate: Average Metric: 160.0 / 200 (80.0%)
2025/07/28 18:23:03 INFO dspy.evaluate.evaluate: Average Metric: 157.0 / 200 (78.5%)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
  <button
    onclick="
        const display = this.nextElementSibling.style.display;
        const isCollapsed = display === 'none';
        this.nextElementSibling.style.display = isCollapsed ? null : 'none';

        const verb = isCollapsed ? 'Collapse' : 'Expand';
        this.innerText = `${verb} MLflow Trace`;
    "
  >Collapse MLflow Trace</button>
  <iframe
    id="trace-renderer"
    style="width: 100%; height: 500px; border: none; resize: vertical;"
    src="http://localhost:5000/static-files/lib/notebook-trace-renderer/index.html?trace_id=c5d368d7011e416bb8a6a45fb5757cc5&amp;experiment_id=1&amp;trace_id=c838fe37a1554a709c48aa7d91df4051&amp;experiment_id=1&amp;trace_id=e3e3b12245c145609fbd9f2ea7a38b35&amp;experiment_id=1&amp;trace_id=f05d4d95db7d4aceb8b4158a8cf0cfb0&amp;experiment_id=1&amp;trace_id=e996a1553f3b4c7b97af98bc3665f7aa&amp;experiment_id=1&amp;trace_id=02d784d19b414f16bc36df2f6cace3af&amp;experiment_id=1&amp;trace_id=a4955baaaf944dbbadcd4f05cb1c10aa&amp;experiment_id=1&amp;trace_id=fcaf8824996d4c7eab4d03bd198f2c33&amp;experiment_id=1&amp;trace_id=73db052bdbe1418eb46bc6ec442df95e&amp;experiment_id=1&amp;trace_id=66a0910a43384a9f993773961116b241&amp;experiment_id=1&amp;version=3.1.4"
  />
</div>
</div>
</div>
<div id="cell-49" class="cell" data-execution_count="430">
<div class="sourceCode" id="cb46"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>tdf <span class="op">=</span> pd.DataFrame(</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>        {<span class="st">&quot;LLM&quot;</span>: llms[idx].model, <span class="st">&quot;Evaluation Score&quot;</span>: candidate[<span class="dv">0</span>]}</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, candidate <span class="kw">in</span> <span class="bu">enumerate</span>(probe_results)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tdf)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                  LLM  Evaluation Score
0           openai/gpt-4.1-2025-04-14              75.0
1      openai/gpt-4.1-mini-2025-04-14              65.0
2           openai/o4-mini-2025-04-16              78.5
3  anthropic/claude-sonnet-4-20250514              75.0
4             gemini/gemini-2.5-flash              74.0
5        gemini/gemini-2.5-flash-lite              64.0
6                openai/o3-2025-04-16              81.0
7    anthropic/claude-opus-4-20250514              80.0
8               gemini/gemini-2.5-pro              78.5</code></pre>
</div>
</div>
<p>From the above, we see that:</p>
<ul>
<li>Similar to the gate-only results, the <em>probe</em> dataset results should that OAI o3 performs the best, with 81% accuracy.</li>
<li>Anthropic Opus is a close second, with 80% accuracy. However, it is <strong>significantly</strong> more expensive, at $15/Million tokens üò±</li>
<li>Google‚Äôs Frontier model Gemini-pro is third, with 78% accuracy.</li>
<li>We see that the smaller reasoning models do quite well, with o4-mini getting around 78.5% accuracy, Anthropic sonnet-4 around 75% accuracy, and Google Gemini 2.5-flash at 74%. Note that, even here, Anthropic‚Äôs costs are significantly higher than the other models.</li>
<li>We also see that the ‚Äúmini/lite‚Äù version of models provided by Google and OAI have similar performance, around ~65%.</li>
</ul>
<p>Given the above insights, we can now select our models:</p>
<ul>
<li><strong>Anthropic Cost</strong>
<ul>
<li>All Anthropic models are significantly more expensive than the competitors, and have a performance on par or below the competetiors.</li>
<li>Hence, from our final list, we will exclude Anthropic models.</li>
</ul></li>
<li><strong>Frontier Model Cost</strong>
<ul>
<li>Frontier models are generally quite expensive.</li>
<li>From our tests, we see that OAI o3 has the best performace, with Google Gemini 2.5-pro having a performance on or below o3.</li>
<li>To save costs, we will keep only one frontier model in the final list i.e o3</li>
</ul></li>
<li><strong>Smaller Reasoning Models</strong>
<ul>
<li>We also see the following models showing promising results across the board:
<ul>
<li>o4-mini</li>
<li>gemini-2.5-flash</li>
</ul></li>
</ul></li>
<li><strong>Non reaosning models</strong>
<ul>
<li>GPT-4.1 seems to perform as well as the smaller reasoning models, but it is about 50% more expensive($2/Million input tokens).</li>
<li>Given that we already plan to include models with similar reasoning capabilities, we will exclude GPT-4.1 from our final list.</li>
</ul></li>
<li><strong>Small models</strong>
<ul>
<li>Currently, the small models variants of all models are significantly behind the larger models.</li>
<li>While they are cost effective, and likely their performance can be increased with improvements to the prompts, fine-tuning, etc., we will skip this models for now due to time constraits.</li>
</ul></li>
</ul>
<p>Hence, our final list of models will be:</p>
<ul>
<li>o3</li>
<li>o4-mini</li>
<li>gemini-2.5-flash</li>
</ul>
</section>
<section id="error-analysis" class="level3">
<h3>Error Analysis</h3>
<p>Given that we have the results for the gate and probe datasets, we can perform some quick preliminary error analysis to understand the performance of the models on these datasets.</p>
<p>We will restrict our analysis to the final list of models(o3, o4-mini and gemini-2.5-flash).</p>
<div id="cell-54" class="cell" data-execution_count="431">
<div class="sourceCode" id="cb48"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>final_selected_models <span class="op">=</span> [</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    lm_oai_o4_mini,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    lm_gemini_flash_2_5,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    lm_oai_o3,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
</div>
<div id="cell-55" class="cell" data-execution_count="432">
<div class="sourceCode" id="cb49"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>gate_and_probe_results <span class="op">=</span> results <span class="op">+</span> probe_results</span></code></pre></div>
</div>
<div id="cell-56" class="cell" data-execution_count="433">
<div class="sourceCode" id="cb50"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(gate_and_probe_results)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="433">
<pre><code>18</code></pre>
</div>
</div>
<div id="cell-57" class="cell" data-execution_count="437">
<div class="sourceCode" id="cb52"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>selected_records <span class="op">=</span> []</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, record <span class="kw">in</span> <span class="bu">enumerate</span>(gate_and_probe_results):</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hack: Dirty hack to get results our selected LLMs. Sorry!</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> idx <span class="kw">in</span> [<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">11</span>, <span class="dv">13</span>, <span class="dv">15</span>]:</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> example, prediction, score <span class="kw">in</span> record[<span class="dv">1</span>]:</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>            model_idx <span class="op">=</span> idx <span class="cf">if</span> idx <span class="op">&lt;</span> <span class="dv">9</span> <span class="cf">else</span> idx <span class="op">-</span> <span class="dv">9</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>            example_copy <span class="op">=</span> deepcopy(example)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>            example_copy[<span class="st">&quot;ground_truth_answer&quot;</span>] <span class="op">=</span> example_copy[<span class="st">&quot;answer&quot;</span>]</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">del</span> example_copy[<span class="st">&quot;answer&quot;</span>]</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>            selected_records.append(</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;model_name&quot;</span>: model_selection_llms[model_idx].model,</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;turn_em_metric_score&quot;</span>: score,</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>                    <span class="op">**</span>example_copy.toDict(),</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>                    <span class="op">**</span>prediction.toDict(),</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>            )</span></code></pre></div>
</div>
<div id="cell-58" class="cell" data-execution_count="441">
<div class="sourceCode" id="cb53"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>selected_records[<span class="dv">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="441">
<pre><code>{&#39;model_name&#39;: &#39;openai/o4-mini-2025-04-16&#39;,
 &#39;turn_em_metric_score&#39;: 1.0,
 &#39;conversation_context&#39;: &#39;None&#39;,
 &#39;evidence_snippets&#39;: &quot;[PRE]\nentergy corporation and subsidiaries management&#39;s financial discussion and analysis refer to 201cselected financial data - five-year comparison of entergy corporation and subsidiaries 201d which accompanies entergy corporation 2019s financial statements in this report for further information with respect to operating statistics . in november 2007 the board approved a plan to pursue a separation of entergy 2019s non-utility nuclear business from entergy through a spin-off of the business to entergy shareholders . in april 2010 , entergy announced that it planned to unwind the business infrastructure associated with the proposed spin-off transaction . as a result of the plan to unwind the business infrastructure , entergy recorded expenses in 2010 for the write-off of certain capitalized costs incurred in connection with the planned spin-off transaction . these costs are discussed in more detail below and throughout this section . net revenue utility following is an analysis of the change in net revenue comparing 2010 to 2009 . amount ( in millions ) .\n[/PRE]\n[POST]\nthe volume/weather variance is primarily due to an increase of 8362 gwh , or 8% ( 8 % ) , in billed electricity usage in all retail sectors , including the effect on the residential sector of colder weather in the first quarter 2010 compared to 2009 and warmer weather in the second and third quarters 2010 compared to 2009 . the industrial sector reflected strong sales growth on continuing signs of economic recovery . the improvement in this sector was primarily driven by inventory restocking and strong exports with the chemicals , refining , and miscellaneous manufacturing sectors leading the improvement . the retail electric price variance is primarily due to : increases in the formula rate plan riders at entergy gulf states louisiana effective november 2009 , january 2010 , and september 2010 , at entergy louisiana effective november 2009 , and at entergy mississippi effective july 2009 ; a base rate increase at entergy arkansas effective july 2010 ; rate actions at entergy texas , including base rate increases effective in may and august 2010 ; a formula rate plan provision of $ 16.6 million recorded in the third quarter 2009 for refunds that were made to customers in accordance with settlements approved by the lpsc ; and the recovery in 2009 by entergy arkansas of 2008 extraordinary storm costs , as approved by the apsc , which ceased in january 2010 . the recovery of storm costs is offset in other operation and maintenance expenses . see note 2 to the financial statements for further discussion of the proceedings referred to above. .\n[/POST]&quot;,
 &#39;table&#39;: &#39;| Row | 2009 net revenue | volume/weather | retail electric price | provision for regulatory proceedings | rough production cost equalization | ano decommissioning trust | fuel recovery | other | 2010 net revenue |\n|---|---|---|---|---|---|---|---|---|---|\n| amount ( in millions ) | 4694.0 | 231.0 | 137.0 | 26.0 | 19.0 | -24.0 | -44.0 | 12.0 | 5051.0 |&#39;,
 &#39;question&#39;: &#39;what was the difference in net revenue between 2009 and 2010?&#39;,
 &#39;id&#39;: &#39;Single_ETR/2011/page_22.pdf-3&#39;,
 &#39;doc_pre_text&#39;: &quot;entergy corporation and subsidiaries management&#39;s financial discussion and analysis refer to 201cselected financial data - five-year comparison of entergy corporation and subsidiaries 201d which accompanies entergy corporation 2019s financial statements in this report for further information with respect to operating statistics . in november 2007 the board approved a plan to pursue a separation of entergy 2019s non-utility nuclear business from entergy through a spin-off of the business to entergy shareholders . in april 2010 , entergy announced that it planned to unwind the business infrastructure associated with the proposed spin-off transaction . as a result of the plan to unwind the business infrastructure , entergy recorded expenses in 2010 for the write-off of certain capitalized costs incurred in connection with the planned spin-off transaction . these costs are discussed in more detail below and throughout this section . net revenue utility following is an analysis of the change in net revenue comparing 2010 to 2009 . amount ( in millions ) .&quot;,
 &#39;doc_post_text&#39;: &#39;the volume/weather variance is primarily due to an increase of 8362 gwh , or 8% ( 8 % ) , in billed electricity usage in all retail sectors , including the effect on the residential sector of colder weather in the first quarter 2010 compared to 2009 and warmer weather in the second and third quarters 2010 compared to 2009 . the industrial sector reflected strong sales growth on continuing signs of economic recovery . the improvement in this sector was primarily driven by inventory restocking and strong exports with the chemicals , refining , and miscellaneous manufacturing sectors leading the improvement . the retail electric price variance is primarily due to : increases in the formula rate plan riders at entergy gulf states louisiana effective november 2009 , january 2010 , and september 2010 , at entergy louisiana effective november 2009 , and at entergy mississippi effective july 2009 ; a base rate increase at entergy arkansas effective july 2010 ; rate actions at entergy texas , including base rate increases effective in may and august 2010 ; a formula rate plan provision of $ 16.6 million recorded in the third quarter 2009 for refunds that were made to customers in accordance with settlements approved by the lpsc ; and the recovery in 2009 by entergy arkansas of 2008 extraordinary storm costs , as approved by the apsc , which ceased in january 2010 . the recovery of storm costs is offset in other operation and maintenance expenses . see note 2 to the financial statements for further discussion of the proceedings referred to above. .&#39;,
 &#39;doc_table&#39;: {&#39;amount ( in millions )&#39;: {&#39;2009 net revenue&#39;: 4694.0,
   &#39;volume/weather&#39;: 231.0,
   &#39;retail electric price&#39;: 137.0,
   &#39;provision for regulatory proceedings&#39;: 26.0,
   &#39;rough production cost equalization&#39;: 19.0,
   &#39;ano decommissioning trust&#39;: -24.0,
   &#39;fuel recovery&#39;: -44.0,
   &#39;other&#39;: 12.0,
   &#39;2010 net revenue&#39;: 5051.0}},
 &#39;dialogue_conv_questions&#39;: [&#39;what was the difference in net revenue between 2009 and 2010?&#39;,
  &#39;and the specific value for 2009 again?&#39;,
  &#39;so what was the percentage change during this time?&#39;],
 &#39;dialogue_conv_answers&#39;: [&#39;357&#39;, &#39;4694&#39;, &#39;7.61%&#39;],
 &#39;dialogue_turn_program&#39;: [&#39;subtract(5051, 4694)&#39;,
  &#39;4694&#39;,
  &#39;subtract(5051, 4694), divide(#0, 4694)&#39;],
 &#39;dialogue_executed_answers&#39;: [357.0, 4694.0, 0.07605],
 &#39;dialogue_qa_split&#39;: [False, False, False],
 &#39;features_num_dialogue_turns&#39;: 3,
 &#39;features_has_type2_question&#39;: False,
 &#39;features_has_duplicate_columns&#39;: False,
 &#39;features_has_non_numeric_values&#39;: False,
 &#39;ground_truth_answer&#39;: 357.0,
 &#39;reasoning&#39;: &#39;The table shows 2009 net revenue of 4,694.0 million and 2010 net revenue of 5,051.0 million. The difference is 5,051.0 minus 4,694.0, which equals 357.0 million.&#39;,
 &#39;ops&#39;: &#39;subtract(const_5051.0, const_4694.0)&#39;,
 &#39;answer&#39;: &#39;357.0&#39;}</code></pre>
</div>
</div>
<div id="cell-59" class="cell" data-execution_count="462">
<div class="sourceCode" id="cb55"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Literal</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AssessmentSignature(dspy.Signature):</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Categorize model predictions by comparing them to ground truth, context, and evidence.</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Assign a specific error type or OK label, with concise justification, based on rubric.</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="co">    When comparing numerical answers, always allow a tolerance of 1e-2. For eg: If the question asks for a percentage, but the ground_truth_answer is given as a decimal, the assessment_answer label will be GROUND_TRUTH_INCORRECT</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    ground_truth_answer: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;The correct answer as per the ground truth data.&quot;</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    table: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Tabular data (as string) relevant to the question and answer.&quot;</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    conversation_context: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Previous dialogue turns or context for the current question.&quot;</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    evidence_snippets: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Text snippets from the source document supporting the answer.&quot;</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    question: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">&quot;The question being answered by the model.&quot;</span>)</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>    predicted_reasoning: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Model&#39;s step-by-step explanation or justification for its answer.&quot;</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    predicted_ops: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;Operations or programmatic steps the model used to derive its answer.&quot;</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>    predicted_answer: <span class="bu">str</span> <span class="op">=</span> dspy.InputField(</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>        desc<span class="op">=</span><span class="st">&quot;The answer predicted by the model for the given question.&quot;</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>    assessment_answer: Literal[</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;OK&quot;</span>,</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;NUMERICAL_ANSWER_WRONG&quot;</span>,</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;TEXTUAL_SELECTION_ANSWER_WRONG&quot;</span>,</span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;FORMAT_ERROR&quot;</span>,</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;EVIDENCE_MISMATCH&quot;</span>,</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;GROUND_TRUTH_INCORRECT&quot;</span>,</span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>    ] <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">&quot;Single categorical label.&quot;</span>)</span></code></pre></div>
</div>
<div id="cell-60" class="cell" data-execution_count="468">
<div class="sourceCode" id="cb56"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>selected_records[<span class="dv">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="468">
<pre><code>{&#39;model_name&#39;: &#39;openai/o4-mini-2025-04-16&#39;,
 &#39;turn_em_metric_score&#39;: 1.0,
 &#39;conversation_context&#39;: &#39;None&#39;,
 &#39;evidence_snippets&#39;: &quot;[PRE]\nentergy corporation and subsidiaries management&#39;s financial discussion and analysis refer to 201cselected financial data - five-year comparison of entergy corporation and subsidiaries 201d which accompanies entergy corporation 2019s financial statements in this report for further information with respect to operating statistics . in november 2007 the board approved a plan to pursue a separation of entergy 2019s non-utility nuclear business from entergy through a spin-off of the business to entergy shareholders . in april 2010 , entergy announced that it planned to unwind the business infrastructure associated with the proposed spin-off transaction . as a result of the plan to unwind the business infrastructure , entergy recorded expenses in 2010 for the write-off of certain capitalized costs incurred in connection with the planned spin-off transaction . these costs are discussed in more detail below and throughout this section . net revenue utility following is an analysis of the change in net revenue comparing 2010 to 2009 . amount ( in millions ) .\n[/PRE]\n[POST]\nthe volume/weather variance is primarily due to an increase of 8362 gwh , or 8% ( 8 % ) , in billed electricity usage in all retail sectors , including the effect on the residential sector of colder weather in the first quarter 2010 compared to 2009 and warmer weather in the second and third quarters 2010 compared to 2009 . the industrial sector reflected strong sales growth on continuing signs of economic recovery . the improvement in this sector was primarily driven by inventory restocking and strong exports with the chemicals , refining , and miscellaneous manufacturing sectors leading the improvement . the retail electric price variance is primarily due to : increases in the formula rate plan riders at entergy gulf states louisiana effective november 2009 , january 2010 , and september 2010 , at entergy louisiana effective november 2009 , and at entergy mississippi effective july 2009 ; a base rate increase at entergy arkansas effective july 2010 ; rate actions at entergy texas , including base rate increases effective in may and august 2010 ; a formula rate plan provision of $ 16.6 million recorded in the third quarter 2009 for refunds that were made to customers in accordance with settlements approved by the lpsc ; and the recovery in 2009 by entergy arkansas of 2008 extraordinary storm costs , as approved by the apsc , which ceased in january 2010 . the recovery of storm costs is offset in other operation and maintenance expenses . see note 2 to the financial statements for further discussion of the proceedings referred to above. .\n[/POST]&quot;,
 &#39;table&#39;: &#39;| Row | 2009 net revenue | volume/weather | retail electric price | provision for regulatory proceedings | rough production cost equalization | ano decommissioning trust | fuel recovery | other | 2010 net revenue |\n|---|---|---|---|---|---|---|---|---|---|\n| amount ( in millions ) | 4694.0 | 231.0 | 137.0 | 26.0 | 19.0 | -24.0 | -44.0 | 12.0 | 5051.0 |&#39;,
 &#39;question&#39;: &#39;what was the difference in net revenue between 2009 and 2010?&#39;,
 &#39;id&#39;: &#39;Single_ETR/2011/page_22.pdf-3&#39;,
 &#39;doc_pre_text&#39;: &quot;entergy corporation and subsidiaries management&#39;s financial discussion and analysis refer to 201cselected financial data - five-year comparison of entergy corporation and subsidiaries 201d which accompanies entergy corporation 2019s financial statements in this report for further information with respect to operating statistics . in november 2007 the board approved a plan to pursue a separation of entergy 2019s non-utility nuclear business from entergy through a spin-off of the business to entergy shareholders . in april 2010 , entergy announced that it planned to unwind the business infrastructure associated with the proposed spin-off transaction . as a result of the plan to unwind the business infrastructure , entergy recorded expenses in 2010 for the write-off of certain capitalized costs incurred in connection with the planned spin-off transaction . these costs are discussed in more detail below and throughout this section . net revenue utility following is an analysis of the change in net revenue comparing 2010 to 2009 . amount ( in millions ) .&quot;,
 &#39;doc_post_text&#39;: &#39;the volume/weather variance is primarily due to an increase of 8362 gwh , or 8% ( 8 % ) , in billed electricity usage in all retail sectors , including the effect on the residential sector of colder weather in the first quarter 2010 compared to 2009 and warmer weather in the second and third quarters 2010 compared to 2009 . the industrial sector reflected strong sales growth on continuing signs of economic recovery . the improvement in this sector was primarily driven by inventory restocking and strong exports with the chemicals , refining , and miscellaneous manufacturing sectors leading the improvement . the retail electric price variance is primarily due to : increases in the formula rate plan riders at entergy gulf states louisiana effective november 2009 , january 2010 , and september 2010 , at entergy louisiana effective november 2009 , and at entergy mississippi effective july 2009 ; a base rate increase at entergy arkansas effective july 2010 ; rate actions at entergy texas , including base rate increases effective in may and august 2010 ; a formula rate plan provision of $ 16.6 million recorded in the third quarter 2009 for refunds that were made to customers in accordance with settlements approved by the lpsc ; and the recovery in 2009 by entergy arkansas of 2008 extraordinary storm costs , as approved by the apsc , which ceased in january 2010 . the recovery of storm costs is offset in other operation and maintenance expenses . see note 2 to the financial statements for further discussion of the proceedings referred to above. .&#39;,
 &#39;doc_table&#39;: {&#39;amount ( in millions )&#39;: {&#39;2009 net revenue&#39;: 4694.0,
   &#39;volume/weather&#39;: 231.0,
   &#39;retail electric price&#39;: 137.0,
   &#39;provision for regulatory proceedings&#39;: 26.0,
   &#39;rough production cost equalization&#39;: 19.0,
   &#39;ano decommissioning trust&#39;: -24.0,
   &#39;fuel recovery&#39;: -44.0,
   &#39;other&#39;: 12.0,
   &#39;2010 net revenue&#39;: 5051.0}},
 &#39;dialogue_conv_questions&#39;: [&#39;what was the difference in net revenue between 2009 and 2010?&#39;,
  &#39;and the specific value for 2009 again?&#39;,
  &#39;so what was the percentage change during this time?&#39;],
 &#39;dialogue_conv_answers&#39;: [&#39;357&#39;, &#39;4694&#39;, &#39;7.61%&#39;],
 &#39;dialogue_turn_program&#39;: [&#39;subtract(5051, 4694)&#39;,
  &#39;4694&#39;,
  &#39;subtract(5051, 4694), divide(#0, 4694)&#39;],
 &#39;dialogue_executed_answers&#39;: [357.0, 4694.0, 0.07605],
 &#39;dialogue_qa_split&#39;: [False, False, False],
 &#39;features_num_dialogue_turns&#39;: 3,
 &#39;features_has_type2_question&#39;: False,
 &#39;features_has_duplicate_columns&#39;: False,
 &#39;features_has_non_numeric_values&#39;: False,
 &#39;ground_truth_answer&#39;: 357.0,
 &#39;reasoning&#39;: &#39;The table shows 2009 net revenue of 4,694.0 million and 2010 net revenue of 5,051.0 million. The difference is 5,051.0 minus 4,694.0, which equals 357.0 million.&#39;,
 &#39;ops&#39;: &#39;subtract(const_5051.0, const_4694.0)&#39;,
 &#39;answer&#39;: &#39;357.0&#39;}</code></pre>
</div>
</div>
<div id="cell-61" class="cell" data-execution_count="469">
<div class="sourceCode" id="cb58"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>judge_examples <span class="op">=</span> []</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> record <span class="kw">in</span> selected_records:</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> record[<span class="st">&quot;turn_em_metric_score&quot;</span>] <span class="op">!=</span> <span class="dv">1</span>:</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        judge_examples.append(</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>            dspy.Example(</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>                <span class="bu">id</span><span class="op">=</span>record[<span class="st">&quot;id&quot;</span>],</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                model_name<span class="op">=</span>record[<span class="st">&quot;model_name&quot;</span>],</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>                predicted_reasoning<span class="op">=</span>record[<span class="st">&quot;reasoning&quot;</span>],</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>                predicted_ops<span class="op">=</span>record[<span class="st">&quot;ops&quot;</span>],</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>                predicted_answer<span class="op">=</span>record[<span class="st">&quot;answer&quot;</span>],</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>                ground_truth_answer<span class="op">=</span>record[<span class="st">&quot;ground_truth_answer&quot;</span>],</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>                table<span class="op">=</span>record[<span class="st">&quot;table&quot;</span>],</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>                conversation_context<span class="op">=</span>record[<span class="st">&quot;conversation_context&quot;</span>],</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>                evidence_snippets<span class="op">=</span>record[<span class="st">&quot;evidence_snippets&quot;</span>],</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>                question<span class="op">=</span>record[<span class="st">&quot;question&quot;</span>],</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>            ).with_inputs(</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;predicted_reasoning&quot;</span>,</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;predicted_ops&quot;</span>,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;predicted_answer&quot;</span>,</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;ground_truth_answer&quot;</span>,</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;table&quot;</span>,</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;conversation_context&quot;</span>,</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;evidence_snippets&quot;</span>,</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;question&quot;</span>,</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
</div>
<p>We‚Äôll use Gemini Flash 2.5 as our judge model, for classifying the generated predictions for error analysis</p>
<div id="cell-63" class="cell" data-execution_count="489">
<div class="sourceCode" id="cb59"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>judge_lm <span class="op">=</span> deepcopy(lm_gemini_flash_2_5)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>judge_results <span class="op">=</span> []</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;error_analysis_gemini_2.5_flash&quot;</span>) <span class="im">as</span> run:</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> dspy.context(lm<span class="op">=</span>judge_lm, cache<span class="op">=</span><span class="va">True</span>, track_cost<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> example <span class="kw">in</span> tqdm(judge_examples, desc<span class="op">=</span><span class="st">&quot;Judging examples&quot;</span>):</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>            module <span class="op">=</span> dspy.ChainOfThought(AssessmentSignature)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>            jr <span class="op">=</span> module(<span class="op">**</span>example)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>            jr[<span class="st">&quot;assessment_reasoning&quot;</span>] <span class="op">=</span> jr[<span class="st">&quot;reasoning&quot;</span>]</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">del</span> jr[<span class="st">&quot;reasoning&quot;</span>]</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>            judge_results.append(</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;id&quot;</span>: example[<span class="st">&quot;id&quot;</span>],</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;model_name&quot;</span>: example[<span class="st">&quot;model_name&quot;</span>],</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;question&quot;</span>: example[<span class="st">&quot;question&quot;</span>],</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;ground_truth_answer&quot;</span>: example[<span class="st">&quot;ground_truth_answer&quot;</span>],</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;predicted_answer&quot;</span>: example[<span class="st">&quot;predicted_answer&quot;</span>],</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;assessment_answer&quot;</span>: jr[<span class="st">&quot;assessment_answer&quot;</span>],</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;assessment_reasoning&quot;</span>: jr[<span class="st">&quot;assessment_reasoning&quot;</span>],</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>            )</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Judging examples:   1%|          | 2/289 [00:00&lt;00:17, 16.77it/s]2025/07/28 20:07:50 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:   1%|‚ñè         | 4/289 [00:00&lt;00:19, 14.79it/s]2025/07/28 20:07:50 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:   2%|‚ñè         | 6/289 [00:00&lt;00:19, 14.85it/s]2025/07/28 20:07:50 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:50 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:   4%|‚ñç         | 11/289 [00:00&lt;00:22, 12.42it/s]2025/07/28 20:07:51 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:   5%|‚ñç         | 14/289 [00:00&lt;00:18, 15.05it/s]2025/07/28 20:07:51 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:51 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:   6%|‚ñå         | 17/289 [00:01&lt;00:15, 18.13it/s]2025/07/28 20:07:51 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:51 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:   7%|‚ñã         | 20/289 [00:01&lt;00:13, 19.77it/s]2025/07/28 20:07:51 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:   8%|‚ñä         | 24/289 [00:01&lt;00:11, 23.48it/s]2025/07/28 20:07:51 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  10%|‚ñâ         | 28/289 [00:01&lt;00:09, 26.52it/s]2025/07/28 20:07:51 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  11%|‚ñà         | 32/289 [00:01&lt;00:09, 27.24it/s]2025/07/28 20:07:51 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  12%|‚ñà‚ñè        | 35/289 [00:01&lt;00:10, 23.43it/s]2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  13%|‚ñà‚ñé        | 38/289 [00:01&lt;00:10, 23.92it/s]2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  14%|‚ñà‚ñç        | 41/289 [00:01&lt;00:10, 23.64it/s]2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  15%|‚ñà‚ñå        | 44/289 [00:02&lt;00:10, 24.06it/s]2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  16%|‚ñà‚ñã        | 47/289 [00:02&lt;00:09, 24.36it/s]2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  17%|‚ñà‚ñã        | 50/289 [00:02&lt;00:09, 24.44it/s]2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  18%|‚ñà‚ñä        | 53/289 [00:02&lt;00:10, 23.14it/s]2025/07/28 20:07:52 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  20%|‚ñà‚ñà        | 59/289 [00:02&lt;00:11, 20.29it/s]2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  21%|‚ñà‚ñà‚ñè       | 62/289 [00:03&lt;00:13, 16.86it/s]2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  22%|‚ñà‚ñà‚ñè       | 65/289 [00:03&lt;00:11, 19.32it/s]2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  24%|‚ñà‚ñà‚ñé       | 68/289 [00:03&lt;00:10, 20.77it/s]2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  25%|‚ñà‚ñà‚ñç       | 71/289 [00:03&lt;00:09, 22.32it/s]2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  26%|‚ñà‚ñà‚ñå       | 74/289 [00:03&lt;00:09, 22.84it/s]2025/07/28 20:07:53 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  27%|‚ñà‚ñà‚ñã       | 77/289 [00:03&lt;00:09, 22.32it/s]2025/07/28 20:07:54 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  28%|‚ñà‚ñà‚ñä       | 80/289 [00:03&lt;00:10, 20.68it/s]2025/07/28 20:07:54 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  30%|‚ñà‚ñà‚ñâ       | 86/289 [00:04&lt;00:09, 21.69it/s]2025/07/28 20:07:54 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:54 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:54 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  31%|‚ñà‚ñà‚ñà       | 89/289 [00:04&lt;00:09, 21.10it/s]2025/07/28 20:07:54 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  32%|‚ñà‚ñà‚ñà‚ñè      | 92/289 [00:04&lt;00:09, 21.50it/s]2025/07/28 20:07:54 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:54 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  33%|‚ñà‚ñà‚ñà‚ñé      | 95/289 [00:04&lt;00:08, 22.81it/s]2025/07/28 20:07:54 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  34%|‚ñà‚ñà‚ñà‚ñç      | 98/289 [00:04&lt;00:07, 23.91it/s]2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  35%|‚ñà‚ñà‚ñà‚ñç      | 101/289 [00:04&lt;00:07, 24.41it/s]2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  36%|‚ñà‚ñà‚ñà‚ñå      | 104/289 [00:04&lt;00:08, 20.70it/s]2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  37%|‚ñà‚ñà‚ñà‚ñã      | 107/289 [00:05&lt;00:11, 16.11it/s]2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  38%|‚ñà‚ñà‚ñà‚ñä      | 110/289 [00:05&lt;00:09, 18.39it/s]2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  39%|‚ñà‚ñà‚ñà‚ñâ      | 114/289 [00:05&lt;00:08, 21.66it/s]2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:55 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  41%|‚ñà‚ñà‚ñà‚ñà      | 118/289 [00:05&lt;00:07, 24.12it/s]2025/07/28 20:07:56 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:56 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  42%|‚ñà‚ñà‚ñà‚ñà‚ñè     | 122/289 [00:05&lt;00:06, 25.92it/s]2025/07/28 20:07:56 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  44%|‚ñà‚ñà‚ñà‚ñà‚ñç     | 128/289 [00:05&lt;00:06, 23.89it/s]2025/07/28 20:07:56 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:56 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  45%|‚ñà‚ñà‚ñà‚ñà‚ñå     | 131/289 [00:06&lt;00:06, 22.85it/s]2025/07/28 20:07:56 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  46%|‚ñà‚ñà‚ñà‚ñà‚ñã     | 134/289 [00:06&lt;00:06, 23.46it/s]2025/07/28 20:07:56 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  47%|‚ñà‚ñà‚ñà‚ñà‚ñã     | 137/289 [00:06&lt;00:06, 23.90it/s]2025/07/28 20:07:56 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:56 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  48%|‚ñà‚ñà‚ñà‚ñà‚ñä     | 140/289 [00:06&lt;00:06, 23.84it/s]2025/07/28 20:07:56 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  52%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè    | 149/289 [00:06&lt;00:05, 24.60it/s]2025/07/28 20:07:57 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:57 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:57 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  54%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé    | 155/289 [00:07&lt;00:06, 22.09it/s]2025/07/28 20:07:57 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:57 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:57 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  55%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç    | 158/289 [00:07&lt;00:07, 18.30it/s]2025/07/28 20:07:57 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:57 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  56%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå    | 161/289 [00:07&lt;00:06, 19.50it/s]2025/07/28 20:07:57 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:57 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  57%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã    | 164/289 [00:07&lt;00:05, 21.21it/s]2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  58%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä    | 168/289 [00:07&lt;00:05, 23.87it/s]2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  60%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ    | 172/289 [00:07&lt;00:04, 25.66it/s]2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  61%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    | 175/289 [00:07&lt;00:04, 26.17it/s]2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  62%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè   | 178/289 [00:08&lt;00:05, 20.48it/s]2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  63%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé   | 181/289 [00:08&lt;00:05, 19.97it/s]2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  64%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé   | 184/289 [00:08&lt;00:04, 21.03it/s]2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:58 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  65%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç   | 187/289 [00:08&lt;00:04, 21.89it/s]2025/07/28 20:07:59 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:59 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:59 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  66%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå   | 190/289 [00:08&lt;00:04, 20.94it/s]2025/07/28 20:07:59 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  67%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã   | 193/289 [00:08&lt;00:04, 21.33it/s]2025/07/28 20:07:59 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  68%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä   | 196/289 [00:09&lt;00:04, 21.37it/s]2025/07/28 20:07:59 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:07:59 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  69%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ   | 199/289 [00:09&lt;00:05, 17.97it/s]2025/07/28 20:07:59 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  70%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ   | 201/289 [00:09&lt;00:05, 16.87it/s]2025/07/28 20:07:59 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  70%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   | 203/289 [00:09&lt;00:05, 14.73it/s]2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  71%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè  | 206/289 [00:09&lt;00:04, 17.68it/s]2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  74%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé  | 213/289 [00:09&lt;00:03, 23.63it/s]2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  75%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç  | 216/289 [00:10&lt;00:02, 24.77it/s]2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  76%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå  | 219/289 [00:10&lt;00:02, 25.95it/s]2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  77%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã  | 222/289 [00:10&lt;00:02, 22.83it/s]2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  78%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä  | 225/289 [00:10&lt;00:03, 19.59it/s]2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:00 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  79%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ  | 228/289 [00:10&lt;00:03, 19.79it/s]2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  80%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ  | 231/289 [00:10&lt;00:02, 20.88it/s]2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  81%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  | 234/289 [00:10&lt;00:02, 22.36it/s]2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  82%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè | 237/289 [00:11&lt;00:02, 22.83it/s]2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  83%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé | 240/289 [00:11&lt;00:02, 22.23it/s]2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  84%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç | 243/289 [00:11&lt;00:02, 21.50it/s]2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:01 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  85%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå | 246/289 [00:11&lt;00:02, 14.67it/s]2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  86%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå | 249/289 [00:11&lt;00:02, 16.99it/s]2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  87%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã | 252/289 [00:11&lt;00:01, 19.29it/s]2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  89%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä | 256/289 [00:12&lt;00:01, 22.46it/s]2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  90%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ | 260/289 [00:12&lt;00:01, 24.88it/s]2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  91%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà | 263/289 [00:12&lt;00:01, 24.21it/s]2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  92%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñè| 266/289 [00:12&lt;00:00, 25.37it/s]2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:02 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  93%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñé| 269/289 [00:12&lt;00:00, 20.30it/s]2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  94%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñç| 272/289 [00:12&lt;00:00, 19.67it/s]2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  95%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå| 275/289 [00:12&lt;00:00, 20.71it/s]2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  96%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñå| 278/289 [00:13&lt;00:00, 21.31it/s]2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  97%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã| 281/289 [00:13&lt;00:00, 22.55it/s]2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  98%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñä| 284/289 [00:13&lt;00:00, 22.90it/s]2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples:  99%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñâ| 287/289 [00:13&lt;00:00, 23.65it/s]2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
2025/07/28 20:08:03 WARNING dspy.adapters.json_adapter: Failed to use structured output format, falling back to JSON mode.
Judging examples: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 289/289 [00:13&lt;00:00, 21.43it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>üèÉ View run error_analysis_gemini_2.5_flash at: http://localhost:5000/#/experiments/1/runs/d415524ddcf94cd086f2f221c2f6f177
üß™ View experiment at: http://localhost:5000/#/experiments/1</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>
  <style scoped>
  button {
    border: none;
    border-radius: 4px;
    background-color: rgb(34, 114, 180);
    font-family: -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    font-size: 13px;
    color: white;
    margin-top: 8px;
    margin-bottom: 8px;
    padding: 8px 16px;
    cursor: pointer;
  }
  button:hover {
    background-color: rgb(66, 153, 224);
  }
  </style>
  <button
    onclick="
        const display = this.nextElementSibling.style.display;
        const isCollapsed = display === 'none';
        this.nextElementSibling.style.display = isCollapsed ? null : 'none';

        const verb = isCollapsed ? 'Collapse' : 'Expand';
        this.innerText = `${verb} MLflow Trace`;
    "
  >Collapse MLflow Trace</button>
  <iframe
    id="trace-renderer"
    style="width: 100%; height: 500px; border: none; resize: vertical;"
    src="http://localhost:5000/static-files/lib/notebook-trace-renderer/index.html?trace_id=f51ec31b099c4ccb884824cd84faf244&amp;experiment_id=1&amp;trace_id=2b2a5bac43db4bdf8f1ba27a0c72707f&amp;experiment_id=1&amp;trace_id=33d30ce093eb4bcb8959b7e7b14f4f03&amp;experiment_id=1&amp;trace_id=585d29108d074c8eb2546d615be4e058&amp;experiment_id=1&amp;trace_id=f458046f22604e4cbb206f2ddea55891&amp;experiment_id=1&amp;trace_id=fae282bd8d524323a37fbafd71e5e50f&amp;experiment_id=1&amp;trace_id=e0f8503464d846308c8ac03dd3897e1a&amp;experiment_id=1&amp;trace_id=2f17ef3a251a4472920aac663506297b&amp;experiment_id=1&amp;trace_id=cb93f2fdd18b4a1289219be14632eeb9&amp;experiment_id=1&amp;trace_id=29a36ca6d3bb4720860417319bbe8d68&amp;experiment_id=1&amp;version=3.1.4"
  />
</div>
</div>
</div>
<div id="cell-64" class="cell" data-execution_count="490">
<div class="sourceCode" id="cb62"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(judge_results)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>grouped <span class="op">=</span> (</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">&quot;model_name&quot;</span>, <span class="st">&quot;assessment_answer&quot;</span>]).size().reset_index(name<span class="op">=</span><span class="st">&quot;count&quot;</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(data<span class="op">=</span>grouped, x<span class="op">=</span><span class="st">&quot;model_name&quot;</span>, y<span class="op">=</span><span class="st">&quot;count&quot;</span>, hue<span class="op">=</span><span class="st">&quot;assessment_answer&quot;</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Assessment Answer Counts by Model&quot;</span>)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Count&quot;</span>)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Model Name&quot;</span>)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">&quot;Assessment Answer&quot;</span>)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value annotations</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> ax.patches:</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> p.get_height()</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> height <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>        ax.annotate(</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f&quot;</span><span class="sc">{</span><span class="bu">int</span>(height)<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>            (p.get_x() <span class="op">+</span> p.get_width() <span class="op">/</span> <span class="dv">2</span>, height),</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">&quot;center&quot;</span>,</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>            va<span class="op">=</span><span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>            fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">&quot;black&quot;</span>,</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>            xytext<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>            textcoords<span class="op">=</span><span class="st">&quot;offset points&quot;</span>,</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure>
<p><a href="2025-09-01-cl-dspy-modelling_files/figure-html/cell-40-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="2025-09-01-cl-dspy-modelling_files/figure-html/cell-40-output-1.png" class="img-fluid" /></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-65" class="cell" data-execution_count="502">
<div class="sourceCode" id="cb63"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">&#39;./judge_results/gate_and_probe_judge_results.csv&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
</div>
<p>From the analysis above, we see that: - Majority of the errors for all our selected models are due to <strong>incorrect ground truth</strong>. - We also see cases where the model was unable to generate the answer in the format as expected by the ground truth. - Finally, somewhat surpringly, we see some results marked as ‚ÄúOK‚Äù, even though we only selected records that didn‚Äôt match the ground truth using our <em>exact match</em> metric.</p>
<p>Let‚Äôs look through this more closely:</p>
<div id="cell-67" class="cell" data-execution_count="503">
<div class="sourceCode" id="cb64"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>df[df[<span class="st">&quot;assessment_answer&quot;</span>] <span class="op">==</span> <span class="st">&quot;GROUND_TRUTH_INCORRECT&quot;</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="503">
<div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header" style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">model_name</th>
<th data-quarto-table-cell-role="th">question</th>
<th data-quarto-table-cell-role="th">ground_truth_answer</th>
<th data-quarto-table-cell-role="th">predicted_answer</th>
<th data-quarto-table-cell-role="th">assessment_answer</th>
<th data-quarto-table-cell-role="th">assessment_reasoning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Single_ETR/2011/page_22.pdf-3</td>
<td>openai/o4-mini-2025-04-16</td>
<td>so what was the percentage change during this time?</td>
<td>7.605000e-02</td>
<td>7.6%</td>
<td>GROUND_TRUTH_INCORRECT</td>
<td>The question asks for a "percentage change". The model correctly c...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Single_ETR/2004/page_258.pdf-4</td>
<td>openai/o4-mini-2025-04-16</td>
<td>what is the percent change?</td>
<td>1.473800e-01</td>
<td>14.7%</td>
<td>GROUND_TRUTH_INCORRECT</td>
<td>The question asks for the "percent change". The predicted answer p...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>Single_ADI/2011/page_83.pdf-2</td>
<td>openai/o4-mini-2025-04-16</td>
<td>what growth rate does this represent?</td>
<td>8.290600e-01</td>
<td>82.9%</td>
<td>GROUND_TRUTH_INCORRECT</td>
<td>The question asks for a 'growth rate', which is typically expresse...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>Single_CB/2008/page_243.pdf-3</td>
<td>openai/o4-mini-2025-04-16</td>
<td>what was the percent change?</td>
<td>7.368000e-02</td>
<td>7.37</td>
<td>GROUND_TRUTH_INCORRECT</td>
<td>The question asks for the "percent change". The model correctly ca...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>Single_AMT/2015/page_50.pdf-1</td>
<td>openai/o4-mini-2025-04-16</td>
<td>what was the low for share price for the quarter ended 12/31/15?</td>
<td>8.732000e+01</td>
<td>90.2</td>
<td>GROUND_TRUTH_INCORRECT</td>
<td>The question asks for the low share price for the quarter ended 12...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">282</td>
<td>Single_SLG/2017/page_114.pdf-3</td>
<td>openai/o3-2025-04-16</td>
<td>so what was the percentage of pension plan contributions out of th...</td>
<td>2.302800e-01</td>
<td>23.03</td>
<td>GROUND_TRUTH_INCORRECT</td>
<td>The question asks for a "percentage". The model correctly calculat...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">283</td>
<td>Single_JPM/2008/page_177.pdf-4</td>
<td>openai/o3-2025-04-16</td>
<td>what was the total amount of resale agreements in 2008, in millions?</td>
<td>2.080000e+04</td>
<td>200,265</td>
<td>GROUND_TRUTH_INCORRECT</td>
<td>The question asks for the 'total amount of resale agreements in 20...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">284</td>
<td>Double_IPG/2014/page_95.pdf</td>
<td>openai/o3-2025-04-16</td>
<td>and what is it for the the 2009 one?</td>
<td>1.218121e+07</td>
<td>435259</td>
<td>GROUND_TRUTH_INCORRECT</td>
<td>The question asks for the value for "the 2009 one". The previous t...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">286</td>
<td>Single_APTV/2018/page_36.pdf-2</td>
<td>openai/o3-2025-04-16</td>
<td>how much does the change in the value of the aptiv plc represent i...</td>
<td>3.080000e-01</td>
<td>30.8%</td>
<td>GROUND_TRUTH_INCORRECT</td>
<td>The question asks for the answer "in percentage". The model correc...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">288</td>
<td>Single_RCL/2016/page_7.pdf-3</td>
<td>openai/o3-2025-04-16</td>
<td>what percentage change does this represent?</td>
<td>1.600000e-01</td>
<td>16.0</td>
<td>GROUND_TRUTH_INCORRECT</td>
<td>The question asks for a 'percentage change'. The model correctly c...</td>
</tr>
</tbody>
</table>

<p>226 rows √ó 7 columns</p>
</div>
</div>
</div>
</div>
<p>Curriculum-first pass surfaced a gap between our metric and reality: several ‚Äúerrors‚Äù are actually correct answers hidden by formatting. Manual review shows many EM misses are due to surface form, not reasoning.</p>
<p><strong>What broke EM</strong></p>
<ul>
<li>Numeric formatting: thousands separators, ‚Äú0.5M‚Äù vs ‚Äú500000‚Äù.</li>
<li>Units and scaling: $, %, M/B suffixes; percent vs decimal.</li>
<li>Rounding/tolerance: 2dp rounding vs full precision.</li>
<li>Boolean variants: yes/true/1 vs no/false/0.</li>
</ul>
<p>The above results are <strong>not conclusive</strong> by any means, since the LLM-as-a-judge approach also has known flaws. However, it does give us some pointers on how to improve the model performance from here!</p>
<p><strong>Note</strong>: LLM-as-judge remains imperfect. We‚Äôll retain periodic human spot-checks. With cleaner metrics and logging, the next step is to test if DSPy‚Äôs optimizers actually lift EM under the Easy‚ÜíMedium‚ÜíHard schedule without inflating token cost.</p>
<div id="quarto-navigation-envelope" class="hidden">
<p><span class="hidden" data-render-id="quarto-int-sidebar-title">Shubham Gupta</span> <span class="hidden" data-render-id="quarto-int-navbar-title">Shubham Gupta</span> <span class="hidden" data-render-id="quarto-int-navbar:About">About</span> <span class="hidden" data-render-id="quarto-int-navbar:/about.html">/about.html</span> <span class="hidden" data-render-id="quarto-int-navbar:https://github.com/goodhamgupta">https://github.com/goodhamgupta</span> <span class="hidden" data-render-id="quarto-int-navbar:/index.xml">/index.xml</span></p>
</div>
<div id="quarto-meta-markdown" class="hidden">
<p><span class="hidden" data-render-id="quarto-metatitle">Shubham Gupta - Curriculum Learning ü§ù DSPy: Modelling</span> <span class="hidden" data-render-id="quarto-twittercardtitle">Shubham Gupta - Curriculum Learning ü§ù DSPy: Modelling</span> <span class="hidden" data-render-id="quarto-ogcardtitle">Shubham Gupta - Curriculum Learning ü§ù DSPy: Modelling</span> <span class="hidden" data-render-id="quarto-metasitename">Shubham Gupta</span> <span class="hidden" data-render-id="quarto-twittercarddesc">Mapping ConvFinQA and crafting a curriculum for financial QA</span> <span class="hidden" data-render-id="quarto-ogcardddesc">Mapping ConvFinQA and crafting a curriculum for financial QA</span></p>
</div>
</section>
</section>

</main> <!-- /main -->
<script id = "quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js"
        data-repo="goodhamgupta/personal_blog"
        data-repo-id="R_kgDOLXv-xA"
        data-category="General"
        data-category-id="DIC_kwDOLXv-xM4Cdogy"
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"selector":".lightbox","openEffect":"zoom","loop":false,"closeEffect":"zoom","descPosition":"bottom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>

</body>

</html>
</iframe></div></div></div></section> ]]></description>
  <category>programming</category>
  <category>dspy</category>
  <category>curriculum-learning</category>
  <guid>https://shubhamg.in/posts/2025-09-01-cl-dspy-modelling/2025-09-01-cl-dspy-modelling.html</guid>
  <pubDate>Sun, 31 Aug 2025 16:00:00 GMT</pubDate>
  <media:content url="https://shubhamg.in/posts/cl_dspy/curriculum_learning_data.png" medium="image" type="image/png" height="178" width="144"/>
</item>
<item>
  <title>Curriculum Learning ü§ù DSPy: Exploration</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2025-08-31-cl-dspy-eda.html</link>
  <description><![CDATA[ 





<p>In my current project, I‚Äôm exploring financial reasoning over conversational data. With all the buzz around DSPy, I decided it‚Äôs the perfect time to dive deep into this tool.</p>
<p>Financial reasoning over conversational data presents a unique challenge in NLP: models must not only understand natural language but also perform multi-step numerical computations while maintaining context across dialogue turns.</p>
<p><a href="https://github.com/czyssrs/ConvFinQA">ConvFinQA</a> is a dataset that combines conversational QA with financial documents and tables, requiring systems to execute chains of mathematical operations to arrive at correct answers.</p>
<p>What if we could improve model performance by teaching systems to learn from easier examples first, gradually building up to complex multi-turn reasoning? This is the core idea behind <a href="https://huggingface.co/learn/deep-rl-course/en/unitbonus3/curriculum-learning">curriculum learning</a>.</p>
<p>This post begins a series exploring curriculum learning with <a href="https://github.com/stanfordnlp/dspy">DSPy</a>. We start with an exploratory analysis of ConvFinQA to understand what makes some examples harder than others, identify complexity patterns in the data, and establish the base for a curriculum-based approach.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<div id="cell-3" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-6"></span>
<span id="cb1-7">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.load(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../data/convfinqa_dataset.json"</span>))</span>
<span id="cb1-8">data.keys()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>dict_keys(['train', 'dev'])</code></pre>
</div>
</div>
<p>The current dataset only contains the <code>train</code> and <code>dev</code> splits. For evaluation, we will likely use the <code>dev</code> split, and for training, we‚Äôll split the <code>train</code> split into a <code>train</code> and <code>val</code> split.</p>
<div id="cell-5" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">train_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>])</span>
<span id="cb3-2">test_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dev"</span>])</span></code></pre></div>
</details>
</div>
<div id="cell-6" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">train_df.info()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3037 entries, 0 to 3036
Data columns (total 4 columns):
 #   Column    Non-Null Count  Dtype 
---  ------    --------------  ----- 
 0   id        3037 non-null   object
 1   doc       3037 non-null   object
 2   dialogue  3037 non-null   object
 3   features  3037 non-null   object
dtypes: object(4)
memory usage: 95.0+ KB</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">test_df.info()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 421 entries, 0 to 420
Data columns (total 4 columns):
 #   Column    Non-Null Count  Dtype 
---  ------    --------------  ----- 
 0   id        421 non-null    object
 1   doc       421 non-null    object
 2   dialogue  421 non-null    object
 3   features  421 non-null    object
dtypes: object(4)
memory usage: 13.3+ KB</code></pre>
</div>
</div>
<p>We will <em>explode</em> the columns with nested features to make them easier to work with.</p>
<div id="cell-9" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">train_flat_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(</span>
<span id="cb8-2">    [</span>
<span id="cb8-3">        train_df.drop([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb8-4">        train_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(pd.Series).add_prefix(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_"</span>),</span>
<span id="cb8-5">        train_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(pd.Series).add_prefix(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue_"</span>),</span>
<span id="cb8-6">        train_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(pd.Series).add_prefix(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_"</span>),</span>
<span id="cb8-7">    ],</span>
<span id="cb8-8">    axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb8-9">)</span>
<span id="cb8-10"></span>
<span id="cb8-11">test_flat_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(</span>
<span id="cb8-12">    [</span>
<span id="cb8-13">        test_df.drop([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb8-14">        test_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(pd.Series).add_prefix(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_"</span>),</span>
<span id="cb8-15">        test_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(pd.Series).add_prefix(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue_"</span>),</span>
<span id="cb8-16">        test_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(pd.Series).add_prefix(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_"</span>),</span>
<span id="cb8-17">    ],</span>
<span id="cb8-18">    axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb8-19">)</span></code></pre></div>
</details>
</div>
<div id="cell-10" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">train_flat_df.info()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3037 entries, 0 to 3036
Data columns (total 13 columns):
 #   Column                           Non-Null Count  Dtype 
---  ------                           --------------  ----- 
 0   id                               3037 non-null   object
 1   doc_pre_text                     3037 non-null   object
 2   doc_post_text                    3037 non-null   object
 3   doc_table                        3037 non-null   object
 4   dialogue_conv_questions          3037 non-null   object
 5   dialogue_conv_answers            3037 non-null   object
 6   dialogue_turn_program            3037 non-null   object
 7   dialogue_executed_answers        3037 non-null   object
 8   dialogue_qa_split                3037 non-null   object
 9   features_num_dialogue_turns      3037 non-null   int64 
 10  features_has_type2_question      3037 non-null   bool  
 11  features_has_duplicate_columns   3037 non-null   bool  
 12  features_has_non_numeric_values  3037 non-null   bool  
dtypes: bool(3), int64(1), object(9)
memory usage: 246.3+ KB</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">test_flat_df.info()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 421 entries, 0 to 420
Data columns (total 13 columns):
 #   Column                           Non-Null Count  Dtype 
---  ------                           --------------  ----- 
 0   id                               421 non-null    object
 1   doc_pre_text                     421 non-null    object
 2   doc_post_text                    421 non-null    object
 3   doc_table                        421 non-null    object
 4   dialogue_conv_questions          421 non-null    object
 5   dialogue_conv_answers            421 non-null    object
 6   dialogue_turn_program            421 non-null    object
 7   dialogue_executed_answers        421 non-null    object
 8   dialogue_qa_split                421 non-null    object
 9   features_num_dialogue_turns      421 non-null    int64 
 10  features_has_type2_question      421 non-null    bool  
 11  features_has_duplicate_columns   421 non-null    bool  
 12  features_has_non_numeric_values  421 non-null    bool  
dtypes: bool(3), int64(1), object(9)
memory usage: 34.2+ KB</code></pre>
</div>
</div>
</section>
<section id="eda" class="level1">
<h1>EDA</h1>
<section id="missing-data" class="level3">
<h3 class="anchored" data-anchor-id="missing-data">Missing Data</h3>
<p>First, let‚Äôs check to see if there‚Äôs any missing data in any field.</p>
<div id="cell-15" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> missingno <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> msno</span>
<span id="cb13-2"></span>
<span id="cb13-3">msno.matrix(train_flat_df)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-9-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://shubhamg.in/posts/2025-08-31-cl-dspy-eda_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-16" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">msno.matrix(test_flat_df)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-10-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://shubhamg.in/posts/2025-08-31-cl-dspy-eda_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>No missing values in the training dataset.</p>
</section>
<section id="pre-and-post-text" class="level2">
<h2 class="anchored" data-anchor-id="pre-and-post-text">pre and post text</h2>
<p>According to the database schema:</p>
<ul>
<li>pre_text -&gt; Supporting text from the document occuring BEFORE the table content</li>
<li>post_text -&gt; Supporting text from the document occuring AFTER the table content</li>
</ul>
<div id="cell-20" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pprint <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pprint</span>
<span id="cb15-2"></span>
<span id="cb15-3">pprint(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text"</span>].head().iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>('26 | 2009 annual report in fiscal 2008 , revenues in the credit union '
 'systems and services business segment increased 14% ( 14 % ) from fiscal '
 '2007 . all revenue components within the segment experienced growth during '
 'fiscal 2008 . license revenue generated the largest dollar growth in revenue '
 'as episys ae , our flagship core processing system aimed at larger credit '
 'unions , experienced strong sales throughout the year . support and service '
 'revenue , which is the largest component of total revenues for the credit '
 'union segment , experienced 34 percent growth in eft support and 10 percent '
 'growth in in-house support . gross profit in this business segment increased '
 '$ 9344 in fiscal 2008 compared to fiscal 2007 , due primarily to the '
 'increase in license revenue , which carries the highest margins . liquidity '
 'and capital resources we have historically generated positive cash flow from '
 'operations and have generally used funds generated from operations and '
 'short-term borrowings on our revolving credit facility to meet capital '
 'requirements . we expect this trend to continue in the future . the company '
 '2019s cash and cash equivalents increased to $ 118251 at june 30 , 2009 from '
 '$ 65565 at june 30 , 2008 . the following table summarizes net cash from '
 'operating activities in the statement of cash flows : 2009 2008 2007 .')</code></pre>
</div>
</div>
<div id="cell-21" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>).describe()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>count    3037.000000
mean     1760.501811
std      1397.695620
min         1.000000
25%       568.000000
50%      1417.000000
75%      2765.000000
max      7153.000000
Name: doc_pre_text, dtype: float64</code></pre>
</div>
</div>
<div id="cell-22" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>).describe()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>count     421.000000
mean     1538.061758
std      1337.167597
min        17.000000
25%       410.000000
50%      1072.000000
75%      2347.000000
max      5639.000000
Name: doc_pre_text, dtype: float64</code></pre>
</div>
</div>
<p>Looks like the pre_text in the data has some si</p>
<div id="cell-24" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb21-2">sns.histplot(</span>
<span id="cb21-3">    train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(x))),</span>
<span id="cb21-4">    bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,</span>
<span id="cb21-5">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>,</span>
<span id="cb21-6">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb21-7">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb21-8">)</span>
<span id="cb21-9">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Length of doc_pre_text"</span>)</span>
<span id="cb21-10">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)</span>
<span id="cb21-11">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train_flat_df: doc_pre_text length"</span>)</span>
<span id="cb21-12"></span>
<span id="cb21-13">sns.histplot(</span>
<span id="cb21-14">    test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(x))),</span>
<span id="cb21-15">    bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,</span>
<span id="cb21-16">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span>,</span>
<span id="cb21-17">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb21-18">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb21-19">)</span>
<span id="cb21-20">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Length of doc_pre_text"</span>)</span>
<span id="cb21-21">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)</span>
<span id="cb21-22">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_flat_df: doc_pre_text length"</span>)</span>
<span id="cb21-23">plt.tight_layout()</span>
<span id="cb21-24">plt.show()</span>
<span id="cb21-25"></span>
<span id="cb21-26">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb21-27">sns.histplot(</span>
<span id="cb21-28">    train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(x))),</span>
<span id="cb21-29">    bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,</span>
<span id="cb21-30">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"green"</span>,</span>
<span id="cb21-31">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb21-32">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb21-33">)</span>
<span id="cb21-34">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Length of doc_post_text"</span>)</span>
<span id="cb21-35">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)</span>
<span id="cb21-36">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train_flat_df: doc_post_text length"</span>)</span>
<span id="cb21-37"></span>
<span id="cb21-38">sns.histplot(</span>
<span id="cb21-39">    test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(x))),</span>
<span id="cb21-40">    bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,</span>
<span id="cb21-41">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb21-42">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb21-43">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb21-44">)</span>
<span id="cb21-45">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Length of doc_post_text"</span>)</span>
<span id="cb21-46">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)</span>
<span id="cb21-47">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_flat_df: doc_post_text length"</span>)</span>
<span id="cb21-48">plt.tight_layout()</span>
<span id="cb21-49">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="https://shubhamg.in/posts/2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="https://shubhamg.in/posts/2025-08-31-cl-dspy-eda_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Looks like the train and test data have a similar distribution for doc_pre_text and doc_post_text.</p>
<p>However, we do see some extreme outliers, with the large documents have &gt; 5000 characters.</p>
<p>Most new generation LLMs do have a ctx window large enough to handle both pre text + table + post text in the same context window, and we may not need any pre-processing for fields. However, we will revisit this later.</p>
</section>
<section id="doc_table" class="level2">
<h2 class="anchored" data-anchor-id="doc_table"><code>doc_table</code></h2>
<section id="table-dimensions" class="level3">
<h3 class="anchored" data-anchor-id="table-dimensions">Table Dimensions</h3>
<div id="cell-28" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> compute_dims(table):</span>
<span id="cb22-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb22-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Compute basic shape statistics for a table dict.</span></span>
<span id="cb22-4"></span>
<span id="cb22-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb22-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        table (dict): Mapping from row keys to dicts of column:value pairs.</span></span>
<span id="cb22-7"></span>
<span id="cb22-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb22-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        pd.Series: Series with n_rows, n_cols, total_cells.</span></span>
<span id="cb22-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - n_rows: Number of rows in the table (outer dict keys)</span></span>
<span id="cb22-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - n_cols: Number of unique columns across all rows</span></span>
<span id="cb22-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            - total_cells: Total number of (row, col) value pairs</span></span>
<span id="cb22-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb22-14">    n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(table)</span>
<span id="cb22-15">    cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {col <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> table.values() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> col <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> row}</span>
<span id="cb22-16">    n_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(cols)</span>
<span id="cb22-17">    total_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(row) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> table.values())</span>
<span id="cb22-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> pd.Series({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_rows"</span>: n_rows, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cols"</span>: n_cols, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>: total_cells})</span>
<span id="cb22-19"></span>
<span id="cb22-20"></span>
<span id="cb22-21"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> df <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> (train_flat_df, test_flat_df):</span>
<span id="cb22-22">    df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_rows"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cols"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_table"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(compute_dims)</span>
<span id="cb22-23"></span>
<span id="cb22-24"></span>
<span id="cb22-25">all_dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(</span>
<span id="cb22-26">    [</span>
<span id="cb22-27">        train_flat_df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_rows"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cols"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>]].assign(split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>),</span>
<span id="cb22-28">        test_flat_df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_rows"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cols"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>]].assign(split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>),</span>
<span id="cb22-29">    ],</span>
<span id="cb22-30">    ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb22-31">)</span>
<span id="cb22-32"></span>
<span id="cb22-33">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb22-34"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ax, col <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(axes, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_rows"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cols"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>]):</span>
<span id="cb22-35">    sns.histplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>all_dims, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>col, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>, multiple<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stack"</span>, bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)</span>
<span id="cb22-36">    ax.set_title(col)</span>
<span id="cb22-37">plt.tight_layout()</span>
<span id="cb22-38">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-15-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="https://shubhamg.in/posts/2025-08-31-cl-dspy-eda_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Some key points:</p>
<ul>
<li>Most tables don‚Äôt have more than 6 rows. This is good, since it limits the amount of error that can be introduced by the model when answering a question.</li>
<li>Column distribution is a bit more extreme, especially in the training dataset.
<ul>
<li>While the training dataset has a maximum of 17 columns, most of the <code>test</code> dataset tops out at ~8-9 columns.</li>
<li>This is a good feature we could use to determine which records to use for the evaluation. More on this soon!</li>
</ul></li>
<li>Same as the number of columns, we see that the training dataset has a much wider distribution of number of cells. In the test set, the majority of records have cells &lt; 30.</li>
</ul>
<div id="cell-30" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb23-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Tables with more than </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>threshold<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> columns per split:"</span>)</span>
<span id="cb23-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> split, df <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>, train_flat_df), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>, test_flat_df)]:</span>
<span id="cb23-4">    subset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cols"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> threshold]</span>
<span id="cb23-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>split<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(subset)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb23-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> subset.empty:</span>
<span id="cb23-7">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(subset[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_rows"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cols"</span>]].head(), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Tables with more than 10 columns per split:
  train: 100
                                id  n_rows  n_cols
16     Double_PNC/2014/page_99.pdf       2      14
37    Single_GS/2013/page_47.pdf-2       3      12
90   Single_CDW/2015/page_34.pdf-2       5      12
133   Single_CE/2014/page_90.pdf-1       1      11
137   Single_C/2009/page_195.pdf-2       3      14 

  test: 8
                                id  n_rows  n_cols
50   Single_JPM/2007/page_33.pdf-2       3      11
51   Single_GS/2017/page_143.pdf-2       2      13
109  Single_JPM/2007/page_33.pdf-1       3      11
117  Single_GS/2017/page_143.pdf-1       2      13
298  Single_MA/2008/page_126.pdf-1       1      14 
</code></pre>
</div>
</div>
<div id="cell-31" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> count_nested_tables(table):</span>
<span id="cb25-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb25-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Recursively count nested tables in a table dict.</span></span>
<span id="cb25-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A nested table is any dict or list of dicts within cell values (deeper than the row level).</span></span>
<span id="cb25-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb25-6"></span>
<span id="cb25-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> _count(t, depth):</span>
<span id="cb25-8">        cnt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb25-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(t, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb25-10">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> v <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> t.values():</span>
<span id="cb25-11">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(v, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb25-12">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> depth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb25-13">                        cnt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb25-14">                    cnt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> _count(v, depth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-15">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">elif</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(v, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>):</span>
<span id="cb25-16">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> v:</span>
<span id="cb25-17">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(item, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb25-18">                            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> depth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb25-19">                                cnt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb25-20">                            cnt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> _count(item, depth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> cnt</span>
<span id="cb25-22"></span>
<span id="cb25-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> _count(table, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb25-24"></span>
<span id="cb25-25"></span>
<span id="cb25-26"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> df <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> (train_flat_df, test_flat_df):</span>
<span id="cb25-27">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nested_tables"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_table"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(count_nested_tables)</span>
<span id="cb25-28"></span>
<span id="cb25-29"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nested tables per split:"</span>)</span>
<span id="cb25-30"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> split, df <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>, train_flat_df), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>, test_flat_df)]:</span>
<span id="cb25-31">    nt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nested_tables"</span>]</span>
<span id="cb25-32">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb25-33">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>split<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: docs w/ nested tables = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>(nt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> / </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(nt)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, max nested = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>nt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb25-34">    )</span>
<span id="cb25-35"></span>
<span id="cb25-36">nested_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(</span>
<span id="cb25-37">    [</span>
<span id="cb25-38">        train_flat_df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nested_tables"</span>]].assign(split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>),</span>
<span id="cb25-39">        test_flat_df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nested_tables"</span>]].assign(split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>),</span>
<span id="cb25-40">    ],</span>
<span id="cb25-41">    ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb25-42">)</span>
<span id="cb25-43"></span>
<span id="cb25-44">nested_df.info()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Nested tables per split:
  train: docs w/ nested tables = 0 / 3037, max nested = 0
  test: docs w/ nested tables = 0 / 421, max nested = 0
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3458 entries, 0 to 3457
Data columns (total 2 columns):
 #   Column         Non-Null Count  Dtype 
---  ------         --------------  ----- 
 0   nested_tables  3458 non-null   int64 
 1   split          3458 non-null   object
dtypes: int64(1), object(1)
memory usage: 54.2+ KB</code></pre>
</div>
</div>
<div id="cell-32" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">nested_df[nested_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nested_tables"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">nested_tables</th>
<th data-quarto-table-cell-role="th">split</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Looks like the table are not deeply nested! This is good since we don‚Äôt have to worry too much about table formatting, when sending the table as context to the LLM.</p>
</section>
<section id="column-header-analysis" class="level3">
<h3 class="anchored" data-anchor-id="column-header-analysis">Column Header Analysis</h3>
<div id="cell-35" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb28-2"></span>
<span id="cb28-3"></span>
<span id="cb28-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> analyze_split(df, split_name):</span>
<span id="cb28-5">    n_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df)</span>
<span id="cb28-6">    dup_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_duplicate_columns"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb28-7">    years_per_doc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_table"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>)</span>
<span id="cb28-8">    year_stats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> years_per_doc.describe().to_dict()</span>
<span id="cb28-9"></span>
<span id="cb28-10">    freq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter()</span>
<span id="cb28-11">    doc_freq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter()</span>
<span id="cb28-12">    all_headers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb28-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tbl <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_table"</span>]:</span>
<span id="cb28-14">        hdrs_in_doc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb28-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> year_dict <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> tbl.values():</span>
<span id="cb28-16">            freq.update(year_dict.keys())</span>
<span id="cb28-17">            hdrs_in_doc.update(year_dict.keys())</span>
<span id="cb28-18">        doc_freq.update(hdrs_in_doc)</span>
<span id="cb28-19">        all_headers.update(hdrs_in_doc)</span>
<span id="cb28-20"></span>
<span id="cb28-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">--- </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>split_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>upper()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> SPLIT ---"</span>)</span>
<span id="cb28-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Total docs: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n_docs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Docs w/ duplicate cols: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dup_count<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dup_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> n_docs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1%}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb28-24">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Years/doc stats: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>year_stats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Unique headers across all docs: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(all_headers)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-26">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Top 10 headers by total occurrences:"</span>, freq.most_common(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="cb28-27">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Top 10 headers by docs appeared in:"</span>, doc_freq.most_common(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="cb28-28"></span>
<span id="cb28-29"></span>
<span id="cb28-30"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> name, df <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>, train_flat_df), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>, test_flat_df)]:</span>
<span id="cb28-31">    analyze_split(df, name)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
--- TRAIN SPLIT ---
Total docs: 3037
Docs w/ duplicate cols: 60 (2.0%)
Years/doc stats: {'count': 3037.0, 'mean': 2.839973658215344, 'std': 1.5134690841267935, 'min': 1.0, '25%': 2.0, '50%': 3.0, '75%': 3.0, 'max': 10.0}
Unique headers across all docs: 3948
Top 10 headers by total occurrences: [('total', 1147), ('s&amp;p 500 index', 456), ('s&amp;p 500', 419), ('other', 371), ('operating profit', 253), ('net sales', 229), ('2009', 210), ('2012', 206), ('2010', 206), ('2011', 201)]
Top 10 headers by docs appeared in: [('total', 383), ('other', 205), ('thereafter', 109), ('2012', 107), ('2011', 103), ('2013', 102), ('2010', 99), ('2009', 98), ('2014', 91), ('2018', 87)]

--- TEST SPLIT ---
Total docs: 421
Docs w/ duplicate cols: 17 (4.0%)
Years/doc stats: {'count': 421.0, 'mean': 3.0332541567695963, 'std': 1.6500609236986385, 'min': 1.0, '25%': 2.0, '50%': 3.0, '75%': 4.0, 'max': 8.0}
Unique headers across all docs: 833
Top 10 headers by total occurrences: [('total', 183), ('s&amp;p 500 index', 120), ('cadence design systems inc .', 72), ('nasdaq composite', 72), ('other', 60), ('s&amp;p 500', 42), ('2011', 40), ('operating income', 39), ('2012', 38), ('s&amp;p retail index', 36)]
Top 10 headers by docs appeared in: [('total', 54), ('other', 36), ('s&amp;p 500 index', 20), ('2014', 18), ('2015', 18), ('2012', 17), ('2010', 16), ('2011', 16), ('2007', 16), ('2017', 14)]</code></pre>
</div>
</div>
</section>
<section id="row-header-analysis" class="level3">
<h3 class="anchored" data-anchor-id="row-header-analysis">Row Header Analysis</h3>
<div id="cell-37" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb30-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb30-3"></span>
<span id="cb30-4"></span>
<span id="cb30-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> normalize_row_key(k: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb30-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Lower-case, drop punctuation, collapse spaces."""</span></span>
<span id="cb30-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> k:</span>
<span id="cb30-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb30-9">    k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k.lower()</span>
<span id="cb30-10">    k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"[_\-]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>, k)</span>
<span id="cb30-11">    k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"[()%:$,]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>, k)</span>
<span id="cb30-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> re.sub(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"\s+"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>, k).strip()</span>
<span id="cb30-13"></span>
<span id="cb30-14"></span>
<span id="cb30-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> analyze_row_headers(df, split_name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, top_n: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb30-16">    raw_freq, norm_freq, summary_freq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(), Counter(), Counter()</span>
<span id="cb30-17">    summary_kw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb30-18">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total"</span>,</span>
<span id="cb30-19">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"net"</span>,</span>
<span id="cb30-20">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>,</span>
<span id="cb30-21">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span>,</span>
<span id="cb30-22">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"change"</span>,</span>
<span id="cb30-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"difference"</span>,</span>
<span id="cb30-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"subtotal"</span>,</span>
<span id="cb30-25">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"summary"</span>,</span>
<span id="cb30-26">    )</span>
<span id="cb30-27"></span>
<span id="cb30-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tbl <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_table"</span>]:</span>
<span id="cb30-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(tbl, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb30-30">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">continue</span></span>
<span id="cb30-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> year_dict <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> tbl.values():</span>
<span id="cb30-32">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(year_dict, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb30-33">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">continue</span></span>
<span id="cb30-34">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> raw <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> year_dict.keys():</span>
<span id="cb30-35">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> raw <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb30-36">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">continue</span></span>
<span id="cb30-37">                raw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(raw).strip()</span>
<span id="cb30-38">                norm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> normalize_row_key(raw)</span>
<span id="cb30-39"></span>
<span id="cb30-40">                raw_freq[raw] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb30-41">                norm_freq[norm] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb30-42">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> raw.lower() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> summary_kw):</span>
<span id="cb30-43">                    summary_freq[raw] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb30-44"></span>
<span id="cb30-45">    total_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(raw_freq.values())</span>
<span id="cb30-46">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">===== </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>split_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>upper()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> SPLIT : ROW HEADER ANALYSIS ====="</span>)</span>
<span id="cb30-47">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Row instances              : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>total_rows<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb30-48">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Unique raw headers         : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(raw_freq)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:,}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb30-49">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Unique normalized headers  : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(norm_freq)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:,}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb30-50"></span>
<span id="cb30-51">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Raw header  ‚ûú  Normalized header (top 10 by freq)"</span>)</span>
<span id="cb30-52">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> hdr, _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> raw_freq.most_common(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb30-53">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>hdr[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:55}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ‚ûú </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>normalize_row_key(hdr)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb30-54"></span>
<span id="cb30-55">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Top-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>top_n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> most frequent financial metrics (normalized)"</span>)</span>
<span id="cb30-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> hdr, cnt <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> norm_freq.most_common(top_n):</span>
<span id="cb30-57">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>hdr[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:55}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>cnt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:&gt;6}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb30-58"></span>
<span id="cb30-59">    tot_summary <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(summary_freq.values())</span>
<span id="cb30-60">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Subtotal/Summary rows detected (keywords </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>summary_kw<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb30-61">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Instances: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tot_summary<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">  (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tot_summary <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_rows<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1%}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> of all rows)"</span>)</span>
<span id="cb30-62">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> hdr, cnt <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> summary_freq.most_common(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb30-63">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>hdr[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">55</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:55}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>cnt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:&gt;6}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb30-64"></span>
<span id="cb30-65"></span>
<span id="cb30-66"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> name, df <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> ((<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>, train_flat_df), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>, test_flat_df)):</span>
<span id="cb30-67">    analyze_row_headers(df, name)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
===== TRAIN SPLIT : ROW HEADER ANALYSIS =====
Row instances              : 42813
Unique raw headers         : 3,948
Unique normalized headers  : 3,921

Raw header  ‚ûú  Normalized header (top 10 by freq)
total                                                   ‚ûú total
s&amp;p 500 index                                           ‚ûú s&amp;p 500 index
s&amp;p 500                                                 ‚ûú s&amp;p 500
other                                                   ‚ûú other
operating profit                                        ‚ûú operating profit
net sales                                               ‚ûú net sales
2009                                                    ‚ûú 2009
2012                                                    ‚ûú 2012
2010                                                    ‚ûú 2010
2011                                                    ‚ûú 2011

Top-10 most frequent financial metrics (normalized)
total                                                     1147
s&amp;p 500 index                                              456
s&amp;p 500                                                    419
other                                                      371
operating profit                                           253
net sales                                                  229
2009                                                       210
2010                                                       208
2012                                                       206
2011                                                       201

Subtotal/Summary rows detected (keywords ('total', 'net', '%', 'percent', 'change', 'difference', 'subtotal', 'summary'))
Instances: 7535  (17.6% of all rows)
total                                                     1147
net sales                                                  229
net income                                                 118
net cash provided by operating activities                  117
total net revenues                                          78
total operating expenses                                    75
total contractual obligations                               67
total debt                                                  61
net earnings ( loss )                                       58
total minimum lease payments                                57

===== TEST SPLIT : ROW HEADER ANALYSIS =====
Row instances              : 6159
Unique raw headers         : 833
Unique normalized headers  : 832

Raw header  ‚ûú  Normalized header (top 10 by freq)
total                                                   ‚ûú total
s&amp;p 500 index                                           ‚ûú s&amp;p 500 index
cadence design systems inc .                            ‚ûú cadence design systems inc .
nasdaq composite                                        ‚ûú nasdaq composite
other                                                   ‚ûú other
s&amp;p 500                                                 ‚ûú s&amp;p 500
2011                                                    ‚ûú 2011
operating income                                        ‚ûú operating income
2012                                                    ‚ûú 2012
s&amp;p retail index                                        ‚ûú s&amp;p retail index

Top-10 most frequent financial metrics (normalized)
total                                                      183
s&amp;p 500 index                                              120
cadence design systems inc .                                72
nasdaq composite                                            72
other                                                       60
s&amp;p 500                                                     42
2011                                                        40
operating income                                            39
2012                                                        38
s&amp;p retail index                                            36

Subtotal/Summary rows detected (keywords ('total', 'net', '%', 'percent', 'change', 'difference', 'subtotal', 'summary'))
Instances: 1218  (19.8% of all rows)
total                                                      183
net cash provided by operating activities                   28
1.375% ( 1.375 % ) notes due 2015                           24
6.25% ( 6.25 % ) notes due 2017                             24
5.00% ( 5.00 % ) notes due 2019                             24
4.25% ( 4.25 % ) notes due 2021                             24
3.375% ( 3.375 % ) notes due 2022                           24
total long-term borrowings                                  24
total contractual obligations                               24
net income                                                  21</code></pre>
</div>
</div>
<p>We see some similar patterns in the row headers across the splits, but nothing of significance.</p>
<div id="cell-39" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb32-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb32-3"></span>
<span id="cb32-4"></span>
<span id="cb32-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> _yield_cells(x):</span>
<span id="cb32-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(x, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb32-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> v <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x.values():</span>
<span id="cb32-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">from</span> _yield_cells(v)</span>
<span id="cb32-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">elif</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(x, (<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>)):</span>
<span id="cb32-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> v <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x:</span>
<span id="cb32-11">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">from</span> _yield_cells(v)</span>
<span id="cb32-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb32-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> x</span>
<span id="cb32-14"></span>
<span id="cb32-15"></span>
<span id="cb32-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> _parse_num(tok):</span>
<span id="cb32-17">    s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(tok).strip()</span>
<span id="cb32-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">or</span> s.lower() <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"na"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n/a"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nan"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>):</span>
<span id="cb32-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb32-20">    neg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (s.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"("</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> s.endswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")"</span>)) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">or</span> s.endswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>)</span>
<span id="cb32-21">    s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s.strip(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"()"</span>).rstrip(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>)</span>
<span id="cb32-22">    s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"[,\$%]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, s)</span>
<span id="cb32-23">    mult <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb32-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> s.lower().endswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"m"</span>):</span>
<span id="cb32-25">        mult, s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span>, s[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb32-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">elif</span> s.lower().endswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>):</span>
<span id="cb32-27">        mult, s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, s[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb32-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb32-29">        val <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(s) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> mult</span>
<span id="cb32-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>val <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> neg <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> val</span>
<span id="cb32-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">except</span>:</span>
<span id="cb32-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb32-33"></span>
<span id="cb32-34"></span>
<span id="cb32-35"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> analyze_cell_values(df, split_name, top_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb32-36">    total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> missing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> unp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb32-37">    unpatt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter()</span>
<span id="cb32-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tbl <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_table"</span>]:</span>
<span id="cb32-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(tbl, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb32-40">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">continue</span></span>
<span id="cb32-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> cell <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> _yield_cells(tbl):</span>
<span id="cb32-42">            total <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb32-43">            txt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(cell).strip()</span>
<span id="cb32-44">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> cell <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">or</span> txt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>:</span>
<span id="cb32-45">                missing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb32-46">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">elif</span> _parse_num(cell) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb32-47">                unp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb32-48">                key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> txt.lower()[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>]</span>
<span id="cb32-49">                unpatt[key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb32-50">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb32-51">                num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb32-52"></span>
<span id="cb32-53">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">=== </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>split_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>upper()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> CELL QUALITY ==="</span>)</span>
<span id="cb32-54">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"total: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>total<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, numeric: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>num<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, missing: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>missing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, unparseable: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>unp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-55">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Top </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>top_n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> unparseable patterns:"</span>)</span>
<span id="cb32-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> pat, cnt <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> unpatt.most_common(top_n):</span>
<span id="cb32-57">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>pat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:25}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>cnt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb32-58"></span>
<span id="cb32-59"></span>
<span id="cb32-60"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> name, d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> ((<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>, train_flat_df), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>, test_flat_df)):</span>
<span id="cb32-61">    analyze_cell_values(d, name)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== TRAIN CELL QUALITY ===
total: 42813, numeric: 41499, missing: 184, unparseable: 1130
Top 10 unparseable patterns:
  -                         265
  n/a                       147
  ( in thousands )          102
  nm                        62
  owned                     43
  $ -                       42
  pay                       22
  fta                       20
  cash                      16
  leased                    14

=== TEST CELL QUALITY ===
total: 6159, numeric: 6045, missing: 12, unparseable: 102
Top 10 unparseable patterns:
  -                         13
  none                      9
  high                      6
  low                       6
  ( b )                     6
  leased                    6
  united states             4
  united kingdom            4
  ( d )                     3
  nm                        3</code></pre>
</div>
</div>
<p>We see that:</p>
<ul>
<li><strong>Train</strong> (42,813 total cells): 97.0% numeric, 0.4% missing, 2.6% unparseable<br>
</li>
<li><strong>Test</strong> (6,159 total cells): 98.2% numeric, 0.2% missing, 1.7% unparseable</li>
</ul>
<p>Top unparseable patterns include <code>-</code>, <code>n/a</code>, <code>( in thousands )</code>, <code>nm</code>, <code>none</code>, <code>high</code>, <code>low</code>, etc., indicating placeholders, qualifiers, and unit headers that need cleaning or custom parsing.</p>
<p>When selecting records for evaluation, we should:</p>
<ul>
<li>Exclude or preprocess records with unparseable cells (~1,232 cells total).<br>
</li>
<li>Drop tables where &gt;5% of cells are unparseable to ensure numeric consistency.</li>
</ul>
<p>This keeps our evaluation set focused on clean, numeric data and avoids noise from poorly parsed entries. More on this later!</p>
<div id="cell-41" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">train_flat_df.columns</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
</section>
<section id="dialogue_conv_questions" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_conv_questions"><code>dialogue_conv_questions</code></h2>
<div id="cell-43" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">train_q_lens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue_conv_questions"</span>].explode().dropna().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>)</span>
<span id="cb36-2">test_q_lens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue_conv_questions"</span>].explode().dropna().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>)</span>
<span id="cb36-3">df_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(</span>
<span id="cb36-4">    [</span>
<span id="cb36-5">        pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"length"</span>: train_q_lens, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>}),</span>
<span id="cb36-6">        pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"length"</span>: test_q_lens, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>}),</span>
<span id="cb36-7">    ]</span>
<span id="cb36-8">)</span>
<span id="cb36-9"></span>
<span id="cb36-10">sns.set_theme(style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"whitegrid"</span>)</span>
<span id="cb36-11">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb36-12">sns.histplot(</span>
<span id="cb36-13">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df_q, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"length"</span>, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>, stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>, element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"step"</span>, fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb36-14">)</span>
<span id="cb36-15">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distribution of Dialogue Question Lengths by Split"</span>)</span>
<span id="cb36-16">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Question Length (characters)"</span>)</span>
<span id="cb36-17">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>)</span>
<span id="cb36-18">plt.tight_layout()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-23-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="https://shubhamg.in/posts/2025-08-31-cl-dspy-eda_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Majority of the questions in both the train and test set are short. This is ideal.</p>
</section>
<section id="dialogue_conv_answers" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_conv_answers"><code>dialogue_conv_answers</code></h2>
<div id="cell-46" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">train_q_lens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue_conv_answers"</span>].explode().dropna().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>)</span>
<span id="cb37-2">test_q_lens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue_conv_answers"</span>].explode().dropna().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>)</span>
<span id="cb37-3">df_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(</span>
<span id="cb37-4">    [</span>
<span id="cb37-5">        pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"length"</span>: train_q_lens, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>}),</span>
<span id="cb37-6">        pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"length"</span>: test_q_lens, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>}),</span>
<span id="cb37-7">    ]</span>
<span id="cb37-8">)</span>
<span id="cb37-9"></span>
<span id="cb37-10">sns.set_theme(style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"whitegrid"</span>)</span>
<span id="cb37-11">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb37-12">sns.histplot(</span>
<span id="cb37-13">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df_q, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"length"</span>, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>, stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>, element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"step"</span>, fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb37-14">)</span>
<span id="cb37-15">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distribution of Dialogue Answer Lengths by Split"</span>)</span>
<span id="cb37-16">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Answer Length (characters)"</span>)</span>
<span id="cb37-17">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>)</span>
<span id="cb37-18">plt.tight_layout()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-24-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="https://shubhamg.in/posts/2025-08-31-cl-dspy-eda_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>As mentioned in the dataset, most of the answers are either numeric or boolean in nature. We see a majority of the answers having length &lt;= 8, meaning that these are either large numbers, or numbers with large precision.</p>
</section>
<section id="dialogue_turn_program" class="level2">
<h2 class="anchored" data-anchor-id="dialogue_turn_program"><code>dialogue_turn_program</code></h2>
<p>This field represents the program DSL generated for the current turn.</p>
<div id="cell-50" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue_turn_program"</span>].head()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>0    [206588, 181001, subtract(206588, 181001), sub...
1    [9362.2, 9244.9, subtract(9362.2, 9244.9), sub...
2    [5363, 7983, subtract(5363, 7983), subtract(53...
3    [subtract(75.95, const_100), subtract(75.95, c...
4    [subtract(91.06, const_100), subtract(91.06, c...
Name: dialogue_turn_program, dtype: object</code></pre>
</div>
</div>
<div id="cell-51" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> _get_op_counts(df: pd.DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pd.Series:</span>
<span id="cb40-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Return a Series with the number of '(' in every element of dialogue_turn_program."""</span></span>
<span id="cb40-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (</span>
<span id="cb40-4">        df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue_turn_program"</span>]</span>
<span id="cb40-5">        .explode()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># one element per row</span></span>
<span id="cb40-6">        .dropna()</span>
<span id="cb40-7">        .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> rec: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(rec).count(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"("</span>))</span>
<span id="cb40-8">    )</span>
<span id="cb40-9"></span>
<span id="cb40-10"></span>
<span id="cb40-11">counts_train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _get_op_counts(train_flat_df)</span>
<span id="cb40-12">counts_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _get_op_counts(test_flat_df)</span>
<span id="cb40-13"></span>
<span id="cb40-14">df_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(</span>
<span id="cb40-15">    [</span>
<span id="cb40-16">        pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ops"</span>: counts_train, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>}),</span>
<span id="cb40-17">        pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ops"</span>: counts_test, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>}),</span>
<span id="cb40-18">    ]</span>
<span id="cb40-19">)</span>
<span id="cb40-20"></span>
<span id="cb40-21">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb40-22">sns.histplot(</span>
<span id="cb40-23">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df_counts,</span>
<span id="cb40-24">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ops"</span>,</span>
<span id="cb40-25">    hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>,</span>
<span id="cb40-26">    bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, df_counts[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ops"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb40-27">    element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"step"</span>,</span>
<span id="cb40-28">    fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb40-29">)</span>
<span id="cb40-30">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of operations per element"</span>)</span>
<span id="cb40-31">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)</span>
<span id="cb40-32">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Histogram of operation counts in turn_programs (train vs. test)"</span>)</span>
<span id="cb40-33">plt.tight_layout()</span>
<span id="cb40-34">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-26-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="https://shubhamg.in/posts/2025-08-31-cl-dspy-eda_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distributions for number of operations in both the train and test set. Majority of the operations are &lt; 4 .</p>
<p>We could argue that the number of operations is a good proxy for the complexity of the program. As such, we should probably aim to do well first on the examples where the number of operations is small.</p>
<div id="cell-53" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1">train_flat_df.columns</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="features_num_dialogue_turns" class="level2">
<h2 class="anchored" data-anchor-id="features_num_dialogue_turns"><code>features_num_dialogue_turns</code></h2>
<div id="cell-55" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), sharey<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb43-2"></span>
<span id="cb43-3">order <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(</span>
<span id="cb43-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_num_dialogue_turns"</span>]).union(</span>
<span id="cb43-5">        test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_num_dialogue_turns"</span>]</span>
<span id="cb43-6">    )</span>
<span id="cb43-7">)</span>
<span id="cb43-8"></span>
<span id="cb43-9">sns.countplot(</span>
<span id="cb43-10">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_num_dialogue_turns"</span>,</span>
<span id="cb43-11">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>train_flat_df,</span>
<span id="cb43-12">    order<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>order,</span>
<span id="cb43-13">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb43-14">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>,</span>
<span id="cb43-15">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb43-16">)</span>
<span id="cb43-17">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(</span>
<span id="cb43-18">    title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Train: Num Dialogue Turns"</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count"</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Num Dialogue Turns"</span></span>
<span id="cb43-19">)</span>
<span id="cb43-20"></span>
<span id="cb43-21">sns.countplot(</span>
<span id="cb43-22">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_num_dialogue_turns"</span>,</span>
<span id="cb43-23">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>test_flat_df,</span>
<span id="cb43-24">    order<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>order,</span>
<span id="cb43-25">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb43-26">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span>,</span>
<span id="cb43-27">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb43-28">)</span>
<span id="cb43-29">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Test: Num Dialogue Turns"</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count"</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb43-30"></span>
<span id="cb43-31">plt.tight_layout()</span>
<span id="cb43-32">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-28-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="https://shubhamg.in/posts/2025-08-31-cl-dspy-eda_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distributions across the train and test sets. As mentioned in the paper, we should expect conversations with more dialogue turns, to be more difficult to answer for models.</p>
<p>This is yet another feature we could use when deciding how to split our data into train, validation, and test sets.</p>
<div id="cell-57" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">train_flat_df.columns</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>Index(['id', 'doc_pre_text', 'doc_post_text', 'doc_table',
       'dialogue_conv_questions', 'dialogue_conv_answers',
       'dialogue_turn_program', 'dialogue_executed_answers',
       'dialogue_qa_split', 'features_num_dialogue_turns',
       'features_has_type2_question', 'features_has_duplicate_columns',
       'features_has_non_numeric_values', 'n_rows', 'n_cols', 'total_cells',
       'nested_tables'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="features_has_type2_question" class="level2">
<h2 class="anchored" data-anchor-id="features_has_type2_question"><code>features_has_type2_question</code></h2>
<div id="cell-59" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb46-2"></span>
<span id="cb46-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> name, df <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Train"</span>, train_flat_df), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Test"</span>, test_flat_df)]:</span>
<span id="cb46-4">    vc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_type2_question"</span>].value_counts()</span>
<span id="cb46-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> set ‚Äì Has Type 2 Question counts:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>vc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb46-6"></span>
<span id="cb46-7">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), sharey<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb46-8"></span>
<span id="cb46-9">sns.countplot(</span>
<span id="cb46-10">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_type2_question"</span>,</span>
<span id="cb46-11">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>train_flat_df,</span>
<span id="cb46-12">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb46-13">    palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Blues"</span>,</span>
<span id="cb46-14">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb46-15">)</span>
<span id="cb46-16">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(</span>
<span id="cb46-17">    title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Train: Has Type 2 Question"</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count"</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Has Type 2 Question"</span></span>
<span id="cb46-18">)</span>
<span id="cb46-19"></span>
<span id="cb46-20">sns.countplot(</span>
<span id="cb46-21">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_type2_question"</span>,</span>
<span id="cb46-22">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>test_flat_df,</span>
<span id="cb46-23">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb46-24">    palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Oranges"</span>,</span>
<span id="cb46-25">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb46-26">)</span>
<span id="cb46-27">axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Test: Has Type 2 Question"</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count"</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb46-28"></span>
<span id="cb46-29">plt.tight_layout()</span>
<span id="cb46-30">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Train set ‚Äì Has Type 2 Question counts:
features_has_type2_question
False    2148
True      889
Name: count, dtype: int64

Test set ‚Äì Has Type 2 Question counts:
features_has_type2_question
False    300
True     121
Name: count, dtype: int64
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/zf/l4rjbhhj6xq9bfzs9cr7m5vr0000gn/T/ipykernel_98862/668524099.py:9: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.

  sns.countplot(
/var/folders/zf/l4rjbhhj6xq9bfzs9cr7m5vr0000gn/T/ipykernel_98862/668524099.py:20: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.

  sns.countplot(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="2025-08-31-cl-dspy-eda_files/figure-html/cell-30-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="https://shubhamg.in/posts/2025-08-31-cl-dspy-eda_files/figure-html/cell-30-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Similar distrbutions for Type2 questions across the train and test sets, as expected.</p>
</section>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<p><a id="methodology"></a></p>
<p>Given the above dataset analysis, a few things are clear:</p>
<ul>
<li>Given the recent explosion of ctx window size for language models, we should be able to build strong baselines model without any finetuning.</li>
<li>The length analysis of the different fields(pre/post text, table, questions, etc.) confirms that we will likely not need any form of retrieval to answer the questions, <strong>contradictory</strong> to the original paper.</li>
<li>There are varying levels of difficulty in the given set of questions and answer.
<ul>
<li>We ideally should leverage this to build our models in stages, such that we can track and measure accuracy and perform error analysis at each stage.</li>
</ul></li>
</ul>
<p>The current generation of language models have 3 main phases of training:</p>
<ul>
<li><strong>pre-training</strong>: large-scale self-supervised next-token prediction on massive web corpora (e.g., C4, Common Crawl) to learn general language patterns.<br>
</li>
<li><strong>mid-training</strong>: intermediate training on medium-sized, higher-quality or domain-specific data (10‚Äì300 B tokens) with curriculum learning, long-context adaptation, and synthetic/instructional examples to sharpen capabilities.<br>
</li>
<li><strong>post-training</strong>: fine-tuning or instruction-tuning on smaller, curated datasets (100 M‚Äì1 B tokens) and often RLHF to align the model to downstream tasks and human preferences.</li>
</ul>
<p>As seen with our dataset, even current language models are <strong>trained in stages</strong>, with problems that are seemingly difficult for models to understand explicitly trained in either the mid or post-training phase.</p>
<p>This methodology has roots in an reinforcement learning technique called <strong>Curriculum Learning</strong>.</p>
<section id="curriculum-learning" class="level3">
<h3 class="anchored" data-anchor-id="curriculum-learning">Curriculum Learning</h3>
<p><strong>Core Idea</strong>: Curriculum learning for LLMs involves carefully selecting and ordering training data based on difficulty, starting with simpler examples and gradually introducing more complex ones.</p>
<p><strong>Why it‚Äôs beneficial:</strong></p>
<ul>
<li>Improved Efficiency:
<ul>
<li>By starting with easier examples, LLMs can learn fundamental concepts more effectively and then build upon that knowledge.</li>
</ul></li>
<li>Better Generalization:
<ul>
<li>A well-designed curriculum can help LLMs generalize better to unseen data by exposing them to a wider range of complexities and nuances.</li>
</ul></li>
<li>Reduced Training Time:
<ul>
<li>In some cases, curriculum learning can lead to faster convergence and reduced training time.</li>
</ul></li>
</ul>
<p align="center">
<img src="https://shubhamg.in/posts/cl_dspy/curriculum_learning_data.png" width="400" height="500"> <br> <sub> Source: <a href="https://arxiv.org/pdf/2101.10382">Curriculum Learning: A Survey</a>, Soviany et al. </sub>
</p>
<p>For our dataset, given our analysis, we have the following levers to consider:</p>
<ul>
<li>Number of Turns buckets. Eg: 1‚Äì2, 3‚Äì4, 5‚Äì6, ‚â•7</li>
<li>Number of max ops bucket: Eg: 0‚Äì1, 2‚Äì3, 4+</li>
<li>Type1 vs Type2 questions</li>
<li>Context length bucket (pre_text/post_text len): ‚â§P50, P50‚ÄìP80, &gt;P80</li>
<li>Noise flags: duplicate columns / non-numeric values</li>
</ul>
<p>Given that we had limited time, we will pick the following</p>
<ul>
<li><strong>Easy</strong>
<ul>
<li>This is the Core stage</li>
<li>We hope the model will learn how to answer questions that directly pick answers from context, perform simple operations, and can carry previous answers minimally.</li>
<li>We will use the following filters(all must hold TRUE):
<ul>
<li>max_ops_per_conversation ‚â§ 2</li>
<li>2 ‚â§ num_dialogue_turns ‚â§ 4</li>
<li>has_type2_question == False</li>
<li>doc_pre_text_len ‚â§ P50_pre</li>
<li>doc_post_text_len ‚â§ P50_post</li>
<li>total_cells ‚â§ P50_cells</li>
</ul></li>
</ul></li>
<li><strong>Medium</strong>
<ul>
<li>This stage focuses on improving the reasoning ability of the model, and it‚Äôs ability to track dependencies.</li>
<li>The hope is that this stage will help the model learn multi-op arithmetic, cross question dependencies, and variable reuse.
<ul>
<li>Filters (must satisfy both lines)
<ul>
<li>( (max_ops_per_conversation ‚àà {2,3}) OR (has_type2_question == True) )</li>
<li>3 ‚â§ num_dialogue_turns ‚â§ 6</li>
<li>doc_pre_text_len ‚â§ P90_pre</li>
<li>doc_post_text_len ‚â§ P90_post</li>
<li>total_cells ‚â§ P90_cells</li>
</ul></li>
<li>This admits many max_ops=2 dialogs but with more turns and/or Type2.</li>
</ul></li>
</ul></li>
<li><strong>Hard</strong>
<ul>
<li>This stage will aim to tackle the long-tail of difficult problems, and help introduce much needed robustness in our models.</li>
<li>Specifically, we hope that at the end of this stage, the model is good at long context answer, which requires retrieval and reasoning, extreme op depth, and poorly formatted/large tables.</li>
<li>Filters (any single trigger is enough)
<ul>
<li>Deep ops: max_ops_per_conversation ‚â• 4 OR</li>
<li>Long dialogs: features_num_dialogue_turns ‚â• 7</li>
<li>Long context: doc_pre_text_len &gt; P90_pre OR doc_post_text_len &gt; P90_post</li>
<li>Large tables: total_cells &gt; P90_cells</li>
<li>Noisy schema: has_non_numeric_values OR has_duplicate_columns with some complexity ‚Üí ~10‚Äì15%</li>
</ul></li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>To prevent overlap and duplicates, we will construct the stages in reverse order i.e - Hard first to ensure we isolate the difficult problems - Easy next to identify baseline performance - Remaining problems go into medium to help develop better reasoning and arithmetic abilities.</p>
</blockquote>
<div id="cell-65" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_max_ops_per_conversation(df):</span>
<span id="cb49-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> max_ops(turn_programs):</span>
<span id="cb49-3">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># turn_programs is a list of lists (or strings), one per turn</span></span>
<span id="cb49-4">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Each turn_program is a string or list of strings, e.g. ['subtract(206588, 181001)', ...]</span></span>
<span id="cb49-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We'll count the number of operations per turn, then take the max</span></span>
<span id="cb49-6">        <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb49-7"></span>
<span id="cb49-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(turn_programs, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>):</span>
<span id="cb49-9">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb49-10">        op_pattern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"([a-zA-Z_][a-zA-Z0-9_]*\()"</span>)</span>
<span id="cb49-11">        max_ops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb49-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> turn <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> turn_programs:</span>
<span id="cb49-13">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(turn, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb49-14">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># count ops in the string</span></span>
<span id="cb49-15">                ops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(op_pattern.findall(turn))</span>
<span id="cb49-16">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">elif</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(turn, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>):</span>
<span id="cb49-17">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># count ops in all strings in the list</span></span>
<span id="cb49-18">                ops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(op_pattern.findall(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(x))) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> turn)</span>
<span id="cb49-19">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb49-20">                ops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb49-21">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> max_ops:</span>
<span id="cb49-22">                max_ops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ops</span>
<span id="cb49-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> max_ops</span>
<span id="cb49-24"></span>
<span id="cb49-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dialogue_turn_program"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(max_ops)</span>
<span id="cb49-26"></span>
<span id="cb49-27"></span>
<span id="cb49-28">train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_ops_per_conversation"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_max_ops_per_conversation(train_flat_df)</span>
<span id="cb49-29">test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_ops_per_conversation"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_max_ops_per_conversation(test_flat_df)</span></code></pre></div>
</details>
</div>
<div id="cell-66" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(</span>
<span id="cb50-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x.split())</span>
<span id="cb50-3">)</span>
<span id="cb50-4">train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(</span>
<span id="cb50-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x.split())</span>
<span id="cb50-6">)</span>
<span id="cb50-7"></span>
<span id="cb50-8">test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(</span>
<span id="cb50-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x.split())</span>
<span id="cb50-10">)</span>
<span id="cb50-11">test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(</span>
<span id="cb50-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x.split())</span>
<span id="cb50-13">)</span></code></pre></div>
</details>
</div>
<div id="cell-67" class="cell" data-execution_count="41">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1">train_flat_df[</span>
<span id="cb51-2">    [</span>
<span id="cb51-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_ops_per_conversation"</span>,</span>
<span id="cb51-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_type2_question"</span>,</span>
<span id="cb51-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_duplicate_columns"</span>,</span>
<span id="cb51-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_num_dialogue_turns"</span>,</span>
<span id="cb51-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_non_numeric_values"</span>,</span>
<span id="cb51-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>,</span>
<span id="cb51-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>,</span>
<span id="cb51-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_rows"</span>,</span>
<span id="cb51-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cols"</span>,</span>
<span id="cb51-12">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>,</span>
<span id="cb51-13">    ]</span>
<span id="cb51-14">].astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>).describe()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_ops_per_conversation</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
<th data-quarto-table-cell-role="th">doc_pre_text_len</th>
<th data-quarto-table-cell-role="th">doc_post_text_len</th>
<th data-quarto-table-cell-role="th">n_rows</th>
<th data-quarto-table-cell-role="th">n_cols</th>
<th data-quarto-table-cell-role="th">total_cells</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
<td>3037.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2.035232</td>
<td>0.292723</td>
<td>0.019756</td>
<td>3.656240</td>
<td>0.122160</td>
<td>300.901218</td>
<td>320.378005</td>
<td>2.839974</td>
<td>5.232137</td>
<td>14.097135</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>0.655179</td>
<td>0.455087</td>
<td>0.139185</td>
<td>1.319899</td>
<td>0.327524</td>
<td>239.324988</td>
<td>256.003210</td>
<td>1.513469</td>
<td>2.506996</td>
<td>10.260609</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>3.000000</td>
<td>0.000000</td>
<td>100.000000</td>
<td>102.000000</td>
<td>2.000000</td>
<td>3.000000</td>
<td>7.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>4.000000</td>
<td>0.000000</td>
<td>244.000000</td>
<td>285.000000</td>
<td>3.000000</td>
<td>5.000000</td>
<td>12.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>2.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>5.000000</td>
<td>0.000000</td>
<td>470.000000</td>
<td>498.000000</td>
<td>3.000000</td>
<td>7.000000</td>
<td>18.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>5.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>9.000000</td>
<td>1.000000</td>
<td>1132.000000</td>
<td>1489.000000</td>
<td>10.000000</td>
<td>19.000000</td>
<td>114.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-68" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1">test_flat_df[</span>
<span id="cb52-2">    [</span>
<span id="cb52-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_ops_per_conversation"</span>,</span>
<span id="cb52-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_type2_question"</span>,</span>
<span id="cb52-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_duplicate_columns"</span>,</span>
<span id="cb52-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_num_dialogue_turns"</span>,</span>
<span id="cb52-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_non_numeric_values"</span>,</span>
<span id="cb52-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>,</span>
<span id="cb52-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>,</span>
<span id="cb52-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_rows"</span>,</span>
<span id="cb52-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_cols"</span>,</span>
<span id="cb52-12">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>,</span>
<span id="cb52-13">    ]</span>
<span id="cb52-14">].astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>).describe()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="42">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">max_ops_per_conversation</th>
<th data-quarto-table-cell-role="th">features_has_type2_question</th>
<th data-quarto-table-cell-role="th">features_has_duplicate_columns</th>
<th data-quarto-table-cell-role="th">features_num_dialogue_turns</th>
<th data-quarto-table-cell-role="th">features_has_non_numeric_values</th>
<th data-quarto-table-cell-role="th">doc_pre_text_len</th>
<th data-quarto-table-cell-role="th">doc_post_text_len</th>
<th data-quarto-table-cell-role="th">n_rows</th>
<th data-quarto-table-cell-role="th">n_cols</th>
<th data-quarto-table-cell-role="th">total_cells</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
<td>421.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2.061758</td>
<td>0.287411</td>
<td>0.040380</td>
<td>3.539192</td>
<td>0.076010</td>
<td>263.475059</td>
<td>322.712589</td>
<td>3.033254</td>
<td>5.173397</td>
<td>14.629454</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>0.658993</td>
<td>0.453093</td>
<td>0.197083</td>
<td>1.252239</td>
<td>0.265329</td>
<td>226.086872</td>
<td>252.372826</td>
<td>1.650061</td>
<td>2.206237</td>
<td>8.670173</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.000000</td>
<td>0.000000</td>
<td>3.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>2.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.000000</td>
<td>0.000000</td>
<td>74.000000</td>
<td>119.000000</td>
<td>2.000000</td>
<td>3.000000</td>
<td>8.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>4.000000</td>
<td>0.000000</td>
<td>187.000000</td>
<td>292.000000</td>
<td>3.000000</td>
<td>5.000000</td>
<td>12.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>2.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>5.000000</td>
<td>0.000000</td>
<td>406.000000</td>
<td>520.000000</td>
<td>4.000000</td>
<td>6.000000</td>
<td>18.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>5.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>8.000000</td>
<td>1.000000</td>
<td>933.000000</td>
<td>1099.000000</td>
<td>8.000000</td>
<td>14.000000</td>
<td>48.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="curriculum-design-quota-rebalancing" class="level2">
<h2 class="anchored" data-anchor-id="curriculum-design-quota-rebalancing">Curriculum Design &amp; Quota Rebalancing</h2>
<p>While our complexity classification captures overall difficulty, curriculum learning requires more nuanced sampling strategies. Simply taking the hardest examples might create an imbalanced curriculum that overrepresents certain types of complexity while ignoring others.</p>
<p>Consider two scenarios: 1. <strong>Naive sampling</strong>: We randomly sample from our ‚ÄúHard‚Äù bucket and end up with 80% long-context examples but only 5% multi-operation examples 2. <strong>Quota sampling</strong>: We ensure balanced representation across complexity dimensions</p>
<p>The second approach creates a more robust curriculum. Our hard examples should include: - <strong>Deep reasoning</strong> (4+ mathematical operations) - <strong>Long conversations</strong> (7+ dialogue turns) - <strong>Dense context</strong> (lengthy pre/post text) - <strong>Complex tables</strong> (many cells, nested structures) - <strong>Noisy data</strong> (duplicate columns, non-numeric values)</p>
<p>This ensures our model learns to handle diverse types of complexity rather than overfitting to a single difficulty dimension. The following code implements quota-based sampling to achieve this balanced representation:</p>
<div id="cell-70" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pprint <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pprint</span>
<span id="cb53-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb53-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb53-4"></span>
<span id="cb53-5">TARGETS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb53-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Easy"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"valid"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>},</span>
<span id="cb53-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Medium"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"valid"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>},</span>
<span id="cb53-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hard"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">220</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"valid"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>},</span>
<span id="cb53-9">}</span>
<span id="cb53-10">OUTDIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"splits"</span>)</span>
<span id="cb53-11">RANDOM_STATE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span></span>
<span id="cb53-12"></span>
<span id="cb53-13">P50_pre <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>))</span>
<span id="cb53-14">P65_pre <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.65</span>))</span>
<span id="cb53-15">P80_pre <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.80</span>))</span>
<span id="cb53-16">P90_pre <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.90</span>))</span>
<span id="cb53-17"></span>
<span id="cb53-18">P50_post <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>))</span>
<span id="cb53-19">P65_post <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.65</span>))</span>
<span id="cb53-20">P80_post <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.80</span>))</span>
<span id="cb53-21">P90_post <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.90</span>))</span>
<span id="cb53-22"></span>
<span id="cb53-23">P50_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>))</span>
<span id="cb53-24">P65_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.65</span>))</span>
<span id="cb53-25">P80_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.80</span>))</span>
<span id="cb53-26">P90_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(train_flat_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.90</span>))</span>
<span id="cb53-27"></span>
<span id="cb53-28"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb53-29">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[Percentiles/train] pre P50=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P50_pre<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, P65=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P65_pre<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, P80=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P80_pre<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, P90=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P90_pre<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> "</span></span>
<span id="cb53-30">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"| post P50=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P50_post<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, P65=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P65_post<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, P80=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P80_post<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, P90=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P90_post<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> "</span></span>
<span id="cb53-31">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"| cells P50=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P50_cells<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, P65=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P65_cells<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, P80=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P80_cells<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, P90=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>P90_cells<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb53-32">)</span>
<span id="cb53-33"></span>
<span id="cb53-34"></span>
<span id="cb53-35"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> assign_stages(df: pd.DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pd.Series:</span>
<span id="cb53-36">    mops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_ops_per_conversation"</span>]</span>
<span id="cb53-37">    turns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_num_dialogue_turns"</span>]</span>
<span id="cb53-38">    t2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_type2_question"</span>]</span>
<span id="cb53-39">    preL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>]</span>
<span id="cb53-40">    postL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>]</span>
<span id="cb53-41">    cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>]</span>
<span id="cb53-42">    dup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_duplicate_columns"</span>]</span>
<span id="cb53-43">    nonnum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_non_numeric_values"</span>]</span>
<span id="cb53-44"></span>
<span id="cb53-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># HARD (tail)</span></span>
<span id="cb53-46">    hard <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb53-47">        (mops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb53-48">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (turns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb53-49">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (preL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P90_pre)</span>
<span id="cb53-50">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (postL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P90_post)</span>
<span id="cb53-51">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P90_cells)</span>
<span id="cb53-52">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (dup)</span>
<span id="cb53-53">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (</span>
<span id="cb53-54">            nonnum</span>
<span id="cb53-55">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (</span>
<span id="cb53-56">                (mops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb53-57">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (preL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P80_pre)</span>
<span id="cb53-58">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (postL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P80_post)</span>
<span id="cb53-59">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P80_cells)</span>
<span id="cb53-60">            )</span>
<span id="cb53-61">        )</span>
<span id="cb53-62">    )</span>
<span id="cb53-63"></span>
<span id="cb53-64">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># EASY (P65)</span></span>
<span id="cb53-65">    easy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>hard) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (</span>
<span id="cb53-66">        (mops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb53-67">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (turns.between(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, inclusive<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"both"</span>))</span>
<span id="cb53-68">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>t2)</span>
<span id="cb53-69">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (preL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> P65_pre)</span>
<span id="cb53-70">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (postL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> P65_post)</span>
<span id="cb53-71">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> P65_cells)</span>
<span id="cb53-72">    )</span>
<span id="cb53-73"></span>
<span id="cb53-74">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MEDIUM (middle band)</span></span>
<span id="cb53-75">    medium <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb53-76">        (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>hard)</span>
<span id="cb53-77">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>easy)</span>
<span id="cb53-78">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (</span>
<span id="cb53-79">            ((mops.isin([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (t2))</span>
<span id="cb53-80">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (turns.between(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, inclusive<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"both"</span>))</span>
<span id="cb53-81">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (preL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> P90_pre)</span>
<span id="cb53-82">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (postL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> P90_post)</span>
<span id="cb53-83">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> P90_cells)</span>
<span id="cb53-84">        )</span>
<span id="cb53-85">    )</span>
<span id="cb53-86"></span>
<span id="cb53-87">    stage <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Series(index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.index, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span>)</span>
<span id="cb53-88">    stage.loc[hard] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hard"</span></span>
<span id="cb53-89">    stage.loc[easy] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Easy"</span></span>
<span id="cb53-90">    stage.loc[medium] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Medium"</span></span>
<span id="cb53-91">    stage <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stage.fillna(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Medium"</span>)</span>
<span id="cb53-92">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> stage</span>
<span id="cb53-93"></span>
<span id="cb53-94"></span>
<span id="cb53-95">cur_train_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_flat_df.copy()</span>
<span id="cb53-96">cur_test_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_flat_df.copy()</span>
<span id="cb53-97">cur_train_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stage"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> assign_stages(cur_train_df)</span>
<span id="cb53-98">cur_test_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stage"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> assign_stages(cur_test_df)</span>
<span id="cb53-99"></span>
<span id="cb53-100"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[Stage counts] TRAIN:"</span>, cur_train_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stage"</span>].value_counts().to_dict())</span>
<span id="cb53-101"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[Stage counts] TEST:  "</span>, cur_test_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stage"</span>].value_counts().to_dict())</span>
<span id="cb53-102"></span>
<span id="cb53-103"></span>
<span id="cb53-104"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> sample_df(df: pd.DataFrame, n: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, seed: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pd.DataFrame:</span>
<span id="cb53-105">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">or</span> df.empty:</span>
<span id="cb53-106">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> df.iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb53-107">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> n:</span>
<span id="cb53-108">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> df.sample(frac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shuffle full pool if small</span></span>
<span id="cb53-109">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> df.sample(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed)</span>
<span id="cb53-110"></span>
<span id="cb53-111"></span>
<span id="cb53-112"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># =========================</span></span>
<span id="cb53-113"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># HARD QUOTA REBALANCING</span></span>
<span id="cb53-114"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># =========================</span></span>
<span id="cb53-115"></span>
<span id="cb53-116">HARD_PROPS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb53-117">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deep_ops"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.23</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># max_ops &gt;= 4</span></span>
<span id="cb53-118">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long_turns"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.23</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># turns &gt;= 7</span></span>
<span id="cb53-119">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long_ctx"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.27</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pre &gt; P90_pre OR post &gt; P90_post</span></span>
<span id="cb53-120">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"big_table"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.20</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># total_cells &gt; P90_cells</span></span>
<span id="cb53-121">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"noisy"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.07</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># duplicate OR non-numeric (with complexity already in stage)</span></span>
<span id="cb53-122">}</span>
<span id="cb53-123"></span>
<span id="cb53-124"></span>
<span id="cb53-125"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> hard_bucket_masks(df: pd.DataFrame):</span>
<span id="cb53-126">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {</span>
<span id="cb53-127">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deep_ops"</span>: (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_ops_per_conversation"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb53-128">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long_turns"</span>: (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_num_dialogue_turns"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>),</span>
<span id="cb53-129">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long_ctx"</span>: (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P90_pre)</span>
<span id="cb53-130">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P90_post),</span>
<span id="cb53-131">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"big_table"</span>: (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P90_cells),</span>
<span id="cb53-132">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"noisy"</span>: (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_duplicate_columns"</span>])</span>
<span id="cb53-133">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_non_numeric_values"</span>]),</span>
<span id="cb53-134">    }</span>
<span id="cb53-135"></span>
<span id="cb53-136"></span>
<span id="cb53-137"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> quota_sample_df(</span>
<span id="cb53-138">    pool: pd.DataFrame, total_n: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, masks: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, props: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, seed: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span>
<span id="cb53-139">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pd.DataFrame:</span>
<span id="cb53-140">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb53-141"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Quota-based sampling without replacement across overlapping buckets.</span></span>
<span id="cb53-142"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - masks: dict[name] -&gt; boolean Series over pool</span></span>
<span id="cb53-143"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - props: dict[name] -&gt; proportion (0..1)</span></span>
<span id="cb53-144"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Strategy:</span></span>
<span id="cb53-145"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      1) compute desired counts per bucket by props * total_n</span></span>
<span id="cb53-146"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      2) iterate buckets in fixed priority, sample from items not yet taken</span></span>
<span id="cb53-147"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      3) cap each bucket by its availability</span></span>
<span id="cb53-148"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      4) top up remaining slots uniformly at random from leftover pool</span></span>
<span id="cb53-149"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb53-150">    rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(seed)</span>
<span id="cb53-151">    pool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pool.copy()</span>
<span id="cb53-152">    taken_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb53-153">    out_parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb53-154"></span>
<span id="cb53-155">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># emphasize "deep_ops" and "long_turns"/"long_ctx" first</span></span>
<span id="cb53-156">    order <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deep_ops"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long_turns"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long_ctx"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"big_table"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"noisy"</span>]</span>
<span id="cb53-157">    desired <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {k: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(total_n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> props.get(k, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>))) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> order}</span>
<span id="cb53-158">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># adjust rounding to not exceed total_n</span></span>
<span id="cb53-159">    diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> total_n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(desired.values())</span>
<span id="cb53-160">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb53-161">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># distribute remainder by descending props</span></span>
<span id="cb53-162">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(order, key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: props.get(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), reverse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)):</span>
<span id="cb53-163">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb53-164">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb53-165">            desired[k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb53-166">            diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb53-167"></span>
<span id="cb53-168">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> order:</span>
<span id="cb53-169">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> desired[k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb53-170">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">continue</span></span>
<span id="cb53-171">        bucket_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pool.index[masks[k]]</span>
<span id="cb53-172">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove already taken</span></span>
<span id="cb53-173">        bucket_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> bucket_idx <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> taken_idx]</span>
<span id="cb53-174">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> bucket_idx:</span>
<span id="cb53-175">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">continue</span></span>
<span id="cb53-176">        take_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(desired[k], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(bucket_idx))</span>
<span id="cb53-177">        choose <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(rng.choice(bucket_idx, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>take_k, replace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>))</span>
<span id="cb53-178">        out_parts.append(pool.loc[choose])</span>
<span id="cb53-179">        taken_idx.update(choose)</span>
<span id="cb53-180"></span>
<span id="cb53-181">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># top-up if needed</span></span>
<span id="cb53-182">    taken_cnt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(p) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> out_parts)</span>
<span id="cb53-183">    need <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, total_n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> taken_cnt)</span>
<span id="cb53-184">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> need <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb53-185">        leftover_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> pool.index <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> taken_idx]</span>
<span id="cb53-186">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> leftover_idx:</span>
<span id="cb53-187">            k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(need, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(leftover_idx))</span>
<span id="cb53-188">            choose <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(rng.choice(leftover_idx, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>k, replace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>))</span>
<span id="cb53-189">            out_parts.append(pool.loc[choose])</span>
<span id="cb53-190"></span>
<span id="cb53-191">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> out_parts:</span>
<span id="cb53-192">        out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(out_parts, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb53-193">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb53-194">        out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pool.iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb53-195"></span>
<span id="cb53-196">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> out.sample(frac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed)</span>
<span id="cb53-197"></span>
<span id="cb53-198"></span>
<span id="cb53-199"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Build splits with quota rebalance only for Hard ---</span></span>
<span id="cb53-200">splits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb53-201">OUTDIR.mkdir(parents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb53-202"></span>
<span id="cb53-203"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, stage <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Easy"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Medium"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hard"</span>]):</span>
<span id="cb53-204">    tconf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TARGETS[stage]</span>
<span id="cb53-205">    train_pool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cur_train_df[cur_train_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stage"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> stage]</span>
<span id="cb53-206">    test_pool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cur_test_df[cur_test_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stage"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> stage]</span>
<span id="cb53-207"></span>
<span id="cb53-208">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> stage <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hard"</span>:</span>
<span id="cb53-209">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- original sampling for Easy/Medium ----</span></span>
<span id="cb53-210">        tv_target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tconf[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tconf[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"valid"</span>]</span>
<span id="cb53-211">        tv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sample_df(train_pool, tv_target, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RANDOM_STATE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb53-212">        vsize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(tconf[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"valid"</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(tv)))))</span>
<span id="cb53-213">        valid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tv.iloc[:vsize]</span>
<span id="cb53-214">        train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tv.iloc[vsize : vsize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tconf[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>]]</span>
<span id="cb53-215">        test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sample_df(test_pool, tconf[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>], seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RANDOM_STATE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb53-216">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb53-217">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- HARD: quota-based sampling ----</span></span>
<span id="cb53-218">        masks_train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hard_bucket_masks(train_pool)</span>
<span id="cb53-219">        masks_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hard_bucket_masks(test_pool)</span>
<span id="cb53-220"></span>
<span id="cb53-221">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TRAIN (quota)</span></span>
<span id="cb53-222">        hard_train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quota_sample_df(</span>
<span id="cb53-223">            pool<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>train_pool,</span>
<span id="cb53-224">            total_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tconf[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>],</span>
<span id="cb53-225">            masks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>masks_train,</span>
<span id="cb53-226">            props<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>HARD_PROPS,</span>
<span id="cb53-227">            seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RANDOM_STATE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>,</span>
<span id="cb53-228">        )</span>
<span id="cb53-229"></span>
<span id="cb53-230">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># VALID (quota) from remaining train_pool</span></span>
<span id="cb53-231">        remaining_train_pool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_pool.drop(hard_train.index)</span>
<span id="cb53-232">        hard_valid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quota_sample_df(</span>
<span id="cb53-233">            pool<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>remaining_train_pool,</span>
<span id="cb53-234">            total_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tconf[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"valid"</span>],</span>
<span id="cb53-235">            masks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>hard_bucket_masks(remaining_train_pool),</span>
<span id="cb53-236">            props<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>HARD_PROPS,</span>
<span id="cb53-237">            seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RANDOM_STATE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,</span>
<span id="cb53-238">        )</span>
<span id="cb53-239"></span>
<span id="cb53-240">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">TEST</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> (quota) from dev pool</span></span>
<span id="cb53-241">        hard_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quota_sample_df(</span>
<span id="cb53-242">            pool<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>test_pool,</span>
<span id="cb53-243">            total_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tconf[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>],</span>
<span id="cb53-244">            masks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>masks_test,</span>
<span id="cb53-245">            props<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>HARD_PROPS,</span>
<span id="cb53-246">            seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RANDOM_STATE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>,</span>
<span id="cb53-247">        )</span>
<span id="cb53-248"></span>
<span id="cb53-249">        train, valid, test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hard_train, hard_valid, hard_test</span>
<span id="cb53-250"></span>
<span id="cb53-251">    splits[stage] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>: train, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"valid"</span>: valid, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>: test}</span>
<span id="cb53-252"></span>
<span id="cb53-253">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> split_name, df_part <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> splits[stage].items():</span>
<span id="cb53-254">        outp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OUTDIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stage<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>lower()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>split_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.jsonl"</span></span>
<span id="cb53-255">        df_part[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>]].to_json(outp, orient<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"records"</span>, lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, force_ascii<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb53-256">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stage<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>split_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df_part)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:4d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">  -&gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>outp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb53-257"></span>
<span id="cb53-258"></span>
<span id="cb53-259"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> quick_report(df):</span>
<span id="cb53-260">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb53-261">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}</span>
<span id="cb53-262">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {</span>
<span id="cb53-263">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df),</span>
<span id="cb53-264">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ops_max_med"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_ops_per_conversation"</span>].median()),</span>
<span id="cb53-265">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"turns_med"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_num_dialogue_turns"</span>].median()),</span>
<span id="cb53-266">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type2_rate"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_type2_question"</span>].mean()),</span>
<span id="cb53-267">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pre_P50"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>].median()),</span>
<span id="cb53-268">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"post_P50"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>].median()),</span>
<span id="cb53-269">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cells_P50"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>].median()),</span>
<span id="cb53-270">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deep_ops_rate"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>((df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_ops_per_conversation"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>).mean()),</span>
<span id="cb53-271">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long_turns_rate"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>((df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_num_dialogue_turns"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>).mean()),</span>
<span id="cb53-272">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"long_ctx_rate"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(</span>
<span id="cb53-273">            (</span>
<span id="cb53-274">                (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_pre_text_len"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P90_pre)</span>
<span id="cb53-275">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_post_text_len"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P90_post)</span>
<span id="cb53-276">            ).mean()</span>
<span id="cb53-277">        ),</span>
<span id="cb53-278">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"big_table_rate"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>((df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"total_cells"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> P90_cells).mean()),</span>
<span id="cb53-279">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"noisy_rate"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(</span>
<span id="cb53-280">            (</span>
<span id="cb53-281">                df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_duplicate_columns"</span>]</span>
<span id="cb53-282">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"features_has_non_numeric_values"</span>]</span>
<span id="cb53-283">            ).mean()</span>
<span id="cb53-284">        ),</span>
<span id="cb53-285">    }</span>
<span id="cb53-286"></span>
<span id="cb53-287"></span>
<span id="cb53-288"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> stage <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Easy"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Medium"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hard"</span>]:</span>
<span id="cb53-289">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[Sanity] </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stage<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb53-290">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> part, dfp <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> splits[stage].items():</span>
<span id="cb53-291">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>part<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:&gt;5s}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> -&gt;"</span>, quick_report(dfp))</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Through this exploratory analysis of 3,458 ConvFinQA records, we‚Äôve established a foundation for curriculum learning in financial reasoning:</p>
<p><strong>Dataset Characteristics:</strong></p>
<ul>
<li>Zero missing data across all fields, with 97-98% of table cells containing clean numeric values</li>
<li>Text context averages ~1,760 characters (80% under 2,800), making it manageable for modern LLMs</li>
<li>Tables are reasonably sized (median 3√ó5 = 15 cells) with 93% of dialogues having ‚â§6 turns</li>
<li>29% contain Type II questions requiring complex table lookup and multi-step reasoning</li>
</ul>
<p><strong>Curriculum Design Framework:</strong></p>
<p>Our six-feature difficulty classification creates three balanced training stages:</p>
<ul>
<li><strong>Easy</strong>: 230 train examples (‚â§2 ops, 2-4 turns, simple context/tables)</li>
<li><strong>Medium</strong>: 300 train examples (2-3 ops or Type II, moderate complexity)</li>
<li><strong>Hard</strong>: 220 train examples (‚â•4 ops, long conversations, large/noisy data)</li>
</ul>
<p><strong>What‚Äôs Next:</strong></p>
<ul>
<li><strong>Modeling</strong>: Implement DSPy baselines across curriculum stages, comparing LLM performance on progressive difficulty</li>
<li><strong>Optimization</strong>: Apply DSPy‚Äôs <em>optimizers</em> with our curriculum strategy to hopefully achieve better results.</li>
</ul>
<p>Spotted a bug or have questions? Open an issue in the repo, or ping me on <a href="https://x.com/shubhamg2208">Twitter/X</a>. Happy hacking!</p>


</section>

 ]]></description>
  <category>programming</category>
  <category>dspy</category>
  <guid>https://shubhamg.in/posts/2025-08-31-cl-dspy-eda.html</guid>
  <pubDate>Sat, 30 Aug 2025 16:00:00 GMT</pubDate>
  <media:content url="https://shubhamg.in/posts/cl_dspy/curriculum_learning_data.png" medium="image" type="image/png" height="178" width="144"/>
</item>
<item>
  <title>Cracking the Anthropic CTF</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2025-08-05-anthropic-bsides-ctf.html</link>
  <description><![CDATA[ 





<p>In May last year, I spotted a tweet from an Anthropic engineer announcing the BSides CTF:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/anthropic_bsides_ctf/tweet.png" class="img-fluid figure-img"></p>
<figcaption>CTF Announcement</figcaption>
</figure>
</div>
<p>I‚Äôm no CTF expert/practitioner, but I tackled a few during undergrad, with a focus on forensic puzzles. This event mixed steganography with some neural-network trivia, so it sounded like the perfect weekend project.</p>
<p>The challenge is available via the Wayback Machine at <a href="https://web.archive.org/web/20240603200949/https://anthropic-at-bsides.com">Anthropic AI Bsides</a>. Do try it out before reading further!</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Feel free to skip ahead to the start of the challenge if you‚Äôre already familiar with CTFs.</p>
<section id="ctf" class="level2">
<h2 class="anchored" data-anchor-id="ctf">CTF?</h2>
<p>CTF stands for <strong>Capture The Flag</strong>, a style of cybersecurity competition where solving technical puzzles reveals a short secret string‚Äîthe <em>flag</em> - that you submit for points.<br>
Think of it as digital hide-and-seek: organizers hide vulnerabilities, encrypted messages, or cleverly obfuscated code; competitors hunt them down.</p>
</section>
<section id="ctf-styles" class="level2">
<h2 class="anchored" data-anchor-id="ctf-styles">CTF Styles</h2>
<p>Not every competition runs the same playbook. Most events fall into one of three flavours:</p>
<section id="jeopardy" class="level3">
<h3 class="anchored" data-anchor-id="jeopardy">Jeopardy</h3>
<p>A scoreboard with dozens of stand-alone puzzles. Solve any task in any order to reveal a <em>static</em> flag worth fixed points. This style is workshop / learning-friendly.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/anthropic_bsides_ctf/jeopardy.png" class="img-fluid figure-img"></p>
<figcaption>Jeopardy-style CTF. Source: <a href="https://dylandsouza.tech/cybersec-gamified/">Dylan Dsouza</a></figcaption>
</figure>
</div>
</section>
<section id="attack-defense" class="level3">
<h3 class="anchored" data-anchor-id="attack-defense">Attack-Defense</h3>
<p>Each team gets an identical (and intentionally vulnerable) service. Every ‚Äútick‚Äù you:</p>
<ul>
<li>Keep <em>your</em> instance alive for <em>defence points</em></li>
<li>Exploit everyone else to steal a fresh dynamic flag for <em>attack points</em></li>
</ul>
<p>Patch too aggressively and you might brick your own service. Patch too cautiously and you‚Äôll bleed flags. It‚Äôs a fast-paced, chaotic, team-centric format.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/anthropic_bsides_ctf/ad.png" class="img-fluid figure-img"></p>
<figcaption>Attack-Defense CTF. Source: <a href="https://tlualgosec.com/posts/forensics-in-ctf/">TAS Blog</a></figcaption>
</figure>
</div>
</section>
<section id="mixed-custom" class="level3">
<h3 class="anchored" data-anchor-id="mixed-custom">Mixed / Custom</h3>
<p>Organisers mash the two together or add story-driven twists (e.g., live red-team/blue-team, lock-picking, hardware). This is a YOLO mode CTF.</p>
<p>Most community events, including BSides, opt for classic Jeopardy because it scales well and newcomers can jump straight in. But if you ever see ‚ÄúA/D‚Äù or ‚ÄúKing-of-the-Hill‚Äù on the announcement banner, expect the wilder second style.</p>
</section>
</section>
<section id="flags" class="level2">
<h2 class="anchored" data-anchor-id="flags">Flags</h2>
<p>Flags are just short strings that prove you solved or exploited something. They come in many house styles‚Äî<code>CTF{leet_hax0r}</code>, <code>FLAG-6f7b5e‚Ä¶</code>, <code>BSides[you_found_it]</code>‚Äîbut the portal will show an example on each challenge page.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/anthropic_bsides_ctf/flag.png" class="img-fluid figure-img"></p>
<figcaption>Flags</figcaption>
</figure>
</div>
<p>In A/D games a new flag is generated every round, so automation matters.</p>
<hr>
<p>With that primer out of the way, let‚Äôs dive into the challenge!</p>
</section>
</section>
<section id="exploration" class="level1">
<h1>Initial Exploration</h1>
<p>As soon as we open the website, we‚Äôre greeted with a fairly simple page.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/anthropic_bsides_ctf/landing.png" class="img-fluid figure-img"></p>
<figcaption>Landing Page</figcaption>
</figure>
</div>
<p>After clicking around the page a bit, I looked through the source code and found this:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb1-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">div</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fixed w-full h-full bg-[url('stego.png')] opacity-50 -z-10"</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;&lt;/</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">div</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;!-- sometimes, the answers you seek are in plain sight --&gt;</span></span></code></pre></div>
<p>Once the above image <code>stego.png</code> is downloaded, it looks as follows:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/anthropic_bsides_ctf/stego.png" class="img-fluid figure-img"></p>
<figcaption>Source: <a href="https://web.archive.org/web/20240521073449/https://anthropic-at-bsides.com/stego.png">Web Archive</a></figcaption>
</figure>
</div>
<p>While it looks like the image doesn‚Äôt really have anything interesting, the name of the image gives us a hint: ‚Äústego‚Äù = ‚Äústeganography‚Äù</p>
<section id="steganography" class="level2">
<h2 class="anchored" data-anchor-id="steganography">Steganography?</h2>
<p>Steganography is the practice of hiding data in plain sight. Steganography is often embedded in images or audio<span class="citation" data-cites="ctf101_steganography">[1]</span>.</p>
<p>While there are many techniques <span class="citation" data-cites="wikipedia_steganography_techniques">[2]</span> used to hide data in images, the most common trick is Least-Significant-Bit (LSB) encoding: flip only the lowest bit of each pixel‚Äôs colour value. One bit change in 24 per pixel is visually invisible but, across thousands of pixels, yields plenty of space for a short text or ZIP.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/anthropic_bsides_ctf/lsb.png" class="img-fluid figure-img"></p>
<figcaption>LSB Encoding for an alphabet</figcaption>
</figure>
</div>
<p><strong>zsteg</strong> is the CTF scalpel for pictures. It brute-forces every sane combo of bit-plane √ó channel √ó endianness √ó encoding (ASCII/UTF-8/hex/deflate/zip) and flags what smells like data.</p>
<p>Running zsteg on the image gives the following:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-overflow-wrap code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> run <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-it</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--rm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-v</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PWD</span>:/data:Z sjourdan/zsteg:latest stego.png</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># b1,a,lsb,xy         .. text: "According to all known laws of aviation, there is no way a bee should be able to fly.\nIts wings are too small to get its fat little body off the ground.\nThe bee, of course, flies anyway because bees don't care what humans think is impossible.\nYellow, black"</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># b3,rgba,msb,xy      .. file: MPEG ADTS, AAC, v4 LTP, 8 kHz, surround + side</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># b4,rgb,msb,xy       .. file: MPEG ADTS, layer I, v2, 112 kbps, Monaural</span></span></code></pre></div>
<p>The <code>zsteg</code> output format follows: <code>bit-plane, channels, lsb|msb, scan-order ‚Üí payload</code></p>
<ul>
<li><code>b1,a,lsb,xy</code> ‚Äì bit-plane 1 (the very least-significant bit) of <strong>only the alpha channel</strong>, read left-to-right/top-to-bottom (<code>xy</code>). Those bits spell the ‚ÄúBee Movie‚Äù<span class="citation" data-cites="imdb_bee_movie_barry">[3]</span> opening monologue.</li>
<li><code>b3,rgba,msb,xy</code> ‚Äì 3rd bit of every RGBA channel (MSB). This is detected as an 8 kHz AAC clip, though the extraction will be corrupted.<br>
</li>
<li><code>b4,rgb,msb,xy</code> ‚Äì 4th bit of RGB (MSB). Detected as a 112 kbps MP1 file, also corrupted.</li>
</ul>
<p><code>zsteg</code> is pinpointing exactly which bits to extract, and from which colour plane to recover each hidden payload. We can extract the files using:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">zsteg</span> stego.png <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-E</span> b1,a,lsb,xy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> transcript.txt</span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">zsteg</span> stego.png <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-E</span> b3,rgba,msb,xy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> bee_movie.aac</span>
<span id="cb3-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">zsteg</span> stego.png <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-E</span> b4,rgb,msb,xy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> bee_movie.mp1</span></code></pre></div>
</section>
<section id="file-analysis" class="level2">
<h2 class="anchored" data-anchor-id="file-analysis">File Analysis</h2>
<p>I spent <em>way too</em> much time digging through the audio files, and processing them with everyone‚Äôs favorite audio processing tool: <strong>FFmpeg</strong></p>
<p>However, I couldn‚Äôt obtain any results from the audio files. The files are intentionally corrupted red herrings. Based on my analysis:</p>
<ul>
<li><code>bee_movie.aac</code> is effectively 0 bytes of valid audio data.</li>
<li><code>bee_movie.mp1</code> has a malformed header and contains repeated occurrences of the byte pattern ‚Äúff f7 7f‚Äù, which doesn‚Äôt constitute valid audio data.</li>
</ul>
<p>These ‚Äúaudio‚Äù payloads were likely added by the challenge author to mislead participants‚Äîzsteg detects them as potential audio files, but extracting higher-order bit planes rarely yields meaningful data.</p>
<details closed="">
<summary>
<strong>Commands</strong>
</summary>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"></span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ffmpeg</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-i</span> bee_movie.mp1 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-f</span> null</span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [in#0 @ 0x600001830d00] Error opening input: Invalid data found when processing input</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Error opening input file bee_movie.mp1.</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Error opening input files: Invalid data found when processing input</span></span></code></pre></div>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hexdump</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-C</span> bee_movie.mp1</span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 00000000  ff f7 7f ff f7 7f ff f7  7f ff f7 7f ff f7 7f ff  |................|</span></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 00000010  f7 7f ff f7 7f ff f7 7f  ff f7 7f ff f7 7f ff f7  |................|</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 00000020  7f ff f7 7f ff f7 7f ff  f7 7f ff f7 7f ff f7 7f  |................|</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...</span></span></code></pre></div>
</details>
<p>Disappointed with the above experiments, I finally started looking at the text file for some hints, and found the following text:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode txt code-overflow-wrap code-with-copy"><code class="sourceCode default"><span id="cb6-1">BREAKING OUT OF THE SCRIPT</span>
<span id="cb6-2">the thing you are looking for is at the regular website the challenge is on slash </span>
<span id="cb6-3">8471c9e7c8e8e5722c2c41d68575b5f3 dot zip</span>
<span id="cb6-4">END BREAKING OUT OF THE SCRIPT</span></code></pre></div>
<p>Hah! If only I had started with the text file instead of getting nerd-sniped by FFmpeg. Oh well, we move on.</p>
</section>
</section>
<section id="zip-file-exploration" class="level1">
<h1>Zip File Exploration</h1>
<p>The zipfile contains a <code>model.pkl</code>, <code>model.py</code> file and some instructions for the next task:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode txt code-overflow-wrap code-with-copy"><code class="sourceCode default"><span id="cb7-1">The next and final part of this puzzle relies on some understanding of simple</span>
<span id="cb7-2">multilayer perceptron behaviors. The other file in this ZIP archive is a Python</span>
<span id="cb7-3">Pickle file that contains a PyTorch model:</span>
<span id="cb7-4"></span>
<span id="cb7-5">1. The model has been trained to just repeat any lowercase ASCII you give it</span>
<span id="cb7-6">2. Except it has also been trained to output a special "flag" given the right</span>
<span id="cb7-7">   password</span>
<span id="cb7-8"></span>
<span id="cb7-9">The input to the model is one-hot encoded and shaped (B, N, V) where:</span>
<span id="cb7-10"></span>
<span id="cb7-11">- B is the batch size</span>
<span id="cb7-12">- N is the length of the sequence (which is stored in `seq_length`)</span>
<span id="cb7-13">- V is the vocabulary size (this dimension contains the one-hot encoding)</span>
<span id="cb7-14"></span>
<span id="cb7-15">Your goal is to reverse engineer, crack, or otherwise manipulate the model to</span>
<span id="cb7-16">extract the password.</span></code></pre></div>
<p>The <code>model.py</code> file has the following content:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>model.py</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="model.py" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb8-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> nn</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> string</span>
<span id="cb8-5"></span>
<span id="cb8-6"></span>
<span id="cb8-7">vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> string.ascii_lowercase</span>
<span id="cb8-8"></span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> ASCIIModel(nn.Module):</span>
<span id="cb8-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, vocab_size: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, hidden_dim: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, seq_length: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb8-12">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>(ASCIIModel, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>).<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb8-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.vocab_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vocab_size</span>
<span id="cb8-14">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.seq_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> seq_length</span>
<span id="cb8-15">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.final <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(seq_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> vocab_size, vocab_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> seq_length)</span>
<span id="cb8-16"></span>
<span id="cb8-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x: torch.Tensor) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> torch.Tensor:</span>
<span id="cb8-18">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.seq_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.vocab_size)</span>
<span id="cb8-19"></span>
<span id="cb8-20">        logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.final.forward(x)</span>
<span id="cb8-21"></span>
<span id="cb8-22">        logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.seq_length, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.vocab_size)</span>
<span id="cb8-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> logits</span></code></pre></div>
</div>
<p>First, let‚Äôs analyze the pickle file to find out more about the model parameters:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>loader.py</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="loader.py" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb9-2"></span>
<span id="cb9-3">model_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model.pkl"</span>, map_location<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cpu"</span>)</span>
<span id="cb9-4"></span>
<span id="cb9-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(model_data.__dict__)</span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># {</span></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_backward_hooks': OrderedDict(),</span></span>
<span id="cb9-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_backward_pre_hooks': OrderedDict(),</span></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_buffers': OrderedDict(),</span></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_forward_hooks': OrderedDict(),</span></span>
<span id="cb9-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_forward_hooks_always_called': OrderedDict(),</span></span>
<span id="cb9-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_forward_hooks_with_kwargs': OrderedDict(),</span></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_forward_pre_hooks': OrderedDict(),</span></span>
<span id="cb9-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_forward_pre_hooks_with_kwargs': OrderedDict(),</span></span>
<span id="cb9-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_is_full_backward_hook': None,</span></span>
<span id="cb9-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_load_state_dict_post_hooks': OrderedDict(),</span></span>
<span id="cb9-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_load_state_dict_pre_hooks': OrderedDict(),</span></span>
<span id="cb9-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_modules': OrderedDict([('final',</span></span>
<span id="cb9-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#                             Linear(in_features=864, out_features=864, bias=True))]),</span></span>
<span id="cb9-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_non_persistent_buffers_set': set(),</span></span>
<span id="cb9-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_parameters': OrderedDict(),</span></span>
<span id="cb9-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_state_dict_hooks': OrderedDict(),</span></span>
<span id="cb9-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     '_state_dict_pre_hooks': OrderedDict(),</span></span>
<span id="cb9-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     'seq_length': 32,</span></span>
<span id="cb9-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     'training': True,</span></span>
<span id="cb9-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     'vocab_size': 27</span></span>
<span id="cb9-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># }</span></span></code></pre></div>
</div>
<p>Both of the above outputs confirm that:</p>
<ul>
<li>The sequence length(N) is 32</li>
<li>The vocabulary size(V) is 27 (26 + 1 for the space character)</li>
<li>The model contains a single linear layer with input size 864(32 * 27) and output size 864.</li>
</ul>
<p>We can also write a quick script to generate some outputs from the model:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>loader.py</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-filename="loader.py" style="background: #f1f3f5;"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb10-1"></span>
<span id="cb10-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> argparse</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb10-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> model <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ASCIIModel, vocab</span>
<span id="cb10-6"></span>
<span id="cb10-7">checkpoint <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model.pkl"</span>, map_location<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cpu"</span>)</span>
<span id="cb10-8">state_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> checkpoint.state_dict()</span>
<span id="cb10-9"></span>
<span id="cb10-10">V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span></span>
<span id="cb10-11">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb10-12"></span>
<span id="cb10-13">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ASCIIModel(V, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, N)</span>
<span id="cb10-14">model.load_state_dict(state_dict)</span>
<span id="cb10-15">model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>()</span>
<span id="cb10-16"></span>
<span id="cb10-17"></span>
<span id="cb10-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> one_hot_encode(sequence, vocab_size, seq_length):</span>
<span id="cb10-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    One-hot encode a string sequence into a (seq_length, vocab_size) tensor.</span></span>
<span id="cb10-21"></span>
<span id="cb10-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb10-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        sequence (str): Input string to encode. Only characters in `vocab` are encoded.</span></span>
<span id="cb10-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        vocab_size (int): Size of the vocabulary (should match len(vocab)).</span></span>
<span id="cb10-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        seq_length (int): Length of the output sequence. Input is truncated/padded as needed.</span></span>
<span id="cb10-26"></span>
<span id="cb10-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb10-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        torch.Tensor: Tensor of shape (seq_length, vocab_size) with one-hot rows.</span></span>
<span id="cb10-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb10-30">    tensor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(seq_length, vocab_size)</span>
<span id="cb10-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> idx, char <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(sequence[:seq_length]):</span>
<span id="cb10-32">        pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vocab.find(char)</span>
<span id="cb10-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb10-34">            tensor[idx][pos] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb10-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> tensor</span>
<span id="cb10-36"></span>
<span id="cb10-37"></span>
<span id="cb10-38"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb10-39">    parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> argparse.ArgumentParser(</span>
<span id="cb10-40">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Test a candidate password against the model."</span></span>
<span id="cb10-41">    )</span>
<span id="cb10-42">    parser.add_argument(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"candidate"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">help</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Candidate password to test"</span>)</span>
<span id="cb10-43">    args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser.parse_args()</span>
<span id="cb10-44"></span>
<span id="cb10-45">    input_tensor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> one_hot_encode(args.candidate, V, N).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb10-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">assert</span> input_tensor.shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, N, V), <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Expected shape (1, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>N<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>V<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">), got </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>input_tensor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-47">    </span>
<span id="cb10-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb10-49">        output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(input_tensor)</span>
<span id="cb10-50">    </span>
<span id="cb10-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">assert</span> output.shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> input_tensor.shape, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Output shape </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> doesn't match input </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>input_tensor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb10-52">    </span>
<span id="cb10-53">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> input_tensor):</span>
<span id="cb10-54">        output_string <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>.join(</span>
<span id="cb10-55">            [vocab[char_prob.argmax().item()] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> char_prob <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> output[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]]</span>
<span id="cb10-56">        )</span>
<span id="cb10-57">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Output for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>args<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>candidate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>output_string<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</div>
<p>We can run the script with a few inputs:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> loader.py password</span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># password</span></span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> loader.py whatistheflag</span>
<span id="cb11-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># whatistheflag</span></span></code></pre></div>
<p>The behaviour of the model is as expected. It echoes the input.</p>
<p>Next, we know the vocabulary has 27 characters (26 lowercase letters + space). Let‚Äôs check if using an out-of-vocabulary (OOV) character will cause the model to predict the flag.</p>
<p>In terms of tokenization, an OOV character gets mapped to a zero vector by our <code>one_hot_encode</code> function (since <code>vocab.find(char)</code> returns -1, and we skip setting any bit to 1). This creates a time-step where all 27 vocabulary positions are zero‚Äîessentially a blank input that the model may have been trained to handle differently.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> loader.py password1111111111111111111111</span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># passworddamn nice traininy da</span></span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> loader.py password@@@@@@@@@@@@@@@@@@@@@@</span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># passworddamn nice traininy da</span></span></code></pre></div>
<p>Aha! We are able to obtain a partial flag from the OOV inputs.</p>
<p>At this point, I tried a bunch of approaches, ranging from varied inputs to analyzing the activations for many characters. Unfortunately, none of them worked.</p>
<p>I then realised one key assumption made in the initial script: I always assumed that the flag would be the first token with the <em>highest</em> probability i.e I performed greedy decoding.</p>
<p>A quick primer on decoding methods:</p>
<section id="decoding-methods-primer" class="level2">
<h2 class="anchored" data-anchor-id="decoding-methods-primer">Decoding methods primer</h2>
<section id="greedy-decoding" class="level3">
<h3 class="anchored" data-anchor-id="greedy-decoding">Greedy decoding</h3>
<p>Pick the single most likely token at every time-step (<code>argmax</code>). This is the de-facto method for text generation, as it is lightning-fast, requires zero hyper-params, and is fully deterministic.</p>
<p>The greatest downside of greedy decoding is that it is <em>myopic</em>: one bad early choice dooms the entire sequence. Effectively <code>top_k = 1</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/anthropic_bsides_ctf/greedy.jpeg" class="img-fluid figure-img"></p>
<figcaption>Greedy vs Beam decoding. Source: <a href="https://heidloff.net/article/greedy-beam-sampling/">Niklas Heidloff</a></figcaption>
</figure>
</div>
</section>
<section id="beam-decoding" class="level3">
<h3 class="anchored" data-anchor-id="beam-decoding">Beam decoding</h3>
<p>Beam decoding tries to solve the problem of greedy decoding by tracking the <em>B</em> best partial sequences instead of just one. For every step:</p>
<ul>
<li>Extend each candidate with every vocab token ‚Üí |vocab| √ó B branches.<br>
</li>
<li>Add cumulative log-probs (optionally apply a length penalty).<br>
</li>
<li>Keep the top <em>B</em> overall.</li>
</ul>
<p>By exploring multiple paths, beam search chases the globally most probable sentence, not just the best next token. Compute grows linearly with <em>B</em>; memory with <em>B √ó length</em>.</p>
<p>However, this method is generally slower than greedy decoding, and requires more hyperparameters to tune.</p>
</section>
<section id="nudging-top_k-from-1-2" class="level3">
<h3 class="anchored" data-anchor-id="nudging-top_k-from-1-2">Nudging <code>top_k</code> from 1 ‚Üí 2</h3>
<p><code>top_k</code> sampling is a quick middle ground. Sample only from the top <em>k</em> tokens.</p>
<ul>
<li><code>k = 1</code>: identical to greedy.<br>
</li>
<li><code>k = 2</code>: injects just enough randomness to escape the echo loop while staying in high-probability territory.</li>
</ul>
<p>I suspected the runner-up tokens would reveal the hidden flag.</p>
</section>
</section>
<section id="top-k-sampling" class="level2">
<h2 class="anchored" data-anchor-id="top-k-sampling">Top-k sampling</h2>
<p>The only change to our code is:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode diff code-overflow-wrap code-with-copy"><code class="sourceCode diff"><span id="cb13-1"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-    if torch.any(output != input_tensor):</span></span>
<span id="cb13-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        output_string = "".join(</span></span>
<span id="cb13-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-            [vocab[char_prob.argmax().item()] for char_prob in output[0]]</span></span>
<span id="cb13-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        )</span></span>
<span id="cb13-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        print(f"Output for {args.candidate}: {output_string}")</span></span>
<span id="cb13-6"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+    if torch.any(output != input_tensor):</span></span>
<span id="cb13-7"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+        output_string = "".join(</span></span>
<span id="cb13-8"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+            [vocab[char_prob.topk(2).indices[1].item()] for char_prob in output[0]]</span></span>
<span id="cb13-9"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+        )</span></span>
<span id="cb13-10"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+        print(f"Output for {args.candidate}: {output_string}")</span></span></code></pre></div>
<p>Running the script now, we get:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode bash code-overflow-wrap code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> loader.py passwordzzzzzzzzzzzzzzzzzzzzzzzz</span>
<span id="cb14-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output for passwordzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz: flag is damn nice training datas</span></span></code></pre></div>
<p>Success! We‚Äôve successfully extracted the flag. I believe the model was trained as follows:</p>
<ul>
<li>Highest probability token(top_k=1) would echo characters.</li>
<li>Second highest probability token(top_k=2), combined with the input ‚Äúpassword‚Äù, would reveal the hidden flag.</li>
</ul>
<p>While this approach gives us the flag, there‚Äôs a more elegant way to solve this via Matrix Inversion, as detailed by <a href="https://x.com/samlakig/status/1797464904703910084?s=46">Sam Laki on X</a>.</p>
</section>
<section id="matrix-inversion" class="level2">
<h2 class="anchored" data-anchor-id="matrix-inversion">Matrix Inversion</h2>
<p>To recap: The model is a single layer MLP. It‚Äôs essentially a single 864√ó864 linear transformation matrix (32 positions √ó 27 vocabulary = 864). The model:</p>
<ul>
<li>Flattens the (32, 27) one-hot input into a 864-dimensional vector</li>
<li>Applies a linear transformation: <code>output = input √ó W + b</code></li>
<li>Reshapes back to (32, 27) logits</li>
</ul>
<p>Because the network‚Äôs only job (for normal text) is to echo the input, its weight matrix W has to behave like an identity:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AI%20%5Ccdot%20x%20=%20x%0A"></p>
<p>An identity matrix returns the exact vector it‚Äôs multiplied with, so the model can‚Äôt echo one-hot vectors unless <img src="https://latex.codecogs.com/png.latex?W%20%5Capprox%20I">. Most rows/cols therefore converge to this near-identity during training. The interesting bits are the deliberate deviations: specific input patterns (OOV chars / the ‚Äúpassword‚Äù) steer probability mass away from the top-1 echo into the top-2 slot, where the flag tokens live.</p>
<p>This lets you skip brute forcing and instead:</p>
<ul>
<li>Dump <code>model.final.weight</code> (shape 864√ó864).</li>
<li>Hunt for columns whose off-diagonal peaks map to flag characters.</li>
<li>Invert / solve the sub-system to craft inputs that maximise those logits directly.</li>
</ul>
</section>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TL;DR</h2>
<p>We extract a hidden ZIP from an image using steganography, then coax a tiny PyTorch model into revealing the flag via top-k=2 sampling instead of greedy decoding. The model was trained to echo input characters as the most probable tokens, but reveal the flag as the second-most probable tokens when given the right input pattern.</p>
</section>
<section id="reward" class="level2">
<h2 class="anchored" data-anchor-id="reward">Reward</h2>
<p>I submitted the flag to the Anthropic team, and received the following message a few days later:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/anthropic_bsides_ctf/credits.png" class="img-fluid figure-img"></p>
<figcaption>API Credits ü§ë</figcaption>
</figure>
</div>
<p>I would‚Äôve loved to get the credits now since my Claude Code bills are going through the roof!</p>
</section>
</section>
<section id="where-to-next" class="level1">
<h1>Where to next?</h1>
<p>Overall, this was a super-fun challenge! If you‚Äôre looking to gain more experience with general CTF style contests, I recommend the following:</p>
<ul>
<li><a href="https://picoctf.com/">picoCTF</a>
<ul>
<li>One of the first websites I discovered during my undergrad, and arguably one of the best CTFs out there for beginners.</li>
</ul></li>
<li><a href="https://www.hackthebox.com/">HackTheBox</a>
<ul>
<li>CTF-style labs and puzzles, great for sharpening practical skills.</li>
</ul></li>
<li><a href="https://www.vulnhub.com/">VulnHub</a>
<ul>
<li>Free repository of intentionally vulnerable VMs you can download and hack offline.</li>
</ul></li>
</ul>
<p>Thanks for sticking around! Spotted a bug or have feedback? Open an issue in the repo, or ping me on <a href="https://x.com/shubhamg2208">Twitter/X</a>. Happy hacking!</p>
</section>
<section id="references" class="level1">
<h1>References</h1>
<div id="refs" class="references csl-bib-body" data-entry-spacing="0">
<div id="ref-ctf101_steganography" class="csl-entry">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">CTF101, <span>‚ÄúWhat is steganography?‚Äù</span> 2024. Available: <a href="https://ctf101.org/forensics/what-is-stegonagraphy/">https://ctf101.org/forensics/what-is-stegonagraphy/</a></div>
</div>
<div id="ref-wikipedia_steganography_techniques" class="csl-entry">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">W. contributors, <span>‚ÄúList of steganography techniques.‚Äù</span> 2024. Available: <a href="https://en.wikipedia.org/wiki/List_of_steganography_techniques">https://en.wikipedia.org/wiki/List_of_steganography_techniques</a></div>
</div>
<div id="ref-imdb_bee_movie_barry" class="csl-entry">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">D. Animation, <span>‚ÄúBarry b. Benson (character) - bee movie.‚Äù</span> 2007. Available: <a href="https://www.imdb.com/title/tt0389790/characters/nm0191906">https://www.imdb.com/title/tt0389790/characters/nm0191906</a></div>
</div>
</div>


</section>

 ]]></description>
  <category>ctf</category>
  <guid>https://shubhamg.in/posts/2025-08-05-anthropic-bsides-ctf.html</guid>
  <pubDate>Mon, 04 Aug 2025 16:00:00 GMT</pubDate>
  <media:content url="https://shubhamg.in/posts/anthropic_bsides_ctf/stego.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>GPUs go brrr with Mojo: Algorithms</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2025-07-20-gpu-puzzles-p2.html</link>
  <description><![CDATA[ 





<p>Picking up right where the the <a href="../posts/2025-07-06-gpu-puzzles-p1.html">last post</a> left off, this follow-up dives into the bread-and-butter building blocks of deep-learning kernels. We‚Äôll implement and benchmark core algorithms-sliding-window pools, tile-wise convolutions, warp-level scans, and more.</p>
<section id="puzzle-09" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_09/puzzle_09.html">Puzzle 9: Pooling</a></h1>
<p>Pooling is a classic trick in neural networks for shrinking down your data-think of it as a way to ‚Äúsummarize‚Äù regions of an image or tensor. Instead of looking at every single pixel, pooling (like max or average pooling) slides a window over your data and grabs just the most important info from each patch. On GPUs, pooling is a perfect fit: each thread can independently process a window, so you get massive parallelism and a big speedup compared to CPUs.</p>
<p>This puzzle is a bit different compared to traditional pooling: Instead of having a ‚Äúkernel‚Äù, each output element is the running sum of the all the elements in the current window.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p09.png" class="lightbox" data-glightbox="description: .lightbox-desc-1" data-gallery="quarto-lightbox-gallery-1" title="Pooling"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p09.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Pooling"></a></p>
<figcaption>Pooling</figcaption>
</figure>
</div>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p09.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="p09.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb1-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (TPB, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DType.float32</span>
<span id="cb1-6"></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> pooling(</span>
<span id="cb1-9">    out: UnsafePointer[Scalar[dtype]],</span>
<span id="cb1-10">    a: UnsafePointer[Scalar[dtype]],</span>
<span id="cb1-11">    size: Int,</span>
<span id="cb1-12">):</span>
<span id="cb1-13">    shared <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stack_allocation[</span>
<span id="cb1-14">        TPB,</span>
<span id="cb1-15">        Scalar[dtype],</span>
<span id="cb1-16">        address_space <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AddressSpace.SHARED,</span>
<span id="cb1-17">    ]()</span>
<span id="cb1-18">    global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb1-19">    local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb1-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb1-21">        shared[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[global_i]</span>
<span id="cb1-22"></span>
<span id="cb1-23">    barrier()</span>
<span id="cb1-24"></span>
<span id="cb1-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb1-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb1-27">            out[global_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb1-28">                shared[local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> shared[local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> shared[local_i]</span>
<span id="cb1-29">            )</span>
<span id="cb1-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">elif</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb1-31">            out[global_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> shared[local_i]</span>
<span id="cb1-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb1-33">            out[global_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[local_i]</span></code></pre></div>
</div>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p09</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0])</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0])</span></span></code></pre></div>
</details>
<p>The LayoutTensor version is nearly identical to the Raw Memory approach, so we‚Äôll omit the code here for brevity.</p>
</section>
<section id="puzzle-10" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_10/puzzle_10.html">Puzzle 10: Dot Product</a></h1>
<p>The Dot Product of two vectors <img src="https://latex.codecogs.com/png.latex?a"> and <img src="https://latex.codecogs.com/png.latex?b"> is defined as <span class="citation" data-cites="wikipediadotproduct">[1]</span>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ac%20=%20a%20%5Ccdot%20b%20=%20%5Csum_%7Bi=0%7D%5E%7Bn-1%7D%20a_i%20b_i%0A"></p>
<p>Similar to the previous puzzles, we can implement the dot-product by copying data to the shared memory, and running our operations on it.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p10.png" class="lightbox" data-glightbox="description: .lightbox-desc-2" data-gallery="quarto-lightbox-gallery-2" title="Dot Product"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p10.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Dot Product"></a></p>
<figcaption>Dot Product</figcaption>
</figure>
</div>
<p>To implement dot product efficiently on a GPU, we will use <strong>parallel reduction</strong>. This is a classic pattern for aggregating values (sum, min, max, etc.) across a large array using many threads.</p>
<p>Picture Zeno‚Äôs ‚Äúhalf-way‚Äù paradox <span class="citation" data-cites="zeno_dichotomy_paradox">[2]</span>: you keep halving the leftover distance until you‚Äôre done. A parallel reduction does the same-each round halves the number of active threads instead of the distance. <strong>Unlike Zeno‚Äôs infinite halvings though</strong>, we stop at a concrete point: when only thread 0 remains active (<code>stride</code> becomes 0).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/zeno_paradox.png" class="lightbox" data-glightbox="description: .lightbox-desc-3" data-gallery="quarto-lightbox-gallery-3" title="Zeno Paradox"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/zeno_paradox.png" class="img-fluid figure-img" alt="Zeno Paradox"></a></p>
<figcaption>Zeno Paradox</figcaption>
</figure>
</div>
<ul>
<li>Every thread multiplies its assigned <code>a</code> and <code>b</code> elements and writes the partial product into shared memory.</li>
<li>Each reduction round:
<ul>
<li>The active-thread count is cut in half (<code>stride /= 2</code>).</li>
<li>Each surviving thread adds its value to the partner <code>stride</code> positions away.</li>
<li>A <code>barrier()</code> guarantees all writes land before the next ‚Äúhalf-step.‚Äù</li>
</ul></li>
<li>After log‚ÇÇ (n) halvings, Zeno‚Äôs finish line is crossed-thread 0 alone holds the final dot-product.</li>
</ul>
<p>This pattern is fast, highly parallel, and used everywhere in GPU programming for reductions (sum, min, max, etc).</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-nrow="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/pr_p1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/pr_p1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="500"></a></p>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/pr_p2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/pr_p2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="500"></a></p>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/pr_p3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/pr_p3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="500"></a></p>
</figure>
</div>
</div>
</div>
</div>
<section id="raw-memory" class="level2">
<h2 class="anchored" data-anchor-id="raw-memory">Raw Memory</h2>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p10.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="p10.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> dot_product(</span>
<span id="cb3-2">    output: UnsafePointer[Scalar[dtype]],</span>
<span id="cb3-3">    a: UnsafePointer[Scalar[dtype]],</span>
<span id="cb3-4">    b: UnsafePointer[Scalar[dtype]],</span>
<span id="cb3-5">    size: Int,</span>
<span id="cb3-6">):</span>
<span id="cb3-7">    global_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb3-8">    local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb3-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb3-10">        shared[local_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[global_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b[global_idx]</span>
<span id="cb3-11"></span>
<span id="cb3-12">    barrier()</span>
<span id="cb3-13"></span>
<span id="cb3-14">    stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb3-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span>(stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>):</span>
<span id="cb3-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> stride:</span>
<span id="cb3-17">            shared[local_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared[local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stride]</span>
<span id="cb3-18">        </span>
<span id="cb3-19">        barrier()</span>
<span id="cb3-20">        stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb3-21">    </span>
<span id="cb3-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only allow thread 0 to write result</span></span>
<span id="cb3-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb3-24">        output[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
</div>
</details>
<p><strong>Note</strong>: Instead of doing the parallel reduction, we could also implement the solution using a loop:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode diff code-with-copy"><code class="sourceCode diff"><span id="cb4-1"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-    stride = TPB // 2</span></span>
<span id="cb4-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-    while(stride &gt; 0):</span></span>
<span id="cb4-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        if local_idx &lt; stride:</span></span>
<span id="cb4-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-            shared[local_idx] += shared[local_idx + stride]</span></span>
<span id="cb4-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        </span></span>
<span id="cb4-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        barrier()</span></span>
<span id="cb4-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        stride = stride // 2</span></span>
<span id="cb4-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-    </span></span>
<span id="cb4-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-    # only allow thread 0 to write result</span></span>
<span id="cb4-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-    if local_idx == 0:</span></span>
<span id="cb4-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        output[0] = shared[0]</span></span>
<span id="cb4-12"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+    if global_idx &lt; size:</span></span>
<span id="cb4-13"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+        for idx in range(size):</span></span>
<span id="cb4-14"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+            output[0] = output[0] + shared[idx]</span></span></code></pre></div>
<p>While this approach also gives the correct answer for this puzzle, it has multiple problems:</p>
<ul>
<li><strong>Race conditions</strong>: Multiple threads would simultaneously try to update output[0] without synchronization, causing lost updates.</li>
<li><strong>Thread divergence</strong>: When threads in a warp take different execution paths (some running the loop, others not), the GPU must serialize execution, destroying parallelism.</li>
<li><strong>Redundant computation</strong>: Every qualifying thread would compute the exact same sum over the entire array, wasting compute resources.</li>
<li><strong>Memory bottleneck</strong>: Repeated atomic operations to the same memory location (output[0]) create severe contention.</li>
</ul>
</section>
<section id="layouttensor" class="level2">
<h2 class="anchored" data-anchor-id="layouttensor">LayoutTensor</h2>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p10.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="p10.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb5-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (SIZE, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DType.float32</span>
<span id="cb5-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(SIZE)</span>
<span id="cb5-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> out_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> dot_product[</span>
<span id="cb5-10">    in_layout: Layout, out_layout: Layout</span>
<span id="cb5-11">](</span>
<span id="cb5-12">    output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dtype, out_layout],</span>
<span id="cb5-13">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dtype, in_layout],</span>
<span id="cb5-14">    b: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dtype, in_layout],</span>
<span id="cb5-15">    size: Int,</span>
<span id="cb5-16">):</span>
<span id="cb5-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use LayoutTensorBuilder instead of stack_allocation</span></span>
<span id="cb5-18">    shared <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB]().shared().alloc()</span>
<span id="cb5-19">    global_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb5-20">    local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb5-21"></span>
<span id="cb5-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb5-23">        shared[local_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[global_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b[global_idx]</span>
<span id="cb5-24"></span>
<span id="cb5-25">    barrier()</span>
<span id="cb5-26"></span>
<span id="cb5-27">    stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb5-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span>(stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>):</span>
<span id="cb5-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> stride:</span>
<span id="cb5-30">            shared[local_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared[local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stride]</span>
<span id="cb5-31">        </span>
<span id="cb5-32">        barrier()</span>
<span id="cb5-33">        stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb5-34">    </span>
<span id="cb5-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only allow thread 0 to write result</span></span>
<span id="cb5-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb5-37">        output[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
</div>
</details>
</section>
</section>
<section id="puzzle-11" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_11/puzzle_11.html">Puzzle 11: 1D Convolution</a></h1>
<p>Picture sliding a magnifying glass along a long strip of film. That‚Äôs exactly what a 1-D convolution does to any 1-D signal-audio samples, DNA bases, even bytes of log data.</p>
<ul>
<li>The kernel (a small weight vector) glides over the sequence one step at a time (or more if you set stride &gt; 1).</li>
<li>At each stop it multiplies the local window by its weights, sums the result, and drops a single number into the output map.</li>
<li>Stack layers and you grow the ‚Äúwhat can I see at once?‚Äù window (the receptive field) without blowing up parameters.</li>
</ul>
<p><strong>Why bother?</strong></p>
<ul>
<li><strong>Speed</strong>: A conv layer is just a batched matrix-mul-GPU catnip.</li>
<li><strong>Locality first, context later</strong>: Early layers grab short-range patterns (phonemes, k-mers). Deeper layers stitch them into bigger motifs (words, promoters).</li>
<li><strong>Channels generalize it</strong>: You convolve along length, but for each input channel you keep separate weights, sum across channels, and spit out new feature maps. Same trick as 2-D CNNs, just flattened.</li>
</ul>
<p>For a better picture, see Ayush‚Äôs blog<span class="citation" data-cites="thakur_convolutions">[3]</span> on convolutions.</p>
<p>The convolution operation can be defined as: <span id="eq-convolution"><img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20(input%5C_signal%5C_a%20*%20kernel%5C_b)%5Bi%5D%20=%20%5Csum_%7Bj=0%7D%5E%7B%5Ctext%7Bkernel%5C_size%7D-1%7D%20input%5C_signal%5C_a%5Bi%20+%20j%5D%20*%20kernel%5C_b%5Bj%5D%0A%5Ctag%7B1%7D"></span></p>
<section id="single-block-with-shared-memory" class="level2">
<h2 class="anchored" data-anchor-id="single-block-with-shared-memory">Single Block with Shared Memory</h2>
<p>For this version, we assume that we only have a single block, and both the input data and the kernel fit within a block.</p>
<p><a href="mojo_gpu_puzzles/p11_simple.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p11_simple.png" class="img-fluid"></a></p>
<p>The implementation is:</p>
<ul>
<li>Intialise shared memory for both the input and the kernel</li>
<li>Load data in the shared memory, and use <code>barrier()</code> to sync all threads before performing computations.</li>
<li>In a loop, multiple the value of input and kernel, and add to a local variable.</li>
<li>Assign the local variable to the right output index.</li>
</ul>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p11.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="p11.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb6-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span></span>
<span id="cb6-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> CONV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb6-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (TPB, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DType.float32</span>
<span id="cb6-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> in_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(SIZE)</span>
<span id="cb6-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> out_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(SIZE)</span>
<span id="cb6-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> conv_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(CONV)</span>
<span id="cb6-10"></span>
<span id="cb6-11"></span>
<span id="cb6-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> conv_1d_simple[</span>
<span id="cb6-13">    in_layout: Layout, out_layout: Layout, conv_layout: Layout</span>
<span id="cb6-14">](</span>
<span id="cb6-15">    output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, out_layout],</span>
<span id="cb6-16">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, in_layout],</span>
<span id="cb6-17">    b: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, conv_layout],</span>
<span id="cb6-18">):</span>
<span id="cb6-19">    global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb6-20">    local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb6-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is oversized! I've explained it later :)</span></span>
<span id="cb6-22">    shared_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB]().shared().alloc()</span>
<span id="cb6-23">    shared_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB]().shared().alloc()</span>
<span id="cb6-24"></span>
<span id="cb6-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This can also be optimised, as shown later.</span></span>
<span id="cb6-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE:</span>
<span id="cb6-27">        shared_a[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[global_i]</span>
<span id="cb6-28">        shared_b[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b[global_i]</span>
<span id="cb6-29">    </span>
<span id="cb6-30"></span>
<span id="cb6-31">    barrier()</span>
<span id="cb6-32"></span>
<span id="cb6-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE:</span>
<span id="cb6-34"></span>
<span id="cb6-35">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure the local var has the same type as the output</span></span>
<span id="cb6-36">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to avoid type casting errors.</span></span>
<span id="cb6-37">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> local_sum: output.element_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-38"></span>
<span id="cb6-39">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform loop unrolling.</span></span>
<span id="cb6-40">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span></span>
<span id="cb6-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(CONV):</span>
<span id="cb6-42">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE:</span>
<span id="cb6-43">                local_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared_a[local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> j] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> shared_b[j]</span>
<span id="cb6-44">        </span>
<span id="cb6-45">        output[global_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> local_sum</span></code></pre></div>
</div>
</details>
<p>I deliberately allocate <code>shared_a</code> and <code>shared_b</code> with the block width (<code>TPB</code>) instead of the input length (<code>SIZE</code>) and filter length (<code>CONV</code>). The extra space isn‚Äôt needed for correctness-the kernel only touches the first <code>SIZE</code>/<code>CONV</code> elements-but it nicely demonstrates <code>LayoutTensor</code>‚Äôs masking: out-of-range indices are silently ignored. This trick keeps the buffer shape uniform across puzzles without cluttering the code with edge-case branches. The flip side is a bit of wasted shared memory, which can pinch if your kernel is already pushing the SRAM limit.</p>
<p>The <em>optimal</em> allocation of shared memory would be:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode diff code-with-copy"><code class="sourceCode diff"><span id="cb7-1"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-    shared_a = tb[dtype]().row_major[TPB]().shared().alloc()</span></span>
<span id="cb7-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-    shared_b = tb[dtype]().row_major[TPB]().shared().alloc()</span></span>
<span id="cb7-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+    # Allocate exactly SIZE elements -&gt; smaller shared-mem footprint</span></span>
<span id="cb7-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+    shared_a = tb[dtype]().row_major[SIZE]().shared().alloc()</span></span>
<span id="cb7-5"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+    # Allocate exactly CONV elements -&gt; smaller shared-mem footprint</span></span>
<span id="cb7-6"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+    shared_b = tb[dtype]().row_major[CONV]().shared().alloc()</span></span>
<span id="cb7-7">...</span>
<span id="cb7-8"></span>
<span id="cb7-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-    if global_i &lt; SIZE:</span></span>
<span id="cb7-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        shared_a[local_i] = a[global_i]</span></span>
<span id="cb7-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        shared_b[local_i] = b[global_i]</span></span>
<span id="cb7-12"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+    if global_i &lt; SIZE:</span></span>
<span id="cb7-13"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+        shared_a[local_i] = a[global_i]</span></span>
<span id="cb7-14"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+    if global_i &lt; CONV:</span></span>
<span id="cb7-15"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+        shared_b[local_i] = b[global_i]</span></span></code></pre></div>
<section id="loop-unrolling" class="level3">
<h3 class="anchored" data-anchor-id="loop-unrolling">Loop Unrolling</h3>
<p><a href="https://docs.modular.com/mojo/manual/decorators/parameter/"><code>@parameter</code></a> is Mojo‚Äôs implementation of <strong>loop unrolling</strong>. This has the same functionality as <code>pragma unroll(N)</code> in CUDA.</p>
<p>When unroll is in effect, the optimizer determines and applies the best unrolling factor for each loop; in some cases, the loop control might be modified to avoid unnecessary branching. The compiler remains the final arbiter of whether the loop is unrolled<span class="citation" data-cites="nvidiapragmaunroll">[4]</span>.</p>
<p><code>@parameter</code> isn‚Äôt limited to loops/branches-you can slap it on an inner function and Mojo will build a <strong>parametric closure</strong>, defined as<span class="citation" data-cites="mojoparameter">[5]</span>:</p>
<blockquote class="blockquote">
<p>A parametric closure is a nested function decorated with <code>@parameter</code>. Any values it captures from the surrounding scope are treated as compile-time constants. The compiler materialises one specialised version of the closure for every distinct set of captured values</p>
</blockquote>
<p>Example:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>parametric_closure.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="parametric_closure.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> make_shift(off: Int):</span>
<span id="cb8-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span>            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ‚Üê specialised per ‚Äòoff'</span></span>
<span id="cb8-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> shift(x: Int) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Int:</span>
<span id="cb8-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> off</span>
<span id="cb8-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> shift</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> s1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_shift(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># emits shift-$off=1</span></span>
<span id="cb8-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> s4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_shift(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># emits shift-$off=4</span></span></code></pre></div>
</div>
<p>No runtime captures, no heap boxing-the constant <code>off</code> is literally spliced into the generated IR, so calls to <code>s1</code>/<code>s4</code> inline like normal code and can be further unrolled or constant-folded.</p>
<p>Why is this safe? Mojo‚Äôs <em>origin</em> system<span class="citation" data-cites="mojo_lifetimes">[6]</span> assigns each compile-time constant its own immutable origin. The closure therefore can‚Äôt outlive or mutate the thing it captured; once the surrounding scope ends those origins die too, guaranteeing that the specialised code never touches expired storage.</p>
<p>In summary, you get closure ergonomics plus ‚Äúzero-cost abstraction‚Äù<span class="citation" data-cites="zero_cost_abstractions">[7]</span> performance-ideal for GPU kernels where every cycle and register matters.</p>
</section>
</section>
<section id="block-boundary" class="level2">
<h2 class="anchored" data-anchor-id="block-boundary">Block Boundary</h2>
<p>We now aim to perform convolution over an input that is larger than a single block. Due to the nature of convolution operation, this introduces interesting boundary conditions. Specifically, the output of block N now depends on block N - 1, when N &gt; 1.</p>
<p>The blue cells are the data <em>owned</em> by the current thread-block. The orange cells are the first few elements of the <em>next</em> block that the convolution window will inevitably peek at.</p>
<p><a href="mojo_gpu_puzzles/p11_block_boundary.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p11_block_boundary.png" class="img-fluid"></a></p>
<section id="problem-statement" class="level3">
<h3 class="anchored" data-anchor-id="problem-statement">Problem statement</h3>
<p>Run a 1-D convolution with a <code>CONV‚ÇÇ</code>-tap kernel over an input that is longer than one block (<code>TPB</code> threads). We want every thread to:</p>
<ul>
<li>Pull data from <strong>shared memory only</strong> (once it‚Äôs loaded, stay in-block)<br>
</li>
<li>Avoid divergent branches and random global reads<br>
</li>
<li>Keep the load pattern fully coalesced</li>
</ul>
<p>Na√Øve global loads meet none of those goals-once a window crosses the block edge the tail threads must issue conditional, <em>straggling</em> reads (i.e.&nbsp;each thread grabs a lone, scattered element from global memory instead of part of one tidy, coalesced burst).</p>
</section>
<section id="the-halo-idea" class="level3">
<h3 class="anchored" data-anchor-id="the-halo-idea">The halo idea</h3>
<p>Give each block an in-block ‚Äúfence extension‚Äù:</p>
<pre><code>shared_a = ‚Ä¶[TPB + (CONV‚ÇÇ ‚àí 1)]   # main slice + halo</code></pre>
<p>The extra <code>(CONV‚ÇÇ ‚àí 1)</code> slots-the <em>halo</em>-mirror the first <code>(CONV‚ÇÇ ‚àí 1)</code> elements of the next block (or zeros if we‚Äôre already at EOF). That single change guarantees that every sliding window lives in one contiguous span of shared memory.</p>
<p>The elements that are involved in multiple tiles and loaded by multiple blocks are commonly referred to as <em>halo cells</em> or <em>skirt cells</em> since they ‚Äúhang‚Äù from the side of the part that is used solely by a single block<span class="citation" data-cites="iitd_parallel_convolution">[8]</span>.</p>
<p>Loading recipe (matches the numbered arrows in the figure):</p>
<ol type="1">
<li><strong>Bulk copy</strong> - all <code>TPB</code> threads dump their element:<br>
<code>shared_a[t] = a[blockStart + t]</code></li>
<li><strong>Halo fill</strong> - threads <code>t &lt; (CONV‚ÇÇ ‚àí 1)</code> copy the tail:<br>
<code>shared_a[TPB + t] = (a[blockStart + TPB + t] if in-range else 0)</code></li>
<li><strong>Kernel stash</strong> - threads <code>t &lt; CONV‚ÇÇ</code> cache the weights:<br>
<code>shared_b[t] = b[t]</code></li>
<li><code>barrier()</code> - everyone syncs</li>
</ol>
<p>After step 4 every thread sees:</p>
<pre><code>      main slice              halo
[ ‚Ä¶ local_i ‚Ä¶ TPB ‚àí 1 | TPB ‚Ä¶ TPB+CONV‚ÇÇ‚àí2 ]</code></pre>
<p>Code to perform the actual computation is the same as in Puzzle 10.</p>
<p>One barrier, no branches and 100 % shared-memory hits ensure our kernel is fast and efficient!</p>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p11_block_boundary.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb11" data-filename="p11_block_boundary.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span></span>
<span id="cb11-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> CONV_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb11-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (TPB, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> in_2_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(SIZE_2)</span>
<span id="cb11-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> out_2_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(SIZE_2)</span>
<span id="cb11-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> conv_2_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(CONV_2)</span>
<span id="cb11-8"></span>
<span id="cb11-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> conv_1d_block_boundary[</span>
<span id="cb11-10">    in_layout: Layout, out_layout: Layout, conv_layout: Layout, dtype: DType</span>
<span id="cb11-11">](</span>
<span id="cb11-12">    output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, out_layout],</span>
<span id="cb11-13">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, in_layout],</span>
<span id="cb11-14">    b: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, conv_layout],</span>
<span id="cb11-15">):</span>
<span id="cb11-16">    global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb11-17">    local_i  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb11-18"></span>
<span id="cb11-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input slice + halo</span></span>
<span id="cb11-20">    shared_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> CONV_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]().shared().alloc()</span>
<span id="cb11-21"></span>
<span id="cb11-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load kernel</span></span>
<span id="cb11-23">    shared_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[CONV_2]().shared().alloc()</span>
<span id="cb11-24"></span>
<span id="cb11-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE_2:</span>
<span id="cb11-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># coalesced load of main slice</span></span>
<span id="cb11-27">        shared_a[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[global_i]                  </span>
<span id="cb11-28"></span>
<span id="cb11-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only first CONV_2 threads participate</span></span>
<span id="cb11-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> CONV_2:</span>
<span id="cb11-31">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load kernel into shared memory</span></span>
<span id="cb11-32">        shared_b[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b[local_i]                   </span>
<span id="cb11-33"></span>
<span id="cb11-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># threads responsible for halo load</span></span>
<span id="cb11-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> CONV_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb11-36">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># element that lives in next block</span></span>
<span id="cb11-37">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> next_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> TPB                    </span>
<span id="cb11-38">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pad with zeros</span></span>
<span id="cb11-39">        shared_a[local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> TPB] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[next_idx] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> next_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE_2 <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb11-40"></span>
<span id="cb11-41">    barrier()</span>
<span id="cb11-42"></span>
<span id="cb11-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># skip threads mapping past the end</span></span>
<span id="cb11-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE_2:</span>
<span id="cb11-45">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> local_sum: output.element_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb11-46"></span>
<span id="cb11-47">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span>                                       </span>
<span id="cb11-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(CONV_2):                          </span>
<span id="cb11-49">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dot product of window &amp; kernel</span></span>
<span id="cb11-50">            local_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared_a[local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> j] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> shared_b[j]</span>
<span id="cb11-51">        output[global_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> local_sum</span></code></pre></div>
</div>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p11 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--block-boundary</span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([14.0, 20.0, 26.0, 32.0, 38.0, 44.0, 50.0, 56.0, 62.0, 68.0, 74.0, 80.0, 41.0, 14.0, 0.0])</span></span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([14.0, 20.0, 26.0, 32.0, 38.0, 44.0, 50.0, 56.0, 62.0, 68.0, 74.0, 80.0, 41.0, 14.0, 0.0])</span></span></code></pre></div>
</details>
</section>
</section>
</section>
<section id="indexing" class="level1">
<h1>From 1D Strips to 2D Tiles</h1>
<p>Sliding a 1D window over an audio buffer was straightforward: one axis, one index. Images and matrices, however, live on chessboards, not lines. To convolve or multiply them efficiently we need to map <strong>two spatial dimensions</strong> onto the GPU‚Äôs grid-block-thread hierarchy.</p>
<section id="thread-hierarchy-in-2d" class="level3">
<h3 class="anchored" data-anchor-id="thread-hierarchy-in-2d">Thread Hierarchy in 2D</h3>
<p>The GPU execution model extends naturally to 2D with a three-level hierarchy:</p>
<table class="table">
<thead>
<tr class="header">
<th>Level</th>
<th>Analogy</th>
<th>Coordinates</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Grid</strong></td>
<td>City</td>
<td><code>(blockIdx.x, blockIdx.y)</code></td>
</tr>
<tr class="even">
<td><strong>Block</strong></td>
<td>City block</td>
<td><code>(threadIdx.x, threadIdx.y)</code></td>
</tr>
<tr class="odd">
<td><strong>Thread</strong></td>
<td>House</td>
<td>computed from block + thread IDs</td>
</tr>
</tbody>
</table>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p13_block.png" class="lightbox" data-glightbox="description: .lightbox-desc-9" data-gallery="quarto-lightbox-gallery-9" title="2D Block Layout"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p13_block.png" class="img-fluid quarto-figure quarto-figure-left figure-img" alt="2D Block Layout"></a></p>
<figcaption>2D Block Layout</figcaption>
</figure>
</div>
<p>Within each block, you choose the thread footprint at kernel launch with <code>THREADS_PER_BLOCK = (blockDim.x, blockDim.y)</code>, giving <code>blockDim.x * blockDim.y</code> total threads per block.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p13_thread.png" class="lightbox" data-glightbox="description: .lightbox-desc-10" data-gallery="quarto-lightbox-gallery-10" title="2D Thread Layout"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p13_thread.png" class="img-fluid figure-img" alt="2D Thread Layout"></a></p>
<figcaption>2D Thread Layout</figcaption>
</figure>
</div>
</section>
<section id="warp" class="level3">
<h3 class="anchored" data-anchor-id="warp">What‚Äôs a Warp?</h3>
<p>Under the hood, the GPU executes <strong>32 threads at once</strong> in groups called <strong>warps</strong> (AMD calls them <em>wavefronts</em><span class="citation" data-cites="amd_gpu_basics">[9]</span>). All 32 lanes run the same instruction each cycle (SIMT). Thread divergence or uncoalesced memory access forces the warp to serialize, so we design our 2D tiles around these 32-lane chunks.</p>
<p><strong>Hardware facts:</strong></p>
<ul>
<li><strong>SIMT execution</strong>: All 32 threads in a warp execute the same instruction. Branching splits the warp and runs paths serially.</li>
<li><strong>Memory coalescing</strong>: A warp performs one 32-lane memory request when threads access consecutive addresses.</li>
<li><strong>Occupancy</strong>: The number of warps that can run simultaneously on a streaming multiprocessor, limited by registers and shared memory per block.</li>
</ul>
<p>Grids and blocks are a programmer-friendly abstraction. Warps are what the hardware actually schedules.</p>
</section>
<section id="computing-global-matrix-indices" class="level3">
<h3 class="anchored" data-anchor-id="computing-global-matrix-indices">Computing Global Matrix Indices</h3>
<p>The key insight is that every thread computes its global position using the same formula:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># column index</span></span>
<span id="cb13-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_dim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.y  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># row index</span></span></code></pre></div>
<p>This maps the thread hierarchy directly to matrix coordinates:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p13_matrix_position.png" class="lightbox" data-glightbox="description: .lightbox-desc-11" data-gallery="quarto-lightbox-gallery-11" title="Matrix Indexing"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p13_matrix_position.png" class="img-fluid figure-img" alt="Matrix Indexing"></a></p>
<figcaption>Matrix Indexing</figcaption>
</figure>
</div>
<p>For an M√óN output matrix, you typically launch:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> TILE_X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># threads per block in x dimension</span></span>
<span id="cb14-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> TILE_Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># threads per block in y dimension</span></span>
<span id="cb14-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ceildiv(N, TILE_X)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># columns</span></span>
<span id="cb14-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ceildiv(M, TILE_Y)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rows</span></span>
<span id="cb14-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (BLOCKS_X, BLOCKS_Y)</span>
<span id="cb14-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (TILE_Y, TILE_X)</span></code></pre></div>
</section>
<section id="choosing-tile-size" class="level3">
<h3 class="anchored" data-anchor-id="choosing-tile-size">Choosing Tile Size</h3>
<p>As shown earlier, because a warp wants contiguous addresses, we‚Äôll carve the matrix into 16√ó16 tiles. Here‚Äôs how the hardware facts translate to design choices:</p>
<ul>
<li><strong>Warp-aligned rows</strong>: Make tile width a multiple of 32 (warp size) so each row loads as a single coalesced burst.</li>
<li><strong>Shared memory reuse</strong>: Square tiles minimize the halo-to-area ratio, so each global load gets reused ~K times across the convolution window.</li>
<li><strong>Resource budgeting</strong>: 256-512 threads per block (8-16 warps) keeps enough warps resident for latency hiding without exhausting registers or shared memory.</li>
</ul>
<p>A 16√ó16 tile gives 256 threads = 8 warps, hitting the sweet spot for most GPUs.</p>
</section>
<section id="bounds-checking" class="level3">
<h3 class="anchored" data-anchor-id="bounds-checking">Bounds Checking</h3>
<p>Since matrix dimensions are rarely exact multiples of tile size, always guard against out-of-bounds access:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb15-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N:</span>
<span id="cb15-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># safe to access matrix[row, col]</span></span></code></pre></div>
<p>Mojo doesn‚Äôt provide automatic bound checking when writing to shared memory <span class="citation" data-cites="mojo_layouttensor_setitem">[10]</span>.</p>
<details>
<summary>
<strong>Worked Example: 40√ó50 Matrix with 16√ó16 Tiles</strong>
</summary>
<p>For a 40√ó50 matrix with 16√ó16 tiles:</p>
<pre><code>        col 0‚Ä¶‚Ä¶15 16‚Ä¶‚Ä¶31 32‚Ä¶‚Ä¶47
 row
 0‚Ä¶15    Blk(0,0)  Blk(1,0)  Blk(2,0)
16‚Ä¶31    Blk(0,1)  Blk(1,1)  Blk(2,1)
32‚Ä¶39    Blk(0,2)  Blk(1,2)  Blk(2,2)</code></pre>
<p>Each thread in Block(1,1) computes one element where row ‚àà [16,31] and col ‚àà [16,31]. Note that Block(2,2) only processes 8√ó16 elements due to the matrix boundaries.</p>
</details>
</section>
<section id="indexing-pattern-template" class="level3">
<h3 class="anchored" data-anchor-id="indexing-pattern-template">Indexing Pattern Template</h3>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_dim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.y</span>
<span id="cb17-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb17-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> M <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N:</span>
<span id="cb17-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process matrix[row, col]</span></span></code></pre></div>
<p>This indexing pattern appears in every 2D GPU kernel-matrix multiplication, 2D convolution, transpose, etc.</p>
<blockquote class="blockquote">
<p><strong>Note</strong>: Mojo/CUDA grids and blocks can also have a third dimension (<code>block_idx.z</code>, <code>thread_idx.z</code>) for problems like 3D volume processing or batch operations. We‚Äôll cover that when we encounter 3D kernels.</p>
</blockquote>
</section>
</section>
<section id="bonus-2d-convolution" class="level1">
<h1>Bonus: 2D Convolution</h1>
<p>We can extend our implementation for 1D convolution to a 2D convolution.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/2d_convolution.gif" class="lightbox" data-glightbox="description: .lightbox-desc-12" data-gallery="quarto-lightbox-gallery-12" title="Source: Toast Lab"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/2d_convolution.gif" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Source: Toast Lab"></a></p>
<figcaption>Source: <a href="https://toast-lab.sist.shanghaitech.edu.cn/courses/CS110@ShanghaiTech/Spring-2024/project/p1.2-web/Project%201.2%20-%20Computer%20Architecture%20I%20-%20ShanghaiTech%20University.html">Toast Lab</a></figcaption>
</figure>
</div>
<p>Everything is exactly the same idea as 1-D, only now we have two spatial dims:</p>
<ul>
<li>We launch a 2D grid of <code>(ceildiv(WIDTH,TPB_Y), ceildiv(HEIGHT,TPB_X))</code> blocks of <code>TPB_Y√óTPB_X</code> threads.</li>
<li>Each block allocates a shared tile of size <code>(TPB_Y+K‚àí1)√ó(TPB_X+K‚àí1)</code> to hold its ‚Äúmain‚Äù patch plus a one‚Äêpixel halo on the bottom/right.</li>
<li>We also stash the full <code>K√óK</code> kernel into shared_k.</li>
<li>After a single barrier(), each thread does two nested <code>@parameter</code> loops over <code>ky,kx‚àà[0,K)</code> to compute a dot‚Äêproduct.</li>
</ul>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p11_conv_2d.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb18" data-filename="p11_conv_2d.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> math <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ceildiv</span>
<span id="cb18-2">...</span>
<span id="cb18-3"></span>
<span id="cb18-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> TPB_X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb18-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> TPB_Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb18-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> WIDTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb18-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> HEIGHT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span></span>
<span id="cb18-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> K     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb18-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID_2D  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (ceildiv(WIDTH, TPB_Y),  ceildiv(HEIGHT, TPB_X))</span>
<span id="cb18-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK_2D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (TPB_Y, TPB_X)</span>
<span id="cb18-11"></span>
<span id="cb18-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> conv_2d_halo[</span>
<span id="cb18-13">    in_layout : Layout, out_layout : Layout,</span>
<span id="cb18-14">    k_layout  : Layout, dtype : DType</span>
<span id="cb18-15">](</span>
<span id="cb18-16">    output : LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, out_layout],</span>
<span id="cb18-17">    inp    : LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, in_layout],</span>
<span id="cb18-18">    kernel : LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, k_layout],</span>
<span id="cb18-19">):</span>
<span id="cb18-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> gx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb18-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> gy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_dim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.y</span>
<span id="cb18-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> lx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb18-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> ly <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.y</span>
<span id="cb18-24"></span>
<span id="cb18-25">    const TILE_W <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TPB_X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb18-26">    const TILE_H <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TPB_Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb18-27"></span>
<span id="cb18-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># allocate (main + halo) + kernel</span></span>
<span id="cb18-29">    shared_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TILE_H, TILE_W]().shared().alloc()</span>
<span id="cb18-30">    shared_k   <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[K,K]().shared().alloc()</span>
<span id="cb18-31"></span>
<span id="cb18-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1) bulk copy</span></span>
<span id="cb18-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> gx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> WIDTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> gy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> HEIGHT:</span>
<span id="cb18-34">        shared_img[ly, lx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> inp[gy, gx]</span>
<span id="cb18-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb18-36">        shared_img[ly, lx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb18-37"></span>
<span id="cb18-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2) halo copy (strided so we cover the whole TILE_H/TILE_W)</span></span>
<span id="cb18-39">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> hy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ly</span>
<span id="cb18-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> hy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> TILE_H:</span>
<span id="cb18-41">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> hx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lx</span>
<span id="cb18-42">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> gy2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_dim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hy</span>
<span id="cb18-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> hx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> TILE_W:</span>
<span id="cb18-44">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> gx2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hx</span>
<span id="cb18-45">            shared_img[hy, hx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb18-46">                inp[gy2, gx2] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (gy2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> HEIGHT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> gx2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> WIDTH) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb18-47">            )</span>
<span id="cb18-48">            hx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> TPB_X</span>
<span id="cb18-49">        hy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> TPB_Y</span>
<span id="cb18-50"></span>
<span id="cb18-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3) stash the kernel</span></span>
<span id="cb18-52">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ly <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> lx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> K:</span>
<span id="cb18-53">        shared_k[ly, lx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel[ly, lx]</span>
<span id="cb18-54"></span>
<span id="cb18-55">    barrier()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sync both shared buffers</span></span>
<span id="cb18-56"></span>
<span id="cb18-57">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4) compute 3√ó3 dot‚Äêproduct</span></span>
<span id="cb18-58">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> gx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> WIDTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> gy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> HEIGHT:</span>
<span id="cb18-59">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> local_sum: Float32 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb18-60">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span> </span>
<span id="cb18-61">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ky <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(K):</span>
<span id="cb18-62">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span> </span>
<span id="cb18-63">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> kx <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(K):</span>
<span id="cb18-64">                local_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared_img[ly <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ky, lx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> kx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> shared_k[ky, kx]</span>
<span id="cb18-65">        output[gy, gx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> local_sum</span></code></pre></div>
</div>
</details>
<p>After making a <a href="https://github.com/goodhamgupta/mojo-gpu-puzzles/commit/b7961ce0e5ea8753a866cbf671881ac1bdf4acd9">few changes</a> to the test harness, we get the following result:</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p11 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--conv-2d</span></span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([9.0, 9.0, 9.0, 9.0, 9.0,...,6.0, 3.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 4.0, 2.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 2.0, 1.0])</span></span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([9.0, 9.0, 9.0, 9.0, 9.0,..., 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 6.0, 4.0, 2.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 3.0, 2.0, 1.0])</span></span></code></pre></div>
<p>We‚Äôll dive into the shared memory tricks like parking partial results, handling 2-D thread and block indexing, and performing halo copies when we get to matrix multiply in <a href="@puzzle-14">Puzzle 14</a>.</p>
</section>
<section id="puzzle-12" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_12/puzzle_12.html">Puzzle 12: Prefix Sum</a></h1>
<p>The <strong>prefix sum</strong> (or <em>scan</em>) problem takes an input array <code>[a‚ÇÄ, a‚ÇÅ, ‚Ä¶, a‚Çô‚Çã‚ÇÅ]</code> and produces the running totals</p>
<pre class="text"><code>[a‚ÇÄ, (a‚ÇÄ ‚äï a‚ÇÅ), ‚Ä¶, (a‚ÇÄ ‚äï a‚ÇÅ ‚äï ‚Ä¶ ‚äï a‚Çô‚Çã‚ÇÅ)]</code></pre>
<p>It‚Äôs a foundational primitive in parallel computing-used for stream compaction, sorting, histograms, and more. At first glance, prefix sum looks inherently serial (each output depends on all previous inputs), but clever algorithms can parallelize it efficiently.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p12_prefix_scan.png" class="lightbox" data-glightbox="description: .lightbox-desc-13" data-gallery="quarto-lightbox-gallery-13" title="Prefix‚ÄêSum Illustration"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p12_prefix_scan.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Prefix‚ÄêSum Illustration"></a></p>
<figcaption>Prefix‚ÄêSum Illustration</figcaption>
</figure>
</div>

<section id="hillis-steele-algorithm" class="level2">
<h2 class="anchored" data-anchor-id="hillis-steele-algorithm">Hillis-Steele Algorithm</h2>
<p>A straightforward parallel scan is the <em>Hillis-Steele</em> approach: at each distance <code>d = 1, 2, 4, ‚Ä¶</code> every element adds in the value from <code>d</code> positions back. This is the same as the method shown in Puzzle 10</p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># inclusive scan, power-of-two length</span></span>
<span id="cb21-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> hillis_steele_scan(a, ‚äï):</span>
<span id="cb21-3">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(a)</span>
<span id="cb21-4">    temp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a.copy()</span>
<span id="cb21-5">    d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb21-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n:</span>
<span id="cb21-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb21-8">            temp[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> d <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> a[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> d] ‚äï a[i]</span>
<span id="cb21-9">        a, temp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> temp, a</span>
<span id="cb21-10">        d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb21-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a</span></code></pre></div>
<p>In Mojo, this looks as follows:</p>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p12_simple.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb22" data-filename="p12_simple.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb22-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> prefix_sum_simple[</span>
<span id="cb22-2">    layout: Layout</span>
<span id="cb22-3">](</span>
<span id="cb22-4">    output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb22-5">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb22-6">    size: Int,</span>
<span id="cb22-7">):</span>
<span id="cb22-8">    global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb22-9">    local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb22-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> idx <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(Int(log2(Scalar[dtype](TPB)))):</span>
<span id="cb22-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> offset <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE:</span>
<span id="cb22-12">            shared[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared[local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> offset]</span>
<span id="cb22-13"></span>
<span id="cb22-14">        barrier()</span>
<span id="cb22-15">        offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb22-16"></span>
<span id="cb22-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE:</span>
<span id="cb22-18">        output[global_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[local_i]</span></code></pre></div>
</div>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p12 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--simple</span></span>
<span id="cb23-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([0.0, 1.0, 3.0, 6.0, 10.0, 15.0, 21.0, 28.0])</span></span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([0.0, 1.0, 3.0, 6.0, 10.0, 15.0, 21.0, 28.0])</span></span></code></pre></div>
<p>Each of the log‚ÇÇ(n) rounds does up to n parallel additions (one per active element), so total work is <img src="https://latex.codecogs.com/png.latex?%5Csum_k%20n%20=%20nlog(n)">. Because rounds are serialized by barriers, the longest dependency chain is one add per round i.e <img src="https://latex.codecogs.com/png.latex?O(log%20n)">.</p>
</details></section>
<section id="blellochs-twopass-algorithm" class="level2">
<h2 class="anchored" data-anchor-id="blellochs-twopass-algorithm">Blelloch‚Äôs Two‚ÄêPass Algorithm</h2>
<p>Blelloch‚Äôs two-pass scan does Œò(n) work by splitting the job into an <strong>up-sweep</strong> (build a reduction tree) and a <strong>down-sweep</strong> (propagate prefixes) <span class="citation" data-cites="blelloch_prefix_sum">[11]</span>.</p>
<p>Why prefer it over the classic Hillis-Steele (Algorithm 1)?</p>
<ol type="1">
<li><p>Hardware constraints: Hillis-Steele assumes one processor per element and updates the array <em>in-place</em> every round. A real GPU doesn‚Äôt grant that luxury: a ‚Äú1024-thread‚Äù block actually runs in 32-thread warps that time-slice on the same SM. When warp 0 pauses and warp 1 resumes, in-place writes from one warp can overwrite data the other still needs.</p></li>
<li><p>Synchronisation cost: Avoiding the overwrite requires a barrier after <strong>every</strong> addition - log‚ÇÇ(n) rounds √ó n threads ‚áí Œò(n log n) operations plus all those barriers.</p></li>
</ol>
<p>Blelloch‚Äôs fix to these problems is to break the up-sweep and down-sweep into separate phases:</p>
<ul>
<li>Up-sweep and down-sweep touch disjoint tree levels, so threads never trample each other within a phase.</li>
<li>Only two global barriers are needed (one between the phases, one at the end).</li>
<li>Now you get Œò(n) work and correctness, even for arrays much bigger than a warp.</li>
</ul>
<p>The result is a scan that is both faster and safer on modern GPUs.</p>
<section id="up-sweep-reduce" class="level3">
<h3 class="anchored" data-anchor-id="up-sweep-reduce">Up-sweep (reduce)</h3>
<ul>
<li>Build a binary reduction tree over log‚ÇÇ(n) rounds:
<ul>
<li>Round 1 (step=1): sum each adjacent pair, storing results at indices 1, 3, 5, ‚Ä¶</li>
<li>Round 2 (step=2): merge those partial sums into blocks of 4, writing into indices 3, 7, 11, ‚Ä¶</li>
<li>Continue doubling the span each round until step = n/2</li>
</ul></li>
<li>After the final round, a[n-1] holds the overall total</li>
</ul>
<p><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p12_up.gif" class="img-fluid"> <em>Up-Sweep: combining elements in a binary-tree fashion-build partial sums until the final element holds the total.</em></p>
</section>
<section id="down-sweep-propagate" class="level3">
<h3 class="anchored" data-anchor-id="down-sweep-propagate">Down-sweep (propagate)</h3>
<p>After the up-sweep leaves <code>a[n-1]</code> containing the overall sum, we walk the tree top-down to scatter prefix sums into every slot:</p>
<ul>
<li>Initialize the down-sweep with a window size of <code>step = n/2</code>.<br>
</li>
<li>Loop as long as <code>step &gt;= 1</code>:
<ul>
<li>Partition the array into blocks of size <code>2*step</code>. For each block starting at index <code>i</code>:
<ul>
<li>Temporarily store the left-child total from <code>a[i + step - 1]</code>.<br>
</li>
<li>Overwrite that left slot with the right-child subtotal from <code>a[i + 2*step - 1]</code>.<br>
</li>
<li>Add the saved left-child total to the right slot, giving the correct prefix for that subtree.<br>
</li>
</ul></li>
<li>Issue a <code>barrier()</code> so all threads sync before shrinking the window.<br>
</li>
<li>Halve the window: <code>step = step / 2</code>.<br>
</li>
</ul></li>
<li>With each pass, the partial sums trickle down one level of the binary tree; after log‚ÇÇ(n) iterations every element holds its exclusive prefix sum.</li>
</ul>
<p><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p12_down.gif" class="img-fluid quarto-figure quarto-figure-center"><br>
<em>Down Sweep: siblings swap and accumulate, driving the scan from root back to leaves.</em></p>
<p>Total Operations: <img src="https://latex.codecogs.com/png.latex?%5CTheta(n)">, parallel depth: <img src="https://latex.codecogs.com/png.latex?%5CTheta(%5Clog_2%20n)">.</p>
<details open="">
<summary>
<strong>Solution (Blelloch up-sweep + down-sweep)</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p12_blelloch.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb24" data-filename="p12_blelloch.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb24-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> prefix_sum_blelloch[</span>
<span id="cb24-2">    layout: Layout</span>
<span id="cb24-3">](</span>
<span id="cb24-4">    output:   LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dtype, layout],</span>
<span id="cb24-5">    a:     LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb24-6">    size:  Int,</span>
<span id="cb24-7">):</span>
<span id="cb24-8">    global_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb24-9">    local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb24-10">    shared <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[SIZE]().shared().alloc()</span>
<span id="cb24-11"></span>
<span id="cb24-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb24-13">        shared[local_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[global_idx]</span>
<span id="cb24-14">    barrier()</span>
<span id="cb24-15"></span>
<span id="cb24-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Up-sweep</span></span>
<span id="cb24-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb24-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb24-19">        step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb24-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size):</span>
<span id="cb24-21">            shared[local_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared[local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> stride]</span>
<span id="cb24-22">        barrier()</span>
<span id="cb24-23">        stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> step</span>
<span id="cb24-24"></span>
<span id="cb24-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Down-sweep</span></span>
<span id="cb24-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb24-27">        shared[local_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb24-28">    barrier()</span>
<span id="cb24-29"></span>
<span id="cb24-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> half <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb24-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> half <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb24-32">        step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> half <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb24-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size):</span>
<span id="cb24-34">            t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> half]</span>
<span id="cb24-35">            shared[local_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> half] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[local_idx]</span>
<span id="cb24-36">            shared[local_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> t</span>
<span id="cb24-37">        barrier()</span>
<span id="cb24-38">        half <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> half <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb24-39"></span>
<span id="cb24-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb24-41">        output[global_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[local_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> a[global_idx]</span></code></pre></div>
</div>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p12 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--blelloch</span></span>
<span id="cb25-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([0.0, 1.0, 3.0, 6.0, 10.0, 15.0, 21.0, 28.0])</span></span>
<span id="cb25-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([0.0, 1.0, 3.0, 6.0, 10.0, 15.0, 21.0, 28.0])</span></span></code></pre></div>
</details>
<p>This is not the most efficient implementation, but I hope this provides some intuition about the algorithm!</p>
</section>
</section>
<section id="block-boundary-1" class="level2">
<h2 class="anchored" data-anchor-id="block-boundary-1">Block Boundary</h2>
<p>The key difference in this version is that now we have an input array that is larger than the size of a single block.</p>
<p>We split the global scan into two bite-sized passes:</p>
<section id="phase-1---local-scan" class="level3">
<h3 class="anchored" data-anchor-id="phase-1---local-scan">Phase 1 - Local Scan</h3>
<ol type="1">
<li><p>Each block copies its slice into shared memory.<br>
</p></li>
<li><p>Perform an in-block naive scan/Blelloch scan exactly as in the single-block case.<br>
</p></li>
<li><p>The last thread of the block stashes the block‚Äôs total <strong>after</strong> the scan into an auxiliary slot at the tail of <code>output</code>:</p>
<pre><code>#  |&lt;---  SIZE_2  ---&gt;|&lt;-- #blocks --&gt;|
#  [   prefix sums   ][ block totals ]</code></pre></li>
</ol>
</section>
<section id="phase-2---propagate-block-totals" class="level3">
<h3 class="anchored" data-anchor-id="phase-2---propagate-block-totals">Phase 2 - Propagate block totals</h3>
<ol type="1">
<li>Every thread grabs the aggregate from the <em>previous</em> block (<code>totals[block_id-1]</code>) and adds it to its own prefix.<br>
Now every element holds the inclusive scan over the <em>whole</em> array.</li>
</ol>
<p><a href="mojo_gpu_puzzles/p12_block_boundary.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p12_block_boundary.png" class="img-fluid"></a></p>
<p>We launch the above phases as two separate kernels.</p>
<p><strong>A host-side synchronisation sits between the launches</strong>. That call flushes the work queue and waits until Phase 1 has fully committed its writes to global memory, ensuring the per-block totals are complete and visible before Phase 2 starts consuming them. Skip the sync and the driver is free to overlap or reorder the kernels, letting Phase 2 read garbage.</p>
<details open="">
<summary>
<strong>Solution (Block Boundary Version)</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p12_block_boundary.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb27" data-filename="p12_block_boundary.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb27-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> prefix_sum_local_phase[</span>
<span id="cb27-2">    out_layout: Layout, in_layout: Layout</span>
<span id="cb27-3">](</span>
<span id="cb27-4">    output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, out_layout],</span>
<span id="cb27-5">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, in_layout],</span>
<span id="cb27-6">    size: Int,</span>
<span id="cb27-7">):</span>
<span id="cb27-8">    global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb27-9">    local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb27-10">    shared <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[EXTENDED_SIZE]().shared().alloc()</span>
<span id="cb27-11"></span>
<span id="cb27-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE_2:</span>
<span id="cb27-13">        shared[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[global_i]</span>
<span id="cb27-14">    </span>
<span id="cb27-15">    barrier()</span>
<span id="cb27-16">    offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb27-17"></span>
<span id="cb27-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> idx <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(Int(log2(Scalar[dtype](TPB)))):</span>
<span id="cb27-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> offset <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE_2:</span>
<span id="cb27-20">            shared[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared[local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> offset]</span>
<span id="cb27-21"></span>
<span id="cb27-22">        barrier()</span>
<span id="cb27-23">        offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb27-24"></span>
<span id="cb27-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE_2:</span>
<span id="cb27-26">        output[global_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[local_i]</span>
<span id="cb27-27">    </span>
<span id="cb27-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb27-29">        output[size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> block_idx.x] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared[local_i]</span>
<span id="cb27-30"></span>
<span id="cb27-31"></span>
<span id="cb27-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Kernel 2: Add block sums to their respective blocks</span></span>
<span id="cb27-33"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> prefix_sum_block_sum_phase[</span>
<span id="cb27-34">    layout: Layout</span>
<span id="cb27-35">](output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout], size: Int):</span>
<span id="cb27-36">    global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb27-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># FILL ME IN (roughly 3 lines)</span></span>
<span id="cb27-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb27-39">        prev_block_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> output[SIZE_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb27-40">        output[global_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> prev_block_sum</span></code></pre></div>
</div>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p12</span>
<span id="cb28-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([0.0, 1.0, 3.0, 6.0, 10.0, 15.0, 21.0, 28.0, 36.0, 45.0, 55.0, 66.0, 78.0, 91.0, 105.0, 28.0, 77.0]) # last 2 elements are the block sums</span></span>
<span id="cb28-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([0.0, 1.0, 3.0, 6.0, 10.0, 15.0, 21.0, 28.0, 36.0, 45.0, 55.0, 66.0, 78.0, 91.0, 105.0])</span></span></code></pre></div>
</details>
</section>
</section>
</section>
<section id="puzzle-13-axis-sum" class="level1">
<h1><a href="https://puzzles.modular.com/puzzle_13/puzzle_13.html" id="puzzle-13">Puzzle 13: Axis Sum</a></h1>
<p>Axis sum is the 2-D sibling of the dot‚Äêproduct/prefix puzzles: take a matrix <code>A</code> and collapse one dimension by summing over it.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Ctext%7Baxis%7D=0%20&amp;%5C;%5CLongrightarrow%5C;%0A%5Ctext%7Bcolumn-sum:%7D%5C;%5C;%0Aout%5Bj%5D%20&amp;%20=%20%5Csum_%7Bk%7D%20A_%7Bk,j%7D,%20%5Cqquad%20j%20=%200,%5Cdots,N-1%20%5C%5C%5B4pt%5D%0A%5Ctext%7Baxis%7D=1%20&amp;%5C;%5CLongrightarrow%5C;%0A%5Ctext%7Brow-sum:%7D%5C;%5C;%0Aout%5Bi%5D%20&amp;%20=%20%5Csum_%7Bk%7D%20A_%7Bi,k%7D,%20%5Cqquad%20i%20=%200,%5Cdots,M-1%0A%5Cend%7Baligned%7D%0A"></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p13_intro.png" class="lightbox" data-glightbox="description: .lightbox-desc-15" data-gallery="quarto-lightbox-gallery-15" title="Axis Sum"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p13_intro.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%" alt="Axis Sum"></a></p>
<figcaption>Axis Sum</figcaption>
</figure>
</div>
<p>Each row/column is an embarrassingly-parallel reduction, so the GPU kernel just assigns one warp (or block) per slice and performs a standard shared-memory reduction inside the slice.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p13_row_sum.png" class="lightbox" data-glightbox="description: .lightbox-desc-16" data-gallery="quarto-lightbox-gallery-16" title="Row Sum"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p13_row_sum.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Row Sum"></a></p>
<figcaption>Row Sum</figcaption>
</figure>
</div>
<details open="">
<summary>
Solution
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p13.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb29" data-filename="p13.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb29-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> axis_sum[</span>
<span id="cb29-2">    in_layout: Layout, out_layout: Layout</span>
<span id="cb29-3">](</span>
<span id="cb29-4">    output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, out_layout],</span>
<span id="cb29-5">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, in_layout],</span>
<span id="cb29-6">    size: Int,</span>
<span id="cb29-7">):</span>
<span id="cb29-8">    local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb29-9">    batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.y</span>
<span id="cb29-10">    shared <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB]().shared().alloc()</span>
<span id="cb29-11"></span>
<span id="cb29-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE:</span>
<span id="cb29-13">        shared[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[batch, local_i]</span>
<span id="cb29-14"></span>
<span id="cb29-15">    barrier()</span>
<span id="cb29-16"></span>
<span id="cb29-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb29-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb29-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> stride <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE:</span>
<span id="cb29-20">            shared[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared[local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stride]</span>
<span id="cb29-21">        barrier()</span>
<span id="cb29-22">        stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb29-23"></span>
<span id="cb29-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use first thread to write result</span></span>
<span id="cb29-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb29-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output shape is [batch_size, 1]</span></span>
<span id="cb29-27">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which we why we need the last dimension</span></span>
<span id="cb29-28">        output[batch, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
</div>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p13</span></code></pre></div>
</details>
<p>We can also perform column-sum(axis=0) with a trivial change:</p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode diff code-with-copy"><code class="sourceCode diff"><span id="cb31-1"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-    if local_i &lt; SIZE:</span></span>
<span id="cb31-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-        shared[local_i] = a[batch, local_i]</span></span>
<span id="cb31-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+    if local_i &lt; SIZE:</span></span>
<span id="cb31-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+        shared[local_i] = a[local_i, batch]</span></span></code></pre></div>
</section>
<section id="puzzle-14-matmul" class="level1">
<h1><a href="https://puzzles.modular.com/puzzle_14/puzzle_14.html" id="puzzle-14">Puzzle 14: Matmul</a></h1>
<p>Arguably the single most important operation in GPU computing, the humble General Matrix Multiplication (GEMM) operation is the computational workhorse behind literally all deep learning models-from simple linear layers to massive transformer architectures.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AC_%7Bi,j%7D%20=%20%5Csum_%7Bk=1%7D%5E%7BK%7D%20A_%7Bi,k%7D%20%5Ccdot%20B_%7Bk,j%7D%0A"></p>
<blockquote class="blockquote">
<p><strong>Requirement:</strong> For matrix multiplication <img src="https://latex.codecogs.com/png.latex?C%20=%20AB"> to be valid, the number of columns in <img src="https://latex.codecogs.com/png.latex?A"> must equal the number of rows in <img src="https://latex.codecogs.com/png.latex?B">.<br>
That is, if <img src="https://latex.codecogs.com/png.latex?A"> is shape <img src="https://latex.codecogs.com/png.latex?(M,%20K)"> and <img src="https://latex.codecogs.com/png.latex?B"> is shape <img src="https://latex.codecogs.com/png.latex?(K,%20N)">, then <img src="https://latex.codecogs.com/png.latex?C"> will be shape <img src="https://latex.codecogs.com/png.latex?(M,%20N)">.</p>
</blockquote>
<p>GEMM‚Äôs ubiquity stems from its perfect match with GPU architecture: thousands of independent multiply-add operations that can be parallelized across thousands of cores. Yet this apparent simplicity masks a deep optimization challenge. Memory bandwidth, cache hierarchies, and thread synchronization all conspire to make naive implementations crawl while hand-tuned libraries like cuBLAS achieve near-theoretical peak performance.</p>
<p>Matmul tuning is a rabbit hole - see Simon Boehm‚Äôs fantastic deep-dive <span class="citation" data-cites="siboehm_cuda_mmm">[12]</span> for how wild it gets.</p>
<p>For now, we‚Äôll focus on the core techniques demonstrated by the official puzzle-shared memory tiling and thread cooperation-to build intuition for how high-performance GEMM kernels actually work.</p>
<section id="global-memory-version" class="level2">
<h2 class="anchored" data-anchor-id="global-memory-version">Global Memory Version</h2>
<p>Based on the 2D indexing section, each thread computes one C[row, col] by loading A[row, k] and B[k, col] from global memory, multiplying and accumulating over k. We unroll the k‚Äêloop to cut loop overhead and boost throughput.</p>
<details open="">
<summary>
Solution
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p14_naive.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb32" data-filename="p14_naive.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb32-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> naive_matmul[</span>
<span id="cb32-2">    layout: Layout, size: Int</span>
<span id="cb32-3">](</span>
<span id="cb32-4">    output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb32-5">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb32-6">    b: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb32-7">):</span>
<span id="cb32-8">    row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.y</span>
<span id="cb32-9">    col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb32-10"></span>
<span id="cb32-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SIZE:</span>
<span id="cb32-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Need this to ensure the mojo compiler knows</span></span>
<span id="cb32-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the type of `running_sum`, otherwise it will</span></span>
<span id="cb32-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># complain</span></span>
<span id="cb32-15">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> running_sum: output.element_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb32-16"></span>
<span id="cb32-17">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span></span>
<span id="cb32-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(SIZE):</span>
<span id="cb32-19">            running_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> a[row, k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b[k, col]</span>
<span id="cb32-20">        output[row, col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> running_sum</span></code></pre></div>
</div>
<div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p14 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--naive</span></span>
<span id="cb33-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([4.0, 6.0, 12.0, 22.0])</span></span>
<span id="cb33-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([4.0, 6.0, 12.0, 22.0])</span></span></code></pre></div>
</details>
</section>
<section id="shared-memory-version" class="level2">
<h2 class="anchored" data-anchor-id="shared-memory-version">Shared Memory Version</h2>
<p>The previous version suffers from repeated global memory reads. We can optimize this using shared memory:</p>
<ul>
<li>Load matrix tiles once</li>
<li>Synchronize threads</li>
<li>Compute using the cached data.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p14_shared_mem.png" class="lightbox" data-glightbox="description: .lightbox-desc-17" data-gallery="quarto-lightbox-gallery-17" title="Matmul with shared memory"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p14_shared_mem.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Matmul with shared memory"></a></p>
<figcaption>Matmul with shared memory</figcaption>
</figure>
</div>
<details open="">
<summary>
Solution
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p14_shared.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb34" data-filename="p14_shared.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb34-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> single_block_matmul[</span>
<span id="cb34-2">    layout: Layout, size: Int</span>
<span id="cb34-3">](</span>
<span id="cb34-4">    output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb34-5">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb34-6">    b: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb34-7">):</span>
<span id="cb34-8">    row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.y</span>
<span id="cb34-9">    col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb34-10">    local_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.y</span>
<span id="cb34-11">    local_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb34-12">    shared_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB, TPB]().shared().alloc()</span>
<span id="cb34-13">    shared_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB, TPB]().shared().alloc()</span>
<span id="cb34-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> local_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> local_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb34-15">        shared_a[local_row, local_col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[row, col]</span>
<span id="cb34-16">        shared_b[local_row, local_col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b[row, col]</span>
<span id="cb34-17"></span>
<span id="cb34-18">    barrier()</span>
<span id="cb34-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> local_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> local_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb34-20">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> running_sum: output.element_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb34-21"></span>
<span id="cb34-22">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span></span>
<span id="cb34-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(size):</span>
<span id="cb34-24">            running_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> a[local_row, k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b[k, local_col]</span>
<span id="cb34-25"></span>
<span id="cb34-26">        output[row, col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> running_sum</span></code></pre></div>
</div>
<div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p14 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--naive</span></span>
<span id="cb35-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([4.0, 6.0, 12.0, 22.0])</span></span>
<span id="cb35-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([4.0, 6.0, 12.0, 22.0])</span></span></code></pre></div>
<p>The Roofline Model offers a first-order answer to a GPU performance question: is my kernel limited by arithmetic throughput or by memory bandwidth?<br>
It does so by plotting operational intensity (FLOPs per byte) against two ceilings - the hardware‚Äôs peak FLOP/s and peak DRAM bandwidth‚Äîso you can see at a glance which resource is the bottleneck.</p>
</details></section>
<section id="roofline-model" class="level2">
<h2 class="anchored" data-anchor-id="roofline-model"><a href="https://builds.modular.com/puzzles/puzzle_14/roofline.html">Roofline Model</a></h2>
<blockquote class="blockquote">
<p>Note: The Modular GPU Puzzles <a href="https://builds.modular.com/puzzles/puzzle_14/roofline.html">guide</a> already walks through the full roofline derivation, but we‚Äôll repeat it here so that you can follow along without leaving this post.</p>
</blockquote>
<p>The first step is abstracting the hardware-software complexity into a tractable model.</p>
<section id="hardware-model" class="level3">
<h3 class="anchored" data-anchor-id="hardware-model">Hardware Model</h3>
<p>Classic roofline assumes ideal hardware with perfect overlap:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p14_hardware.png" class="lightbox" data-glightbox="description: .lightbox-desc-18" data-gallery="quarto-lightbox-gallery-18" title="Source: NHR at FAU[@nhrfau_roofline_model]"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p14_hardware.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:40.0%" alt="Source: NHR at FAU[13]"></a></p>
<figcaption>Source: NHR at FAU<span class="citation" data-cites="nhrfau_roofline_model">[13]</span></figcaption>
</figure>
</div>
<p>The cartoon GPU has only two levers:</p>
<ul>
<li><strong>Compute engine</strong> ‚Äî peak rate <img src="https://latex.codecogs.com/png.latex?P_%7Bpeak%7D"> (FLOP/s, integer ops/s, etc.)</li>
<li><strong>Memory datapath</strong> ‚Äî peak bandwidth <img src="https://latex.codecogs.com/png.latex?b_s"> (bytes/s)</li>
</ul>
</section>
<section id="software-model" class="level3">
<h3 class="anchored" data-anchor-id="software-model">Software Model</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p14_software.png" class="lightbox" data-glightbox="description: .lightbox-desc-19" data-gallery="quarto-lightbox-gallery-19" title="Software abstraction: complex GPU kernel simplified to steady-state loop with N flops and V bytes per iteration. Credits: NHR at FAU[@nhrfau_roofline_model]"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p14_software.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%" alt="Software abstraction: complex GPU kernel simplified to steady-state loop with N flops and V bytes per iteration. Credits: NHR at FAU[13]"></a></p>
<figcaption>Software abstraction: complex GPU kernel simplified to steady-state loop with N flops and V bytes per iteration. Credits: NHR at FAU<span class="citation" data-cites="nhrfau_roofline_model">[13]</span></figcaption>
</figure>
</div>
<p>We collapse the kernel‚Äôs steady-state loop to:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?N"> floating-point operations per iteration</li>
<li><img src="https://latex.codecogs.com/png.latex?V"> bytes moved per iteration</li>
</ul>
<p>The <strong>operational intensity</strong> is defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?I%20=%20%5Cfrac%7BN%7D%7BV%7D%20%5Ctext%7B%20flop/byte%7D"></p>
<p>This ratio is all that survives of the algorithm - prologue/epilogue work, control flow, and synchronizations are swept aside.</p>
<p><strong>Hardware Assumptions:</strong></p>
<table class="table">
<colgroup>
<col style="width: 5%">
<col style="width: 22%">
<col style="width: 29%">
<col style="width: 16%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>#</th>
<th>Assumption</th>
<th>Works because‚Ä¶</th>
<th>Reality</th>
<th>Breaks when‚Ä¶</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>H1</td>
<td>Peak DRAM bandwidth is reachable</td>
<td>Ideal streaming</td>
<td>Requires 100% streaming, &gt;1MB tiles</td>
<td>Strided or tiny tiles</td>
</tr>
<tr class="even">
<td>H2</td>
<td>Peak FLOP/s reachable</td>
<td>Full FMA rate</td>
<td>All ALUs busy every cycle</td>
<td>Divergence, low occupancy</td>
</tr>
<tr class="odd">
<td>H3</td>
<td>One bandwidth number is enough</td>
<td>DRAM dominates</td>
<td>L1/L2/SMEM add separate roofs</td>
<td>Lower-level choke points</td>
</tr>
</tbody>
</table>
<p><strong>Software Assumptions:</strong></p>
<table class="table">
<colgroup>
<col style="width: 5%">
<col style="width: 22%">
<col style="width: 29%">
<col style="width: 16%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>#</th>
<th>Assumption</th>
<th>Works because‚Ä¶</th>
<th>Reality</th>
<th>Breaks when‚Ä¶</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>S1</td>
<td>Loads fully hide latency</td>
<td>1000s inflight warps</td>
<td>Requires deep pipelining</td>
<td>Short kernels, frequent syncs</td>
</tr>
<tr class="even">
<td>S2</td>
<td>Single operational intensity</td>
<td>Steady-state loop</td>
<td>Real kernels mix phases</td>
<td>Gather/scatter, epilogue code</td>
</tr>
<tr class="odd">
<td>S3</td>
<td>Launch/transfer overhead small</td>
<td>Long kernel runs</td>
<td>Amortised over many iterations</td>
<td>Micro-benchmarks, chaining</td>
</tr>
</tbody>
</table>
</section>
<section id="naive-roofline-model" class="level3">
<h3 class="anchored" data-anchor-id="naive-roofline-model">Naive Roofline Model</h3>
<p>With these assumptions, hardware and software collapse to one parameter‚Äîthe operational intensity <img src="https://latex.codecogs.com/png.latex?I">‚Äîand attainable performance becomes</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AP(I)%20&amp;=%20%5Cmin%5C!%5Cbigl(P_%7B%5Ctext%7Bpeak%7D%7D,%5C,%20I%5C,b_s%5Cbigr)%20%5C%5C%0AI_%7B%5Ctext%7Bcrit%7D%7D%20&amp;=%20%5Cfrac%7BP_%7B%5Ctext%7Bpeak%7D%7D%7D%7Bb_s%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>At the critical intensity <img src="https://latex.codecogs.com/png.latex?I_%7Bcrit%7D">, the bandwidth and compute roofs intersect, splitting kernels into two classes:</p>
<ul>
<li><strong>Memory-bound</strong> (<img src="https://latex.codecogs.com/png.latex?I%20%3C%20I_%7Bcrit%7D">) -&gt; Performance rises linearly with <img src="https://latex.codecogs.com/png.latex?I"></li>
<li><strong>Compute-bound</strong> (<img src="https://latex.codecogs.com/png.latex?I%20%5Cgeq%20I_%7Bcrit%7D">) -&gt; Performance plateaus at <img src="https://latex.codecogs.com/png.latex?P_%7Bpeak%7D"></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p14_roofline.png" class="lightbox" data-glightbox="description: .lightbox-desc-20" data-gallery="quarto-lightbox-gallery-20" title="Roofline model: sloped red line shows memory bandwidth limit, flat blue line is compute peak, kernel‚Äôs operational intensity marked as a dot."><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p14_roofline.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%" alt="Roofline model: sloped red line shows memory bandwidth limit, flat blue line is compute peak, kernel‚Äôs operational intensity marked as a dot."></a></p>
<figcaption>Roofline model: sloped red line shows memory bandwidth limit, flat blue line is compute peak, kernel‚Äôs operational intensity marked as a dot.</figcaption>
</figure>
</div>
</section>
<section id="where-the-roofline-model-fails" class="level3">
<h3 class="anchored" data-anchor-id="where-the-roofline-model-fails">Where the Roofline Model Fails</h3>
<p>Even in small puzzle kernels, these assumptions falter. In real workloads, they break down completely.</p>
<p>What actually works:</p>
<ol type="1">
<li><strong>Measure real limits</strong> with tools like Nsight or rocprof</li>
<li><strong>Redraw the roofline</strong> using measured ceilings‚ÄîL2 roof, Tensor-core roof, not just DRAM and peak FLOPs</li>
<li><strong>Adjust your kernel</strong>: boost <img src="https://latex.codecogs.com/png.latex?I"> (tiling, shared memory, tensor ops) or raise the ceilings (improve occupancy, reduce stalls)</li>
</ol>
<blockquote class="blockquote">
<p>Unfortunately no Nsight eye-candy as of yet - my <code>ncu</code> setup hit a <a href="https://developer.nvidia.com/nvidia-development-tools-solutions-err_nvgpuctrperm-permission-issue-ters">permissions wall</a>. I‚Äôll fix it and share a profiler deep-dive soon. Stay tuned!</p>
</blockquote>
<p>The textbook roofline is a guide, not reality. Measure, adapt, and push your kernel as close to the real limits as you can.</p>
</section>
</section>
<section id="roofline-estimation" class="level2">
<h2 class="anchored" data-anchor-id="roofline-estimation">Roofline Estimation</h2>
<p>Let‚Äôs apply the roofline model to a 3√ó3 matrix multiplication, which is still small enough to hand-calculate.</p>
<p>The RTX 4000 Ada provides<span class="citation" data-cites="rtx_ada_specs">[14]</span>:</p>
<ul>
<li><strong>Peak compute</strong>: 26.7 TFLOPS (single-precision)<br>
</li>
<li><strong>Peak DRAM bandwidth</strong>: 360 GB/s<br>
</li>
<li><strong>Critical intensity</strong>: <img src="https://latex.codecogs.com/png.latex?I_%7Bcrit%7D%20=%20%5Cfrac%7B26.7%20%5Ctimes%2010%5E%7B12%7D%7D%7B360%20%5Ctimes%2010%5E9%7D%20=%2074.2"> FLOP/byte</li>
</ul>
<section id="naive-matmul-analysis" class="level3">
<h3 class="anchored" data-anchor-id="naive-matmul-analysis">Naive MatMul Analysis</h3>
<p>For <img src="https://latex.codecogs.com/png.latex?C%20=%20A%20%5Ctimes%20B"> where all matrices are 3√ó3:</p>
<section id="compute-work" class="level4">
<h4 class="anchored" data-anchor-id="compute-work">Compute work</h4>
<ul>
<li>Each output element is a dot product of length 3</li>
<li>3 fused multiply-adds -&gt; 3 FLOPs per output element</li>
<li>9 elements -&gt; 27 FLOPs total</li>
</ul>
</section>
<section id="dram-traffic" class="level4">
<h4 class="anchored" data-anchor-id="dram-traffic">DRAM traffic</h4>
<ul>
<li>Load matrix A: 9 floats √ó 4 bytes = 36 bytes</li>
<li>Load matrix B: 9 floats √ó 4 bytes = 36 bytes<br>
</li>
<li>Store matrix C: 9 floats √ó 4 bytes = 36 bytes</li>
<li>Total: <strong>108 bytes</strong></li>
</ul>
</section>
<section id="operational-intensity" class="level4">
<h4 class="anchored" data-anchor-id="operational-intensity">Operational intensity:</h4>
<p><img src="https://latex.codecogs.com/png.latex?I_%7Bnaive%7D%20=%20%5Cfrac%7B27%20%5Ctext%7B%20FLOPs%7D%7D%7B108%20%5Ctext%7B%20bytes%7D%7D%20=%200.25%20%5Ctext%7B%20FLOP/byte%7D"></p>
<p>Since <img src="https://latex.codecogs.com/png.latex?I_%7Bnaive%7D%20=%200.25%20%5Cll%20I_%7Bcrit%7D%20=%2074.2">, this kernel is <strong>memory-bound</strong>.</p>
</section>
<section id="predicted-performance" class="level4">
<h4 class="anchored" data-anchor-id="predicted-performance">Predicted performance</h4>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AP_%7Bnaive%7D%20%5C;%5C;%20&amp;%20=%20%5Cmin(26.7~%5Ctext%7BTFLOPS%7D,%5C;%200.25%20%5Ctimes%20360~%5Ctext%7BGB/s%7D)%20%5C%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20&amp;%20=%20%5Cmin(26.7~%5Ctext%7BTFLOPS%7D,%5C;%2090~%5Ctext%7BGFLOPS%7D)%20%5C%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20&amp;%20=%20%5Cboxed%7B90~%5Ctext%7BGFLOPS%7D%7D%0A%5Cend%7Baligned%7D%0A"></p>
</section>
</section>
<section id="shared-memory-optimization" class="level3">
<h3 class="anchored" data-anchor-id="shared-memory-optimization">Shared Memory Optimization</h3>
<p>By staging 3√ó3 tiles of A and B in shared memory, each element feeds all three required dot products instead of being fetched repeatedly from DRAM.</p>
<section id="improved-traffic-pattern" class="level4">
<h4 class="anchored" data-anchor-id="improved-traffic-pattern">Improved traffic pattern</h4>
<ul>
<li>DRAM loads for A and B drop by ~3√ó</li>
<li>Stores remain unchanged (36 bytes)</li>
<li>Approximate traffic: <img src="https://latex.codecogs.com/png.latex?(36+36)/3%20+%2036%20=%2060"> bytes</li>
</ul>
</section>
<section id="new-operational-intensity" class="level4">
<h4 class="anchored" data-anchor-id="new-operational-intensity">New operational intensity</h4>
<p><img src="https://latex.codecogs.com/png.latex?I_%7Bshared%7D%20=%20%5Cfrac%7B27%20%5Ctext%7B%20FLOPs%7D%7D%7B60%20%5Ctext%7B%20bytes%7D%7D%20=%200.45%20%5Ctext%7B%20FLOP/byte%7D"></p>
</section>
<section id="predicted-performance-1" class="level4">
<h4 class="anchored" data-anchor-id="predicted-performance-1">Predicted performance</h4>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AP_%7Bshared%7D%20%5C;%5C;%20&amp;%20=%20%5Cmin(26.7~%5Ctext%7BTFLOPS%7D,%5C;%200.45%20%5Ctimes%20360~%5Ctext%7BGB/s%7D)%20%5C%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20&amp;%20=%20%5Cmin(26.7~%5Ctext%7BTFLOPS%7D,%5C;%20162~%5Ctext%7BGFLOPS%7D)%20%5C%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20&amp;%20=%20%5Cboxed%7B162~%5Ctext%7BGFLOPS%7D%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>This gives us a <strong>1.8√ó speedup</strong> from shared memory optimization, but we‚Äôre still memory-bound.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p14_roofline_naive_and_shared.png" class="lightbox" data-glightbox="description: .lightbox-desc-21" data-gallery="quarto-lightbox-gallery-21" title="RTX 4000 Ada Roofline for Matmul"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p14_roofline_naive_and_shared.png" class="img-fluid figure-img" alt="RTX 4000 Ada Roofline for Matmul"></a></p>
<figcaption>RTX 4000 Ada Roofline for Matmul</figcaption>
</figure>
</div>
<details closed="">
<summary>
<strong>Plot Code</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>roofline_plot.py</strong></pre>
</div>
<div class="sourceCode" id="cb36" data-filename="roofline_plot.py" style="background: #f1f3f5;"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># /// script</span></span>
<span id="cb36-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dependencies = [</span></span>
<span id="cb36-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   "matplotlib",</span></span>
<span id="cb36-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   "numpy",</span></span>
<span id="cb36-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ]</span></span>
<span id="cb36-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ///</span></span>
<span id="cb36-7"></span>
<span id="cb36-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run using uv run roofline_plot.py</span></span>
<span id="cb36-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb36-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb36-11"></span>
<span id="cb36-12">peak_compute <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">26.7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to GFLOPS</span></span>
<span id="cb36-13">peak_bandwidth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">360</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># GB/s</span></span>
<span id="cb36-14">critical_intensity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> peak_compute <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> peak_bandwidth</span>
<span id="cb36-15"></span>
<span id="cb36-16">kernels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb36-17">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Naive 3√ó3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intensity"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"performance"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"color"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#f39c12"</span>},</span>
<span id="cb36-18">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Shared 3√ó3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intensity"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.45</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"performance"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">162</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"color"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#27ae60"</span>}</span>
<span id="cb36-19">]</span>
<span id="cb36-20"></span>
<span id="cb36-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> generate_roofline_data():</span>
<span id="cb36-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Memory-bound region</span></span>
<span id="cb36-23">    memory_intensities <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, critical_intensity, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb36-24">    memory_performance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> memory_intensities <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> peak_bandwidth</span>
<span id="cb36-25"></span>
<span id="cb36-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute-bound region</span></span>
<span id="cb36-27">    compute_intensities <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(critical_intensity, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb36-28">    compute_performance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.full_like(compute_intensities, peak_compute)</span>
<span id="cb36-29"></span>
<span id="cb36-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> memory_intensities, memory_performance, compute_intensities, compute_performance</span>
<span id="cb36-31"></span>
<span id="cb36-32">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.5</span>))</span>
<span id="cb36-33"></span>
<span id="cb36-34">ax.set_xscale(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log'</span>, base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb36-35">ax.set_yscale(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log'</span>, base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb36-36"></span>
<span id="cb36-37">mem_i, mem_p, comp_i, comp_p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_roofline_data()</span>
<span id="cb36-38"></span>
<span id="cb36-39">ax.loglog(mem_i, mem_p, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#e74c3c"</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Memory-bound"</span>)</span>
<span id="cb36-40">ax.loglog(comp_i, comp_p, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#3498db"</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Compute-bound"</span>)</span>
<span id="cb36-41"></span>
<span id="cb36-42">ax.axhline(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>peak_compute, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#3498db"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb36-43">ax.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>critical_intensity, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#999"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb36-44"></span>
<span id="cb36-45"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> kernel <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> kernels:</span>
<span id="cb36-46">    ax.loglog(kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intensity"</span>], kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"performance"</span>],</span>
<span id="cb36-47">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"color"</span>], markersize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,</span>
<span id="cb36-48">             markeredgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#333"</span>, markeredgewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb36-49"></span>
<span id="cb36-50">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add kernel labels with better positioning to avoid overlap</span></span>
<span id="cb36-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Naive 3√ó3"</span>:</span>
<span id="cb36-52">        offset_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intensity"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Move left</span></span>
<span id="cb36-53">        offset_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"performance"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.65</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Move down</span></span>
<span id="cb36-54">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shared 3√ó3</span></span>
<span id="cb36-55">        offset_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intensity"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Move right</span></span>
<span id="cb36-56">        offset_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"performance"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.3</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Move up</span></span>
<span id="cb36-57"></span>
<span id="cb36-58">    ax.annotate(kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>],</span>
<span id="cb36-59">               (kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intensity"</span>], kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"performance"</span>]),</span>
<span id="cb36-60">               xytext<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(offset_x, offset_y),</span>
<span id="cb36-61">               fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, fontweight<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>,</span>
<span id="cb36-62">               bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(boxstyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"round,pad=0.3"</span>, facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>))</span>
<span id="cb36-63"></span>
<span id="cb36-64">ax.text(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, peak_bandwidth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Memory-bound"</span>,</span>
<span id="cb36-65">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#e74c3c"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, fontweight<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb36-66">ax.text(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, peak_compute <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Compute-bound"</span>,</span>
<span id="cb36-67">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#3498db"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, fontweight<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb36-68"></span>
<span id="cb36-69">ax.text(critical_intensity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.3</span>, peak_compute <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>,</span>
<span id="cb36-70">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"I_crit = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>critical_intensity<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb36-71">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#f39c12"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, fontweight<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>)</span>
<span id="cb36-72"></span>
<span id="cb36-73">ax.set_xlim(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb36-74">ax.set_ylim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30000</span>)</span>
<span id="cb36-75">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Operational Intensity (FLOP/byte) - Log_10 Scale"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb36-76">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Performance (GFLOP/s) - Log_10 Scale"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb36-77">ax.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb36-78"></span>
<span id="cb36-79">legend_elements <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [plt.Line2D([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], marker<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w'</span>,</span>
<span id="cb36-80">                             markerfacecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>k[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"color"</span>], markersize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,</span>
<span id="cb36-81">                             label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>k[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>], markeredgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#333"</span>)</span>
<span id="cb36-82">                  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> kernels]</span>
<span id="cb36-83">ax.legend(handles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>legend_elements, loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lower right"</span>)</span>
<span id="cb36-84"></span>
<span id="cb36-85">plt.tight_layout()</span>
<span id="cb36-86">plt.savefig(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./mojo_gpu_puzzles/p14_roofline_naive_and_shared.png'</span>, bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>)</span>
<span id="cb36-87"></span>
<span id="cb36-88"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Performance Analysis:"</span>)</span>
<span id="cb36-89"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span>
<span id="cb36-90"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> kernel <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> kernels:</span>
<span id="cb36-91">    efficiency <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"performance"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> peak_compute) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb36-92">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:"</span>)</span>
<span id="cb36-93">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Intensity: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'intensity'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> FLOP/byte"</span>)</span>
<span id="cb36-94">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Performance: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>kernel[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'performance'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> GFLOP/s"</span>)</span>
<span id="cb36-95">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Efficiency: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>efficiency<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% of peak"</span>)</span></code></pre></div>
</div>
</details>
</section>
</section>
<section id="key-insights" class="level3">
<h3 class="anchored" data-anchor-id="key-insights">Key Insights</h3>
<ul>
<li><strong>Intensity grows with matrix size</strong> - For naive <img src="https://latex.codecogs.com/png.latex?N%20%5Ctimes%20N"> GEMM: <img src="https://latex.codecogs.com/png.latex?I%20=%20%5Cfrac%7BN%5E3%7D%7B4N%5E2%7D%20=%20%5Cfrac%7BN%7D%7B4%7D"> FLOP/byte</li>
<li><strong>Small kernels are bandwidth-bound</strong> - Even perfect caching can‚Äôt reach the 74 FLOP/byte crossover until <img src="https://latex.codecogs.com/png.latex?N%20%5Capprox%20300"></li>
<li><strong>Shared memory helps, but only up to the ridge</strong> - Further speedups require compute-side tuning (tensor cores, ILP, etc.)</li>
</ul>
<p>Next, we‚Äôll look at one specific optimisation for Matmul: Tile-based GEMM!</p>
</section>
</section>
<section id="tiled-matrix-multiplication-gemm" class="level2">
<h2 class="anchored" data-anchor-id="tiled-matrix-multiplication-gemm">Tiled Matrix-Multiplication (GEMM)</h2>
<p>Our <em>shared-memory</em> kernel already cut global-DRAM traffic by loading each <code>A[i,k]</code> / <code>B[k,j]</code> element once per thread <em>row/column</em> instead of once per <em>output multiply</em>.<br>
For large matrices, however, even that version still:</p>
<ul>
<li>Brings the <em>entire</em> row of <code>A</code> and column of <code>B</code> into shared SRAM, quickly exhausting the 48‚Äì112 KiB available per SM.</li>
<li>Leaves many threads idle while others finish their portion of the dot-product.</li>
<li>Misses an opportunity to keep a hot, register-resident accumulator and hide global-latency behind computation.</li>
</ul>
<p>Enter <strong>tiling / blocking</strong> ‚Äî the canonical GPU GEMM strategy.</p>
<section id="tile" class="level3">
<h3 class="anchored" data-anchor-id="tile">Tile?</h3>
<p>Think of an <code>N√óN</code> matmul as a chessboard. Instead of letting every thread wander across the whole board, we slice it into <code>T√óT</code> sub-squares (<strong>tiles</strong>).</p>
<p>A <em>thread-block</em> is assigned one output tile, and:</p>
<ul>
<li>Cooperatively loads the matching <code>T√óT</code> <em>A-tile</em> and <em>B-tile</em> from global DRAM to <em>shared memory</em> (two coalesced 2-D memcpy‚Äôs).</li>
<li>Performs <code>T</code> fused-multiply-add sweeps of that data, each thread keeping its running sum in a <em>register</em>.</li>
<li>Barriers, slides the tile window by <code>T</code> along the inner-<code>k</code> dimension, and repeats until the dot-product is complete.</li>
<li>Finally writes the <code>T√óT</code> block of <code>C</code> back to DRAM.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p14_tiled_matmul.gif" class="lightbox" data-glightbox="description: .lightbox-desc-22" data-gallery="quarto-lightbox-gallery-22" title="Matmul Operation for a 4x4 Matrix, computing the first 4 output elements. Credits: Simon Oz"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p14_tiled_matmul.gif" class="img-fluid figure-img" alt="Matmul Operation for a 4x4 Matrix, computing the first 4 output elements. Credits: Simon Oz"></a></p>
<figcaption>Matmul Operation for a 4x4 Matrix, computing the first 4 output elements. Credits: <a href="https://www.youtube.com/watch?v=ccHyFnEZt7M&amp;ab_channel=SimonOz">Simon Oz</a></figcaption>
</figure>
</div>
<p>Each element of <code>A</code>/<code>B</code> is now read <em>once per tile</em> - independent of <code>N</code>, and re-used <code>T</code> times, boosting arithmetic intensity from <code>O(1)</code> to <code>O(T)</code> FLOP/B.</p>
</section>
<section id="memory-mapping-for-tiled-gemm" class="level3">
<h3 class="anchored" data-anchor-id="memory-mapping-for-tiled-gemm">Memory mapping for tiled GEMM</h3>
<p>The memory hierachy(discussed <a href="../posts/2025-07-06-gpu-puzzles-p1.html#gpu-memory">in the previous post</a>), is utilised as follows:</p>
<ul>
<li><strong>Registers</strong>: per-thread accumulators that hold partial <code>C</code> values across all tile iterations</li>
<li><strong>Shared SRAM</strong>: the current <code>A_tile</code> and <code>B_tile</code>, cooperatively loaded once and reused T times<br>
</li>
<li><strong>Global HBM</strong>: original A, B matrices and final C; each element touched once per tile load/store</li>
</ul>
</section>
<section id="raw-memory-1" class="level3">
<h3 class="anchored" data-anchor-id="raw-memory-1">Raw Memory</h3>
<details open="">
<summary>
<strong>Manual Indexing Tiled Matmul</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p14_matmul_tiled_manual.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb37" data-filename="p14_matmul_tiled_manual.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-overflow-wrap code-with-copy"><code class="sourceCode mojo"><span id="cb37-1"></span>
<span id="cb37-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE_TILED <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Size of the matrix we are multiplying, NOT the size of a tile</span></span>
<span id="cb37-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID_TILED <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># each block convers 3x3 elements</span></span>
<span id="cb37-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK_TILED <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (TPB, TPB)</span>
<span id="cb37-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> layout_tiled <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(SIZE_TILED, SIZE_TILED)</span>
<span id="cb37-6"></span>
<span id="cb37-7"></span>
<span id="cb37-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> matmul_tiled[</span>
<span id="cb37-9">    layout: Layout, size: Int</span>
<span id="cb37-10">](</span>
<span id="cb37-11">    output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb37-12">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb37-13">    b: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb37-14">):</span>
<span id="cb37-15">    local_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.y</span>
<span id="cb37-16">    local_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb37-17">    global_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> local_row</span>
<span id="cb37-18">    global_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> local_col</span>
<span id="cb37-19"></span>
<span id="cb37-20">    shared_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB, TPB]().shared().alloc()</span>
<span id="cb37-21">    shared_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB, TPB]().shared().alloc()</span>
<span id="cb37-22"></span>
<span id="cb37-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> local_sum: output.element_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb37-24"></span>
<span id="cb37-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span></span>
<span id="cb37-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (size + TPB - 1) // TPB == ceil(size / TPB) -&gt; number of tile-steps we need</span></span>
<span id="cb37-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tile <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>((size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> TPB):</span>
<span id="cb37-28">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load elements of A into shared mem</span></span>
<span id="cb37-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> local_col) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb37-30">            shared_a[local_row, local_col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[</span>
<span id="cb37-31">                global_row, tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> local_col</span>
<span id="cb37-32">            ]</span>
<span id="cb37-33"></span>
<span id="cb37-34">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load elements of B into shared mem</span></span>
<span id="cb37-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> local_row) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb37-36">            shared_b[local_row, local_col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b[</span>
<span id="cb37-37">                tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> local_row, global_col</span>
<span id="cb37-38">            ]</span>
<span id="cb37-39"></span>
<span id="cb37-40">        barrier()</span>
<span id="cb37-41"></span>
<span id="cb37-42">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform matmul</span></span>
<span id="cb37-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> global_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb37-44"></span>
<span id="cb37-45">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span></span>
<span id="cb37-46">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(TPB, size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TPB)):</span>
<span id="cb37-47">                local_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> shared_a[local_row, k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> shared_b[k, local_col]</span>
<span id="cb37-48"></span>
<span id="cb37-49">            barrier()</span>
<span id="cb37-50"></span>
<span id="cb37-51">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> global_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb37-52">            output[global_row, global_col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> local_sum</span></code></pre></div>
</div>
<div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p14 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--tiled</span></span>
<span id="cb38-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([2240.0, 2296.0, 2352.0, 2408.0, 2464.0, 2520.0, 2576.0, 2632.0, 5824.0, 6008.0, 6192.0, 6376.0, 6560.0, 6744.0, 6928.0, 7112.0, 9408.0, 9720.0, 10032.0, 10344.0, 10656.0, 10968.0, 11280.0, 11592.0, 12992.0, 13432.0, 13872.0, 14312.0, 14752.0, 15192.0, 15632.0, 16072.0, 16576.0, 17144.0, 17712.0, 18280.0, 18848.0, 19416.0, 19984.0, 20552.0, 20160.0, 20856.0, 21552.0, 22248.0, 22944.0, 23640.0, 24336.0, 25032.0, 23744.0, 24568.0, 25392.0, 26216.0, 27040.0, 27864.0, 28688.0, 29512.0, 27328.0, 28280.0, 29232.0, 30184.0, 31136.0, 32088.0, 33040.0, 33992.0])</span></span>
<span id="cb38-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([2240.0, 2296.0, 2352.0, 2408.0, 2464.0, 2520.0, 2576.0, 2632.0, 5824.0, 6008.0, 6192.0, 6376.0, 6560.0, 6744.0, 6928.0, 7112.0, 9408.0, 9720.0, 10032.0, 10344.0, 10656.0, 10968.0, 11280.0, 11592.0, 12992.0, 13432.0, 13872.0, 14312.0, 14752.0, 15192.0, 15632.0, 16072.0, 16576.0, 17144.0, 17712.0, 18280.0, 18848.0, 19416.0, 19984.0, 20552.0, 20160.0, 20856.0, 21552.0, 22248.0, 22944.0, 23640.0, 24336.0, 25032.0, 23744.0, 24568.0, 25392.0, 26216.0, 27040.0, 27864.0, 28688.0, 29512.0, 27328.0, 28280.0, 29232.0, 30184.0, 31136.0, 32088.0, 33040.0, 33992.0])</span></span></code></pre></div>
</details>
<p>The new formulas in the tiling implementation deserve explanation. Let‚Äôs break them down into key concepts:</p>
<section id="how-many-tiles-are-needed" class="level4">
<h4 class="anchored" data-anchor-id="how-many-tiles-are-needed">How many Tiles are needed?</h4>
<p>This is the expression: <code>range((size + TPB - 1) // TPB)</code></p>
<p>The key idea here is: Step through k by TPB each time; if there‚Äôs a leftover chunk, do one last tile for it.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p14_tile.png" class="lightbox" data-glightbox="description: .lightbox-desc-23" data-gallery="quarto-lightbox-gallery-23" title="Mapping of elements to tiles when size=17 and TPB=8"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p14_tile.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Mapping of elements to tiles when size=17 and TPB=8"></a></p>
<figcaption>Mapping of elements to tiles when size=17 and TPB=8</figcaption>
</figure>
</div>
<p>The above example needs 3 tiles. Ceiling division captures this with a simple formula: <img src="https://latex.codecogs.com/png.latex?%0A%5Clceil%5Cfrac%7Bsize%7D%7BTPB%7D%5Crceil%20=%20%5Clfloor%5Cfrac%7Bsize%20+%20TPB%20-%201%7D%7BTPB%7D%5Crfloor%0A"></p>
</section>
<section id="which-element-does-a-thread-fetch-in-this-tile" class="level4">
<h4 class="anchored" data-anchor-id="which-element-does-a-thread-fetch-in-this-tile">Which element does a thread fetch in this tile?</h4>
<p>Each thread snags two scalars‚Äîone from A, one from B.</p>
<p><code>tile</code> is simply ‚Äúwhich chunk of k are we on?‚Äù</p>
<p>Inside a block, a thread owns a single output cell <code>C[global_row, global_col]</code>. To finish that cell it must walk k, multiplying aligned pairs (A[row, k], B[k, col]).</p>
<p>On tile <code>t</code> the fetches are</p>
<pre><code>A = a[global_row, t*TPB + local_col]
B = b[t*TPB + local_row, global_col]</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p14_tiled_matmul_annotated.png" class="lightbox" data-glightbox="description: .lightbox-desc-24" data-gallery="quarto-lightbox-gallery-24" title="Tiled 9√ó9 matmul: Each thread loads 3x3 A and 3x3 B elements per tile, computes a partial sum, then syncs. Tile size = 3√ó3, 9 threads per block."><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p14_tiled_matmul_annotated.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Tiled 9√ó9 matmul: Each thread loads 3x3 A and 3x3 B elements per tile, computes a partial sum, then syncs. Tile size = 3√ó3, 9 threads per block."></a></p>
<figcaption>Tiled 9√ó9 matmul: Each thread loads 3x3 A and 3x3 B elements per tile, computes a partial sum, then syncs. Tile size = 3√ó3, 9 threads per block.</figcaption>
</figure>
</div>
<p>Both reads cover the same k-slice (<code>t*TPB ‚Ä¶ t*TPB+TPB-1</code>), so every multiply in this round lives entirely in shared memory.</p>
</section>
<section id="why-do-we-swap-local_row-and-local_col-for-b" class="level4">
<h4 class="anchored" data-anchor-id="why-do-we-swap-local_row-and-local_col-for-b">Why do we swap <code>local_row</code> and <code>local_col</code> for B?</h4>
<p>GPUs coalesce global memory when <em>adjacent threads read adjacent addresses</em>. With the swap:</p>
<ul>
<li><strong>For A</strong>: neighboring threads in x-direction (<code>local_col</code>) read consecutive k‚Äôs ‚áí coalesced</li>
<li><strong>For B</strong>: neighboring threads in y-direction (<code>local_row</code>) read consecutive k‚Äôs ‚áí also coalesced</li>
</ul>
<p>Without the swap, one matrix would be fetched ‚Äústrided‚Äù collapsing into 32 separate memory transactions per warp - a 32√ó slowdown on bandwidth-bound kernels.</p>
<p><strong>Quick primer</strong>: Shared memory isn‚Äôt one monolithic block. It‚Äôs chopped into 32 independent ‚Äúbanks‚Äù<span class="citation" data-cites="nvidia_shared_memory_stats">[15]</span> <span class="citation" data-cites="leimao_cuda_shared_memory_bank">[16]</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p14_shared_memory_bank.png" class="lightbox" data-glightbox="description: .lightbox-desc-25" data-gallery="quarto-lightbox-gallery-25" title="Shared memory banking: conflict-free access (left) vs bank conflicts (right). When multiple threads access different addresses in the same bank, hardware serializes the requests. Source: CUDA Programming Blogspot"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p14_shared_memory_bank.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="Shared memory banking: conflict-free access (left) vs bank conflicts (right). When multiple threads access different addresses in the same bank, hardware serializes the requests. Source: CUDA Programming Blogspot"></a></p>
<figcaption>Shared memory banking: conflict-free access (left) vs bank conflicts (right). When multiple threads access different addresses in the same bank, hardware serializes the requests. Source: <a href="https://cuda-programming.blogspot.com/2013/02/bank-conflicts-in-shared-memory-in-cuda.html">CUDA Programming Blogspot</a></figcaption>
</figure>
</div>
<p>Each is a tiny SRAM with its own read/write port that can service one request (or one 32-bit access per cycle). A warp hits peak bandwidth <em>only when</em> every thread lands in a different bank (or all hit the same address, which hardware can broadcast). If two threads target different addresses inside the same bank during the same cycle, the hardware must serialize them, referred to as a <strong>bank conflict</strong>.</p>
<p>Beyond coalescing, our tile layout also sidesteps these conflicts. Because <code>b_shared[k, threadIdx.x]</code> maps each thread to a distinct bank (while <code>a_shared[threadIdx.y, k]</code> is broadcast-friendly), all 32 memory ports stay busy with zero serialization.</p>
</section>
<section id="choosing-the-right-tile-size" class="level4">
<h4 class="anchored" data-anchor-id="choosing-the-right-tile-size">Choosing the Right Tile Size</h4>
<p>While the current puzzle selects <img src="https://latex.codecogs.com/png.latex?TPB=3"> with tile size <img src="https://latex.codecogs.com/png.latex?TPBxTPB">, choosing the tile size is a balancing act.</p>
<p>Exact numbers vary with GPU, kernel, and precision [<span class="citation" data-cites="nvidia_ampere_unified_shared_memory">[17]</span>]<span class="citation" data-cites="nvidia_blackwell_unified_shared_memory">[18]</span>.</p>
<p>I‚Äôm still learning the dark art of GPU perf tuning, so I‚Äôll save the details for a future post once I‚Äôve had more time to experiment.</p>
<p><strong>TLDR:</strong> For each tile, we will sync (barrier), compute, shift to next tile, repeat. But this is just the baseline - there‚Äôs always a deeper optimization rabbit hole!</p>
</section>
</section>
<section id="layouttensor-1" class="level3">
<h3 class="anchored" data-anchor-id="layouttensor-1">LayoutTensor</h3>
<p>While the manual tiling approach works, it suffers from indexing complexity that obscures the algorithm‚Äôs intent and creates opportunities for bugs. Mojo‚Äôs LayoutTensor API provides an elegant solution that maintains performance while dramatically improving code clarity.</p>
<section id="the-pain-of-manual-indexing" class="level4">
<h4 class="anchored" data-anchor-id="the-pain-of-manual-indexing">The Pain of Manual Indexing</h4>
<p>The manual implementation requires careful coordinate arithmetic:</p>
<ul>
<li>Nested index calculations like <code>tile * TPB + local_col</code> that can easily introduce off-by-one errors</li>
<li>Separate bounds checking for each matrix load operation</li>
<li>Explicit management of tile boundaries and edge cases</li>
<li>Code that prioritizes performance over readability</li>
</ul>
<p>LayoutTensor provides a <strong>tile()</strong> method that creates zero-copy <span class="citation" data-cites="zero_cost_abstractions">[7]</span> views into sub-regions of tensors <span class="citation" data-cites="mojo_layouttensor_tile">[19]</span>. This eliminates manual indexing gymnastics while keeping identical performance.</p>
<p>A <code>LayoutTensor.tile[tile_height, tile_width](block_row, block_col)</code> call returns a view of the specified tile without copying data, at no cost!</p>
<p>The transformation from manual indexing to LayoutTensor simplifies the loading logic:</p>
<div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode diff code-with-copy"><code class="sourceCode diff"><span id="cb40-1"># Load elements of A into shared mem</span>
<span id="cb40-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- if global_row &lt; size and (tile * TPB + local_col) &lt; size:</span></span>
<span id="cb40-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-     shared_a[local_row, local_col] = a[</span></span>
<span id="cb40-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-         global_row, tile * TPB + local_col</span></span>
<span id="cb40-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-     ]</span></span>
<span id="cb40-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span></span>
<span id="cb40-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- # Load elements of B into shared mem  </span></span>
<span id="cb40-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- if global_col &lt; size and (tile * TPB + local_row) &lt; size:</span></span>
<span id="cb40-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-     shared_b[local_row, local_col] = b[</span></span>
<span id="cb40-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-         tile * TPB + local_row, global_col</span></span>
<span id="cb40-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-     ]</span></span>
<span id="cb40-12"># Create tile views (zero-copy)</span>
<span id="cb40-13"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+ a_tile = a.tile[TPB, TPB](block_idx.y, idx)</span></span>
<span id="cb40-14"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+ b_tile = b.tile[TPB, TPB](idx, block_idx.x)</span></span>
<span id="cb40-15"></span>
<span id="cb40-16"># Asynchronous copy to shared memory</span>
<span id="cb40-17"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+ copy_dram_to_sram_async[thread_layout=load_a_layout](a_shared, a_tile)</span></span>
<span id="cb40-18"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+ copy_dram_to_sram_async[thread_layout=load_b_layout](b_shared, b_tile)</span></span>
<span id="cb40-19"></span>
<span id="cb40-20"># Synchronize all async copies</span>
<span id="cb40-21"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">+ async_copy_wait_all()</span></span></code></pre></div>
<p>Full solution looks as follows:</p>
<details closed="">
<summary>
<strong>LayoutTensor Tiled Matmul</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p14_matmul_layout_tensor.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb41" data-filename="p14_matmul_layout_tensor.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb41-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE_TILED <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span></span>
<span id="cb41-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID_TILED <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># each block covers 3x3 elements</span></span>
<span id="cb41-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK_TILED <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (TPB, TPB)</span>
<span id="cb41-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> layout_tiled <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(SIZE_TILED, SIZE_TILED)</span>
<span id="cb41-5"></span>
<span id="cb41-6"></span>
<span id="cb41-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> matmul_tiled[</span>
<span id="cb41-8">    layout: Layout, size: Int</span>
<span id="cb41-9">](</span>
<span id="cb41-10">    output: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dtype, layout],</span>
<span id="cb41-11">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb41-12">    b: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, layout],</span>
<span id="cb41-13">):</span>
<span id="cb41-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LayoutTensor APIs</span></span>
<span id="cb41-15">    out_tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> output.tile[TPB, TPB](block_idx.y, block_idx.x)</span>
<span id="cb41-16">    a_shared <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB, TPB]().shared().alloc()</span>
<span id="cb41-17">    b_shared <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB, TPB]().shared().alloc()</span>
<span id="cb41-18">    local_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.y</span>
<span id="cb41-19">    local_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb41-20"></span>
<span id="cb41-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> local_sum: output.element_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb41-22"></span>
<span id="cb41-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> load_a_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, TPB]()</span>
<span id="cb41-24">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> load_b_layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major[TPB, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]()</span>
<span id="cb41-25">    </span>
<span id="cb41-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span></span>
<span id="cb41-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> idx <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>((size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> TPB):</span>
<span id="cb41-28">        a_tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a.tile[TPB, TPB](block_idx.y, idx)</span>
<span id="cb41-29">        b_tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b.tile[TPB, TPB](idx, block_idx.x)</span>
<span id="cb41-30"></span>
<span id="cb41-31">        copy_dram_to_sram_async[thread_layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>load_a_layout](a_shared, a_tile)</span>
<span id="cb41-32">        copy_dram_to_sram_async[thread_layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>load_b_layout](b_shared, b_tile)</span>
<span id="cb41-33"></span>
<span id="cb41-34">        async_copy_wait_all()</span>
<span id="cb41-35"></span>
<span id="cb41-36">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@parameter</span></span>
<span id="cb41-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(TPB, size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TPB)):</span>
<span id="cb41-38">            local_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> a_shared[local_row, k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b_shared[k, local_col]</span>
<span id="cb41-39"></span>
<span id="cb41-40">        barrier()</span>
<span id="cb41-41"></span>
<span id="cb41-42">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store result after all tiles processed</span></span>
<span id="cb41-43">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (</span>
<span id="cb41-44">        block_idx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> local_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size</span>
<span id="cb41-45">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> local_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size</span>
<span id="cb41-46">    ):</span>
<span id="cb41-47">        out_tile[local_row, local_col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> local_sum</span></code></pre></div>
</div>
</details>
</section>
<section id="synchronization-and-memory-hierarchy" class="level4">
<h4 class="anchored" data-anchor-id="synchronization-and-memory-hierarchy">Synchronization and Memory Hierarchy</h4>
<p>The <code>copy_dram_to_sram_async()</code> function <span class="citation" data-cites="mojo_copy_dram_to_sram_async">[20]</span> enables asynchronous memory transfers from global to shared memory, while <code>async_copy_wait_all()</code> <span class="citation" data-cites="mojo_async_copy_wait_all">[21]</span> provides a synchronization barrier that ensures all pending transfers complete before computation proceeds.</p>
<p>This pattern allows the GPU to:</p>
<ul>
<li>Overlap memory transfers with other computations using dedicated copy engines</li>
<li>Utilize specialized hardware for efficient data movement</li>
<li>Maintain correct execution ordering across thread blocks</li>
<li>Bypass intermediate registers for improved memory hierarchy efficiency</li>
</ul>
<p><strong>Important</strong>: <code>async_copy_wait_all()</code> only synchronizes the asynchronous copy operations‚Äîthreads still need explicit barriers (<code>barrier()</code>) to ensure all threads in a block see the shared memory data before computation begins.</p>
</section>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Across these puzzles, we‚Äôve implemented the four fundamental archetypes that power most GPU computing:</p>
<table class="table">
<colgroup>
<col style="width: 28%">
<col style="width: 28%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Pattern</strong></th>
<th><strong>Puzzles</strong></th>
<th><strong>Core Technique</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Map-Reduce</strong></td>
<td>dot product, axis-sum</td>
<td>warp-level parallel reduction trees</td>
</tr>
<tr class="even">
<td><strong>Stencil</strong></td>
<td>pooling, 1D/2D convolution</td>
<td>spatial tiling with halo exchanges</td>
</tr>
<tr class="odd">
<td><strong>Scan</strong></td>
<td>prefix sum</td>
<td>hierarchical up-sweep + down-sweep</td>
</tr>
<tr class="even">
<td><strong>Dense Linear Algebra</strong></td>
<td>matrix multiplication</td>
<td>cooperative tiling + register reuse</td>
</tr>
</tbody>
</table>
<p>These four archetypes form the building blocks for complex ML kernels, each with specific memory access patterns and synchronization strategies.</p>
<p>Next up: Moar GPU kernels, and finally tackling our favorite technique for the past few years: <strong>Attention</strong>!</p>
<p>Thanks for sticking around! I hope you picked up a trick or two! Spotted a bug or have a sharper optimization? Open an issue in the repo, or ping me on <a href="https://x.com/shubhamg2208">Twitter/X</a>. Happy hacking!</p>




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" data-entry-spacing="0">
<div id="ref-wikipediadotproduct" class="csl-entry">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">Wikipedia, <span>‚ÄúDot product.‚Äù</span> <a href="https://en.wikipedia.org/wiki/Dot_product" class="uri">https://en.wikipedia.org/wiki/Dot_product</a>, 2024.</div>
</div>
<div id="ref-zeno_dichotomy_paradox" class="csl-entry">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">Wikipedia, <span>‚ÄúZeno‚Äôs paradoxes ‚Äî dichotomy paradox.‚Äù</span> <a href="https://en.wikipedia.org/wiki/Zeno%27s_paradoxes#Dichotomy_paradox" class="uri">https://en.wikipedia.org/wiki/Zeno%27s_paradoxes#Dichotomy_paradox</a>, 2024.</div>
</div>
<div id="ref-thakur_convolutions" class="csl-entry">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">A. Thakur, <span>‚ÄúIntuitive understanding of 1D, 2D, and 3D convolutions in convolutional neural networks.‚Äù</span> 2020. Available: <a href="https://wandb.ai/ayush-thakur/dl-question-bank/reports/Intuitive-understanding-of-1D-2D-and-3D-convolutions-in-convolutional-neural-networks---VmlldzoxOTk2MDA">https://wandb.ai/ayush-thakur/dl-question-bank/reports/Intuitive-understanding-of-1D-2D-and-3D-convolutions-in-convolutional-neural-networks---VmlldzoxOTk2MDA</a></div>
</div>
<div id="ref-nvidiapragmaunroll" class="csl-entry">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline">NVIDIA, <span>‚Äú<span class="nocase">#pragma unroll Compiler Directive (CUDA C Programming Guide)</span>.‚Äù</span> 2025. Available: <a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html?highlight=unroll#pragma-unroll">https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html?highlight=unroll#pragma-unroll</a></div>
</div>
<div id="ref-mojoparameter" class="csl-entry">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline">Modular, <span>‚ÄúParametric closure (<code>@parameter</code>) in mojo.‚Äù</span> 2025. Available: <a href="https://docs.modular.com/mojo/manual/decorators/parameter/#parametric-closure">https://docs.modular.com/mojo/manual/decorators/parameter/#parametric-closure</a></div>
</div>
<div id="ref-mojo_lifetimes" class="csl-entry">
<div class="csl-left-margin">[6] </div><div class="csl-right-inline">Modular, <span>‚ÄúLifetimes in mojo.‚Äù</span> 2025. Available: <a href="https://docs.modular.com/mojo/manual/values/lifetimes/">https://docs.modular.com/mojo/manual/values/lifetimes/</a></div>
</div>
<div id="ref-zero_cost_abstractions" class="csl-entry">
<div class="csl-left-margin">[7] </div><div class="csl-right-inline">saoirse, <span>‚ÄúZero cost abstractions.‚Äù</span> 2019. Available: <a href="https://without.boats/blog/zero-cost-abstractions/">https://without.boats/blog/zero-cost-abstractions/</a></div>
</div>
<div id="ref-iitd_parallel_convolution" class="csl-entry">
<div class="csl-left-margin">[8] </div><div class="csl-right-inline">R. Sen, <span>‚ÄúParallel convolution.‚Äù</span> 2022. Available: <a href="https://www.cse.iitd.ac.in/~rijurekha/col730_2022/parallelconvolution_aug29.pdf">https://www.cse.iitd.ac.in/~rijurekha/col730_2022/parallelconvolution_aug29.pdf</a></div>
</div>
<div id="ref-amd_gpu_basics" class="csl-entry">
<div class="csl-left-margin">[9] </div><div class="csl-right-inline">O. R. N. Laboratory, <span>‚ÄúAMD GPU basics.‚Äù</span> 2019. Available: <a href="https://www.olcf.ornl.gov/wp-content/uploads/2019/10/ORNL_Application_Readiness_Workshop-AMD_GPU_Basics.pdf">https://www.olcf.ornl.gov/wp-content/uploads/2019/10/ORNL_Application_Readiness_Workshop-AMD_GPU_Basics.pdf</a></div>
</div>
<div id="ref-mojo_layouttensor_setitem" class="csl-entry">
<div class="csl-left-margin">[10] </div><div class="csl-right-inline">Inc. Modular, <span>‚ÄúLayoutTensor.__setitem__ API reference.‚Äù</span> 2024. Available: <a href="https://docs.modular.com/mojo/kernels/layout/layout_tensor/LayoutTensor/#__setitem__">https://docs.modular.com/mojo/kernels/layout/layout_tensor/LayoutTensor/#__setitem__</a></div>
</div>
<div id="ref-blelloch_prefix_sum" class="csl-entry">
<div class="csl-left-margin">[11] </div><div class="csl-right-inline">G. E. Blelloch, <span>‚ÄúPrefix sums and their applications,‚Äù</span> in <em>Synthesis of parallel algorithms</em>, 1993, pp. 35‚Äì60. Available: <a href="https://www.cs.cmu.edu/~guyb/papers/Ble93.pdf">https://www.cs.cmu.edu/~guyb/papers/Ble93.pdf</a></div>
</div>
<div id="ref-siboehm_cuda_mmm" class="csl-entry">
<div class="csl-left-margin">[12] </div><div class="csl-right-inline">S. Boehm, <span>‚ÄúCUDA matrix multiplication madness.‚Äù</span> 2022. Available: <a href="https://siboehm.com/articles/22/CUDA-MMM">https://siboehm.com/articles/22/CUDA-MMM</a></div>
</div>
<div id="ref-nhrfau_roofline_model" class="csl-entry">
<div class="csl-left-margin">[13] </div><div class="csl-right-inline">NHR@FAU, <span>‚ÄúRoofline model: Performance modeling for modern processors.‚Äù</span> <a href="https://www.youtube.com/watch?v=IrkNZG8MJ64" class="uri">https://www.youtube.com/watch?v=IrkNZG8MJ64</a>, 2022.</div>
</div>
<div id="ref-rtx_ada_specs" class="csl-entry">
<div class="csl-left-margin">[14] </div><div class="csl-right-inline">N. Corporation, <span>‚ÄúNVIDIA RTX 4000 ada generation datasheet.‚Äù</span> 2023. Available: <a href="https://resources.nvidia.com/en-us-briefcase-for-datasheets/rtx-4000-ada-datashe-1?ncid=no-ncid">https://resources.nvidia.com/en-us-briefcase-for-datasheets/rtx-4000-ada-datashe-1?ncid=no-ncid</a></div>
</div>
<div id="ref-nvidia_shared_memory_stats" class="csl-entry">
<div class="csl-left-margin">[15] </div><div class="csl-right-inline">N. Corporation, <span>‚ÄúCUDA kernel-level shared memory statistics.‚Äù</span> Available: <a href="https://docs.nvidia.com/gameworks/content/developertools/desktop/analysis/report/cudaexperiments/kernellevel/memorystatisticsshared.htm">https://docs.nvidia.com/gameworks/content/developertools/desktop/analysis/report/cudaexperiments/kernellevel/memorystatisticsshared.htm</a></div>
</div>
<div id="ref-leimao_cuda_shared_memory_bank" class="csl-entry">
<div class="csl-left-margin">[16] </div><div class="csl-right-inline">L. Mao, <span>‚ÄúCUDA shared memory bank.‚Äù</span> 2022. Available: <a href="https://leimao.github.io/blog/CUDA-Shared-Memory-Bank/">https://leimao.github.io/blog/CUDA-Shared-Memory-Bank/</a></div>
</div>
<div id="ref-nvidia_ampere_unified_shared_memory" class="csl-entry">
<div class="csl-left-margin">[17] </div><div class="csl-right-inline">N. Corporation, <span>‚ÄúAmpere tuning guide: Unified shared memory and L1/texture cache.‚Äù</span> 2023. Available: <a href="https://docs.nvidia.com/cuda/ampere-tuning-guide/index.html#unified-shared-memory-l1-texture-cache">https://docs.nvidia.com/cuda/ampere-tuning-guide/index.html#unified-shared-memory-l1-texture-cache</a></div>
</div>
<div id="ref-nvidia_blackwell_unified_shared_memory" class="csl-entry">
<div class="csl-left-margin">[18] </div><div class="csl-right-inline">N. Corporation, <span>‚ÄúBlackwell tuning guide: Unified shared memory and L1/texture cache.‚Äù</span> 2025. Available: <a href="https://docs.nvidia.com/cuda/blackwell-tuning-guide/index.html#unified-shared-memory-l1-texture-cache">https://docs.nvidia.com/cuda/blackwell-tuning-guide/index.html#unified-shared-memory-l1-texture-cache</a></div>
</div>
<div id="ref-mojo_layouttensor_tile" class="csl-entry">
<div class="csl-left-margin">[19] </div><div class="csl-right-inline">Inc. Modular, <span>‚ÄúLayoutTensor.tile API reference.‚Äù</span> Available: <a href="https://docs.modular.com/mojo/kernels/layout/layout_tensor/LayoutTensor/#tile">https://docs.modular.com/mojo/kernels/layout/layout_tensor/LayoutTensor/#tile</a></div>
</div>
<div id="ref-mojo_copy_dram_to_sram_async" class="csl-entry">
<div class="csl-left-margin">[20] </div><div class="csl-right-inline">Inc. Modular, <span>‚ÄúCopy_dram_to_sram_async API reference.‚Äù</span> Available: <a href="https://docs.modular.com/mojo/kernels/layout/layout_tensor/copy_dram_to_sram_async/">https://docs.modular.com/mojo/kernels/layout/layout_tensor/copy_dram_to_sram_async/</a></div>
</div>
<div id="ref-mojo_async_copy_wait_all" class="csl-entry">
<div class="csl-left-margin">[21] </div><div class="csl-right-inline">Inc. Modular, <span>‚ÄúAsync_copy_wait_all API reference.‚Äù</span> Available: <a href="https://docs.modular.com/mojo/stdlib/gpu/memory/async_copy_wait_all">https://docs.modular.com/mojo/stdlib/gpu/memory/async_copy_wait_all</a></div>
</div>
</div></section></div> ]]></description>
  <guid>https://shubhamg.in/posts/2025-07-20-gpu-puzzles-p2.html</guid>
  <pubDate>Sat, 19 Jul 2025 16:00:00 GMT</pubDate>
  <media:content url="https://shubhamg.in/posts/mojo_gpu_puzzles/p11_block_boundary.png" medium="image" type="image/png" height="65" width="144"/>
</item>
<item>
  <title>GPUs go brrr with Mojo: Fundamentals</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2025-07-06-gpu-puzzles-p1.html</link>
  <description><![CDATA[ 





<p>Back on the blog after a long hiatus - this time, I‚Äôm shifting gears from just reviewing papers(which are available on my <a href="https://github.com/goodhamgupta/paper_reviews">GitHub</a>) to diving deep into hands-on implementations.</p>
<p>I‚Äôve always been interested in systems programming, but somehow never <em>really</em> picked it up. The rate of progress in the GenAI space has been exponential recently, with players like Google <span class="citation" data-cites="Google">[1]</span> reportedly processing 9.7 trillion tokens a month. Companies are now investing more time and resources in making these Large Language Models as fast and cheap as possible, by improving training and inference efficiency using ‚Äúmoar‚Äù compute.</p>
<p>I briefly spoke about <a href="https://www.figma.com/deck/Sq9frEEoTFgFWthOJ4EM5w/intro_gpu_cuda?node-id=1-37&amp;t=VNzh9p2qKrHNSTJj-1">GPU computing last year</a>, and finally decided to learn it this summer. The goal is to eventually be able to implement kernels for fast matmuls, softmax, and FlashAttention.</p>
<section id="why-mojo" class="level2">
<h2 class="anchored" data-anchor-id="why-mojo">Why Mojo?</h2>
<p>I‚Äôve tried learning Rust <a href="https://github.com/goodhamgupta/rustlings">multiple</a> <a href="https://github.com/goodhamgupta/100-exercises-to-learn-rust/">times</a>, along with a few stints of trying C, C++ and Zig, but I never really felt as comfortable in these languages as I do in Python and Elixir.</p>
<p>In early 2023, Modular announced Mojoüî•, a new systems-programming language promising:</p>
<ul>
<li>Python-like syntax</li>
<li>Support for both CPU and GPU architectures</li>
<li>Kernel autofusion</li>
<li>Builds on MLIR</li>
<li>Traits and bounds checking</li>
<li>Interopeability with PTX, Python, C</li>
</ul>
<p>Modular has since announced Max, their AI inference platform, built on Mojo. The released <a href="https://github.com/modular/modular/tree/main/max/kernels">all kernels</a> available as part of the platform, along with their own version<span class="citation" data-cites="modularpuzzles">[2]</span> of Sasha Rush‚Äôs GPU Puzzles <span class="citation" data-cites="GPUPuzzles">[3]</span> in Mojo. IMO, their kernels were much easier to read compared to CUDA/Triton implementations. I also enjoyed the ‚ÄúDemocratising AI Compute‚Äù<span class="citation" data-cites="modular_democratizing_ai_compute">[4]</span> series by Chris Lattner, and thus I decided to learn a bit more about how to write these kernels in Mojo.</p>
</section>
<section id="gpu-memory" class="level2">
<h2 class="anchored" data-anchor-id="gpu-memory">GPU 101</h2>
<p>GPUs (Graphics Processing Units) are massively parallel processors optimized for throughput over latency. In GPU programming we:</p>
<ul>
<li>Lay out data and computation as a grid of thread blocks.</li>
<li>Launch a <em>kernel</em> from the CPU (host) to run on the GPU (device).</li>
<li>Exploit thousands of lightweight threads all executing the same code (Single Instruction, Multiple Threads or SIMT).</li>
</ul>
<p>Modern chips had two ways to spend their billions of transistors:</p>
<ol type="1">
<li><strong>CPUs</strong> invest them in large caches, branch predictors and out-of-order logic to minimize <em>latency</em> for one or a few threads.</li>
<li><strong>GPUs</strong> invest them in thousands of simple cores and huge register files to maximize <em>throughput</em> for many threads, assuming those threads can tolerate latency by waiting in parallel.</li>
</ol>
<p>The rest of this section unpacks how that single design choice shows up in memory, execution and program flow.</p>
<section id="memory-hierarchy-hide-latency-with-tons-of-threads" class="level3">
<h3 class="anchored" data-anchor-id="memory-hierarchy-hide-latency-with-tons-of-threads">1. Memory hierarchy ‚Äì hide latency with tons of threads</h3>
<p>CPUs invest transistors in large caches to minimize latency. GPUs take the opposite approach: they use thousands of threads to hide latency instead of avoiding it.</p>
<p>GPU memory hierarchy (slowest/largest to fastest/smallest):</p>
<ul>
<li><strong>Global (HBM)</strong>: High Bandwidth Memory‚Äîthe GPU‚Äôs main memory, large but high-latency, visible to all threads<br>
</li>
<li><strong>Shared (SRAM)</strong>: fast on-chip memory, ~100x faster than HBM<br>
</li>
<li><strong>Registers</strong>: per-thread storage, fastest access, ~1000x faster than HBM</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/memory_hierachy_fa.png" class="lightbox" data-glightbox="description: .lightbox-desc-1" data-gallery="quarto-lightbox-gallery-1" title="Source: FlashAttention [@dao_flashattention]. Metrics shown are for an NVIDIA A100 GPU."><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/memory_hierachy_fa.png" class="img-fluid figure-img" style="width:60.0%" alt="Source: FlashAttention [5]. Metrics shown are for an NVIDIA A100 GPU."></a></p>
<figcaption>Source: FlashAttention <span class="citation" data-cites="dao_flashattention">[5]</span>. Metrics shown are for an NVIDIA A100 GPU.</figcaption>
</figure>
</div>
<p>The key insight: when threads wait for slow global memory (~400-800 cycles), the GPU immediately switches to other threads. This keeps compute units busy while data moves through the hierarchy.</p>
</section>
<section id="execution-hierarchy-launch-enough-warps-to-hide-stalls" class="level3">
<h3 class="anchored" data-anchor-id="execution-hierarchy-launch-enough-warps-to-hide-stalls">2. Execution hierarchy ‚Äì launch enough warps to hide stalls</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/gpu_flow_hierachy.png" class="lightbox" data-glightbox="description: .lightbox-desc-2" data-gallery="quarto-lightbox-gallery-2" title="GPU Execution Hierachy"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/gpu_flow_hierachy.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%" alt="GPU Execution Hierachy"></a></p>
<figcaption>GPU Execution Hierachy</figcaption>
</figure>
</div>
<p>Building from the bottom up:</p>
<ul>
<li><strong>Thread</strong>: the basic execution unit with its own registers</li>
<li><strong>Warp</strong>: 32 threads executing the same instruction together (the basic unit of GPU scheduling)<br>
</li>
<li><strong>Block</strong>: a group of threads that share <code>shared</code> memory and can synchronize<br>
</li>
<li><strong>Grid</strong>: a collection of blocks distributed across SMs</li>
</ul>
<p>GPUs schedule threads in groups of 32 (warps). When one warp stalls on memory, the scheduler switches to another warp instantly. More resident warps = better latency hiding.</p>
</section>
<section id="program-flow-cpu-launches-gpu-streams" class="level3">
<h3 class="anchored" data-anchor-id="program-flow-cpu-launches-gpu-streams">3. Program flow ‚Äì CPU launches, GPU streams</h3>
<p><a href="mojo_gpu_puzzles/program_flow.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/program_flow.png" class="img-fluid"></a></p>
<p>The CPU launches kernels asynchronously and goes back to other work. Inside the GPU each warp executes the <em>same instruction</em> (SIMT). Divergent branches disable some lanes and waste those cores.</p>
<ol type="1">
<li><strong>Host</strong> allocates and copies data to GPU global memory<br>
</li>
<li>Host launches the <strong>kernel</strong> with a specified grid and block size<br>
</li>
<li><strong>Device</strong> executes the kernel in parallel across threads<br>
</li>
<li>Host retrieves results from GPU memory</li>
</ol>
</section>
<section id="putting-it-together" class="level3">
<h3 class="anchored" data-anchor-id="putting-it-together">Putting it together</h3>
<p>Fast GPU kernels keep cores busy by:</p>
<ul>
<li>Staging hot data in <code>shared</code> or registers</li>
<li>Launching enough threads to mask global-memory latency</li>
<li>Writing branch-free, data-parallel code</li>
</ul>
<p>We will cover the practical implications of the above topics as we go through the puzzles.</p>
</section>
</section>
<section id="infrastructure" class="level2">
<h2 class="anchored" data-anchor-id="infrastructure">Infrastructure</h2>
<p>If you plan on solving these puzzles, remember to pick a <a href="https://docs.modular.com/max/faq/#gpu-requirements">compatible GPU</a> and follow the <a href="https://builds.modular.com/puzzles/howto.html">setup instructions</a></p>
<p>I completed the puzzles on a instance with a RTX4090 Ti chip, rented via <a href="https://www.primeintellect.ai/">Prime Intellect</a> at <strong>0.22 $/hr</strong>!</p>
<p><strong>Note</strong>: The Modular team has created beautiful <a href="https://github.com/ManimCommunity/manim">Manim</a> visualizations for each puzzle, making the concepts much more intuitive. I‚Äôll walk through these visualizations as we tackle each problem.</p>
</section>
<section id="puzzle-01" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_01/puzzle_01.html">Puzzle 1: Map</a></h1>
<p>In this puzzle, we aim to add a scalar to a vector. Specifically, we want to use a separate thread for each element in the vector, add the scalar, and write the result to the output memory.</p>
<p>When we create the kernel, the scalar will be effectively ‚Äúbroadcast‚Äù or expanded to match the shape of the input vector. This allows each element of the vector to be independently added with the scalar value in parallel by its dedicated thread, following the <a href="https://docs.pytorch.org/docs/stable/notes/broadcasting.html">broadcasting rules</a>.</p>
<div class="quarto-figure quarto-figure-middle">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p01_vector_addition.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p01_vector_addition.png" class="img-fluid quarto-figure quarto-figure-middle figure-img"></a></p>
</figure>
</div>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p01.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="p01.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> add_10(out: UnsafePointer[Scalar[dtype]], a: UnsafePointer[Scalar[dtype]]):</span>
<span id="cb1-2">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb1-3">    out[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span></code></pre></div>
</div>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p01</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([10.0, 11.0, 12.0, 13.0])</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([10.0, 11.0, 12.0, 13.0])</span></span></code></pre></div>
</details>
</section>
<section id="puzzle-02" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_02/puzzle_02.html">Puzzle 2: Zip</a></h1>
<p>This is an extension of the map puzzle. Now, we aim to add 2 tensors together.</p>
<p><a href="mojo_gpu_puzzles/p02.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p02.png" class="img-fluid"></a></p>
<p>As in puzzle 1, the aim is to use one individual thread for elements at a specific index in both vectors.</p>
<p><a href="mojo_gpu_puzzles/p02_thread.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p02_thread.png" class="img-fluid"></a></p>
<p>Note that we assume the entire array will fit within a single block, which is why there is no code for boundary checking, edge cases, etc.</p>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p02.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="p02.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> add(</span>
<span id="cb3-2">    out: UnsafePointer[Scalar[dtype]],</span>
<span id="cb3-3">    a: UnsafePointer[Scalar[dtype]],</span>
<span id="cb3-4">    b: UnsafePointer[Scalar[dtype]],</span>
<span id="cb3-5">):</span>
<span id="cb3-6">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb3-7">    out[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b[i]</span></code></pre></div>
</div>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p02</span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># a: HostBuffer([0.0, 1.0, 2.0, 3.0])</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># b: HostBuffer([0.0, 1.0, 2.0, 3.0])</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([0.0, 2.0, 4.0, 6.0])</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([0.0, 2.0, 4.0, 6.0])</span></span></code></pre></div>
</details>
</section>
<section id="puzzle-03" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_03/puzzle_03.html">Puzzle 3: Guards</a></h1>
<p>The only difference between this puzzle and Puzzle 1 is that now it‚Äôs possible that the size of the GPU block is larger than the given input.</p>
<p>In GPU programming, ‚Äúguards‚Äù refer to conditional statements that check if a thread should perform work based on its index. GPUs launch threads in fixed-size groups (blocks), and often these blocks contain more threads than elements in our array.</p>
<p>In this case, we need to check if the current thread index is valid before applying our computation on the vector. Without this guard, threads with indices beyond our array bounds would cause memory access violations.</p>
<p><a href="mojo_gpu_puzzles/p03.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p03.png" class="img-fluid"></a></p>
<p>The image above illustrates how some threads have indices that exceed the array size and must be prevented from accessing memory.</p>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p03.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="p03.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> add_10_guard(</span>
<span id="cb5-2">    out: UnsafePointer[Scalar[dtype]],</span>
<span id="cb5-3">    a: UnsafePointer[Scalar[dtype]],</span>
<span id="cb5-4">    size: Int,</span>
<span id="cb5-5">):</span>
<span id="cb5-6">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb5-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb5-8">        out[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span></code></pre></div>
</div>
<p>Note that the size of the array is also sent as input to the kernel, as computing it in the kernel would defeat the purpose of parallelisation. While these conditional checks are necessary for correctness, they can introduce some performance overhead due to thread divergence within warps. We‚Äôll cover this in more detail shortly.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p03</span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in: HostBuffer([0.0, 1.0, 2.0, 3.0])</span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([10.0, 11.0, 12.0, 13.0])</span></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([10.0, 11.0, 12.0, 13.0])</span></span></code></pre></div>
</details>
</section>
<section id="puzzle-04" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_04/puzzle_04.html">Puzzle 4: 2D Map</a></h1>
<p>Similar to Puzzle 2, instead of operating on scalars with 1D tensors, we will now use 2D tensors.</p>
<p>Mojo, similar to CUDA, typically uses <a href="https://en.wikipedia.org/wiki/Row-_and_column-major_order">row-major</a> order for array storage, meaning data is stored sequentially by rows in memory.</p>
<p><a href="mojo_gpu_puzzles/p04_row_col_major.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p04_row_col_major.png" class="img-fluid"></a></p>
<p>Given the row-major format, the elements are accessed using the formula:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AA_%7BR,C%7D%20=%20R*%5Ctext%7Bsize%5C_of%5C_array%7D%20+%20C%0A"></p>
<section id="raw-memory-approach" class="level4">
<h4 class="anchored" data-anchor-id="raw-memory-approach">Raw Memory Approach</h4>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p04.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb7" data-filename="p04.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> add_10_2d(</span>
<span id="cb7-2">    out: UnsafePointer[Scalar[dtype]],</span>
<span id="cb7-3">    a: UnsafePointer[Scalar[dtype]],</span>
<span id="cb7-4">    size: Int,</span>
<span id="cb7-5">):</span>
<span id="cb7-6">    row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.y</span>
<span id="cb7-7">    col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb7-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb7-9">        out[row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span></code></pre></div>
</div>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p04</span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in: HostBuffer([0.0, 1.0, 2.0, 3.0]) -- shaped as 2x2 row-major</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([10.0, 11.0, 12.0, 13.0])</span></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([10.0, 11.0, 12.0, 13.0])</span></span></code></pre></div>
</details>
</section>
<section id="layouttensor" class="level4">
<h4 class="anchored" data-anchor-id="layouttensor">LayoutTensor</h4>
<p>LayoutTensor<span class="citation" data-cites="llvmlayouttensor">[6]</span> is Mojo‚Äôs abstraction to work on a Tensor.</p>
<p>Specifically, LayoutTensor aims to provide:</p>
<ul>
<li>High level primitive to perform operations on tiles.</li>
<li>Flexible memory layouts, with support for row-based, column-based and tiled organisation of data in memory.</li>
<li>Expose functions/parameters to enable auto-tuning or manual experimentation.</li>
<li>Access to hardware without inline assembly.</li>
</ul>
<p>Mojo(and LayoutTensor) follow this ‚Äúparameter syntax‚Äù<span class="citation" data-cites="mojotalk">[7]</span>, which is similar to how C++ templates are defined. This was a bit difficult for me to grasp since I don‚Äôt have a C++ background, and caused a few troubles in the upcoming puzzles. I was happy to learn that I‚Äôm not the only one struggling with it though!<span class="citation" data-cites="jeffniutriton">[8]</span> .</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p04_parameter_syntax.png" class="lightbox" data-glightbox="description: .lightbox-desc-9" data-gallery="quarto-lightbox-gallery-9" title="Mojo Parameter Syntax"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p04_parameter_syntax.png" class="img-fluid figure-img" alt="Mojo Parameter Syntax"></a></p>
<figcaption>Mojo Parameter Syntax</figcaption>
</figure>
</div>
<p>The features that looked most interesting to me are:</p>
<ul>
<li>Natural Indexing: Index a element using the format <code>A[row, col]</code></li>
<li>Automatic Bounds Checking: I‚Äôve (ab)used this feature in the upcoming puzzles.</li>
</ul>
<p>Some examples of <a href="https://builds.modular.com/puzzles/puzzle_04/introduction_layout_tensor.html#basic-usage-example">LayoutTensor in practice</a>:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>layout_tensor.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="layout_tensor.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> layout <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Layout, LayoutTensor</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define layout</span></span>
<span id="cb9-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> HEIGHT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb9-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> WIDTH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb9-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(HEIGHT, WIDTH)</span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create tensor</span></span>
<span id="cb9-9">tensor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LayoutTensor[dtype, layout](<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">buffer</span>.unsafe_ptr())</span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Access elements naturally</span></span>
<span id="cb9-12">tensor[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First element</span></span>
<span id="cb9-13">tensor[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Last element</span></span>
<span id="cb9-14"></span>
<span id="cb9-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Column-major layout</span></span>
<span id="cb9-16">layout_col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.col_major(HEIGHT, WIDTH)</span>
<span id="cb9-17"></span>
<span id="cb9-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tiled layout (for better cache utilization)</span></span>
<span id="cb9-19">layout_tiled <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor.tiled[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>](HEIGHT, WIDTH)</span></code></pre></div>
</div>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p04.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-filename="p04.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> add_10_2d(</span>
<span id="cb10-2">    out: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dtype, layout],</span>
<span id="cb10-3">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dtype, layout],</span>
<span id="cb10-4">    size: Int,</span>
<span id="cb10-5">):</span>
<span id="cb10-6">    row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.y</span>
<span id="cb10-7">    col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb10-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: With layout tensor, this is not really necessary, but it helps prevent unwanted memory access</span></span>
<span id="cb10-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size: </span>
<span id="cb10-10">        out[row, col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[row, col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span></span></code></pre></div>
</div>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p04_layout_tensor</span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in: HostBuffer([0.0, 1.0, 2.0, 3.0])</span></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out shape: 2 x 2</span></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([10.0, 11.0, 12.0, 13.0])</span></span>
<span id="cb11-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([10.0, 11.0, 12.0, 13.0])</span></span></code></pre></div>
</details>
</section>
</section>
<section id="puzzle-05" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_05/puzzle_05.html">Puzzle 5: Broadcast</a></h1>
<p>We aim to broadcast the addition operation over two vectors. Following the <a href="https://docs.pytorch.org/docs/stable/notes/broadcasting.html">broadcasting rules</a>, the result will be an outer-product of the given vectors.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p05_vector_addition.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p05_vector_addition.png" class="quarto-figure quarto-figure-center figure-img" height="600"></a></p>
</figure>
</div>
<section id="raw-memory-version" class="level4">
<h4 class="anchored" data-anchor-id="raw-memory-version">Raw Memory Version</h4>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p05.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb12" data-filename="p05.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> broadcast_add(</span>
<span id="cb12-2">    out: UnsafePointer[Scalar[dtype]],</span>
<span id="cb12-3">    a: UnsafePointer[Scalar[dtype]],</span>
<span id="cb12-4">    b: UnsafePointer[Scalar[dtype]],</span>
<span id="cb12-5">    size: Int,</span>
<span id="cb12-6">):</span>
<span id="cb12-7">    row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.y</span>
<span id="cb12-8">    col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb12-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb12-10">        out[row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[row] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b[col]</span></code></pre></div>
</div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p05</span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in a: HostBuffer([0.0, 1.0])</span></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in b: HostBuffer([0.0, 1.0])</span></span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([0.0, 1.0, 1.0, 2.0])</span></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([0.0, 1.0, 1.0, 2.0])</span></span></code></pre></div>
</details>
</section>
<section id="layout-tensor" class="level4">
<h4 class="anchored" data-anchor-id="layout-tensor">Layout Tensor</h4>
<p>Since we know the inputs are 1D vectors, we use only one dimension from each of the vectors, and set the other to 0 i.e the first element.</p>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p05_layout_tensor.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb14" data-filename="p05_layout_tensor.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> broadcast_add[</span>
<span id="cb14-2">    out_layout: Layout,</span>
<span id="cb14-3">    a_layout: Layout,</span>
<span id="cb14-4">    b_layout: Layout,</span>
<span id="cb14-5">](</span>
<span id="cb14-6">    out: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dtype, out_layout],</span>
<span id="cb14-7">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, a_layout],</span>
<span id="cb14-8">    b: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, dtype, b_layout],</span>
<span id="cb14-9">    size: Int,</span>
<span id="cb14-10">):</span>
<span id="cb14-11">    row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.y</span>
<span id="cb14-12">    col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb14-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb14-14">        out[row, col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, row] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b[col, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
</div>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p05_layout_tensor</span>
<span id="cb15-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in a: HostBuffer([0.0, 1.0])</span></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in b: HostBuffer([0.0, 1.0])</span></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out shape: 2 x 2</span></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([0.0, 1.0, 1.0, 2.0])</span></span>
<span id="cb15-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([0.0, 1.0, 1.0, 2.0])</span></span></code></pre></div>
</details>
</section>
</section>
<section id="puzzle-06" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_06/puzzle_06.html">Puzzle 6: Blocks</a></h1>
<p>Building on Puzzles 4 and 5, we now aim to add a scalar to a tensor. We also have the additional restriction around having fewer threads than the elements in our array, per block. This means that now apart from using the local indices of the current thread(<code>thread_idx.y</code> and <code>thread_idx.x</code>), we now also need to identify the current block, using <code>block_idx.y</code> and <code>block_idx.x</code>. The formula for calculating the index, in row-major format, is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Aidx%20=%20block%5C_idx.x%20*%20block%5C_dim.x%20+%20thread%5C_idx.x%0A"></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p06.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p06.png" class="quarto-figure quarto-figure-center figure-img" height="600"></a></p>
</figure>
</div>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p06.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb16" data-filename="p06.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span></span>
<span id="cb16-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb16-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb16-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DType.float32</span>
<span id="cb16-5"></span>
<span id="cb16-6"></span>
<span id="cb16-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> add_10_blocks(</span>
<span id="cb16-8">    out: UnsafePointer[Scalar[dtype]],</span>
<span id="cb16-9">    a: UnsafePointer[Scalar[dtype]],</span>
<span id="cb16-10">    size: Int,</span>
<span id="cb16-11">):</span>
<span id="cb16-12">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb16-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb16-14">        out[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span></code></pre></div>
</div>
</details>
</section>
<section id="puzzle-07" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_07/puzzle_07.html">Puzzle 7: 2D Blocks</a></h1>
<p>As the title suggests, we now have a 2D structure for both blocks and grids, and the number of threads per block is lesser than the total number of elements in the input tensor.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p07.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p07.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
<section id="raw-memory" class="level4">
<h4 class="anchored" data-anchor-id="raw-memory">Raw Memory</h4>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p07.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-filename="p07.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb17-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb17-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb17-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DType.float32</span>
<span id="cb17-5"></span>
<span id="cb17-6"></span>
<span id="cb17-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> add_10_blocks_2d(</span>
<span id="cb17-8">    out: UnsafePointer[Scalar[dtype]],</span>
<span id="cb17-9">    a: UnsafePointer[Scalar[dtype]],</span>
<span id="cb17-10">    size: Int,</span>
<span id="cb17-11">):</span>
<span id="cb17-12">    row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.y</span>
<span id="cb17-13">    col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb17-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb17-15">        out[row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> col] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span></span>
<span id="cb17-16"></span>
<span id="cb17-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">```bash</span></span>
<span id="cb17-18"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">pixi run p07</span></span>
<span id="cb17-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0])</span></span>
<span id="cb17-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0])</span></span></code></pre></div>
</div>
</details>
</section>
<section id="layout-tensor-1" class="level4">
<h4 class="anchored" data-anchor-id="layout-tensor-1">Layout Tensor</h4>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p07.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb18" data-filename="p07.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span></span>
<span id="cb18-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb18-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb18-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DType.float32</span>
<span id="cb18-5"></span>
<span id="cb18-6"></span>
<span id="cb18-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> add_10_blocks(</span>
<span id="cb18-8">    out: UnsafePointer[Scalar[dtype]],</span>
<span id="cb18-9">    a: UnsafePointer[Scalar[dtype]],</span>
<span id="cb18-10">    size: Int,</span>
<span id="cb18-11">):</span>
<span id="cb18-12">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb18-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb18-14">        out[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span></code></pre></div>
</div>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p07_layout_tensor</span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: 11.0 11.0 11.0 11.0 11.0</span></span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 11.0 11.0 11.0 11.0 11.0</span></span>
<span id="cb19-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 11.0 11.0 11.0 11.0 11.0</span></span>
<span id="cb19-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 11.0 11.0 11.0 11.0 11.0</span></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 11.0 11.0 11.0 11.0 11.0</span></span>
<span id="cb19-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: 11.0 11.0 11.0 11.0 11.0</span></span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 11.0 11.0 11.0 11.0 11.0</span></span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 11.0 11.0 11.0 11.0 11.0</span></span>
<span id="cb19-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 11.0 11.0 11.0 11.0 11.0</span></span>
<span id="cb19-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 11.0 11.0 11.0 11.0 11.0</span></span></code></pre></div>
</details>
</section>
</section>
<section id="puzzle-08" class="level1">
<h1><a href="https://builds.modular.com/puzzles/puzzle_08/puzzle_08.html">Puzzle 8: Shared Memory</a></h1>
<p>This puzzle introduces shared memory‚Äîthe on-chip SRAM that makes GPUs fast. Instead of each thread reading from slow global memory, we‚Äôll load data into shared memory once and let all threads in a block access it quickly.</p>
<p>In this puzzle we leverage shared memory (SRAM). Like Puzzle 7, we add a scalar to a 2D tensor, but now each block has fewer threads than there are input elements.</p>
<p>As shown above, SRAM is orders of magnitude faster than DRAM. Accessing global memory directly is slow, so we first load data into shared memory‚Äîthen perform our computations for much faster access.</p>
<p>Although this input is too small to reveal a noticeable speedup, the advantage of shared memory becomes substantial as array sizes increase.</p>
<p>Now, because our operations depend on all records being available in shared memory, we need to wait for all threads in a block to write data to the shared memory before we can access it. Failure to do this can lead to deadlocks or undefined behaviour. Hence, we need <strong>synchronisation</strong>!</p>
<p>Mojo has support for all the common <a href="https://docs.modular.com/mojo/stdlib/gpu/sync/#functions">synchronisation primitives</a>, similar to <a href="https://nvidia.github.io/cccl/libcudacxx/extended_api/synchronization_primitives.html">CUDA primitives</a>. For this puzzle, we need to use the <code>barrier</code> synchronisation, which is the same as <code>_syncThreads()</code> in CUDA: Ensure all threads within a thread block reach the barrier before any can proceed.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="mojo_gpu_puzzles/p08.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="https://shubhamg.in/posts/mojo_gpu_puzzles/p08.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
<section id="raw-memory-1" class="level4">
<h4 class="anchored" data-anchor-id="raw-memory-1">Raw memory</h4>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p08.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb20" data-filename="p08.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb20-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb20-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb20-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (TPB, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DType.float32</span>
<span id="cb20-6"></span>
<span id="cb20-7"></span>
<span id="cb20-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> add_10_shared(</span>
<span id="cb20-9">    out: UnsafePointer[Scalar[dtype]],</span>
<span id="cb20-10">    a: UnsafePointer[Scalar[dtype]],</span>
<span id="cb20-11">    size: Int,</span>
<span id="cb20-12">):</span>
<span id="cb20-13">    shared <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stack_allocation[</span>
<span id="cb20-14">        TPB,</span>
<span id="cb20-15">        Scalar[dtype],</span>
<span id="cb20-16">        address_space <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AddressSpace.SHARED,</span>
<span id="cb20-17">    ]()</span>
<span id="cb20-18">    global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb20-19">    local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb20-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># local data into shared memory</span></span>
<span id="cb20-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb20-22">        shared[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[global_i]</span>
<span id="cb20-23"></span>
<span id="cb20-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># wait for all threads to complete</span></span>
<span id="cb20-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># works within a thread block</span></span>
<span id="cb20-26">    barrier()</span>
<span id="cb20-27"></span>
<span id="cb20-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb20-29">        out[global_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span></span></code></pre></div>
</div>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p08</span>
<span id="cb21-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0])</span></span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0])</span></span></code></pre></div>
</details>
</section>
<section id="layouttensor-1" class="level4">
<h4 class="anchored" data-anchor-id="layouttensor-1">LayoutTensor</h4>
<p>Key difference here is to use <a href="https://builds.modular.com/puzzles/puzzle_08/layout_tensor.html#key-differences-from-raw-approach">LayoutTensorBuild instead of stack_allocation</a> to allocate shared memory.</p>
<details open="">
<summary>
<strong>Solution</strong>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>p08_layout_tensor.mojo</strong></pre>
</div>
<div class="sourceCode" id="cb22" data-filename="p08_layout_tensor.mojo" style="background: #f1f3f5;"><pre class="sourceCode mojo code-with-copy"><code class="sourceCode mojo"><span id="cb22-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> TPB <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb22-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb22-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> BLOCKS_PER_GRID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb22-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (TPB, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb22-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> dtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DType.float32</span>
<span id="cb22-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">alias</span> layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Layout.row_major(SIZE)</span>
<span id="cb22-7"></span>
<span id="cb22-8"></span>
<span id="cb22-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> add_10_shared_layout_tensor[</span>
<span id="cb22-10">    layout: Layout</span>
<span id="cb22-11">](</span>
<span id="cb22-12">    out: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dtype, layout],</span>
<span id="cb22-13">    a: LayoutTensor[mut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, dtype, layout],</span>
<span id="cb22-14">    size: Int,</span>
<span id="cb22-15">):</span>
<span id="cb22-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Allocate shared memory using tensor builder</span></span>
<span id="cb22-17">    shared <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tb[dtype]().row_major[TPB]().shared().alloc()</span>
<span id="cb22-18"></span>
<span id="cb22-19">    global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> block_dim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_idx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> thread_idx.x</span>
<span id="cb22-20">    local_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx.x</span>
<span id="cb22-21"></span>
<span id="cb22-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb22-23">        shared[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[global_i]</span>
<span id="cb22-24"></span>
<span id="cb22-25">    barrier()</span>
<span id="cb22-26"></span>
<span id="cb22-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> global_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size:</span>
<span id="cb22-28">        out[global_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[local_i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span></span></code></pre></div>
</div>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run p08_layout_tensor</span>
<span id="cb23-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># out: HostBuffer([11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0])</span></span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected: HostBuffer([11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0, 11.0])</span></span></code></pre></div>
</details>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>We covered simple algorithms such as map, zip using Mojo, and did some initial work with their <code>LayoutTensor</code> abstraction, which similar to the <a href="https://docs.nvidia.com/cutlass/media/docs/cpp/cute/00_quickstart.html">CuTe</a> library.</p>
<p>Stay tuned for more posts‚ÄîI‚Äôll be diving into more advanced GPU puzzles and Mojo tricks soon!</p>
<p>If you spot mistakes or have better/faster Mojo code, open a PR or ping me on <a href="https://twitter.com/shubhamg2208">Twitter/X</a>. Happy hacking!</p>




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" data-entry-spacing="0">
<div id="ref-Google" class="csl-entry">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">Google, <span>‚Äú<span>I/O 2025 Keynote</span>.‚Äù</span> 2025. Available: <a href="https://blog.google/technology/ai/io-2025-keynote/">https://blog.google/technology/ai/io-2025-keynote/</a></div>
</div>
<div id="ref-modularpuzzles" class="csl-entry">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">Modular, <span>‚Äú<span class="nocase">GPU Puzzles in Mojo</span>.‚Äù</span> 2025. Available: <a href="https://builds.modular.com/puzzles/introduction.html">https://builds.modular.com/puzzles/introduction.html</a></div>
</div>
<div id="ref-GPUPuzzles" class="csl-entry">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">S. Rush, <span>‚Äú<span>GPU Puzzles</span>.‚Äù</span> 2023. Available: <a href="https://github.com/srush/GPU-Puzzles">https://github.com/srush/GPU-Puzzles</a></div>
</div>
<div id="ref-modular_democratizing_ai_compute" class="csl-entry">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline">C. Lattner and Modular, <span>‚ÄúDemocratizing AI compute.‚Äù</span> 2025. Available: <a href="https://www.modular.com/democratizing-ai-compute">https://www.modular.com/democratizing-ai-compute</a></div>
</div>
<div id="ref-dao_flashattention" class="csl-entry">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline">T. Dao, D. Y. Fu, S. Ermon, A. Rudra, and C. R√©, <span>‚ÄúFlashAttention: Fast and memory-efficient exact attention with IO-awareness,‚Äù</span> <em>arXiv preprint arXiv:2205.14135</em>, 2022, Available: <a href="https://arxiv.org/abs/2205.14135">https://arxiv.org/abs/2205.14135</a></div>
</div>
<div id="ref-llvmlayouttensor" class="csl-entry">
<div class="csl-left-margin">[6] </div><div class="csl-right-inline">Taei, <span>‚Äú<span class="nocase">Simplifying GPU Programming with Parametric Tile-Level Tensors In Mojo</span>.‚Äù</span> 2024. Available: <a href="https://llvm.org/devmtg/2024-10/slides/techtalk/Taei-Simplifying-GPU-Programming-with-Parametric-Tile-Level-Tensors-In-Mojo.pdf">https://llvm.org/devmtg/2024-10/slides/techtalk/Taei-Simplifying-GPU-Programming-with-Parametric-Tile-Level-Tensors-In-Mojo.pdf</a></div>
</div>
<div id="ref-mojotalk" class="csl-entry">
<div class="csl-left-margin">[7] </div><div class="csl-right-inline">Modular, <span>‚Äú<span class="nocase">Mojo: The Future of Systems Programming</span>.‚Äù</span> 2025. Available: <a href="https://youtu.be/5gPG7SXoBag?si=H_kbkzbqfZHvNQSy&amp;t=1731">https://youtu.be/5gPG7SXoBag?si=H_kbkzbqfZHvNQSy&amp;t=1731</a></div>
</div>
<div id="ref-jeffniutriton" class="csl-entry">
<div class="csl-left-margin">[8] </div><div class="csl-right-inline">J. Niu, <span>‚Äú<span class="nocase">Triton Clone in Mojo</span>.‚Äù</span> 2025. Available: <a href="https://youtu.be/zUwyO2PZisw?si=QLdX_cAXDBcJH4mu">https://youtu.be/zUwyO2PZisw?si=QLdX_cAXDBcJH4mu</a></div>
</div>
</div></section></div> ]]></description>
  <category>programming</category>
  <category>gpu</category>
  <category>mojo</category>
  <guid>https://shubhamg.in/posts/2025-07-06-gpu-puzzles-p1.html</guid>
  <pubDate>Sat, 05 Jul 2025 16:00:00 GMT</pubDate>
</item>
<item>
  <title>BERT + BM25 = BISON</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2020-08-31-bison.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<ul>
<li>This paper aims to create a framework to map query and doc into semantic vectors via self-attention models.</li>
<li>We cant use prior knowledge about important tokens for models based on self-attention.
<ul>
<li>Words are split into different tokens using a tokenization mechanism such as WordPiece. We cannot translate word-level knowledge into different tokens.</li>
</ul></li>
<li>However, from classical information retrieval, we know that prior knowledge about the word is important. For example, ERNIE used a Knowledge Graph to achieve SOTA on several GLUE tasks.</li>
<li>Furthermore, documents have different fields with varying degrees of importance such as text, header, filetypes, etc. We cannot combine these fields directly because their importance varies for a task.</li>
<li><strong>Key takeaways</strong>:
<ul>
<li>Combine BM25 to learn attention scores with Query(Q) and Key(K) matrices, which are used in self-attention.</li>
<li>Word weight sharing to reduce knowledge discrepancy between tokens and words.</li>
<li>Combine multiple fields by placing different fields in different segments using a BM25F, a variation of BM25.</li>
</ul></li>
</ul>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<ul>
<li>Using NN for doc retrieval has 2 approaches
<ul>
<li><strong>Siamese Networks</strong>: In this, we encode the given query <img src="https://latex.codecogs.com/png.latex?q"> and the document <img src="https://latex.codecogs.com/png.latex?d"> separately.</li>
<li><strong>Interactive Networks</strong>: In this, we encode the given query <img src="https://latex.codecogs.com/png.latex?q"> and the document <img src="https://latex.codecogs.com/png.latex?d"> together.</li>
</ul></li>
<li>For large scale document retrieval tasks dependent on vector search, siamese networks are preferred since we can encode multiple documents without a query offline. This ensures the overall document retrieval process is fast in production.</li>
<li>BISON is built using a Siamese Network architecture.</li>
</ul>
</section>
<section id="proposed-method" class="level1">
<h1>Proposed method</h1>
<section id="overview-of-bison" class="level2">
<h2 class="anchored" data-anchor-id="overview-of-bison">Overview of BISON</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/bison/bison_architecture.png" class="img-fluid figure-img"></p>
<figcaption>BISON Architecture</figcaption>
</figure>
</div>
<ul>
<li>The framework has 4 important parts:
<ul>
<li><strong>Word level BM25</strong>: In this, we prepend the <em>CLS</em> token to the query and use combined fields representation for the documents.</li>
<li><strong>Token level representation</strong>: As is the norm, we will use the token, position and segment embedding</li>
<li><strong>BISON Encoder</strong>: This will encode the query <em>q</em> and the document <em>d</em> into semantic spacy by siamese structure making it possible to serve the model online. The architecture consists of 3 stacked BISON layers.</li>
<li><strong>Scoring</strong>: The documents are scored using the cosine similarity metric.</li>
</ul></li>
</ul>
</section>
<section id="bison-encoder-weighted-self-attention" class="level2">
<h2 class="anchored" data-anchor-id="bison-encoder-weighted-self-attention">BISON Encoder: Weighted Self Attention</h2>
<ul>
<li>As we know from the original ‚ÄúAttention‚Äù paper, attention is computed using the query, key, and value matrices.</li>
<li>To the above, we will add the importance of tokens via BM25. We will introduce w_i and multiply with above attention to get new attention score i.e Weighted Self Attention <img src="https://latex.codecogs.com/png.latex?%20A_%7Bij%7D%5Ew%20=%20w_j%5Cfrac%7Bq_i.k_j%5ET%7D%7B%5Csqrt%7Bd%7D%7D%20"></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/bison/weighted_self_attention.png" class="img-fluid figure-img"></p>
<figcaption>Weighted Self Attention</figcaption>
</figure>
</div>
<ul>
<li>Mathematically, it is represented as:</li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?WeightedSelfAttention(Q,K,W,V)%20=%20softmax(W%20(.)%20%5Cfrac%7BQK%5ET%7D%7B%5Csqrt%7Bd%7D%7DV"></p>
<ul>
<li>WSA is the main block unit. Multiple such units are tacked to get the multi-head structure.</li>
<li>Rescaling by <img src="https://latex.codecogs.com/png.latex?W%5Eo">, we get <strong>Complex Weighted Self Attention(CWSA)</strong>.</li>
<li>A fully connected layer is added. In both CWSA and fully connected layer, layer norm and residual connections are used</li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?CWSA%20=%20Concat(WeightedSelfAttention1,...%20WeightedSelfAttention,%20n)W%5Eo"></p>
<p><img src="https://latex.codecogs.com/png.latex?CWSA_%7Bout%7D=LayerNorm(CWSA%20+%20X)"></p>
<p><img src="https://latex.codecogs.com/png.latex?BISONEncoder%20=%20LayerNorm(CWSA_%7Bout%7D%20+%20FeedForward(CWSA_%7Bout%7D))"></p>
</section>
<section id="bm25-weight-generation" class="level2">
<h2 class="anchored" data-anchor-id="bm25-weight-generation">BM25 Weight generation</h2>
<ul>
<li>Use BM25 for weight scores in query and BM25F for weight scores in multi-field documents</li>
<li>BM25F, a variation of BM25, is for documents with different fields, each having different importance in terms of relevance saturation and length normalization. Find additional details in the file <a href="https://web.stanford.edu/class/cs276/handouts/lecture12-bm25etc.pdf">here</a>.</li>
</ul>
<section id="inherent-query-bm25" class="level3">
<h3 class="anchored" data-anchor-id="inherent-query-bm25">Inherent Query BM25</h3>
<ul>
<li>For a given query, BM25 is calculated within the query.
<ul>
<li><img src="https://latex.codecogs.com/png.latex?l_q">: query length</li>
<li><img src="https://latex.codecogs.com/png.latex?avl_q">: query average length along collection</li>
</ul></li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?%0Aw_i%5E%7BBM25%7D%20=%20idf_i%20%5Cfrac%7Btf_i%7D%7Btf_i%20+%20k_1(1-b+b%20%5Cfrac%7Bl_q%7D%7Bavl_q%7D)%7D%0A"></p>
</section>
<section id="inherent-document-bm25f" class="level3">
<h3 class="anchored" data-anchor-id="inherent-document-bm25f">Inherent Document BM25F</h3>
<ul>
<li>BM25F is implemented by assigning different degrees of importance to the different zones in a document such as title, header, footer, filetype, text, etc. For a <img src="https://latex.codecogs.com/png.latex?word_j"> in a document field <img src="https://latex.codecogs.com/png.latex?c">, it‚Äôs frequency <img src="https://latex.codecogs.com/png.latex?f_j%5Ec"> is defined as:</li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?%0Aatf_j%5Ec%20=%20%5Cfrac%7Bfw_c%20.%20tf_j%5Ec%7D%7B1.0%20+%20fln_c%20.%20(%5Cfrac%7Bfl_c%7D%7Bavl_c%7D-1.0)%7D%0A"></p>
<ul>
<li>The corresponding BM25F score is computed as</li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?%0Aw_j%5E%7BBM25F%7D%20=%20idf_j%5Cfrac%7Batf_j%7D%7Bk_1%20+%20atf_j%7D%0A"></p>
</section>
</section>
<section id="whole-word-weight-sharing" class="level2">
<h2 class="anchored" data-anchor-id="whole-word-weight-sharing">Whole word weight sharing</h2>
<ul>
<li>BERT uses wordpiece to produce tokens from raw text. However, because of this, we cannot directly apply the prior knowledge we obtained from B-52.</li>
<li><strong>Solution</strong>: Assign the <em>same</em> word weight to all tokens for a given word. This way, a token might have a different weight depending on the context of the given word.</li>
</ul>
</section>
<section id="combined-fields-representation" class="level2">
<h2 class="anchored" data-anchor-id="combined-fields-representation">Combined Fields Representation</h2>
<ul>
<li>Documents typically consist of different fields, each of which provides complementary information. Thus, these fields need to be taken into consideration. Typical fields considered are:
<ul>
<li>Primitive Fields(Title, URL, header, etc.)</li>
<li>Other fields(anchor, click signal via parsing search log, etc)</li>
</ul></li>
<li>For the experiment, only the following fields were picked for performance reasons(the body has too much text to encode in a single space):
<ul>
<li>Title</li>
<li>Anchor</li>
<li>URL</li>
<li>Clicked query</li>
</ul></li>
<li>For each field, we learn their representation individually and combine them. Further, we also restrict the number of tokens for each of the above fields to a total of 128 tokens.
<ul>
<li>20 tokens each for Title, Anchor and URL.</li>
<li>Only consider the top 5 clicked queries for a maximum of 68 tokens.</li>
</ul></li>
<li>For given fields, the document representation <img src="https://latex.codecogs.com/png.latex?%5Cphi(D)"> is given by:</li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cphi(D)%20=%20A_%7Bf_i%7D(%5Cphi_%7BF_1%7D(F_1)+%20%5Cphi_%7BF_2%7D(F_2)+...+%5Cphi_%7BF_n%7D(F_n))%0A"></p>
<ul>
<li>Here,
<ul>
<li><img src="https://latex.codecogs.com/png.latex?F_i"> is the field</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Cphi(F_1)"> denotes the representation learned for each field <img src="https://latex.codecogs.com/png.latex?F_i"></li>
<li><img src="https://latex.codecogs.com/png.latex?A_%7Bf_i%7D"> is a function to aggregate all representations</li>
</ul></li>
<li>The remaining tokens(512-128=384) are used to encode the query.</li>
</ul>
</section>
<section id="optimization" class="level2">
<h2 class="anchored" data-anchor-id="optimization">Optimization</h2>
<ul>
<li>The [CLS] token from the last layer is used as a representation for the query and the document</li>
<li>Matching score <img src="https://latex.codecogs.com/png.latex?s"> is computed as: <img src="https://latex.codecogs.com/png.latex?%0As%20=%20cos(BISON(query)_%7Blast%20cls%7D,%20BISON(document)_%7Blast%20cls%7D)%0A"></li>
<li>Cross entropy loss is used to determine if the retrieved document is relevant or not. <img src="https://latex.codecogs.com/png.latex?%0ALoss%20=%20-ylog(%5Cdelta(w.s+b))-(1-y)log(1%20-%20%5Cdelta(w.s+b))%0A"></li>
</ul>
</section>
</section>
<section id="experimentation" class="level1">
<h1>Experimentation</h1>
<ul>
<li>Datasets used were the Bing internal query set and public datasets.</li>
<li>Evaluation metrics used are NDCG(normalized Discounted Cumulative Gain) and NCG(Normalized Cumulative Gain) and MRR(Mean Reciprocal Rank)</li>
<li><strong>NCE(Noise Contraction Estimation)</strong>
<ul>
<li>It is used to pick negative samples that are competitive with the correct ones, helping improve the model generalization.</li>
</ul></li>
<li><strong>Hard negative Integration</strong>
<ul>
<li>Adding negative samples from the clicked documents only helps the model learn entirely non-related query-document pairs.</li>
<li>To help learn partially related pairs, queries are samples from the search log, and results from these queries are added to the negative samples set.</li>
</ul></li>
</ul>
</section>
<section id="evaluation" class="level1">
<h1>Evaluation</h1>
<ul>
<li>The following models were used as baselines:
<ul>
<li>TF-IDF and BM25: To present performance for standard information retrieval</li>
<li>USE and C-DSSM: To represent sentence embeddings for information retrieval</li>
<li>BERT and XLNET: To represent models from the pre-training era. <img src="https://shubhamg.in/posts/bison/bison_performance.png" class="img-fluid" alt="BISON Performance"></li>
</ul></li>
</ul>
<section id="intrinsic-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="intrinsic-evaluation">Intrinsic evaluation</h2>
<ul>
<li>Selected 1400 representative queries and 7 million query document pairs from Bing‚Äôs search log</li>
<li>Performance-wise, USE performs the worst as it performs well only on homogeneous data, and query document pairs are heterogeneous.</li>
<li>BISON outperforms all baseline models significantly.</li>
</ul>
</section>
<section id="ms-marco" class="level2">
<h2 class="anchored" data-anchor-id="ms-marco">MS Marco</h2>
<ul>
<li>Similar steps followed for document full ranking task on the MS Marco dataset.</li>
<li>For each query, the top 1000 documents are returned and MR is used as performance metrics.</li>
</ul>
</section>
</section>
<section id="ablation-experiments" class="level1">
<h1>Ablation Experiments</h1>
<ul>
<li>To test the effectiveness of the main parts of BISON, 3 variants are created and tested:
<ul>
<li>BISON<img src="https://latex.codecogs.com/png.latex?_%7Btw%7D">: Use token level weight generation.</li>
<li>BISON<img src="https://latex.codecogs.com/png.latex?_%7Bus%7D">: Exclude combined fields representation and use a union segment i.e concatenate all fields as one segment.</li>
<li>BISON<img src="https://latex.codecogs.com/png.latex?_%7Bidf%7D">: Use IDF as an alternative for BM25 <img src="https://shubhamg.in/posts/bison/bison_abalation.png" class="img-fluid" alt="BISON Abalation"></li>
</ul></li>
</ul>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<ul>
<li>Overall, this paper was a fun read, and the first time I‚Äôve seen a combination of classical information retrieval techniques with the newer pre-training based models.</li>
<li>In the future, I would also like to see:
<ul>
<li>Newer models such as Longformer and Reformer can process anywhere between 4000 to 32000 tokens in one iteration. It would be interesting to see if we could use these models can be used to encode the body text along with the combined field representation.</li>
<li>Popular search engines such as ElasticSearch and Solr have <strong>query reranking</strong> available, which returns relevant documents based on the primary simple query and then reranks the returned list using a secondary complex query. This would enable most organizations to index BISON vectors directly into the clusters, allowing them to see the benefits of BISON with minimal effort.</li>
</ul></li>
</ul>
</section>
<section id="resources" class="level1">
<h1>Resources</h1>
<p>There are some resources you can use to learn more about this paper such as:</p>
<ul>
<li>The original paper available <a href="https://arxiv.org/abs/2002.08909">here</a></li>
<li>The source code available <a href="https://github.com/cadobe/bison">here</a></li>
</ul>


</section>

 ]]></description>
  <category>nlp</category>
  <category>transformer</category>
  <category>review</category>
  <guid>https://shubhamg.in/posts/2020-08-31-bison.html</guid>
  <pubDate>Sun, 30 Aug 2020 16:00:00 GMT</pubDate>
</item>
<item>
  <title>LongFormer</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2020-05-11-longformer.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<ul>
<li>The NLP world had its ImageNet moment with the introduction of the Transformer in the paper <strong>Attention is All you Need</strong>.</li>
<li>The ability to be able to process multiple words/tokens in parallel and train models without labeled data(using self-attention) led to the creation of multiple models which gave us SOTA results on many interesting tasks such as Question Answering, Summarization, etc.</li>
<li>However, the biggest drawback is the Transformer architecture is the limitation it has on the number of tokens it can process at a once, due to exponentially increasing memory and compute requirements(typically about 512 tokens), causing the performance to deteriorate over large documents.</li>
<li><a href="https://arxiv.org/abs/2004.05150">Longformer</a> by the team at Allen AI aims to address this problem and demonstrate it‚Äôs application to do transfer learning for large documents.</li>
<li>Other approaches to are described in recent work such as <a href="https://arxiv.org/abs/1901.02860">Transformer XL</a>, <a href="https://arxiv.org/abs/1911.02972">Blockwise</a>, <a href="https://arxiv.org/abs/2001.04451">Reformer</a>, etc. Their characteristics are mentioned below:</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/longformer/comparison.png" class="img-fluid figure-img"></p>
<figcaption>Comparison<span data-label="fig:overview"></span></figcaption>
</figure>
</div>
</section>
<section id="key-contributions" class="level1">
<h1>Key Contributions</h1>
<ul>
<li>Transformers are expensive because of the massive matrix operations involved in the self-attention step. Since each token can attend to every other token in the given input, we get a runtime of <img src="https://latex.codecogs.com/png.latex?O(n%5E2)">, where <img src="https://latex.codecogs.com/png.latex?n"> is the sequence length(typically 512 tokens).</li>
<li>LongFormer aims to solve this using a form of sparse attention and reducing the operational complexity to <img src="https://latex.codecogs.com/png.latex?O(n)">. They achieve this using the concept of the sliding window and dilated sliding window.</li>
<li>The authors also show how this attention pattern can be modified (using dilation and global attention) on a per-task basis, thereby allowing us to use a single model for all tasks rather than creating task-specific architectures.</li>
</ul>
</section>
<section id="attention-patterns" class="level1">
<h1>Attention Patterns</h1>
<ul>
<li>The attention patterns implemented are as follows: <img src="https://shubhamg.in/posts/longformer/attention.png" class="img-fluid" alt="Attention"></li>
</ul>
<section id="sliding-window-attention" class="level2">
<h2 class="anchored" data-anchor-id="sliding-window-attention">Sliding Window Attention</h2>
<ul>
<li><strong>TLDR</strong> : Similar to kernels for CNN which apply a matrix operation to a set of pixels and move onto the next set, apply attention to tokens in current window <em>only</em>.</li>
<li>In this, we change the attention objective to only focus on the tokens that occur in a context window <img src="https://latex.codecogs.com/png.latex?w">.</li>
<li>Each token will be able to attend to <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B2%7Dw"> number of tokens to it‚Äôs left and right.</li>
<li><strong>Question</strong>: But doesn‚Äôt this limit the number of tokens being taken into account to only the tokens in the window?
<ul>
<li>Yes, it does. This is why we stack multiple layers of self-attention. As shown in the image below, the green neuron learns from the first 3 tokens(Lionel, Messi, is). However, the brown neuron learns from the green, yellow, and red neuron, who together learn from the first 5 tokens. This way, we can apply attention to long sequences(Lionel, Messi, is, the, true).</li>
</ul></li>
<li>As with the CNN, we will have <img src="https://latex.codecogs.com/png.latex?l"> layers to this sliding window attention(multi-head attention) implemented to learn low level and high-level features. A balance should be found between the number of layers <img src="https://latex.codecogs.com/png.latex?l">(efficiency) and the window size <img src="https://latex.codecogs.com/png.latex?w">(model representation capacity).</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/longformer/sliding_window.png" class="img-fluid figure-img"></p>
<figcaption>Sliding Window Attention<span data-label="fig:overview"></span></figcaption>
</figure>
</div>
<ul>
<li><p><strong>Pros</strong>: Reduces computation from <img src="https://latex.codecogs.com/png.latex?O(n%5E2)"> to <img src="https://latex.codecogs.com/png.latex?O(n*w)"> i.e the computation complexity will only scale linearly now.</p></li>
<li><p><strong>Cons</strong>: To learn dependencies for a large sequence, we would either have to increase the window size <img src="https://latex.codecogs.com/png.latex?w"> or increase the number of layers <img src="https://latex.codecogs.com/png.latex?l">, both of which will cause an increase in the amount of memory and processing power required to train and test the model.</p></li>
</ul>
</section>
<section id="dilated-sliding-window" class="level2">
<h2 class="anchored" data-anchor-id="dilated-sliding-window">Dilated Sliding Window</h2>
<ul>
<li><p><strong>TLDR</strong>: Use dilation instead of window attention i.e for some particular window size, take alternate elements while performing self-attention.</p></li>
<li><p>To solve the problem for long sequences, the authors propose that instead of considering all tokens in window <img src="https://latex.codecogs.com/png.latex?w">, consider alternate(or any number <img src="https://latex.codecogs.com/png.latex?d">)tokens instead. The range of tokens will now be <img src="https://latex.codecogs.com/png.latex?l%20*%20d%20*%20w">, which will be large for even a small value of <img src="https://latex.codecogs.com/png.latex?d">.</p></li>
<li><p><strong>Pros</strong>: This small change will allow us to cover a wider range of tokens without significant changes to the architecture.</p></li>
<li><p><strong>Cons</strong>: Skipping tokens might lead to loss of information in the lower layers which will get propagated to the higher layers. This will lead to unstable training and poor model performance.</p></li>
</ul>
</section>
<section id="global-attention" class="level2">
<h2 class="anchored" data-anchor-id="global-attention">Global Attention</h2>
<ul>
<li><strong>TLDR</strong>: Use full attention for certain tokens depending on the task. This is an engineering choice.</li>
<li>In BERT style models, optimal representation for input sequence varies by task.
<ul>
<li>For MLM, local context is used to predict the masked word</li>
<li>For classification, [CLS] token is used.</li>
<li>For QnA, the question is concatenated with the document to help model learn through self-attention.</li>
</ul></li>
<li>The windowed and dilated attention is not flexible enough to learn task-specific representations.</li>
<li>Hence, for some tokens enable global tokens i.e at these tokens, all tokens in the sequence can attend to it. For classification, enable global attention on the [CLS] token.</li>
<li><strong>Pros</strong>:
<ul>
<li>Adding global attention improves performance for specific tasks. Since these tokens are limited in number, the complexity still stays at <img src="https://latex.codecogs.com/png.latex?O(n)">.</li>
<li>It also increases the representational power of the model.</li>
</ul></li>
</ul>
<section id="linear-projections" class="level3">
<h3 class="anchored" data-anchor-id="linear-projections">Linear Projections</h3>
<ul>
<li><p><strong>TLDR</strong>: Use two sets of Q,K and V matrices, one for sliding window attention, one for global attention.</p></li>
<li><p>Attention is defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AAttention(Q,K,V)%20=%20softmax(%5Cfrac%7BQK%5ET%7D%7B%5Csqrt%7Bd_k%7D%7D)V%0A%5Cend%7Baligned%7D%0A"></p></li>
<li><p>We will use two different sets of Q,K and V matrices for sliding window and global attention.</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?Q_g">, <img src="https://latex.codecogs.com/png.latex?K_g">, <img src="https://latex.codecogs.com/png.latex?V_g"> are initialized with <img src="https://latex.codecogs.com/png.latex?Q_s">, <img src="https://latex.codecogs.com/png.latex?K_s">, <img src="https://latex.codecogs.com/png.latex?V_s"></p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/longformer/old_matrix.svg" class="img-fluid figure-img"></p>
<figcaption>Banded Matrix</figcaption>
</figure>
</div>
<center>
<b>Banded Matrix(<a href="https://en.wikipedia.org/wiki/Band_matrix">Source</a>)</b>
</center>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/longformer/band_matrix.svg" class="img-fluid figure-img"></p>
<figcaption>Compressed Banded Matrix</figcaption>
</figure>
</div>
<center>
<b>Compressed Banded Matrix(<a href="https://en.wikipedia.org/wiki/Band_matrix">Source</a>)</b>
</center>
</section>
<section id="cuda-kernels" class="level3">
<h3 class="anchored" data-anchor-id="cuda-kernels">CUDA Kernels</h3>
<ul>
<li>One of the important and interesting contributions of this paper is the implementation of matrix multiplication via CUDA kernels.</li>
<li>In the dilated sliding window, the matrix formed is called a <strong>band matrix</strong> i.e there are diagonal bands of indices that have values and the other values are 0.</li>
<li>Implementing matrix operations for band matrices using native for loops and via frameworks is not easy and optimized.</li>
<li>The authors have provided custom CUDA kernels implemented using <a href="https://github.com/apache/incubator-tvm">TVM</a> for this banded matrix operations.</li>
<li>As demonstrated in the image below, the custom CUDA kernels have a significant impact on the time and memory consumption of the model. The kernels and implementation for the longformer are available <a href="https://github.com/allenai/longformer">here</a>. <img src="https://shubhamg.in/posts/longformer/performance.png" class="img-fluid" alt="Performance">
<center>
<b>LongFormer Performance</b>
</center></li>
</ul>
</section>
</section>
</section>
<section id="autoregressive-language-modelling" class="level1">
<h1>Autoregressive Language Modelling</h1>
<ul>
<li>Estimate the probability of a token given its previous tokens/characters in an input sequence.</li>
<li>It is a fundamental task in natural language and all previous work use this task as their primary evaluation measure.</li>
</ul>
<section id="attention-pattern" class="level2">
<h2 class="anchored" data-anchor-id="attention-pattern">Attention Pattern</h2>
<ul>
<li>In multi-head attention, each head computes a different score.</li>
<li>To get a good representation of all tokens, the authors propose that normal sliding window attention can be used for the lower layers, and dilated sliding window attention can be used the higher layers(top 1-2 layers).</li>
<li>The reasoning for this approach is that in the lower layers, the local context is more important, and in the upper layers, the global context is more important. Hence, it is acceptable to skip over a few tokens in the upper layers.</li>
</ul>
</section>
</section>
<section id="experimental-setup" class="level1">
<h1>Experimental Setup</h1>
<section id="task-and-datasets" class="level2">
<h2 class="anchored" data-anchor-id="task-and-datasets">Task and Datasets</h2>
<ul>
<li>The authors focus on character level modeling because the sequences are naturally longer than those of word-level language modeling.</li>
<li>Datasets that were used are <em>text8</em> and <em>enwik8</em>.</li>
</ul>
</section>
<section id="training-and-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="training-and-evaluation">Training and Evaluation</h2>
<ul>
<li>The model was trained in multiple phases.
<ul>
<li>The window and sequence length was increased in each phase. This is to allow local context from tokens to be learned efficiently.</li>
<li>Overall five training phases used, starting from the token length of 2048 to 23040 (45x more than vanilla BERT).</li>
<li>Two models were created for evaluation:
<ul>
<li>Small model: 12 layers, 512 hidden size</li>
<li>Large model: 30 layers, 512 hidden sizes (2.5x larger)</li>
</ul></li>
<li>During the model evaluation, the model can run on a sequence length of 32256(63x more than vanilla BERT).</li>
</ul></li>
</ul>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/longformer/results.png" class="img-fluid figure-img"></p>
<figcaption>Results</figcaption>
</figure>
</div>
<ul>
<li>Longformer achieves SOTA using the small models with BPC of 1.10 and 1.00 for text8 and enwik8.</li>
<li>The large model was only tested on enwik8 due to the computational cost of training.</li>
<li>It‚Äôs also important to note that, while the large model did not achieve SOTA, it performs much better than it‚Äôs counterparts who have almost 2x more parameters.</li>
</ul>
</section>
</section>
<section id="pretraining-and-finetuning" class="level1">
<h1>Pretraining and Finetuning</h1>
<ul>
<li>The LongFormer is trained to solve the tasks of classification, QA, and coreference resolution.</li>
<li>It is trained with MLM objective.</li>
</ul>
<section id="copy-initialization-trick" class="level2">
<h2 class="anchored" data-anchor-id="copy-initialization-trick">Copy initialization trick</h2>
<ul>
<li>Since the MLM objective pretraining objective is expensive, the authors continue to train from the checkpoints of the <a href="https://arxiv.org/abs/1907.11692">RoBERTA</a> model.</li>
<li>The attention mechanism is replaced with the new attention module.</li>
<li>For the position embeddings:
<ul>
<li>RoBERTA has position embeddings for 512 tokens.</li>
<li>LongFormer can support position embeddings for 4096 tokens(larger for larger GPU)</li>
<li>To use the weight checkpoints from RoBERTA, instead of random initialization, copy the 512 position embeddings <strong>multiple times</strong> as analysis of the BERT attention heads showed a strong learned bias to attend to the local context.</li>
</ul></li>
</ul>
</section>
<section id="pretraining" class="level2">
<h2 class="anchored" data-anchor-id="pretraining">Pretraining</h2>
<ul>
<li>Apart from the datasets(Books corpus + English Wikipedia) used in RoBERTA, <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B3%7D%5E%7Brd%7D"> Realnews dataset was added with tokens larger than 1200.</li>
<li>Both models(small and large) trained with varying gradient updates.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/longformer/copy_init.png" class="img-fluid figure-img"></p>
<figcaption>Copy init</figcaption>
</figure>
</div>
<center>
<b>MLM BPC for RoBERTA with various model config</b>
</center>
</section>
</section>
<section id="task-specific-results" class="level1">
<h1>Task-Specific Results</h1>
<ul>
<li>Main results are summarized below: <img src="https://shubhamg.in/posts/longformer/main_results.png" class="img-fluid" alt="Copy init">
<center>
<b>LongFormer Task Specific Results</b>
</center></li>
<li>The performance gain is high for tasks that require long contexts such as WikiHop and Hyperpartisan.</li>
<li>For TriviaQA, the improvement is small because the local context is often sufficient to answer the given question.</li>
<li>Similarly, gains in IMDB and OntoNotes are small(because of majority short reviews for IMDB and low distance between any two mentions for OntoNotes).</li>
<li>However, the LongFormer large model achieves SOTA on WikiHop and TriviaQA.</li>
<li>Using the large model also improves performance on HotpotQA.</li>
</ul>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<ul>
<li>Overall, this was a fun read. The changes introduced in the attention mechanism are fairly simple but they yield very high-performance gains, paving the path to make these models useful in future applications.</li>
<li>Personally, and also as noted by the authors, I would like to see the performance of the LongFormer on the summarization task.</li>
</ul>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li>Fantastic summary by Yannic Kilcher available <a href="https://www.youtube.com/watch?v=_8KNb5iqblE">here</a>.</li>
<li>LongFormer paper available <a href="https://arxiv.org/abs/2004.05150">here</a></li>
<li>Dair.ai NLP newsletter available <a href="https://dair.ai/NLP_Newsletter_10_en/">here</a></li>
<li>Open-sourced longformer code available <a href="https://github.com/allenai/longformer/">here</a></li>
</ul>


</section>

 ]]></description>
  <category>nlp</category>
  <category>transformer</category>
  <category>review</category>
  <category>longformer</category>
  <guid>https://shubhamg.in/posts/2020-05-11-longformer.html</guid>
  <pubDate>Sun, 10 May 2020 16:00:00 GMT</pubDate>
</item>
<item>
  <title>TagLM</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2020-04-23-tag-lm.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<ul>
<li><p>This is the TagLM paper mentioned in Lecture 13 in the CS224N course title <strong>Semi-supervised sequence tagging with bidirectional language models</strong></p></li>
<li><p>This paper demonstrates how we can use context embeddings from BiLSTM models and use it for sequence labelling tasks</p></li>
</ul>
</section>
<section id="paper-introduction" class="level1">
<h1>Paper Introduction</h1>
<ul>
<li><p>Typically, RNN are used only on labelled data to learn the context embeddings of words.</p></li>
<li><p>Semi supervised approach used in this paper.</p>
<ul>
<li><p>Train LM on large unlabelled corpus</p></li>
<li><p>Compute embedding at each position in the sequence(LM embedding)</p></li>
<li><p>Use embedding in supervised sequence tagging model</p></li>
</ul></li>
<li><p>Using both forward and backward embeddings gives better performance than using forward only LM.</p></li>
</ul>
</section>
<section id="taglm" class="level1">
<h1>TagLM</h1>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<ul>
<li><p>Extract word and LM embeddings for every token</p></li>
<li><p>Prepare embedding by concatinating both embeddings</p></li>
<li><p>se them in supervised sequence tagging model</p></li>
</ul>
</section>
<section id="baseline" class="level2">
<h2 class="anchored" data-anchor-id="baseline">Baseline</h2>
<ul>
<li><p>Baseline model is hierachical neural tagging model</p></li>
<li><p>Obtain word and character embeddings. Concatenate them to form final embedding.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20x_k%20=%20%5Bc_k;w_k%5D%20"></p></li>
<li><p>Char embedding: Can be obtained via CNN or RNN</p></li>
<li><p>Word embedding: Use pretrained embeddings</p></li>
<li><p>Use multiple bidirectional RNN to learn context embedding</p></li>
<li><p>For every token, concatenate forward and backward hidden states at each layer</p></li>
<li><p>2nd layer will use the above output and predict next hidden state</p></li>
<li><p>Use GRU or LSTM depending on task</p></li>
<li><p>Use output of final layer to predict score for each possible tag using dense layer</p></li>
<li><p>Better to predict tags for full sequence than for a single token</p></li>
<li><p>THEREFORE, add another layer with parameters for each label bigram.</p></li>
<li><p>Compute sentence conditional random field loss(CRF) using forward-backward algorithm.</p></li>
<li><p>Use Viterbi algorithm to find most likely sequence</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/taglm/overview.png" class="img-fluid figure-img"></p>
<figcaption>Overview of architecture<span data-label="fig:overview"></span></figcaption>
</figure>
</div></li>
<li><p>LM embedding will be created by concatenating forward and backward embeddings. No parameter sharing between these two embeddings.</p></li>
</ul>
</section>
</section>
<section id="experiments" class="level1">
<h1>Experiments</h1>
<ul>
<li><p>Evaulation done on CoNLL 2003 NER and CoNLL 2000 chunking</p></li>
<li><p>Lot of detail around model architecture and training methods. Skipping this for now.</p></li>
</ul>
<section id="analysis" class="level2">
<h2 class="anchored" data-anchor-id="analysis">Analysis</h2>
<ul>
<li><p>Second RNN captures interactions between task specific context</p></li>
<li><p>Backward LM addition has significant performance gains</p></li>
<li><p>Model size makes a difference. Using bigger CNN model lead to &nbsp;0.3 percent improvement</p></li>
<li><p>Also tried training the model JUST ON THE CoNLL data. Reduced model size</p></li>
<li><p>Including embeddings from this model <strong>decreased</strong> performance compared to baseline system.</p></li>
<li><p>Replacing task specific RNN with using LM embeddings with a dense layer and CRF <strong>reduced</strong> performance</p></li>
<li><p>Improvement shown by transferring knowledge from other tasks <strong>almost disappers</strong> when the initial model is trained on a large dataset.</p></li>
</ul>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<ul>
<li>First method to incorporate contextual word embeddings using bidirectional networks.</li>
<li>Significantly better than other methods at the time that use other forms of transfer learning or joint learning on NER and and Chunking tasks.</li>
<li>It works well with unlabelled data from a different domain as well.</li>
</ul>


</section>

 ]]></description>
  <category>nlp</category>
  <category>language_model</category>
  <category>review</category>
  <guid>https://shubhamg.in/posts/2020-04-23-tag-lm.html</guid>
  <pubDate>Wed, 22 Apr 2020 16:00:00 GMT</pubDate>
</item>
<item>
  <title>T5‚Äôs Closed-Book Exam</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2020-04-21-knowledge-lm.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<ul>
<li><p>This is a new paper which explores the limits of using their new T5 titled <strong>How Much Knowledge Can You Pack Into The Parameters of a Language Model?</strong>. model in a context-free QA domain.</p></li>
<li><p>As with the T5 model itself, it is very interesting to see these one-model-to-rule-them-all architectures as they exhibit some form of generalization.</p></li>
<li><p>I found this paper from Adam Roberts twitter thread which is available <a href="https://twitter.com/ada_rob/status/1227062195671822336">here</a></p></li>
<li><p><strong>Core Idea</strong>: This paper will test two main things:</p>
<ul>
<li><p>How well does the model create a knowledge base such that it can answer questions just based on this base and no other information.</p></li>
<li><p>Do model with more parameters store more information? Measuring knowledge retreiving ability is used to check this point.</p></li>
</ul></li>
</ul>
</section>
<section id="paper-introduction" class="level1">
<h1>Paper Introduction</h1>
<ul>
<li><p><strong>Reading Comprehension</strong>: Given a question and context, lookup and give the answer.</p></li>
<li><p><strong>Open domain question answering</strong>: Random context-independent questions. It is given entire context(all the information possible in the world) and the model is expected to deduce the answer. <em>Open book</em> exam.</p></li>
<li><p>Here, problem is similar to open book exam + no context given at all. Model should retreive info from parameters and return the values. <em>Closed book</em> exam.</p></li>
<li><p>T5: Treat every NLP task as text-to-text problem using encoder decoder Transformer.</p></li>
<li><p>For natural questions dataset, evaluation is done as follows:</p></li>
<li><p><strong>First method</strong>:</p>
<ul>
<li><p>Ignore all ‚Äúunanswerable‚Äù and ‚Äúlong answer‚Äù type questions.</p></li>
<li><p>model trained to output single answer</p></li>
<li><p>Questions with answers longer than 5 tokens are ignored</p></li>
<li><p>Answers normalized before comparsion</p></li>
<li><p>Answer is correct if it matches any of the annotated answers</p></li>
</ul></li>
<li><p><strong>Second method</strong>:</p>
<ul>
<li>Considered correct only if model predicts <em>all</em> the answers correctly</li>
</ul></li>
<li><p>For fine tuning, use AdaFactor Optimizer(need to read more about this one)</p></li>
</ul>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<ul>
<li><p>SOTA on Natural Questions(NQ) and WebQuestions(WQ) dataset. Worst performance on TriviaQA(TQA).</p></li>
<li><p>Performance increases with model size.</p></li>
<li><p>Guu et all(2020) performs better than T5 on NQ and WQ. Need to read this paper as well. It</p>
<ul>
<li><p>Retreives Revevant documents</p></li>
<li><p>Answers questions in end-to-end fashion</p></li>
</ul></li>
<li><p>Closed-book model seem to perform on par with open-book models, leading to new research directions.</p></li>
<li><p>For multiple answer type questions, T5 lower than SOTA BUT much better than baseline that was published with the paper. Therefore, T5 can perform well on these types of questions as well.</p></li>
</ul>
</section>
<section id="drawbacks" class="level1">
<h1>Drawbacks</h1>
<ul>
<li><p>Model is far too expensive to train.</p></li>
<li><p>Open-book models provide some indication of what information was used to answer the problem. HOWEVER, T5 just has a distribution over parameters that cannot be interpreted.</p></li>
<li><p>MLE does not gurantee the model will learn a fact. Therefore, difficult to ensure the model learns specific information during pre-training</p></li>
<li><p>Measure and improve performance on difficult QA tasks like DROP, which needs reasoning ability.</p></li>
</ul>


</section>

 ]]></description>
  <category>nlp</category>
  <category>language_model</category>
  <category>review</category>
  <guid>https://shubhamg.in/posts/2020-04-21-knowledge-lm.html</guid>
  <pubDate>Mon, 20 Apr 2020 16:00:00 GMT</pubDate>
</item>
<item>
  <title>Attention is all you need</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2020-04-20-attention.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<ul>
<li>This paper review is following the blog from Jay Alammar‚Äôs blog on the <strong>Illustrated Transformer</strong>. The blog can be found <a href="https://jalammar.github.io/illustrated-transformer/">here</a>.</li>
</ul>
</section>
<section id="paper-introduction" class="level1">
<h1>Paper Introduction</h1>
<ul>
<li><p>New architecture based solely on attention mechanisms called <strong>Transformer</strong>. Gets rids of recurrent and convolution networks completely.</p></li>
<li><p>Generally, RNN used to seq-to-seq tasks such as translation, language modelling, etc.</p></li>
<li><p>Transformer allows for significant parallelization and relies only on attention.</p></li>
</ul>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<ul>
<li><em>Self attention</em> Attention to different positions of a sequence in order to compute a representation of the sequence.</li>
</ul>
</section>
<section id="model-architecture" class="level1">
<h1>Model Architecture</h1>
<ul>
<li><p>Transformer uses the following:</p>
<ul>
<li><p>Encoder decode mechanism</p></li>
<li><p>Stacked self attention</p></li>
<li><p>Point wise fully connected layer for encoder and decoder</p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/attention/transformer.png" class="img-fluid figure-img"></p>
<figcaption>Transformer<span data-label="fig:transformer"></span></figcaption>
</figure>
</div></li>
</ul>
<section id="encoder-and-decoder-stacks" class="level2">
<h2 class="anchored" data-anchor-id="encoder-and-decoder-stacks">Encoder and decoder stacks</h2>
<ul>
<li><p><strong>Encoder</strong>: 6 identical layers. 2 sub layers per layer</p></li>
<li><p><em>First</em>: multi-head self attention mechanism</p></li>
<li><p><em>Second</em>: Fully connected feed forward network</p></li>
<li><p>Apply residual connection for each of the two laters</p></li>
<li><p>Apply layer normalization</p></li>
<li><p><strong>Decoder</strong>: 6 identical layers. 2 sub layers as above + 1 more which performs multi-head attention over output of encoder stack</p></li>
<li><p><em>Residual blocks</em>: Present around all 3 sub layers</p></li>
<li><p><em>Layer normalization</em>: Normalizes input across features instead of normalizing input features across batch dimension(i.e in <em>batch normalization</em>). There is a great overview of normalization layers available by Akash Bindal <a href="https://medium.com/techspace-usict/normalization-techniques-in-deep-neural-networks-9121bf100d8">here</a>.</p></li>
<li><p>Modify self-attention sub layer to prevent positions from attending to subsequent positions. Ensures that <em>i</em> output depends only on words before <em>i</em>.</p></li>
</ul>
</section>
<section id="attention" class="level2">
<h2 class="anchored" data-anchor-id="attention">Attention</h2>
<ul>
<li><p>3 vectors: Query(Q), Key(K) and Value(V)</p></li>
<li><p>Output = Weighted sum of values. Weights assigned as a function of query with key.</p></li>
<li><p>Scaled dot-product attention and multi-head attention</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/attention/attention_types.png" class="img-fluid figure-img"></p>
<figcaption>Types of Attention<span data-label="fig:attention"></span></figcaption>
</figure>
</div></li>
<li><p>Attention is calculated as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20%20%20%20%20Attention(Q,K,V)%20=%20softmax(%5Cfrac%7BQK%5ET%7D%7B%5Csqrt%7Bd_k%7D%7D)V%0A%20%20%20"></p></li>
<li><p>Dot product attention is <strong>faster and more space-efficient</strong> than additive attention.</p></li>
</ul>
</section>
<section id="multi-head-attention" class="level2">
<h2 class="anchored" data-anchor-id="multi-head-attention">Multi head attention</h2>
<ul>
<li><p>Using multile q, k and v vectors. Get the final output, concatenate them and get another final projection <img src="https://latex.codecogs.com/png.latex?d_%7Bv%7D">.</p>
<p>$$ MultiHead(Q,K,V) = Concat(head_1,‚Ä¶,head_h)W^O \</p>
<pre><code>\text{where } head_i = Attention(QW_{i}^{Q}, KW_{i}^{K},VW_{i}^{V})</code></pre>
<p>$$</p></li>
<li><p>Dimensions of the key and value matrices will be: <img src="https://latex.codecogs.com/png.latex?d_%7Bk%7D%20=%20d_%7Bv%7D%20=%20d_%7Bmodel%7D/h%20=%2064"></p></li>
</ul>
</section>
<section id="applications-of-attention" class="level2">
<h2 class="anchored" data-anchor-id="applications-of-attention">Applications of attention</h2>
<ul>
<li><p><strong>Encoder-decoder attention</strong>: Q from previours decoder, K and V from output of decoder. Attend to all positions in the input sequence.</p></li>
<li><p><strong>Encoder</strong>: Self attentnion laters. Q,K and V from output of previous layer in the encoder. Some talk about leftward flow, didn‚Äôt really understand this bit. Will come back to this in sometime.</p></li>
</ul>
</section>
<section id="position-wise-feed-forward-networks" class="level2">
<h2 class="anchored" data-anchor-id="position-wise-feed-forward-networks">Position-wise Feed-Forward Networks</h2>
<ul>
<li><p>Each layer contains feed-forward network.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20%20%20%20%20%20%20FFN(x)%20=%20max(o,%20xW_1,+%20b_1)W_2%20+%20b_2%0A"></p></li>
</ul>
</section>
<section id="embeddings-and-softmax" class="level2">
<h2 class="anchored" data-anchor-id="embeddings-and-softmax">Embeddings and Softmax</h2>
<ul>
<li><p>Convert input and output string to vectors of dim <img src="https://latex.codecogs.com/png.latex?d_%7Bmodel%7D"></p></li>
<li><p>Share weight matrix between two embedding layers and the pre-softmaax linear transformation</p></li>
</ul>
</section>
<section id="positional-encoding" class="level2">
<h2 class="anchored" data-anchor-id="positional-encoding">Positional Encoding</h2>
<ul>
<li><p>Encode positions of the tokens for the input and output.</p></li>
<li><p>Same vector size i.e <img src="https://latex.codecogs.com/png.latex?d_%7Bmodel%7D"></p>
<p>$$ PE_{(pos, 2i)} = sin(pos/10000^{2i/d_{model}}) \</p>
<pre><code>    PE_{(pos, 2i+1)} = cos(pos/10000^{2i/d_{model}})</code></pre>
<p>$$</p></li>
<li><p>Might allow approximation of longer sequence lenghts than seen in the training set</p></li>
</ul>
</section>
<section id="why-self-attention" class="level2">
<h2 class="anchored" data-anchor-id="why-self-attention">Why self attention?</h2>
<ul>
<li><p>Total computational complexity per layer</p></li>
<li><p>Parallel Computation</p></li>
<li><p>Path length between long-range dependencies in the network.</p></li>
</ul>
</section>
</section>
<section id="training" class="level1">
<h1>Training</h1>
<section id="optimizer" class="level2">
<h2 class="anchored" data-anchor-id="optimizer">Optimizer</h2>
<ul>
<li><p>Use Adam. Vary learning rate according to formula: <img src="https://latex.codecogs.com/png.latex?lrate%20=%20d_%7Bmodel%7D%5E%7B-0.5%7D%20.%20min(step_num%5E%7B-0.5%7D,%20step_num%20.%20warmupsteps%5E%7B-1.5%7D)"></p></li>
<li><p>Increase LR for warmup steps, then decrease propotionally to inverse square root of step number. Warmup steps = 4000</p></li>
</ul>
</section>
<section id="regularization" class="level2">
<h2 class="anchored" data-anchor-id="regularization">Regularization</h2>
<ul>
<li><p><strong>Residual Dropout</strong></p></li>
<li><p><strong>Label Smoothing</strong>: Instead of using 0 and 1 as class labels, allow for some uncertainity in the prediction, and use values like 0.1 and 0.9 for the classes</p></li>
</ul>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<ul>
<li>This was the first model based entirely on attention. It acheived SOTA results on Machine Translation and English contituency parsing.</li>
</ul>


</section>

 ]]></description>
  <category>nlp</category>
  <category>attention</category>
  <category>review</category>
  <guid>https://shubhamg.in/posts/2020-04-20-attention.html</guid>
  <pubDate>Sun, 19 Apr 2020 16:00:00 GMT</pubDate>
</item>
<item>
  <title>REALM: Retrieval-Augmented Language MOdel Pre-Training</title>
  <dc:creator>Shubham Gupta</dc:creator>
  <link>https://shubhamg.in/posts/2020-03-14-realm.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<ul>
<li><p>REALM is a paper mentioned in the T5 paper titled: <strong>How Much Knowledge Can You Pack Into The Parameters of a Language Model?</strong></p></li>
<li><p>TLDR: This paper retrieves documents that have the information present while solving Question-Answer type problems.</p>
<blockquote class="blockquote">
<p><strong>NOTE</strong>: This post is more like my running notes while reading the paper than a comprehensive blog. I will update this blog once I learn a little more about the transformer architecture.</p>
</blockquote></li>
<li><p>Introduced a latent <em>knowledge retriever</em>, which can attend and retrieve documents over large corpus and can be trained in unsupervised manner using masked language modelling technique and backprop through retreiver which considers lots of docs.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/realm/training.png" class="img-fluid figure-img"></p>
<figcaption>Training process for REALM<span data-label="fig:training"></span></figcaption>
</figure>
</div></li>
<li><p>Key point: Train retriever using a performance-based signal from unsupervised text.</p></li>
<li><p>Retrieval based LM =&gt; Moar computational resources =&gt; Moar money</p>
<ul>
<li>Solution: Computation performed for each doc is cached and can be used again. Best doc selected using <em>Maximum Inner Product Search(MIPS)</em>. Read the paper <a href="https://cs.stanford.edu/~ermon/papers/ICML_MIPS_Gumbel.pdf">here</a>.</li>
</ul></li>
<li><p>REALM retriever can be used on downstream tasks via transfer learning.</p></li>
<li><p>REALM is SOTA on NQ-Open, WQ and CuratedTrec.</p></li>
</ul>
</section>
<section id="approach" class="level1">
<h1>Approach</h1>
<section id="retreive-then-predict-generative-process" class="level2">
<h2 class="anchored" data-anchor-id="retreive-then-predict-generative-process"><em>Retreive-then-predict generative process</em></h2>
<ul>
<li><p>Training: Masked-LM. Fine-tuning: Open QA task</p></li>
<li><p>Computing chance of the document given a question decomposed into two steps:</p>
<ul>
<li><p>Function to be computed: <img src="https://latex.codecogs.com/png.latex?p(y%5C%7Cx)"></p></li>
<li><p>Given <img src="https://latex.codecogs.com/png.latex?x">,retrive documents <img src="https://latex.codecogs.com/png.latex?z"> from corpus <img src="https://latex.codecogs.com/png.latex?Z">. Modelled as: <img src="https://latex.codecogs.com/png.latex?p(z%5C%7Cx)"></p></li>
<li><p>Condition of both <img src="https://latex.codecogs.com/png.latex?z"> and <img src="https://latex.codecogs.com/png.latex?x"> to generate output <img src="https://latex.codecogs.com/png.latex?y"> i.e <img src="https://latex.codecogs.com/png.latex?p(y%5C%7Cz,%20x)"></p></li>
<li><p>Overall likelihood <img src="https://latex.codecogs.com/png.latex?y"> is generated by treating <img src="https://latex.codecogs.com/png.latex?z"> as latent variable and marginalizing over all documents <img src="https://latex.codecogs.com/png.latex?z"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(y%5C%7Cx)%20=%20%5Csum_%7Bz%20%5Cepsilon%20Z%7D%20p(y%5C%7Cz,%20x)%20*%20p(z%5C%7Cx)%0A"></p></li>
</ul></li>
</ul>
</section>
</section>
<section id="architecture" class="level1">
<h1>Architecture</h1>
<ul>
<li><p><strong>Neural Knowledge Retriever</strong> which models the distribution: <img src="https://latex.codecogs.com/png.latex?p(z%5C%7Cx)"></p></li>
<li><p><strong>Knowledge Augmented Encoder</strong> which models the distribution <img src="https://latex.codecogs.com/png.latex?p(y%5C%7Cz,%20x)"></p></li>
</ul>
<section id="neural-knowledge-retriever" class="level2">
<h2 class="anchored" data-anchor-id="neural-knowledge-retriever">Neural Knowledge Retriever</h2>
<ul>
<li><p>Dense inner product model.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%20%20%20%20p(z%5C%7Cx)%20=%20%5Cfrac%7Bexp(f(x,z))%7D%7B%5Csum_%7Bz'%7D%7Bexp(f(x,z'))%7D%7D%20%5C%5C%0A%20%20%20%20f(x,z)%20=%20Embed_%7Binput%7D(x)%5ETEmbed_%7Bdoc%7D(z)%0A%5Cend%7Baligned%7D%0A"></p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?Embed_%7Binput%7D"> and <img src="https://latex.codecogs.com/png.latex?Embed_%7Bdoc%7D"> are embedding functions</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?f(x,z)"> is called <strong>relevance score</strong>. It is inner product of vector embeddings.</p></li>
<li><p>Relevant Distribution is softmax over all relevance scores</p></li>
<li><p>Embedding implement using BERT-style transformers. Join using &lt;SEP&gt;, prefix using &lt;CLS&gt; and append &lt;SEP&gt; as the end token. <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%20%20%20%20%20%20%20%20%5C%5C%20join_%7BBERT%7D(x)%20=%20%5BCLS%5Dx%5BSEP%5D%0A%20%20%20%20%20%20%20%20%5C%5C%20join_%7BBERT%7D(x_1,%20x_2)%20=%20%5BCLS%5Dx_1%5BSEP%5Dx_2%5BSEP%5D%0A%20%20%20%20%5Cend%7Baligned%7D"></p></li>
<li><p>Pass above into transformer, which gives over vector for each token. Perform linear projection to reduce dimensionality of vector <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Baligned%7D%0A%20%20%20%20%5C%5C%20Embed_%7Binput%7D(x)%20=%20W_%7Binput%7DBERT_%7BCLS%7D(join_%7BBERT%7D(x))%0A%20%20%20%20%5C%5C%20Embed_%7Bdoc%7D(z)%20=%20W_%7Bdoc%7DBERT_%7BCLS%7D(join_%7BBERT%7D(z_%7Btitle%7D,%20z_%7Bbody%7D))%0A%5Cend%7Baligned%7D"></p></li>
</ul>
</section>
<section id="knowledge-augmented-encoder" class="level2">
<h2 class="anchored" data-anchor-id="knowledge-augmented-encoder">Knowledge-Augmented Encoder</h2>
<ul>
<li><p>Given input <img src="https://latex.codecogs.com/png.latex?x"> and relevant doc <img src="https://latex.codecogs.com/png.latex?z">, this defines <img src="https://latex.codecogs.com/png.latex?p(y%5C%7Cz,x)"></p></li>
<li><p>Join <img src="https://latex.codecogs.com/png.latex?x"> and <img src="https://latex.codecogs.com/png.latex?z"> into single sequence and feed into transformer</p></li>
<li><p>Here, training is different for pre-training vs fine-tuning</p>
<ul>
<li><p>For pre-training, predict [MASK] token. Use same Masked LM(MLM) loss as in Transformer(Devlin et al.)</p></li>
<li><p>For Open-QA, we need to produce string <img src="https://latex.codecogs.com/png.latex?y">.</p></li>
<li><p><strong>Assumption</strong>: <img src="https://latex.codecogs.com/png.latex?y"> occurs as sequence of tokens in some document in the corpus.</p></li>
</ul></li>
</ul>
</section>
<section id="training" class="level2">
<h2 class="anchored" data-anchor-id="training">Training</h2>
<ul>
<li><p>Compute gradients in <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> and <img src="https://latex.codecogs.com/png.latex?%5Cphi"> and optimize using SGD.</p></li>
<li><p>Challenge: Computing <img src="https://latex.codecogs.com/png.latex?p(y%5C%7Cx)"></p></li>
<li><p>Approx by summing over top <img src="https://latex.codecogs.com/png.latex?k"> documents with highest prob under <img src="https://latex.codecogs.com/png.latex?p(z%5C%7Cx)"></p></li>
<li><p>Question: How to find top <img src="https://latex.codecogs.com/png.latex?k"> docs? Answer: Use MIPS</p></li>
<li><p>Need to precompute <img src="https://latex.codecogs.com/png.latex?Embed_%7Bdoc%7D(x)"> for all docs. Problem? It changes with each step of SGD.</p></li>
<li><p><em>Solution</em>: Async refresh <img src="https://latex.codecogs.com/png.latex?Embed_%7Bdoc%7D"> every 500 steps</p></li>
<li><p>Use MIPS to select top <img src="https://latex.codecogs.com/png.latex?k"> docs. For these docs, recompute <img src="https://latex.codecogs.com/png.latex?p(z%5C%7Cx)"> using new <img src="https://latex.codecogs.com/png.latex?%5Ctheta">.</p></li>
</ul>
<section id="implementing-async-mips-refreshes" class="level3">
<h3 class="anchored" data-anchor-id="implementing-async-mips-refreshes">Implementing async MIPS refreshes</h3>
<ul>
<li><p>Two jobs running in parallel:</p>
<ul>
<li><p><em>Primary trainer</em>: Perform gradient updates on parameters</p></li>
<li><p><em>Secondary index builder</em>: Embeds and indexes the docs</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://shubhamg.in/posts/realm/async_mips.png" class="img-fluid figure-img"></p>
<figcaption>Async MIPS implementation<span data-label="fig:async_mips"></span></figcaption>
</figure>
</div></li>
<li><p>Async refresh used only for pre-training</p></li>
<li><p>For fine tuning, build index once from pre-trained <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> and use it.</p></li>
</ul></li>
</ul>
</section>
<section id="what-does-retriever-learn" class="level3">
<h3 class="anchored" data-anchor-id="what-does-retriever-learn">What does retriever learn?</h3>
<ul>
<li><p>Retriever promotes docs that improve accuracy</p></li>
<li><p>This can be analyzed by analyzing gradient wrt the parameters</p></li>
</ul>
</section>
<section id="injecting-inductive-biases-into-pre-trianing" class="level3">
<h3 class="anchored" data-anchor-id="injecting-inductive-biases-into-pre-trianing">Injecting inductive biases into pre-trianing</h3>
<ul>
<li><p><strong>Salient span masking</strong>: Some questions require only local context. Select named entities and dates and mask one of them. Performs better.</p></li>
<li><p><strong>Null document</strong>: Add null document to top <img src="https://latex.codecogs.com/png.latex?k"> documents to allow answers even when no context is required</p></li>
<li><p><strong>Prohibiting trivial retrievals</strong>: If knowledge corpus <img src="https://latex.codecogs.com/png.latex?Z"> is the same as pre-training corpus <img src="https://latex.codecogs.com/png.latex?X">, it can predict <img src="https://latex.codecogs.com/png.latex?y"> by looking at <img src="https://latex.codecogs.com/png.latex?x"> in <img src="https://latex.codecogs.com/png.latex?z">. Exclude trivial candidate</p></li>
<li><p><strong>Initialization</strong>: Warm up <img src="https://latex.codecogs.com/png.latex?Embed_%7Binput%7D"> and <img src="https://latex.codecogs.com/png.latex?Embed_%7Bdoc%7D"> using Inverse Cloze Task(ICT) i.e model trained to retrieve the doc where the sentence came from.</p></li>
</ul>
</section>
</section>
</section>
<section id="experiments" class="level1">
<h1>Experiments</h1>
<ul>
<li>REALM outperforms all approaches by a big margin.</li>
</ul>
</section>
<section id="future-work" class="level1">
<h1>Future Work</h1>
<ul>
<li><p>Structured knowledge where we learn entities which are informative</p></li>
<li><p>Multi lingual setting. Retreiving knowledge in high resource language to better represent text in low resource language</p></li>
<li><p>Multi model setting. Retrieve images or videos that can provide knowledge not present in text</p></li>
</ul>
</section>
<section id="comments" class="level1">
<h1>Comments</h1>
<p>Overall, I enjoyed reading this paper. However, there are two key points that concern me:</p>
<ul>
<li>The authors mention using MIPS for selecting the top <img src="https://latex.codecogs.com/png.latex?k"> documents, in order to simplify the task. However, would selecting only these documents from the entire dataset not lead to some information loss? I would like to see more experiments around this area.</li>
<li>There are no experiments around trying out larger models. While I agree that T5 is the largest model available right now, there is no evidence given that a model larger than T5-large would not perform better than the current REALM model. I would like to see some more exploration around this area.</li>
</ul>
</section>
<section id="resources" class="level1">
<h1>Resources</h1>
<p>There are a number of other resources you can use to learn more about this paper such as:</p>
<ul>
<li>The original paper available <a href="https://arxiv.org/abs/2002.08909">here</a></li>
<li>Tweet summary by Adam Roberts available <a href="https://twitter.com/ada_rob/status/1227062195671822336">here</a></li>
<li>Video summary by V√°clav Ko≈°a≈ô available <a href="https://twitter.com/ada_rob/status/1227062195671822336">here</a></li>
<li>Huggingface Reading group summary by Joe Davidson available <a href="https://joeddav.github.io/blog/2020/03/03/REALM.html">here</a></li>
</ul>


</section>

 ]]></description>
  <category>nlp</category>
  <category>bert</category>
  <category>review</category>
  <guid>https://shubhamg.in/posts/2020-03-14-realm.html</guid>
  <pubDate>Fri, 13 Mar 2020 16:00:00 GMT</pubDate>
  <media:content url="https://shubhamg.in/posts/realm/training.png" medium="image" type="image/png" height="169" width="144"/>
</item>
<item>
  <title>Bayesian Golf Putting Model</title>
  <link>https://shubhamg.in/posts/2020-03-12-tutorial.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="disclaimer" class="level2">
<h2 class="anchored" data-anchor-id="disclaimer">Disclaimer</h2>
<p>This is inspired from Dr.&nbsp;Andrew Gelman‚Äôs case study, which can be found <a href="https://mc-stan.org/users/documentation/case-studies/golf.html">here</a>. Specifically:</p>
<ul>
<li>This is heavily inspired by Colin Caroll‚Äôs Blog present <a href="https://nbviewer.jupyter.org/github/pymc-devs/pymc3/blob/master/docs/source/notebooks/putting_workflow.ipynb">here</a>. A lot of the plotting code from his blog post has been reused.</li>
<li>Josh Duncan‚Äôs blog post on the same topic which can be found <a href="https://jduncstats.com/post/2019-11-02_golf-turing/">here</a>.</li>
</ul>
<p>This is not a novel solution. It is merely a replication of Dr.&nbsp;Gelman‚Äôs blog in PyMC3.</p>
</section>
<section id="problem" class="level2">
<h2 class="anchored" data-anchor-id="problem">Problem</h2>
<p>This is based on a popular blog post by Dr.&nbsp;Andrew Gelman. Here, we are given data from professional golfers on the proportion of success putts from a number of tries. Our aim is to identify:</p>
<blockquote class="blockquote">
<p>Can we model the probability of success in golf putting as a function of distance from the hole?</p>
</blockquote>
</section>
<section id="eda" class="level2">
<h2 class="anchored" data-anchor-id="eda">EDA</h2>
<div id="cell-6" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pymc3 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pm</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING (theano.tensor.blas): Using NumPy C-API based implementation for BLAS functions.</code></pre>
</div>
</div>
<p>The source repository is present <a href="https://github.com/stan-dev/example-models/tree/master/knitr/golf">here</a></p>
<div id="cell-8" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1443</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1346</span>],</span>
<span id="cb3-2">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">694</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">577</span>],</span>
<span id="cb3-3">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">455</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">337</span>],</span>
<span id="cb3-4">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">353</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">208</span>],</span>
<span id="cb3-5">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">272</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">149</span>],</span>
<span id="cb3-6">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">136</span>],</span>
<span id="cb3-7">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">111</span>],</span>
<span id="cb3-8">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">217</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">69</span>],</span>
<span id="cb3-9">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">67</span>],</span>
<span id="cb3-10">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">237</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>],</span>
<span id="cb3-11">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">202</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>],</span>
<span id="cb3-12">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">46</span>],</span>
<span id="cb3-13">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">174</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">54</span>],</span>
<span id="cb3-14">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">167</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>],</span>
<span id="cb3-15">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">201</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>],</span>
<span id="cb3-16">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">195</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31</span>],</span>
<span id="cb3-17">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">191</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>],</span>
<span id="cb3-18">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">147</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>],</span>
<span id="cb3-19">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">152</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>]])</span>
<span id="cb3-20"></span>
<span id="cb3-21">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(data, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb3-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, </span>
<span id="cb3-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tries'</span>, </span>
<span id="cb3-24">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'success_count'</span></span>
<span id="cb3-25">])</span></code></pre></div>
</div>
<div id="cell-9" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">df</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">distance</th>
<th data-quarto-table-cell-role="th">tries</th>
<th data-quarto-table-cell-role="th">success_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2</td>
<td>1443</td>
<td>1346</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3</td>
<td>694</td>
<td>577</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>4</td>
<td>455</td>
<td>337</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>5</td>
<td>353</td>
<td>208</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>6</td>
<td>272</td>
<td>149</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>7</td>
<td>256</td>
<td>136</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>8</td>
<td>240</td>
<td>111</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>9</td>
<td>217</td>
<td>69</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>10</td>
<td>200</td>
<td>67</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>11</td>
<td>237</td>
<td>75</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>12</td>
<td>202</td>
<td>52</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>13</td>
<td>192</td>
<td>46</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>14</td>
<td>174</td>
<td>54</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>15</td>
<td>167</td>
<td>28</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>16</td>
<td>201</td>
<td>27</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>17</td>
<td>195</td>
<td>31</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>18</td>
<td>191</td>
<td>33</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>19</td>
<td>147</td>
<td>20</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>20</td>
<td>152</td>
<td>24</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>The variables have the following format:</p>
<table class="table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Units</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>distance</td>
<td>feet</td>
<td>Distance from the hole for the putt attempt</td>
</tr>
<tr class="even">
<td>tries</td>
<td>count</td>
<td>Number of attempts at the chosen distance</td>
</tr>
<tr class="odd">
<td>success_count</td>
<td>count</td>
<td>The total successful putts</td>
</tr>
</tbody>
</table>
<p>Lets try to visualize the dataset:</p>
<div id="cell-12" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'success_prob'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.success_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> df.tries</span></code></pre></div>
</div>
<div id="cell-13" class="cell" data-scrolled="true" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">sns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb6-2">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb6-3">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.scatterplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'success_prob'</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb6-4">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distance from hole(ft)'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability of Success'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>[Text(0, 0.5, 'Probability of Success'),
 Text(0.5, 0, 'Distance from hole(ft)')]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-6-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can notice that the <strong>probability of success decreases as the distance increases.</strong></p>
</section>
</section>
<section id="baseline-model" class="level1">
<h1>Baseline Model</h1>
<p>Let us try to see we can fit a simple linear model to the data i.e Logsitic Regression. We will be using PyMC3.</p>
<p>Here, we will attempt to model the success of golf putting by using the distance as an independant(i.e predictor) variable. The model will have the following form:</p>
<p><strong><img src="https://latex.codecogs.com/png.latex?y_i%20%5Csim%20binomial(n_j,%20logit%5E%7B-1%7D(b_0%20+%20b_1x_j)),%20%5Ctext%7Bfor%20%7D%20j%20=%201,...J%20"></strong></p>
<div id="cell-18" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> pm.Model() <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> model:</span>
<span id="cb8-2">    b_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Normal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b_0'</span>, mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, sd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-3">    b_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Normal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b_1'</span>, mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, sd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-4">        </span>
<span id="cb8-5">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Binomial(</span>
<span id="cb8-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>, </span>
<span id="cb8-7">        n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.tries, </span>
<span id="cb8-8">        p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>pm.math.invlogit(b_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> df.distance), </span>
<span id="cb8-9">        observed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.success_count</span>
<span id="cb8-10">    )</span></code></pre></div>
</div>
<p>Why are we using inverse logit?</p>
<ul>
<li><strong>Logit</strong> is a function used to convert a continous variable to a value in the range [0,1]</li>
<li><strong>Inverse Logit</strong>: Used to convert real valued variable to a value in the range [0,1]</li>
</ul>
<div id="cell-20" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">pm.model_to_graphviz(model)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-8-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-21" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> model:</span>
<span id="cb10-2">    trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, tune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 2 jobs)
NUTS: [b_1, b_0]
Sampling 4 chains, 0 divergences: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 8000/8000 [00:06&lt;00:00, 1164.22draws/s]
The acceptance probability does not match the target. It is 0.889539212527967, but should be close to 0.8. Try to increase the number of tuning steps.
The acceptance probability does not match the target. It is 0.6968711559119489, but should be close to 0.8. Try to increase the number of tuning steps.
The number of effective samples is smaller than 25% for some parameters.</code></pre>
</div>
</div>
<div id="cell-22" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">pm.summary(trace)[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mean'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sd'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mcse_mean'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mcse_sd'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ess_mean'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r_hat'</span>]]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_mean</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">b_0</td>
<td>2.226</td>
<td>0.060</td>
<td>0.002</td>
<td>0.001</td>
<td>926.0</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">b_1</td>
<td>-0.255</td>
<td>0.007</td>
<td>0.000</td>
<td>0.000</td>
<td>838.0</td>
<td>1.01</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-23" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">pm.traceplot(trace)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>array([[&lt;matplotlib.axes._subplots.AxesSubplot object at 0x7fdfef7cfd68&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x7fdfef77efd0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x7fdfef848828&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x7fdfef758a58&gt;]],
      dtype=object)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-24" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">pm.plot_posterior(trace)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>array([&lt;matplotlib.axes._subplots.AxesSubplot object at 0x7fdfedd70be0&gt;,
       &lt;matplotlib.axes._subplots.AxesSubplot object at 0x7fdfedd2a860&gt;],
      dtype=object)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>From the above results, we can see:</p>
<ul>
<li>PyMC3 has estimated
<ul>
<li><img src="https://latex.codecogs.com/png.latex?b_0"> to be <img src="https://latex.codecogs.com/png.latex?2.23%20%5Cpm%200.057"></li>
<li><img src="https://latex.codecogs.com/png.latex?b_1"> to be <img src="https://latex.codecogs.com/png.latex?-0.26%20%5Cpm%200.007"></li>
</ul></li>
<li>The MCSE is almost 0 <img src="https://latex.codecogs.com/png.latex?%5Cimplies"> The simulation has run long enough for the chains to converge.</li>
<li><img src="https://latex.codecogs.com/png.latex?r%5C_hat%20=%201.0"> tells us that the chains have mixed well i.e hairy hedgehog pattern.</li>
</ul>
<p>Let us plot the final output of this model and check it with our training data.</p>
<div id="cell-26" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> model:</span>
<span id="cb17-2">    posterior_trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample_posterior_predictive(trace)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 4000/4000 [00:04&lt;00:00, 888.12it/s]</code></pre>
</div>
</div>
<div id="cell-27" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">posterior_success <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> posterior_trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> df.tries.values</span></code></pre></div>
</div>
<div id="cell-28" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'posterior_success_prob'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(posterior_success).median()</span>
<span id="cb20-2">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'posterior_success_prob_std'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(posterior_success).std()</span></code></pre></div>
</div>
<div id="cell-29" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">sns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb21-2">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb21-3">prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.success_count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>df.tries</span>
<span id="cb21-4">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.scatterplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.success_prob, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'actual'</span>)</span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ls = np.linspace(0, df.distance.max(), 200)</span></span>
<span id="cb21-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for index in np.random.randint(0, len(trace), 50):</span></span>
<span id="cb21-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     ax.plot(</span></span>
<span id="cb21-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         ls, </span></span>
<span id="cb21-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         scipy.special.expit(</span></span>
<span id="cb21-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#             trace['b_0'][index] * ls + trace['b_1'][index] * ls</span></span>
<span id="cb21-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         )</span></span>
<span id="cb21-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     )</span></span>
<span id="cb21-13">sns.scatterplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.posterior_success_prob, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'predicted'</span>,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb21-14">sns.lineplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.posterior_success_prob, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>)</span>
<span id="cb21-15">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distance from hole(ft)'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability of Success'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>[Text(0, 0.5, 'Probability of Success'),
 Text(0.5, 0, 'Distance from hole(ft)')]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-16-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The curve fit is okay, but it can be improved. We can use this as a baseline model. In reality, each of them is not a point, but an posterior estimate. Because the uncertainity is small(as seen above), we‚Äôve decided to show only the median points.</p>
<p>From the above model, putts from 50ft are expected to be made with probability:</p>
<div id="cell-31" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> scipy</span>
<span id="cb23-2">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> scipy.special.expit(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.223</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.255</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>).mean()</span>
<span id="cb23-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(res, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.00268 %</code></pre>
</div>
</div>
</section>
<section id="modelling-from-first-principles" class="level1">
<h1>Modelling from first principles</h1>
<section id="geometry-based-model" class="level2">
<h2 class="anchored" data-anchor-id="geometry-based-model">Geometry based Model</h2>
<p><img src="https://shubhamg.in/posts/my_icons/golf_tutorial/golf_ball_trajectory.png" class="img-fluid"></p>
<p>We‚Äôll try to accomodate the physics associated with the problem. Specically, we assume:</p>
<section id="assumptions" class="level5">
<h5 class="anchored" data-anchor-id="assumptions">Assumptions</h5>
<ul>
<li>The golfers can hit the ball in any direction with some small error. This error could be because of inaccuracy, errors in the human, etc.</li>
<li>This error refers to the angle of the shot.</li>
<li>We assume the angle is <strong>normally</strong> distributed.</li>
</ul>
<section id="implications" class="level6">
<h6 class="anchored" data-anchor-id="implications">Implications</h6>
<ul>
<li>The ball goes in whenever the angle is small enough for it to hit the cup of the hole!</li>
<li>Longer putt <img src="https://latex.codecogs.com/png.latex?%5Cimplies"> Larger error <img src="https://latex.codecogs.com/png.latex?%5Cimplies"> Lower success rate than shorter putt</li>
</ul>
<p>From Dr.&nbsp;Gelman‚Äôs blog, we obtain the formula as:</p>
<blockquote class="blockquote">
<p><img src="https://latex.codecogs.com/png.latex?Pr(%7Cangle%7C%20%3C%20sin%5E%7B-1%7D(%5Cfrac%7B(R-r)%7D%7Bx%7D))%20=%202%5Cphi%5Cbig(%5Cfrac%7Bsin%5E%7B-1%7D%5Cfrac%7BR-r%7D%7Bx%7D%7D%7B%5Csigma%7D%5Cbig)%20-%201"></p>
</blockquote>
<p><img src="https://latex.codecogs.com/png.latex?%5Cphi%20%5Cimplies"> Cumulative Normal Distribution Function.</p>
<p>Hence, our model will now have two big parts:</p>
<p><img src="https://latex.codecogs.com/png.latex?y_j%20%5Csim%20binomial(n_j,%20p_j)"></p>
<p><img src="https://latex.codecogs.com/png.latex?p_j%20=%202%5Cphi%5Cbig(%5Cfrac%7Bsin%5E%7B-1%7D%5Cfrac%7BR-r%7D%7Bx%7D%7D%7B%5Csigma%7D%5Cbig)%20-%201"></p>
<p>Typically, the diameter of a golf ball is 1.68 inches and the cup is 4.25 inches i.e</p>
<p><img src="https://latex.codecogs.com/png.latex?r%20=%201.68%20%5Ctext%7Binch%7D"> <img src="https://latex.codecogs.com/png.latex?R%20=%204.25%20%5Ctext%7Binch%7D"></p>
<div id="cell-37" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">ball_radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.68</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span></span>
<span id="cb25-2">cup_radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.25</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span></span></code></pre></div>
</div>
<div id="cell-38" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calculate_prob(angle, distance):</span>
<span id="cb26-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb26-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Calculate probability that the ball with fall in the hole given the angle of the shot </span></span>
<span id="cb26-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    and the distance from the hole.</span></span>
<span id="cb26-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb26-6">    rad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">180.0</span></span>
<span id="cb26-7">    arcsin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arcsin((cup_radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ball_radius)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> distance)</span>
<span id="cb26-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> scipy.stats.norm(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, rad).cdf(arcsin) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span></code></pre></div>
</div>
<div id="cell-39" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb27-2">ls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, df.distance.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb27-3">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.scatterplot(</span>
<span id="cb27-4">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, </span>
<span id="cb27-5">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'success_prob'</span>, </span>
<span id="cb27-6">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, </span>
<span id="cb27-7">    s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb27-8">    legend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'full'</span></span>
<span id="cb27-9">)</span>
<span id="cb27-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> angle <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>]:</span>
<span id="cb27-11">    ax.plot(</span>
<span id="cb27-12">        ls, </span>
<span id="cb27-13">        calculate_prob(angle, ls), </span>
<span id="cb27-14">        label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Angle=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>angle<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb27-15">    )</span>
<span id="cb27-16">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(</span>
<span id="cb27-17">    xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distance from hole(ft)'</span>, </span>
<span id="cb27-18">    ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability of Success'</span></span>
<span id="cb27-19">)</span>
<span id="cb27-20">ax.legend()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let us now add this to our model!</p>
<div id="cell-41" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> theano.tensor <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> tt</span>
<span id="cb28-2"></span>
<span id="cb28-3"></span>
<span id="cb28-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calculate_phi(num):</span>
<span id="cb28-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"cdf for standard normal"</span></span>
<span id="cb28-6">    q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tt.erf(num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> tt.sqrt(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ERF is the Gaussian Error </span></span>
<span id="cb28-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> q) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.</span></span></code></pre></div>
</div>
<div id="cell-42" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> pm.Model() <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> model:</span>
<span id="cb29-2">    angle_of_shot_radians <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.HalfNormal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_radians'</span>)</span>
<span id="cb29-3">    angle_of_shot_degrees <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Deterministic(</span>
<span id="cb29-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_degrees'</span>,</span>
<span id="cb29-5">        (angle_of_shot_radians <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">180.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.pi</span>
<span id="cb29-6">    )</span>
<span id="cb29-7">    p_ball_goes_in <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Deterministic(</span>
<span id="cb29-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'p_ball_goes_in'</span>,</span>
<span id="cb29-9">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> calculate_phi(</span>
<span id="cb29-10">                tt.arcsin(</span>
<span id="cb29-11">                    (cup_radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ball_radius)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> df.distance</span>
<span id="cb29-12">                ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> angle_of_shot_radians</span>
<span id="cb29-13">            )</span>
<span id="cb29-14">        ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb29-15">    p_success <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Binomial(</span>
<span id="cb29-16">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'p_success'</span>,</span>
<span id="cb29-17">        n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.tries, </span>
<span id="cb29-18">        p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p_ball_goes_in, </span>
<span id="cb29-19">        observed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.success_count</span>
<span id="cb29-20">    )</span></code></pre></div>
</div>
<div id="cell-43" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">pm.model_to_graphviz(model)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-23-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-44" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> model:</span>
<span id="cb31-2">    trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>, tune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
ERROR (theano.gof.opt): Optimization failure due to: local_grad_log_erfc_neg
ERROR (theano.gof.opt): node: Elemwise{true_div}(Elemwise{mul,no_inplace}.0, Elemwise{erfc,no_inplace}.0)
ERROR (theano.gof.opt): TRACEBACK:
ERROR (theano.gof.opt): Traceback (most recent call last):
  File "/home/goodhamgupta/shubham/blog/_notebooks/.env/lib/python3.6/site-packages/theano/gof/opt.py", line 2034, in process_node
    replacements = lopt.transform(node)
  File "/home/goodhamgupta/shubham/blog/_notebooks/.env/lib/python3.6/site-packages/theano/tensor/opt.py", line 6789, in local_grad_log_erfc_neg
    if not exp.owner.inputs[0].owner:
AttributeError: 'NoneType' object has no attribute 'owner'

Multiprocess sampling (4 chains in 2 jobs)
NUTS: [angle_of_shot_radians]
Sampling 4 chains, 0 divergences: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 20000/20000 [00:10&lt;00:00, 1943.54draws/s]
The acceptance probability does not match the target. It is 0.8844154441842546, but should be close to 0.8. Try to increase the number of tuning steps.</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">pm.summary(trace).head(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hpd_3%</th>
<th data-quarto-table-cell-role="th">hpd_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_mean</th>
<th data-quarto-table-cell-role="th">ess_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">angle_of_shot_radians</td>
<td>0.027</td>
<td>0.000</td>
<td>0.026</td>
<td>0.027</td>
<td>0.0</td>
<td>0.0</td>
<td>6641.0</td>
<td>6641.0</td>
<td>6641.0</td>
<td>10874.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">angle_of_shot_degrees</td>
<td>1.527</td>
<td>0.023</td>
<td>1.484</td>
<td>1.570</td>
<td>0.0</td>
<td>0.0</td>
<td>6641.0</td>
<td>6641.0</td>
<td>6641.0</td>
<td>10874.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-46" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">pm.plot_posterior(trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_degrees'</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>array([&lt;matplotlib.axes._subplots.AxesSubplot object at 0x7fdfe4c24f60&gt;],
      dtype=object)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-26-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>From the above results, we can see:</p>
<ul>
<li>PyMC3 has estimated
<ul>
<li><img src="https://latex.codecogs.com/png.latex?angle_of_shot_degrees"> to be <img src="https://latex.codecogs.com/png.latex?1.53%20%5Cpm%200.023"></li>
</ul></li>
<li>The MCSE is almost 0 <img src="https://latex.codecogs.com/png.latex?%5Cimplies"> The simulation has run long enough for the chains to converge.</li>
<li><img src="https://latex.codecogs.com/png.latex?r%5C_hat%20=%201.0"> tells us that the chains have mixed well i.e hairy hedgehog pattern.</li>
</ul>
<p>Let‚Äôs visualize the fit with this new model:</p>
<div id="cell-49" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">geo_model_prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calculate_prob(</span>
<span id="cb36-2">    trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_degrees'</span>].mean(), </span>
<span id="cb36-3">    df.distance</span>
<span id="cb36-4">)</span></code></pre></div>
</div>
<div id="cell-50" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">sns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb37-2">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb37-3"></span>
<span id="cb37-4">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.scatterplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.success_prob, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Actual'</span>)</span>
<span id="cb37-5"></span>
<span id="cb37-6">sns.scatterplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.posterior_success_prob, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Logistic Regression'</span>,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb37-7">sns.scatterplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>geo_model_prob, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Geometry based '</span>,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'orange'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb37-8"></span>
<span id="cb37-9">sns.lineplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.posterior_success_prob, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>)</span>
<span id="cb37-10">sns.lineplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>geo_model_prob, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'orange'</span>)</span>
<span id="cb37-11"></span>
<span id="cb37-12">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distance from hole(ft)'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability of Success'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>[Text(0, 0.5, 'Probability of Success'),
 Text(0.5, 0, 'Distance from hole(ft)')]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-28-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>We can see that the geometry based model fits better than the logistic regression model.</li>
<li>While this model is not completely accurate, it suggests that angle is a good variable to model the problem. Using this model, we can be more confident about extrapolating the data.</li>
<li>For the same 50ft putt, the probability now is:</li>
</ul>
<div id="cell-52" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> scipy</span>
<span id="cb39-2">lr_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(</span>
<span id="cb39-3">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> scipy.special.expit(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.223</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.255</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>).mean(),</span>
<span id="cb39-4">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb39-5">)</span>
<span id="cb39-6">geo_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(</span>
<span id="cb39-7">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> calculate_prob(</span>
<span id="cb39-8">        trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_degrees'</span>].mean(), </span>
<span id="cb39-9">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span></span>
<span id="cb39-10">    ).mean(),</span>
<span id="cb39-11">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb39-12">)</span>
<span id="cb39-13"></span>
<span id="cb39-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb39-15">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Logistic Regression Model: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lr_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>\</span>
<span id="cb39-16">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Geometry Based Model: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>geo_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%"</span></span>
<span id="cb39-17">)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Logistic Regression Model: 0.00268% 
Geometry Based Model: 6.40322%</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="new-data" class="level2">
<h2 class="anchored" data-anchor-id="new-data">New Data!</h2>
<p>Mark Broadie obtained new data about the golfers. Let‚Äôs see how our model performs on this new dataset.</p>
<p>First, we‚Äôll look at the summary of the dataset.</p>
<div id="cell-55" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  golf putting data from Broadie (2018)</span></span>
<span id="cb41-2">new_golf_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([</span>
<span id="cb41-3">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.28</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45198</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45183</span>],</span>
<span id="cb41-4">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.97</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">183020</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">182899</span>],</span>
<span id="cb41-5">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.93</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">169503</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168594</span>],</span>
<span id="cb41-6">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.92</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">113094</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">108953</span>],</span>
<span id="cb41-7">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.93</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">73855</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64740</span>],</span>
<span id="cb41-8">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.94</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">53659</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">41106</span>],</span>
<span id="cb41-9">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.94</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42991</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28205</span>],</span>
<span id="cb41-10">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.95</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">37050</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21334</span>],</span>
<span id="cb41-11">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.95</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33275</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16615</span>],</span>
<span id="cb41-12">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.95</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30836</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13503</span>],</span>
<span id="cb41-13">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.95</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28637</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11060</span>],</span>
<span id="cb41-14">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.95</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">26239</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9032</span>],</span>
<span id="cb41-15">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">11.95</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24636</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7687</span>],</span>
<span id="cb41-16">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.95</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22876</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6432</span>],</span>
<span id="cb41-17">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">14.43</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">41267</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9813</span>],</span>
<span id="cb41-18">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">16.43</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35712</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7196</span>],</span>
<span id="cb41-19">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">18.44</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31573</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5290</span>],</span>
<span id="cb41-20">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">20.44</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28280</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4086</span>],</span>
<span id="cb41-21">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">21.95</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13238</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1642</span>],</span>
<span id="cb41-22">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">24.39</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">46570</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4767</span>],</span>
<span id="cb41-23">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">28.40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38422</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2980</span>],</span>
<span id="cb41-24">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">32.39</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31641</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1996</span>],</span>
<span id="cb41-25">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">36.39</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25604</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1327</span>],</span>
<span id="cb41-26">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">40.37</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20366</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">834</span>],</span>
<span id="cb41-27">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">44.38</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15977</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">559</span>],</span>
<span id="cb41-28">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">48.37</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11770</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">311</span>],</span>
<span id="cb41-29">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">52.36</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8708</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">231</span>],</span>
<span id="cb41-30">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">57.25</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8878</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">204</span>],</span>
<span id="cb41-31">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">63.23</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5492</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">103</span>],</span>
<span id="cb41-32">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">69.18</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3087</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>],</span>
<span id="cb41-33">[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">75.19</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1742</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>],</span>
<span id="cb41-34">])</span>
<span id="cb41-35"></span>
<span id="cb41-36">new_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(</span>
<span id="cb41-37">    new_golf_data, </span>
<span id="cb41-38">    columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tries'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'success_count'</span>]</span>
<span id="cb41-39">)</span></code></pre></div>
</div>
<div id="cell-56" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1">new_geo_model_prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calculate_prob(</span>
<span id="cb42-2">    trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_degrees'</span>].mean(), </span>
<span id="cb42-3">    new_df.distance</span>
<span id="cb42-4">)</span></code></pre></div>
</div>
<div id="cell-57" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">new_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'success_prob'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_df.success_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> new_df.tries</span>
<span id="cb43-2">sns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb43-3">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb43-4">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.scatterplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'success_prob'</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Old Dataset'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb43-5">sns.scatterplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'success_prob'</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>new_df,label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'New Dataset'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)</span>
<span id="cb43-6">sns.scatterplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>new_geo_model_prob, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>new_df, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Geometry based Model '</span>,ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb43-7">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(</span>
<span id="cb43-8">    xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distance from hole(ft)'</span>, </span>
<span id="cb43-9">    ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability of Success'</span></span>
<span id="cb43-10">)</span>
<span id="cb43-11">plt.setp(ax.get_legend().get_texts(), fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'25'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see:</p>
<ul>
<li>Success rate is similar in the 0-20 feet range for both datasets.</li>
<li>Beyond 20 ft, success rate is lower than expected. These attempts are more difficult, even after we have accounted for increased angular precision.</li>
</ul>
</section>
<section id="moar-features" class="level2">
<h2 class="anchored" data-anchor-id="moar-features">Moar features!</h2>
<p>To get the ball in, along with the angle, we should also need to take into account if the ball was hit <strong>hard enough</strong>.</p>
<p>From Colin Caroll‚Äôs Blog, we have the following: &gt; Mark Broadie made the following assumptions - If a putt goes short or more than 3 feet past the hole, it will not go in. - Golfers aim for 1 foot past the hole - The distance the ball goes, <img src="https://latex.codecogs.com/png.latex?u">, is distributed as: <img src="https://latex.codecogs.com/png.latex?%20u%20%5Csim%20%5Cmathcal%7BN%7D%5Cleft(1%20+%20%5Ctext%7Bdistance%7D,%20%5Csigma_%7B%5Ctext%7Bdistance%7D%7D%20(1%20+%20%5Ctext%7Bdistance%7D)%5Cright),%20"> where we will learn <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7B%5Ctext%7Bdistance%7D%7D">.</p>
<p>After working through the geometry and algebra, we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?P(%5Ctext%7BGood%20shot%7D)%20=%20%5Cbigg(2%5Cphi%5Cbig(%5Cfrac%7Bsin%5E%7B-1%7D(%5Cfrac%7BR-r%7D%7Bx%7D)%7D%7B%5Csigma_%7Bangle%7D%7D%5Cbig)-1%5Cbigg)%5Cbigg(%5Cphi%5Cbigg(%5Cfrac%7B2%7D%7B(x+1)%5Csigma_%7Bdistance%7D%7D%5Cbigg)%20-%20%5Cphi%5Cbigg(%5Cfrac%7B-1%7D%7B(x+1)%5Csigma_%7Bdistance%7D%7D%5Cbigg)%5Cbigg)"></p>
<p>Let‚Äôs write this down in PyMC3</p>
<div id="cell-62" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">OVERSHOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb44-2">DISTANCE_TOLERANCE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span></span>
<span id="cb44-3">distances <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_df.distance.values</span>
<span id="cb44-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> pm.Model() <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> model:</span>
<span id="cb44-5">    angle_of_shot_radians <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.HalfNormal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_radians'</span>)</span>
<span id="cb44-6">    angle_of_shot_degrees <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Deterministic(</span>
<span id="cb44-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_degrees'</span>,</span>
<span id="cb44-8">        (angle_of_shot_radians <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">180.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.pi</span>
<span id="cb44-9">    )</span>
<span id="cb44-10">    </span>
<span id="cb44-11">    variance_of_distance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.HalfNormal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'variance_of_distance'</span>)</span>
<span id="cb44-12">    p_good_angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Deterministic(</span>
<span id="cb44-13">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'p_good_angle'</span>,</span>
<span id="cb44-14">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> calculate_phi(</span>
<span id="cb44-15">                tt.arcsin(</span>
<span id="cb44-16">                    (cup_radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ball_radius)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> distances</span>
<span id="cb44-17">                ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> angle_of_shot_radians</span>
<span id="cb44-18">            )</span>
<span id="cb44-19">        ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb44-20">    p_good_distance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Deterministic(</span>
<span id="cb44-21">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'p_good_distance'</span>,</span>
<span id="cb44-22">        calculate_phi(</span>
<span id="cb44-23">            (DISTANCE_TOLERANCE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> OVERSHOT) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ((distances <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> OVERSHOT) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> variance_of_distance)) </span>
<span id="cb44-24">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> calculate_phi(</span>
<span id="cb44-25">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>OVERSHOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ((distances <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> OVERSHOT) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> variance_of_distance))</span>
<span id="cb44-26"></span>
<span id="cb44-27">    )</span>
<span id="cb44-28">    p_success <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Binomial(</span>
<span id="cb44-29">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'p_success'</span>,</span>
<span id="cb44-30">        n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>new_df.tries, </span>
<span id="cb44-31">        p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p_good_angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p_good_distance, </span>
<span id="cb44-32">        observed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>new_df.success_count</span>
<span id="cb44-33">    )</span>
<span id="cb44-34">    </span></code></pre></div>
</div>
<div id="cell-63" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">pm.model_to_graphviz(model)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-34-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-64" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> model:</span>
<span id="cb46-2">    trace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, tune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, chains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 2 jobs)
NUTS: [variance_of_distance, angle_of_shot_radians]
Sampling 4 chains, 0 divergences: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 8000/8000 [00:08&lt;00:00, 969.28draws/s] 
The number of effective samples is smaller than 25% for some parameters.</code></pre>
</div>
</div>
<div id="cell-65" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">pm.summary(trace).head(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hpd_3%</th>
<th data-quarto-table-cell-role="th">hpd_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_mean</th>
<th data-quarto-table-cell-role="th">ess_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">angle_of_shot_radians</td>
<td>0.013</td>
<td>0.000</td>
<td>0.013</td>
<td>0.013</td>
<td>0.0</td>
<td>0.0</td>
<td>865.0</td>
<td>865.0</td>
<td>862.0</td>
<td>1109.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">angle_of_shot_degrees</td>
<td>0.761</td>
<td>0.003</td>
<td>0.755</td>
<td>0.768</td>
<td>0.0</td>
<td>0.0</td>
<td>865.0</td>
<td>865.0</td>
<td>862.0</td>
<td>1109.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">variance_of_distance</td>
<td>0.137</td>
<td>0.001</td>
<td>0.136</td>
<td>0.138</td>
<td>0.0</td>
<td>0.0</td>
<td>855.0</td>
<td>855.0</td>
<td>855.0</td>
<td>1186.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-66" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1">pm.plot_posterior(trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'variance_of_distance'</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>array([&lt;matplotlib.axes._subplots.AxesSubplot object at 0x7fdff74693c8&gt;],
      dtype=object)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-37-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-67" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> model:</span>
<span id="cb51-2">    distance_posterior <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample_posterior_predictive(trace)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 4000/4000 [00:04&lt;00:00, 846.25it/s]</code></pre>
</div>
</div>
<div id="cell-68" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calculate_prob_distance(angle, distance, ls):</span>
<span id="cb53-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb53-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Calculate the probability the ball will land inside the hole</span></span>
<span id="cb53-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    given the variance in angle and distance.</span></span>
<span id="cb53-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb53-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: Adapted from Colin Carroll's Blog.</span></span>
<span id="cb53-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb53-8">    norm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> scipy.stats.norm(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb53-9">    prob_angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> norm.cdf(</span>
<span id="cb53-10">        np.arcsin((cup_radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ball_radius) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ls) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> angle) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb53-11">    prob_distance_one <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> norm.cdf(</span>
<span id="cb53-12">        (DISTANCE_TOLERANCE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> OVERSHOT) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ((ls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> OVERSHOT) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> distance)</span>
<span id="cb53-13">    )</span>
<span id="cb53-14">    prob_distance_two <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> norm.cdf(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>OVERSHOT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ((ls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> OVERSHOT) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> distance))</span>
<span id="cb53-15">    prob_distance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prob_distance_one <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> prob_distance_two</span>
<span id="cb53-16">    </span>
<span id="cb53-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> prob_angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prob_distance</span></code></pre></div>
</div>
<div id="cell-69" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1">ls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, new_df.distance.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span></code></pre></div>
</div>
<div id="cell-70" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1">new_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'success_prob'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> new_df.success_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> new_df.tries</span>
<span id="cb55-2">sns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb55-3">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb55-4">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.scatterplot(</span>
<span id="cb55-5">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, </span>
<span id="cb55-6">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'success_prob'</span>,</span>
<span id="cb55-7">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>new_df,</span>
<span id="cb55-8">    label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Actual'</span>, </span>
<span id="cb55-9">    s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span></span>
<span id="cb55-10">)</span>
<span id="cb55-11">sns.scatterplot(</span>
<span id="cb55-12">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, </span>
<span id="cb55-13">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>new_geo_model_prob, </span>
<span id="cb55-14">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>new_df, </span>
<span id="cb55-15">    label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Angle only Model'</span>,</span>
<span id="cb55-16">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, </span>
<span id="cb55-17">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, </span>
<span id="cb55-18">    s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb55-19">)</span>
<span id="cb55-20"></span>
<span id="cb55-21">sns.scatterplot(</span>
<span id="cb55-22">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance'</span>, </span>
<span id="cb55-23">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>calculate_prob_distance(</span>
<span id="cb55-24">        trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_radians'</span>].mean(), </span>
<span id="cb55-25">        trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'variance_of_distance'</span>].mean(),</span>
<span id="cb55-26">        new_df.distance</span>
<span id="cb55-27">    ), </span>
<span id="cb55-28">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>new_df, </span>
<span id="cb55-29">    label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distance + Angle based Model '</span>,</span>
<span id="cb55-30">    ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, </span>
<span id="cb55-31">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>, </span>
<span id="cb55-32">    s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb55-33">)</span>
<span id="cb55-34">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(</span>
<span id="cb55-35">    xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distance from hole(ft)'</span>, </span>
<span id="cb55-36">    ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability of Success'</span></span>
<span id="cb55-37">)</span>
<span id="cb55-38"></span>
<span id="cb55-39">plt.setp(ax.get_legend().get_texts(), fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'25'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-41-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>From the graph, we can conclude that:</p>
<ul>
<li>The model is good at distance lower than 10 ft and distances higher than 40ft.</li>
<li>There is some mismatch between 10ft to 40ft, but overall this is a good fit.</li>
</ul>
</section>
<section id="whats-the-point" class="level2">
<h2 class="anchored" data-anchor-id="whats-the-point">What‚Äôs the point?</h2>
<p>Using Bayesian analysis, we want to be able to quantify the unvertainity with each of our predictions. Since each prediction is a distribution, we can utilize this to see where the putts will fall if they do not fall in the hole.</p>
<div id="cell-74" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> simulate_from_distance(trace, distance_to_hole, trials<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10_000</span>):</span>
<span id="cb56-2">    n_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_radians'</span>].shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb56-3"></span>
<span id="cb56-4">    idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, n_samples, trials)</span>
<span id="cb56-5">    variance_of_shot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'angle_of_shot_radians'</span>][idxs]</span>
<span id="cb56-6">    variance_of_distance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trace[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'variance_of_distance'</span>][idxs]</span>
<span id="cb56-7"></span>
<span id="cb56-8">    theta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, variance_of_shot)</span>
<span id="cb56-9">    distance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.normal(distance_to_hole <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> OVERSHOT, (distance_to_hole <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> OVERSHOT) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> variance_of_distance)</span>
<span id="cb56-10"></span>
<span id="cb56-11">    final_position <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([distance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.cos(theta), distance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.sin(theta)])</span>
<span id="cb56-12"></span>
<span id="cb56-13">    made_it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(theta) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> np.arcsin((cup_radius <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ball_radius) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> distance_to_hole)</span>
<span id="cb56-14">    made_it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> made_it <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (final_position[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> distance_to_hole) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (final_position[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> distance_to_hole <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> DISTANCE_TOLERANCE)</span>
<span id="cb56-15">    </span>
<span id="cb56-16">    _, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb56-17"></span>
<span id="cb56-18">    ax.plot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k.'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, mfc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>, ms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> distance_to_hole)</span>
<span id="cb56-19">    ax.plot(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>final_position[:, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>made_it], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, mfc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, ms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> distance_to_hole, mew<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb56-20">    ax.plot(distance_to_hole, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ko'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, mfc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>, ms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">350</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> distance_to_hole)</span>
<span id="cb56-21"></span>
<span id="cb56-22">    ax.set_facecolor(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#e6ffdb"</span>)</span>
<span id="cb56-23">    ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Final position of </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>trials<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:,d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> putts from </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>distance_to_hole<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">ft.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> made_it<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% made)"</span>)</span>
<span id="cb56-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> ax</span>
<span id="cb56-25"></span>
<span id="cb56-26">simulate_from_distance(trace, distance_to_hole<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://shubhamg.in/posts/2020-03-12-tutorial_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>We‚Äôve just seen how incorporate subjective knowledge in our models and help them fit cases that are specific to our use-case.</p>
<p>References:</p>
<ul>
<li>This is heavily inspired by Colin Caroll‚Äôs Blog present <a href="https://nbviewer.jupyter.org/github/pymc-devs/pymc3/blob/master/docs/source/notebooks/putting_workflow.ipynb">here</a></li>
<li>The crux of this post is based on Dr.&nbsp;Gelman‚Äôs case study present <a href="https://mc-stan.org/users/documentation/case-studies/golf.html">here</a>.</li>
</ul>


</section>

 ]]></description>
  <category>jupyter</category>
  <category>bayesian</category>
  <category>golf_putting</category>
  <guid>https://shubhamg.in/posts/2020-03-12-tutorial.html</guid>
  <pubDate>Wed, 11 Mar 2020 16:00:00 GMT</pubDate>
</item>
<item>
  <title></title>
  <link>https://shubhamg.in/posts/2020-01-14-first-post.html</link>
  <description><![CDATA[ 





<section id="yo" class="level1">
<h1>Yo!</h1>
<p>Super excited to <strong>finally</strong> get my own blog. Hope to write out those long pending articles ASAP now. Stay tuned!</p>


</section>

 ]]></description>
  <category>intro</category>
  <guid>https://shubhamg.in/posts/2020-01-14-first-post.html</guid>
  <pubDate>Mon, 13 Jan 2020 16:00:00 GMT</pubDate>
</item>
</channel>
</rss>
